(function(e){function t(o){if(r[o])return r[o].exports;var i=r[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,o){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var r=e&&e.__esModule?function(){return e['default']}:function(){return e};return t.d(r,'a',r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p='',t(t.s=1)})([function(i,e,t){var o=String.fromCharCode,S=Number.MAX_VALUE,F=Math.cos,B=Math.sin,V=Math.PI,A=Math.abs;(function(l){!function(a,e){var s=a.CANNON||this.CANNON,r=a.OIMO||this.OIMO,n=a.earcut||this.earcut;try{s=s||t(3)}catch(t){}try{r=r||t(4)}catch(t){}try{n=n||t(5)}catch(t){}i.exports=e(s,r,n)}(this,function(d,c,p){var u=Math.exp,f=Math.atan,_=Math.LN2,O=Math.round,ee=Math.floor,m=Math.log,y=Math.tan,I=Math.atan2,T=Math.acos,W=Math.max,C=Math.min,$=Math.sqrt,x=Math.pow;d=d||this.CANNON,c=c||this.OIMO,p=p||this.earcut;var g=this&&this.__decorate||function(l,e,t,i){var r=arguments.length,o=3>r?e:null===i?i=Object.getOwnPropertyDescriptor(e,t):i,s;if('object'==typeof Reflect&&'function'==typeof Reflect.decorate)o=Reflect.decorate(l,e,t,i);else for(var n=l.length-1;0<=n;n--)(s=l[n])&&(o=(3>r?s(o):3<r?s(e,t,o):s(e,t))||o);return 3<r&&o&&Object.defineProperty(e,t,o),o},h=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,e){r.__proto__=e}||function(r,e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t])};return function(e,t){function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),e;!function(g){var e=function(){function t(){this._defines={},this._currentRank=32,this._maxRank=-1}return t.prototype.unBindMesh=function(){this._mesh=null},t.prototype.addFallback=function(r,e){this._defines[r]||(r<this._currentRank&&(this._currentRank=r),r>this._maxRank&&(this._maxRank=r),this._defines[r]=[]),this._defines[r].push(e)},t.prototype.addCPUSkinningFallback=function(r,e){this._mesh=e,r<this._currentRank&&(this._currentRank=r),r>this._maxRank&&(this._maxRank=r)},Object.defineProperty(t.prototype,'isMoreFallbacks',{get:function(){return this._currentRank<=this._maxRank},enumerable:!0,configurable:!0}),t.prototype.reduce=function(d,e){if(this._mesh&&this._mesh.computeBonesUsingShaders&&0<this._mesh.numBoneInfluencers&&this._mesh.material){this._mesh.computeBonesUsingShaders=!1,d=d.replace('#define NUM_BONE_INFLUENCERS '+this._mesh.numBoneInfluencers,'#define NUM_BONE_INFLUENCERS 0'),e._bonesComputationForcedToCPU=!0;for(var t=this._mesh.getScene(),i=0,r;i<t.meshes.length;i++)if(r=t.meshes[i],r.material&&r.computeBonesUsingShaders&&0!==r.numBoneInfluencers)if(r.material.getEffect()===e)r.computeBonesUsingShaders=!1;else if(r.subMeshes)for(var n=0,o=r.subMeshes;n<o.length;n++){var s=o[n],a=s.effect;if(a===e){r.computeBonesUsingShaders=!1;break}}}else{var l=this._defines[this._currentRank];if(l)for(var i=0;i<l.length;i++)d=d.replace('#define '+l[i],'');this._currentRank++}return d},t}();g.EffectFallbacks=e;var t=function(){return function(){}}();g.EffectCreationOptions=t;var o=function(){function T(y,e,t,r,o,i,a,n,s,l){void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===n&&(n=null),void 0===s&&(s=null);var c=this;if(this.uniqueId=0,this.onCompileObservable=new g.Observable,this.onErrorObservable=new g.Observable,this.onBindObservable=new g.Observable,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._isReady=!1,this._compilationError='',this.name=y,e.attributes){var u=e;if(this._engine=t,this._attributesNames=u.attributes,this._uniformsNames=u.uniformsNames.concat(u.samplers),this._samplers=u.samplers.slice(),this.defines=u.defines,this.onError=u.onError,this.onCompiled=u.onCompiled,this._fallbacks=u.fallbacks,this._indexParameters=u.indexParameters,this._transformFeedbackVaryings=u.transformFeedbackVaryings,u.uniformBuffersNames)for(var d=0;d<u.uniformBuffersNames.length;d++)this._uniformBuffersNames[u.uniformBuffersNames[d]]=d}else this._engine=o,this.defines=i,this._uniformsNames=t.concat(r),this._samplers=r?r.slice():[],this._attributesNames=e,this.onError=s,this.onCompiled=n,this._indexParameters=l,this._fallbacks=a;this.uniqueId=T._uniqueIdSeed++;var p,f;y.vertexElement?(p=document.getElementById(y.vertexElement))||(p=y.vertexElement):p=y.vertex||y,y.fragmentElement?(f=document.getElementById(y.fragmentElement))||(f=y.fragmentElement):f=y.fragment||y,this._loadVertexShader(p,function(t){c._processIncludes(t,function(t){c._processShaderConversion(t,!1,function(o){c._loadFragmentShader(f,function(e){c._processIncludes(e,function(e){c._processShaderConversion(e,!0,function(e){if(y){var t=y.vertexElement||y.vertex||y,r=y.fragmentElement||y.fragment||y;c._vertexSourceCode='#define SHADER_NAME vertex:'+t+'\n'+o,c._fragmentSourceCode='#define SHADER_NAME fragment:'+r+'\n'+e}else c._vertexSourceCode=o,c._fragmentSourceCode=e;c._prepareEffect()})})})})})})}return Object.defineProperty(T.prototype,'key',{get:function(){return this._key},enumerable:!0,configurable:!0}),T.prototype.isReady=function(){return this._isReady},T.prototype.getEngine=function(){return this._engine},T.prototype.getProgram=function(){return this._program},T.prototype.getAttributesNames=function(){return this._attributesNames},T.prototype.getAttributeLocation=function(t){return this._attributes[t]},T.prototype.getAttributeLocationByName=function(r){var e=this._attributesNames.indexOf(r);return this._attributes[e]},T.prototype.getAttributesCount=function(){return this._attributes.length},T.prototype.getUniformIndex=function(t){return this._uniformsNames.indexOf(t)},T.prototype.getUniform=function(t){return this._uniforms[this._uniformsNames.indexOf(t)]},T.prototype.getSamplers=function(){return this._samplers},T.prototype.getCompilationError=function(){return this._compilationError},T.prototype.executeWhenCompiled=function(r){return this.isReady()?void r(this):void this.onCompileObservable.add(function(e){r(e)})},T.prototype._loadVertexShader=function(e,t){if(g.Tools.IsWindowObjectExist()&&e instanceof HTMLElement)return void t(g.Tools.GetDOMTextContent(e));if('base64:'===e.substr(0,7))return void t(window.atob(e.substr(7)));if(T.ShadersStore[e+'VertexShader'])return void t(T.ShadersStore[e+'VertexShader']);var r;r='.'===e[0]||'/'===e[0]||-1<e.indexOf('http')?e:g.Engine.ShadersRepository+e,this._engine._loadFile(r+'.vertex.fx',t)},T.prototype._loadFragmentShader=function(e,t){if(g.Tools.IsWindowObjectExist()&&e instanceof HTMLElement)return void t(g.Tools.GetDOMTextContent(e));if('base64:'===e.substr(0,7))return void t(window.atob(e.substr(7)));if(T.ShadersStore[e+'PixelShader'])return void t(T.ShadersStore[e+'PixelShader']);if(T.ShadersStore[e+'FragmentShader'])return void t(T.ShadersStore[e+'FragmentShader']);var r;r='.'===e[0]||'/'===e[0]||-1<e.indexOf('http')?e:g.Engine.ShadersRepository+e,this._engine._loadFile(r+'.fragment.fx',t)},T.prototype._dumpShadersSource=function(e,t,i){var r=1<this._engine.webGLVersion?'#version 300 es\n#define WEBGL2 \n':'',n=r+(i?i+'\n':'');e=n+e,t=n+t;var o=2,s=/\n/gm,a='\n1\t'+e.replace(s,function(){return'\n'+o++ +'\t'});o=2;var l='\n1\t'+t.replace(s,function(){return'\n'+o++ +'\t'});this.name.vertexElement?(g.Tools.Error('Vertex shader: '+this.name.vertexElement+a),g.Tools.Error('Fragment shader: '+this.name.fragmentElement+l)):this.name.vertex?(g.Tools.Error('Vertex shader: '+this.name.vertex+a),g.Tools.Error('Fragment shader: '+this.name.fragment+l)):(g.Tools.Error('Vertex shader: '+this.name+a),g.Tools.Error('Fragment shader: '+this.name+l))},T.prototype._processShaderConversion=function(a,e,t){var i=this._processPrecision(a);if(1==this._engine.webGLVersion)return void t(i);if(-1!==i.indexOf('#version 3'))return void t(i.replace('#version 300 es',''));var r=-1!==i.search(/#extension.+GL_EXT_draw_buffers.+require/),n=/#extension.+(GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,o=i.replace(n,'');o=o.replace(/varying(?![\n\r])\s/g,e?'in ':'out '),o=o.replace(/attribute[ \t]/g,'in '),o=o.replace(/[ \t]attribute/g,' in'),e&&(o=o.replace(/texture2DLodEXT\s*\(/g,'textureLod('),o=o.replace(/textureCubeLodEXT\s*\(/g,'textureLod('),o=o.replace(/texture2D\s*\(/g,'texture('),o=o.replace(/textureCube\s*\(/g,'texture('),o=o.replace(/gl_FragDepthEXT/g,'gl_FragDepth'),o=o.replace(/gl_FragColor/g,'glFragColor'),o=o.replace(/gl_FragData/g,'glFragData'),o=o.replace(/void\s+?main\s*\(/g,(r?'':'out vec4 glFragColor;\n')+'void main(')),t(o)},T.prototype._processIncludes=function(e,t){for(var r=this,i=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,o=i.exec(e),n=new String(e),a;null!=o;){if(a=o[1],-1!==a.indexOf('__decl__')&&(a=a.replace(/__decl__/,''),this._engine.supportsUniformBuffers&&(a=a.replace(/Vertex/,'Ubo'),a=a.replace(/Fragment/,'Ubo')),a+='Declaration'),!T.IncludesShadersStore[a]){var s=g.Engine.ShadersRepository+'ShadersInclude/'+a+'.fx';return void this._engine._loadFile(s,function(o){T.IncludesShadersStore[a]=o,r._processIncludes(n,t)})}var l=T.IncludesShadersStore[a];if(o[2])for(var c=o[3].split(','),u=0;u<c.length;u+=2){var f=new RegExp(c[u],'g'),d=c[u+1];l=l.replace(f,d)}if(o[4]){var p=o[5];if(-1!==p.indexOf('..')){var _=p.split('..'),m=parseInt(_[0]),h=parseInt(_[1]),x=l.slice(0);l='',isNaN(h)&&(h=this._indexParameters[_[1]]);for(var y=m;y<h;y++)this._engine.supportsUniformBuffers||(x=x.replace(/light\{X\}.(\w*)/g,function(r,e){return e+'{X}'})),l+=x.replace(/\{X\}/g,y.toString())+'\n'}else this._engine.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,function(r,e){return e+'{X}'})),l=l.replace(/\{X\}/g,p)}n=n.replace(o[0],l),o=i.exec(e)}t(n)},T.prototype._processPrecision=function(t){return-1===t.indexOf('precision highp float')?t=this._engine.getCaps().highPrecisionShaderSupported?'precision highp float;\n'+t:'precision mediump float;\n'+t:this._engine.getCaps().highPrecisionShaderSupported||(t=t.replace('precision highp float','precision mediump float')),t},T.prototype._rebuildProgram=function(e,t,a,r){var n=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(o,e){r&&r(e)},this.onCompiled=function(){for(var e=n.getEngine().scenes,t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(g.Material.TextureDirtyFlag);a&&a(n._program)},this._fallbacks=null,this._prepareEffect()},T.prototype.getSpecificUniformLocations=function(t){return this._engine.getUniforms(this._program,t)},T.prototype._prepareEffect=function(){var e=this._attributesNames,t=this.defines,i=this._fallbacks;this._valueCache={};var r=this._program;try{var n=this._engine;if(this._program=this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n.createRawShaderProgram(this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,void 0,this._transformFeedbackVaryings):n.createShaderProgram(this._vertexSourceCode,this._fragmentSourceCode,t,void 0,this._transformFeedbackVaryings),this._program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this),n.supportsUniformBuffers)for(var o in this._uniformBuffersNames)this.bindUniformBlock(o,this._uniformBuffersNames[o]);this._uniforms=n.getUniforms(this._program,this._uniformsNames),this._attributes=n.getAttributes(this._program,e);var s;for(s=0;s<this._samplers.length;s++)null==this.getUniform(this._samplers[s])&&(this._samplers.splice(s,1),s--);n.bindSamplers(this),this._compilationError='',this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),r&&this.getEngine()._deleteProgram(r)}catch(a){this._compilationError=a.message,g.Tools.Error('Unable to compile effect:'),g.Tools.Error('Uniforms: '+this._uniformsNames.map(function(t){return' '+t})),g.Tools.Error('Attributes: '+e.map(function(t){return' '+t})),this._dumpShadersSource(this._vertexSourceCode,this._fragmentSourceCode,t),g.Tools.Error('Error: '+this._compilationError),r&&(this._program=r,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),i&&i.isMoreFallbacks?(g.Tools.Error('Trying next fallback.'),this.defines=i.reduce(this.defines,this),this._prepareEffect()):(this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())}},Object.defineProperty(T.prototype,'isSupported',{get:function(){return''===this._compilationError},enumerable:!0,configurable:!0}),T.prototype._bindTexture=function(r,e){this._engine._bindTexture(this._samplers.indexOf(r),e)},T.prototype.setTexture=function(r,e){this._engine.setTexture(this._samplers.indexOf(r),this.getUniform(r),e)},T.prototype.setDepthStencilTexture=function(r,e){this._engine.setDepthStencilTexture(this._samplers.indexOf(r),this.getUniform(r),e)},T.prototype.setTextureArray=function(o,e){if(-1===this._samplers.indexOf(o+'Ex'))for(var t=this._samplers.indexOf(o),i=1;i<e.length;i++)this._samplers.splice(t+i,0,o+'Ex');this._engine.setTextureArray(this._samplers.indexOf(o),this.getUniform(o),e)},T.prototype.setTextureFromPostProcess=function(r,e){this._engine.setTextureFromPostProcess(this._samplers.indexOf(r),e)},T.prototype.setTextureFromPostProcessOutput=function(r,e){this._engine.setTextureFromPostProcessOutput(this._samplers.indexOf(r),e)},T.prototype._cacheMatrix=function(o,e){var t=this._valueCache[o],i=e.updateFlag;return(void 0===t||t!==i)&&(this._valueCache[o]=i,!0)},T.prototype._cacheFloat2=function(o,e,t){var i=this._valueCache[o];if(!i)return i=[e,t],this._valueCache[o]=i,!0;var a=!1;return i[0]!==e&&(i[0]=e,a=!0),i[1]!==t&&(i[1]=t,a=!0),a},T.prototype._cacheFloat3=function(a,e,t,i){var r=this._valueCache[a];if(!r)return r=[e,t,i],this._valueCache[a]=r,!0;var s=!1;return r[0]!==e&&(r[0]=e,s=!0),r[1]!==t&&(r[1]=t,s=!0),r[2]!==i&&(r[2]=i,s=!0),s},T.prototype._cacheFloat4=function(a,e,t,i,r){var n=this._valueCache[a];if(!n)return n=[e,t,i,r],this._valueCache[a]=n,!0;var l=!1;return n[0]!==e&&(n[0]=e,l=!0),n[1]!==t&&(n[1]=t,l=!0),n[2]!==i&&(n[2]=i,l=!0),n[3]!==r&&(n[3]=r,l=!0),l},T.prototype.bindUniformBuffer=function(t,e){var o=this._uniformBuffersNames[e];void 0!==o&&T._baseCache[o]!==t&&(T._baseCache[o]=t,this._engine.bindUniformBufferBase(t,o))},T.prototype.bindUniformBlock=function(r,e){this._engine.bindUniformBlock(this._program,r,e)},T.prototype.setInt=function(r,e){var t=this._valueCache[r];return void 0!==t&&t===e?this:(this._valueCache[r]=e,this._engine.setInt(this.getUniform(r),e),this)},T.prototype.setIntArray=function(r,e){return this._valueCache[r]=null,this._engine.setIntArray(this.getUniform(r),e),this},T.prototype.setIntArray2=function(r,e){return this._valueCache[r]=null,this._engine.setIntArray2(this.getUniform(r),e),this},T.prototype.setIntArray3=function(r,e){return this._valueCache[r]=null,this._engine.setIntArray3(this.getUniform(r),e),this},T.prototype.setIntArray4=function(r,e){return this._valueCache[r]=null,this._engine.setIntArray4(this.getUniform(r),e),this},T.prototype.setFloatArray=function(r,e){return this._valueCache[r]=null,this._engine.setFloatArray(this.getUniform(r),e),this},T.prototype.setFloatArray2=function(r,e){return this._valueCache[r]=null,this._engine.setFloatArray2(this.getUniform(r),e),this},T.prototype.setFloatArray3=function(r,e){return this._valueCache[r]=null,this._engine.setFloatArray3(this.getUniform(r),e),this},T.prototype.setFloatArray4=function(r,e){return this._valueCache[r]=null,this._engine.setFloatArray4(this.getUniform(r),e),this},T.prototype.setArray=function(r,e){return this._valueCache[r]=null,this._engine.setArray(this.getUniform(r),e),this},T.prototype.setArray2=function(r,e){return this._valueCache[r]=null,this._engine.setArray2(this.getUniform(r),e),this},T.prototype.setArray3=function(r,e){return this._valueCache[r]=null,this._engine.setArray3(this.getUniform(r),e),this},T.prototype.setArray4=function(r,e){return this._valueCache[r]=null,this._engine.setArray4(this.getUniform(r),e),this},T.prototype.setMatrices=function(r,e){return e?(this._valueCache[r]=null,this._engine.setMatrices(this.getUniform(r),e),this):this},T.prototype.setMatrix=function(r,e){return this._cacheMatrix(r,e)&&this._engine.setMatrix(this.getUniform(r),e),this},T.prototype.setMatrix3x3=function(r,e){return this._valueCache[r]=null,this._engine.setMatrix3x3(this.getUniform(r),e),this},T.prototype.setMatrix2x2=function(r,e){return this._valueCache[r]=null,this._engine.setMatrix2x2(this.getUniform(r),e),this},T.prototype.setFloat=function(r,e){var t=this._valueCache[r];return void 0!==t&&t===e?this:(this._valueCache[r]=e,this._engine.setFloat(this.getUniform(r),e),this)},T.prototype.setBool=function(r,e){var t=this._valueCache[r];return void 0!==t&&t===e?this:(this._valueCache[r]=e,this._engine.setBool(this.getUniform(r),e?1:0),this)},T.prototype.setVector2=function(r,e){return this._cacheFloat2(r,e.x,e.y)&&this._engine.setFloat2(this.getUniform(r),e.x,e.y),this},T.prototype.setFloat2=function(r,e,t){return this._cacheFloat2(r,e,t)&&this._engine.setFloat2(this.getUniform(r),e,t),this},T.prototype.setVector3=function(r,e){return this._cacheFloat3(r,e.x,e.y,e.z)&&this._engine.setFloat3(this.getUniform(r),e.x,e.y,e.z),this},T.prototype.setFloat3=function(o,e,t,i){return this._cacheFloat3(o,e,t,i)&&this._engine.setFloat3(this.getUniform(o),e,t,i),this},T.prototype.setVector4=function(r,e){return this._cacheFloat4(r,e.x,e.y,e.z,e.w)&&this._engine.setFloat4(this.getUniform(r),e.x,e.y,e.z,e.w),this},T.prototype.setFloat4=function(o,e,t,i,r){return this._cacheFloat4(o,e,t,i,r)&&this._engine.setFloat4(this.getUniform(o),e,t,i,r),this},T.prototype.setColor3=function(r,e){return this._cacheFloat3(r,e.r,e.g,e.b)&&this._engine.setColor3(this.getUniform(r),e),this},T.prototype.setColor4=function(r,e,t){return this._cacheFloat4(r,e.r,e.g,e.b,t)&&this._engine.setColor4(this.getUniform(r),e,t),this},T.prototype.setDirectColor4=function(r,e){return this._cacheFloat4(r,e.r,e.g,e.b,e.a)&&this._engine.setDirectColor4(this.getUniform(r),e),this},T.ResetCache=function(){T._baseCache={}},T._uniqueIdSeed=0,T._baseCache={},T.ShadersStore={},T.IncludesShadersStore={},T}();g.Effect=o}(e||(e={}));var e;!function(o){var e=function(){function t(){}return Object.defineProperty(t,'KEYDOWN',{get:function(){return t._KEYDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(t,'KEYUP',{get:function(){return t._KEYUP},enumerable:!0,configurable:!0}),t._KEYDOWN=1,t._KEYUP=2,t}();o.KeyboardEventTypes=e;var t=function(){function t(r,o){this.type=r,this.event=o}return t}();o.KeyboardInfo=t;var i=function(o){function e(e,a){var i=o.call(this,e,a)||this;return i.skipOnPointerObservable=!1,i}return h(e,o),e}(t);o.KeyboardInfoPre=i}(e||(e={}));var e;!function(a){var e=function(){function t(){}return Object.defineProperty(t,'POINTERDOWN',{get:function(){return t._POINTERDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERUP',{get:function(){return t._POINTERUP},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERMOVE',{get:function(){return t._POINTERMOVE},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERWHEEL',{get:function(){return t._POINTERWHEEL},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERPICK',{get:function(){return t._POINTERPICK},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERTAP',{get:function(){return t._POINTERTAP},enumerable:!0,configurable:!0}),Object.defineProperty(t,'POINTERDOUBLETAP',{get:function(){return t._POINTERDOUBLETAP},enumerable:!0,configurable:!0}),t._POINTERDOWN=1,t._POINTERUP=2,t._POINTERMOVE=4,t._POINTERWHEEL=8,t._POINTERPICK=16,t._POINTERTAP=32,t._POINTERDOUBLETAP=64,t}();a.PointerEventTypes=e;var t=function(){function t(r,o){this.type=r,this.event=o}return t}();a.PointerInfoBase=t;var o=function(e){function t(t,l,r,n){var o=e.call(this,t,l)||this;return o.skipOnPointerObservable=!1,o.localPosition=new a.Vector2(r,n),o}return h(t,e),t}(t);a.PointerInfoPre=o;var r=function(o){function e(e,a,i){var r=o.call(this,e,a)||this;return r.pickInfo=i,r}return h(e,o),e}(t);a.PointerInfo=r}(e||(e={}));var e;!function(P){P.ToGammaSpace=1/2.2,P.ToLinearSpace=2.2,P.Epsilon=.001;var S=function(){function o(r,e,o){void 0===r&&(r=0),void 0===e&&(e=0),void 0===o&&(o=0),this.r=r,this.g=e,this.b=o}return o.prototype.toString=function(){return'{R: '+this.r+' G:'+this.g+' B:'+this.b+'}'},o.prototype.getClassName=function(){return'Color3'},o.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0)},o.prototype.toArray=function(r,e){return void 0===e&&(e=0),r[e]=this.r,r[e+1]=this.g,r[e+2]=this.b,this},o.prototype.toColor4=function(r){return void 0===r&&(r=1),new t(this.r,this.g,this.b,r)},o.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},o.prototype.toLuminance=function(){return .3*this.r+.59*this.g+.11*this.b},o.prototype.multiply=function(t){return new o(this.r*t.r,this.g*t.g,this.b*t.b)},o.prototype.multiplyToRef=function(r,e){return e.r=this.r*r.r,e.g=this.g*r.g,e.b=this.b*r.b,this},o.prototype.equals=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},o.prototype.equalsFloats=function(r,e,t){return this.r===r&&this.g===e&&this.b===t},o.prototype.scale=function(t){return new o(this.r*t,this.g*t,this.b*t)},o.prototype.scaleToRef=function(r,e){return e.r=this.r*r,e.g=this.g*r,e.b=this.b*r,this},o.prototype.scaleAndAddToRef=function(r,e){return e.r+=this.r*r,e.g+=this.g*r,e.b+=this.b*r,this},o.prototype.clampToRef=function(e,t,o){return void 0===e&&(e=0),void 0===t&&(t=1),o.r=P.Scalar.Clamp(this.r,e,t),o.g=P.Scalar.Clamp(this.g,e,t),o.b=P.Scalar.Clamp(this.b,e,t),this},o.prototype.add=function(t){return new o(this.r+t.r,this.g+t.g,this.b+t.b)},o.prototype.addToRef=function(r,e){return e.r=this.r+r.r,e.g=this.g+r.g,e.b=this.b+r.b,this},o.prototype.subtract=function(t){return new o(this.r-t.r,this.g-t.g,this.b-t.b)},o.prototype.subtractToRef=function(r,e){return e.r=this.r-r.r,e.g=this.g-r.g,e.b=this.b-r.b,this},o.prototype.clone=function(){return new o(this.r,this.g,this.b)},o.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},o.prototype.copyFromFloats=function(r,e,t){return this.r=r,this.g=e,this.b=t,this},o.prototype.set=function(r,e,t){return this.copyFromFloats(r,e,t)},o.prototype.toHexString=function(){var e=0|255*this.r,t=0|255*this.g,o=0|255*this.b;return'#'+P.Scalar.ToHex(e)+P.Scalar.ToHex(t)+P.Scalar.ToHex(o)},o.prototype.toLinearSpace=function(){var t=new o;return this.toLinearSpaceToRef(t),t},o.prototype.toLinearSpaceToRef=function(e){return e.r=x(this.r,P.ToLinearSpace),e.g=x(this.g,P.ToLinearSpace),e.b=x(this.b,P.ToLinearSpace),this},o.prototype.toGammaSpace=function(){var t=new o;return this.toGammaSpaceToRef(t),t},o.prototype.toGammaSpaceToRef=function(e){return e.r=x(this.r,P.ToGammaSpace),e.g=x(this.g,P.ToGammaSpace),e.b=x(this.b,P.ToGammaSpace),this},o.FromHexString=function(t){if('#'!==t.substring(0,1)||7!==t.length)return new o(0,0,0);var e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16);return o.FromInts(e,i,r)},o.FromArray=function(t,e){return void 0===e&&(e=0),new o(t[e],t[e+1],t[e+2])},o.FromInts=function(t,e,i){return new o(t/255,e/255,i/255)},o.Lerp=function(t,e,i){return new o(t.r+(e.r-t.r)*i,t.g+(e.g-t.g)*i,t.b+(e.b-t.b)*i)},o.Red=function(){return new o(1,0,0)},o.Green=function(){return new o(0,1,0)},o.Blue=function(){return new o(0,0,1)},o.Black=function(){return new o(0,0,0)},o.White=function(){return new o(1,1,1)},o.Purple=function(){return new o(.5,0,.5)},o.Magenta=function(){return new o(1,0,1)},o.Yellow=function(){return new o(1,1,0)},o.Gray=function(){return new o(.5,.5,.5)},o.Teal=function(){return new o(0,1,1)},o.Random=function(){return new o(Math.random(),Math.random(),Math.random())},o}();P.Color3=S;var t=function(){function a(o,e,a,i){void 0===o&&(o=0),void 0===e&&(e=0),void 0===a&&(a=0),void 0===i&&(i=1),this.r=o,this.g=e,this.b=a,this.a=i}return a.prototype.addInPlace=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},a.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},a.prototype.toArray=function(r,e){return void 0===e&&(e=0),r[e]=this.r,r[e+1]=this.g,r[e+2]=this.b,r[e+3]=this.a,this},a.prototype.add=function(t){return new a(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)},a.prototype.subtract=function(t){return new a(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)},a.prototype.subtractToRef=function(r,e){return e.r=this.r-r.r,e.g=this.g-r.g,e.b=this.b-r.b,e.a=this.a-r.a,this},a.prototype.scale=function(t){return new a(this.r*t,this.g*t,this.b*t,this.a*t)},a.prototype.scaleToRef=function(r,e){return e.r=this.r*r,e.g=this.g*r,e.b=this.b*r,e.a=this.a*r,this},a.prototype.scaleAndAddToRef=function(r,e){return e.r+=this.r*r,e.g+=this.g*r,e.b+=this.b*r,e.a+=this.a*r,this},a.prototype.clampToRef=function(e,t,o){return void 0===e&&(e=0),void 0===t&&(t=1),o.r=P.Scalar.Clamp(this.r,e,t),o.g=P.Scalar.Clamp(this.g,e,t),o.b=P.Scalar.Clamp(this.b,e,t),o.a=P.Scalar.Clamp(this.a,e,t),this},a.prototype.multiply=function(t){return new a(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)},a.prototype.multiplyToRef=function(r,e){return e.r=this.r*r.r,e.g=this.g*r.g,e.b=this.b*r.b,e.a=this.a*r.a,e},a.prototype.toString=function(){return'{R: '+this.r+' G:'+this.g+' B:'+this.b+' A:'+this.a+'}'},a.prototype.getClassName=function(){return'Color4'},a.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0),t=397*t^(this.a||0)},a.prototype.clone=function(){return new a(this.r,this.g,this.b,this.a)},a.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},a.prototype.copyFromFloats=function(o,e,t,i){return this.r=o,this.g=e,this.b=t,this.a=i,this},a.prototype.set=function(o,e,t,i){return this.copyFromFloats(o,e,t,i)},a.prototype.toHexString=function(){var e=0|255*this.r,t=0|255*this.g,o=0|255*this.b,r=0|255*this.a;return'#'+P.Scalar.ToHex(e)+P.Scalar.ToHex(t)+P.Scalar.ToHex(o)+P.Scalar.ToHex(r)},a.prototype.toLinearSpace=function(){var t=new a;return this.toLinearSpaceToRef(t),t},a.prototype.toLinearSpaceToRef=function(e){return e.r=x(this.r,P.ToLinearSpace),e.g=x(this.g,P.ToLinearSpace),e.b=x(this.b,P.ToLinearSpace),e.a=this.a,this},a.prototype.toGammaSpace=function(){var t=new a;return this.toGammaSpaceToRef(t),t},a.prototype.toGammaSpaceToRef=function(e){return e.r=x(this.r,P.ToGammaSpace),e.g=x(this.g,P.ToGammaSpace),e.b=x(this.b,P.ToGammaSpace),e.a=this.a,this},a.FromHexString=function(t){if('#'!==t.substring(0,1)||9!==t.length)return new a(0,0,0,0);var e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16),n=parseInt(t.substring(7,9),16);return a.FromInts(e,i,r,n)},a.Lerp=function(t,e,o){var r=new a(0,0,0,0);return a.LerpToRef(t,e,o,r),r},a.LerpToRef=function(o,e,t,i){i.r=o.r+(e.r-o.r)*t,i.g=o.g+(e.g-o.g)*t,i.b=o.b+(e.b-o.b)*t,i.a=o.a+(e.a-o.a)*t},a.FromArray=function(t,e){return void 0===e&&(e=0),new a(t[e],t[e+1],t[e+2],t[e+3])},a.FromInts=function(t,e,o,r){return new a(t/255,e/255,o/255,r/255)},a.CheckColors4=function(o,e){if(o.length===3*e){for(var t=[],i=0,r;i<o.length;i+=3)r=4*(i/3),t[r]=o[i],t[r+1]=o[i+1],t[r+2]=o[i+2],t[r+3]=1;return t}return o},a}();P.Color4=t;var M=function(){function d(r,e){this.x=r,this.y=e}return d.prototype.toString=function(){return'{X: '+this.x+' Y:'+this.y+'}'},d.prototype.getClassName=function(){return'Vector2'},d.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0)},d.prototype.toArray=function(r,e){return void 0===e&&(e=0),r[e]=this.x,r[e+1]=this.y,this},d.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},d.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this},d.prototype.copyFromFloats=function(r,e){return this.x=r,this.y=e,this},d.prototype.set=function(r,e){return this.copyFromFloats(r,e)},d.prototype.add=function(t){return new d(this.x+t.x,this.y+t.y)},d.prototype.addToRef=function(r,e){return e.x=this.x+r.x,e.y=this.y+r.y,this},d.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this},d.prototype.addVector3=function(t){return new d(this.x+t.x,this.y+t.y)},d.prototype.subtract=function(t){return new d(this.x-t.x,this.y-t.y)},d.prototype.subtractToRef=function(r,e){return e.x=this.x-r.x,e.y=this.y-r.y,this},d.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this},d.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this},d.prototype.multiply=function(t){return new d(this.x*t.x,this.y*t.y)},d.prototype.multiplyToRef=function(r,e){return e.x=this.x*r.x,e.y=this.y*r.y,this},d.prototype.multiplyByFloats=function(t,e){return new d(this.x*t,this.y*e)},d.prototype.divide=function(t){return new d(this.x/t.x,this.y/t.y)},d.prototype.divideToRef=function(r,e){return e.x=this.x/r.x,e.y=this.y/r.y,this},d.prototype.divideInPlace=function(t){return this.divideToRef(t,this)},d.prototype.negate=function(){return new d(-this.x,-this.y)},d.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this},d.prototype.scale=function(t){var e=new d(0,0);return this.scaleToRef(t,e),e},d.prototype.scaleToRef=function(r,e){return e.x=this.x*r,e.y=this.y*r,this},d.prototype.scaleAndAddToRef=function(r,e){return e.x+=this.x*r,e.y+=this.y*r,this},d.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y},d.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=P.Epsilon),e&&P.Scalar.WithinEpsilon(this.x,e.x,t)&&P.Scalar.WithinEpsilon(this.y,e.y,t)},d.prototype.length=function(){return $(this.x*this.x+this.y*this.y)},d.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},d.prototype.normalize=function(){var r=this.length();if(0===r)return this;var e=1/r;return this.x*=e,this.y*=e,this},d.prototype.clone=function(){return new d(this.x,this.y)},d.Zero=function(){return new d(0,0)},d.One=function(){return new d(1,1)},d.FromArray=function(t,e){return void 0===e&&(e=0),new d(t[e],t[e+1])},d.FromArrayToRef=function(r,e,t){t.x=r[e],t.y=r[e+1]},d.CatmullRom=function(t,e,i,r,n){var o=n*n,s=n*o;return new d(.5*(2*e.x+(-t.x+i.x)*n+(2*t.x-5*e.x+4*i.x-r.x)*o+(-t.x+3*e.x-3*i.x+r.x)*s),.5*(2*e.y+(-t.y+i.y)*n+(2*t.y-5*e.y+4*i.y-r.y)*o+(-t.y+3*e.y-3*i.y+r.y)*s))},d.Clamp=function(t,e,i){var r=t.x;r=r>i.x?i.x:r,r=r<e.x?e.x:r;var a=t.y;return a=a>i.y?i.y:a,a=a<e.y?e.y:a,new d(r,a)},d.Hermite=function(t,e,i,r,n){var o=n*n,s=n*o,a=2*s-3*o+1,l=-2*s+3*o,p=s-2*o+n,c=s-o;return new d(t.x*a+i.x*l+e.x*p+r.x*c,t.y*a+i.y*l+e.y*p+r.y*c)},d.Lerp=function(t,e,o){return new d(t.x+(e.x-t.x)*o,t.y+(e.y-t.y)*o)},d.Dot=function(r,e){return r.x*e.x+r.y*e.y},d.Normalize=function(r){var e=r.clone();return e.normalize(),e},d.Minimize=function(t,e){return new d(t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y)},d.Maximize=function(t,e){return new d(t.x>e.x?t.x:e.x,t.y>e.y?t.y:e.y)},d.Transform=function(t,e){var o=d.Zero();return d.TransformToRef(t,e,o),o},d.TransformToRef=function(o,e,t){var i=o.x*e.m[0]+o.y*e.m[4]+e.m[12],r=o.x*e.m[1]+o.y*e.m[5]+e.m[13];t.x=i,t.y=r},d.PointInTriangle=function(l,e,t,i){var r=.5*(-t.y*i.x+e.y*(-t.x+i.x)+e.x*(t.y-i.y)+t.x*i.y),n=0>r?-1:1,o=(e.y*i.x-e.x*i.y+(i.y-e.y)*l.x+(e.x-i.x)*l.y)*n,s=(e.x*t.y-e.y*t.x+(e.y-t.y)*l.x+(t.x-e.x)*l.y)*n;return 0<o&&0<s&&o+s<2*r*n},d.Distance=function(t,e){return $(d.DistanceSquared(t,e))},d.DistanceSquared=function(o,e){var t=o.x-e.x,i=o.y-e.y;return t*t+i*i},d.Center=function(r,e){var t=r.add(e);return t.scaleInPlace(.5),t},d.DistanceOfPointFromSegment=function(t,e,i){var r=d.DistanceSquared(e,i);if(0===r)return d.Distance(t,e);var n=i.subtract(e),o=W(0,C(1,d.Dot(t.subtract(e),n)/r)),s=e.add(n.multiplyByFloats(o,o));return d.Distance(t,s)},d}();P.Vector2=M;var R=function(){function p(r,e,o){this.x=r,this.y=e,this.z=o}return p.prototype.toString=function(){return'{X: '+this.x+' Y:'+this.y+' Z:'+this.z+'}'},p.prototype.getClassName=function(){return'Vector3'},p.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0)},p.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},p.prototype.toArray=function(r,e){return void 0===e&&(e=0),r[e]=this.x,r[e+1]=this.y,r[e+2]=this.z,this},p.prototype.toQuaternion=function(){return P.Quaternion.RotationYawPitchRoll(this.x,this.y,this.z)},p.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},p.prototype.add=function(t){return new p(this.x+t.x,this.y+t.y,this.z+t.z)},p.prototype.addToRef=function(r,e){return e.x=this.x+r.x,e.y=this.y+r.y,e.z=this.z+r.z,this},p.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},p.prototype.subtract=function(t){return new p(this.x-t.x,this.y-t.y,this.z-t.z)},p.prototype.subtractToRef=function(r,e){return e.x=this.x-r.x,e.y=this.y-r.y,e.z=this.z-r.z,this},p.prototype.subtractFromFloats=function(t,e,o){return new p(this.x-t,this.y-e,this.z-o)},p.prototype.subtractFromFloatsToRef=function(o,e,t,i){return i.x=this.x-o,i.y=this.y-e,i.z=this.z-t,this},p.prototype.negate=function(){return new p(-this.x,-this.y,-this.z)},p.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this},p.prototype.scale=function(t){return new p(this.x*t,this.y*t,this.z*t)},p.prototype.scaleToRef=function(r,e){return e.x=this.x*r,e.y=this.y*r,e.z=this.z*r,this},p.prototype.scaleAndAddToRef=function(r,e){return e.x+=this.x*r,e.y+=this.y*r,e.z+=this.z*r,this},p.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},p.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=P.Epsilon),e&&P.Scalar.WithinEpsilon(this.x,e.x,t)&&P.Scalar.WithinEpsilon(this.y,e.y,t)&&P.Scalar.WithinEpsilon(this.z,e.z,t)},p.prototype.equalsToFloats=function(r,e,t){return this.x===r&&this.y===e&&this.z===t},p.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},p.prototype.multiply=function(t){return new p(this.x*t.x,this.y*t.y,this.z*t.z)},p.prototype.multiplyToRef=function(r,e){return e.x=this.x*r.x,e.y=this.y*r.y,e.z=this.z*r.z,this},p.prototype.multiplyByFloats=function(t,e,o){return new p(this.x*t,this.y*e,this.z*o)},p.prototype.divide=function(t){return new p(this.x/t.x,this.y/t.y,this.z/t.z)},p.prototype.divideToRef=function(r,e){return e.x=this.x/r.x,e.y=this.y/r.y,e.z=this.z/r.z,this},p.prototype.divideInPlace=function(t){return this.divideToRef(t,this)},p.prototype.minimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this},p.prototype.maximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this},Object.defineProperty(p.prototype,'isNonUniform',{get:function(){var r=A(this.x),e=A(this.y);if(r!==e)return!0;var t=A(this.z);return r!==t||e!==t},enumerable:!0,configurable:!0}),p.prototype.length=function(){return $(this.x*this.x+this.y*this.y+this.z*this.z)},p.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},p.prototype.normalize=function(){var r=this.length();if(0===r||1===r)return this;var e=1/r;return this.x*=e,this.y*=e,this.z*=e,this},p.prototype.normalizeToNew=function(){var t=new p(0,0,0);return this.normalizeToRef(t),t},p.prototype.normalizeToRef=function(r){var e=this.length();if(0===e||1===e)return r.set(this.x,this.y,this.z),r;return this.scaleToRef(1/e,r),r},p.prototype.clone=function(){return new p(this.x,this.y,this.z)},p.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},p.prototype.copyFromFloats=function(r,e,t){return this.x=r,this.y=e,this.z=t,this},p.prototype.set=function(r,e,t){return this.copyFromFloats(r,e,t)},p.GetClipFactor=function(t,e,i,r){var a=p.Dot(t,i)-r;return a/(a-(p.Dot(e,i)-r))},p.GetAngleBetweenVectors=function(t,e,i){var r=t.clone().normalize(),n=e.clone().normalize(),o=p.Dot(r,n),s=p.Cross(r,n);return 0<p.Dot(s,i)?T(o):-T(o)},p.FromArray=function(t,e){return e||(e=0),new p(t[e],t[e+1],t[e+2])},p.FromFloatArray=function(t,e){return p.FromArray(t,e)},p.FromArrayToRef=function(r,e,t){t.x=r[e],t.y=r[e+1],t.z=r[e+2]},p.FromFloatArrayToRef=function(t,e,o){return p.FromArrayToRef(t,e,o)},p.FromFloatsToRef=function(o,e,t,i){i.x=o,i.y=e,i.z=t},p.Zero=function(){return new p(0,0,0)},p.One=function(){return new p(1,1,1)},p.Up=function(){return new p(0,1,0)},p.Forward=function(){return new p(0,0,1)},p.Right=function(){return new p(1,0,0)},p.Left=function(){return new p(-1,0,0)},p.TransformCoordinates=function(t,e){var o=p.Zero();return p.TransformCoordinatesToRef(t,e,o),o},p.TransformCoordinatesToRef=function(a,e,t){var i=a.x*e.m[0]+a.y*e.m[4]+a.z*e.m[8]+e.m[12],r=a.x*e.m[1]+a.y*e.m[5]+a.z*e.m[9]+e.m[13],n=a.x*e.m[2]+a.y*e.m[6]+a.z*e.m[10]+e.m[14],o=a.x*e.m[3]+a.y*e.m[7]+a.z*e.m[11]+e.m[15];t.x=i/o,t.y=r/o,t.z=n/o},p.TransformCoordinatesFromFloatsToRef=function(d,e,t,i,r){var n=d*i.m[0]+e*i.m[4]+t*i.m[8]+i.m[12],o=d*i.m[1]+e*i.m[5]+t*i.m[9]+i.m[13],s=d*i.m[2]+e*i.m[6]+t*i.m[10]+i.m[14],a=d*i.m[3]+e*i.m[7]+t*i.m[11]+i.m[15];r.x=n/a,r.y=o/a,r.z=s/a},p.TransformNormal=function(t,e){var o=p.Zero();return p.TransformNormalToRef(t,e,o),o},p.TransformNormalToRef=function(a,e,t){var i=a.x*e.m[0]+a.y*e.m[4]+a.z*e.m[8],r=a.x*e.m[1]+a.y*e.m[5]+a.z*e.m[9],n=a.x*e.m[2]+a.y*e.m[6]+a.z*e.m[10];t.x=i,t.y=r,t.z=n},p.TransformNormalFromFloatsToRef=function(o,e,t,i,r){r.x=o*i.m[0]+e*i.m[4]+t*i.m[8],r.y=o*i.m[1]+e*i.m[5]+t*i.m[9],r.z=o*i.m[2]+e*i.m[6]+t*i.m[10]},p.CatmullRom=function(t,e,i,r,n){var o=n*n,s=n*o;return new p(.5*(2*e.x+(-t.x+i.x)*n+(2*t.x-5*e.x+4*i.x-r.x)*o+(-t.x+3*e.x-3*i.x+r.x)*s),.5*(2*e.y+(-t.y+i.y)*n+(2*t.y-5*e.y+4*i.y-r.y)*o+(-t.y+3*e.y-3*i.y+r.y)*s),.5*(2*e.z+(-t.z+i.z)*n+(2*t.z-5*e.z+4*i.z-r.z)*o+(-t.z+3*e.z-3*i.z+r.z)*s))},p.Clamp=function(t,e,i){var r=t.x;r=r>i.x?i.x:r,r=r<e.x?e.x:r;var a=t.y;a=a>i.y?i.y:a,a=a<e.y?e.y:a;var o=t.z;return o=o>i.z?i.z:o,o=o<e.z?e.z:o,new p(r,a,o)},p.Hermite=function(t,e,i,r,n){var o=n*n,s=n*o,a=2*s-3*o+1,l=-2*s+3*o,d=s-2*o+n,c=s-o;return new p(t.x*a+i.x*l+e.x*d+r.x*c,t.y*a+i.y*l+e.y*d+r.y*c,t.z*a+i.z*l+e.z*d+r.z*c)},p.Lerp=function(t,e,o){var r=new p(0,0,0);return p.LerpToRef(t,e,o,r),r},p.LerpToRef=function(o,e,t,i){i.x=o.x+(e.x-o.x)*t,i.y=o.y+(e.y-o.y)*t,i.z=o.z+(e.z-o.z)*t},p.Dot=function(r,e){return r.x*e.x+r.y*e.y+r.z*e.z},p.Cross=function(t,e){var o=p.Zero();return p.CrossToRef(t,e,o),o},p.CrossToRef=function(r,e,t){g.Vector3[0].x=r.y*e.z-r.z*e.y,g.Vector3[0].y=r.z*e.x-r.x*e.z,g.Vector3[0].z=r.x*e.y-r.y*e.x,t.copyFrom(g.Vector3[0])},p.Normalize=function(t){var e=p.Zero();return p.NormalizeToRef(t,e),e},p.NormalizeToRef=function(r,e){e.copyFrom(r),e.normalize()},p.Project=function(t,e,i,r){var n=r.width,o=r.height,l=r.x,a=r.y,d=p._viewportMatrixCache?p._viewportMatrixCache:p._viewportMatrixCache=new D;D.FromValuesToRef(n/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+n/2,o/2+a,.5,1,d);var c=g.Matrix[0];return e.multiplyToRef(i,c),c.multiplyToRef(d,c),p.TransformCoordinates(t,c)},p.UnprojectFromTransform=function(e,t,r,i,o){var n=g.Matrix[0];i.multiplyToRef(o,n),n.invert(),e.x=2*(e.x/t)-1,e.y=-(2*(e.y/r)-1);var a=p.TransformCoordinates(e,n),s=e.x*n.m[3]+e.y*n.m[7]+e.z*n.m[11]+n.m[15];return P.Scalar.WithinEpsilon(s,1)&&(a=a.scale(1/s)),a},p.Unproject=function(t,e,i,r,n,o){var s=p.Zero();return p.UnprojectToRef(t,e,i,r,n,o,s),s},p.UnprojectToRef=function(t,e,i,r,n,o,s){p.UnprojectFloatsToRef(t.x,t.y,t.z,e,i,r,n,o,s)},p.UnprojectFloatsToRef=function(e,t,r,i,o,n,a,s,l){var c=g.Matrix[0];n.multiplyToRef(a,c),c.multiplyToRef(s,c),c.invert();var u=g.Vector3[0];u.x=2*(e/i)-1,u.y=-(2*(t/o)-1),u.z=2*r-1,p.TransformCoordinatesToRef(u,c,l);var f=u.x*c.m[3]+u.y*c.m[7]+u.z*c.m[11]+c.m[15];P.Scalar.WithinEpsilon(f,1)&&l.scaleInPlace(1/f)},p.Minimize=function(r,e){var t=r.clone();return t.minimizeInPlace(e),t},p.Maximize=function(r,e){var t=r.clone();return t.maximizeInPlace(e),t},p.Distance=function(t,e){return $(p.DistanceSquared(t,e))},p.DistanceSquared=function(o,e){var t=o.x-e.x,i=o.y-e.y,r=o.z-e.z;return t*t+i*i+r*r},p.Center=function(r,e){var t=r.add(e);return t.scaleInPlace(.5),t},p.RotationFromAxis=function(t,e,o){var r=p.Zero();return p.RotationFromAxisToRef(t,e,o,r),r},p.RotationFromAxisToRef=function(o,e,t,i){var r=g.Quaternion[0];O.RotationQuaternionFromAxisToRef(o,e,t,r),r.toEulerAnglesToRef(i)},p}();P.Vector3=R;var r=function(){function o(o,e,a,i){this.x=o,this.y=e,this.z=a,this.w=i}return o.prototype.toString=function(){return'{X: '+this.x+' Y:'+this.y+' Z:'+this.z+' W:'+this.w+'}'},o.prototype.getClassName=function(){return'Vector4'},o.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},o.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},o.prototype.toArray=function(r,e){return void 0===e&&(e=0),r[e]=this.x,r[e+1]=this.y,r[e+2]=this.z,r[e+3]=this.w,this},o.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},o.prototype.add=function(t){return new o(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},o.prototype.addToRef=function(r,e){return e.x=this.x+r.x,e.y=this.y+r.y,e.z=this.z+r.z,e.w=this.w+r.w,this},o.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},o.prototype.subtract=function(t){return new o(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},o.prototype.subtractToRef=function(r,e){return e.x=this.x-r.x,e.y=this.y-r.y,e.z=this.z-r.z,e.w=this.w-r.w,this},o.prototype.subtractFromFloats=function(t,e,i,r){return new o(this.x-t,this.y-e,this.z-i,this.w-r)},o.prototype.subtractFromFloatsToRef=function(o,e,t,i,r){return r.x=this.x-o,r.y=this.y-e,r.z=this.z-t,r.w=this.w-i,this},o.prototype.negate=function(){return new o(-this.x,-this.y,-this.z,-this.w)},o.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},o.prototype.scale=function(t){return new o(this.x*t,this.y*t,this.z*t,this.w*t)},o.prototype.scaleToRef=function(r,e){return e.x=this.x*r,e.y=this.y*r,e.z=this.z*r,e.w=this.w*r,this},o.prototype.scaleAndAddToRef=function(r,e){return e.x+=this.x*r,e.y+=this.y*r,e.z+=this.z*r,e.w+=this.w*r,this},o.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},o.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=P.Epsilon),e&&P.Scalar.WithinEpsilon(this.x,e.x,t)&&P.Scalar.WithinEpsilon(this.y,e.y,t)&&P.Scalar.WithinEpsilon(this.z,e.z,t)&&P.Scalar.WithinEpsilon(this.w,e.w,t)},o.prototype.equalsToFloats=function(o,e,t,i){return this.x===o&&this.y===e&&this.z===t&&this.w===i},o.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},o.prototype.multiply=function(t){return new o(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)},o.prototype.multiplyToRef=function(r,e){return e.x=this.x*r.x,e.y=this.y*r.y,e.z=this.z*r.z,e.w=this.w*r.w,this},o.prototype.multiplyByFloats=function(t,e,i,r){return new o(this.x*t,this.y*e,this.z*i,this.w*r)},o.prototype.divide=function(t){return new o(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)},o.prototype.divideToRef=function(r,e){return e.x=this.x/r.x,e.y=this.y/r.y,e.z=this.z/r.z,e.w=this.w/r.w,this},o.prototype.divideInPlace=function(t){return this.divideToRef(t,this)},o.prototype.minimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this},o.prototype.maximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this},o.prototype.length=function(){return $(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},o.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},o.prototype.normalize=function(){var r=this.length();if(0===r)return this;var e=1/r;return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},o.prototype.toVector3=function(){return new R(this.x,this.y,this.z)},o.prototype.clone=function(){return new o(this.x,this.y,this.z,this.w)},o.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},o.prototype.copyFromFloats=function(o,e,t,i){return this.x=o,this.y=e,this.z=t,this.w=i,this},o.prototype.set=function(o,e,t,i){return this.copyFromFloats(o,e,t,i)},o.FromArray=function(t,e){return e||(e=0),new o(t[e],t[e+1],t[e+2],t[e+3])},o.FromArrayToRef=function(r,e,t){t.x=r[e],t.y=r[e+1],t.z=r[e+2],t.w=r[e+3]},o.FromFloatArrayToRef=function(t,e,i){o.FromArrayToRef(t,e,i)},o.FromFloatsToRef=function(o,e,t,i,r){r.x=o,r.y=e,r.z=t,r.w=i},o.Zero=function(){return new o(0,0,0,0)},o.One=function(){return new o(1,1,1,1)},o.Normalize=function(t){var e=o.Zero();return o.NormalizeToRef(t,e),e},o.NormalizeToRef=function(r,e){e.copyFrom(r),e.normalize()},o.Minimize=function(r,e){var t=r.clone();return t.minimizeInPlace(e),t},o.Maximize=function(r,e){var t=r.clone();return t.maximizeInPlace(e),t},o.Distance=function(t,e){return $(o.DistanceSquared(t,e))},o.DistanceSquared=function(a,e){var t=a.x-e.x,i=a.y-e.y,r=a.z-e.z,n=a.w-e.w;return t*t+i*i+r*r+n*n},o.Center=function(r,e){var t=r.add(e);return t.scaleInPlace(.5),t},o.TransformNormal=function(t,e){var i=o.Zero();return o.TransformNormalToRef(t,e,i),i},o.TransformNormalToRef=function(a,e,t){var i=a.x*e.m[0]+a.y*e.m[4]+a.z*e.m[8],r=a.x*e.m[1]+a.y*e.m[5]+a.z*e.m[9],n=a.x*e.m[2]+a.y*e.m[6]+a.z*e.m[10];t.x=i,t.y=r,t.z=n,t.w=a.w},o.TransformNormalFromFloatsToRef=function(a,e,t,i,r,n){n.x=a*r.m[0]+e*r.m[4]+t*r.m[8],n.y=a*r.m[1]+e*r.m[5]+t*r.m[9],n.z=a*r.m[2]+e*r.m[6]+t*r.m[10],n.w=i},o}();P.Vector4=r;var e=function(){function o(r,o){this.width=r,this.height=o}return o.prototype.toString=function(){return'{W: '+this.width+', H: '+this.height+'}'},o.prototype.getClassName=function(){return'Size'},o.prototype.getHashCode=function(){var t=this.width||0;return t=397*t^(this.height||0)},o.prototype.copyFrom=function(t){this.width=t.width,this.height=t.height},o.prototype.copyFromFloats=function(r,e){return this.width=r,this.height=e,this},o.prototype.set=function(r,e){return this.copyFromFloats(r,e)},o.prototype.multiplyByFloats=function(e,t){return new o(this.width*e,this.height*t)},o.prototype.clone=function(){return new o(this.width,this.height)},o.prototype.equals=function(t){return!!t&&this.width===t.width&&this.height===t.height},Object.defineProperty(o.prototype,'surface',{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),o.Zero=function(){return new o(0,0)},o.prototype.add=function(e){return new o(this.width+e.width,this.height+e.height)},o.prototype.subtract=function(e){return new o(this.width-e.width,this.height-e.height)},o.Lerp=function(e,t,i){return new o(e.width+(t.width-e.width)*i,e.height+(t.height-e.height)*i)},o}();P.Size=e;var O=function(){function d(o,a,t,i){void 0===o&&(o=0),void 0===a&&(a=0),void 0===t&&(t=0),void 0===i&&(i=1),this.x=o,this.y=a,this.z=t,this.w=i}return d.prototype.toString=function(){return'{X: '+this.x+' Y:'+this.y+' Z:'+this.z+' W:'+this.w+'}'},d.prototype.getClassName=function(){return'Quaternion'},d.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},d.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},d.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},d.prototype.clone=function(){return new d(this.x,this.y,this.z,this.w)},d.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},d.prototype.copyFromFloats=function(o,e,t,i){return this.x=o,this.y=e,this.z=t,this.w=i,this},d.prototype.set=function(o,e,t,i){return this.copyFromFloats(o,e,t,i)},d.prototype.add=function(e){return new d(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},d.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},d.prototype.subtract=function(e){return new d(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},d.prototype.scale=function(e){return new d(this.x*e,this.y*e,this.z*e,this.w*e)},d.prototype.scaleToRef=function(r,e){return e.x=this.x*r,e.y=this.y*r,e.z=this.z*r,e.w=this.w*r,this},d.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},d.prototype.scaleAndAddToRef=function(r,e){return e.x+=this.x*r,e.y+=this.y*r,e.z+=this.z*r,e.w+=this.w*r,this},d.prototype.multiply=function(e){var t=new d(0,0,0,1);return this.multiplyToRef(e,t),t},d.prototype.multiplyToRef=function(a,e){var t=this.x*a.w+this.y*a.z-this.z*a.y+this.w*a.x,i=-this.x*a.z+this.y*a.w+this.z*a.x+this.w*a.y,r=this.x*a.y-this.y*a.x+this.z*a.w+this.w*a.z,n=-this.x*a.x-this.y*a.y-this.z*a.z+this.w*a.w;return e.copyFromFloats(t,i,r,n),this},d.prototype.multiplyInPlace=function(t){return this.multiplyToRef(t,this),this},d.prototype.conjugateToRef=function(t){return t.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},d.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},d.prototype.conjugate=function(){return new d(-this.x,-this.y,-this.z,this.w)},d.prototype.length=function(){return $(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},d.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},d.prototype.toEulerAngles=function(r){void 0===r&&(r='YZX');var e=R.Zero();return this.toEulerAnglesToRef(e,r),e},d.prototype.toEulerAnglesToRef=function(d,e){void 0===e&&(e='YZX');var t=this.z,i=this.x,r=this.y,n=this.w,o=n*n,s=t*t,p=i*i,l=r*r,u=r*t-i*n;return-.4999999>u?(d.y=2*I(r,n),d.x=V/2,d.z=0):.4999999<u?(d.y=2*I(r,n),d.x=-V/2,d.z=0):(d.z=I(2*(i*r+t*n),-s-p+l+o),d.x=Math.asin(-2*(t*r-i*n)),d.y=I(2*(t*i+r*n),s-p-l+o)),this},d.prototype.toRotationMatrix=function(d){var e=this.x*this.x,t=this.y*this.y,i=this.z*this.z,r=this.x*this.y,n=this.z*this.w,o=this.z*this.x,s=this.y*this.w,a=this.y*this.z,l=this.x*this.w;return d.m[0]=1-2*(t+i),d.m[1]=2*(r+n),d.m[2]=2*(o-s),d.m[3]=0,d.m[4]=2*(r-n),d.m[5]=1-2*(i+e),d.m[6]=2*(a+l),d.m[7]=0,d.m[8]=2*(o+s),d.m[9]=2*(a-l),d.m[10]=1-2*(t+e),d.m[11]=0,d.m[12]=0,d.m[13]=0,d.m[14]=0,d.m[15]=1,d._markAsUpdated(),this},d.prototype.fromRotationMatrix=function(e){return d.FromRotationMatrixToRef(e,this),this},d.FromRotationMatrix=function(e){var t=new d;return d.FromRotationMatrixToRef(e,t),t},d.FromRotationMatrixToRef=function(p,e){var t=p.m,r=t[0],n=t[4],o=t[8],s=t[1],a=t[5],l=t[9],_=t[2],c=t[6],u=t[10],f=r+a+u,d;0<f?(d=.5/$(f+1),e.w=.25/d,e.x=(c-l)*d,e.y=(o-_)*d,e.z=(s-n)*d):r>a&&r>u?(d=2*$(1+r-a-u),e.w=(c-l)/d,e.x=.25*d,e.y=(n+s)/d,e.z=(o+_)/d):a>u?(d=2*$(1+a-r-u),e.w=(o-_)/d,e.x=(n+s)/d,e.y=.25*d,e.z=(l+c)/d):(d=2*$(1+u-r-a),e.w=(s-n)/d,e.x=(o+_)/d,e.y=(l+c)/d,e.z=.25*d)},d.Dot=function(r,e){return r.x*e.x+r.y*e.y+r.z*e.z+r.w*e.w},d.AreClose=function(e,t){return 0<=d.Dot(e,t)},d.Zero=function(){return new d(0,0,0,0)},d.Inverse=function(e){return new d(-e.x,-e.y,-e.z,e.w)},d.Identity=function(){return new d(0,0,0,1)},d.IsIdentity=function(t){return t&&0===t.x&&0===t.y&&0===t.z&&1===t.w},d.RotationAxis=function(e,t){return d.RotationAxisToRef(e,t,new d)},d.RotationAxisToRef=function(o,e,t){var i=B(e/2);return o.normalize(),t.w=F(e/2),t.x=o.x*i,t.y=o.y*i,t.z=o.z*i,t},d.FromArray=function(e,t){return t||(t=0),new d(e[t],e[t+1],e[t+2],e[t+3])},d.RotationYawPitchRoll=function(e,t,o){var r=new d;return d.RotationYawPitchRollToRef(e,t,o,r),r},d.RotationYawPitchRollToRef=function(d,e,t,i){var r=.5*t,n=.5*e,o=.5*d,s=B(r),a=F(r),l=B(n),p=F(n),c=B(o),u=F(o);i.x=u*l*a+c*p*s,i.y=c*p*a-u*l*s,i.z=u*p*s-c*l*a,i.w=u*p*a+c*l*s},d.RotationAlphaBetaGamma=function(e,t,o){var r=new d;return d.RotationAlphaBetaGammaToRef(e,t,o,r),r},d.RotationAlphaBetaGammaToRef=function(a,e,t,i){var r=.5*(t+a),n=.5*(t-a),o=.5*e;i.x=F(n)*B(o),i.y=B(n)*B(o),i.z=B(r)*F(o),i.w=F(r)*F(o)},d.RotationQuaternionFromAxis=function(e,t,o){var r=new d(0,0,0,0);return d.RotationQuaternionFromAxisToRef(e,t,o,r),r},d.RotationQuaternionFromAxisToRef=function(e,t,i,r){var a=g.Matrix[0];D.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),a),d.FromRotationMatrixToRef(a,r)},d.Slerp=function(e,t,o){var r=d.Identity();return d.SlerpToRef(e,t,o,r),r},d.SlerpToRef=function(d,e,t,c){var r=d.x*e.x+d.y*e.y+d.z*e.z+d.w*e.w,p=!1,a,n;if(0>r&&(p=!0,r=-r),.999999<r)n=1-t,a=p?-t:t;else{var o=T(r),l=1/B(o);n=B((1-t)*o)*l,a=p?-B(t*o)*l:B(t*o)*l}c.x=n*d.x+a*e.x,c.y=n*d.y+a*e.y,c.z=n*d.z+a*e.z,c.w=n*d.w+a*e.w},d.Hermite=function(e,t,i,r,n){var o=n*n,s=n*o,a=2*s-3*o+1,l=-2*s+3*o,p=s-2*o+n,c=s-o;return new d(e.x*a+i.x*l+t.x*p+r.x*c,e.y*a+i.y*l+t.y*p+r.y*c,e.z*a+i.z*l+t.z*p+r.z*c,e.w*a+i.w*l+t.w*p+r.w*c)},d}();P.Quaternion=O;var D=function(){function T(){this._isIdentity=!1,this._isIdentityDirty=!0,this.m=new Float32Array(16),this._markAsUpdated()}return T.prototype._markAsUpdated=function(){this.updateFlag=T._updateFlagSeed++,this._isIdentityDirty=!0},T.prototype.isIdentity=function(t){return void 0===t&&(t=!1),this._isIdentityDirty&&(this._isIdentityDirty=!1,this._isIdentity=1===this.m[0]&&1===this.m[5]&&1===this.m[15]&&0===this.m[1]&&0===this.m[2]&&0===this.m[3]&&0===this.m[4]&&0===this.m[6]&&0===this.m[7]&&0===this.m[8]&&0===this.m[9]&&0===this.m[11]&&0===this.m[12]&&0===this.m[13]&&0===this.m[14],t||1===this.m[10]||(this._isIdentity=!1)),this._isIdentity},T.prototype.determinant=function(){var a=this.m[10]*this.m[15]-this.m[11]*this.m[14],e=this.m[9]*this.m[15]-this.m[11]*this.m[13],t=this.m[9]*this.m[14]-this.m[10]*this.m[13],i=this.m[8]*this.m[15]-this.m[11]*this.m[12],r=this.m[8]*this.m[14]-this.m[10]*this.m[12],n=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*a-this.m[6]*e+this.m[7]*t)-this.m[1]*(this.m[4]*a-this.m[6]*i+this.m[7]*r)+this.m[2]*(this.m[4]*e-this.m[5]*i+this.m[7]*n)-this.m[3]*(this.m[4]*t-this.m[5]*r+this.m[6]*n)},T.prototype.toArray=function(){return this.m},T.prototype.asArray=function(){return this.toArray()},T.prototype.invert=function(){return this.invertToRef(this),this},T.prototype.reset=function(){for(var t=0;16>t;t++)this.m[t]=0;return this._markAsUpdated(),this},T.prototype.add=function(e){var t=new T;return this.addToRef(e,t),t},T.prototype.addToRef=function(r,e){for(var t=0;16>t;t++)e.m[t]=this.m[t]+r.m[t];return e._markAsUpdated(),this},T.prototype.addToSelf=function(r){for(var e=0;16>e;e++)this.m[e]+=r.m[e];return this._markAsUpdated(),this},T.prototype.invertToRef=function(z){var e=this.m[0],t=this.m[1],i=this.m[2],r=this.m[3],n=this.m[4],o=this.m[5],s=this.m[6],a=this.m[7],l=this.m[8],h=this.m[9],c=this.m[10],u=this.m[11],f=this.m[12],d=this.m[13],p=this.m[14],_=this.m[15],m=c*_-u*p,g=h*_-u*d,v=h*p-c*d,y=l*_-u*f,b=l*p-c*f,x=l*d-h*f,T=o*m-s*g+a*v,E=-(n*m-s*y+a*b),P=n*g-o*y+a*x,A=-(n*v-o*b+s*x),M=1/(e*T+t*E+i*P+r*A),S=s*_-a*p,C=o*_-a*d,R=o*p-s*d,O=n*_-a*f,I=n*p-s*f,D=n*d-o*f,w=s*u-a*c,L=o*u-a*h,F=o*c-s*h,B=n*u-a*l,V=n*c-s*l,N=n*h-o*l;return z.m[0]=T*M,z.m[4]=E*M,z.m[8]=P*M,z.m[12]=A*M,z.m[1]=-(t*m-i*g+r*v)*M,z.m[5]=(e*m-i*y+r*b)*M,z.m[9]=-(e*g-t*y+r*x)*M,z.m[13]=(e*v-t*b+i*x)*M,z.m[2]=(t*S-i*C+r*R)*M,z.m[6]=-(e*S-i*O+r*I)*M,z.m[10]=(e*C-t*O+r*D)*M,z.m[14]=-(e*R-t*I+i*D)*M,z.m[3]=-(t*w-i*L+r*F)*M,z.m[7]=(e*w-i*B+r*V)*M,z.m[11]=-(e*L-t*B+r*N)*M,z.m[15]=(e*F-t*V+i*N)*M,z._markAsUpdated(),this},T.prototype.setTranslationFromFloats=function(r,e,t){return this.m[12]=r,this.m[13]=e,this.m[14]=t,this._markAsUpdated(),this},T.prototype.setTranslation=function(t){return this.m[12]=t.x,this.m[13]=t.y,this.m[14]=t.z,this._markAsUpdated(),this},T.prototype.getTranslation=function(){return new R(this.m[12],this.m[13],this.m[14])},T.prototype.getTranslationToRef=function(t){return t.x=this.m[12],t.y=this.m[13],t.z=this.m[14],this},T.prototype.removeRotationAndScaling=function(){return this.setRowFromFloats(0,1,0,0,0),this.setRowFromFloats(1,0,1,0,0),this.setRowFromFloats(2,0,0,1,0),this},T.prototype.multiply=function(e){var t=new T;return this.multiplyToRef(e,t),t},T.prototype.copyFrom=function(r){for(var e=0;16>e;e++)this.m[e]=r.m[e];return this._markAsUpdated(),this},T.prototype.copyToArray=function(r,e){void 0===e&&(e=0);for(var t=0;16>t;t++)r[e+t]=this.m[t];return this},T.prototype.multiplyToRef=function(r,e){return this.multiplyToArray(r,e.m,0),e._markAsUpdated(),this},T.prototype.multiplyToArray=function(F,e,t){var i=this.m[0],r=this.m[1],n=this.m[2],o=this.m[3],s=this.m[4],a=this.m[5],l=this.m[6],h=this.m[7],c=this.m[8],u=this.m[9],f=this.m[10],d=this.m[11],p=this.m[12],_=this.m[13],m=this.m[14],g=this.m[15],v=F.m[0],y=F.m[1],b=F.m[2],x=F.m[3],T=F.m[4],E=F.m[5],P=F.m[6],A=F.m[7],M=F.m[8],S=F.m[9],C=F.m[10],R=F.m[11],O=F.m[12],I=F.m[13],D=F.m[14],B=F.m[15];return e[t]=i*v+r*T+n*M+o*O,e[t+1]=i*y+r*E+n*S+o*I,e[t+2]=i*b+r*P+n*C+o*D,e[t+3]=i*x+r*A+n*R+o*B,e[t+4]=s*v+a*T+l*M+h*O,e[t+5]=s*y+a*E+l*S+h*I,e[t+6]=s*b+a*P+l*C+h*D,e[t+7]=s*x+a*A+l*R+h*B,e[t+8]=c*v+u*T+f*M+d*O,e[t+9]=c*y+u*E+f*S+d*I,e[t+10]=c*b+u*P+f*C+d*D,e[t+11]=c*x+u*A+f*R+d*B,e[t+12]=p*v+_*T+m*M+g*O,e[t+13]=p*y+_*E+m*S+g*I,e[t+14]=p*b+_*P+m*C+g*D,e[t+15]=p*x+_*A+m*R+g*B,this},T.prototype.equals=function(t){return t&&this.m[0]===t.m[0]&&this.m[1]===t.m[1]&&this.m[2]===t.m[2]&&this.m[3]===t.m[3]&&this.m[4]===t.m[4]&&this.m[5]===t.m[5]&&this.m[6]===t.m[6]&&this.m[7]===t.m[7]&&this.m[8]===t.m[8]&&this.m[9]===t.m[9]&&this.m[10]===t.m[10]&&this.m[11]===t.m[11]&&this.m[12]===t.m[12]&&this.m[13]===t.m[13]&&this.m[14]===t.m[14]&&this.m[15]===t.m[15]},T.prototype.clone=function(){return T.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},T.prototype.getClassName=function(){return'Matrix'},T.prototype.getHashCode=function(){for(var r=this.m[0]||0,e=1;16>e;e++)r=397*r^(this.m[e]||0);return r},T.prototype.decompose=function(e,t,o){return o&&(o.x=this.m[12],o.y=this.m[13],o.z=this.m[14]),e=e||g.Vector3[0],e.x=$(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),e.y=$(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),e.z=$(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),0>=this.determinant()&&(e.y*=-1),0===e.x||0===e.y||0===e.z?(t&&(t.x=0,t.y=0,t.z=0,t.w=1),!1):(t&&(T.FromValuesToRef(this.m[0]/e.x,this.m[1]/e.x,this.m[2]/e.x,0,this.m[4]/e.y,this.m[5]/e.y,this.m[6]/e.y,0,this.m[8]/e.z,this.m[9]/e.z,this.m[10]/e.z,0,0,0,0,1,g.Matrix[0]),O.FromRotationMatrixToRef(g.Matrix[0],t)),!0)},T.prototype.getRow=function(o){if(0>o||3<o)return null;var e=4*o;return new r(this.m[e+0],this.m[e+1],this.m[e+2],this.m[e+3])},T.prototype.setRow=function(r,e){if(0>r||3<r)return this;var t=4*r;return this.m[t+0]=e.x,this.m[t+1]=e.y,this.m[t+2]=e.z,this.m[t+3]=e.w,this._markAsUpdated(),this},T.prototype.transpose=function(){return T.Transpose(this)},T.prototype.transposeToRef=function(e){return T.TransposeToRef(this,e),this},T.prototype.setRowFromFloats=function(a,e,t,i,r){if(0>a||3<a)return this;var n=4*a;return this.m[n+0]=e,this.m[n+1]=t,this.m[n+2]=i,this.m[n+3]=r,this._markAsUpdated(),this},T.prototype.scale=function(e){var t=new T;return this.scaleToRef(e,t),t},T.prototype.scaleToRef=function(r,e){for(var t=0;16>t;t++)e.m[t]=this.m[t]*r;return e._markAsUpdated(),this},T.prototype.scaleAndAddToRef=function(r,e){for(var t=0;16>t;t++)e.m[t]+=this.m[t]*r;return e._markAsUpdated(),this},T.prototype.toNormalMatrix=function(e){this.invertToRef(e),e.transpose();var t=e.m;T.FromValuesToRef(t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1,e)},T.prototype.getRotationMatrix=function(){var e=T.Identity();return this.getRotationMatrixToRef(e),e},T.prototype.getRotationMatrixToRef=function(e){var t=this.m,i=$(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=$(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]),a=$(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]);return 0>=this.determinant()&&(r*=-1),0===i||0===r||0===a?T.IdentityToRef(e):T.FromValuesToRef(t[0]/i,t[1]/i,t[2]/i,0,t[4]/r,t[5]/r,t[6]/r,0,t[8]/a,t[9]/a,t[10]/a,0,0,0,0,1,e),this},T.FromArray=function(e,t){var o=new T;return t||(t=0),T.FromArrayToRef(e,t,o),o},T.FromArrayToRef=function(o,e,t){for(var i=0;16>i;i++)t.m[i]=o[i+e];t._markAsUpdated()},T.FromFloat32ArrayToRefScaled=function(o,e,t,i){for(var r=0;16>r;r++)i.m[r]=o[r+e]*t;i._markAsUpdated()},T.FromValuesToRef=function(g,e,t,i,r,n,o,s,a,l,h,c,u,f,d,p,_){_.m[0]=g,_.m[1]=e,_.m[2]=t,_.m[3]=i,_.m[4]=r,_.m[5]=n,_.m[6]=o,_.m[7]=s,_.m[8]=a,_.m[9]=l,_.m[10]=h,_.m[11]=c,_.m[12]=u,_.m[13]=f,_.m[14]=d,_.m[15]=p,_._markAsUpdated()},Object.defineProperty(T,'IdentityReadOnly',{get:function(){return T._identityReadOnly},enumerable:!0,configurable:!0}),T.FromValues=function(e,t,i,r,n,o,s,a,l,h,c,u,f,d,p,_){var m=new T;return m.m[0]=e,m.m[1]=t,m.m[2]=i,m.m[3]=r,m.m[4]=n,m.m[5]=o,m.m[6]=s,m.m[7]=a,m.m[8]=l,m.m[9]=h,m.m[10]=c,m.m[11]=u,m.m[12]=f,m.m[13]=d,m.m[14]=p,m.m[15]=_,m},T.Compose=function(e,t,o){var r=T.Identity();return T.ComposeToRef(e,t,o,r),r},T.ComposeToRef=function(e,t,o,r){T.FromValuesToRef(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1,g.Matrix[1]),t.toRotationMatrix(g.Matrix[0]),g.Matrix[1].multiplyToRef(g.Matrix[0],r),r.setTranslation(o)},T.Identity=function(){return T.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},T.IdentityToRef=function(e){T.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e)},T.Zero=function(){return T.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},T.RotationX=function(e){var t=new T;return T.RotationXToRef(e,t),t},T.Invert=function(e){var t=new T;return e.invertToRef(t),t},T.RotationXToRef=function(o,e){var t=B(o),a=F(o);e.m[0]=1,e.m[15]=1,e.m[5]=a,e.m[10]=a,e.m[9]=-t,e.m[6]=t,e.m[1]=0,e.m[2]=0,e.m[3]=0,e.m[4]=0,e.m[7]=0,e.m[8]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e._markAsUpdated()},T.RotationY=function(e){var t=new T;return T.RotationYToRef(e,t),t},T.RotationYToRef=function(o,e){var t=B(o),a=F(o);e.m[5]=1,e.m[15]=1,e.m[0]=a,e.m[2]=-t,e.m[8]=t,e.m[10]=a,e.m[1]=0,e.m[3]=0,e.m[4]=0,e.m[6]=0,e.m[7]=0,e.m[9]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e._markAsUpdated()},T.RotationZ=function(e){var t=new T;return T.RotationZToRef(e,t),t},T.RotationZToRef=function(o,e){var t=B(o),a=F(o);e.m[10]=1,e.m[15]=1,e.m[0]=a,e.m[1]=t,e.m[4]=-t,e.m[5]=a,e.m[2]=0,e.m[3]=0,e.m[6]=0,e.m[7]=0,e.m[8]=0,e.m[9]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e._markAsUpdated()},T.RotationAxis=function(e,t){var o=T.Zero();return T.RotationAxisToRef(e,t,o),o},T.RotationAxisToRef=function(a,e,s){var i=B(-e),r=F(-e),n=1-r;a.normalize(),s.m[0]=a.x*a.x*n+r,s.m[1]=a.x*a.y*n-a.z*i,s.m[2]=a.x*a.z*n+a.y*i,s.m[3]=0,s.m[4]=a.y*a.x*n+a.z*i,s.m[5]=a.y*a.y*n+r,s.m[6]=a.y*a.z*n-a.x*i,s.m[7]=0,s.m[8]=a.z*a.x*n-a.y*i,s.m[9]=a.z*a.y*n+a.x*i,s.m[10]=a.z*a.z*n+r,s.m[11]=0,s.m[15]=1,s._markAsUpdated()},T.RotationYawPitchRoll=function(e,t,o){var r=new T;return T.RotationYawPitchRollToRef(e,t,o,r),r},T.RotationYawPitchRollToRef=function(o,e,t,i){O.RotationYawPitchRollToRef(o,e,t,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(i)},T.Scaling=function(e,t,o){var r=T.Zero();return T.ScalingToRef(e,t,o,r),r},T.ScalingToRef=function(o,e,t,i){i.m[0]=o,i.m[1]=0,i.m[2]=0,i.m[3]=0,i.m[4]=0,i.m[5]=e,i.m[6]=0,i.m[7]=0,i.m[8]=0,i.m[9]=0,i.m[10]=t,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1,i._markAsUpdated()},T.Translation=function(e,t,o){var r=T.Identity();return T.TranslationToRef(e,t,o,r),r},T.TranslationToRef=function(e,t,o,r){T.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,o,1,r)},T.Lerp=function(e,t,o){var r=T.Zero();return T.LerpToRef(e,t,o,r),r},T.LerpToRef=function(o,e,t,i){for(var r=0;16>r;r++)i.m[r]=o.m[r]*(1-t)+e.m[r]*t;i._markAsUpdated()},T.DecomposeLerp=function(e,t,o){var r=T.Zero();return T.DecomposeLerpToRef(e,t,o,r),r},T.DecomposeLerpToRef=function(e,t,i,r){var o=g.Vector3[0],a=g.Quaternion[0],n=g.Vector3[1];e.decompose(o,a,n);var s=g.Vector3[2],l=g.Quaternion[1],c=g.Vector3[3];t.decompose(s,l,c);var u=g.Vector3[4];R.LerpToRef(o,s,i,u);var d=g.Quaternion[2];O.SlerpToRef(a,l,i,d);var p=g.Vector3[5];R.LerpToRef(n,c,i,p),T.ComposeToRef(u,d,p,r)},T.LookAtLH=function(e,t,o){var r=T.Zero();return T.LookAtLHToRef(e,t,o,r),r},T.LookAtLHToRef=function(e,t,i,r){t.subtractToRef(e,this._zAxis),this._zAxis.normalize(),R.CrossToRef(i,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),R.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-R.Dot(this._xAxis,e),n=-R.Dot(this._yAxis,e),a=-R.Dot(this._zAxis,e);return T.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,n,a,1,r)},T.LookAtRH=function(e,t,o){var r=T.Zero();return T.LookAtRHToRef(e,t,o,r),r},T.LookAtRHToRef=function(e,t,i,r){e.subtractToRef(t,this._zAxis),this._zAxis.normalize(),R.CrossToRef(i,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),R.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-R.Dot(this._xAxis,e),n=-R.Dot(this._yAxis,e),a=-R.Dot(this._zAxis,e);return T.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,n,a,1,r)},T.OrthoLH=function(e,t,i,r){var a=T.Zero();return T.OrthoLHToRef(e,t,i,r,a),a},T.OrthoLHToRef=function(e,t,i,r,n){var o=i,s=r;T.FromValuesToRef(2/e,0,0,0,0,2/t,0,0,0,0,2/(s-o),0,0,0,-(s+o)/(s-o),1,n)},T.OrthoOffCenterLH=function(e,t,i,r,n,o){var s=T.Zero();return T.OrthoOffCenterLHToRef(e,t,i,r,n,o,s),s},T.OrthoOffCenterLHToRef=function(e,t,i,r,n,o,s){var a=n,l=o;T.FromValuesToRef(2/(t-e),0,0,0,0,2/(r-i),0,0,0,0,2/(l-a),0,(e+t)/(e-t),(r+i)/(i-r),-(l+a)/(l-a),1,s)},T.OrthoOffCenterRH=function(e,t,i,r,n,o){var s=T.Zero();return T.OrthoOffCenterRHToRef(e,t,i,r,n,o,s),s},T.OrthoOffCenterRHToRef=function(e,t,i,r,n,o,s){T.OrthoOffCenterLHToRef(e,t,i,r,n,o,s),s.m[10]*=-1},T.PerspectiveLH=function(e,t,i,r){var n=T.Zero(),o=i,s=r;return T.FromValuesToRef(2*o/e,0,0,0,0,2*o/t,0,0,0,0,(s+o)/(s-o),1,0,0,-2*s*o/(s-o),0,n),n},T.PerspectiveFovLH=function(e,t,i,r){var a=T.Zero();return T.PerspectiveFovLHToRef(e,t,i,r,a),a},T.PerspectiveFovLHToRef=function(e,t,i,r,n,o){void 0===o&&(o=!0);var s=i,a=r,l=1/y(.5*e),d=o?l/t:l,c=o?l:l*t;T.FromValuesToRef(d,0,0,0,0,c,0,0,0,0,(a+s)/(a-s),1,0,0,-2*a*s/(a-s),0,n)},T.PerspectiveFovRH=function(e,t,i,r){var a=T.Zero();return T.PerspectiveFovRHToRef(e,t,i,r,a),a},T.PerspectiveFovRHToRef=function(e,t,i,r,n,o){void 0===o&&(o=!0);var s=i,a=r,l=1/y(.5*e),d=o?l/t:l,c=o?l:l*t;T.FromValuesToRef(d,0,0,0,0,c,0,0,0,0,-(a+s)/(a-s),-1,0,0,-2*a*s/(a-s),0,n)},T.PerspectiveFovWebVRToRef=function(d,e,t,p,r){void 0===r&&(r=!1);var n=r?-1:1,o=y(d.upDegrees*V/180),s=y(d.downDegrees*V/180),a=y(d.leftDegrees*V/180),l=y(d.rightDegrees*V/180),f=2/(a+l),c=2/(o+s);p.m[0]=f,p.m[1]=p.m[2]=p.m[3]=p.m[4]=0,p.m[5]=c,p.m[6]=p.m[7]=0,p.m[8]=.5*((a-l)*f),p.m[9]=.5*(-(o-s)*c),p.m[10]=-t/(e-t),p.m[11]=1*n,p.m[12]=p.m[13]=p.m[15]=0,p.m[14]=-2*t*e/(t-e),p._markAsUpdated()},T.GetFinalMatrix=function(e,t,i,r,n,o){var s=e.width,a=e.height,d=e.x,p=e.y,c=T.FromValues(s/2,0,0,0,0,-a/2,0,0,0,0,o-n,0,d+s/2,a/2+p,n,1);return t.multiply(i).multiply(r).multiply(c)},T.GetAsMatrix2x2=function(t){return new Float32Array([t.m[0],t.m[1],t.m[4],t.m[5]])},T.GetAsMatrix3x3=function(t){return new Float32Array([t.m[0],t.m[1],t.m[2],t.m[4],t.m[5],t.m[6],t.m[8],t.m[9],t.m[10]])},T.Transpose=function(e){var t=new T;return T.TransposeToRef(e,t),t},T.TransposeToRef=function(r,e){e.m[0]=r.m[0],e.m[1]=r.m[4],e.m[2]=r.m[8],e.m[3]=r.m[12],e.m[4]=r.m[1],e.m[5]=r.m[5],e.m[6]=r.m[9],e.m[7]=r.m[13],e.m[8]=r.m[2],e.m[9]=r.m[6],e.m[10]=r.m[10],e.m[11]=r.m[14],e.m[12]=r.m[3],e.m[13]=r.m[7],e.m[14]=r.m[11],e.m[15]=r.m[15]},T.Reflection=function(e){var t=new T;return T.ReflectionToRef(e,t),t},T.ReflectionToRef=function(l,e){l.normalize();var t=l.normal.x,i=l.normal.y,r=l.normal.z,n=-2*t,o=-2*i,s=-2*r;e.m[0]=n*t+1,e.m[1]=o*t,e.m[2]=s*t,e.m[3]=0,e.m[4]=n*i,e.m[5]=o*i+1,e.m[6]=s*i,e.m[7]=0,e.m[8]=n*r,e.m[9]=o*r,e.m[10]=s*r+1,e.m[11]=0,e.m[12]=n*l.d,e.m[13]=o*l.d,e.m[14]=s*l.d,e.m[15]=1,e._markAsUpdated()},T.FromXYZAxesToRef=function(o,e,t,i){i.m[0]=o.x,i.m[1]=o.y,i.m[2]=o.z,i.m[3]=0,i.m[4]=e.x,i.m[5]=e.y,i.m[6]=e.z,i.m[7]=0,i.m[8]=t.x,i.m[9]=t.y,i.m[10]=t.z,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1,i._markAsUpdated()},T.FromQuaternionToRef=function(d,e){var t=d.x*d.x,i=d.y*d.y,r=d.z*d.z,n=d.x*d.y,o=d.z*d.w,s=d.z*d.x,a=d.y*d.w,l=d.y*d.z,p=d.x*d.w;e.m[0]=1-2*(i+r),e.m[1]=2*(n+o),e.m[2]=2*(s-a),e.m[3]=0,e.m[4]=2*(n-o),e.m[5]=1-2*(r+t),e.m[6]=2*(l+p),e.m[7]=0,e.m[8]=2*(s+a),e.m[9]=2*(l-p),e.m[10]=1-2*(i+t),e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1,e._markAsUpdated()},T._tempQuaternion=new O,T._xAxis=R.Zero(),T._yAxis=R.Zero(),T._zAxis=R.Zero(),T._updateFlagSeed=0,T._identityReadOnly=T.Identity(),T}();P.Matrix=D;var o=function(){function a(o,a,t,i){this.normal=new R(o,a,t),this.d=i}return a.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},a.prototype.clone=function(){return new a(this.normal.x,this.normal.y,this.normal.z,this.d)},a.prototype.getClassName=function(){return'Plane'},a.prototype.getHashCode=function(){var t=this.normal.getHashCode();return t=397*t^(this.d||0)},a.prototype.normalize=function(){var r=$(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return 0!==r&&(e=1/r),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},a.prototype.transform=function(e){var t=D.Transpose(e),i=this.normal.x,r=this.normal.y,n=this.normal.z,o=this.d;return new a(i*t.m[0]+r*t.m[1]+n*t.m[2]+o*t.m[3],i*t.m[4]+r*t.m[5]+n*t.m[6]+o*t.m[7],i*t.m[8]+r*t.m[9]+n*t.m[10]+o*t.m[11],i*t.m[12]+r*t.m[13]+n*t.m[14]+o*t.m[15])},a.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},a.prototype.copyFromPoints=function(p,e,t){var i=e.x-p.x,n=e.y-p.y,o=e.z-p.z,s=t.x-p.x,a=t.y-p.y,l=t.z-p.z,_=n*l-o*a,c=o*s-i*l,u=i*a-n*s,f=$(_*_+c*c+u*u),d;return d=0===f?0:1/f,this.normal.x=_*d,this.normal.y=c*d,this.normal.z=u*d,this.d=-(this.normal.x*p.x+this.normal.y*p.y+this.normal.z*p.z),this},a.prototype.isFrontFacingTo=function(r,e){return R.Dot(this.normal,r)<=e},a.prototype.signedDistanceTo=function(t){return R.Dot(t,this.normal)+this.d},a.FromArray=function(e){return new a(e[0],e[1],e[2],e[3])},a.FromPoints=function(e,t,o){var r=new a(0,0,0,0);return r.copyFromPoints(e,t,o),r},a.FromPositionAndNormal=function(e,t){var o=new a(0,0,0,0);return t.normalize(),o.normal=t,o.d=-(t.x*e.x+t.y*e.y+t.z*e.z),o},a.SignedDistanceToPlaneFromPositionAndNormal=function(o,e,t){var i=-(e.x*o.x+e.y*o.y+e.z*o.z);return R.Dot(t,e)+i},a}();P.Plane=o;var i=function(){function o(o,a,t,i){this.x=o,this.y=a,this.width=t,this.height=i}return o.prototype.toGlobal=function(e,t){if(e.getRenderWidth){var i=e;return this.toGlobal(i.getRenderWidth(),i.getRenderHeight())}var r=e;return new o(this.x*r,this.y*t,this.width*r,this.height*t)},o.prototype.clone=function(){return new o(this.x,this.y,this.width,this.height)},o}();P.Viewport=i;var a=function(){function a(){}return a.GetPlanes=function(e){for(var t=[],i=0;6>i;i++)t.push(new o(0,0,0,0));return a.GetPlanesToRef(e,t),t},a.GetNearPlaneToRef=function(r,e){e.normal.x=r.m[3]+r.m[2],e.normal.y=r.m[7]+r.m[6],e.normal.z=r.m[11]+r.m[10],e.d=r.m[15]+r.m[14],e.normalize()},a.GetFarPlaneToRef=function(r,e){e.normal.x=r.m[3]-r.m[2],e.normal.y=r.m[7]-r.m[6],e.normal.z=r.m[11]-r.m[10],e.d=r.m[15]-r.m[14],e.normalize()},a.GetLeftPlaneToRef=function(r,e){e.normal.x=r.m[3]+r.m[0],e.normal.y=r.m[7]+r.m[4],e.normal.z=r.m[11]+r.m[8],e.d=r.m[15]+r.m[12],e.normalize()},a.GetRightPlaneToRef=function(r,e){e.normal.x=r.m[3]-r.m[0],e.normal.y=r.m[7]-r.m[4],e.normal.z=r.m[11]-r.m[8],e.d=r.m[15]-r.m[12],e.normalize()},a.GetTopPlaneToRef=function(r,e){e.normal.x=r.m[3]-r.m[1],e.normal.y=r.m[7]-r.m[5],e.normal.z=r.m[11]-r.m[9],e.d=r.m[15]-r.m[13],e.normalize()},a.GetBottomPlaneToRef=function(r,e){e.normal.x=r.m[3]+r.m[1],e.normal.y=r.m[7]+r.m[5],e.normal.z=r.m[11]+r.m[9],e.d=r.m[15]+r.m[13],e.normalize()},a.GetPlanesToRef=function(e,t){a.GetNearPlaneToRef(e,t[0]),a.GetFarPlaneToRef(e,t[1]),a.GetLeftPlaneToRef(e,t[2]),a.GetRightPlaneToRef(e,t[3]),a.GetTopPlaneToRef(e,t[4]),a.GetBottomPlaneToRef(e,t[5])},a}();P.Frustum=a,!function(t){t[t.LOCAL=0]='LOCAL',t[t.WORLD=1]='WORLD',t[t.BONE=2]='BONE'}(P.Space||(P.Space={}));var n=function(){function t(){}return t.X=new R(1,0,0),t.Y=new R(0,1,0),t.Z=new R(0,0,1),t}();P.Axis=n;var s=function(){function t(){}return t.interpolate=function(d,e,t,i,r){for(var n=1-3*i+3*e,o=3*i-6*e,s=3*e,a=d,l=0,p;5>l;l++)p=a*a,a-=(n*(p*a)+o*p+s*a-d)*(1/(3*n*p+2*o*a+s)),a=C(1,W(0,a));return 3*x(1-a,2)*a*t+3*(1-a)*x(a,2)*r+x(a,3)},t}();P.BezierCurve=s;var L;!function(t){t[t.CW=0]='CW',t[t.CCW=1]='CCW'}(L=P.Orientation||(P.Orientation={}));var d=function(){function o(t){this._radians=t,0>this._radians&&(this._radians+=2*V)}return o.prototype.degrees=function(){return 180*this._radians/V},o.prototype.radians=function(){return this._radians},o.BetweenTwoPoints=function(e,t){var i=t.subtract(e);return new o(I(i.y,i.x))},o.FromRadians=function(e){return new o(e)},o.FromDegrees=function(e){return new o(e*V/180)},o}();P.Angle=d;var p=function(){function t(r,p,t){this.startPoint=r,this.midPoint=p,this.endPoint=t;var i=x(p.x,2)+x(p.y,2),n=(x(r.x,2)+x(r.y,2)-i)/2,o=(i-x(t.x,2)-x(t.y,2))/2,s=(r.x-p.x)*(p.y-t.y)-(p.x-t.x)*(r.y-p.y);this.centerPoint=new M((n*(p.y-t.y)-o*(r.y-p.y))/s,((r.x-p.x)*o-(p.x-t.x)*n)/s),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=d.BetweenTwoPoints(this.centerPoint,this.startPoint);var a=this.startAngle.degrees(),l=d.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),u=d.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();180<l-a&&(l-=360),-180>l-a&&(l+=360),180<u-l&&(u-=360),-180>u-l&&(u+=360),this.orientation=0>l-a?L.CW:L.CCW,this.angle=d.FromDegrees(this.orientation===L.CW?a-u:u-a)}return t}();P.Arc2=p;var l=function(){function r(r,o){this._points=[],this._length=0,this.closed=!1,this._points.push(new M(r,o))}return r.prototype.addLineTo=function(r,e){if(this.closed)return this;var t=new M(r,e),o=this._points[this._points.length-1];return this._points.push(t),this._length+=t.subtract(o).length(),this},r.prototype.addArcTo=function(r,e,t,i,n){if(void 0===n&&(n=36),this.closed)return this;var o=this._points[this._points.length-1],s=new M(r,e),a=new M(t,i),l=new p(o,s,a),m=l.angle.radians()/n;l.orientation===L.CW&&(m*=-1);for(var c=l.startAngle.radians()+m,u=0;u<n;u++){var f=F(c)*l.radius+l.centerPoint.x,d=B(c)*l.radius+l.centerPoint.y;this.addLineTo(f,d),c+=m}return this},r.prototype.close=function(){return this.closed=!0,this},r.prototype.length=function(){var r=this._length;if(!this.closed){var e=this._points[this._points.length-1];r+=this._points[0].subtract(e).length()}return r},r.prototype.getPoints=function(){return this._points},r.prototype.getPointAtLengthPosition=function(r){if(0>r||1<r)return M.Zero();for(var e=r*this.length(),t=0,i=0;i<this._points.length;i++){var n=(i+1)%this._points.length,o=this._points[i],s=this._points[n],a=s.subtract(o),l=a.length()+t;if(e>=t&&e<=l){var d=a.normalize(),c=e-t;return new M(o.x+d.x*c,o.y+d.y*c)}t=l}return M.Zero()},r.StartingAt=function(e,t){return new r(e,t)},r}();P.Path2=l;var c=function(){function e(o,e,a){void 0===e&&(e=null),this.path=o,this._curve=[],this._distances=[],this._tangents=[],this._normals=[],this._binormals=[];for(var i=0;i<o.length;i++)this._curve[i]=o[i].clone();this._raw=a||!1,this._compute(e)}return e.prototype.getCurve=function(){return this._curve},e.prototype.getTangents=function(){return this._tangents},e.prototype.getNormals=function(){return this._normals},e.prototype.getBinormals=function(){return this._binormals},e.prototype.getDistances=function(){return this._distances},e.prototype.update=function(r,e){void 0===e&&(e=null);for(var t=0;t<r.length;t++)this._curve[t].x=r[t].x,this._curve[t].y=r[t].y,this._curve[t].z=r[t].z;return this._compute(e),this},e.prototype._compute=function(n){var e=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[e-1]=this._curve[e-1].subtract(this._curve[e-2]),this._raw||this._tangents[e-1].normalize();var t=this._tangents[0],i=this._normalVector(this._curve[0],t,n);this._normals[0]=i,this._raw||this._normals[0].normalize(),this._binormals[0]=R.Cross(t,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var r=1,d,o,s,a;r<e;r++)d=this._getLastNonNullVector(r),r<e-1&&(o=this._getFirstNonNullVector(r),this._tangents[r]=d.add(o),this._tangents[r].normalize()),this._distances[r]=this._distances[r-1]+d.length(),s=this._tangents[r],a=this._binormals[r-1],this._normals[r]=R.Cross(a,s),this._raw||this._normals[r].normalize(),this._binormals[r]=R.Cross(s,this._normals[r]),this._raw||this._binormals[r].normalize()},e.prototype._getFirstNonNullVector=function(r){for(var e=1,t=this._curve[r+e].subtract(this._curve[r]);0===t.length()&&r+e+1<this._curve.length;)e++,t=this._curve[r+e].subtract(this._curve[r]);return t},e.prototype._getLastNonNullVector=function(r){for(var e=1,t=this._curve[r].subtract(this._curve[r-e]);0===t.length()&&r>e+1;)e++,t=this._curve[r].subtract(this._curve[r-e]);return t},e.prototype._normalVector=function(e,t,i){var r=t.length(),n;if(0===r&&(r=1),void 0===i||null===i){var o;o=P.Scalar.WithinEpsilon(A(t.y)/r,1,P.Epsilon)?P.Scalar.WithinEpsilon(A(t.x)/r,1,P.Epsilon)?P.Scalar.WithinEpsilon(A(t.z)/r,1,P.Epsilon)?R.Zero():new R(0,0,1):new R(1,0,0):new R(0,-1,0),n=R.Cross(t,o)}else n=R.Cross(t,i),R.CrossToRef(n,t,n);return n.normalize(),n},e}();P.Path3D=c;var u=function(){function d(t){this._length=0,this._points=t,this._length=this._computeLength(t)}return d.CreateQuadraticBezier=function(e,t,i,r){r=2<r?r:3;for(var o=[],n=function(o,e,t,i){return(1-o)*(1-o)*e+2*o*(1-o)*t+o*o*i},a=0;a<=r;a++)o.push(new R(n(a/r,e.x,t.x,i.x),n(a/r,e.y,t.y,i.y),n(a/r,e.z,t.z,i.z)));return new d(o)},d.CreateCubicBezier=function(e,t,i,r,o){o=3<o?o:4;for(var n=[],a=function(o,e,t,i,r){return(1-o)*(1-o)*(1-o)*e+3*o*(1-o)*(1-o)*t+3*o*o*(1-o)*i+o*o*o*r},s=0;s<=o;s++)n.push(new R(a(s/o,e.x,t.x,i.x,r.x),a(s/o,e.y,t.y,i.y,r.y),a(s/o,e.z,t.z,i.z,r.z)));return new d(n)},d.CreateHermiteSpline=function(e,t,i,r,o){for(var n=[],a=0;a<=o;a++)n.push(R.Hermite(e,t,i,r,a*(1/o)));return new d(n)},d.CreateCatmullRomSpline=function(e,t){var i=[];i.push(e[0].clone()),Array.prototype.push.apply(i,e),i.push(e[e.length-1].clone());for(var r=[],o=0,a=0;a<i.length-3;a++){o=0;for(var n=0;n<t;n++)r.push(R.CatmullRom(i[a],i[a+1],i[a+2],i[a+3],o)),o+=1/t}return a--,r.push(R.CatmullRom(i[a],i[a+1],i[a+2],i[a+3],o)),new d(r)},d.prototype.getPoints=function(){return this._points},d.prototype.length=function(){return this._length},d.prototype.continue=function(e){for(var t=this._points[this._points.length-1],i=this._points.slice(),r=e.getPoints(),a=1;a<r.length;a++)i.push(r[a].subtract(r[0]).add(t));return new d(i)},d.prototype._computeLength=function(r){for(var e=0,t=1;t<r.length;t++)e+=r[t].subtract(r[t-1]).length();return e},d}();P.Curve3=u;var f=function(){function t(r,o){void 0===r&&(r=R.Zero()),void 0===o&&(o=R.Up()),this.position=r,this.normal=o}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone())},t}();P.PositionNormalVertex=f;var _=function(){function t(r,o,t){void 0===r&&(r=R.Zero()),void 0===o&&(o=R.Up()),void 0===t&&(t=M.Zero()),this.position=r,this.normal=o,this.uv=t}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone(),this.uv.clone())},t}();P.PositionNormalTextureVertex=_;var m=function(){function t(){}return t.Color3=[S.Black(),S.Black(),S.Black()],t.Vector2=[M.Zero(),M.Zero(),M.Zero()],t.Vector3=[R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero()],t.Vector4=[r.Zero(),r.Zero(),r.Zero()],t.Quaternion=[O.Zero(),O.Zero()],t.Matrix=[D.Zero(),D.Zero(),D.Zero(),D.Zero(),D.Zero(),D.Zero(),D.Zero(),D.Zero()],t}();P.Tmp=m;var g=function(){function t(){}return t.Vector3=[R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero(),R.Zero()],t.Matrix=[D.Zero(),D.Zero()],t.Quaternion=[O.Zero(),O.Zero(),O.Zero()],t}()}(e||(e={}));var e;!function(r){var e=function(){function a(){}return a.WithinEpsilon=function(o,e,t){void 0===t&&(t=1401298e-51);var a=o-e;return-t<=a&&a<=t},a.ToHex=function(r){var e=r.toString(16);return 15>=r?('0'+e).toUpperCase():e.toUpperCase()},a.Sign=function(t){return t=+t,0===t||isNaN(t)?t:0<t?1:-1},a.Clamp=function(r,e,t){return void 0===e&&(e=0),void 0===t&&(t=1),C(t,W(e,r))},a.Log2=function(t){return m(t)*Math.LOG2E},a.Repeat=function(r,e){return r-ee(r/e)*e},a.Normalize=function(r,e,t){return(r-e)/(t-e)},a.Denormalize=function(r,e,t){return r*(t-e)+e},a.DeltaAngle=function(e,t){var o=a.Repeat(t-e,360);return 180<o&&(o-=360),o},a.PingPong=function(e,t){var o=a.Repeat(e,2*t);return t-A(o-t)},a.SmoothStep=function(e,t,o){var r=a.Clamp(o);return r=-2*r*r*r+3*r*r,t*r+e*(1-r)},a.MoveTowards=function(e,t,o){return A(t-e)<=o?t:e+a.Sign(t-e)*o},a.MoveTowardsAngle=function(e,t,i){var s=a.DeltaAngle(e,t),n=0;return-i<s&&s<i?n=t:(t=e+s,n=a.MoveTowards(e,t,i)),n},a.Lerp=function(r,e,t){return r+(e-r)*t},a.LerpAngle=function(e,t,o){var r=a.Repeat(t-e,360);return 180<r&&(r-=360),e+r*a.Clamp(o)},a.InverseLerp=function(e,t,o){return e==t?0:a.Clamp((o-e)/(t-e))},a.Hermite=function(a,e,t,i,r){var n=r*r,o=r*n;return a*(2*o-3*n+1)+t*(-2*o+3*n)+e*(o-2*n+r)+i*(o-n)},a.RandomRange=function(r,e){return r===e?r:Math.random()*(e-r)+r},a.RangeToPercent=function(r,e,t){return(r-e)/(t-e)},a.PercentToRange=function(r,e,t){return(t-e)*r+e},a.NormalizeRadians=function(e){return e-=a.TwoPi*ee((e+V)/a.TwoPi)},a.TwoPi=2*V,a}();r.Scalar=e}(e||(e={}));var e;!function(d){function a(r){var e=r.getClassName();return l[e]||(l[e]={}),l[e]}function e(d){var e=d.getClassName();if(c[e])return c[e];c[e]={};for(var t=c[e],p=d,r=e,n;r;){for(var o in n=l[r],n)t[o]=n[o];var s=void 0,a=!1;do{if(s=Object.getPrototypeOf(p),!s.getClassName){a=!0;break}if(s.getClassName()!==r)break;p=s}while(s);if(a)break;r=s.getClassName(),p=s}return t}function t(t,s){return function(l,r){var n=a(l);n[r]||(n[r]={type:t,sourceName:s})}}function r(r,e){return void 0===e&&(e=null),function(o,t){var i=e||'_'+t;Object.defineProperty(o,t,{get:function(){return this[i]},set:function(e){this[i]!==e&&(this[i]=e,o[r].apply(this))},enumerable:!0,configurable:!0})}}var l={},c={},o=function(i,t,r){var n=i();d.Tags&&d.Tags.AddTagsTo(n,t.tags);var o=e(n);for(var s in o){var a=o[s],l=t[s],p=a.type;void 0!==l&&null!==l&&(0===p||6===p||11===p?n[s]=l:1===p?n[s]=r||l.isRenderTarget?l:l.clone():2===p||3===p||4===p||5===p||7===p||10===p?n[s]=r?l:l.clone():void 0)}return n};d.expandToProperty=function(o,e){return void 0===e&&(e=null),r(o,e)},d.serialize=function(r){return t(0,r)},d.serializeAsTexture=function(r){return t(1,r)},d.serializeAsColor3=function(r){return t(2,r)},d.serializeAsFresnelParameters=function(r){return t(3,r)},d.serializeAsVector2=function(r){return t(4,r)},d.serializeAsVector3=function(r){return t(5,r)},d.serializeAsMeshReference=function(r){return t(6,r)},d.serializeAsColorCurves=function(r){return t(7,r)},d.serializeAsColor4=function(r){return t(8,r)},d.serializeAsImageProcessingConfiguration=function(r){return t(9,r)},d.serializeAsQuaternion=function(r){return t(10,r)},d.serializeAsCameraReference=function(r){return t(11,r)};var i=function(){function r(){}return r.Serialize=function(i,t){t||(t={}),d.Tags&&(t.tags=d.Tags.GetTags(i));var r=e(i);for(var n in r){var o=r[n],s=o.sourceName||n,a=o.type,l=i[n];void 0!==l&&null!==l&&(0===a?t[s]=l:1===a?t[s]=l.serialize():2===a?t[s]=l.asArray():3===a?t[s]=l.serialize():4===a||5===a?t[s]=l.asArray():6===a?t[s]=l.id:7===a?t[s]=l.serialize():8===a?t[s]=l.asArray():9===a?t[s]=l.serialize():10===a?t[s]=l.asArray():11===a?t[s]=l.id:void 0)}return t},r.Parse=function(i,t,r,n){void 0===n&&(n=null);var o=i();n||(n=''),d.Tags&&d.Tags.AddTagsTo(o,t.tags);var s=e(o);for(var a in s){var l=s[a],p=t[l.sourceName||a],c=l.type;if(void 0!==p&&null!==p){var u=o;0===c?u[a]=p:1===c?r&&(u[a]=d.Texture.Parse(p,r,n)):2===c?u[a]=d.Color3.FromArray(p):3===c?u[a]=d.FresnelParameters.Parse(p):4===c?u[a]=d.Vector2.FromArray(p):5===c?u[a]=d.Vector3.FromArray(p):6===c?r&&(u[a]=r.getLastMeshByID(p)):7===c?u[a]=d.ColorCurves.Parse(p):8===c?u[a]=d.Color4.FromArray(p):9===c?u[a]=d.ImageProcessingConfiguration.Parse(p):10===c?u[a]=d.Quaternion.FromArray(p):11===c?r&&(u[a]=r.getCameraByID(p)):void 0}}return o},r.Clone=function(r,e){return o(r,e,!1)},r.Instanciate=function(r,e){return o(r,e,!0)},r}();d.SerializationHelper=i}(e||(e={}));var e;!function(r){var e=function(){function t(){var r=this;this.promise=new Promise(function(e,t){r._resolve=e,r._reject=t})}return Object.defineProperty(t.prototype,'resolve',{get:function(){return this._resolve},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'reject',{get:function(){return this._reject},enumerable:!0,configurable:!0}),t}();r.Deferred=e}(e||(e={}));var e;!function(o){var a=function(){function t(o,a,t,i){void 0===a&&(a=!1),this.initalize(o,a,t,i)}return t.prototype.initalize=function(o,e,t,i){return void 0===e&&(e=!1),this.mask=o,this.skipNextObservers=e,this.target=t,this.currentTarget=i,this},t}();o.EventState=a;var l=function(){function t(r,o,t){void 0===t&&(t=null),this.callback=r,this.mask=o,this.scope=t,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}return t}();o.Observer=l;var e=function(){function d(){}return d.prototype.dispose=function(){if(this._observers&&this._observables)for(var t=0;t<this._observers.length;t++)this._observables[t].remove(this._observers[t]);this._observers=null,this._observables=null},d.Watch=function(e,t,i,r){void 0===i&&(i=-1),void 0===r&&(r=null);var n=new d;n._observers=[],n._observables=e;for(var o=0,s=e;o<s.length;o++){var a=s[o],l=a.add(t,i,!1,r);l&&n._observers.push(l)}return n},d}();o.MultiObserver=e;var t=function(){function t(t){this._observers=[],this._eventState=new a(0),t&&(this._onObserverAdded=t)}return t.prototype.add=function(i,a,t,r,n){if(void 0===a&&(a=-1),void 0===t&&(t=!1),void 0===r&&(r=null),void 0===n&&(n=!1),!i)return null;var o=new l(i,a,r);return o.unregisterOnNextCall=n,t?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),o},t.prototype.remove=function(r){if(!r)return!1;var o=this._observers.indexOf(r);return-1!==o&&(this._observers.splice(o,1),!0)},t.prototype.removeCallback=function(r,e){for(var o=0;o<this._observers.length;o++)if(this._observers[o].callback===r&&(!e||e===this._observers[o].scope))return this._observers.splice(o,1),!0;return!1},t.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,o.Tools.SetImmediate(function(){t.remove(e)})},t.prototype.notifyObservers=function(l,e,t,i){if(void 0===e&&(e=-1),!this._observers.length)return!0;var r=this._eventState;r.mask=e,r.target=t,r.currentTarget=i,r.skipNextObservers=!1,r.lastReturnValue=l;for(var n=0,o=this._observers,s;n<o.length;n++)if(s=o[n],!s._willBeUnregistered&&(s.mask&e&&(r.lastReturnValue=s.scope?s.callback.apply(s.scope,[l,r]):s.callback(l,r),s.unregisterOnNextCall&&this._deferUnregister(s)),r.skipNextObservers))return!1;return!0},t.prototype.notifyObserversWithPromise=function(a,e,t,i){var r=this;void 0===e&&(e=-1);var n=Promise.resolve(a);if(!this._observers.length)return n;var o=this._eventState;return o.mask=e,o.target=t,o.currentTarget=i,o.skipNextObservers=!1,this._observers.forEach(function(s){o.skipNextObservers||s._willBeUnregistered||s.mask&e&&(n=s.scope?n.then(function(e){return o.lastReturnValue=e,s.callback.apply(s.scope,[a,o])}):n.then(function(e){return o.lastReturnValue=e,s.callback(a,o)}),s.unregisterOnNextCall&&r._deferUnregister(s))}),n.then(function(){return a})},t.prototype.notifyObserver=function(o,e,t){void 0===t&&(t=-1);var i=this._eventState;i.mask=t,i.skipNextObservers=!1,o.callback(e,i)},t.prototype.hasObservers=function(){return 0<this._observers.length},t.prototype.clear=function(){this._observers=[],this._onObserverAdded=null},t.prototype.clone=function(){var r=new t;return r._observers=this._observers.slice(0),r},t.prototype.hasSpecificMask=function(o){void 0===o&&(o=-1);for(var e=0,t=this._observers,i;e<t.length;e++)if(i=t[e],i.mask&o||i.mask===o)return!0;return!1},t}();o.Observable=t}(e||(e={}));var e;!function(r){var e=function(){function r(e){this.length=0,this.data=Array(e),this._id=r._GlobalId++}return r.prototype.push=function(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)},r.prototype.forEach=function(r){for(var e=0;e<this.length;e++)r(this.data[e])},r.prototype.sort=function(t){this.data.sort(t)},r.prototype.reset=function(){this.length=0},r.prototype.dispose=function(){this.reset(),this.data&&(this.data.length=0,this.data=[])},r.prototype.concat=function(r){if(0!==r.length){this.length+r.length>this.data.length&&(this.data.length=2*(this.length+r.length));for(var e=0;e<r.length;e++)this.data[this.length++]=(r.data||r)[e]}},r.prototype.indexOf=function(r){var e=this.data.indexOf(r);return e>=this.length?-1:e},r.prototype.contains=function(t){return-1!==this.data.indexOf(t)},r._GlobalId=0,r}();r.SmartArray=e;var t=function(r){function e(){var e=null!==r&&r.apply(this,arguments)||this;return e._duplicateId=0,e}return h(e,r),e.prototype.push=function(e){r.prototype.push.call(this,e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId},e.prototype.pushNoDuplicate=function(t){return(!t.__smartArrayFlags||t.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(t),!0)},e.prototype.reset=function(){r.prototype.reset.call(this),this._duplicateId++},e.prototype.concatWithNoDuplicate=function(r){if(0!==r.length){this.length+r.length>this.data.length&&(this.data.length=2*(this.length+r.length));for(var e=0,t;e<r.length;e++)t=(r.data||r)[e],this.pushNoDuplicate(t)}},e}(e);r.SmartArrayNoDuplicate=t}(e||(e={}));var e;!function(m){function e(r,e){return function(t){t.__bjsclassName__=r,t.__bjsmoduleName__=null==e?null:e}}var u=function(o){function e(t,i){var r=o.call(this,t)||this;return r.request=i,r.name='LoadFileError',e._setPrototypeOf(r,e.prototype),r}return h(e,o),e._setPrototypeOf=Object.setPrototypeOf||function(r,e){return r.__proto__=e,r},e}(Error);m.LoadFileError=u;var o=function(){function t(){}return t.ExponentialBackoff=function(o,e){return void 0===o&&(o=3),void 0===e&&(e=500),function(t,i,r){return 0!==i.status||r>=o||-1!==t.indexOf('file:')?-1:x(2,r)*e}},t}();m.RetryStrategy=o;var r=function(e,t){return e?e instanceof m.Mesh?null:e instanceof m.SubMesh?e.clone(t):e.clone?e.clone():null:null},s=function(){function T(){}return T.Mix=function(r,e,t){return r*(1-t)+e*t},T.Instantiate=function(t){if(T.RegisteredExternalClasses&&T.RegisteredExternalClasses[t])return T.RegisteredExternalClasses[t];for(var e=t.split('.'),i=window||this,a=0,n=e.length;a<n;a++)i=i[e[a]];return'function'==typeof i?i:null},T.Slice=function(r,e,t){return r.slice?r.slice(e,t):Array.prototype.slice.call(r,e,t)},T.SetImmediate=function(t){window.setImmediate?window.setImmediate(t):setTimeout(t,1)},T.IsExponentOfTwo=function(r){var e=1;do e*=2;while(e<r);return e===r},T.FloatRound=function(t){var e=Math.fround;return e?e(t):T._tmpFloatArray[0]=t},T.CeilingPOT=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},T.FloorPOT=function(t){return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,(t|=t>>16)-(t>>1)},T.NearestPOT=function(t){var e=T.CeilingPOT(t),o=T.FloorPOT(t);return e-t>t-o?o:e},T.GetExponentOfTwo=function(e,t,r){void 0===r&&(r=m.Engine.SCALEMODE_NEAREST);var i;switch(r){case m.Engine.SCALEMODE_FLOOR:i=T.FloorPOT(e);break;case m.Engine.SCALEMODE_NEAREST:i=T.NearestPOT(e);break;case m.Engine.SCALEMODE_CEILING:default:i=T.CeilingPOT(e);}return C(i,t)},T.GetFilename=function(r){var e=r.lastIndexOf('/');return 0>e?r:r.substring(e+1)},T.GetFolderPath=function(r,e){void 0===e&&(e=!1);var t=r.lastIndexOf('/');return 0>t?e?r:'':r.substring(0,t+1)},T.GetDOMTextContent=function(r){for(var e='',t=r.firstChild;t;)3===t.nodeType&&(e+=t.textContent),t=t.nextSibling;return e},T.ToDegrees=function(t){return 180*t/V},T.ToRadians=function(t){return t*V/180},T.EncodeArrayBufferTobase64=function(d){for(var e=Number.NaN,p='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',l='',f=0,c=new Uint8Array(d),u,t,i,r,n,o,s;f<c.length;)u=c[f++],t=f<c.length?c[f++]:e,i=f<c.length?c[f++]:e,r=u>>2,n=(3&u)<<4|t>>4,o=(15&t)<<2|i>>6,s=63&i,isNaN(t)?o=s=64:isNaN(i)&&(s=64),l+=p.charAt(r)+p.charAt(n)+p.charAt(o)+p.charAt(s);return'data:image/png;base64,'+l},T.ExtractMinAndMaxIndexed=function(e,t,i,r,n){void 0===n&&(n=null);for(var o=new m.Vector3(S,S,S),d=new m.Vector3(-S,-S,-S),c=i,l;c<i+r;c++)l=new m.Vector3(e[3*t[c]],e[3*t[c]+1],e[3*t[c]+2]),o=m.Vector3.Minimize(l,o),d=m.Vector3.Maximize(l,d);return n&&(o.x-=o.x*n.x+n.y,o.y-=o.y*n.x+n.y,o.z-=o.z*n.x+n.y,d.x+=d.x*n.x+n.y,d.y+=d.y*n.x+n.y,d.z+=d.z*n.x+n.y),{minimum:o,maximum:d}},T.ExtractMinAndMax=function(e,t,i,r,n){void 0===r&&(r=null);var o=new m.Vector3(S,S,S),d=new m.Vector3(-S,-S,-S);n||(n=3);for(var c=t,l;c<t+i;c++)l=new m.Vector3(e[c*n],e[c*n+1],e[c*n+2]),o=m.Vector3.Minimize(l,o),d=m.Vector3.Maximize(l,d);return r&&(o.x-=o.x*r.x+r.y,o.y-=o.y*r.x+r.y,o.z-=o.z*r.x+r.y,d.x+=d.x*r.x+r.y,d.y+=d.y*r.x+r.y,d.z+=d.z*r.x+r.y),{minimum:o,maximum:d}},T.Vector2ArrayFeeder=function(e){return function(t){var o=void 0!==e.BYTES_PER_ELEMENT;if(t>=(o?e.length/2:e.length))return null;if(o){var r=e;return new m.Vector2(r[2*t+0],r[2*t+1])}return e[t]}},T.ExtractMinAndMaxVector2=function(e,t){void 0===t&&(t=null);for(var i=new m.Vector2(S,S),a=new m.Vector2(-S,-S),l=0,o=e(l++);o;)i=m.Vector2.Minimize(o,i),a=m.Vector2.Maximize(o,a),o=e(l++);return t&&(i.x-=i.x*t.x+t.y,i.y-=i.y*t.x+t.y,a.x+=a.x*t.x+t.y,a.y+=a.y*t.x+t.y),{minimum:i,maximum:a}},T.MakeArray=function(r,e){return!0===e||void 0!==r&&null!=r?Array.isArray(r)?r:[r]:null},T.GetPointerPrefix=function(){var t='pointer';return!T.IsWindowObjectExist()||window.PointerEvent||navigator.pointerEnabled||(t='mouse'),t},T.QueueNewFrame=function(t,e){return T.IsWindowObjectExist()?(e||(e=window),e.requestAnimationFrame?e.requestAnimationFrame(t):e.msRequestAnimationFrame?e.msRequestAnimationFrame(t):e.webkitRequestAnimationFrame?e.webkitRequestAnimationFrame(t):e.mozRequestAnimationFrame?e.mozRequestAnimationFrame(t):e.oRequestAnimationFrame?e.oRequestAnimationFrame(t):window.setTimeout(t,16)):setTimeout(t,16)},T.RequestFullscreen=function(r){var e=r.requestFullscreen||r.msRequestFullscreen||r.webkitRequestFullscreen||r.mozRequestFullScreen;e&&e.call(r)},T.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},T.SetCorsBehavior=function(t,o){if((!t||0!==t.indexOf('data:'))&&T.CorsBehavior)if('string'==typeof T.CorsBehavior||T.CorsBehavior instanceof String)o.crossOrigin=T.CorsBehavior;else{var i=T.CorsBehavior(t);i&&(o.crossOrigin=i)}},T.CleanUrl=function(t){return t=t.replace(/#/gm,'%23')},T.LoadImage=function(t,e,r,i){t instanceof ArrayBuffer&&(t=T.EncodeArrayBufferTobase64(t)),t=T.CleanUrl(t),t=T.PreprocessUrl(t);var o=new Image;T.SetCorsBehavior(t,o);var n=function(){o.removeEventListener('load',n),o.removeEventListener('error',a),e(o)},a=function(i){o.removeEventListener('load',n),o.removeEventListener('error',a),T.Error('Error while trying to load image: '+t),r&&r('Error while trying to load image: '+t,i)};o.addEventListener('load',n),o.addEventListener('error',a);var s=function(){o.src=t},l=function(){i&&i.loadImageFromDB(t,o)};if('data:'!==t.substr(0,5)&&i&&i.enableTexturesOffline&&m.Database.IsUASupportingBlobStorage)i.openAsync(l,s);else{if(-1!==t.indexOf('file:')){var d=decodeURIComponent(t.substring(5).toLowerCase());if(m.FilesInput.FilesToLoad[d]){try{var c;try{c=URL.createObjectURL(m.FilesInput.FilesToLoad[d],{oneTimeOnly:!0})}catch(e){c=URL.createObjectURL(m.FilesInput.FilesToLoad[d])}o.src=c}catch(t){o.src=''}return o}}s()}return o},T.LoadFile=function(e,t,i,r,n,a){if(e=T.CleanUrl(e),e=T.PreprocessUrl(e),-1!==e.indexOf('file:')){var o=decodeURIComponent(e.substring(5).toLowerCase());if(m.FilesInput.FilesToLoad[o])return T.ReadFile(m.FilesInput.FilesToLoad[o],t,i,n)}var g=T.BaseUrl+e,c=!1,h={onCompleteObservable:new m.Observable,abort:function(){return c=!0}},s=function(){var m=new XMLHttpRequest,e=null;h.abort=function(){c=!0,m.readyState!==(XMLHttpRequest.DONE||4)&&m.abort(),null!==e&&(clearTimeout(e),e=null)};var r=function(s){m.open('GET',g,!0),n&&(m.responseType='arraybuffer'),i&&m.addEventListener('progress',i);var _=function(){m.removeEventListener('loadend',_),h.onCompleteObservable.notifyObservers(h),h.onCompleteObservable.clear()};m.addEventListener('loadend',_);var d=function(){if(!c&&m.readyState===(XMLHttpRequest.DONE||4)){if(m.removeEventListener('readystatechange',d),200<=m.status&&300>m.status||!T.IsWindowObjectExist()&&0===m.status)return void t(n?m.response:m.responseText,m.responseURL);var i=T.DefaultRetryStrategy;if(i){var o=i(g,m,s);if(-1!==o)return m.removeEventListener('loadend',_),m=new XMLHttpRequest,void(e=setTimeout(function(){return r(s+1)},o))}var p=new u('Error status: '+m.status+' '+m.statusText+' - Unable to load '+g,m);if(!a)throw p;a(m,p)}};m.addEventListener('readystatechange',d),m.send()};r(0)};if(r&&r.enableSceneOffline){var d=function(){c||s()},p=function(){c||r&&r.loadFileFromDB(e,function(r){c||t(r),h.onCompleteObservable.notifyObservers(h)},i?function(t){c||i(t)}:void 0,d,n)};r.openAsync(p,d)}else s();return h},T.LoadScript=function(o,e,a){var t=document.getElementsByTagName('head')[0],r=document.createElement('script');r.type='text/javascript',r.src=o,r.onload=function(){e&&e()},r.onerror=function(e){a&&a('Unable to load script \''+o+'\'',e)},t.appendChild(r)},T.ReadFileAsDataURL=function(e,t,i){var r=new FileReader,a={onCompleteObservable:new m.Observable,abort:function(){return r.abort()}};return r.onloadend=function(){a.onCompleteObservable.notifyObservers(a)},r.onload=function(r){t(r.target.result)},r.onprogress=i,r.readAsDataURL(e),a},T.ReadFile=function(e,t,r,i){var o=new FileReader,n={onCompleteObservable:new m.Observable,abort:function(){return o.abort()}};return o.onloadend=function(){return n.onCompleteObservable.notifyObservers(n)},o.onerror=function(){T.Log('Error while reading file: '+e.name),t(JSON.stringify({autoClear:!0,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))},o.onload=function(r){t(r.target.result)},r&&(o.onprogress=r),i?o.readAsArrayBuffer(e):o.readAsText(e),n},T.FileAsURL=function(r){var e=new Blob([r]);return(window.URL||window.webkitURL).createObjectURL(e)},T.Format=function(r,e){return void 0===e&&(e=2),r.toFixed(e)},T.CheckExtends=function(r,e,t){r.x<e.x&&(e.x=r.x),r.y<e.y&&(e.y=r.y),r.z<e.z&&(e.z=r.z),r.x>t.x&&(t.x=r.x),r.y>t.y&&(t.y=r.y),r.z>t.z&&(t.z=r.z)},T.DeepCopy=function(s,e,t,d){for(var c in s)if(('_'!==c[0]||d&&-1!==d.indexOf(c))&&(!t||-1===t.indexOf(c))){var n=s[c],p=typeof n;if('function'!=p)try{if(!('object'==p))e[c]=n;else if(!(n instanceof Array))e[c]=r(n,e);else if(e[c]=[],0<n.length)if('object'==typeof n[0])for(var a=0,l;a<n.length;a++)l=r(n[a],e),-1===e[c].indexOf(l)&&e[c].push(l);else e[c]=n.slice(0)}catch(t){}}},T.IsEmpty=function(r){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0},T.RegisterTopRootEvents=function(r){for(var e=0,t;e<r.length;e++){t=r[e],window.addEventListener(t.name,t.handler,!1);try{window.parent&&window.parent.addEventListener(t.name,t.handler,!1)}catch(t){}}},T.UnregisterTopRootEvents=function(r){for(var e=0,t;e<r.length;e++){t=r[e],window.removeEventListener(t.name,t.handler);try{window.parent&&window.parent.removeEventListener(t.name,t.handler)}catch(t){}}},T.DumpFramebuffer=function(t,e,i,r,o,n){void 0===o&&(o='image/png');for(var a=4*t,s=i.readPixels(0,0,t,e),l=0;l<e/2;l++)for(var c=0;c<a;c++){var u=c+l*a,d=e-l-1,p=c+d*a,f=s[u];s[u]=s[p],s[p]=f}y||(y=document.createElement('canvas')),y.width=t,y.height=e;var _=y.getContext('2d');if(_){var m=_.createImageData(t,e);m.data.set(s),_.putImageData(m,0,0),T.EncodeScreenshotCanvasData(r,o,n)}},T.EncodeScreenshotCanvasData=function(o,e,a){void 0===e&&(e='image/png');var t=y.toDataURL(e);o?o(t):(y.toBlob||(y.toBlob=function(l,e,t){var i=this;setTimeout(function(){for(var r=atob(i.toDataURL(e,t).split(',')[1]),n=r.length,o=new Uint8Array(n),s=0;s<n;s++)o[s]=r.charCodeAt(s);l(new Blob([o],{type:e||'image/png'}))})}),y.toBlob(function(i){var e=URL.createObjectURL(i);if('download'in document.createElement('a')){var t=window.document.createElement('a');if(t.href=e,a)t.setAttribute('download',a);else{var r=new Date,n=(r.getFullYear()+'-'+(r.getMonth()+1)).slice(-2)+'-'+r.getDate()+'_'+r.getHours()+'-'+('0'+r.getMinutes()).slice(-2);t.setAttribute('download','screenshot_'+n+'.png')}window.document.body.appendChild(t),t.addEventListener('click',function(){t.parentElement&&t.parentElement.removeChild(t)}),t.click()}else{var o=window.open('');if(!o)return;var l=o.document.createElement('img');l.onload=function(){URL.revokeObjectURL(e)},l.src=e,o.document.body.appendChild(l)}}))},T.CreateScreenshot=function(t,e,i,r,o){void 0===o&&(o='image/png');var n,a;if(i.precision)n=O(t.getRenderWidth()*i.precision),a=O(n/t.getAspectRatio(e));else if(i.width&&i.height)n=i.width,a=i.height;else if(i.width&&!i.height)n=i.width,a=O(n/t.getAspectRatio(e));else if(i.height&&!i.width)a=i.height,n=O(a*t.getAspectRatio(e));else{if(isNaN(i))return void T.Error('Invalid \'size\' parameter !');a=i,n=i}y||(y=document.createElement('canvas')),y.width=n,y.height=a;var s=y.getContext('2d'),l=t.getRenderWidth()/t.getRenderHeight(),c=n,u=c/l;u>a&&(u=a,c=u*l);var f=W(0,n-c)/2,d=W(0,a-u)/2,p=t.getRenderingCanvas();s&&p&&s.drawImage(p,f,d,c,u),T.EncodeScreenshotCanvasData(r,o)},T.CreateScreenshotUsingRenderTarget=function(e,t,r,i,o,n,a,s){void 0===o&&(o='image/png'),void 0===n&&(n=1),void 0===a&&(a=!1);var l,_;if(r.precision)l=O(e.getRenderWidth()*r.precision),_=O(l/e.getAspectRatio(t)),r={width:l,height:_};else if(r.width&&r.height)l=r.width,_=r.height;else if(r.width&&!r.height)l=r.width,_=O(l/e.getAspectRatio(t)),r={width:l,height:_};else if(r.height&&!r.width)_=r.height,l=O(_*e.getAspectRatio(t)),r={width:l,height:_};else{if(isNaN(r))return void T.Error('Invalid \'size\' parameter !');_=r,l=r}var g=t.getScene(),f=null;g.activeCamera!==t&&(f=g.activeCamera,g.activeCamera=t);var d=new m.RenderTargetTexture('screenShot',r,g,!1,!1,m.Engine.TEXTURETYPE_UNSIGNED_INT,!1,m.Texture.NEAREST_SAMPLINGMODE);d.renderList=null,d.samples=n,a&&d.addPostProcess(new m.FxaaPostProcess('antialiasing',1,g.activeCamera)),d.onAfterRenderObservable.add(function(){T.DumpFramebuffer(l,_,e,i,o,s)}),g.incrementRenderId(),g.resetCachedMaterial(),d.render(!0),d.dispose(),f&&(g.activeCamera=f),t.getProjectionMatrix(!0)},T.ValidateXHRData=function(e,t){void 0===t&&(t=7);try{if(1&t){if(e.responseText&&0<e.responseText.length)return!0;if(1===t)return!1}if(2&t){var o=m.TGATools.GetTGAHeader(e.response);if(o.width&&o.height&&0<o.width&&0<o.height)return!0;if(2===t)return!1}if(4&t){var r=new Uint8Array(e.response,0,3);return 68===r[0]&&68===r[1]&&83===r[2]}}catch(t){}return!1},T.RandomId=function(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(r){var e=0|16*Math.random();return('x'===r?e:8|3&e).toString(16)})},T.IsBase64=function(t){return!(5>t.length)&&'data:'===t.substr(0,5)},T.DecodeBase64=function(o){for(var e=atob(o.split(',')[1]),t=e.length,i=new Uint8Array(new ArrayBuffer(t)),r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer},Object.defineProperty(T,'NoneLogLevel',{get:function(){return T._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'MessageLogLevel',{get:function(){return T._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'WarningLogLevel',{get:function(){return T._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'ErrorLogLevel',{get:function(){return T._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'AllLogLevel',{get:function(){return T._MessageLogLevel|T._WarningLogLevel|T._ErrorLogLevel},enumerable:!0,configurable:!0}),T._AddLogEntry=function(t){T._LogCache=t+T._LogCache,T.OnNewCacheEntry&&T.OnNewCacheEntry(t)},T._FormatMessage=function(r){var e=function(t){return 10>t?'0'+t:''+t},t=new Date;return'['+e(t.getHours())+':'+e(t.getMinutes())+':'+e(t.getSeconds())+']: '+r},T._LogDisabled=function(){},T._LogEnabled=function(t){var e=T._FormatMessage(t);console.log('BJS - '+e);T._AddLogEntry('<div style=\'color:white\'>'+e+'</div><br>')},T._WarnDisabled=function(){},T._WarnEnabled=function(t){var e=T._FormatMessage(t);console.warn('BJS - '+e);T._AddLogEntry('<div style=\'color:orange\'>'+e+'</div><br>')},T._ErrorDisabled=function(){},T._ErrorEnabled=function(t){T.errorsCount++;var e=T._FormatMessage(t);console.error('BJS - '+e);T._AddLogEntry('<div style=\'color:red\'>'+e+'</div><br>')},Object.defineProperty(T,'LogCache',{get:function(){return T._LogCache},enumerable:!0,configurable:!0}),T.ClearLogCache=function(){T._LogCache='',T.errorsCount=0},Object.defineProperty(T,'LogLevels',{set:function(t){T.Log=(t&T.MessageLogLevel)===T.MessageLogLevel?T._LogEnabled:T._LogDisabled,T.Warn=(t&T.WarningLogLevel)===T.WarningLogLevel?T._WarnEnabled:T._WarnDisabled,T.Error=(t&T.ErrorLogLevel)===T.ErrorLogLevel?T._ErrorEnabled:T._ErrorDisabled},enumerable:!0,configurable:!0}),T.IsWindowObjectExist=function(){return'undefined'!=typeof window},Object.defineProperty(T,'PerformanceNoneLogLevel',{get:function(){return T._PerformanceNoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'PerformanceUserMarkLogLevel',{get:function(){return T._PerformanceUserMarkLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'PerformanceConsoleLogLevel',{get:function(){return T._PerformanceConsoleLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(T,'PerformanceLogLevel',{set:function(t){return(t&T.PerformanceUserMarkLogLevel)===T.PerformanceUserMarkLogLevel?(T.StartPerformanceCounter=T._StartUserMark,void(T.EndPerformanceCounter=T._EndUserMark)):(t&T.PerformanceConsoleLogLevel)===T.PerformanceConsoleLogLevel?(T.StartPerformanceCounter=T._StartPerformanceConsole,void(T.EndPerformanceCounter=T._EndPerformanceConsole)):(T.StartPerformanceCounter=T._StartPerformanceCounterDisabled,void(T.EndPerformanceCounter=T._EndPerformanceCounterDisabled))},enumerable:!0,configurable:!0}),T._StartPerformanceCounterDisabled=function(){},T._EndPerformanceCounterDisabled=function(){},T._StartUserMark=function(t,e){if(void 0===e&&(e=!0),!T._performance){if(!T.IsWindowObjectExist())return;T._performance=window.performance}e&&T._performance.mark&&T._performance.mark(t+'-Begin')},T._EndUserMark=function(t,e){void 0===e&&(e=!0),e&&T._performance.mark&&(T._performance.mark(t+'-End'),T._performance.measure(t,t+'-Begin',t+'-End'))},T._StartPerformanceConsole=function(t,e){void 0===e&&(e=!0),e&&(T._StartUserMark(t,e),console.time&&console.time(t))},T._EndPerformanceConsole=function(t,e){void 0===e&&(e=!0),e&&(T._EndUserMark(t,e),console.time&&console.timeEnd(t))},Object.defineProperty(T,'Now',{get:function(){return T.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()},enumerable:!0,configurable:!0}),T.GetClassName=function(r,o){void 0===o&&(o=!1);var a=null;return!o&&r.getClassName?a=r.getClassName():(r instanceof Object&&(a=(o?r:Object.getPrototypeOf(r)).constructor.__bjsclassName__),a||(a=typeof r)),a},T.First=function(o,e){for(var t=0,i=o,r;t<i.length;t++)if(r=i[t],e(r))return r;return null},T.getFullClassName=function(o,a){void 0===a&&(a=!1);var s=null,i=null;if(!a&&o.getClassName)s=o.getClassName();else{if(o instanceof Object){var r=a?o:Object.getPrototypeOf(o);s=r.constructor.__bjsclassName__,i=r.constructor.__bjsmoduleName__}s||(s=typeof o)}return s?(null==i?'':i+'.')+s:null},T.arrayOrStringFeeder=function(t){return function(e){if(e>=t.length)return null;var o=t.charCodeAt?t.charCodeAt(e):t[e];return o&&o.getHashCode&&(o=o.getHashCode()),'string'==typeof o?T.hashCodeFromStream(T.arrayOrStringFeeder(o)):o}},T.hashCodeFromStream=function(o){for(var e=0,t=0,i=o(t++);null!=i;)e=(e<<5)-e+i,e|=0,i=o(t++);return e},T.DelayAsync=function(r){return new Promise(function(e){setTimeout(function(){e()},r)})},T.BaseUrl='',T.DefaultRetryStrategy=o.ExponentialBackoff(),T.CorsBehavior='anonymous',T.UseFallbackTexture=!0,T.RegisteredExternalClasses={},T.fallbackTexture='data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z',T._tmpFloatArray=new Float32Array(1),T.PreprocessUrl=function(t){return t},T._NoneLogLevel=0,T._MessageLogLevel=1,T._WarningLogLevel=2,T._ErrorLogLevel=4,T._LogCache='',T.errorsCount=0,T.Log=T._LogEnabled,T.Warn=T._WarnEnabled,T.Error=T._ErrorEnabled,T._PerformanceNoneLogLevel=0,T._PerformanceUserMarkLogLevel=1,T._PerformanceConsoleLogLevel=2,T.StartPerformanceCounter=T._StartPerformanceCounterDisabled,T.EndPerformanceCounter=T._EndPerformanceCounterDisabled,T}(),y;m.Tools=s;var t=function(){function r(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(r.prototype,'min',{get:function(){return this._min},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'max',{get:function(){return this._max},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'average',{get:function(){return this._average},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'lastSecAverage',{get:function(){return this._lastSecAverage},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'current',{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'total',{get:function(){return this._totalAccumulated},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'count',{get:function(){return this._totalValueCount},enumerable:!0,configurable:!0}),r.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},r.prototype.addCount=function(e,t){r.Enabled&&(this._current+=e,t&&this._fetchResult())},r.prototype.beginMonitoring=function(){r.Enabled&&(this._startMonitoringTime=s.Now)},r.prototype.endMonitoring=function(e){if(void 0===e&&(e=!0),r.Enabled){e&&this.fetchNewFrame();var t=s.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}},r.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=C(this._min,this._current),this._max=W(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var t=s.Now;1e3<t-this._lastSecTime&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=t,this._lastSecAccumulated=0,this._lastSecValueCount=0)},r.Enabled=!0,r}();m.PerfCounter=t,m.className=e;var i=function(){function a(o,a,t,i){void 0===i&&(i=0),this.iterations=o,this._fn=a,this._successCallback=t,this.index=i-1,this._done=!1}return a.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},a.prototype.breakLoop=function(){this._done=!0,this._successCallback()},a.Run=function(e,t,i,r){void 0===r&&(r=0);var n=new a(e,t,i,r);return n.executeNext(),n},a.SyncAsyncForLoop=function(l,t,i,e,r,o){void 0===o&&(o=0),a.Run(Math.ceil(l/t),function(a){r&&r()?a.breakLoop():setTimeout(function(){for(var e=0,o;e<t&&(o=a.index*t+e,!(o>=l));++e)if(i(o),r&&r()){a.breakLoop();break}a.executeNext()},o)},e)},a}();m.AsyncLoop=i}(e||(e={}));var e;!function(a){var d;!function(t){t[t.Pending=0]='Pending',t[t.Fulfilled=1]='Fulfilled',t[t.Rejected=2]='Rejected'}(d||(d={}));var s=function(){return function(){this.count=0,this.target=0,this.results=[]}}(),t=function(){function l(t){var r=this;if(this._state=d.Pending,this._children=[],this._rejectWasConsumed=!1,t)try{t(function(t){r._resolve(t)},function(t){r._reject(t)})}catch(t){this._reject(t)}}return Object.defineProperty(l.prototype,'_result',{get:function(){return this._resultValue},set:function(t){this._resultValue=t,this._parent&&void 0===this._parent._result&&(this._parent._result=t)},enumerable:!0,configurable:!0}),l.prototype.catch=function(t){return this.then(void 0,t)},l.prototype.then=function(e,t){var r=this,o=new l;return o._onFulfilled=e,o._onRejected=t,this._children.push(o),o._parent=this,this._state!==d.Pending&&a.Tools.SetImmediate(function(){if(r._state===d.Fulfilled||r._rejectWasConsumed){var t=o._resolve(r._result);if(void 0!==t&&null!==t)if(void 0!==t._state){var e=t;o._children.push(e),e._parent=o,o=e}else o._result=t}else o._reject(r._reason)}),o},l.prototype._moveChildren=function(t){var c=this;if((a=this._children).push.apply(a,t.splice(0,t.length)),this._children.forEach(function(t){t._parent=c}),this._state===d.Fulfilled)for(var e=0,r=this._children,i;e<r.length;e++)i=r[e],i._resolve(this._result);else if(this._state===d.Rejected)for(var o=0,n=this._children,i;o<n.length;o++)i=n[o],i._reject(this._reason);var a},l.prototype._resolve=function(t){try{this._state=d.Fulfilled;var e=null;if(this._onFulfilled&&(e=this._onFulfilled(t)),void 0!==e&&null!==e)if(void 0!==e._state){var i=e;i._parent=this,i._moveChildren(this._children),t=i._result}else t=e;this._result=t;for(var r=0,a=this._children;r<a.length;r++)a[r]._resolve(t);this._children.length=0,delete this._onFulfilled,delete this._onRejected}catch(t){this._reject(t,!0)}},l.prototype._reject=function(a,e){if(void 0===e&&(e=!1),this._state=d.Rejected,this._reason=a,this._onRejected&&!e)try{this._onRejected(a),this._rejectWasConsumed=!0}catch(e){a=e}for(var t=0,r=this._children,n;t<r.length;t++)n=r[t],this._rejectWasConsumed?n._resolve(null):n._reject(a);this._children.length=0,delete this._onFulfilled,delete this._onRejected},l.resolve=function(r){var e=new l;return e._resolve(r),e},l._RegisterForFulfillment=function(t,o,i){t.then(function(t){return o.results[i]=t,o.count++,o.count===o.target&&o.rootPromise._resolve(o.results),null},function(t){o.rootPromise._state!==d.Rejected&&o.rootPromise._reject(t)})},l.all=function(r){var e=new l,t=new s;if(t.target=r.length,t.rootPromise=e,r.length)for(var i=0;i<r.length;i++)l._RegisterForFulfillment(r[i],t,i);else e._resolve([]);return e},l.race=function(r){var a=new l;if(r.length)for(var e=0,t=r,i;e<t.length;e++)i=t[e],i.then(function(t){return a&&(a._resolve(t),a=null),null},function(t){a&&(a._reject(t),a=null)});return a},l}(),e=function(){function r(){}return r.Apply=function(r){(void 0===r&&(r=!1),r||'undefined'==typeof Promise)&&(window.Promise=t)},r}();a.PromisePolyfill=e}(e||(e={}));var e;!function(r){var e=function(){function t(t){this._pendingActions=[],this._workerInfos=t.map(function(t){return{worker:t,active:!1}})}return t.prototype.dispose=function(){for(var r=0,e=this._workerInfos;r<e.length;r++)e[r].worker.terminate();delete this._workerInfos,delete this._pendingActions},t.prototype.push=function(o){for(var e=0,t=this._workerInfos,i;e<t.length;e++)if(i=t[e],!i.active)return void this._execute(i,o);this._pendingActions.push(o)},t.prototype._execute=function(r,e){var o=this;r.active=!0,e(r.worker,function(){r.active=!1;var e=o._pendingActions.shift();e&&o._execute(r,e)})},t}();r.WorkerPool=e}(e||(e={}));var e;!function(r){var e=function(){function t(){this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._blendFunctionParameters=[,,,,],this._blendEquationParameters=[,,],this._blendConstants=[,,,,],this.reset()}return Object.defineProperty(t.prototype,'isDirty',{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'alphaBlend',{get:function(){return this._alphaBlend},set:function(t){this._alphaBlend!==t&&(this._alphaBlend=t,this._isAlphaBlendDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.setAlphaBlendConstants=function(o,e,t,i){this._blendConstants[0]===o&&this._blendConstants[1]===e&&this._blendConstants[2]===t&&this._blendConstants[3]===i||(this._blendConstants[0]=o,this._blendConstants[1]=e,this._blendConstants[2]=t,this._blendConstants[3]=i,this._isBlendConstantsDirty=!0)},t.prototype.setAlphaBlendFunctionParameters=function(o,e,t,i){this._blendFunctionParameters[0]===o&&this._blendFunctionParameters[1]===e&&this._blendFunctionParameters[2]===t&&this._blendFunctionParameters[3]===i||(this._blendFunctionParameters[0]=o,this._blendFunctionParameters[1]=e,this._blendFunctionParameters[2]=t,this._blendFunctionParameters[3]=i,this._isBlendFunctionParametersDirty=!0)},t.prototype.setAlphaEquationParameters=function(r,e){this._blendEquationParameters[0]===r&&this._blendEquationParameters[1]===e||(this._blendEquationParameters[0]=r,this._blendEquationParameters[1]=e,this._isBlendEquationParametersDirty=!0)},t.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},t.prototype.apply=function(t){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?t.enable(t.BLEND):t.disable(t.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(t.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(t.blendEquationSeparate(this._isBlendEquationParametersDirty[0],this._isBlendEquationParametersDirty[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(t.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},t}();r._AlphaState=e}(e||(e={}));var e;!function(r){var e=function(){function t(){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,this.reset()}return Object.defineProperty(t.prototype,'isDirty',{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'zOffset',{get:function(){return this._zOffset},set:function(t){this._zOffset!==t&&(this._zOffset=t,this._isZOffsetDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'cullFace',{get:function(){return this._cullFace},set:function(t){this._cullFace!==t&&(this._cullFace=t,this._isCullFaceDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'cull',{get:function(){return this._cull},set:function(t){this._cull!==t&&(this._cull=t,this._isCullDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'depthFunc',{get:function(){return this._depthFunc},set:function(t){this._depthFunc!==t&&(this._depthFunc=t,this._isDepthFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'depthMask',{get:function(){return this._depthMask},set:function(t){this._depthMask!==t&&(this._depthMask=t,this._isDepthMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'depthTest',{get:function(){return this._depthTest},set:function(t){this._depthTest!==t&&(this._depthTest=t,this._isDepthTestDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'frontFace',{get:function(){return this._frontFace},set:function(t){this._frontFace!==t&&(this._frontFace=t,this._isFrontFaceDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1},t.prototype.apply=function(t){this.isDirty&&(this._isCullDirty&&(this.cull?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(t.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(t.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(t.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.zOffset,0)):t.disable(t.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(t.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},t}();r._DepthCullingState=e}(e||(e={}));var e;!function(r){var e=function(){function e(){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.reset()}return Object.defineProperty(e.prototype,'isDirty',{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilFunc',{get:function(){return this._stencilFunc},set:function(t){this._stencilFunc!==t&&(this._stencilFunc=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilFuncRef',{get:function(){return this._stencilFuncRef},set:function(t){this._stencilFuncRef!==t&&(this._stencilFuncRef=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilFuncMask',{get:function(){return this._stencilFuncMask},set:function(t){this._stencilFuncMask!==t&&(this._stencilFuncMask=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilOpStencilFail',{get:function(){return this._stencilOpStencilFail},set:function(t){this._stencilOpStencilFail!==t&&(this._stencilOpStencilFail=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilOpDepthFail',{get:function(){return this._stencilOpDepthFail},set:function(t){this._stencilOpDepthFail!==t&&(this._stencilOpDepthFail=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilOpStencilDepthPass',{get:function(){return this._stencilOpStencilDepthPass},set:function(t){this._stencilOpStencilDepthPass!==t&&(this._stencilOpStencilDepthPass=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilMask',{get:function(){return this._stencilMask},set:function(t){this._stencilMask!==t&&(this._stencilMask=t,this._isStencilMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'stencilTest',{get:function(){return this._stencilTest},set:function(t){this._stencilTest!==t&&(this._stencilTest=t,this._isStencilTestDirty=!0)},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=r.Engine.ALWAYS,this._stencilFuncRef=1,this._stencilFuncMask=255,this._stencilOpStencilFail=r.Engine.KEEP,this._stencilOpDepthFail=r.Engine.KEEP,this._stencilOpStencilDepthPass=r.Engine.REPLACE,this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},e.prototype.apply=function(t){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(t.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(t.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(t.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},e}();r._StencilState=e}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(R){var d=function(i,e,t,r,a){return p(i,a+(r?r+'\n':'')+e,t)},p=function(o,e,t){var i=o.createShader('vertex'===t?o.VERTEX_SHADER:o.FRAGMENT_SHADER);if(o.shaderSource(i,e),o.compileShader(i),!o.getShaderParameter(i,o.COMPILE_STATUS)){var a=o.getShaderInfoLog(i);if(a)throw new Error(a)}if(!i)throw new Error('Something went wrong while compile the shader.');return i},S=function(e,t,i){var r=i.NEAREST,a=i.NEAREST;return e===R.Texture.BILINEAR_SAMPLINGMODE?(r=i.LINEAR,a=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR):e===R.Texture.TRILINEAR_SAMPLINGMODE?(r=i.LINEAR,a=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR):e===R.Texture.NEAREST_SAMPLINGMODE?(r=i.NEAREST,a=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST):e===R.Texture.NEAREST_NEAREST_MIPNEAREST?(r=i.NEAREST,a=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST):e===R.Texture.NEAREST_LINEAR_MIPNEAREST?(r=i.NEAREST,a=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR):e===R.Texture.NEAREST_LINEAR_MIPLINEAR?(r=i.NEAREST,a=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR):e===R.Texture.NEAREST_LINEAR?(r=i.NEAREST,a=i.LINEAR):e===R.Texture.NEAREST_NEAREST?(r=i.NEAREST,a=i.NEAREST):e===R.Texture.LINEAR_NEAREST_MIPNEAREST?(r=i.LINEAR,a=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST):e===R.Texture.LINEAR_NEAREST_MIPLINEAR?(r=i.LINEAR,a=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST):e===R.Texture.LINEAR_LINEAR?(r=i.LINEAR,a=i.LINEAR):e===R.Texture.LINEAR_NEAREST?(r=i.LINEAR,a=i.NEAREST):void 0,{min:a,mag:r}},e=function(e,t,i,r,n,o){void 0===o&&(o=null);var s=function(){i[t]=d,i._internalCount++,r&&r._removePendingData(d),6===i._internalCount&&n(i)},l=function(i,e){r&&r._removePendingData(d),o&&o(i,e)},d;d=R.Tools.LoadImage(e,s,l,r?r.database:null),r&&r._addPendingData(d)},t=function(n,l,t,i,r){void 0===r&&(r=null);var o=[];o._internalCount=0;for(var s=0;6>s;s++)e(i[s],s,o,l,t,r)},r=function(){return function(){}}(),o=function(){return function(){}}();R.InstancingAttributeInfo=o;var _=function(){return function(){}}();R.RenderTargetCreationOptions=_;var i=function(){return function(){}}();R.DepthTextureCreationOptions=i;var l=function(){return function(){}}();R.EngineCapabilities=l;var a=function(){function I(e,t,i,a){void 0===a&&(a=!1);var o=this;this.forcePOTTextures=!1,this.isFullscreen=!1,this.isPointerLock=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.scenes=[],this.postProcesses=[],this.onResizeObservable=new R.Observable,this.onCanvasBlurObservable=new R.Observable,this.onCanvasFocusObservable=new R.Observable,this.onCanvasPointerOutObservable=new R.Observable,this.onBeforeTextureInitObservable=new R.Observable,this._vrDisplay=void 0,this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.disableUniformBuffers=!1,this._uniformBuffers=[],this.onBeginFrameObservable=new R.Observable,this.onEndFrameObservable=new R.Observable,this.onBeforeShaderCompilationObservable=new R.Observable,this.onAfterShaderCompilationObservable=new R.Observable,this._windowIsBackground=!1,this._webGLVersion=1,this._badOS=!1,this._badDesktopOS=!1,this.disableTextureBindingOptimization=!1,this.onVRDisplayChangedObservable=new R.Observable,this.onVRRequestPresentComplete=new R.Observable,this.onVRRequestPresentStart=new R.Observable,this._colorWrite=!0,this._drawCalls=new R.PerfCounter,this._textureCollisions=new R.PerfCounter,this._renderingQueueLaunched=!1,this._activeRenderLoops=[],this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this.onContextLostObservable=new R.Observable,this.onContextRestoredObservable=new R.Observable,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this._performanceMonitor=new R.PerformanceMonitor,this._fps=60,this._deltaTime=0,this.disablePerformanceMonitorInBackground=!1,this._depthCullingState=new R._DepthCullingState,this._stencilState=new R._StencilState,this._alphaState=new R._AlphaState,this._alphaMode=I.ALPHA_DISABLE,this._internalTexturesCache=[],this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=[],this._currentBufferPointers=[],this._currentInstanceLocations=[],this._currentInstanceBuffers=[],this._firstBoundInternalTextureTracker=new R.DummyInternalTextureTracker,this._lastBoundInternalTextureTracker=new R.DummyInternalTextureTracker,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=[],this._maxSimultaneousTextures=0,this._activeRequests=[],this._texturesSupported=[],this._onVRFullScreenTriggered=function(){if(o._vrDisplay&&o._vrDisplay.isPresenting){o._oldSize=new R.Size(o.getRenderWidth(),o.getRenderHeight()),o._oldHardwareScaleFactor=o.getHardwareScalingLevel();var e=o._vrDisplay.getEyeParameters('left');o.setHardwareScalingLevel(1),o.setSize(2*e.renderWidth,e.renderHeight)}else o.setHardwareScalingLevel(o._oldHardwareScaleFactor),o.setSize(o._oldSize.width,o._oldSize.height)},this._boundUniforms={},R.PromisePolyfill.Apply();var n=null;if(I.Instances.push(this),e){if(i=i||{},e.getContext){if(n=e,this._renderingCanvas=n,null!=t&&(i.antialias=t),void 0===i.deterministicLockstep&&(i.deterministicLockstep=!1),void 0===i.lockstepMaxSteps&&(i.lockstepMaxSteps=4),void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.audioEngine&&(i.audioEngine=!0),void 0===i.stencil&&(i.stencil=!0),this._deterministicLockstep=i.deterministicLockstep,this._lockstepMaxSteps=i.lockstepMaxSteps,this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent)for(var s=navigator.userAgent,h=0,c=I.ExceptionList;h<c.length;h++){var u=c[h],f=u.key,d=u.targets;if(-1<s.indexOf(f)){if(u.capture&&u.captureConstraint){var p=u.capture,_=u.captureConstraint,m=new RegExp(p),g=m.exec(s);if(g&&0<g.length){var v=parseInt(g[g.length-1]);if(v>=_)continue}}for(var y=0,b=d,x;y<b.length;y++)x=b[y],'uniformBuffer'===x?this.disableUniformBuffers=!0:'textureBindingOptimization'===x?this.disableTextureBindingOptimization=!0:void 0}}if(!i.disableWebGL2Support)try{this._gl=n.getContext('webgl2',i)||n.getContext('experimental-webgl2',i),this._gl&&(this._webGLVersion=2)}catch(t){}if(!this._gl){if(!n)throw new Error('The provided canvas is null or undefined.');try{this._gl=n.getContext('webgl',i)||n.getContext('experimental-webgl',i)}catch(t){throw new Error('WebGL not supported')}}if(!this._gl)throw new Error('WebGL not supported');this._onCanvasFocus=function(){o.onCanvasFocusObservable.notifyObservers(o)},this._onCanvasBlur=function(){o.onCanvasBlurObservable.notifyObservers(o)},n.addEventListener('focus',this._onCanvasFocus),n.addEventListener('blur',this._onCanvasBlur),this._onBlur=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.disable(),o._windowIsBackground=!0},this._onFocus=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.enable(),o._windowIsBackground=!1},this._onCanvasPointerOut=function(t){o.onCanvasPointerOutObservable.notifyObservers(t)},window.addEventListener('blur',this._onBlur),window.addEventListener('focus',this._onFocus),n.addEventListener('pointerout',this._onCanvasPointerOut),this._doNotHandleContextLost||(this._onContextLost=function(e){e.preventDefault(),o._contextWasLost=!0,R.Tools.Warn('WebGL context lost.'),o.onContextLostObservable.notifyObservers(o)},this._onContextRestored=function(){setTimeout(function(){o._initGLContext(),o._rebuildEffects(),o._rebuildInternalTextures(),o._rebuildBuffers(),o.wipeCaches(!0),R.Tools.Warn('WebGL context successfully restored.'),o.onContextRestoredObservable.notifyObservers(o),o._contextWasLost=!1},0)},n.addEventListener('webglcontextlost',this._onContextLost,!1),n.addEventListener('webglcontextrestored',this._onContextRestored,!1))}else this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample&&(this._webGLVersion=2),i.stencil=this._gl.getContextAttributes().stencil;var T=i.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=a?1/C(T,window.devicePixelRatio||1):1,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext(),n&&(this._onFullscreenChange=function(){void 0===document.fullscreen?void 0===document.mozFullScreen?void 0===document.webkitIsFullScreen?void 0!==document.msIsFullScreen&&(o.isFullscreen=document.msIsFullScreen):o.isFullscreen=document.webkitIsFullScreen:o.isFullscreen=document.mozFullScreen:o.isFullscreen=document.fullscreen,o.isFullscreen&&o._pointerLockRequested&&n&&(n.requestPointerLock=n.requestPointerLock||n.msRequestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock,n.requestPointerLock&&n.requestPointerLock())},document.addEventListener('fullscreenchange',this._onFullscreenChange,!1),document.addEventListener('mozfullscreenchange',this._onFullscreenChange,!1),document.addEventListener('webkitfullscreenchange',this._onFullscreenChange,!1),document.addEventListener('msfullscreenchange',this._onFullscreenChange,!1),this._onPointerLockChange=function(){o.isPointerLock=document.mozPointerLockElement===n||document.webkitPointerLockElement===n||document.msPointerLockElement===n||document.pointerLockElement===n},document.addEventListener('pointerlockchange',this._onPointerLockChange,!1),document.addEventListener('mspointerlockchange',this._onPointerLockChange,!1),document.addEventListener('mozpointerlockchange',this._onPointerLockChange,!1),document.addEventListener('webkitpointerlockchange',this._onPointerLockChange,!1),this._onVRDisplayPointerRestricted=function(){n&&n.requestPointerLock()},this._onVRDisplayPointerUnrestricted=function(){document.exitPointerLock()},window.addEventListener('vrdisplaypointerrestricted',this._onVRDisplayPointerRestricted,!1),window.addEventListener('vrdisplaypointerunrestricted',this._onVRDisplayPointerUnrestricted,!1)),i.audioEngine&&R.AudioEngine&&!I.audioEngine&&(I.audioEngine=new R.AudioEngine);for(var E=0;E<this._caps.maxVertexAttribs;E++)this._currentBufferPointers[E]=new r;this._linkTrackers(this._firstBoundInternalTextureTracker,this._lastBoundInternalTextureTracker),i.autoEnableWebVR&&this.initWebVR(),this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),console.log('Babylon.js engine (v'+I.Version+') launched'),this.enableOfflineSupport=void 0!==R.Database}}return Object.defineProperty(I,'LastCreatedEngine',{get:function(){return 0===I.Instances.length?null:I.Instances[I.Instances.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(I,'LastCreatedScene',{get:function(){var t=I.LastCreatedEngine;return t?0===t.scenes.length?null:t.scenes[t.scenes.length-1]:null},enumerable:!0,configurable:!0}),I.MarkAllMaterialsAsDirty=function(a,e){for(var t=0;t<I.Instances.length;t++)for(var i=I.Instances[t],r=0;r<i.scenes.length;r++)i.scenes[r].markAllMaterialsAsDirty(a,e)},Object.defineProperty(I,'NEVER',{get:function(){return I._NEVER},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALWAYS',{get:function(){return I._ALWAYS},enumerable:!0,configurable:!0}),Object.defineProperty(I,'LESS',{get:function(){return I._LESS},enumerable:!0,configurable:!0}),Object.defineProperty(I,'EQUAL',{get:function(){return I._EQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(I,'LEQUAL',{get:function(){return I._LEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(I,'GREATER',{get:function(){return I._GREATER},enumerable:!0,configurable:!0}),Object.defineProperty(I,'GEQUAL',{get:function(){return I._GEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(I,'NOTEQUAL',{get:function(){return I._NOTEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(I,'KEEP',{get:function(){return I._KEEP},enumerable:!0,configurable:!0}),Object.defineProperty(I,'REPLACE',{get:function(){return I._REPLACE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'INCR',{get:function(){return I._INCR},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DECR',{get:function(){return I._DECR},enumerable:!0,configurable:!0}),Object.defineProperty(I,'INVERT',{get:function(){return I._INVERT},enumerable:!0,configurable:!0}),Object.defineProperty(I,'INCR_WRAP',{get:function(){return I._INCR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DECR_WRAP',{get:function(){return I._DECR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_DISABLE',{get:function(){return I._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_ONEONE',{get:function(){return I._ALPHA_ONEONE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_ADD',{get:function(){return I._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_COMBINE',{get:function(){return I._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_SUBTRACT',{get:function(){return I._ALPHA_SUBTRACT},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_MULTIPLY',{get:function(){return I._ALPHA_MULTIPLY},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_MAXIMIZED',{get:function(){return I._ALPHA_MAXIMIZED},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_PREMULTIPLIED',{get:function(){return I._ALPHA_PREMULTIPLIED},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_PREMULTIPLIED_PORTERDUFF',{get:function(){return I._ALPHA_PREMULTIPLIED_PORTERDUFF},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_INTERPOLATE',{get:function(){return I._ALPHA_INTERPOLATE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'ALPHA_SCREENMODE',{get:function(){return I._ALPHA_SCREENMODE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DELAYLOADSTATE_NONE',{get:function(){return I._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DELAYLOADSTATE_LOADED',{get:function(){return I._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DELAYLOADSTATE_LOADING',{get:function(){return I._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(I,'DELAYLOADSTATE_NOTLOADED',{get:function(){return I._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_ALPHA',{get:function(){return I._TEXTUREFORMAT_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_LUMINANCE',{get:function(){return I._TEXTUREFORMAT_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_R32F',{get:function(){return I._TEXTUREFORMAT_R32F},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_RG32F',{get:function(){return I._TEXTUREFORMAT_RG32F},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_RGB32F',{get:function(){return I._TEXTUREFORMAT_RGB32F},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_RGBA32F',{get:function(){return I._TEXTUREFORMAT_RGBA32F},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_LUMINANCE_ALPHA',{get:function(){return I._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_RGB',{get:function(){return I._TEXTUREFORMAT_RGB},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTUREFORMAT_RGBA',{get:function(){return I._TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTURETYPE_UNSIGNED_INT',{get:function(){return I._TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTURETYPE_FLOAT',{get:function(){return I._TEXTURETYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(I,'TEXTURETYPE_HALF_FLOAT',{get:function(){return I._TEXTURETYPE_HALF_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(I,'SCALEMODE_FLOOR',{get:function(){return I._SCALEMODE_FLOOR},enumerable:!0,configurable:!0}),Object.defineProperty(I,'SCALEMODE_NEAREST',{get:function(){return I._SCALEMODE_NEAREST},enumerable:!0,configurable:!0}),Object.defineProperty(I,'SCALEMODE_CEILING',{get:function(){return I._SCALEMODE_CEILING},enumerable:!0,configurable:!0}),Object.defineProperty(I,'Version',{get:function(){return'3.2.0'},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'isInVRExclusivePointerMode',{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'supportsUniformBuffers',{get:function(){return 1<this.webGLVersion&&!this.disableUniformBuffers},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'needPOTTextures',{get:function(){return 2>this._webGLVersion||this.forcePOTTextures},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'performanceMonitor',{get:function(){return this._performanceMonitor},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'texturesSupported',{get:function(){return this._texturesSupported},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'textureFormatInUse',{get:function(){return this._textureFormatInUse},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'currentViewport',{get:function(){return this._cachedViewport},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'emptyTexture',{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,I.TEXTUREFORMAT_RGBA,!1,!1,R.Texture.NEAREST_SAMPLINGMODE)),this._emptyTexture},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'emptyTexture3D',{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,I.TEXTUREFORMAT_RGBA,!1,!1,R.Texture.NEAREST_SAMPLINGMODE)),this._emptyTexture3D},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'emptyCubeTexture',{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4);this._emptyCubeTexture=this.createRawCubeTexture([e,e,e,e,e,e],1,I.TEXTUREFORMAT_RGBA,I.TEXTURETYPE_UNSIGNED_INT,!1,!1,R.Texture.NEAREST_SAMPLINGMODE)}return this._emptyCubeTexture},enumerable:!0,configurable:!0}),I.prototype._rebuildInternalTextures=function(){for(var r=this._internalTexturesCache.slice(),e=0,t=r;e<t.length;e++)t[e]._rebuild()},I.prototype._rebuildEffects=function(){for(var e in this._compiledEffects)this._compiledEffects[e]._prepareEffect();R.Effect.ResetCache()},I.prototype._rebuildBuffers=function(){for(var o=0,e=this.scenes,t;o<e.length;o++)t=e[o],t.resetCachedMaterial(),t._rebuildGeometries(),t._rebuildTextures();for(var i=0,r=this._uniformBuffers;i<r.length;i++)r[i]._rebuild()},I.prototype._initGLContext=function(){this._caps=new l,this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxCombinedTexturesImageUnits=this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureImageUnits=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._caps.maxVaryingVectors=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),this._caps.maxFragmentUniformVectors=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxVertexUniformVectors=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),this._glVersion=this._gl.getParameter(this._gl.VERSION);var d=this._gl.getExtension('WEBGL_debug_renderer_info');if(null!=d&&(this._glRenderer=this._gl.getParameter(d.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(d.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor='Unknown vendor'),this._glRenderer||(this._glRenderer='Unknown renderer'),this._gl.HALF_FLOAT_OES=36193,34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.standardDerivatives=1<this._webGLVersion||null!==this._gl.getExtension('OES_standard_derivatives'),this._caps.astc=this._gl.getExtension('WEBGL_compressed_texture_astc')||this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_astc'),this._caps.s3tc=this._gl.getExtension('WEBGL_compressed_texture_s3tc')||this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_s3tc'),this._caps.pvrtc=this._gl.getExtension('WEBGL_compressed_texture_pvrtc')||this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_pvrtc'),this._caps.etc1=this._gl.getExtension('WEBGL_compressed_texture_etc1')||this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc1'),this._caps.etc2=this._gl.getExtension('WEBGL_compressed_texture_etc')||this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc')||this._gl.getExtension('WEBGL_compressed_texture_es3_0'),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension('EXT_texture_filter_anisotropic')||this._gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic')||this._gl.getExtension('MOZ_EXT_texture_filter_anisotropic'),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.uintIndices=1<this._webGLVersion||null!==this._gl.getExtension('OES_element_index_uint'),this._caps.fragmentDepthSupported=1<this._webGLVersion||null!==this._gl.getExtension('EXT_frag_depth'),this._caps.highPrecisionShaderSupported=!0,this._caps.timerQuery=this._gl.getExtension('EXT_disjoint_timer_query_webgl2')||this._gl.getExtension('EXT_disjoint_timer_query'),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=0<this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)),this._caps.colorBufferFloat=1<this._webGLVersion&&this._gl.getExtension('EXT_color_buffer_float'),this._caps.textureFloat=!!(1<this._webGLVersion||this._gl.getExtension('OES_texture_float')),this._caps.textureFloatLinearFiltering=this._caps.textureFloat&&this._gl.getExtension('OES_texture_float_linear'),this._caps.textureFloatRender=this._caps.textureFloat&&this._canRenderToFloatFramebuffer(),this._caps.textureHalfFloat=!!(1<this._webGLVersion||this._gl.getExtension('OES_texture_half_float')),this._caps.textureHalfFloatLinearFiltering=!!(1<this._webGLVersion||this._caps.textureHalfFloat&&this._gl.getExtension('OES_texture_half_float_linear')),1<this._webGLVersion&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._caps.textureLOD=!!(1<this._webGLVersion||this._gl.getExtension('EXT_shader_texture_lod')),1<this._webGLVersion)this._caps.drawBuffersExtension=!0;else{var e=this._gl.getExtension('WEBGL_draw_buffers');if(null!==e){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var t=0;16>t;t++)this._gl['COLOR_ATTACHMENT'+t+'_WEBGL']=e['COLOR_ATTACHMENT'+t+'_WEBGL']}else this._caps.drawBuffersExtension=!1}if(1<this._webGLVersion)this._caps.depthTextureExtension=!0;else{var i=this._gl.getExtension('WEBGL_depth_texture');null!=i&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(1<this._webGLVersion)this._caps.vertexArrayObject=!0;else{var r=this._gl.getExtension('OES_vertex_array_object');null==r?this._caps.vertexArrayObject=!1:(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=r.createVertexArrayOES.bind(r),this._gl.bindVertexArray=r.bindVertexArrayOES.bind(r),this._gl.deleteVertexArray=r.deleteVertexArrayOES.bind(r))}if(1<this._webGLVersion)this._caps.instancedArrays=!0;else{var n=this._gl.getExtension('ANGLE_instanced_arrays');null==n?this._caps.instancedArrays=!1:(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=n.drawArraysInstancedANGLE.bind(n),this._gl.drawElementsInstanced=n.drawElementsInstancedANGLE.bind(n),this._gl.vertexAttribDivisor=n.vertexAttribDivisorANGLE.bind(n))}if(this._caps.astc&&this.texturesSupported.push('-astc.ktx'),this._caps.s3tc&&this.texturesSupported.push('-dxt.ktx'),this._caps.pvrtc&&this.texturesSupported.push('-pvrtc.ktx'),this._caps.etc2&&this.texturesSupported.push('-etc2.ktx'),this._caps.etc1&&this.texturesSupported.push('-etc1.ktx'),this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&(this._caps.highPrecisionShaderSupported=0!==o.precision)}this.setDepthBuffer(!0),this.setDepthFunctionToLessOrEqual(),this.setDepthWrite(!0),this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var s=0;s<this._maxSimultaneousTextures;s++)this._nextFreeTextureSlots.push(s)},Object.defineProperty(I.prototype,'webGLVersion',{get:function(){return this._webGLVersion},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'isStencilEnable',{get:function(){return this._isStencilEnable},enumerable:!0,configurable:!0}),I.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=document.createElement('canvas');var t=this._workingCanvas.getContext('2d');t&&(this._workingContext=t)}},I.prototype.resetTextureCache=function(){for(var r in this._boundTexturesCache)if(this._boundTexturesCache.hasOwnProperty(r)){var e=this._boundTexturesCache[r];e&&this._removeDesignatedSlot(e),this._boundTexturesCache[r]=null}if(!this.disableTextureBindingOptimization){this._nextFreeTextureSlots=[];for(var t=0;t<this._maxSimultaneousTextures;t++)this._nextFreeTextureSlots.push(t)}this._currentTextureChannel=-1},I.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},I.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},I.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},I.prototype.getAspectRatio=function(r,e){void 0===e&&(e=!1);var t=r.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)},I.prototype.getRenderWidth=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._gl.drawingBufferWidth},I.prototype.getRenderHeight=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._gl.drawingBufferHeight},I.prototype.getRenderingCanvas=function(){return this._renderingCanvas},I.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},I.prototype.setHardwareScalingLevel=function(t){this._hardwareScalingLevel=t,this.resize()},I.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},I.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},I.prototype.getCaps=function(){return this._caps},Object.defineProperty(I.prototype,'drawCalls',{get:function(){return R.Tools.Warn('drawCalls is deprecated. Please use SceneInstrumentation class'),0},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'drawCallsPerfCounter',{get:function(){return R.Tools.Warn('drawCallsPerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),I.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},I.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},I.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER},I.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL},I.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS},I.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL},I.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},I.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},I.prototype.getStencilMask=function(){return this._stencilState.stencilMask},I.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},I.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},I.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},I.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},I.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},I.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},I.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},I.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},I.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},I.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},I.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},I.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},I.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},I.prototype.setDitheringState=function(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},I.prototype.setRasterizerState=function(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},I.prototype.stopRenderLoop=function(r){if(!r)return void(this._activeRenderLoops=[]);var o=this._activeRenderLoops.indexOf(r);0<=o&&this._activeRenderLoops.splice(o,1)},I.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++)(0,this._activeRenderLoops[t])();this.endFrame()}}if(0<this._activeRenderLoops.length){var o=null;this._vrDisplay&&this._vrDisplay.isPresenting&&(o=this._vrDisplay),this._frameHandler=R.Tools.QueueNewFrame(this._bindedRenderFunction,o)}else this._renderingQueueLaunched=!1},I.prototype.runRenderLoop=function(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._bindedRenderFunction=this._renderLoop.bind(this),this._frameHandler=R.Tools.QueueNewFrame(this._bindedRenderFunction)))},I.prototype.switchFullscreen=function(e){this.isFullscreen?R.Tools.ExitFullscreen():(this._pointerLockRequested=e,this._renderingCanvas&&R.Tools.RequestFullscreen(this._renderingCanvas))},I.prototype.clear=function(o,e,t,i){void 0===i&&(i=!1),this.applyStates();var r=0;e&&o&&(this._gl.clearColor(o.r,o.g,o.b,void 0===o.a?1:o.a),r|=this._gl.COLOR_BUFFER_BIT),t&&(this._gl.clearDepth(1),r|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(0),r|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(r)},I.prototype.scissorClear=function(l,e,t,i,r){var n=this._gl,o=n.getParameter(n.SCISSOR_TEST),s=n.getParameter(n.SCISSOR_BOX);n.enable(n.SCISSOR_TEST),n.scissor(l,e,t,i),this.clear(r,!0,!0,!0),n.scissor(s[0],s[1],s[2],s[3]),!0===o?n.enable(n.SCISSOR_TEST):n.disable(n.SCISSOR_TEST)},I.prototype.setViewport=function(a,e,t){var i=e||this.getRenderWidth(),r=t||this.getRenderHeight(),n=a.x||0,o=a.y||0;this._cachedViewport=a,this._gl.viewport(n*i,o*r,i*a.width,r*a.height)},I.prototype.setDirectViewport=function(o,e,t,i){var r=this._cachedViewport;return this._cachedViewport=null,this._gl.viewport(o,e,t,i),r},I.prototype.beginFrame=function(){this.onBeginFrameObservable.notifyObservers(this),this._measureFps()},I.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.submitFrame(),this.onEndFrameObservable.notifyObservers(this)},I.prototype.resize=function(){if(!this._vrDisplay||!this._vrDisplay.isPresenting){var r=this._renderingCanvas?this._renderingCanvas.clientWidth:window.innerWidth,e=this._renderingCanvas?this._renderingCanvas.clientHeight:window.innerHeight;this.setSize(r/this._hardwareScalingLevel,e/this._hardwareScalingLevel)}},I.prototype.setSize=function(a,e){if(this._renderingCanvas&&(this._renderingCanvas.width!==a||this._renderingCanvas.height!==e)){this._renderingCanvas.width=a,this._renderingCanvas.height=e;for(var t=0;t<this.scenes.length;t++)for(var i=this.scenes[t],r=0,n;r<i.cameras.length;r++)n=i.cameras[r],n._currentRenderId=0;this.onResizeObservable.hasObservers&&this.onResizeObservable.notifyObservers(this)}},I.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},I.prototype.getVRDevice=function(){return this._vrDisplay},I.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},I.prototype.initWebVRAsync=function(){var r=this,t=function(){var o={vrDisplay:r._vrDisplay,vrSupported:r._vrSupported};r.onVRDisplayChangedObservable.notifyObservers(o),r._webVRInitPromise=new Promise(function(e){e(o)})};return this._onVrDisplayConnect||(this._onVrDisplayConnect=function(o){r._vrDisplay=o.display,t()},this._onVrDisplayDisconnect=function(){r._vrDisplay.cancelAnimationFrame(r._frameHandler),r._vrDisplay=void 0,r._frameHandler=R.Tools.QueueNewFrame(r._bindedRenderFunction),t()},this._onVrDisplayPresentChange=function(){r._vrExclusivePointerMode=r._vrDisplay&&r._vrDisplay.isPresenting},window.addEventListener('vrdisplayconnect',this._onVrDisplayConnect),window.addEventListener('vrdisplaydisconnect',this._onVrDisplayDisconnect),window.addEventListener('vrdisplaypresentchange',this._onVrDisplayPresentChange)),this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(t),this._webVRInitPromise},I.prototype.enableVR=function(){var r=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var e=function(){r.onVRRequestPresentComplete.notifyObservers(!0),r._onVRFullScreenTriggered()},t=function(){r.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this),this._vrDisplay.requestPresent([{source:this.getRenderingCanvas()}]).then(e).catch(t)}},I.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(this._onVRFullScreenTriggered).catch(this._onVRFullScreenTriggered)},I.prototype._getVRDisplaysAsync=function(){var r=this;return new Promise(function(e){navigator.getVRDisplays?navigator.getVRDisplays().then(function(t){r._vrSupported=!0,r._vrDisplay=t[0],e({vrDisplay:r._vrDisplay,vrSupported:r._vrSupported})}):(r._vrDisplay=void 0,r._vrSupported=!1,e({vrDisplay:r._vrDisplay,vrSupported:r._vrSupported}))})},I.prototype.bindFramebuffer=function(a,e,t,i,r,l){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=a,this.bindUnboundFramebuffer(a._MSAAFramebuffer?a._MSAAFramebuffer:a._framebuffer);var o=this._gl;a.isCube&&(void 0===e&&(e=0),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+e,a._webGLTexture,0),l&&(l._generateStencilBuffer?o.framebufferTexture2D(o.FRAMEBUFFER,o.DEPTH_STENCIL_ATTACHMENT,o.TEXTURE_CUBE_MAP_POSITIVE_X+e,l._webGLTexture,0):o.framebufferTexture2D(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.TEXTURE_CUBE_MAP_POSITIVE_X+e,l._webGLTexture,0))),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,t,i):o.viewport(0,0,t||a.width,i||a.height),this.wipeCaches()},I.prototype.bindUnboundFramebuffer=function(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)},I.prototype.unBindFramebuffer=function(o,e,t){void 0===e&&(e=!1),this._currentRenderTarget=null;var i=this._gl;o._MSAAFramebuffer&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,o._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,o._framebuffer),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)),!o.generateMipMaps||e||o.isCube||(this._bindTextureDirectly(i.TEXTURE_2D,o,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null)),t&&(o._MSAAFramebuffer&&this.bindUnboundFramebuffer(o._framebuffer),t()),this.bindUnboundFramebuffer(null)},I.prototype.unBindMultiColorAttachmentFramebuffer=function(l,e,t){void 0===e&&(e=!1),this._currentRenderTarget=null;var i=this._gl;if(l[0]._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,l[0]._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,l[0]._framebuffer);var r=l[0]._attachments;r||(r=Array(l.length),l[0]._attachments=r);for(var n=0;n<l.length;n++){for(var o=l[n],s=0;s<r.length;s++)r[s]=i.NONE;r[n]=i[1<this.webGLVersion?'COLOR_ATTACHMENT'+n:'COLOR_ATTACHMENT'+n+'_WEBGL'],i.readBuffer(r[n]),i.drawBuffers(r),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(var n=0;n<r.length;n++)r[n]=i[1<this.webGLVersion?'COLOR_ATTACHMENT'+n:'COLOR_ATTACHMENT'+n+'_WEBGL'];i.drawBuffers(r)}for(var n=0,o;n<l.length;n++)o=l[n],!o.generateMipMaps||e||o.isCube||(this._bindTextureDirectly(i.TEXTURE_2D,o),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null));t&&(l[0]._MSAAFramebuffer&&this.bindUnboundFramebuffer(l[0]._framebuffer),t()),this.bindUnboundFramebuffer(null)},I.prototype.generateMipMapsForCubemap=function(r){if(r.generateMipMaps){var e=this._gl;this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,r,!0),e.generateMipmap(e.TEXTURE_CUBE_MAP),this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,null)}},I.prototype.flushFramebuffer=function(){this._gl.flush()},I.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this.bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},I.prototype.createUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error('Unable to create uniform buffer');return this.bindUniformBuffer(e),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),e.references=1,e},I.prototype.createDynamicUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error('Unable to create dynamic uniform buffer');return this.bindUniformBuffer(e),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),e.references=1,e},I.prototype.updateUniformBuffer=function(o,e,t,i){this.bindUniformBuffer(o),void 0===t&&(t=0),void 0===i?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)},I.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},I.prototype.createVertexBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error('Unable to create vertex buffer');return this.bindArrayBuffer(e),r instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,r,this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),e.references=1,e},I.prototype.createDynamicVertexBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error('Unable to create dynamic vertex buffer');return this.bindArrayBuffer(e),r instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),e.references=1,e},I.prototype.updateDynamicIndexBuffer=function(o,e,t){void 0===t&&(t=0),this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(o);var i;i=e instanceof Uint16Array||e instanceof Uint32Array?e:o.is32Bits?new Uint32Array(e):new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},I.prototype.updateDynamicVertexBuffer=function(o,e,t,i){this.bindArrayBuffer(o),void 0===t&&(t=0),void 0===i?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e=e instanceof ArrayBuffer?new Uint8Array(e,t,i):new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()},I.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},I.prototype.createIndexBuffer=function(a,e){var t=this._gl.createBuffer();if(!t)throw new Error('Unable to create index buffer');this.bindIndexBuffer(t);var s=!1,n;if(a instanceof Uint16Array)n=a;else if(!this._caps.uintIndices)n=new Uint16Array(a);else if(a instanceof Uint32Array)n=a,s=!0;else{for(var r=0;r<a.length;r++)if(65535<a[r]){s=!0;break}n=s?new Uint32Array(a):new Uint16Array(a)}return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,e?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),t.references=1,t.is32Bits=s,t},I.prototype.bindArrayBuffer=function(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(t,this._gl.ARRAY_BUFFER)},I.prototype.bindUniformBuffer=function(t){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,t)},I.prototype.bindUniformBufferBase=function(r,e){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,r)},I.prototype.bindUniformBlock=function(o,e,t){var i=this._gl.getUniformBlockIndex(o,e);this._gl.uniformBlockBinding(o,i,t)},I.prototype.bindIndexBuffer=function(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)},I.prototype.bindBuffer=function(r,e){(this._vaoRecordInProgress||this._currentBoundBuffer[e]!==r)&&(this._gl.bindBuffer(e,r),this._currentBoundBuffer[e]=r)},I.prototype.updateArrayBuffer=function(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)},I.prototype._vertexAttribPointer=function(d,e,t,i,r,n,o){var s=this._currentBufferPointers[e],a=!1;s.active?(s.buffer!==d&&(s.buffer=d,a=!0),s.size!==t&&(s.size=t,a=!0),s.type!==i&&(s.type=i,a=!0),s.normalized!==r&&(s.normalized=r,a=!0),s.stride!==n&&(s.stride=n,a=!0),s.offset!==o&&(s.offset=o,a=!0)):(a=!0,s.active=!0,s.index=e,s.size=t,s.type=i,s.normalized=r,s.stride=n,s.offset=o,s.buffer=d),(a||this._vaoRecordInProgress)&&(this.bindArrayBuffer(d),this._gl.vertexAttribPointer(e,t,i,r,n,o))},I.prototype._bindIndexBufferWithCache=function(t){null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)},I.prototype._bindVertexBuffersAttributes=function(a,e){var t=e.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var i=0,r;i<t.length;i++)if(r=e.getAttributeLocation(i),0<=r){var n=a[t[i]];if(!n)continue;this._gl.enableVertexAttribArray(r),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[r]=!0);var l=n.getBuffer();l&&(this._vertexAttribPointer(l,r,n.getSize(),n.type,n.normalized,n.byteStride,n.byteOffset),n.getIsInstanced()&&(this._gl.vertexAttribDivisor(r,n.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(l))))}},I.prototype.recordVertexArrayObject=function(o,e,t){var i=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(i),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(o,t),this.bindIndexBuffer(e),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),i},I.prototype.bindVertexArrayObject=function(r,e){this._cachedVertexArrayObject!==r&&(this._cachedVertexArrayObject=r,this._gl.bindVertexArray(r),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=e&&e.is32Bits,this._mustWipeVertexAttributes=!0)},I.prototype.bindBuffersDirectly=function(d,e,t,i,r){if(this._cachedVertexBuffers!==d||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=d,this._cachedEffectForVertexBuffers=r;var n=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,s=0;s<n;s++)if(s<t.length){var a=r.getAttributeLocation(s);0<=a&&(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0,this._vertexAttribPointer(d,a,t[s],this._gl.FLOAT,!1,i,o)),o+=4*t[s]}}this._bindIndexBufferWithCache(e)},I.prototype._unbindVertexArrayObject=function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},I.prototype.bindBuffers=function(r,e,t){this._cachedVertexBuffers===r&&this._cachedEffectForVertexBuffers===t||(this._cachedVertexBuffers=r,this._cachedEffectForVertexBuffers=t,this._bindVertexBuffersAttributes(r,t)),this._bindIndexBufferWithCache(e)},I.prototype.unbindInstanceAttributes=function(){for(var o=0,t=this._currentInstanceLocations.length,i,e;o<t;o++){e=this._currentInstanceBuffers[o],i!=e&&e.references&&(i=e,this.bindArrayBuffer(e));var r=this._currentInstanceLocations[o];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},I.prototype.releaseVertexArrayObject=function(t){this._gl.deleteVertexArray(t)},I.prototype._releaseBuffer=function(t){return 0==--t.references&&(this._gl.deleteBuffer(t),!0)},I.prototype.createInstancesBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error('Unable to create instance buffer');return e.capacity=r,this.bindArrayBuffer(e),this._gl.bufferData(this._gl.ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),e},I.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},I.prototype.updateAndBindInstancesBuffer=function(l,e,t){if(this.bindArrayBuffer(l),e&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e),void 0!==t[0].index){for(var i=0,r=0,n;r<t.length;r++)n=t[r],i+=4*n.attributeSize;for(var r=0,n;r<t.length;r++)n=t[r],this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(l,n.index,n.attributeSize,n.attribyteType||this._gl.FLOAT,n.normalized||!1,i,n.offset),this._gl.vertexAttribDivisor(n.index,1),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(l)}else for(var o=0,s;4>o;o++)s=t[o],this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(l,s,4,this._gl.FLOAT,!1,64,16*o),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(l)},I.prototype.applyStates=function(){this._depthCullingState.apply(this._gl),this._stencilState.apply(this._gl),this._alphaState.apply(this._gl)},I.prototype.draw=function(e,t,o,r){this.drawElementsType(e?R.Material.TriangleFillMode:R.Material.WireFrameFillMode,t,o,r)},I.prototype.drawPointClouds=function(e,t,o){this.drawArraysType(R.Material.PointFillMode,e,t,o)},I.prototype.drawUnIndexed=function(e,t,o,r){this.drawArraysType(e?R.Material.TriangleFillMode:R.Material.WireFrameFillMode,t,o,r)},I.prototype.drawElementsType=function(a,e,t,i){this.applyStates(),this._drawCalls.addCount(1,!1);var r=this._drawMode(a),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;i?this._gl.drawElementsInstanced(r,t,n,e*o,i):this._gl.drawElements(r,t,n,e*o)},I.prototype.drawArraysType=function(o,e,t,i){this.applyStates(),this._drawCalls.addCount(1,!1);var r=this._drawMode(o);i?this._gl.drawArraysInstanced(r,e,t,i):this._gl.drawArrays(r,e,t)},I.prototype._drawMode=function(e){return e===R.Material.TriangleFillMode?this._gl.TRIANGLES:e===R.Material.PointFillMode?this._gl.POINTS:e===R.Material.WireFrameFillMode?this._gl.LINES:e===R.Material.PointListDrawMode?this._gl.POINTS:e===R.Material.LineListDrawMode?this._gl.LINES:e===R.Material.LineLoopDrawMode?this._gl.LINE_LOOP:e===R.Material.LineStripDrawMode?this._gl.LINE_STRIP:e===R.Material.TriangleStripDrawMode?this._gl.TRIANGLE_STRIP:e===R.Material.TriangleFanDrawMode?this._gl.TRIANGLE_FAN:this._gl.TRIANGLES},I.prototype._releaseEffect=function(t){this._compiledEffects[t._key]&&(delete this._compiledEffects[t._key],this._deleteProgram(t.getProgram()))},I.prototype._deleteProgram=function(t){t&&(t.__SPECTOR_rebuildProgram=null,t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),this._gl.deleteProgram(t))},I.prototype.createEffect=function(e,t,i,r,n,o,s,a,l){var _=e.vertexElement||e.vertex||e,c=e.fragmentElement||e.fragment||e,u=_+'+'+c+'@'+(n||t.defines);if(this._compiledEffects[u]){var f=this._compiledEffects[u];return s&&f.isReady()&&s(f),f}var d=new R.Effect(e,t,i,r,this,n,o,s,a,l);return d._key=u,this._compiledEffects[u]=d,d},I.prototype.createEffectForParticles=function(a,l,t,i,r,n,o){return void 0===l&&(l=[]),void 0===t&&(t=[]),void 0===i&&(i=''),this.createEffect({vertex:'particles',fragmentElement:a},['position','color','options'],['view','projection'].concat(l),['diffuseSampler'].concat(t),i,r,n,o)},I.prototype.createRawShaderProgram=function(i,e,t,r){void 0===r&&(r=null),t=t||this._gl;var a=p(t,i,'vertex'),o=p(t,e,'fragment');return this._createShaderProgram(a,o,t,r)},I.prototype.createShaderProgram=function(t,e,i,r,n){void 0===n&&(n=null),r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var o=1<this._webGLVersion?'#version 300 es\n#define WEBGL2 \n':'',s=d(r,t,'vertex',i,o),a=d(r,e,'fragment',i,o),l=this._createShaderProgram(s,a,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),l},I.prototype._createShaderProgram=function(a,e,t,i){void 0===i&&(i=null);var r=t.createProgram();if(!r)throw new Error('Unable to create program');if(t.attachShader(r,a),t.attachShader(r,e),1<this.webGLVersion&&i){var l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(r,i),r.transformFeedback=l}if(t.linkProgram(r),1<this.webGLVersion&&i&&this.bindTransformFeedback(null),!t.getProgramParameter(r,t.LINK_STATUS)){t.validateProgram(r);var o=t.getProgramInfoLog(r);if(o)throw new Error(o)}return t.deleteShader(a),t.deleteShader(e),r},I.prototype.getUniforms=function(o,e){for(var t=[],i=0;i<e.length;i++)t.push(this._gl.getUniformLocation(o,e[i]));return t},I.prototype.getAttributes=function(o,e){for(var t=[],i=0;i<e.length;i++)try{t.push(this._gl.getAttribLocation(o,e[i]))}catch(r){t.push(-1)}return t},I.prototype.enableEffect=function(t){t&&(this.bindSamplers(t),this._currentEffect=t,t.onBind&&t.onBind(t),t.onBindObservable.notifyObservers(t))},I.prototype.setIntArray=function(r,e){r&&this._gl.uniform1iv(r,e)},I.prototype.setIntArray2=function(r,e){r&&0==e.length%2&&this._gl.uniform2iv(r,e)},I.prototype.setIntArray3=function(r,e){r&&0==e.length%3&&this._gl.uniform3iv(r,e)},I.prototype.setIntArray4=function(r,e){r&&0==e.length%4&&this._gl.uniform4iv(r,e)},I.prototype.setFloatArray=function(r,e){r&&this._gl.uniform1fv(r,e)},I.prototype.setFloatArray2=function(r,e){r&&0==e.length%2&&this._gl.uniform2fv(r,e)},I.prototype.setFloatArray3=function(r,e){r&&0==e.length%3&&this._gl.uniform3fv(r,e)},I.prototype.setFloatArray4=function(r,e){r&&0==e.length%4&&this._gl.uniform4fv(r,e)},I.prototype.setArray=function(r,e){r&&this._gl.uniform1fv(r,e)},I.prototype.setArray2=function(r,e){r&&0==e.length%2&&this._gl.uniform2fv(r,e)},I.prototype.setArray3=function(r,e){r&&0==e.length%3&&this._gl.uniform3fv(r,e)},I.prototype.setArray4=function(r,e){r&&0==e.length%4&&this._gl.uniform4fv(r,e)},I.prototype.setMatrices=function(r,e){r&&this._gl.uniformMatrix4fv(r,!1,e)},I.prototype.setMatrix=function(r,e){r&&this._gl.uniformMatrix4fv(r,!1,e.toArray())},I.prototype.setMatrix3x3=function(r,e){r&&this._gl.uniformMatrix3fv(r,!1,e)},I.prototype.setMatrix2x2=function(r,e){r&&this._gl.uniformMatrix2fv(r,!1,e)},I.prototype.setInt=function(r,e){r&&this._gl.uniform1i(r,e)},I.prototype.setFloat=function(r,e){r&&this._gl.uniform1f(r,e)},I.prototype.setFloat2=function(r,e,t){r&&this._gl.uniform2f(r,e,t)},I.prototype.setFloat3=function(o,e,t,i){o&&this._gl.uniform3f(o,e,t,i)},I.prototype.setBool=function(r,e){r&&this._gl.uniform1i(r,e)},I.prototype.setFloat4=function(o,e,t,i,r){o&&this._gl.uniform4f(o,e,t,i,r)},I.prototype.setColor3=function(r,e){r&&this._gl.uniform3f(r,e.r,e.g,e.b)},I.prototype.setColor4=function(r,e,t){r&&this._gl.uniform4f(r,e.r,e.g,e.b,t)},I.prototype.setDirectColor4=function(r,e){r&&this._gl.uniform4f(r,e.r,e.g,e.b,e.a)},I.prototype.setState=function(a,e,t,i){void 0===e&&(e=0),void 0===i&&(i=!1),(this._depthCullingState.cull!==a||t)&&(this._depthCullingState.cull=a);var r=this.cullBackFaces?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==r||t)&&(this._depthCullingState.cullFace=r),this.setZOffset(e);var n=i?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==n||t)&&(this._depthCullingState.frontFace=n)},I.prototype.setZOffset=function(t){this._depthCullingState.zOffset=t},I.prototype.getZOffset=function(){return this._depthCullingState.zOffset},I.prototype.setDepthBuffer=function(t){this._depthCullingState.depthTest=t},I.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},I.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},I.prototype.setColorWrite=function(t){this._gl.colorMask(t,t,t,t),this._colorWrite=t},I.prototype.getColorWrite=function(){return this._colorWrite},I.prototype.setAlphaConstants=function(o,e,t,i){this._alphaState.setAlphaBlendConstants(o,e,t,i)},I.prototype.setAlphaMode=function(r,e){(void 0===e&&(e=!1),this._alphaMode!==r)&&(r===I.ALPHA_DISABLE?this._alphaState.alphaBlend=!1:r===I.ALPHA_PREMULTIPLIED?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_PREMULTIPLIED_PORTERDUFF?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0):r===I.ALPHA_COMBINE?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_ONEONE?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_ADD?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_SUBTRACT?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_MULTIPLY?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_MAXIMIZED?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0):r===I.ALPHA_INTERPOLATE?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0):r===I.ALPHA_SCREENMODE?(this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0):void 0,e||this.setDepthWrite(r===I.ALPHA_DISABLE),this._alphaMode=r)},I.prototype.getAlphaMode=function(){return this._alphaMode},I.prototype.wipeCaches=function(t){this.preventCacheWipeBetweenFrames&&!t||(this._currentEffect=null,t&&(this.resetTextureCache(),this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this.setDepthFunctionToLessOrEqual(),this._alphaState.reset()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this._unbindVertexArrayObject(),this.bindIndexBuffer(null))},I.prototype.setTextureFormatToUse=function(o){for(var e=0,t=this.texturesSupported.length;e<t;e++)for(var i=0,r=o.length;i<r;i++)if(this._texturesSupported[e]===o[i].toLowerCase())return this._textureFormatInUse=this._texturesSupported[e];return this._textureFormatInUse=null,null},I.prototype._createTexture=function(){var t=this._gl.createTexture();if(!t)throw new Error('Unable to create texture');return t},I.prototype.createTexture=function(e,S,M,C,r,t,o,a,n,O){var c=this;void 0===r&&(r=R.Texture.TRILINEAR_SAMPLINGMODE),void 0===t&&(t=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===n&&(n=null),void 0===O&&(O=null);var s=e+'',u='data:'===s.substr(0,5),f='blob:'===s.substr(0,5),p=u&&-1!==s.indexOf('base64'),_=n||new R.InternalTexture(this,R.InternalTexture.DATASOURCE_URL),m=s.lastIndexOf('.'),g=0<m?s.substring(m).toLowerCase():'',v=this.getCaps().s3tc&&0===g.indexOf('.dds'),y=0===g.indexOf('.tga'),b=!1;!this._textureFormatInUse||p||n||(s=s.substring(0,m)+this._textureFormatInUse,b=!0),C&&C._addPendingData(_),_.url=s,_.generateMipMaps=!S,_.samplingMode=r,_.invertY=M,this._doNotHandleContextLost||(_._buffer=a);var x=null;t&&!n&&(x=_.onLoadedObservable.add(t)),n||this._internalTexturesCache.push(_);var T=function(t,i){C&&C._removePendingData(_),x&&_.onLoadedObservable.remove(x),b?c.createTexture(e,S,M,C,r,null,o,a,_):R.Tools.UseFallbackTexture&&c.createTexture(R.Tools.fallbackTexture,S,M,C,r,null,o,a,_),o&&o(t||'Unknown error',i)},E=null;if(b||y||v)b?E=function(e){var t=new R.KhronosTextureContainer(e,1);c._prepareWebGLTexture(_,C,t.pixelWidth,t.pixelHeight,M,!1,!0,function(){return t.uploadLevels(c._gl,!S),!1},r)}:y?E=function(e){var t=new Uint8Array(e),o=R.TGATools.GetTGAHeader(t);c._prepareWebGLTexture(_,C,o.width,o.height,M,S,!1,function(){return R.TGATools.UploadContent(c._gl,t),!1},r)}:v&&(E=function(e){var t=R.DDSTools.GetDDSInfo(e),o=(t.isRGB||t.isLuminance||1<t.mipmapCount)&&!S&&1==t.width>>t.mipmapCount-1;c._prepareWebGLTexture(_,C,t.width,t.height,M,!o,t.isFourCC,function(){return R.DDSTools.UploadDDSLevels(c,c._gl,e,t,o,1),!1},r)}),a?E&&E(a):this._loadFile(s,function(t){E&&E(t)},void 0,C?C.database:void 0,!0,function(r,e){T('Unable to load '+(r&&r.responseURL,e))});else{var P=function(e){f&&!c._doNotHandleContextLost&&(_._buffer=e),c._prepareWebGLTexture(_,C,e.width,e.height,M,S,!1,function(t,i,r){var o=c._gl,n=e.width===t&&e.height===i,a=O?c._getInternalFormat(O):'.jpg'===g?o.RGB:o.RGBA;if(n)return o.texImage2D(o.TEXTURE_2D,0,a,a,o.UNSIGNED_BYTE,e),!1;var s=new R.InternalTexture(c,R.InternalTexture.DATASOURCE_TEMP);return c._bindTextureDirectly(o.TEXTURE_2D,s,!0),o.texImage2D(o.TEXTURE_2D,0,a,a,o.UNSIGNED_BYTE,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),c._rescaleTexture(s,_,C,a,function(){c._releaseTexture(s),c._bindTextureDirectly(o.TEXTURE_2D,_,!0),r()}),!0},r)};!u||p?a instanceof HTMLImageElement?P(a):R.Tools.LoadImage(s,P,T,C?C.database:null):a instanceof Array||'string'==typeof a||a instanceof ArrayBuffer?R.Tools.LoadImage(a,P,T,C?C.database:null):P(a)}return _},I.prototype._rescaleTexture=function(n,t,i,r,o){var s=this,a=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:I.TEXTURETYPE_UNSIGNED_INT,samplingMode:R.Texture.BILINEAR_SAMPLINGMODE,generateDepthBuffer:!1,generateStencilBuffer:!1});this._rescalePostProcess||(this._rescalePostProcess=new R.PassPostProcess('rescale',1,null,R.Texture.BILINEAR_SAMPLINGMODE,this,!1,I.TEXTURETYPE_UNSIGNED_INT)),this._rescalePostProcess.getEffect().executeWhenCompiled(function(){s._rescalePostProcess.onApply=function(t){t._bindTexture('textureSampler',n)};var l=i;l||(l=s.scenes[s.scenes.length-1]),l.postProcessManager.directRender([s._rescalePostProcess],a,!0),s._bindTextureDirectly(s._gl.TEXTURE_2D,t,!0),s._gl.copyTexImage2D(s._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),s.unBindFramebuffer(a),s._releaseTexture(a),o&&o()})},I.prototype.updateRawTexture=function(n,e,t,i,r,o){if(void 0===r&&(r=null),void 0===o&&(o=I.TEXTURETYPE_UNSIGNED_INT),n){var s=this._getRGBABufferInternalSizedFormat(o,t),a=this._getInternalFormat(t),l=this._getWebGLTextureType(o);this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===i?1:i?1:0),this._doNotHandleContextLost||(n._bufferView=e,n.format=t,n.type=o,n.invertY=i,n._compression=r),0!=n.width%4&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],n.width,n.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,n.width,n.height,0,a,l,e),n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0}},I.prototype.createRawTexture=function(e,t,r,o,i,a,n,s,l){void 0===s&&(s=null),void 0===l&&(l=I.TEXTURETYPE_UNSIGNED_INT);var c=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_RAW);c.baseWidth=t,c.baseHeight=r,c.width=t,c.height=r,c.format=o,c.generateMipMaps=i,c.samplingMode=n,c.invertY=a,c._compression=s,c.type=l,this._doNotHandleContextLost||(c._bufferView=e),this.updateRawTexture(c,e,o,a,s,l),this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0);var p=S(n,i,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,p.min),i&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(c),c},I.prototype.createDynamicTexture=function(e,t,i,r){var a=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_DYNAMIC);return a.baseWidth=e,a.baseHeight=t,i&&(e=this.needPOTTextures?R.Tools.GetExponentOfTwo(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?R.Tools.GetExponentOfTwo(t,this._caps.maxTextureSize):t),a.width=e,a.height=t,a.isReady=!1,a.generateMipMaps=i,a.samplingMode=r,this.updateTextureSamplingMode(r,a),this._internalTexturesCache.push(a),a},I.prototype.updateTextureSamplingMode=function(r,e){var t=S(r,e.generateMipMaps,this._gl);e.isCube?(this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,t.mag,e),this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,t.min),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):e.is3D?(this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,t.mag,e),this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,t.min),this._bindTextureDirectly(this._gl.TEXTURE_3D,null)):(this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,t.mag,e),this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,t.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e.samplingMode=r},I.prototype.updateDynamicTexture=function(a,e,t,i,r){if(void 0===i&&(i=!1),a){this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?1:0),i&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var n=r?this._getInternalFormat(r):this._gl.RGBA;this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,n,this._gl.UNSIGNED_BYTE,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),i&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),a.isReady=!0}},I.prototype.updateVideoTexture=function(o,e,t){if(o&&!o._isDisabled){this._bindTextureDirectly(this._gl.TEXTURE_2D,o,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?0:1);try{if(void 0===this._videoTextureSupported&&(this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),this._videoTextureSupported=!(0!==this._gl.getError())),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e);else{if(!o._workingCanvas){o._workingCanvas=document.createElement('canvas');var i=o._workingCanvas.getContext('2d');if(!i)throw new Error('Unable to get 2d context');o._workingContext=i,o._workingCanvas.width=o.width,o._workingCanvas.height=o.height}o._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,o.width,o.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,o._workingCanvas)}o.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),o.isReady=!0}catch(e){o._isDisabled=!0}}},I.prototype.updateTextureComparisonFunction=function(e,t){if(1===this.webGLVersion)return void R.Tools.Error('WebGL 1 does not support texture comparison.');var o=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_COMPARE_FUNC,I.LEQUAL),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_COMPARE_MODE,o.NONE)):(o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_COMPARE_FUNC,t),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_COMPARE_MODE,o.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_COMPARE_FUNC,I.LEQUAL),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_COMPARE_MODE,o.NONE)):(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_COMPARE_FUNC,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_COMPARE_MODE,o.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t},I.prototype._setupDepthStencilTexture=function(e,t,r,o,i){var a=t.width||t,n=t.height||t;e.baseWidth=a,e.baseHeight=n,e.width=a,e.height=n,e.isReady=!0,e.samples=1,e.generateMipMaps=!1,e._generateDepthBuffer=!0,e._generateStencilBuffer=r,e.samplingMode=o?R.Texture.BILINEAR_SAMPLINGMODE:R.Texture.NEAREST_SAMPLINGMODE,e.type=I.TEXTURETYPE_UNSIGNED_INT,e._comparisonFunction=i;var s=this._gl,l=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D,d=S(e.samplingMode,!1,s);s.texParameteri(l,s.TEXTURE_MAG_FILTER,d.mag),s.texParameteri(l,s.TEXTURE_MIN_FILTER,d.min),s.texParameteri(l,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(l,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),0===i?(s.texParameteri(l,s.TEXTURE_COMPARE_FUNC,I.LEQUAL),s.texParameteri(l,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(l,s.TEXTURE_COMPARE_FUNC,i),s.texParameteri(l,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE))},I.prototype.createDepthStencilTexture=function(r,e){if(e.isCube){var t=r.width||r;return this._createDepthStencilCubeTexture(t,e)}return this._createDepthStencilTexture(r,e)},I.prototype._createDepthStencilTexture=function(e,t){var i=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_DEPTHTEXTURE);if(!this._caps.depthTextureExtension)return R.Tools.Error('Depth texture is not supported by your browser or hardware.'),i;var r=b({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t),a=this._gl;return this._bindTextureDirectly(a.TEXTURE_2D,i,!0),this._setupDepthStencilTexture(i,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction),1<this.webGLVersion?r.generateStencil?a.texImage2D(a.TEXTURE_2D,0,a.DEPTH24_STENCIL8,i.width,i.height,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_COMPONENT24,i.width,i.height,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null):r.generateStencil?a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_STENCIL,i.width,i.height,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_COMPONENT,i.width,i.height,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null),this._bindTextureDirectly(a.TEXTURE_2D,null),i},I.prototype._createDepthStencilCubeTexture=function(e,t){var i=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_UNKNOWN);if(i.isCube=!0,1===this.webGLVersion)return R.Tools.Error('Depth cube texture is not supported by WebGL 1.'),i;var r=b({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t),n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction);for(var o=0;6>o;o++)r.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,n.DEPTH24_STENCIL8,e,e,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,n.DEPTH_COMPONENT24,e,e,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),i},I.prototype.setFrameBufferDepthStencilTexture=function(o){var e=o.getInternalTexture();if(e&&e._framebuffer&&o.depthStencilTexture){var t=this._gl,i=o.depthStencilTexture;this.bindUnboundFramebuffer(e._framebuffer),i.isCube?i._generateStencilBuffer?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_CUBE_MAP_POSITIVE_X,i._webGLTexture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_CUBE_MAP_POSITIVE_X,i._webGLTexture,0):i._generateStencilBuffer?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,i._webGLTexture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,i._webGLTexture,0),this.bindUnboundFramebuffer(null)}},I.prototype.createRenderTargetTexture=function(e,t){var r=new _;void 0!==t&&'object'==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&t.generateStencilBuffer,r.type=void 0===t.type?I.TEXTURETYPE_UNSIGNED_INT:t.type,r.samplingMode=void 0===t.samplingMode?R.Texture.TRILINEAR_SAMPLINGMODE:t.samplingMode,r.format=void 0===t.format?I.TEXTUREFORMAT_RGBA:t.format):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=I.TEXTURETYPE_UNSIGNED_INT,r.samplingMode=R.Texture.TRILINEAR_SAMPLINGMODE,r.format=I.TEXTUREFORMAT_RGBA),r.type!==I.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?r.type!==I.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(r.samplingMode=R.Texture.NEAREST_SAMPLINGMODE):r.samplingMode=R.Texture.NEAREST_SAMPLINGMODE;var o=this._gl,n=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(o.TEXTURE_2D,n,!0);var a=e.width||e,s=e.height||e,l=S(r.samplingMode,!!r.generateMipMaps,o);r.type!==I.TEXTURETYPE_FLOAT||this._caps.textureFloat||(r.type=I.TEXTURETYPE_UNSIGNED_INT,R.Tools.Warn('Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type')),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,l.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,l.min),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),a,s,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);var d=o.createFramebuffer();return this.bindUnboundFramebuffer(d),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,n._webGLTexture,0),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!r.generateStencilBuffer,r.generateDepthBuffer,a,s),r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),o.bindRenderbuffer(o.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),n._framebuffer=d,n.baseWidth=a,n.baseHeight=s,n.width=a,n.height=s,n.isReady=!0,n.samples=1,n.generateMipMaps=!!r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,n._generateDepthBuffer=r.generateDepthBuffer,n._generateStencilBuffer=!!r.generateStencilBuffer,this._internalTexturesCache.push(n),n},I.prototype.createMultipleRenderTarget=function(e,t){var r=!1,o=!0,i=!1,a=!1,n=1,s=I.TEXTURETYPE_UNSIGNED_INT,l=R.Texture.TRILINEAR_SAMPLINGMODE,c=[],u=[];void 0!==t&&(r=void 0!==t.generateMipMaps&&t.generateMipMaps,o=void 0===t.generateDepthBuffer||t.generateDepthBuffer,i=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,a=void 0!==t.generateDepthTexture&&t.generateDepthTexture,n=t.textureCount||1,t.types&&(c=t.types),t.samplingModes&&(u=t.samplingModes));var d=this._gl,p=d.createFramebuffer();this.bindUnboundFramebuffer(p);for(var f=e.width||e,_=e.height||e,m=[],g=[],h=this._setupFramebufferDepthAttachments(i,o,f,_),y=0;y<n;y++){var x=u[y]||l,T=c[y]||s;T!==I.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?T!==I.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(x=R.Texture.NEAREST_SAMPLINGMODE):x=R.Texture.NEAREST_SAMPLINGMODE;var b=S(x,r,d);T!==I.TEXTURETYPE_FLOAT||this._caps.textureFloat||(T=I.TEXTURETYPE_UNSIGNED_INT,R.Tools.Warn('Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type'));var E=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_MULTIRENDERTARGET),v=d[1<this.webGLVersion?'COLOR_ATTACHMENT'+y:'COLOR_ATTACHMENT'+y+'_WEBGL'];m.push(E),g.push(v),d.activeTexture(d['TEXTURE'+y]),d.bindTexture(d.TEXTURE_2D,E._webGLTexture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,b.mag),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,b.min),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(T),f,_,0,d.RGBA,this._getWebGLTextureType(T),null),d.framebufferTexture2D(d.DRAW_FRAMEBUFFER,v,d.TEXTURE_2D,E._webGLTexture,0),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(d.TEXTURE_2D,null),E._framebuffer=p,E._depthStencilBuffer=h,E.baseWidth=f,E.baseHeight=_,E.width=f,E.height=_,E.isReady=!0,E.samples=1,E.generateMipMaps=r,E.samplingMode=x,E.type=T,E._generateDepthBuffer=o,E._generateStencilBuffer=i,E._attachments=g,this._internalTexturesCache.push(E)}if(a&&this._caps.depthTextureExtension){var P=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_MULTIRENDERTARGET);d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,P._webGLTexture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,2>this.webGLVersion?d.DEPTH_COMPONENT:d.DEPTH_COMPONENT16,f,_,0,d.DEPTH_COMPONENT,d.UNSIGNED_SHORT,null),d.framebufferTexture2D(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.TEXTURE_2D,P._webGLTexture,0),P._framebuffer=p,P.baseWidth=f,P.baseHeight=_,P.width=f,P.height=_,P.isReady=!0,P.samples=1,P.generateMipMaps=r,P.samplingMode=d.NEAREST,P._generateDepthBuffer=o,P._generateStencilBuffer=i,m.push(P),this._internalTexturesCache.push(P)}return d.drawBuffers(g),d.bindRenderbuffer(d.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),this.resetTextureCache(),m},I.prototype._setupFramebufferDepthAttachments=function(a,e,t,i,r){void 0===r&&(r=1);var n=null,o=this._gl;return a?(n=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,n),1<r?o.renderbufferStorageMultisample(o.RENDERBUFFER,r,o.DEPTH24_STENCIL8,t,i):o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_STENCIL,t,i),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_STENCIL_ATTACHMENT,o.RENDERBUFFER,n)):e&&(n=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,n),1<r?o.renderbufferStorageMultisample(o.RENDERBUFFER,r,o.DEPTH_COMPONENT16,t,i):o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,t,i),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,n)),n},I.prototype.updateRenderTargetTextureSampleCount=function(o,a){if(2>this.webGLVersion||!o)return 1;if(o.samples===a)return a;var t=this._gl;if(a=C(a,t.getParameter(t.MAX_SAMPLES)),o._depthStencilBuffer&&(t.deleteRenderbuffer(o._depthStencilBuffer),o._depthStencilBuffer=null),o._MSAAFramebuffer&&(t.deleteFramebuffer(o._MSAAFramebuffer),o._MSAAFramebuffer=null),o._MSAARenderBuffer&&(t.deleteRenderbuffer(o._MSAARenderBuffer),o._MSAARenderBuffer=null),1<a){var i=t.createFramebuffer();if(!i)throw new Error('Unable to create multi sampled framebuffer');o._MSAAFramebuffer=i,this.bindUnboundFramebuffer(o._MSAAFramebuffer);var s=t.createRenderbuffer();if(!s)throw new Error('Unable to create multi sampled framebuffer');t.bindRenderbuffer(t.RENDERBUFFER,s),t.renderbufferStorageMultisample(t.RENDERBUFFER,a,this._getRGBAMultiSampleBufferFormat(o.type),o.width,o.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,s),o._MSAARenderBuffer=s}else this.bindUnboundFramebuffer(o._framebuffer);return o.samples=a,o._depthStencilBuffer=this._setupFramebufferDepthAttachments(o._generateStencilBuffer,o._generateDepthBuffer,o.width,o.height,a),t.bindRenderbuffer(t.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),a},I.prototype.updateMultipleRenderTargetTextureSampleCount=function(d,c){if(2>this.webGLVersion||!d||0==d.length)return 1;if(d[0].samples===c)return c;var t=this._gl;c=C(c,t.getParameter(t.MAX_SAMPLES)),d[0]._depthStencilBuffer&&(t.deleteRenderbuffer(d[0]._depthStencilBuffer),d[0]._depthStencilBuffer=null),d[0]._MSAAFramebuffer&&(t.deleteFramebuffer(d[0]._MSAAFramebuffer),d[0]._MSAAFramebuffer=null);for(var i=0;i<d.length;i++)d[i]._MSAARenderBuffer&&(t.deleteRenderbuffer(d[i]._MSAARenderBuffer),d[i]._MSAARenderBuffer=null);if(1<c){var r=t.createFramebuffer();if(!r)throw new Error('Unable to create multi sampled framebuffer');this.bindUnboundFramebuffer(r);for(var p=this._setupFramebufferDepthAttachments(d[0]._generateStencilBuffer,d[0]._generateDepthBuffer,d[0].width,d[0].height,c),o=[],i=0;i<d.length;i++){var s=d[i],a=t[1<this.webGLVersion?'COLOR_ATTACHMENT'+i:'COLOR_ATTACHMENT'+i+'_WEBGL'],l=t.createRenderbuffer();if(!l)throw new Error('Unable to create multi sampled framebuffer');t.bindRenderbuffer(t.RENDERBUFFER,l),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,this._getRGBAMultiSampleBufferFormat(s.type),s.width,s.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,l),s._MSAAFramebuffer=r,s._MSAARenderBuffer=l,s.samples=c,s._depthStencilBuffer=p,t.bindRenderbuffer(t.RENDERBUFFER,null),o.push(a)}t.drawBuffers(o)}else this.bindUnboundFramebuffer(d[0]._framebuffer);return this.bindUnboundFramebuffer(null),c},I.prototype._uploadDataToTexture=function(l,e,t,i,r,n,o,s){this._gl.texImage2D(l,e,t,i,r,0,n,o,s)},I.prototype._uploadCompressedDataToTexture=function(a,e,t,i,r,n){this._gl.compressedTexImage2D(a,e,t,i,r,0,n)},I.prototype.createRenderTargetCubeTexture=function(e,t){var r=b({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:I.TEXTURETYPE_UNSIGNED_INT,samplingMode:R.Texture.TRILINEAR_SAMPLINGMODE,format:I.TEXTUREFORMAT_RGBA},t);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,r.type!==I.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?r.type!==I.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(r.samplingMode=R.Texture.NEAREST_SAMPLINGMODE):r.samplingMode=R.Texture.NEAREST_SAMPLINGMODE;var o=this._gl,i=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,i,!0);var a=S(r.samplingMode,r.generateMipMaps,o);r.type!==I.TEXTURETYPE_FLOAT||this._caps.textureFloat||(r.type=I.TEXTURETYPE_UNSIGNED_INT,R.Tools.Warn('Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type')),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,a.mag),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,a.min),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);for(var n=0;6>n;n++)o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),e,e,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);var s=o.createFramebuffer();return this.bindUnboundFramebuffer(s),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,e,e),r.generateMipMaps&&o.generateMipmap(o.TEXTURE_CUBE_MAP),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null),o.bindRenderbuffer(o.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),i._framebuffer=s,i.width=e,i.height=e,i.isReady=!0,i.isCube=!0,i.samples=1,i.generateMipMaps=r.generateMipMaps,i.samplingMode=r.samplingMode,i.type=r.type,i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=r.generateStencilBuffer,this._internalTexturesCache.push(i),i},I.prototype.createPrefilteredCubeTexture=function(e,d,i,r,n,t,o,a){var m=this;void 0===n&&(n=null),void 0===t&&(t=null),void 0===a&&(a=null);var s=function(e){if(!e)return void(n&&n(null));var o=e.texture;if(e.info.sphericalPolynomial&&(o._sphericalPolynomial=e.info.sphericalPolynomial),o._dataSource=R.InternalTexture.DATASOURCE_CUBEPREFILTERED,o._lodGenerationScale=i,o._lodGenerationOffset=r,m._caps.textureLOD)return void(n&&n(o));var s=m._gl,a=e.width;if(a){for(var l=[],c=0;3>c;c++){var u=c/2,f=r,p=R.Scalar.Log2(a)*i+r,_=O(C(W(f+(p-f)*(1-u),0),p)),g=new R.InternalTexture(m,R.InternalTexture.DATASOURCE_TEMP);if(g.isCube=!0,m._bindTextureDirectly(s.TEXTURE_CUBE_MAP,g,!0),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.isDDS){var h=e.info,y=e.data;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,h.isCompressed?1:0),R.DDSTools.UploadDDSLevels(m,m._gl,y,h,!0,6,_)}else R.Tools.Warn('DDS is the only prefiltered cube map supported so far.');m._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null);var T=new R.BaseTexture(d);T.isCube=!0,T._texture=g,g.isReady=!0,l.push(T)}o._lodTextureHigh=l[2],o._lodTextureMid=l[1],o._lodTextureLow=l[0],n&&n(o)}};return this.createCubeTexture(e,d,null,!1,s,t,o,a,!0)},I.prototype.createCubeTexture=function(e,o,i,y,T,s,x,a,l){var c=this;void 0===T&&(T=null),void 0===s&&(s=null),void 0===a&&(a=null),void 0===l&&(l=!1);var u=this._gl,f=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_CUBE);f.isCube=!0,f.url=e,f.generateMipMaps=!y,this._doNotHandleContextLost||(f._extension=a,f._files=i);var h=!1,p=!1,_=e.lastIndexOf('.'),m=a||(-1<_?e.substring(_).toLowerCase():'');this._textureFormatInUse?(m=this._textureFormatInUse,e=(-1<_?e.substring(0,_):e)+this._textureFormatInUse,h=!0):p='.dds'===m;var g=function(r,e){s&&r&&s(r.status+' '+r.statusText,e)};if(h)this._loadFile(e,function(e){var t=new R.KhronosTextureContainer(e,6),o=1<t.numberOfMipmapLevels&&!y;c._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f,!0),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,1),t.uploadLevels(c._gl,!y),c.setCubeMapTextureParams(u,o),f.width=t.pixelWidth,f.height=t.pixelHeight,f.isReady=!0},void 0,void 0,!0,g);else if(p)i&&6===i.length?this._cascadeLoadFiles(o,function(e){for(var s=!1,r=0,p=0,a,_;p<e.length;p++)_=e[p],a=R.DDSTools.GetDDSInfo(_),s=(a.isRGB||a.isLuminance||1<a.mipmapCount)&&!y,c._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f,!0),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,a.isCompressed?1:0),R.DDSTools.UploadDDSLevels(c,c._gl,_,a,s,6,-1,p),y||a.isFourCC||1!==a.mipmapCount||u.generateMipmap(u.TEXTURE_CUBE_MAP),f.width=a.width,f.height=a.height,f.type=a.textureType,r=a.width;c.setCubeMapTextureParams(u,s),f.isReady=!0,T&&T({isDDS:!0,width:r,info:a,imgs:e,texture:f})},i,s):this._loadFile(e,function(e){var o=R.DDSTools.GetDDSInfo(e);l&&(o.sphericalPolynomial=new R.SphericalPolynomial);var a=(o.isRGB||o.isLuminance||1<o.mipmapCount)&&!y;c._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f,!0),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,o.isCompressed?1:0),R.DDSTools.UploadDDSLevels(c,c._gl,e,o,a,6),y||o.isFourCC||1!==o.mipmapCount||u.generateMipmap(u.TEXTURE_CUBE_MAP),c.setCubeMapTextureParams(u,a),f.width=o.width,f.height=o.height,f.isReady=!0,f.type=o.textureType,T&&T({isDDS:!0,width:o.width,info:o,data:e,texture:f})},void 0,void 0,!0,g);else{if(!i)throw new Error('Cannot load cubemap because files were not defined');t(0,o,function(e){var t=c.needPOTTextures?R.Tools.GetExponentOfTwo(e[0].width,c._caps.maxCubemapTextureSize):e[0].width,i=t;if(c._prepareWorkingCanvas(),c._workingCanvas&&c._workingContext){c._workingCanvas.width=t,c._workingCanvas.height=i;var r=[u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Z];c._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f,!0),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0);for(var o=x?c._getInternalFormat(x):c._gl.RGBA,a=0;a<r.length;a++)c._workingContext.drawImage(e[a],0,0,e[a].width,e[a].height,0,0,t,i),u.texImage2D(r[a],0,o,o,u.UNSIGNED_BYTE,c._workingCanvas);y||u.generateMipmap(u.TEXTURE_CUBE_MAP),c.setCubeMapTextureParams(u,!y),f.width=t,f.height=i,f.isReady=!0,x&&(f.format=x),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),T&&T()}},i,s)}return this._internalTexturesCache.push(f),f},I.prototype.setCubeMapTextureParams=function(r,e){r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,e?r.LINEAR_MIPMAP_LINEAR:r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)},I.prototype.updateRawCubeTexture=function(e,t,i,r,n,o,s){void 0===o&&(o=null),void 0===s&&(s=0),e._bufferViewArray=t,e.format=i,e.type=r,e.invertY=n,e._compression=o;var a=this._gl,l=this._getWebGLTextureType(r),_=this._getInternalFormat(i),c=this._getRGBABufferInternalSizedFormat(r),u=!1;_===a.RGB&&(_=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,e,!0),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,void 0===n?1:n?1:0),0!=e.width%4&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(var f=0,d;6>f;f++)d=t[f],o?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,s,this.getCaps().s3tc[o],e.width,e.height,0,d):(u&&(d=this._convertRGBtoRGBATextureData(d,e.width,e.height,r)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,s,c,e.width,e.height,0,_,l,d));(!this.needPOTTextures||R.Tools.IsExponentOfTwo(e.width)&&R.Tools.IsExponentOfTwo(e.height))&&e.generateMipMaps&&0===s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},I.prototype.createRawCubeTexture=function(e,t,r,i,o,n,a,s){void 0===s&&(s=null);var l=this._gl,c=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_CUBERAW);c.isCube=!0,c.generateMipMaps=o,c.format=r,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=e);var u=this._getWebGLTextureType(i),f=this._getInternalFormat(r);f===l.RGB&&(f=l.RGBA);var d=t;if(!(c.width=d,c.height=d,!this.needPOTTextures||R.Tools.IsExponentOfTwo(c.width)&&R.Tools.IsExponentOfTwo(c.height)||(o=!1),e&&this.updateRawCubeTexture(c,e,r,i,n,s),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),e&&o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),u!==l.FLOAT||this._caps.textureFloatLinearFiltering))l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.NEAREST);else if(u!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering){var p=S(a,o,l);l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,p.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,p.min)}else l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.NEAREST);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c},I.prototype.createRawCubeTextureFromUrl=function(e,E,t,i,n,o,P,a,l,r,c,h){var f=this;void 0===l&&(l=null),void 0===r&&(r=null),void 0===c&&(c=R.Texture.TRILINEAR_SAMPLINGMODE),void 0===h&&(h=!1);var d=this._gl,p=this.createRawCubeTexture(null,t,i,n,!o,h,c);E._addPendingData(p),p.url=e,this._internalTexturesCache.push(p);var u=function(o,e){E._removePendingData(p),r&&o&&r(o.status+' '+o.statusText,e)},_=function(_){var e=p.width,t=P(_);if(t){if(a){var r=f._getWebGLTextureType(n),c=f._getInternalFormat(i),u=f._getRGBABufferInternalSizedFormat(n),m=!1;c===d.RGB&&(c=d.RGBA,m=!0),f._bindTextureDirectly(d.TEXTURE_CUBE_MAP,p,!0),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,0);for(var g=a(t),v=0;v<g.length;v++)for(var y=e>>v,b=0,x;6>b;b++)x=g[v][b],m&&(x=f._convertRGBtoRGBATextureData(x,y,y,n)),d.texImage2D(b,v,u,y,y,0,c,r,x);f._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else p.generateMipMaps=!o,f.updateRawCubeTexture(p,t,i,n,h);p.isReady=!0,E._removePendingData(p),l&&l()}};return this._loadFile(e,function(t){_(t)},void 0,E.database,!0,u),p},I.prototype.updateRawTexture3D=function(a,e,t,i,r){void 0===r&&(r=null);var n=this._getInternalFormat(t);this._bindTextureDirectly(this._gl.TEXTURE_3D,a,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===i?1:i?1:0),this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.invertY=i,a._compression=r),0!=a.width%4&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage3D(this._gl.TEXTURE_3D,0,this.getCaps().s3tc[r],a.width,a.height,a.depth,0,e):this._gl.texImage3D(this._gl.TEXTURE_3D,0,n,a.width,a.height,a.depth,0,n,this._gl.UNSIGNED_BYTE,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_3D),this._bindTextureDirectly(this._gl.TEXTURE_3D,null),a.isReady=!0},I.prototype.createRawTexture3D=function(e,t,r,i,o,n,a,s,l){void 0===l&&(l=null);var d=new R.InternalTexture(this,R.InternalTexture.DATASOURCE_RAW3D);d.baseWidth=t,d.baseHeight=r,d.baseDepth=i,d.width=t,d.height=r,d.depth=i,d.format=o,d.generateMipMaps=n,d.samplingMode=s,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=e),this.updateRawTexture3D(d,e,o,a,l),this._bindTextureDirectly(this._gl.TEXTURE_3D,d,!0);var c=S(s,n,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,c.mag),this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,c.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_3D),this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._internalTexturesCache.push(d),d},I.prototype._prepareWebGLTextureContinuation=function(r,e,t,l,n){var o=this._gl;if(o){var s=S(n,!t,o);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,s.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,s.min),t||l||o.generateMipmap(o.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),e&&e._removePendingData(r),r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear()}},I.prototype._prepareWebGLTexture=function(e,t,i,r,n,o,s,a,l){var p=this;void 0===l&&(l=R.Texture.TRILINEAR_SAMPLINGMODE);var c=this.needPOTTextures?R.Tools.GetExponentOfTwo(i,this.getCaps().maxTextureSize):i,u=this.needPOTTextures?R.Tools.GetExponentOfTwo(r,this.getCaps().maxTextureSize):r,f=this._gl;if(f){if(!e._webGLTexture)return void(t&&t._removePendingData(e));this._bindTextureDirectly(f.TEXTURE_2D,e,!0),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,void 0===n?1:n?1:0),e.baseWidth=i,e.baseHeight=r,e.width=c,e.height=u,e.isReady=!0,a(c,u,function(){p._prepareWebGLTextureContinuation(e,t,o,s,l)})||this._prepareWebGLTextureContinuation(e,t,o,s,l)}},I.prototype._convertRGBtoRGBATextureData=function(n,e,t,i){var r=i===I.TEXTURETYPE_FLOAT?new Float32Array(4*(e*t)):new Uint32Array(4*(e*t));for(var o=0;o<e;o++)for(var s=0;s<t;s++){var a=3*(s*e+o),l=4*(s*e+o);r[l+0]=n[a+0],r[l+1]=n[a+1],r[l+2]=n[a+2],r[l+3]=1}return r},I.prototype._releaseFramebufferObjects=function(r){var e=this._gl;r._framebuffer&&(e.deleteFramebuffer(r._framebuffer),r._framebuffer=null),r._depthStencilBuffer&&(e.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(e.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null),r._MSAARenderBuffer&&(e.deleteRenderbuffer(r._MSAARenderBuffer),r._MSAARenderBuffer=null)},I.prototype._releaseTexture=function(r){var e=this._gl;this._releaseFramebufferObjects(r),e.deleteTexture(r._webGLTexture),this.unbindAllTextures();var t=this._internalTexturesCache.indexOf(r);-1!==t&&this._internalTexturesCache.splice(t,1),r._lodTextureHigh&&r._lodTextureHigh.dispose(),r._lodTextureMid&&r._lodTextureMid.dispose(),r._lodTextureLow&&r._lodTextureLow.dispose(),this.scenes.forEach(function(e){e.postProcesses.forEach(function(e){e._outputTexture==r&&(e._outputTexture=null)}),e.cameras.forEach(function(e){e._postProcesses.forEach(function(e){e&&e._outputTexture==r&&(e._outputTexture=null)})})})},I.prototype.setProgram=function(t){this._currentProgram!==t&&(this._gl.useProgram(t),this._currentProgram=t)},I.prototype.bindSamplers=function(o){this.setProgram(o.getProgram());for(var e=o.getSamplers(),t=0,i;t<e.length;t++)i=o.getUniform(e[t]),i&&(this._boundUniforms[t]=i);this._currentEffect=null},I.prototype._moveBoundTextureOnTop=function(t){this.disableTextureBindingOptimization||this._lastBoundInternalTextureTracker.previous===t||(this._linkTrackers(t.previous,t.next),this._linkTrackers(this._lastBoundInternalTextureTracker.previous,t),this._linkTrackers(t,this._lastBoundInternalTextureTracker))},I.prototype._getCorrectTextureChannel=function(r,e){if(!e)return-1;if(e._initialSlot=r,this.disableTextureBindingOptimization)r!==e._designatedSlot&&this._textureCollisions.addCount(1,!1);else if(r!==e._designatedSlot)return-1<e._designatedSlot?e._designatedSlot:this._nextFreeTextureSlots.length?this._nextFreeTextureSlots[0]:(this._textureCollisions.addCount(1,!1),this._removeDesignatedSlot(this._firstBoundInternalTextureTracker.next));return r},I.prototype._linkTrackers=function(r,e){r.next=e,e.previous=r},I.prototype._removeDesignatedSlot=function(r){var e=r._designatedSlot;return-1===e?-1:(r._designatedSlot=-1,this.disableTextureBindingOptimization?-1:(this._linkTrackers(r.previous,r.next),this._boundTexturesCache[e]=null,this._nextFreeTextureSlots.push(e),e))},I.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},I.prototype._bindTextureDirectly=function(a,e,t,l){void 0===t&&(t=!1),void 0===l&&(l=!1),t&&e&&-1<e._designatedSlot&&(this._activeChannel=e._designatedSlot);var r=this._boundTexturesCache[this._activeChannel],n=e&&-1<e._initialSlot;if(!(r!==e||l))t&&this._activateCurrentTexture();else if(r&&this._removeDesignatedSlot(r),this._activateCurrentTexture(),this._gl.bindTexture(a,e?e._webGLTexture:null),this._boundTexturesCache[this._activeChannel]=e,e){if(!this.disableTextureBindingOptimization){var o=this._nextFreeTextureSlots.indexOf(this._activeChannel);-1<o&&this._nextFreeTextureSlots.splice(o,1),this._linkTrackers(this._lastBoundInternalTextureTracker.previous,e),this._linkTrackers(e,this._lastBoundInternalTextureTracker)}e._designatedSlot=this._activeChannel}n&&!t&&this._bindSamplerUniformToChannel(e._initialSlot,this._activeChannel)},I.prototype._bindTexture=function(r,e){0>r||(e&&(r=this._getCorrectTextureChannel(r,e)),this._activeChannel=r,this._bindTextureDirectly(this._gl.TEXTURE_2D,e))},I.prototype.setTextureFromPostProcess=function(r,e){this._bindTexture(r,e?e._textures.data[e._currentRenderTextureInd]:null)},I.prototype.setTextureFromPostProcessOutput=function(r,e){this._bindTexture(r,e?e._outputTexture:null)},I.prototype.unbindAllTextures=function(){for(var t=0;t<this._maxSimultaneousTextures;t++)this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&this._bindTextureDirectly(this._gl.TEXTURE_3D,null)},I.prototype.setTexture=function(r,e,t){0>r||(e&&(this._boundUniforms[r]=e),this._setTexture(r,t))},I.prototype.setDepthStencilTexture=function(r,e,t){0>r||(e&&(this._boundUniforms[r]=e),t&&t.depthStencilTexture?this._setTexture(r,t,!1,!0):this._setTexture(r,null))},I.prototype._bindSamplerUniformToChannel=function(r,e){var t=this._boundUniforms[r];t._currentState!==e&&(this._gl.uniform1i(t,e),t._currentState=e)},I.prototype._getTextureWrapMode=function(e){return e===R.Texture.WRAP_ADDRESSMODE?this._gl.REPEAT:e===R.Texture.CLAMP_ADDRESSMODE?this._gl.CLAMP_TO_EDGE:e===R.Texture.MIRROR_ADDRESSMODE?this._gl.MIRRORED_REPEAT:this._gl.REPEAT},I.prototype._setTexture=function(e,t,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=!1),!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&this._bindTextureDirectly(this._gl.TEXTURE_3D,null)),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===I.DELAYLOADSTATE_NOTLOADED)return t.delayLoad(),!1;var o;o=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:this.emptyTexture,n||(e=this._getCorrectTextureChannel(e,o));var s=!0;if(this._boundTexturesCache[e]===o&&(this._moveBoundTextureOnTop(o),n||this._bindSamplerUniformToChannel(o._initialSlot,e),s=!1),this._activeChannel=e,o&&o.is3D)s&&this._bindTextureDirectly(this._gl.TEXTURE_3D,o,n),o&&o._cachedWrapU!==t.wrapU&&(o._cachedWrapU=t.wrapU,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),o)),o&&o._cachedWrapV!==t.wrapV&&(o._cachedWrapV=t.wrapV,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),o)),o&&o._cachedWrapR!==t.wrapR&&(o._cachedWrapR=t.wrapR,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),o)),this._setAnisotropicLevel(this._gl.TEXTURE_3D,t);else if(o&&o.isCube){if(s&&this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,o,n),o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;var a=t.coordinatesMode!==R.Texture.CUBIC_MODE&&t.coordinatesMode!==R.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,a,o),this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,a)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,t)}else s&&this._bindTextureDirectly(this._gl.TEXTURE_2D,o,n),o&&o._cachedWrapU!==t.wrapU&&(o._cachedWrapU=t.wrapU,this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),o)),o&&o._cachedWrapV!==t.wrapV&&(o._cachedWrapV=t.wrapV,this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),o)),this._setAnisotropicLevel(this._gl.TEXTURE_2D,t);return!0},I.prototype.setTextureArray=function(o,e,t){if(!(0>o)&&e){this._textureUnits&&this._textureUnits.length===t.length||(this._textureUnits=new Int32Array(t.length));for(var i=0;i<t.length;i++)this._textureUnits[i]=this._getCorrectTextureChannel(o+i,t[i].getInternalTexture());this._gl.uniform1iv(e,this._textureUnits);for(var r=0;r<t.length;r++)this._setTexture(this._textureUnits[r],t[r],!0)}},I.prototype._setAnisotropicLevel=function(e,t){var i=t.getInternalTexture();if(i){var r=this._caps.textureAnisotropicFilterExtension,a=t.anisotropicFilteringLevel;i.samplingMode!==R.Texture.LINEAR_LINEAR_MIPNEAREST&&i.samplingMode!==R.Texture.LINEAR_LINEAR_MIPLINEAR&&i.samplingMode!==R.Texture.LINEAR_LINEAR&&(a=1),r&&i._cachedAnisotropicFilteringLevel!==a&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,C(a,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=a)}},I.prototype._setTextureParameterFloat=function(o,e,t,i){this._bindTextureDirectly(o,i,!0,!0),this._gl.texParameterf(o,e,t)},I.prototype._setTextureParameterInteger=function(o,e,t,i){i&&this._bindTextureDirectly(o,i,!0,!0),this._gl.texParameteri(o,e,t)},I.prototype.readPixels=function(o,e,t,i){var r=new Uint8Array(4*(i*t));return this._gl.readPixels(o,e,t,i,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r),r},I.prototype.addExternalData=function(e,t){return this._externalData||(this._externalData=new R.StringDictionary),this._externalData.add(e,t)},I.prototype.getExternalData=function(e){return this._externalData||(this._externalData=new R.StringDictionary),this._externalData.get(e)},I.prototype.getOrAddExternalDataWithFactory=function(e,t){return this._externalData||(this._externalData=new R.StringDictionary),this._externalData.getOrAddWithFactory(e,t)},I.prototype.removeExternalData=function(e){return this._externalData||(this._externalData=new R.StringDictionary),this._externalData.remove(e)},I.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var r=0;r<this._caps.maxVertexAttribs;r++)this._gl.disableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!1,this._currentBufferPointers[r].active=!1}else for(var r=0,e=this._vertexAttribArraysEnabled.length;r<e;r++)r>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[r]||(this._gl.disableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!1,this._currentBufferPointers[r].active=!1)},I.prototype.releaseEffects=function(){for(var t in this._compiledEffects)this._deleteProgram(this._compiledEffects[t]._program);this._compiledEffects={}},I.prototype.dispose=function(){for(this.hideLoadingUI(),this.stopRenderLoop();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();I.audioEngine&&I.audioEngine.dispose(),this.releaseEffects(),this.unbindAllAttributes(),this._boundUniforms=[],this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.disableVR(),R.Tools.IsWindowObjectExist()&&(window.removeEventListener('blur',this._onBlur),window.removeEventListener('focus',this._onFocus),window.removeEventListener('vrdisplaypointerrestricted',this._onVRDisplayPointerRestricted),window.removeEventListener('vrdisplaypointerunrestricted',this._onVRDisplayPointerUnrestricted),this._renderingCanvas&&(this._renderingCanvas.removeEventListener('focus',this._onCanvasFocus),this._renderingCanvas.removeEventListener('blur',this._onCanvasBlur),this._renderingCanvas.removeEventListener('pointerout',this._onCanvasPointerOut),this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener('webglcontextlost',this._onContextLost),this._renderingCanvas.removeEventListener('webglcontextrestored',this._onContextRestored))),document.removeEventListener('fullscreenchange',this._onFullscreenChange),document.removeEventListener('mozfullscreenchange',this._onFullscreenChange),document.removeEventListener('webkitfullscreenchange',this._onFullscreenChange),document.removeEventListener('msfullscreenchange',this._onFullscreenChange),document.removeEventListener('pointerlockchange',this._onPointerLockChange),document.removeEventListener('mspointerlockchange',this._onPointerLockChange),document.removeEventListener('mozpointerlockchange',this._onPointerLockChange),document.removeEventListener('webkitpointerlockchange',this._onPointerLockChange),this._onVrDisplayConnect&&(window.removeEventListener('vrdisplayconnect',this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener('vrdisplaydisconnect',this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener('vrdisplaypresentchange',this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null));var e=I.Instances.indexOf(this);0<=e&&I.Instances.splice(e,1),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._bindedRenderFunction=null,this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear(),R.Effect.ResetCache();for(var t=0,o=this._activeRequests;t<o.length;t++)o[t].abort()},I.prototype.displayLoadingUI=function(){if(R.Tools.IsWindowObjectExist()){var e=this.loadingScreen;e&&e.displayLoadingUI()}},I.prototype.hideLoadingUI=function(){if(R.Tools.IsWindowObjectExist()){var e=this.loadingScreen;e&&e.hideLoadingUI()}},Object.defineProperty(I.prototype,'loadingScreen',{get:function(){return!this._loadingScreen&&R.DefaultLoadingScreen&&this._renderingCanvas&&(this._loadingScreen=new R.DefaultLoadingScreen(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'loadingUIText',{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,'loadingUIBackgroundColor',{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!0,configurable:!0}),I.prototype.attachContextLostEvent=function(t){this._renderingCanvas&&this._renderingCanvas.addEventListener('webglcontextlost',t,!1)},I.prototype.attachContextRestoredEvent=function(t){this._renderingCanvas&&this._renderingCanvas.addEventListener('webglcontextrestored',t,!1)},I.prototype.getVertexShaderSource=function(r){var e=this._gl.getAttachedShaders(r);return e?this._gl.getShaderSource(e[0]):null},I.prototype.getFragmentShaderSource=function(r){var e=this._gl.getAttachedShaders(r);return e?this._gl.getShaderSource(e[1]):null},I.prototype.getError=function(){return this._gl.getError()},I.prototype.getFps=function(){return this._fps},I.prototype.getDeltaTime=function(){return this._deltaTime},I.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},I.prototype._readTexturePixels=function(l,e,t,i){void 0===i&&(i=-1);var r=this._gl;if(!this._dummyFramebuffer){var n=r.createFramebuffer();if(!n)throw new Error('Unable to create dummy framebuffer');this._dummyFramebuffer=n}r.bindFramebuffer(r.FRAMEBUFFER,this._dummyFramebuffer),-1<i?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+i,l._webGLTexture,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,l._webGLTexture,0);var d=void 0===l.type?r.UNSIGNED_BYTE:this._getWebGLTextureType(l.type),a;return d===r.UNSIGNED_BYTE?(a=new Uint8Array(4*e*t),d=r.UNSIGNED_BYTE):(a=new Float32Array(4*e*t),d=r.FLOAT),r.readPixels(0,0,e,t,r.RGBA,d,a),r.bindFramebuffer(r.FRAMEBUFFER,this._currentFramebuffer),a},I.prototype._canRenderToFloatFramebuffer=function(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(I.TEXTURETYPE_FLOAT)},I.prototype._canRenderToHalfFloatFramebuffer=function(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(I.TEXTURETYPE_HALF_FLOAT)},I.prototype._canRenderToFramebuffer=function(d){for(var e=this._gl;e.getError()!==e.NO_ERROR;);var t=!0,c=e.createTexture();e.bindTexture(e.TEXTURE_2D,c),e.texImage2D(e.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(d),1,1,0,e.RGBA,this._getWebGLTextureType(d),null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,c,0);var n=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t=t&&n===e.FRAMEBUFFER_COMPLETE,t=t&&e.getError()===e.NO_ERROR,t&&(e.clear(e.COLOR_BUFFER_BIT),t=t&&e.getError()===e.NO_ERROR),t){e.bindFramebuffer(e.FRAMEBUFFER,null);var o=e.RGBA,s=e.UNSIGNED_BYTE,a=new Uint8Array(4);e.readPixels(0,0,1,1,o,s,a),t=t&&e.getError()===e.NO_ERROR}for(e.deleteTexture(c),e.deleteFramebuffer(r),e.bindFramebuffer(e.FRAMEBUFFER,null);!t&&e.getError()!==e.NO_ERROR;);return t},I.prototype._getWebGLTextureType=function(t){return t===I.TEXTURETYPE_FLOAT?this._gl.FLOAT:t===I.TEXTURETYPE_HALF_FLOAT?this._gl.HALF_FLOAT_OES:this._gl.UNSIGNED_BYTE},I.prototype._getInternalFormat=function(r){var e=this._gl.RGBA;return r===I.TEXTUREFORMAT_ALPHA?e=this._gl.ALPHA:r===I.TEXTUREFORMAT_LUMINANCE?e=this._gl.LUMINANCE:r===I.TEXTUREFORMAT_LUMINANCE_ALPHA?e=this._gl.LUMINANCE_ALPHA:r===I.TEXTUREFORMAT_RGB||r===I.TEXTUREFORMAT_RGB32F?e=this._gl.RGB:r===I.TEXTUREFORMAT_RGBA||r===I.TEXTUREFORMAT_RGBA32F?e=this._gl.RGBA:r===I.TEXTUREFORMAT_R32F?e=this._gl.RED:r===I.TEXTUREFORMAT_RG32F?e=this._gl.RG:void 0,e},I.prototype._getRGBABufferInternalSizedFormat=function(r,e){if(1===this._webGLVersion){if(e)switch(e){case I.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;}return this._gl.RGBA}if(r===I.TEXTURETYPE_FLOAT){if(e)switch(e){case I.TEXTUREFORMAT_R32F:return this._gl.R32F;case I.TEXTUREFORMAT_RG32F:return this._gl.RG32F;case I.TEXTUREFORMAT_RGB32F:return this._gl.RGB32F;}return this._gl.RGBA32F}if(r===I.TEXTURETYPE_HALF_FLOAT)return this._gl.RGBA16F;if(e)switch(e){case I.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;case I.TEXTUREFORMAT_RGB:return this._gl.RGB;}return this._gl.RGBA},I.prototype._getRGBAMultiSampleBufferFormat=function(t){return t===I.TEXTURETYPE_FLOAT?this._gl.RGBA32F:t===I.TEXTURETYPE_HALF_FLOAT?this._gl.RGBA16F:this._gl.RGBA8},I.prototype.createQuery=function(){return this._gl.createQuery()},I.prototype.deleteQuery=function(t){return this._gl.deleteQuery(t),this},I.prototype.isQueryResultAvailable=function(t){return this._gl.getQueryParameter(t,this._gl.QUERY_RESULT_AVAILABLE)},I.prototype.getQueryResult=function(t){return this._gl.getQueryParameter(t,this._gl.QUERY_RESULT)},I.prototype.beginOcclusionQuery=function(r,e){var t=this.getGlAlgorithmType(r);return this._gl.beginQuery(t,e),this},I.prototype.endOcclusionQuery=function(r){var e=this.getGlAlgorithmType(r);return this._gl.endQuery(e),this},I.prototype._createTimeQuery=function(){var t=this._caps.timerQuery;return t.createQueryEXT?t.createQueryEXT():this.createQuery()},I.prototype._deleteTimeQuery=function(r){var e=this._caps.timerQuery;return e.deleteQueryEXT?void e.deleteQueryEXT(r):void this.deleteQuery(r)},I.prototype._getTimeQueryResult=function(r){var e=this._caps.timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_EXT):this.getQueryResult(r)},I.prototype._getTimeQueryAvailability=function(r){var e=this._caps.timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(r)},I.prototype.startTimeQuery=function(){var e=this._caps.timerQuery;if(!e)return null;var r=new R._TimeToken;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),this._caps.canUseTimestampForTimerQuery)r._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(r._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;r._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,r._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,r._timeElapsedQuery),this._currentNonTimestampToken=r}return r},I.prototype.endTimeQuery=function(a){var s=this._caps.timerQuery;if(!s||!a)return-1;if(this._caps.canUseTimestampForTimerQuery){if(!a._startTimeQuery)return-1;a._endTimeQuery||(a._endTimeQuery=this._createTimeQuery(),s.queryCounterEXT(a._endTimeQuery,s.TIMESTAMP_EXT))}else if(!a._timeElapsedQueryEnded){if(!a._timeElapsedQuery)return-1;s.endQueryEXT?s.endQueryEXT(s.TIME_ELAPSED_EXT):this._gl.endQuery(s.TIME_ELAPSED_EXT),a._timeElapsedQueryEnded=!0}var l=this._gl.getParameter(s.GPU_DISJOINT_EXT),d=!1;if(a._endTimeQuery?d=this._getTimeQueryAvailability(a._endTimeQuery):a._timeElapsedQuery&&(d=this._getTimeQueryAvailability(a._timeElapsedQuery)),d&&!l){var r=0;if(this._caps.canUseTimestampForTimerQuery){if(!a._startTimeQuery||!a._endTimeQuery)return-1;var n=this._getTimeQueryResult(a._startTimeQuery);r=this._getTimeQueryResult(a._endTimeQuery)-n,this._deleteTimeQuery(a._startTimeQuery),this._deleteTimeQuery(a._endTimeQuery),a._startTimeQuery=null,a._endTimeQuery=null}else{if(!a._timeElapsedQuery)return-1;r=this._getTimeQueryResult(a._timeElapsedQuery),this._deleteTimeQuery(a._timeElapsedQuery),a._timeElapsedQuery=null,a._timeElapsedQueryEnded=!1,this._currentNonTimestampToken=null}return r}return-1},I.prototype.getGlAlgorithmType=function(e){return e===R.AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},I.prototype.createTransformFeedback=function(){return this._gl.createTransformFeedback()},I.prototype.deleteTransformFeedback=function(t){this._gl.deleteTransformFeedback(t)},I.prototype.bindTransformFeedback=function(t){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,t)},I.prototype.beginTransformFeedback=function(t){void 0===t&&(t=!0),this._gl.beginTransformFeedback(t?this._gl.POINTS:this._gl.TRIANGLES)},I.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},I.prototype.setTranformFeedbackVaryings=function(r,e){this._gl.transformFeedbackVaryings(r,e,this._gl.INTERLEAVED_ATTRIBS)},I.prototype.bindTransformFeedbackBuffer=function(t){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,t)},I.prototype._loadFile=function(e,t,i,r,n,o){var s=this,a=R.Tools.LoadFile(e,t,i,r,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add(function(t){s._activeRequests.splice(s._activeRequests.indexOf(t),1)}),a},I.prototype._loadFileAsync=function(a,e,t){var i=this;return new Promise(function(r,n){i._loadFile(a,function(t){r(t)},void 0,e,t,function(r,e){n(e)})})},I.prototype._partialLoadFile=function(s,l,t,e,r,i){void 0===i&&(i=null);var o=function(r,e){i&&r&&i(r.status+' '+r.statusText,e)};this._loadFile(s,function(o){t[l]=o,6==++t._internalCount&&r(t)},void 0,void 0,!0,o)},I.prototype._cascadeLoadFiles=function(a,e,t,i){void 0===i&&(i=null);var r=[];r._internalCount=0;for(var n=0;6>n;n++)this._partialLoadFile(t[n],n,r,a,e,i)},I.isSupported=function(){try{var t=document.createElement('canvas');return null!=(t.getContext('webgl')||t.getContext('experimental-webgl'))&&!!window.WebGLRenderingContext}catch(t){return!1}},I.ExceptionList=[{key:'Chrome/63.0',capture:'63\\.0\\.3239\\.(\\d+)',captureConstraint:108,targets:['uniformBuffer']},{key:'Firefox/58',capture:null,captureConstraint:null,targets:['uniformBuffer']},{key:'Firefox/59',capture:null,captureConstraint:null,targets:['uniformBuffer']},{key:'Macintosh',capture:null,captureConstraint:null,targets:['textureBindingOptimization']},{key:'iPhone',capture:null,captureConstraint:null,targets:['textureBindingOptimization']},{key:'iPad',capture:null,captureConstraint:null,targets:['textureBindingOptimization']}],I.Instances=[],I._ALPHA_DISABLE=0,I._ALPHA_ADD=1,I._ALPHA_COMBINE=2,I._ALPHA_SUBTRACT=3,I._ALPHA_MULTIPLY=4,I._ALPHA_MAXIMIZED=5,I._ALPHA_ONEONE=6,I._ALPHA_PREMULTIPLIED=7,I._ALPHA_PREMULTIPLIED_PORTERDUFF=8,I._ALPHA_INTERPOLATE=9,I._ALPHA_SCREENMODE=10,I._DELAYLOADSTATE_NONE=0,I._DELAYLOADSTATE_LOADED=1,I._DELAYLOADSTATE_LOADING=2,I._DELAYLOADSTATE_NOTLOADED=4,I._TEXTUREFORMAT_ALPHA=0,I._TEXTUREFORMAT_LUMINANCE=1,I._TEXTUREFORMAT_LUMINANCE_ALPHA=2,I._TEXTUREFORMAT_RGB=4,I._TEXTUREFORMAT_RGBA=5,I._TEXTUREFORMAT_R32F=6,I._TEXTUREFORMAT_RG32F=7,I._TEXTUREFORMAT_RGB32F=8,I._TEXTUREFORMAT_RGBA32F=9,I._TEXTURETYPE_UNSIGNED_INT=0,I._TEXTURETYPE_FLOAT=1,I._TEXTURETYPE_HALF_FLOAT=2,I._NEVER=512,I._ALWAYS=519,I._LESS=513,I._EQUAL=514,I._LEQUAL=515,I._GREATER=516,I._GEQUAL=518,I._NOTEQUAL=517,I._KEEP=7680,I._REPLACE=7681,I._INCR=7682,I._DECR=7683,I._INVERT=5386,I._INCR_WRAP=34055,I._DECR_WRAP=34056,I._SCALEMODE_FLOOR=1,I._SCALEMODE_NEAREST=2,I._SCALEMODE_CEILING=3,I.CollisionsEpsilon=.001,I.CodeRepository='src/',I.ShadersRepository='src/Shaders/',I}();R.Engine=a}(e||(e={}));var e;!function(a){var e=function(){function e(e,r){void 0===r&&(r=null),this.state='',this.metadata=null,this.doNotSerialize=!1,this._isDisposed=!1,this.animations=[],this._ranges={},this._isEnabled=!0,this._isReady=!0,this._currentRenderId=-1,this._parentRenderId=-1,this._childRenderId=-1,this._animationPropertiesOverride=null,this.onDisposeObservable=new a.Observable,this._behaviors=[],this.name=e,this.id=e,this._scene=r||a.Engine.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}return e.prototype.isDisposed=function(){return this._isDisposed},Object.defineProperty(e.prototype,'parent',{get:function(){return this._parentNode},set:function(r){if(this._parentNode!==r){if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){var e=this._parentNode._children.indexOf(this);-1!==e&&this._parentNode._children.splice(e,1)}this._parentNode=r,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=[]),this._parentNode._children.push(this))}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'animationPropertiesOverride',{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'Node'},Object.defineProperty(e.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getEngine=function(){return this._scene.getEngine()},e.prototype.addBehavior=function(r){var e=this;if(-1!==this._behaviors.indexOf(r))return this;if(r.init(),this._scene.isLoading)var t=this._scene.onDataLoadedObservable.add(function(){r.attach(e),setTimeout(function(){e._scene.onDataLoadedObservable.remove(t)},0)});else r.attach(this);return this._behaviors.push(r),this},e.prototype.removeBehavior=function(r){var e=this._behaviors.indexOf(r);return-1===e?this:(this._behaviors[e].detach(),this._behaviors.splice(e,1),this)},Object.defineProperty(e.prototype,'behaviors',{get:function(){return this._behaviors},enumerable:!0,configurable:!0}),e.prototype.getBehaviorByName=function(o){for(var e=0,t=this._behaviors,i;e<t.length;e++)if(i=t[e],i.name===o)return i;return null},e.prototype.getWorldMatrix=function(){return a.Matrix.Identity()},e.prototype._getWorldMatrixDeterminant=function(){return 1},e.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},e.prototype.updateCache=function(t){!t&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},e.prototype._updateCache=function(){},e.prototype._isSynchronized=function(){return!0},e.prototype._markSyncedWithParent=function(){this.parent&&(this._parentRenderId=this.parent._childRenderId)},e.prototype.isSynchronizedWithParent=function(){return!this.parent||this._parentRenderId===this.parent._childRenderId&&this.parent.isSynchronized()},e.prototype.isSynchronized=function(r){var e=this.hasNewParent();return e=e||!this.isSynchronizedWithParent(),e=e||!this._isSynchronized(),r&&this.updateCache(!0),!e},e.prototype.hasNewParent=function(t){return this._cache.parent!==this.parent&&(t&&(this._cache.parent=this.parent),!0)},e.prototype.isReady=function(t){return void 0===t&&(t=!1),this._isReady},e.prototype.isEnabled=function(t){return void 0===t&&(t=!0),!1===t?this._isEnabled:!1!==this._isEnabled&&(void 0===this.parent||null===this.parent||this.parent.isEnabled(t))},e.prototype.setEnabled=function(t){this._isEnabled=t},e.prototype.isDescendantOf=function(t){return!!this.parent&&(this.parent===t||this.parent.isDescendantOf(t))},e.prototype._getDescendants=function(o,e,t){if(void 0===e&&(e=!1),this._children)for(var i=0,r;i<this._children.length;i++)r=this._children[i],t&&!t(r)||o.push(r),e||r._getDescendants(o,!1,t)},e.prototype.getDescendants=function(r,e){var t=[];return this._getDescendants(t,r,e),t},e.prototype.getChildMeshes=function(e,o){var t=[];return this._getDescendants(t,e,function(e){return(!o||o(e))&&e instanceof a.AbstractMesh}),t},e.prototype.getChildTransformNodes=function(e,o){var t=[];return this._getDescendants(t,e,function(e){return(!o||o(e))&&e instanceof a.TransformNode}),t},e.prototype.getChildren=function(t){return this.getDescendants(!0,t)},e.prototype._setReady=function(t){if(t!==this._isReady){if(!t)return void(this._isReady=!1);this.onReady&&this.onReady(this),this._isReady=!0}},e.prototype.getAnimationByName=function(r){for(var e=0,t;e<this.animations.length;e++)if(t=this.animations[e],t.name===r)return t;return null},e.prototype.createAnimationRange=function(e,t,i){if(!this._ranges[e]){this._ranges[e]=new a.AnimationRange(e,t,i);for(var r=0,n=this.animations.length;r<n;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}},e.prototype.deleteAnimationRange=function(o,e){void 0===e&&(e=!0);for(var t=0,i=this.animations.length;t<i;t++)this.animations[t]&&this.animations[t].deleteRange(o,e);this._ranges[o]=null},e.prototype.getAnimationRange=function(t){return this._ranges[t]},e.prototype.beginAnimation=function(o,e,t,i){var r=this.getAnimationRange(o);return r?this._scene.beginAnimation(this,r.from,r.to,e,t,i):null},e.prototype.serializeAnimationRanges=function(){var o=[];for(var e in this._ranges){var t=this._ranges[e];if(t){var i={};i.name=e,i.from=t.from,i.to=t.to,o.push(i)}}return o},e.prototype.computeWorldMatrix=function(){return a.Matrix.Identity()},e.prototype.dispose=function(d,e){if(void 0===e&&(e=!1),d)for(var t=this.getChildTransformNodes(!0),i=0,r=t,n;i<r.length;i++)n=r[i],n.parent=null,n.computeWorldMatrix(!0);else for(var o=this.getDescendants(!0),s=0,a=o,l;s<a.length;s++)l=a[s],l.dispose(d,e);this.parent=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear();for(var p=0,c=this._behaviors;p<c.length;p++)c[p].detach();this._behaviors=[],this._isDisposed=!0},e.ParseAnimationRanges=function(o,e){if(e.ranges)for(var t=0,r;t<e.ranges.length;t++)r=e.ranges[t],o.createAnimationRange(r.name,r.from,r.to)},g([a.serialize()],e.prototype,'name',void 0),g([a.serialize()],e.prototype,'id',void 0),g([a.serialize()],e.prototype,'uniqueId',void 0),g([a.serialize()],e.prototype,'state',void 0),g([a.serialize()],e.prototype,'metadata',void 0),e}();a.Node=e}(e||(e={}));var e;!function(a){var e=function(){function e(e,r){this._tempRadiusVector=a.Vector3.Zero(),this.reConstruct(e,r)}return e.prototype.reConstruct=function(e,t){this.minimum=e.clone(),this.maximum=t.clone();var o=a.Vector3.Distance(e,t);this.center=a.Vector3.Lerp(e,t,.5),this.radius=.5*o,this.centerWorld=a.Vector3.Zero(),this._update(a.Matrix.Identity())},e.prototype._update=function(e){a.Vector3.TransformCoordinatesToRef(this.center,e,this.centerWorld),a.Vector3.TransformNormalFromFloatsToRef(1,1,1,e,this._tempRadiusVector),this.radiusWorld=W(A(this._tempRadiusVector.x),A(this._tempRadiusVector.y),A(this._tempRadiusVector.z))*this.radius},e.prototype.isInFrustum=function(r){for(var e=0;6>e;e++)if(r[e].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},e.prototype.intersectsPoint=function(e){var t=this.centerWorld.x-e.x,i=this.centerWorld.y-e.y,r=this.centerWorld.z-e.z,n=$(t*t+i*i+r*r);return!(A(this.radiusWorld-n)<a.Epsilon)},e.Intersects=function(a,e){var t=a.centerWorld.x-e.centerWorld.x,i=a.centerWorld.y-e.centerWorld.y,r=a.centerWorld.z-e.centerWorld.z,n=$(t*t+i*i+r*r);return!(a.radiusWorld+e.radiusWorld<n)},e}();a.BoundingSphere=e}(e||(e={}));var e;!function(a){var e=function(){function r(r,e){this.vectorsWorld=[],this.reConstruct(r,e)}return r.prototype.reConstruct=function(e,t){this.minimum=e.clone(),this.maximum=t.clone(),this.vectors=[],this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this.extendSize=this.maximum.subtract(this.minimum).scale(.5),this.directions=[a.Vector3.Zero(),a.Vector3.Zero(),a.Vector3.Zero()];for(var o=0;o<this.vectors.length;o++)this.vectorsWorld[o]=a.Vector3.Zero();this.minimumWorld=a.Vector3.Zero(),this.maximumWorld=a.Vector3.Zero(),this.centerWorld=a.Vector3.Zero(),this.extendSizeWorld=a.Vector3.Zero(),this._update(this._worldMatrix||a.Matrix.Identity())},r.prototype.getWorldMatrix=function(){return this._worldMatrix},r.prototype.setWorldMatrix=function(t){return this._worldMatrix.copyFrom(t),this},r.prototype._update=function(e){a.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),a.Vector3.FromFloatsToRef(-S,-S,-S,this.maximumWorld);for(var t=0,o;t<this.vectors.length;t++)o=this.vectorsWorld[t],a.Vector3.TransformCoordinatesToRef(this.vectors[t],e,o),o.x<this.minimumWorld.x&&(this.minimumWorld.x=o.x),o.y<this.minimumWorld.y&&(this.minimumWorld.y=o.y),o.z<this.minimumWorld.z&&(this.minimumWorld.z=o.z),o.x>this.maximumWorld.x&&(this.maximumWorld.x=o.x),o.y>this.maximumWorld.y&&(this.maximumWorld.y=o.y),o.z>this.maximumWorld.z&&(this.maximumWorld.z=o.z);this.maximumWorld.subtractToRef(this.minimumWorld,this.extendSizeWorld),this.extendSizeWorld.scaleInPlace(.5),this.maximumWorld.addToRef(this.minimumWorld,this.centerWorld),this.centerWorld.scaleInPlace(.5),a.Vector3.FromFloatArrayToRef(e.m,0,this.directions[0]),a.Vector3.FromFloatArrayToRef(e.m,4,this.directions[1]),a.Vector3.FromFloatArrayToRef(e.m,8,this.directions[2]),this._worldMatrix=e},r.prototype.isInFrustum=function(t){return r.IsInFrustum(this.vectorsWorld,t)},r.prototype.isCompletelyInFrustum=function(t){return r.IsCompletelyInFrustum(this.vectorsWorld,t)},r.prototype.intersectsPoint=function(e){var t=-a.Epsilon;return!(this.maximumWorld.x-e.x<t||t>e.x-this.minimumWorld.x)&&!(this.maximumWorld.y-e.y<t||t>e.y-this.minimumWorld.y)&&!(this.maximumWorld.z-e.z<t||t>e.z-this.minimumWorld.z)},r.prototype.intersectsSphere=function(t){return r.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)},r.prototype.intersectsMinMax=function(r,e){return!(this.maximumWorld.x<r.x||this.minimumWorld.x>e.x)&&!(this.maximumWorld.y<r.y||this.minimumWorld.y>e.y)&&!(this.maximumWorld.z<r.z||this.minimumWorld.z>e.z)},r.Intersects=function(r,e){return!(r.maximumWorld.x<e.minimumWorld.x||r.minimumWorld.x>e.maximumWorld.x)&&!(r.maximumWorld.y<e.minimumWorld.y||r.minimumWorld.y>e.maximumWorld.y)&&!(r.maximumWorld.z<e.minimumWorld.z||r.minimumWorld.z>e.maximumWorld.z)},r.IntersectsSphere=function(e,t,i,r){var n=a.Vector3.Clamp(i,e,t);return a.Vector3.DistanceSquared(i,n)<=r*r},r.IsCompletelyInFrustum=function(o,e){for(var t=0;6>t;t++)for(var i=0;8>i;i++)if(0>e[t].dotCoordinate(o[i]))return!1;return!0},r.IsInFrustum=function(o,e){for(var t=0;6>t;t++){for(var i=8,r=0;8>r&&0>e[t].dotCoordinate(o[r]);r++)--i;if(0===i)return!1}return!0},r}();a.BoundingBox=e}(e||(e={}));var e;!function(l){var a=function(e,t){var i=l.Vector3.Dot(t.centerWorld,e),r=A(l.Vector3.Dot(t.directions[0],e))*t.extendSize.x,n=A(l.Vector3.Dot(t.directions[1],e))*t.extendSize.y,o=A(l.Vector3.Dot(t.directions[2],e))*t.extendSize.z,s=r+n+o;return{min:i-s,max:i+s}},t=function(o,e,t,i){return!(o>i||t>e)},e=function(i,e,r){var n=a(i,e),o=a(i,r);return t(n.min,n.max,o.min,o.max)},r=function(){function r(e,r){this.minimum=e,this.maximum=r,this._isLocked=!1,this.boundingBox=new l.BoundingBox(e,r),this.boundingSphere=new l.BoundingSphere(e,r)}return Object.defineProperty(r.prototype,'isLocked',{get:function(){return this._isLocked},set:function(t){this._isLocked=t},enumerable:!0,configurable:!0}),r.prototype.update=function(t){this._isLocked||(this.boundingBox._update(t),this.boundingSphere._update(t))},r.prototype.centerOn=function(e,t){return this.minimum=e.subtract(t),this.maximum=e.add(t),this.boundingBox=new l.BoundingBox(this.minimum,this.maximum),this.boundingSphere=new l.BoundingSphere(this.minimum,this.maximum),this},r.prototype.isInFrustum=function(t){return!!this.boundingSphere.isInFrustum(t)&&this.boundingBox.isInFrustum(t)},Object.defineProperty(r.prototype,'diagonalLength',{get:function(){var t=this.boundingBox;return t.maximumWorld.subtract(t.minimumWorld).length()},enumerable:!0,configurable:!0}),r.prototype.isCompletelyInFrustum=function(t){return this.boundingBox.isCompletelyInFrustum(t)},r.prototype._checkCollision=function(t){return t._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},r.prototype.intersectsPoint=function(t){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(t)&&!!this.boundingBox.intersectsPoint(t)},r.prototype.intersects=function(r,t){if(!this.boundingSphere.centerWorld||!r.boundingSphere.centerWorld)return!1;if(!l.BoundingSphere.Intersects(this.boundingSphere,r.boundingSphere))return!1;if(!l.BoundingBox.Intersects(this.boundingBox,r.boundingBox))return!1;if(!t)return!0;var a=this.boundingBox,n=r.boundingBox;return!!e(a.directions[0],a,n)&&!!e(a.directions[1],a,n)&&!!e(a.directions[2],a,n)&&!!e(n.directions[0],a,n)&&!!e(n.directions[1],a,n)&&!!e(n.directions[2],a,n)&&!!e(l.Vector3.Cross(a.directions[0],n.directions[0]),a,n)&&!!e(l.Vector3.Cross(a.directions[0],n.directions[1]),a,n)&&!!e(l.Vector3.Cross(a.directions[0],n.directions[2]),a,n)&&!!e(l.Vector3.Cross(a.directions[1],n.directions[0]),a,n)&&!!e(l.Vector3.Cross(a.directions[1],n.directions[1]),a,n)&&!!e(l.Vector3.Cross(a.directions[1],n.directions[2]),a,n)&&!!e(l.Vector3.Cross(a.directions[2],n.directions[0]),a,n)&&!!e(l.Vector3.Cross(a.directions[2],n.directions[1]),a,n)&&!!e(l.Vector3.Cross(a.directions[2],n.directions[2]),a,n)},r}();l.BoundingInfo=r}(e||(e={}));var e;!function(d){var e=function(a){function e(t,r,i){void 0===r&&(r=null),void 0===i&&(i=!0);var o=a.call(this,t,r)||this;return o._forward=new d.Vector3(0,0,1),o._forwardInverted=new d.Vector3(0,0,-1),o._up=new d.Vector3(0,1,0),o._right=new d.Vector3(1,0,0),o._rightInverted=new d.Vector3(-1,0,0),o._rotation=d.Vector3.Zero(),o._scaling=d.Vector3.One(),o._isDirty=!1,o.billboardMode=e.BILLBOARDMODE_NONE,o.scalingDeterminant=1,o.infiniteDistance=!1,o.position=d.Vector3.Zero(),o._localWorld=d.Matrix.Zero(),o._worldMatrix=d.Matrix.Zero(),o._worldMatrixDeterminant=0,o._absolutePosition=d.Vector3.Zero(),o._pivotMatrix=d.Matrix.Identity(),o._postMultiplyPivotMatrix=!1,o._isWorldMatrixFrozen=!1,o.onAfterWorldMatrixUpdateObservable=new d.Observable,o._nonUniformScaling=!1,i&&o.getScene().addTransformNode(o),o}return h(e,a),e.prototype.getClassName=function(){return'TransformNode'},Object.defineProperty(e.prototype,'rotation',{get:function(){return this._rotation},set:function(t){this._rotation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'scaling',{get:function(){return this._scaling},set:function(t){this._scaling=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'rotationQuaternion',{get:function(){return this._rotationQuaternion},set:function(t){this._rotationQuaternion=t,t&&this.rotation.length()&&this.rotation.copyFromFloats(0,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'forward',{get:function(){return d.Vector3.Normalize(d.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._forwardInverted:this._forward,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'up',{get:function(){return d.Vector3.Normalize(d.Vector3.TransformNormal(this._up,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'right',{get:function(){return d.Vector3.Normalize(d.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._rightInverted:this._right,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),e.prototype.getWorldMatrix=function(){return this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},e.prototype._getWorldMatrixDeterminant=function(){return this._worldMatrixDeterminant},Object.defineProperty(e.prototype,'worldMatrixFromCache',{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),e.prototype.updatePoseMatrix=function(t){return this._poseMatrix.copyFrom(t),this},e.prototype.getPoseMatrix=function(){return this._poseMatrix},e.prototype._isSynchronized=function(){return!this._isDirty&&this.billboardMode===this._cache.billboardMode&&this.billboardMode===e.BILLBOARDMODE_NONE&&!this._cache.pivotMatrixUpdated&&!this.infiniteDistance&&!!this._cache.position.equals(this.position)&&(!this.rotationQuaternion||this._cache.rotationQuaternion.equals(this.rotationQuaternion))&&!!this._cache.rotation.equals(this.rotation)&&!!this._cache.scaling.equals(this.scaling)},e.prototype._initCache=function(){a.prototype._initCache.call(this),this._cache.localMatrixUpdated=!1,this._cache.position=d.Vector3.Zero(),this._cache.scaling=d.Vector3.Zero(),this._cache.rotation=d.Vector3.Zero(),this._cache.rotationQuaternion=new d.Quaternion(0,0,0,0),this._cache.billboardMode=-1},e.prototype.markAsDirty=function(t){return'rotation'===t&&(this.rotationQuaternion=null),this._currentRenderId=S,this._isDirty=!0,this},Object.defineProperty(e.prototype,'absolutePosition',{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),e.prototype.setPreTransformMatrix=function(t){return this.setPivotMatrix(t,!1)},e.prototype.setPivotMatrix=function(e,t){return void 0===t&&(t=!0),this._pivotMatrix=e.clone(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=d.Matrix.Invert(this._pivotMatrix)),this},e.prototype.getPivotMatrix=function(){return this._pivotMatrix},e.prototype.freezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this._isWorldMatrixFrozen=!0,this},e.prototype.unfreezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this},Object.defineProperty(e.prototype,'isWorldMatrixFrozen',{get:function(){return this._isWorldMatrixFrozen},enumerable:!0,configurable:!0}),e.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},e.prototype.setAbsolutePosition=function(e){if(!e)return this;var a,i,r;if(void 0===e.x){if(3>arguments.length)return this;a=arguments[0],i=arguments[1],r=arguments[2]}else a=e.x,i=e.y,r=e.z;if(this.parent){var n=this.parent.getWorldMatrix().clone();n.invert();var o=new d.Vector3(a,i,r);this.position=d.Vector3.TransformCoordinates(o,n)}else this.position.x=a,this.position.y=i,this.position.z=r;return this},e.prototype.setPositionWithLocalVector=function(e){return this.computeWorldMatrix(),this.position=d.Vector3.TransformNormal(e,this._localWorld),this},e.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var e=this._localWorld.clone();return e.invert(),d.Vector3.TransformNormal(this.position,e)},e.prototype.locallyTranslate=function(e){return this.computeWorldMatrix(!0),this.position=d.Vector3.TransformCoordinates(e,this._localWorld),this},e.prototype.lookAt=function(i,t,r,n,o){void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=d.Space.LOCAL);var s=e._lookAtVectorCache,a=o===d.Space.LOCAL?this.position:this.getAbsolutePosition();i.subtractToRef(a,s);var l=-I(s.z,s.x)-V/2,p=$(s.x*s.x+s.z*s.z),c=I(s.y,p);return this.rotationQuaternion?d.Quaternion.RotationYawPitchRollToRef(l+t,c+r,n,this.rotationQuaternion):(this.rotation.x=c+r,this.rotation.y=l+t,this.rotation.z=n),this},e.prototype.getDirection=function(e){var t=d.Vector3.Zero();return this.getDirectionToRef(e,t),t},e.prototype.getDirectionToRef=function(e,t){return d.Vector3.TransformNormalToRef(e,this.getWorldMatrix(),t),this},e.prototype.setPivotPoint=function(e,t){void 0===t&&(t=d.Space.LOCAL),0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);var o=this.getWorldMatrix();if(t==d.Space.WORLD){var r=d.Tmp.Matrix[0];o.invertToRef(r),e=d.Vector3.TransformCoordinates(e,r)}return this.setPivotMatrix(d.Matrix.Translation(-e.x,-e.y,-e.z),!0)},e.prototype.getPivotPoint=function(){var e=d.Vector3.Zero();return this.getPivotPointToRef(e),e},e.prototype.getPivotPointToRef=function(t){return t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14],this},e.prototype.getAbsolutePivotPoint=function(){var e=d.Vector3.Zero();return this.getAbsolutePivotPointToRef(e),e},e.prototype.getAbsolutePivotPointToRef=function(e){return e.x=this._pivotMatrix.m[12],e.y=this._pivotMatrix.m[13],e.z=this._pivotMatrix.m[14],this.getPivotPointToRef(e),d.Vector3.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this},e.prototype.setParent=function(e){if(null===e){var t=d.Tmp.Quaternion[0],i=d.Tmp.Vector3[0],r=d.Tmp.Vector3[1];this.parent&&this.parent.computeWorldMatrix&&this.parent.computeWorldMatrix(!0),this.computeWorldMatrix(!0),this.getWorldMatrix().decompose(r,t,i),this.rotationQuaternion?this.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(this.rotation),this.scaling.x=r.x,this.scaling.y=r.y,this.scaling.z=r.z,this.position.x=i.x,this.position.y=i.y,this.position.z=i.z}else{var t=d.Tmp.Quaternion[0],i=d.Tmp.Vector3[0],r=d.Tmp.Vector3[1],a=d.Tmp.Matrix[0],o=d.Tmp.Matrix[1];this.computeWorldMatrix(!0),e.computeWorldMatrix(!0),e.getWorldMatrix().invertToRef(o),this.getWorldMatrix().multiplyToRef(o,a),a.decompose(r,t,i),this.rotationQuaternion?this.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(this.rotation),this.position.x=i.x,this.position.y=i.y,this.position.z=i.z,this.scaling.x=r.x,this.scaling.y=r.y,this.scaling.z=r.z}return this.parent=e,this},Object.defineProperty(e.prototype,'nonUniformScaling',{get:function(){return this._nonUniformScaling},enumerable:!0,configurable:!0}),e.prototype._updateNonUniformScalingState=function(t){return this._nonUniformScaling!==t&&(this._nonUniformScaling=!0,!0)},e.prototype.attachToBone=function(r,e){return this._transformToBoneReferal=e,this.parent=r,0>r.getWorldMatrix().determinant()&&(this.scalingDeterminant*=-1),this},e.prototype.detachFromBone=function(){return this.parent?(0>this.parent.getWorldMatrix().determinant()&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=null,this):this},e.prototype.rotate=function(i,t,r){i.normalize(),this.rotationQuaternion||(this.rotationQuaternion=d.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=d.Vector3.Zero());var a;if(r&&r!==d.Space.LOCAL){if(this.parent){var o=this.parent.getWorldMatrix().clone();o.invert(),i=d.Vector3.TransformNormal(i,o)}a=d.Quaternion.RotationAxisToRef(i,t,e._rotationAxisCache),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else a=d.Quaternion.RotationAxisToRef(i,t,e._rotationAxisCache),this.rotationQuaternion.multiplyToRef(a,this.rotationQuaternion);return this},e.prototype.rotateAround=function(e,t,o){return t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=d.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.copyFromFloats(0,0,0)),e.subtractToRef(this.position,d.Tmp.Vector3[0]),d.Matrix.TranslationToRef(d.Tmp.Vector3[0].x,d.Tmp.Vector3[0].y,d.Tmp.Vector3[0].z,d.Tmp.Matrix[0]),d.Tmp.Matrix[0].invertToRef(d.Tmp.Matrix[2]),d.Matrix.RotationAxisToRef(t,o,d.Tmp.Matrix[1]),d.Tmp.Matrix[2].multiplyToRef(d.Tmp.Matrix[1],d.Tmp.Matrix[2]),d.Tmp.Matrix[2].multiplyToRef(d.Tmp.Matrix[0],d.Tmp.Matrix[2]),d.Tmp.Matrix[2].decompose(d.Tmp.Vector3[0],d.Tmp.Quaternion[0],d.Tmp.Vector3[1]),this.position.addInPlace(d.Tmp.Vector3[1]),d.Tmp.Quaternion[0].multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this},e.prototype.translate=function(e,t,i){var r=e.scale(t);if(i&&i!==d.Space.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(r));else{var a=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(a)}return this},e.prototype.addRotation=function(e,t,i){var r;this.rotationQuaternion?r=this.rotationQuaternion:(r=d.Tmp.Quaternion[1],d.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));var a=d.Tmp.Quaternion[0];return d.Quaternion.RotationYawPitchRollToRef(t,e,i,a),r.multiplyInPlace(a),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this},e.prototype.computeWorldMatrix=function(i){if(this._isWorldMatrixFrozen)return this._worldMatrix;if(!i&&this.isSynchronized(!0))return this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix;(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._cache.billboardMode=this.billboardMode,this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this.getScene().getRenderId(),this._isDirty=!1,d.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,d.Tmp.Matrix[1]),this.rotationQuaternion)&&this.rotation.length()&&(this.rotationQuaternion.multiplyInPlace(d.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)),this.rotation.copyFromFloats(0,0,0)),this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(d.Tmp.Matrix[0]),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(d.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,d.Tmp.Matrix[0]),this._cache.rotation.copyFrom(this.rotation));var l=this.getScene().activeCamera;if(this.infiniteDistance&&!this.parent&&l){var r=l.getWorldMatrix(),n=new d.Vector3(r.m[12],r.m[13],r.m[14]);d.Matrix.TranslationToRef(this.position.x+n.x,this.position.y+n.y,this.position.z+n.z,d.Tmp.Matrix[2])}else d.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,d.Tmp.Matrix[2]);if(this._pivotMatrix.multiplyToRef(d.Tmp.Matrix[1],d.Tmp.Matrix[4]),d.Tmp.Matrix[4].multiplyToRef(d.Tmp.Matrix[0],d.Tmp.Matrix[5]),this.billboardMode!==e.BILLBOARDMODE_NONE&&l){if((this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){var o=d.Tmp.Vector3[3];this.parent&&this.parent.getWorldMatrix?this._transformToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),d.Tmp.Matrix[6]),d.Vector3.TransformCoordinatesToRef(this.position,d.Tmp.Matrix[6],o)):d.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),o):o.copyFrom(this.position),o.subtractInPlace(l.globalPosition);var s=d.Tmp.Vector3[4].copyFromFloats(0,0,0);(this.billboardMode&e.BILLBOARDMODE_X)===e.BILLBOARDMODE_X&&(s.x=I(-o.y,o.z)),(this.billboardMode&e.BILLBOARDMODE_Y)===e.BILLBOARDMODE_Y&&(s.y=I(o.x,o.z)),(this.billboardMode&e.BILLBOARDMODE_Z)===e.BILLBOARDMODE_Z&&(s.z=I(o.y,o.x)),d.Matrix.RotationYawPitchRollToRef(s.y,s.x,s.z,d.Tmp.Matrix[0])}else d.Tmp.Matrix[1].copyFrom(l.getViewMatrix()),d.Tmp.Matrix[1].setTranslationFromFloats(0,0,0),d.Tmp.Matrix[1].invertToRef(d.Tmp.Matrix[0]);d.Tmp.Matrix[1].copyFrom(d.Tmp.Matrix[5]),d.Tmp.Matrix[1].multiplyToRef(d.Tmp.Matrix[0],d.Tmp.Matrix[5])}return d.Tmp.Matrix[5].multiplyToRef(d.Tmp.Matrix[2],this._localWorld),this.parent&&this.parent.getWorldMatrix?(this.billboardMode===e.BILLBOARDMODE_NONE?this._transformToBoneReferal?(this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),d.Tmp.Matrix[6]),d.Tmp.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix):(this._transformToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),d.Tmp.Matrix[6]),d.Tmp.Matrix[5].copyFrom(d.Tmp.Matrix[6])):d.Tmp.Matrix[5].copyFrom(this.parent.getWorldMatrix()),this._localWorld.getTranslationToRef(d.Tmp.Vector3[5]),d.Vector3.TransformCoordinatesToRef(d.Tmp.Vector3[5],d.Tmp.Matrix[5],d.Tmp.Vector3[5]),this._worldMatrix.copyFrom(this._localWorld),this._worldMatrix.setTranslation(d.Tmp.Vector3[5])),this._markSyncedWithParent()):this._worldMatrix.copyFrom(this._localWorld),this._postMultiplyPivotMatrix&&this._worldMatrix.multiplyToRef(this._pivotMatrixInverse,this._worldMatrix),this.scaling.isNonUniform?this._updateNonUniformScalingState(!0):this.parent&&this.parent._nonUniformScaling?this._updateNonUniformScalingState(this.parent._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=d.Matrix.Invert(this._worldMatrix)),this._worldMatrixDeterminant=this._worldMatrix.determinant(),this._worldMatrix},e.prototype._afterComputeWorldMatrix=function(){},e.prototype.registerAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this},e.prototype.unregisterAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this},e.prototype.clone=function(i,t,r){var c=this,o=d.SerializationHelper.Clone(function(){return new e(i,c.getScene())},this);if(o.name=i,o.id=i,t&&(o.parent=t),!r)for(var s=this.getDescendants(!0),a=0,l;a<s.length;a++)l=s[a],l.clone&&l.clone(i+'.'+l.name,o);return o},e.prototype.serialize=function(e){var t=d.SerializationHelper.Serialize(this,e);return t.type=this.getClassName(),this.parent&&(t.parentId=this.parent.id),d.Tags&&d.Tags.HasTags(this)&&(t.tags=d.Tags.GetTags(this)),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),this.parent&&(t.parentId=this.parent.id),t},e.Parse=function(i,t,r){var a=d.SerializationHelper.Parse(function(){return new e(i.name,t)},i,t,r);return d.Tags&&d.Tags.AddTagsTo(a,i.tags),i.localMatrix?a.setPreTransformMatrix(d.Matrix.FromArray(i.localMatrix)):i.pivotMatrix&&a.setPivotMatrix(d.Matrix.FromArray(i.pivotMatrix)),a.setEnabled(i.isEnabled),i.parentId&&(a._waitingParentId=i.parentId),a},e.prototype.dispose=function(t,e){void 0===e&&(e=!1),this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this.onAfterWorldMatrixUpdateObservable.clear(),a.prototype.dispose.call(this,t,e)},e.BILLBOARDMODE_NONE=0,e.BILLBOARDMODE_X=1,e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_Z=4,e.BILLBOARDMODE_ALL=7,e._lookAtVectorCache=new d.Vector3(0,0,0),e._rotationAxisCache=new d.Quaternion,g([d.serializeAsVector3()],e.prototype,'_rotation',void 0),g([d.serializeAsQuaternion()],e.prototype,'_rotationQuaternion',void 0),g([d.serializeAsVector3()],e.prototype,'_scaling',void 0),g([d.serialize()],e.prototype,'billboardMode',void 0),g([d.serialize()],e.prototype,'scalingDeterminant',void 0),g([d.serialize()],e.prototype,'infiniteDistance',void 0),g([d.serializeAsVector3()],e.prototype,'position',void 0),e}(d.Node);d.TransformNode=e}(e||(e={}));var e;!function(g){var e=function(d){function a(e,t){void 0===t&&(t=null);var n=d.call(this,e,t,!1)||this;return n._facetNb=0,n._partitioningSubdivisions=10,n._partitioningBBoxRatio=1.01,n._facetDataEnabled=!1,n._facetParameters={},n._bbSize=g.Vector3.Zero(),n._subDiv={max:1,X:1,Y:1,Z:1},n._facetDepthSort=!1,n._facetDepthSortEnabled=!1,n.onCollideObservable=new g.Observable,n.onCollisionPositionChangeObservable=new g.Observable,n.onMaterialChangedObservable=new g.Observable,n.definedFacingForward=!0,n.occlusionQueryAlgorithmType=a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,n.occlusionType=a.OCCLUSION_TYPE_NONE,n.occlusionRetryCount=-1,n._occlusionInternalRetryCounter=0,n._isOccluded=!1,n._isOcclusionQueryInProgress=!1,n._visibility=1,n.alphaIndex=S,n.isVisible=!0,n.isPickable=!0,n.showBoundingBox=!1,n.showSubMeshesBoundingBox=!1,n.isBlocker=!1,n.enablePointerMoveEvents=!1,n.renderingGroupId=0,n._receiveShadows=!1,n.renderOutline=!1,n.outlineColor=g.Color3.Red(),n.outlineWidth=.02,n.renderOverlay=!1,n.overlayColor=g.Color3.Red(),n.overlayAlpha=.5,n._hasVertexAlpha=!1,n._useVertexColors=!0,n._computeBonesUsingShaders=!0,n._numBoneInfluencers=4,n._applyFog=!0,n.useOctreeForRenderingSelection=!0,n.useOctreeForPicking=!0,n.useOctreeForCollisions=!0,n._layerMask=268435455,n.alwaysSelectAsActiveMesh=!1,n.actionManager=null,n.physicsImpostor=null,n._checkCollisions=!1,n._collisionMask=-1,n._collisionGroup=-1,n.ellipsoid=new g.Vector3(.5,1,.5),n.ellipsoidOffset=new g.Vector3(0,0,0),n._oldPositionForCollisions=new g.Vector3(0,0,0),n._diffPositionForCollisions=new g.Vector3(0,0,0),n.edgesWidth=1,n.edgesColor=new g.Color4(1,0,0,1),n._collisionsTransformMatrix=g.Matrix.Zero(),n._collisionsScalingMatrix=g.Matrix.Zero(),n._renderId=0,n._intersectionsInProgress=[],n._unIndexed=!1,n._lightSources=[],n._onCollisionPositionChange=function(e,t,o){void 0===o&&(o=null),n.getScene().workerCollisions&&t.multiplyInPlace(n._collider._radius),t.subtractToRef(n._oldPositionForCollisions,n._diffPositionForCollisions),n._diffPositionForCollisions.length()>g.Engine.CollisionsEpsilon&&n.position.addInPlace(n._diffPositionForCollisions),o&&n.onCollideObservable.notifyObservers(o),n.onCollisionPositionChangeObservable.notifyObservers(n.position)},n.getScene().addMesh(n),n._resyncLightSources(),n}return h(a,d),Object.defineProperty(a,'BILLBOARDMODE_NONE',{get:function(){return g.TransformNode.BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(a,'BILLBOARDMODE_X',{get:function(){return g.TransformNode.BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(a,'BILLBOARDMODE_Y',{get:function(){return g.TransformNode.BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(a,'BILLBOARDMODE_Z',{get:function(){return g.TransformNode.BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(a,'BILLBOARDMODE_ALL',{get:function(){return g.TransformNode.BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'facetNb',{get:function(){return this._facetNb},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'partitioningSubdivisions',{get:function(){return this._partitioningSubdivisions},set:function(t){this._partitioningSubdivisions=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'partitioningBBoxRatio',{get:function(){return this._partitioningBBoxRatio},set:function(t){this._partitioningBBoxRatio=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'mustDepthSortFacets',{get:function(){return this._facetDepthSort},set:function(t){this._facetDepthSort=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'facetDepthSortFrom',{get:function(){return this._facetDepthSortFrom},set:function(t){this._facetDepthSortFrom=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'isFacetDataEnabled',{get:function(){return this._facetDataEnabled},enumerable:!0,configurable:!0}),a.prototype._updateNonUniformScalingState=function(t){return!!d.prototype._updateNonUniformScalingState.call(this,t)&&(this._markSubMeshesAsMiscDirty(),!0)},Object.defineProperty(a.prototype,'onCollide',{set:function(t){this._onCollideObserver&&this.onCollideObservable.remove(this._onCollideObserver),this._onCollideObserver=this.onCollideObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'onCollisionPositionChange',{set:function(t){this._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver),this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'isOccluded',{get:function(){return this._isOccluded},set:function(t){this._isOccluded=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'isOcclusionQueryInProgress',{get:function(){return this._isOcclusionQueryInProgress},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'visibility',{get:function(){return this._visibility},set:function(t){this._visibility!==t&&(this._visibility=t,this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'material',{get:function(){return this._material},set:function(t){this._material!==t&&(this._material=t,this.onMaterialChangedObservable.hasObservers&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&this._unBindEffect())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'receiveShadows',{get:function(){return this._receiveShadows},set:function(t){this._receiveShadows!==t&&(this._receiveShadows=t,this._markSubMeshesAsLightDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'hasVertexAlpha',{get:function(){return this._hasVertexAlpha},set:function(t){this._hasVertexAlpha!==t&&(this._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useVertexColors',{get:function(){return this._useVertexColors},set:function(t){this._useVertexColors!==t&&(this._useVertexColors=t,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'computeBonesUsingShaders',{get:function(){return this._computeBonesUsingShaders},set:function(t){this._computeBonesUsingShaders!==t&&(this._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'numBoneInfluencers',{get:function(){return this._numBoneInfluencers},set:function(t){this._numBoneInfluencers!==t&&(this._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'applyFog',{get:function(){return this._applyFog},set:function(t){this._applyFog!==t&&(this._applyFog=t,this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'layerMask',{get:function(){return this._layerMask},set:function(t){t!==this._layerMask&&(this._layerMask=t,this._resyncLightSources())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'collisionMask',{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'collisionGroup',{get:function(){return this._collisionGroup},set:function(t){this._collisionGroup=isNaN(t)?-1:t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'_positions',{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'skeleton',{get:function(){return this._skeleton},set:function(t){this._skeleton&&this._skeleton.needInitialSkinMatrix&&this._skeleton._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._skeleton=t,this._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()},enumerable:!0,configurable:!0}),a.prototype.getClassName=function(){return'AbstractMesh'},a.prototype.toString=function(e){var t='Name: '+this.name+', isInstance: '+(this instanceof g.InstancedMesh?'YES':'NO');return t+=', # of submeshes: '+(this.subMeshes?this.subMeshes.length:0),this._skeleton&&(t+=', skeleton: '+this._skeleton.name),e&&(t+=', billboard mode: '+['NONE','X','Y',null,'Z',null,null,'ALL'][this.billboardMode],t+=', freeze wrld mat: '+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?'YES':'NO')),t},a.prototype._rebuild=function(){if(this._occlusionQuery&&(this._occlusionQuery=null),this._edgesRenderer&&this._edgesRenderer._rebuild(),this.subMeshes)for(var r=0,e=this.subMeshes,t;r<e.length;r++)t=e[r],t._rebuild()},a.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var r=0,e=this.getScene().lights,t;r<e.length;r++)t=e[r],t.isEnabled()&&t.canAffectMesh(this)&&this._lightSources.push(t);this._markSubMeshesAsLightDirty()},a.prototype._resyncLighSource=function(r){var e=r.isEnabled()&&r.canAffectMesh(this),o=this._lightSources.indexOf(r);if(-1===o){if(!e)return;this._lightSources.push(r)}else{if(e)return;this._lightSources.splice(o,1)}this._markSubMeshesAsLightDirty()},a.prototype._unBindEffect=function(){for(var r=0,e=this.subMeshes;r<e.length;r++)e[r].setEffect(null)},a.prototype._removeLightSource=function(r){var e=this._lightSources.indexOf(r);-1!==e&&(this._lightSources.splice(e,1),this._markSubMeshesAsLightDirty())},a.prototype._markSubMeshesAsDirty=function(o){if(this.subMeshes)for(var e=0,t=this.subMeshes,i;e<t.length;e++)i=t[e],i._materialDefines&&o(i._materialDefines)},a.prototype._markSubMeshesAsLightDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsLightDirty()})},a.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsAttributesDirty()})},a.prototype._markSubMeshesAsMiscDirty=function(){if(this.subMeshes)for(var e=0,t=this.subMeshes;e<t.length;e++){var o=t[e],r=o.getMaterial();r&&r.markAsDirty(g.Material.MiscDirtyFlag)}},Object.defineProperty(a.prototype,'scaling',{get:function(){return this._scaling},set:function(t){this._scaling=t,this.physicsImpostor&&this.physicsImpostor.forceUpdate()},enumerable:!0,configurable:!0}),a.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},a.prototype.enableEdgesRendering=function(e,t){return void 0===e&&(e=.95),void 0===t&&(t=!1),this.disableEdgesRendering(),this._edgesRenderer=new g.EdgesRenderer(this,e,t),this},Object.defineProperty(a.prototype,'isBlocked',{get:function(){return!1},enumerable:!0,configurable:!0}),a.prototype.getLOD=function(){return this},a.prototype.getTotalVertices=function(){return 0},a.prototype.getIndices=function(){return null},a.prototype.getVerticesData=function(){return null},a.prototype.setVerticesData=function(){return this},a.prototype.updateVerticesData=function(){return this},a.prototype.setIndices=function(){return this},a.prototype.isVerticesDataPresent=function(){return!1},a.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfo||this._updateBoundingInfo(),this._boundingInfo)},a.prototype.normalizeToUnitCube=function(o){void 0===o&&(o=!0);var e=this.getHierarchyBoundingVectors(o),t=e.max.subtract(e.min),i=W(t.x,t.y,t.z);if(0===i)return this;return this.scaling.scaleInPlace(1/i),this},a.prototype.setBoundingInfo=function(t){return this._boundingInfo=t,this},Object.defineProperty(a.prototype,'useBones',{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(g.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(g.VertexBuffer.MatricesWeightsKind)},enumerable:!0,configurable:!0}),a.prototype._preActivate=function(){},a.prototype._preActivateForIntermediateRendering=function(){},a.prototype._activate=function(t){this._renderId=t},a.prototype.getWorldMatrix=function(){return this._masterMesh?this._masterMesh.getWorldMatrix():d.prototype.getWorldMatrix.call(this)},a.prototype._getWorldMatrixDeterminant=function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():d.prototype._getWorldMatrixDeterminant.call(this)},a.prototype.movePOV=function(r,e,t){return this.position.addInPlace(this.calcMovePOV(r,e,t)),this},a.prototype.calcMovePOV=function(e,t,i){var r=new g.Matrix;(this.rotationQuaternion?this.rotationQuaternion:g.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);var a=g.Vector3.Zero(),o=this.definedFacingForward?-1:1;return g.Vector3.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,a),a},a.prototype.rotatePOV=function(r,e,t){return this.rotation.addInPlace(this.calcRotatePOV(r,e,t)),this},a.prototype.calcRotatePOV=function(e,t,o){var r=this.definedFacingForward?1:-1;return new g.Vector3(e*r,t,o*r)},a.prototype.getHierarchyBoundingVectors=function(e){void 0===e&&(e=!0),this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);var t=this.getBoundingInfo(),n,p;if(this.subMeshes?(n=t.boundingBox.minimumWorld,p=t.boundingBox.maximumWorld):(n=new g.Vector3(S,S,S),p=new g.Vector3(-S,-S,-S)),e)for(var _=this.getDescendants(!1),o=0,s=_;o<s.length;o++){var a=s[o],l=a;if(l.computeWorldMatrix(!0),l.getBoundingInfo&&0!==l.getTotalVertices()){var m=l.getBoundingInfo(),c=m.boundingBox,u=c.minimumWorld,f=c.maximumWorld;g.Tools.CheckExtends(u,n,p),g.Tools.CheckExtends(f,n,p)}}return{min:n,max:p}},a.prototype._updateBoundingInfo=function(){return this._boundingInfo=this._boundingInfo||new g.BoundingInfo(this.absolutePosition,this.absolutePosition),this._boundingInfo.update(this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},a.prototype._updateSubMeshesBoundingInfo=function(r){if(!this.subMeshes)return this;for(var e=0,t;e<this.subMeshes.length;e++)t=this.subMeshes[e],t.IsGlobal||t.updateBoundingInfo(r);return this},a.prototype._afterComputeWorldMatrix=function(){this._updateBoundingInfo()},a.prototype.isInFrustum=function(t){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(t)},a.prototype.isCompletelyInFrustum=function(t){return null!==this._boundingInfo&&this._boundingInfo.isCompletelyInFrustum(t)},a.prototype.intersectsMesh=function(a,e,t){if(void 0===e&&(e=!1),!this._boundingInfo||!a._boundingInfo)return!1;if(this._boundingInfo.intersects(a._boundingInfo,e))return!0;if(t)for(var i=0,r=this.getChildMeshes(),n;i<r.length;i++)if(n=r[i],n.intersectsMesh(a,e,!0))return!0;return!1},a.prototype.intersectsPoint=function(t){return!!this._boundingInfo&&this._boundingInfo.intersectsPoint(t)},a.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},a.prototype.getPositionInCameraSpace=function(e){return void 0===e&&(e=null),e||(e=this.getScene().activeCamera),g.Vector3.TransformCoordinates(this.absolutePosition,e.getViewMatrix())},a.prototype.getDistanceToCamera=function(t){return void 0===t&&(t=null),t||(t=this.getScene().activeCamera),this.absolutePosition.subtract(t.position).length()},a.prototype.applyImpulse=function(r,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(r,e),this):this},a.prototype.setPhysicsLinkWith=function(e,t,o,a){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,g.PhysicsJoint.HingeJoint,{mainPivot:t,connectedPivot:o,nativeParams:a}),this):this},Object.defineProperty(a.prototype,'checkCollisions',{get:function(){return this._checkCollisions},set:function(t){this._checkCollisions=t,this.getScene().workerCollisions&&this.getScene().collisionCoordinator.onMeshUpdated(this)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'collider',{get:function(){return this._collider},enumerable:!0,configurable:!0}),a.prototype.moveWithCollisions=function(e){return this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._oldPositionForCollisions),this._collider||(this._collider=new g.Collider),this._collider._radius=this.ellipsoid,this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,e,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId),this},a.prototype.createOrUpdateSubmeshesOctree=function(e,t){void 0===e&&(e=64),void 0===t&&(t=2),this._submeshesOctree||(this._submeshesOctree=new g.Octree(g.Octree.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);var o=this.getBoundingInfo(),r=o.boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree},a.prototype._collideForSubMesh=function(e,t,i){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var r=e.verticesStart,a=e.verticesStart+e.verticesCount,o=r;o<a;o++)e._lastColliderWorldVertices.push(g.Vector3.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial()),i.collisionFound&&(i.collidedMesh=this),this},a.prototype._processCollisionsForSubMeshes=function(l,e){var t,i;if(this._submeshesOctree&&this.useOctreeForCollisions){var r=l._velocityWorldLength+W(l._radius.x,l._radius.y,l._radius.z),n=this._submeshesOctree.intersects(l._basePointWorld,r);i=n.length,t=n.data}else t=this.subMeshes,i=t.length;for(var o=0,s;o<i;o++)s=t[o],1<i&&!s._checkCollision(l)||this._collideForSubMesh(s,e,l);return this},a.prototype._checkCollision=function(e){return this._boundingInfo&&this._boundingInfo._checkCollision(e)?(g.Matrix.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(e,this._collisionsTransformMatrix),this):this},a.prototype._generatePointsArray=function(){return!1},a.prototype.intersects=function(e,t){var i=new g.PickingInfo;if(!(this.subMeshes&&this._boundingInfo&&e.intersectsSphere(this._boundingInfo.boundingSphere)&&e.intersectsBox(this._boundingInfo.boundingBox)))return i;if(!this._generatePointsArray())return i;var r=null,y,n;if(this._submeshesOctree&&this.useOctreeForPicking){var o=g.Ray.Transform(e,this.getWorldMatrix()),a=this._submeshesOctree.intersectsRay(o);n=a.length,y=a.data}else y=this.subMeshes,n=y.length;for(var l=0,h;l<n;l++)if(h=y[l],!(1<n)||h.canIntersects(e)){var c=h.intersects(e,this._positions,this.getIndices(),t);if(c&&(t||!r||c.distance<r.distance)&&(r=c,r.subMeshId=l,t))break}if(r){var u=this.getWorldMatrix(),f=g.Vector3.TransformCoordinates(e.origin,u),d=e.direction.clone();d=d.scale(r.distance);var p=g.Vector3.TransformNormal(d,u),_=f.add(p);return i.hit=!0,i.distance=g.Vector3.Distance(f,_),i.pickedPoint=_,i.pickedMesh=this,i.bu=r.bu||0,i.bv=r.bv||0,i.faceId=r.faceId,i.subMeshId=r.subMeshId,i}return i},a.prototype.clone=function(){return null},a.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this},a.prototype.dispose=function(t,c){var p=this;void 0===c&&(c=!1);var r;for(this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._skeleton=null,this.physicsImpostor&&this.physicsImpostor.dispose(),r=0;r<this._intersectionsInProgress.length;r++){var i=this._intersectionsInProgress[r],o=i._intersectionsInProgress.indexOf(this);i._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress=[],this.getScene().lights.forEach(function(r){var e=r.includedOnlyMeshes.indexOf(p);-1!==e&&r.includedOnlyMeshes.splice(e,1),-1!==(e=r.excludedMeshes.indexOf(p))&&r.excludedMeshes.splice(e,1);var t=r.getShadowGenerator();if(t){var o=t.getShadowMap();o&&o.renderList&&-1!==(e=o.renderList.indexOf(p))&&o.renderList.splice(e,1)}}),this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),'InstancedMesh'!==this.getClassName()&&this.releaseSubMeshes();var n=this.getScene().selectionOctree;if(void 0!==n&&null!==n){var r=n.dynamicContent.indexOf(this);-1!==r&&n.dynamicContent.splice(r,1)}var a=this.getScene().getEngine();if(this._occlusionQuery&&(this._isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),this.getScene().removeMesh(this),c&&this.material&&this.material.dispose(!1,!0),!t)for(r=0;r<this.getScene().particleSystems.length;r++)this.getScene().particleSystems[r].emitter===this&&(this.getScene().particleSystems[r].dispose(),r--);this._facetDataEnabled&&this.disableFacetData(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),d.prototype.dispose.call(this,t,c)},a.prototype.addChild=function(t){return t.setParent(this),this},a.prototype.removeChild=function(t){return t.setParent(null),this},a.prototype._initFacetData=function(){this._facetNormals||(this._facetNormals=[]),this._facetPositions||(this._facetPositions=[]),this._facetPartitioning||(this._facetPartitioning=[]),this._facetNb=0|this.getIndices().length/3,this._partitioningSubdivisions=this._partitioningSubdivisions?this._partitioningSubdivisions:10,this._partitioningBBoxRatio=this._partitioningBBoxRatio?this._partitioningBBoxRatio:1.01;for(var e=0;e<this._facetNb;e++)this._facetNormals[e]=g.Vector3.Zero(),this._facetPositions[e]=g.Vector3.Zero();return this._facetDataEnabled=!0,this},a.prototype.updateFacetData=function(){this._facetDataEnabled||this._initFacetData();var e=this.getVerticesData(g.VertexBuffer.PositionKind),t=this.getIndices(),i=this.getVerticesData(g.VertexBuffer.NormalKind),r=this.getBoundingInfo();if(this._facetDepthSort&&!this._facetDepthSortEnabled){if(this._facetDepthSortEnabled=!0,t instanceof Uint16Array)this._depthSortedIndices=new Uint16Array(t);else if(t instanceof Uint32Array)this._depthSortedIndices=new Uint32Array(t);else{for(var n=!1,o=0;o<t.length;o++)if(65535<t[o]){n=!0;break}this._depthSortedIndices=n?new Uint32Array(t):new Uint16Array(t)}if(this._facetDepthSortFunction=function(r,e){return e.sqDistance-r.sqDistance},!this._facetDepthSortFrom){var s=this.getScene().activeCamera;this._facetDepthSortFrom=s?s.position:g.Vector3.Zero()}this._depthSortedFacets=[];for(var a=0,l;a<this._facetNb;a++)l={ind:3*a,sqDistance:0},this._depthSortedFacets.push(l);this._invertedMatrix=g.Matrix.Identity(),this._facetDepthSortOrigin=g.Vector3.Zero()}this._bbSize.x=r.maximum.x-r.minimum.x>g.Epsilon?r.maximum.x-r.minimum.x:g.Epsilon,this._bbSize.y=r.maximum.y-r.minimum.y>g.Epsilon?r.maximum.y-r.minimum.y:g.Epsilon,this._bbSize.z=r.maximum.z-r.minimum.z>g.Epsilon?r.maximum.z-r.minimum.z:g.Epsilon;var d=this._bbSize.x>this._bbSize.y?this._bbSize.x:this._bbSize.y;if(d=d>this._bbSize.z?d:this._bbSize.z,this._subDiv.max=this._partitioningSubdivisions,this._subDiv.X=ee(this._subDiv.max*this._bbSize.x/d),this._subDiv.Y=ee(this._subDiv.max*this._bbSize.y/d),this._subDiv.Z=ee(this._subDiv.max*this._bbSize.z/d),this._subDiv.X=1>this._subDiv.X?1:this._subDiv.X,this._subDiv.Y=1>this._subDiv.Y?1:this._subDiv.Y,this._subDiv.Z=1>this._subDiv.Z?1:this._subDiv.Z,this._facetParameters.facetNormals=this.getFacetLocalNormals(),this._facetParameters.facetPositions=this.getFacetLocalPositions(),this._facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),this._facetParameters.bInfo=r,this._facetParameters.bbSize=this._bbSize,this._facetParameters.subDiv=this._subDiv,this._facetParameters.ratio=this.partitioningBBoxRatio,this._facetParameters.depthSort=this._facetDepthSort,this._facetDepthSort&&this._facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(this._invertedMatrix),g.Vector3.TransformCoordinatesToRef(this._facetDepthSortFrom,this._invertedMatrix,this._facetDepthSortOrigin),this._facetParameters.distanceTo=this._facetDepthSortOrigin),this._facetParameters.depthSortedFacets=this._depthSortedFacets,g.VertexData.ComputeNormals(e,t,i,this._facetParameters),this._facetDepthSort&&this._facetDepthSortEnabled){this._depthSortedFacets.sort(this._facetDepthSortFunction);for(var c=0|this._depthSortedIndices.length/3,a=0,p;a<c;a++)p=this._depthSortedFacets[a].ind,this._depthSortedIndices[3*a]=t[p],this._depthSortedIndices[3*a+1]=t[p+1],this._depthSortedIndices[3*a+2]=t[p+2];this.updateIndices(this._depthSortedIndices)}return this},a.prototype.getFacetLocalNormals=function(){return this._facetNormals||this.updateFacetData(),this._facetNormals},a.prototype.getFacetLocalPositions=function(){return this._facetPositions||this.updateFacetData(),this._facetPositions},a.prototype.getFacetLocalPartitioning=function(){return this._facetPartitioning||this.updateFacetData(),this._facetPartitioning},a.prototype.getFacetPosition=function(e){var t=g.Vector3.Zero();return this.getFacetPositionToRef(e,t),t},a.prototype.getFacetPositionToRef=function(e,t){var o=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return g.Vector3.TransformCoordinatesToRef(o,r,t),this},a.prototype.getFacetNormal=function(e){var t=g.Vector3.Zero();return this.getFacetNormalToRef(e,t),t},a.prototype.getFacetNormalToRef=function(e,t){var o=this.getFacetLocalNormals()[e];return g.Vector3.TransformNormalToRef(o,this.getWorldMatrix(),t),this},a.prototype.getFacetsAtLocalCoordinates=function(a,e,t){var i=this.getBoundingInfo(),r=ee((a-i.minimum.x*this._partitioningBBoxRatio)*this._subDiv.X*this._partitioningBBoxRatio/this._bbSize.x),n=ee((e-i.minimum.y*this._partitioningBBoxRatio)*this._subDiv.Y*this._partitioningBBoxRatio/this._bbSize.y),o=ee((t-i.minimum.z*this._partitioningBBoxRatio)*this._subDiv.Z*this._partitioningBBoxRatio/this._bbSize.z);return 0>r||r>this._subDiv.max||0>n||n>this._subDiv.max||0>o||o>this._subDiv.max?null:this._facetPartitioning[r+this._subDiv.max*n+this._subDiv.max*this._subDiv.max*o]},a.prototype.getClosestFacetAtCoordinates=function(e,t,i,r,n,o){void 0===n&&(n=!1),void 0===o&&(o=!0);var s=this.getWorldMatrix(),a=g.Tmp.Matrix[5];s.invertToRef(a);var l=g.Tmp.Vector3[8];g.Vector3.TransformCoordinatesFromFloatsToRef(e,t,i,a,l);var d=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,r,n,o);return r&&g.Vector3.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,s,r),d},a.prototype.getClosestFacetAtLocalCoordinates=function(P,e,t,i,r,A){void 0===r&&(r=!1),void 0===A&&(A=!0);var M=null,s=0,a=0,l=0,h=0,c=0,u=0,f=0,d=0,p=this.getFacetLocalPositions(),_=this.getFacetLocalNormals(),m=this.getFacetsAtLocalCoordinates(P,e,t);if(!m)return null;for(var C=S,x=C,T=0,E,v,y;T<m.length;T++)E=m[T],v=_[E],y=p[E],h=(P-y.x)*v.x+(e-y.y)*v.y+(t-y.z)*v.z,(!r||r&&A&&0<=h||r&&!A&&0>=h)&&(h=v.x*y.x+v.y*y.y+v.z*y.z,c=-(v.x*P+v.y*e+v.z*t-h)/(v.x*v.x+v.y*v.y+v.z*v.z),u=P+v.x*c,f=e+v.y*c,d=t+v.z*c,s=u-P,a=f-e,l=d-t,(x=s*s+a*a+l*l)<C&&(C=x,M=E,i&&(i.x=u,i.y=f,i.z=d)));return M},a.prototype.getFacetDataParameters=function(){return this._facetParameters},a.prototype.disableFacetData=function(){return this._facetDataEnabled&&(this._facetDataEnabled=!1,this._facetPositions=[],this._facetNormals=[],this._facetPartitioning=[],this._facetParameters=null,this._depthSortedIndices=new Uint32Array(0)),this},a.prototype.updateIndices=function(){return this},a.prototype.createNormals=function(e){var t=this.getVerticesData(g.VertexBuffer.PositionKind),r=this.getIndices(),o;return o=this.isVerticesDataPresent(g.VertexBuffer.NormalKind)?this.getVerticesData(g.VertexBuffer.NormalKind):[],g.VertexData.ComputeNormals(t,r,o,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(g.VertexBuffer.NormalKind,o,e),this},a.prototype.alignWithNormal=function(e,t){t||(t=g.Axis.Y);var o=g.Tmp.Vector3[0],r=g.Tmp.Vector3[1];return g.Vector3.CrossToRef(t,e,r),g.Vector3.CrossToRef(e,r,o),this.rotationQuaternion?g.Quaternion.RotationQuaternionFromAxisToRef(o,e,r,this.rotationQuaternion):g.Vector3.RotationFromAxisToRef(o,e,r,this.rotation),this},a.prototype._checkOcclusionQuery=function(){var o=this.getEngine();if(2>o.webGLVersion||this.occlusionType===a.OCCLUSION_TYPE_NONE)return void(this._isOccluded=!1);if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(o.isQueryResultAvailable(this._occlusionQuery)){var e=o.getQueryResult(this._occlusionQuery);this._isOcclusionQueryInProgress=!1,this._occlusionInternalRetryCounter=0,this._isOccluded=1!==e}else{if(this._occlusionInternalRetryCounter++,!(-1!==this.occlusionRetryCount&&this._occlusionInternalRetryCounter>this.occlusionRetryCount))return;this._isOcclusionQueryInProgress=!1,this._occlusionInternalRetryCounter=0,this._isOccluded=this.occlusionType!==a.OCCLUSION_TYPE_OPTIMISTIC&&this._isOccluded}var t=this.getScene(),r=t.getBoundingBoxRenderer();this._occlusionQuery||(this._occlusionQuery=o.createQuery()),o.beginOcclusionQuery(this.occlusionQueryAlgorithmType,this._occlusionQuery),r.renderOcclusionBoundingBox(this),o.endOcclusionQuery(this.occlusionQueryAlgorithmType),this._isOcclusionQueryInProgress=!0},a.OCCLUSION_TYPE_NONE=0,a.OCCLUSION_TYPE_OPTIMISTIC=1,a.OCCLUSION_TYPE_STRICT=2,a.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,a}(g.TransformNode);g.AbstractMesh=e}(e||(e={}));var e;!function(l){var e=function(a){function d(e,t){var r=a.call(this,e,t)||this;return r.diffuse=new l.Color3(1,1,1),r.specular=new l.Color3(1,1,1),r.intensity=1,r.range=S,r._photometricScale=1,r._intensityMode=d.INTENSITYMODE_AUTOMATIC,r._radius=1e-5,r.renderPriority=0,r.shadowEnabled=!0,r._excludeWithLayerMask=0,r._includeOnlyWithLayerMask=0,r._lightmapMode=0,r._excludedMeshesIds=[],r._includedOnlyMeshesIds=[],r.getScene().addLight(r),r._uniformBuffer=new l.UniformBuffer(r.getScene().getEngine()),r._buildUniformLayout(),r.includedOnlyMeshes=[],r.excludedMeshes=[],r._resyncMeshes(),r}return h(d,a),Object.defineProperty(d,'LIGHTMAP_DEFAULT',{get:function(){return d._LIGHTMAP_DEFAULT},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTMAP_SPECULAR',{get:function(){return d._LIGHTMAP_SPECULAR},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTMAP_SHADOWSONLY',{get:function(){return d._LIGHTMAP_SHADOWSONLY},enumerable:!0,configurable:!0}),Object.defineProperty(d,'INTENSITYMODE_AUTOMATIC',{get:function(){return d._INTENSITYMODE_AUTOMATIC},enumerable:!0,configurable:!0}),Object.defineProperty(d,'INTENSITYMODE_LUMINOUSPOWER',{get:function(){return d._INTENSITYMODE_LUMINOUSPOWER},enumerable:!0,configurable:!0}),Object.defineProperty(d,'INTENSITYMODE_LUMINOUSINTENSITY',{get:function(){return d._INTENSITYMODE_LUMINOUSINTENSITY},enumerable:!0,configurable:!0}),Object.defineProperty(d,'INTENSITYMODE_ILLUMINANCE',{get:function(){return d._INTENSITYMODE_ILLUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(d,'INTENSITYMODE_LUMINANCE',{get:function(){return d._INTENSITYMODE_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTTYPEID_POINTLIGHT',{get:function(){return d._LIGHTTYPEID_POINTLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTTYPEID_DIRECTIONALLIGHT',{get:function(){return d._LIGHTTYPEID_DIRECTIONALLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTTYPEID_SPOTLIGHT',{get:function(){return d._LIGHTTYPEID_SPOTLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(d,'LIGHTTYPEID_HEMISPHERICLIGHT',{get:function(){return d._LIGHTTYPEID_HEMISPHERICLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'intensityMode',{get:function(){return this._intensityMode},set:function(t){this._intensityMode=t,this._computePhotometricScale()},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'radius',{get:function(){return this._radius},set:function(t){this._radius=t,this._computePhotometricScale()},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'includedOnlyMeshes',{get:function(){return this._includedOnlyMeshes},set:function(t){this._includedOnlyMeshes=t,this._hookArrayForIncludedOnly(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'excludedMeshes',{get:function(){return this._excludedMeshes},set:function(t){this._excludedMeshes=t,this._hookArrayForExcluded(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'excludeWithLayerMask',{get:function(){return this._excludeWithLayerMask},set:function(t){this._excludeWithLayerMask=t,this._resyncMeshes()},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'includeOnlyWithLayerMask',{get:function(){return this._includeOnlyWithLayerMask},set:function(t){this._includeOnlyWithLayerMask=t,this._resyncMeshes()},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'lightmapMode',{get:function(){return this._lightmapMode},set:function(t){this._lightmapMode!==t&&(this._lightmapMode=t,this._markMeshesAsLightDirty())},enumerable:!0,configurable:!0}),d.prototype.getClassName=function(){return'Light'},d.prototype.toString=function(r){var e='Name: '+this.name;if(e+=', type: '+['Point','Directional','Spot','Hemispheric'][this.getTypeID()],this.animations)for(var t=0;t<this.animations.length;t++)e+=', animation[0]: '+this.animations[t].toString(r);return e},d.prototype.setEnabled=function(t){a.prototype.setEnabled.call(this,t),this._resyncMeshes()},d.prototype.getShadowGenerator=function(){return this._shadowGenerator},d.prototype.getAbsolutePosition=function(){return l.Vector3.Zero()},d.prototype.canAffectMesh=function(t){return!t||!(this.includedOnlyMeshes&&0<this.includedOnlyMeshes.length&&-1===this.includedOnlyMeshes.indexOf(t))&&!(this.excludedMeshes&&0<this.excludedMeshes.length&&-1!==this.excludedMeshes.indexOf(t))&&(0===this.includeOnlyWithLayerMask||0!=(this.includeOnlyWithLayerMask&t.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&t.layerMask)},d.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this._currentRenderId;var e=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=l.Matrix.Identity()),e.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._markSyncedWithParent(),this._parentedWorldMatrix):e},d.CompareLightsPriority=function(r,e){return r.shadowEnabled===e.shadowEnabled?e.renderPriority-r.renderPriority:(e.shadowEnabled?1:0)-(r.shadowEnabled?1:0)},d.prototype.dispose=function(t,e){void 0===e&&(e=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this);for(var o=0,r=this.getScene().meshes;o<r.length;o++)r[o]._removeLightSource(this);this._uniformBuffer.dispose(),this.getScene().removeLight(this),a.prototype.dispose.call(this,t,e)},d.prototype.getTypeID=function(){return 0},d.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},d.prototype.clone=function(e){var t=d.GetConstructorFromName(this.getTypeID(),e,this.getScene());return t?l.SerializationHelper.Clone(t,this):null},d.prototype.serialize=function(){var r=l.SerializationHelper.Serialize(this);return r.type=this.getTypeID(),this.parent&&(r.parentId=this.parent.id),0<this.excludedMeshes.length&&(r.excludedMeshesIds=[],this.excludedMeshes.forEach(function(t){r.excludedMeshesIds.push(t.id)})),0<this.includedOnlyMeshes.length&&(r.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(t){r.includedOnlyMeshesIds.push(t.id)})),l.Animation.AppendSerializedAnimations(this,r),r.ranges=this.serializeAnimationRanges(),r},d.GetConstructorFromName=function(e,t,o){return 0===e?function(){return new l.PointLight(t,l.Vector3.Zero(),o)}:1===e?function(){return new l.DirectionalLight(t,l.Vector3.Zero(),o)}:2===e?function(){return new l.SpotLight(t,l.Vector3.Zero(),l.Vector3.Zero(),0,0,o)}:3===e?function(){return new l.HemisphericLight(t,l.Vector3.Zero(),o)}:null},d.Parse=function(e,t){var r=d.GetConstructorFromName(e.type,e.name,t);if(!r)return null;var i=l.SerializationHelper.Parse(r,e,t);if(e.excludedMeshesIds&&(i._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(i._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId&&(i._waitingParentId=e.parentId),e.animations){for(var o=0,s;o<e.animations.length;o++)s=e.animations[o],i.animations.push(l.Animation.Parse(s));l.Node.ParseAnimationRanges(i,e,t)}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i},d.prototype._hookArrayForExcluded=function(l){var e=this,t=l.push;l.push=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];for(var n=t.apply(l,i),o=0,s=i;o<s.length;o++)s[o]._resyncLighSource(e);return n};var d=l.splice;l.splice=function(t,r){for(var i=d.apply(l,[t,r]),o=0,n=i;o<n.length;o++)n[o]._resyncLighSource(e);return i};for(var r=0,i=l;r<i.length;r++)i[r]._resyncLighSource(this)},d.prototype._hookArrayForIncludedOnly=function(a){var e=this,t=a.push;a.push=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];var n=t.apply(a,i);return e._resyncMeshes(),n};var s=a.splice;a.splice=function(t,r){var i=s.apply(a,[t,r]);return e._resyncMeshes(),i},this._resyncMeshes()},d.prototype._resyncMeshes=function(){for(var r=0,e=this.getScene().meshes;r<e.length;r++)e[r]._resyncLighSource(this)},d.prototype._markMeshesAsLightDirty=function(){for(var r=0,e=this.getScene().meshes,t;r<e.length;r++)t=e[r],-1!==t._lightSources.indexOf(this)&&t._markSubMeshesAsLightDirty()},d.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},d.prototype._getPhotometricScale=function(){var o=0,e=this.getTypeID(),t=this.intensityMode;switch(t===d.INTENSITYMODE_AUTOMATIC&&(t=e===d.LIGHTTYPEID_DIRECTIONALLIGHT?d.INTENSITYMODE_ILLUMINANCE:d.INTENSITYMODE_LUMINOUSINTENSITY),e){case d.LIGHTTYPEID_POINTLIGHT:case d.LIGHTTYPEID_SPOTLIGHT:t===d.INTENSITYMODE_LUMINOUSPOWER?o=1/(4*V):t===d.INTENSITYMODE_LUMINOUSINTENSITY?o=1:t===d.INTENSITYMODE_LUMINANCE?o=this.radius*this.radius:void 0;break;case d.LIGHTTYPEID_DIRECTIONALLIGHT:switch(t){case d.INTENSITYMODE_ILLUMINANCE:o=1;break;case d.INTENSITYMODE_LUMINANCE:var r=this.radius;r=W(r,.001),o=2*V*(1-F(r));}break;case d.LIGHTTYPEID_HEMISPHERICLIGHT:o=1;}return o},d.prototype._reorderLightsInScene=function(){var t=this.getScene();0!=this._renderPriority&&(t.requireLightSorting=!0),this.getScene().sortLightsByPriority()},d._LIGHTMAP_DEFAULT=0,d._LIGHTMAP_SPECULAR=1,d._LIGHTMAP_SHADOWSONLY=2,d._INTENSITYMODE_AUTOMATIC=0,d._INTENSITYMODE_LUMINOUSPOWER=1,d._INTENSITYMODE_LUMINOUSINTENSITY=2,d._INTENSITYMODE_ILLUMINANCE=3,d._INTENSITYMODE_LUMINANCE=4,d._LIGHTTYPEID_POINTLIGHT=0,d._LIGHTTYPEID_DIRECTIONALLIGHT=1,d._LIGHTTYPEID_SPOTLIGHT=2,d._LIGHTTYPEID_HEMISPHERICLIGHT=3,g([l.serializeAsColor3()],d.prototype,'diffuse',void 0),g([l.serializeAsColor3()],d.prototype,'specular',void 0),g([l.serialize()],d.prototype,'intensity',void 0),g([l.serialize()],d.prototype,'range',void 0),g([l.serialize()],d.prototype,'intensityMode',null),g([l.serialize()],d.prototype,'radius',null),g([l.serialize()],d.prototype,'_renderPriority',void 0),g([l.expandToProperty('_reorderLightsInScene')],d.prototype,'renderPriority',void 0),g([l.serialize()],d.prototype,'shadowEnabled',void 0),g([l.serialize('excludeWithLayerMask')],d.prototype,'_excludeWithLayerMask',void 0),g([l.serialize('includeOnlyWithLayerMask')],d.prototype,'_includeOnlyWithLayerMask',void 0),g([l.serialize('lightmapMode')],d.prototype,'_lightmapMode',void 0),d}(l.Node);l.Light=e}(e||(e={}));var e;!function(d){var e=function(l){function p(e,t,r,o){void 0===o&&(o=!0);var i=l.call(this,e,r)||this;return i.upVector=d.Vector3.Up(),i.orthoLeft=null,i.orthoRight=null,i.orthoBottom=null,i.orthoTop=null,i.fov=.8,i.minZ=1,i.maxZ=1e4,i.inertia=.9,i.mode=p.PERSPECTIVE_CAMERA,i.isIntermediate=!1,i.viewport=new d.Viewport(0,0,1,1),i.layerMask=268435455,i.fovMode=p.FOVMODE_VERTICAL_FIXED,i.cameraRigMode=p.RIG_MODE_NONE,i._rigCameras=[],i._webvrViewMatrix=d.Matrix.Identity(),i._skipRendering=!1,i.customRenderTargets=[],i.onViewMatrixChangedObservable=new d.Observable,i.onProjectionMatrixChangedObservable=new d.Observable,i.onAfterCheckInputsObservable=new d.Observable,i.onRestoreStateObservable=new d.Observable,i._computedViewMatrix=d.Matrix.Identity(),i._projectionMatrix=new d.Matrix,i._doNotComputeProjectionMatrix=!1,i._worldMatrix=d.Matrix.Identity(),i._postProcesses=[],i._transformMatrix=d.Matrix.Zero(),i._activeMeshes=new d.SmartArray(256),i._globalPosition=d.Vector3.Zero(),i._refreshFrustumPlanes=!0,i.getScene().addCamera(i),o&&!i.getScene().activeCamera&&(i.getScene().activeCamera=i),i.position=t,i}return h(p,l),Object.defineProperty(p,'PERSPECTIVE_CAMERA',{get:function(){return p._PERSPECTIVE_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(p,'ORTHOGRAPHIC_CAMERA',{get:function(){return p._ORTHOGRAPHIC_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(p,'FOVMODE_VERTICAL_FIXED',{get:function(){return p._FOVMODE_VERTICAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(p,'FOVMODE_HORIZONTAL_FIXED',{get:function(){return p._FOVMODE_HORIZONTAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_NONE',{get:function(){return p._RIG_MODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_STEREOSCOPIC_ANAGLYPH',{get:function(){return p._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL',{get:function(){return p._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED',{get:function(){return p._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_STEREOSCOPIC_OVERUNDER',{get:function(){return p._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_VR',{get:function(){return p._RIG_MODE_VR},enumerable:!0,configurable:!0}),Object.defineProperty(p,'RIG_MODE_WEBVR',{get:function(){return p._RIG_MODE_WEBVR},enumerable:!0,configurable:!0}),p.prototype.storeState=function(){return this._stateStored=!0,this._storedFov=this.fov,this},p.prototype._restoreStateValues=function(){return!!this._stateStored&&(this.fov=this._storedFov,!0)},p.prototype.restoreState=function(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)},p.prototype.getClassName=function(){return'Camera'},p.prototype.toString=function(r){var e='Name: '+this.name;if(e+=', type: '+this.getClassName(),this.animations)for(var t=0;t<this.animations.length;t++)e+=', animation[0]: '+this.animations[t].toString(r);return e},Object.defineProperty(p.prototype,'globalPosition',{get:function(){return this._globalPosition},enumerable:!0,configurable:!0}),p.prototype.getActiveMeshes=function(){return this._activeMeshes},p.prototype.isActiveMesh=function(t){return-1!==this._activeMeshes.indexOf(t)},p.prototype.isReady=function(t){if(void 0===t&&(t=!1),t)for(var e=0,o=this._postProcesses,r;e<o.length;e++)if(r=o[e],r&&!r.isReady())return!1;return l.prototype.isReady.call(this,t)},p.prototype._initCache=function(){l.prototype._initCache.call(this),this._cache.position=new d.Vector3(S,S,S),this._cache.upVector=new d.Vector3(S,S,S),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},p.prototype._updateCache=function(t){t||l.prototype._updateCache.call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)},p.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},p.prototype._isSynchronizedViewMatrix=function(){return!!l.prototype._isSynchronized.call(this)&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()},p.prototype._isSynchronizedProjectionMatrix=function(){var r=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!r)return!1;var o=this.getEngine();return r=this.mode===p.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===o.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===o.getRenderWidth()&&this._cache.renderHeight===o.getRenderHeight()},p.prototype.attachControl=function(){},p.prototype.detachControl=function(){},p.prototype.update=function(){this._checkInputs(),this.cameraRigMode!==p.RIG_MODE_NONE&&this._updateRigCameras()},p.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)},Object.defineProperty(p.prototype,'rigCameras',{get:function(){return this._rigCameras},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'rigPostProcess',{get:function(){return this._rigPostProcess},enumerable:!0,configurable:!0}),p.prototype._getFirstPostProcess=function(){for(var t=0;t<this._postProcesses.length;t++)if(null!==this._postProcesses[t])return this._postProcesses[t];return null},p.prototype._cascadePostProcessesToRigCams=function(){var e=this._getFirstPostProcess();e&&e.markTextureDirty();for(var t=0,i=this._rigCameras.length;t<i;t++){var r=this._rigCameras[t],a=r._rigPostProcess;a?(a instanceof d.PassPostProcess&&(r.isIntermediate=0===this._postProcesses.length),r._postProcesses=this._postProcesses.slice(0).concat(a),a.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}},p.prototype.attachPostProcess=function(e,t){return void 0===t&&(t=null),!e.isReusable()&&-1<this._postProcesses.indexOf(e)?(d.Tools.Error('You\'re trying to reuse a post process not defined as reusable.'),0):(null==t||0>t?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._postProcesses.indexOf(e))},p.prototype.detachPostProcess=function(r){var e=this._postProcesses.indexOf(r);-1!==e&&(this._postProcesses[e]=null),this._cascadePostProcessesToRigCams()},p.prototype.getWorldMatrix=function(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)},p.prototype._getViewMatrix=function(){return d.Matrix.Identity()},p.prototype.getViewMatrix=function(t){return!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this._currentRenderId,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)},p.prototype.freezeProjectionMatrix=function(t){this._doNotComputeProjectionMatrix=!0,void 0!==t&&(this._projectionMatrix=t)},p.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},p.prototype.getProjectionMatrix=function(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var i=this.getEngine(),r=this.getScene();if(this.mode===p.PERSPECTIVE_CAMERA)this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=i.getAspectRatio(this),0>=this.minZ&&(this.minZ=.1),r.useRightHandedSystem?d.Matrix.PerspectiveFovRHToRef(this.fov,i.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===p.FOVMODE_VERTICAL_FIXED):d.Matrix.PerspectiveFovLHToRef(this.fov,i.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===p.FOVMODE_VERTICAL_FIXED);else{var a=i.getRenderWidth()/2,n=i.getRenderHeight()/2;r.useRightHandedSystem?d.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-a,this.orthoRight||a,this.orthoBottom||-n,this.orthoTop||n,this.minZ,this.maxZ,this._projectionMatrix):d.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-a,this.orthoRight||a,this.orthoBottom||-n,this.orthoTop||n,this.minZ,this.maxZ,this._projectionMatrix),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=i.getRenderWidth(),this._cache.renderHeight=i.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix},p.prototype.getTranformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},p.prototype.updateFrustumPlanes=function(){this._refreshFrustumPlanes&&(this.getTranformationMatrix(),this._frustumPlanes?d.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=d.Frustum.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},p.prototype.isInFrustum=function(t){return this.updateFrustumPlanes(),t.isInFrustum(this._frustumPlanes)},p.prototype.isCompletelyInFrustum=function(t){return this.updateFrustumPlanes(),t.isCompletelyInFrustum(this._frustumPlanes)},p.prototype.getForwardRay=function(e,t,i){void 0===e&&(e=100),t||(t=this.getWorldMatrix()),i||(i=this.position);var r=new d.Vector3(0,0,1),a=d.Vector3.TransformNormal(r,t),o=d.Vector3.Normalize(a);return new d.Ray(i,o,e)},p.prototype.dispose=function(t,e){for(void 0===e&&(e=!1),this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);0<this._rigCameras.length;){var r=this._rigCameras.pop();r&&r.dispose()}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses=[];else if(this.cameraRigMode!==p.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses=[];else for(var i=this._postProcesses.length,o;0<=--i;)o=this._postProcesses[i],o&&o.dispose(this);for(var i=this.customRenderTargets.length;0<=--i;)this.customRenderTargets[i].dispose();this.customRenderTargets=[],this._activeMeshes.dispose(),l.prototype.dispose.call(this,t,e)},Object.defineProperty(p.prototype,'leftCamera',{get:function(){return 1>this._rigCameras.length?null:this._rigCameras[0]},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'rightCamera',{get:function(){return 2>this._rigCameras.length?null:this._rigCameras[1]},enumerable:!0,configurable:!0}),p.prototype.getLeftTarget=function(){return 1>this._rigCameras.length?null:this._rigCameras[0].getTarget()},p.prototype.getRightTarget=function(){return 2>this._rigCameras.length?null:this._rigCameras[1].getTarget()},p.prototype.setCameraRigMode=function(e,t){if(this.cameraRigMode!==e){for(;0<this._rigCameras.length;){var r=this._rigCameras.pop();r&&r.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=d.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==p.RIG_MODE_NONE){var i=this.createRigCamera(this.name+'_L',0),o=this.createRigCamera(this.name+'_R',1);i&&o&&(this._rigCameras.push(i),this._rigCameras.push(o))}switch(this.cameraRigMode){case p.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new d.PassPostProcess(this.name+'_passthru',1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new d.AnaglyphPostProcess(this.name+'_anaglyph',1,this._rigCameras);break;case p.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case p.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case p.RIG_MODE_STEREOSCOPIC_OVERUNDER:var n=this.cameraRigMode===p.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===p.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new d.PassPostProcess(this.name+'_passthru',1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new d.StereoscopicInterlacePostProcess(this.name+'_stereoInterlace',this._rigCameras,n);break;case p.RIG_MODE_VR:var a=t.vrCameraMetrics||d.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=a,this._rigCameras[0].viewport=new d.Viewport(0,0,.5,1),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new d.Matrix,this._rigCameras[0]._cameraRigParams.vrHMatrix=a.leftHMatrix,this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=a.leftPreViewMatrix,this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix,this._rigCameras[1]._cameraRigParams.vrMetrics=a,this._rigCameras[1].viewport=new d.Viewport(.5,0,.5,1),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new d.Matrix,this._rigCameras[1]._cameraRigParams.vrHMatrix=a.rightHMatrix,this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=a.rightPreViewMatrix,this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix,a.compensateDistortion&&(this._rigCameras[0]._rigPostProcess=new d.VRDistortionCorrectionPostProcess('VR_Distort_Compensation_Left',this._rigCameras[0],!1,a),this._rigCameras[1]._rigPostProcess=new d.VRDistortionCorrectionPostProcess('VR_Distort_Compensation_Right',this._rigCameras[1],!0,a));break;case p.RIG_MODE_WEBVR:if(t.vrDisplay){var s=t.vrDisplay.getEyeParameters('left'),l=t.vrDisplay.getEyeParameters('right');this._rigCameras[0].viewport=new d.Viewport(0,0,.5,1),this._rigCameras[0].setCameraRigParameter('left',!0),this._rigCameras[0].setCameraRigParameter('specs',t.specs),this._rigCameras[0].setCameraRigParameter('eyeParameters',s),this._rigCameras[0].setCameraRigParameter('frameData',t.frameData),this._rigCameras[0].setCameraRigParameter('parentCamera',t.parentCamera),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new d.Matrix,this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[0].parent=this,this._rigCameras[0]._getViewMatrix=this._getWebVRViewMatrix,this._rigCameras[1].viewport=new d.Viewport(.5,0,.5,1),this._rigCameras[1].setCameraRigParameter('eyeParameters',l),this._rigCameras[1].setCameraRigParameter('specs',t.specs),this._rigCameras[1].setCameraRigParameter('frameData',t.frameData),this._rigCameras[1].setCameraRigParameter('parentCamera',t.parentCamera),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new d.Matrix,this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[1].parent=this,this._rigCameras[1]._getViewMatrix=this._getWebVRViewMatrix,p.UseAlternateWebVRRendering&&(this._rigCameras[1]._skipRendering=!0,this._rigCameras[0]._alternateCamera=this._rigCameras[1])}}this._cascadePostProcessesToRigCams(),this.update()}},p.prototype._getVRProjectionMatrix=function(){return d.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},p.prototype._updateCameraRotationMatrix=function(){},p.prototype._updateWebVRCameraRotationMatrix=function(){},p.prototype._getWebVRProjectionMatrix=function(){return d.Matrix.Identity()},p.prototype._getWebVRViewMatrix=function(){return d.Matrix.Identity()},p.prototype.setCameraRigParameter=function(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,'interaxialDistance'===e&&(this._cameraRigParams.stereoHalfAngle=d.Tools.ToRadians(t/.0637))},p.prototype.createRigCamera=function(){return null},p.prototype._updateRigCameras=function(){for(var t=0;t<this._rigCameras.length;t++)this._rigCameras[t].minZ=this.minZ,this._rigCameras[t].maxZ=this.maxZ,this._rigCameras[t].fov=this.fov;this.cameraRigMode===p.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},p.prototype._setupInputs=function(){},p.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);return e.type=this.getClassName(),this.parent&&(e.parentId=this.parent.id),this.inputs&&this.inputs.serialize(e),d.Animation.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e},p.prototype.clone=function(e){return d.SerializationHelper.Clone(p.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)},p.prototype.getDirection=function(e){var t=d.Vector3.Zero();return this.getDirectionToRef(e,t),t},p.prototype.getDirectionToRef=function(e,t){d.Vector3.TransformNormalToRef(e,this.getWorldMatrix(),t)},p.GetConstructorFromName=function(e,t,i,r,a){switch(void 0===r&&(r=0),void 0===a&&(a=!0),e){case'ArcRotateCamera':return function(){return new d.ArcRotateCamera(t,0,0,1,d.Vector3.Zero(),i)};case'DeviceOrientationCamera':return function(){return new d.DeviceOrientationCamera(t,d.Vector3.Zero(),i)};case'FollowCamera':return function(){return new d.FollowCamera(t,d.Vector3.Zero(),i)};case'ArcFollowCamera':return function(){return new d.ArcFollowCamera(t,0,0,1,null,i)};case'GamepadCamera':return function(){return new d.GamepadCamera(t,d.Vector3.Zero(),i)};case'TouchCamera':return function(){return new d.TouchCamera(t,d.Vector3.Zero(),i)};case'VirtualJoysticksCamera':return function(){return new d.VirtualJoysticksCamera(t,d.Vector3.Zero(),i)};case'WebVRFreeCamera':case'WebVRGamepadCamera':return function(){return new d.WebVRFreeCamera(t,d.Vector3.Zero(),i)};case'VRDeviceOrientationFreeCamera':return function(){return new d.VRDeviceOrientationFreeCamera(t,d.Vector3.Zero(),i)};case'VRDeviceOrientationGamepadCamera':return function(){return new d.VRDeviceOrientationGamepadCamera(t,d.Vector3.Zero(),i)};case'AnaglyphArcRotateCamera':return function(){return new d.AnaglyphArcRotateCamera(t,0,0,1,d.Vector3.Zero(),r,i)};case'AnaglyphFreeCamera':return function(){return new d.AnaglyphFreeCamera(t,d.Vector3.Zero(),r,i)};case'AnaglyphGamepadCamera':return function(){return new d.AnaglyphGamepadCamera(t,d.Vector3.Zero(),r,i)};case'AnaglyphUniversalCamera':return function(){return new d.AnaglyphUniversalCamera(t,d.Vector3.Zero(),r,i)};case'StereoscopicArcRotateCamera':return function(){return new d.StereoscopicArcRotateCamera(t,0,0,1,d.Vector3.Zero(),r,a,i)};case'StereoscopicFreeCamera':return function(){return new d.StereoscopicFreeCamera(t,d.Vector3.Zero(),r,a,i)};case'StereoscopicGamepadCamera':return function(){return new d.StereoscopicGamepadCamera(t,d.Vector3.Zero(),r,a,i)};case'StereoscopicUniversalCamera':return function(){return new d.StereoscopicUniversalCamera(t,d.Vector3.Zero(),r,a,i)};case'FreeCamera':default:return function(){return new d.UniversalCamera(t,d.Vector3.Zero(),i)};}},p.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()},p.Parse=function(e,t){var r=e.type,i=p.GetConstructorFromName(r,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),o=d.SerializationHelper.Parse(i,e,t);if(e.parentId&&(o._waitingParentId=e.parentId),o.inputs&&(o.inputs.parse(e),o._setupInputs()),o.setPosition&&(o.position.copyFromFloats(0,0,0),o.setPosition(d.Vector3.FromArray(e.position))),e.target&&o.setTarget&&o.setTarget(d.Vector3.FromArray(e.target)),e.cameraRigMode){var n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};o.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(var a=0,s;a<e.animations.length;a++)s=e.animations[a],o.animations.push(d.Animation.Parse(s));d.Node.ParseAnimationRanges(o,e,t)}return e.autoAnimate&&t.beginAnimation(o,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),o},p._PERSPECTIVE_CAMERA=0,p._ORTHOGRAPHIC_CAMERA=1,p._FOVMODE_VERTICAL_FIXED=0,p._FOVMODE_HORIZONTAL_FIXED=1,p._RIG_MODE_NONE=0,p._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,p._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,p._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,p._RIG_MODE_STEREOSCOPIC_OVERUNDER=13,p._RIG_MODE_VR=20,p._RIG_MODE_WEBVR=21,p.ForceAttachControlToAlwaysPreventDefault=!1,p.UseAlternateWebVRRendering=!1,g([d.serializeAsVector3()],p.prototype,'position',void 0),g([d.serializeAsVector3()],p.prototype,'upVector',void 0),g([d.serialize()],p.prototype,'orthoLeft',void 0),g([d.serialize()],p.prototype,'orthoRight',void 0),g([d.serialize()],p.prototype,'orthoBottom',void 0),g([d.serialize()],p.prototype,'orthoTop',void 0),g([d.serialize()],p.prototype,'fov',void 0),g([d.serialize()],p.prototype,'minZ',void 0),g([d.serialize()],p.prototype,'maxZ',void 0),g([d.serialize()],p.prototype,'inertia',void 0),g([d.serialize()],p.prototype,'mode',void 0),g([d.serialize()],p.prototype,'layerMask',void 0),g([d.serialize()],p.prototype,'fovMode',void 0),g([d.serialize()],p.prototype,'cameraRigMode',void 0),g([d.serialize()],p.prototype,'interaxialDistance',void 0),g([d.serialize()],p.prototype,'isStereoscopicSideBySide',void 0),p}(d.Node);d.Camera=e}(e||(e={}));var e;!function(d){var e=function(){function p(t){this._renderingGroups=[],this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderinGroupInfo=null,this._scene=t;for(var e=p.MIN_RENDERINGGROUPS;e<p.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}return p.prototype._clearDepthStencilBuffer=function(r,e){void 0===r&&(r=!0),void 0===e&&(e=!0),this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,r,e),this._depthStencilBufferAlreadyCleaned=!0)},p.prototype.render=function(e,t,r,i){var o=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null,n=null;if(o&&(this._renderinGroupInfo||(this._renderinGroupInfo=new d.RenderingGroupInfo),n=this._renderinGroupInfo,n.scene=this._scene,n.camera=this._scene.activeCamera),i)for(var a=0,s;a<this._scene.spriteManagers.length;a++)s=this._scene.spriteManagers[a],this.dispatchSprites(s);for(var a=p.MIN_RENDERINGGROUPS;a<p.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===p.MIN_RENDERINGGROUPS;var l=this._renderingGroups[a];if(l||o){var c=0;if(o&&n&&(c=x(2,a),n.renderStage=d.RenderingGroupInfo.STAGE_PRECLEAR,n.renderingGroupId=a,o.notifyObservers(n,c)),p.AUTOCLEAR){var u=this._autoClearDepthStencil[a];u&&u.autoClear&&this._clearDepthStencilBuffer(u.depth,u.stencil)}o&&n&&(n.renderStage=d.RenderingGroupInfo.STAGE_PREOPAQUE,o.notifyObservers(n,c),n.renderStage=d.RenderingGroupInfo.STAGE_PRETRANSPARENT,o.notifyObservers(n,c)),l&&l.render(e,i,r,t),o&&n&&(n.renderStage=d.RenderingGroupInfo.STAGE_POSTTRANSPARENT,o.notifyObservers(n,c))}}},p.prototype.reset=function(){for(var t=p.MIN_RENDERINGGROUPS,e;t<p.MAX_RENDERINGGROUPS;t++)e=this._renderingGroups[t],e&&e.prepare()},p.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0},p.prototype.freeRenderingGroups=function(){for(var t=p.MIN_RENDERINGGROUPS,e;t<p.MAX_RENDERINGGROUPS;t++)e=this._renderingGroups[t],e&&e.dispose()},p.prototype._prepareRenderingGroup=function(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new d.RenderingGroup(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))},p.prototype.dispatchSprites=function(r){var e=r.renderingGroupId||0;this._prepareRenderingGroup(e),this._renderingGroups[e].dispatchSprites(r)},p.prototype.dispatchParticles=function(r){var e=r.renderingGroupId||0;this._prepareRenderingGroup(e),this._renderingGroups[e].dispatchParticles(r)},p.prototype.dispatch=function(o,e,t){void 0===e&&(e=o.getMesh());var i=e.renderingGroupId||0;this._prepareRenderingGroup(i),this._renderingGroups[i].dispatch(o,e,t)},p.prototype.setRenderingOrder=function(o,e,t,i){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._customOpaqueSortCompareFn[o]=e,this._customAlphaTestSortCompareFn[o]=t,this._customTransparentSortCompareFn[o]=i,this._renderingGroups[o]){var r=this._renderingGroups[o];r.opaqueSortCompareFn=this._customOpaqueSortCompareFn[o],r.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[o],r.transparentSortCompareFn=this._customTransparentSortCompareFn[o]}},p.prototype.setRenderingAutoClearDepthStencil=function(o,e,a,n){void 0===a&&(a=!0),void 0===n&&(n=!0),this._autoClearDepthStencil[o]={autoClear:e,depth:a,stencil:n}},p.MAX_RENDERINGGROUPS=4,p.MIN_RENDERINGGROUPS=0,p.AUTOCLEAR=!0,p}();d.RenderingManager=e}(e||(e={}));var e;!function(l){var e=function(){function r(e,a,i,r,n){void 0===i&&(i=null),void 0===r&&(r=null),void 0===n&&(n=null),this.index=e,this._opaqueSubMeshes=new l.SmartArray(256),this._transparentSubMeshes=new l.SmartArray(256),this._alphaTestSubMeshes=new l.SmartArray(256),this._depthOnlySubMeshes=new l.SmartArray(256),this._particleSystems=new l.SmartArray(256),this._spriteManagers=new l.SmartArray(256),this._edgesRenderers=new l.SmartArray(16),this._scene=a,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=n}return Object.defineProperty(r.prototype,'opaqueSortCompareFn',{set:function(t){this._opaqueSortCompareFn=t,this._renderOpaque=t?this.renderOpaqueSorted:r.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'alphaTestSortCompareFn',{set:function(t){this._alphaTestSortCompareFn=t,this._renderAlphaTest=t?this.renderAlphaTestSorted:r.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'transparentSortCompareFn',{set:function(t){this._transparentSortCompareFn=t||r.defaultTransparentSortCompare,this._renderTransparent=this.renderTransparentSorted},enumerable:!0,configurable:!0}),r.prototype.render=function(e,t,i,r){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);var n=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);var o=n.getStencilBuffer();n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length&&(this._renderTransparent(this._transparentSubMeshes),n.setAlphaMode(l.Engine.ALPHA_DISABLE)),n.setStencilBuffer(!1);for(var s=0;s<this._edgesRenderers.length;s++)this._edgesRenderers.data[s].render();n.setStencilBuffer(o)},r.prototype.renderOpaqueSorted=function(t){return r.renderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},r.prototype.renderAlphaTestSorted=function(t){return r.renderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},r.prototype.renderTransparentSorted=function(t){return r.renderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera,!0)},r.renderSorted=function(e,t,i,r){for(var n=0,s=i?i.globalPosition:l.Vector3.Zero(),a;n<e.length;n++)a=e.data[n],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=a.getBoundingInfo().boundingSphere.centerWorld.subtract(s).length();var o=e.data.slice(0,e.length);for(t&&o.sort(t),n=0;n<o.length;n++){if(a=o[n],r){var d=a.getMaterial();if(d&&d.needDepthPrePass){var p=d.getScene().getEngine();p.setColorWrite(!1),p.setAlphaMode(l.Engine.ALPHA_DISABLE),a.render(!1),p.setColorWrite(!0)}}a.render(r)}},r.renderUnsorted=function(r){for(var e=0;e<r.length;e++)r.data[e].render(!1)},r.defaultTransparentSortCompare=function(t,e){return t._alphaIndex>e._alphaIndex?1:t._alphaIndex<e._alphaIndex?-1:r.backToFrontSortCompare(t,e)},r.backToFrontSortCompare=function(r,e){return r._distanceToCamera<e._distanceToCamera?1:r._distanceToCamera>e._distanceToCamera?-1:0},r.frontToBackSortCompare=function(r,e){return r._distanceToCamera<e._distanceToCamera?-1:r._distanceToCamera>e._distanceToCamera?1:0},r.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset()},r.prototype.dispose=function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},r.prototype.dispatch=function(r,e,t){void 0===e&&(e=r.getMesh()),void 0===t&&(t=r.getMaterial()),null!==t&&void 0!==t&&(t.needAlphaBlendingForMesh(e)?this._transparentSubMeshes.push(r):t.needAlphaTesting()?(t.needDepthPrePass&&this._depthOnlySubMeshes.push(r),this._alphaTestSubMeshes.push(r)):(t.needDepthPrePass&&this._depthOnlySubMeshes.push(r),this._opaqueSubMeshes.push(r)),null!==e._edgesRenderer&&void 0!==e._edgesRenderer&&this._edgesRenderers.push(e._edgesRenderer))},r.prototype.dispatchSprites=function(t){this._spriteManagers.push(t)},r.prototype.dispatchParticles=function(t){this._particleSystems.push(t)},r.prototype._renderParticles=function(o){if(0!==this._particleSystems.length){var e=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var t=0,i;t<this._particleSystems.length;t++)if(i=this._particleSystems.data[t],0!==(e&&e.layerMask&i.layerMask)){var r=i.emitter;r.position&&o&&-1===o.indexOf(r)||this._scene._activeParticles.addCount(i.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},r.prototype._renderSprites=function(){if(this._scene.spritesEnabled&&0!==this._spriteManagers.length){var r=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var e=0,t;e<this._spriteManagers.length;e++)t=this._spriteManagers.data[e],0!==(r&&r.layerMask&t.layerMask)&&t.render();this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},r}();l.RenderingGroup=e}(e||(e={}));var e;!function(T){var p=function(){function t(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(t.prototype,'singleClick',{get:function(){return this._singleClick},set:function(t){this._singleClick=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'doubleClick',{get:function(){return this._doubleClick},set:function(t){this._doubleClick=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'hasSwiped',{get:function(){return this._hasSwiped},set:function(t){this._hasSwiped=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'ignore',{get:function(){return this._ignore},set:function(t){this._ignore=t},enumerable:!0,configurable:!0}),t}(),e=function(){function t(){}return t.STAGE_PRECLEAR=1,t.STAGE_PREOPAQUE=2,t.STAGE_PRETRANSPARENT=3,t.STAGE_POSTTRANSPARENT=4,t}();T.RenderingGroupInfo=e;var t=function(){function c(e){this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new T.Color4(.2,.2,.3,1),this.ambientColor=new T.Color3(0,0,0),this._forceWireframe=!1,this._forcePointsCloud=!1,this.forceShowBoundingBoxes=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor='pointer',this.defaultCursor='',this.preventDefaultOnPointerDown=!0,this.metadata=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new T.Observable,this._onDisposeObserver=null,this.onBeforeRenderObservable=new T.Observable,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new T.Observable,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new T.Observable,this.onAfterAnimationsObservable=new T.Observable,this.onBeforeDrawPhaseObservable=new T.Observable,this.onAfterDrawPhaseObservable=new T.Observable,this.onBeforePhysicsObservable=new T.Observable,this.onAfterPhysicsObservable=new T.Observable,this.onReadyObservable=new T.Observable,this.onBeforeCameraRenderObservable=new T.Observable,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new T.Observable,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new T.Observable,this.onAfterActiveMeshesEvaluationObservable=new T.Observable,this.onBeforeParticlesRenderingObservable=new T.Observable,this.onAfterParticlesRenderingObservable=new T.Observable,this.onBeforeSpritesRenderingObservable=new T.Observable,this.onAfterSpritesRenderingObservable=new T.Observable,this.onDataLoadedObservable=new T.Observable,this.onNewCameraAddedObservable=new T.Observable,this.onCameraRemovedObservable=new T.Observable,this.onNewLightAddedObservable=new T.Observable,this.onLightRemovedObservable=new T.Observable,this.onNewGeometryAddedObservable=new T.Observable,this.onGeometryRemovedObservable=new T.Observable,this.onNewTransformNodeAddedObservable=new T.Observable,this.onTransformNodeRemovedObservable=new T.Observable,this.onNewMeshAddedObservable=new T.Observable,this.onMeshRemovedObservable=new T.Observable,this.onBeforeRenderTargetsRenderObservable=new T.Observable,this.onAfterRenderTargetsRenderObservable=new T.Observable,this.onBeforeStepObservable=new T.Observable,this.onAfterStepObservable=new T.Observable,this.onRenderingGroupObservable=new T.Observable,this.animations=[],this._registeredForLateAnimationBindings=new T.SmartArrayNoDuplicate(256),this.onPrePointerObservable=new T.Observable,this.onPointerObservable=new T.Observable,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this.cameraToUseForPointers=null,this._startingPointerPosition=new T.Vector2(0,0),this._previousStartingPointerPosition=new T.Vector2(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this.onPreKeyboardObservable=new T.Observable,this.onKeyboardObservable=new T.Observable,this._useRightHandedSystem=!1,this._fogEnabled=!0,this._fogMode=c.FOGMODE_NONE,this.fogColor=new T.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this._shadowsEnabled=!0,this._lightsEnabled=!0,this.lights=[],this.cameras=[],this.activeCameras=[],this.transformNodes=[],this.meshes=[],this.animationGroups=[],this._geometries=[],this.materials=[],this.multiMaterials=[],this._texturesEnabled=!0,this.textures=[],this.particlesEnabled=!0,this.particleSystems=[],this.spritesEnabled=!0,this.spriteManagers=[],this.layers=[],this.effectLayers=[],this._skeletonsEnabled=!0,this.skeletons=[],this.morphTargetManagers=[],this.lensFlaresEnabled=!0,this.lensFlareSystems=[],this.collisionsEnabled=!0,this.gravity=new T.Vector3(0,-9.807,0),this.postProcessesEnabled=!0,this.postProcesses=[],this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this.reflectionProbes=[],this._actionManagers=[],this._meshesForIntersections=new T.SmartArrayNoDuplicate(256),this.proceduralTexturesEnabled=!0,this.proceduralTextures=[],this.soundTracks=[],this._audioEnabled=!0,this._headphone=!1,this._totalVertices=new T.PerfCounter,this._activeIndices=new T.PerfCounter,this._activeParticles=new T.PerfCounter,this._activeBones=new T.PerfCounter,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._intermediateRendering=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._alternateViewUpdateFlag=-1,this._alternateProjectionUpdateFlag=-1,this._toBeDisposed=new T.SmartArray(256),this._activeRequests=[],this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new T.SmartArray(256),this._processedMaterials=new T.SmartArray(256),this._renderTargets=new T.SmartArrayNoDuplicate(256),this._activeParticleSystems=new T.SmartArray(256),this._activeSkeletons=new T.SmartArrayNoDuplicate(32),this._softwareSkinnedMeshes=new T.SmartArrayNoDuplicate(32),this._activeAnimatables=[],this._transformMatrix=T.Matrix.Zero(),this._useAlternateCameraConfiguration=!1,this._alternateRendering=!1,this.requireLightSorting=!1,this._depthRenderer={},this._activeMeshesFrozen=!1,this._tempPickingRay=T.Ray?T.Ray.Zero():null,this._engine=e||T.Engine.LastCreatedEngine,this._engine.scenes.push(this),this._uid=null,this._renderingManager=new T.RenderingManager(this),this.postProcessManager=new T.PostProcessManager(this),T.OutlineRenderer&&(this._outlineRenderer=new T.OutlineRenderer(this)),T.Tools.IsWindowObjectExist()&&this.attachControl(),T.SimplificationQueue&&(this.simplificationQueue=new T.SimplificationQueue),this.workerCollisions=!1,this._createUbo(),this._imageProcessingConfiguration=new T.ImageProcessingConfiguration}return Object.defineProperty(c,'FOGMODE_NONE',{get:function(){return c._FOGMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(c,'FOGMODE_EXP',{get:function(){return c._FOGMODE_EXP},enumerable:!0,configurable:!0}),Object.defineProperty(c,'FOGMODE_EXP2',{get:function(){return c._FOGMODE_EXP2},enumerable:!0,configurable:!0}),Object.defineProperty(c,'FOGMODE_LINEAR',{get:function(){return c._FOGMODE_LINEAR},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'environmentTexture',{get:function(){return this._environmentTexture},set:function(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(T.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'imageProcessingConfiguration',{get:function(){return this._imageProcessingConfiguration},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'forceWireframe',{get:function(){return this._forceWireframe},set:function(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(T.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'forcePointsCloud',{get:function(){return this._forcePointsCloud},set:function(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(T.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'animationPropertiesOverride',{get:function(){return this._animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'beforeRender',{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'afterRender',{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'beforeCameraRender',{set:function(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'afterCameraRender',{set:function(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'gamepadManager',{get:function(){return this._gamepadManager||(this._gamepadManager=new T.GamepadManager(this)),this._gamepadManager},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'unTranslatedPointer',{get:function(){return new T.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'useRightHandedSystem',{get:function(){return this._useRightHandedSystem},set:function(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(T.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),c.prototype.setStepId=function(t){this._currentStepId=t},c.prototype.getStepId=function(){return this._currentStepId},c.prototype.getInternalStep=function(){return this._currentInternalStep},Object.defineProperty(c.prototype,'fogEnabled',{get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(T.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'fogMode',{get:function(){return this._fogMode},set:function(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(T.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'shadowsEnabled',{get:function(){return this._shadowsEnabled},set:function(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(T.Material.LightDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'lightsEnabled',{get:function(){return this._lightsEnabled},set:function(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(T.Material.LightDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'defaultMaterial',{get:function(){return this._defaultMaterial||(this._defaultMaterial=new T.StandardMaterial('default material',this)),this._defaultMaterial},set:function(t){this._defaultMaterial=t},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'texturesEnabled',{get:function(){return this._texturesEnabled},set:function(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(T.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'skeletonsEnabled',{get:function(){return this._skeletonsEnabled},set:function(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(T.Material.AttributesDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'postProcessRenderPipelineManager',{get:function(){return this._postProcessRenderPipelineManager||(this._postProcessRenderPipelineManager=new T.PostProcessRenderPipelineManager),this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'mainSoundTrack',{get:function(){return this._mainSoundTrack||(this._mainSoundTrack=new T.SoundTrack(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'_isAlternateRenderingEnabled',{get:function(){return this._alternateRendering},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'frustumPlanes',{get:function(){return this._frustumPlanes},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'geometryBufferRenderer',{get:function(){return this._geometryBufferRenderer},set:function(t){t&&t.isSupported&&(this._geometryBufferRenderer=t)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'debugLayer',{get:function(){return this._debugLayer||(this._debugLayer=new T.DebugLayer(this)),this._debugLayer},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'workerCollisions',{get:function(){return this._workerCollisions},set:function(e){T.CollisionCoordinatorLegacy&&(e=e&&!!Worker&&!!T.CollisionWorker,this._workerCollisions=e,this.collisionCoordinator&&this.collisionCoordinator.destroy(),this.collisionCoordinator=e?new T.CollisionCoordinatorWorker:new T.CollisionCoordinatorLegacy,this.collisionCoordinator.init(this))},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'selectionOctree',{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'meshUnderPointer',{get:function(){return this._pointerOverMesh},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'pointerX',{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'pointerY',{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),c.prototype.getCachedMaterial=function(){return this._cachedMaterial},c.prototype.getCachedEffect=function(){return this._cachedEffect},c.prototype.getCachedVisibility=function(){return this._cachedVisibility},c.prototype.isCachedMaterialInvalid=function(r,e,t){return void 0===t&&(t=1),this._cachedEffect!==e||this._cachedMaterial!==r||this._cachedVisibility!==t},c.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new T.BoundingBoxRenderer(this)),this._boundingBoxRenderer},c.prototype.getOutlineRenderer=function(){return this._outlineRenderer},c.prototype.getEngine=function(){return this._engine},c.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(c.prototype,'totalVerticesPerfCounter',{get:function(){return this._totalVertices},enumerable:!0,configurable:!0}),c.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(c.prototype,'totalActiveIndicesPerfCounter',{get:function(){return this._activeIndices},enumerable:!0,configurable:!0}),c.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(c.prototype,'activeParticlesPerfCounter',{get:function(){return this._activeParticles},enumerable:!0,configurable:!0}),c.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(c.prototype,'activeBonesPerfCounter',{get:function(){return this._activeBones},enumerable:!0,configurable:!0}),c.prototype.getInterFramePerfCounter=function(){return T.Tools.Warn('getInterFramePerfCounter is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'interFramePerfCounter',{get:function(){return T.Tools.Warn('interFramePerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getLastFrameDuration=function(){return T.Tools.Warn('getLastFrameDuration is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'lastFramePerfCounter',{get:function(){return T.Tools.Warn('lastFramePerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getEvaluateActiveMeshesDuration=function(){return T.Tools.Warn('getEvaluateActiveMeshesDuration is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'evaluateActiveMeshesDurationPerfCounter',{get:function(){return T.Tools.Warn('evaluateActiveMeshesDurationPerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getActiveMeshes=function(){return this._activeMeshes},c.prototype.getRenderTargetsDuration=function(){return T.Tools.Warn('getRenderTargetsDuration is deprecated. Please use SceneInstrumentation class'),0},c.prototype.getRenderDuration=function(){return T.Tools.Warn('getRenderDuration is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'renderDurationPerfCounter',{get:function(){return T.Tools.Warn('renderDurationPerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getParticlesDuration=function(){return T.Tools.Warn('getParticlesDuration is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'particlesDurationPerfCounter',{get:function(){return T.Tools.Warn('particlesDurationPerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getSpritesDuration=function(){return T.Tools.Warn('getSpritesDuration is deprecated. Please use SceneInstrumentation class'),0},Object.defineProperty(c.prototype,'spriteDuractionPerfCounter',{get:function(){return T.Tools.Warn('spriteDuractionPerfCounter is deprecated. Please use SceneInstrumentation class'),null},enumerable:!0,configurable:!0}),c.prototype.getAnimationRatio=function(){return this._animationRatio},c.prototype.getRenderId=function(){return this._renderId},c.prototype.incrementRenderId=function(){this._renderId++},c.prototype._updatePointerPosition=function(r){var e=this._engine.getRenderingCanvasClientRect();e&&(this._pointerX=r.clientX-e.left,this._pointerY=r.clientY-e.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},c.prototype._createUbo=function(){this._sceneUbo=new T.UniformBuffer(this._engine,void 0,!0),this._sceneUbo.addUniform('viewProjection',16),this._sceneUbo.addUniform('view',16)},c.prototype._createAlternateUbo=function(){this._alternateSceneUbo=new T.UniformBuffer(this._engine,void 0,!0),this._alternateSceneUbo.addUniform('viewProjection',16),this._alternateSceneUbo.addUniform('view',16)},c.prototype.simulatePointerMove=function(r,e){var t=new PointerEvent('pointermove',e);return this._processPointerMove(r,t)},c.prototype._processPointerMove=function(e,t){var i=this._engine.getRenderingCanvas();if(!i)return this;if(e&&e.hit&&e.pickedMesh?(this.setPointerOverSprite(null),this.setPointerOverMesh(e.pickedMesh),i.style.cursor=this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.hasPointerTriggers?this._pointerOverMesh.actionManager.hoverCursor?this._pointerOverMesh.actionManager.hoverCursor:this.hoverCursor:this.defaultCursor):(this.setPointerOverMesh(null),e=this.pickSprite(this._unTranslatedPointerX,this._unTranslatedPointerY,this._spritePredicate,!1,this.cameraToUseForPointers||void 0),e&&e.hit&&e.pickedSprite?(this.setPointerOverSprite(e.pickedSprite),i.style.cursor=this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.hoverCursor?this._pointerOverSprite.actionManager.hoverCursor:this.hoverCursor):(this.setPointerOverSprite(null),i.style.cursor=this.defaultCursor)),e){var a='mousewheel'===t.type||'DOMMouseScroll'===t.type?T.PointerEventTypes.POINTERWHEEL:T.PointerEventTypes.POINTERMOVE;if(this.onPointerMove&&this.onPointerMove(t,e,a),this.onPointerObservable.hasObservers()){var n=new T.PointerInfo(a,t,e);this.onPointerObservable.notifyObservers(n,a)}}return this},c.prototype.simulatePointerDown=function(r,e){var t=new PointerEvent('pointerdown',e);return this._processPointerDown(r,t)},c.prototype._processPointerDown=function(e,i){var r=this;if(e&&e.hit&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;var n=e.pickedMesh.actionManager;if(n){if(n.hasPickTriggers)switch(n.processTrigger(T.ActionManager.OnPickDownTrigger,T.ActionEvent.CreateNew(e.pickedMesh,i)),i.button){case 0:n.processTrigger(T.ActionManager.OnLeftPickTrigger,T.ActionEvent.CreateNew(e.pickedMesh,i));break;case 1:n.processTrigger(T.ActionManager.OnCenterPickTrigger,T.ActionEvent.CreateNew(e.pickedMesh,i));break;case 2:n.processTrigger(T.ActionManager.OnRightPickTrigger,T.ActionEvent.CreateNew(e.pickedMesh,i));}n.hasSpecificTrigger(T.ActionManager.OnLongPressTrigger)&&window.setTimeout(function(){var e=r.pick(r._unTranslatedPointerX,r._unTranslatedPointerY,function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(T.ActionManager.OnLongPressTrigger)&&e==r._pickedDownMesh},!1,r.cameraToUseForPointers);e&&e.hit&&e.pickedMesh&&n&&0!==r._totalPointersPressed&&Date.now()-r._startingPointerTime>c.LongPressDelay&&A(r._startingPointerPosition.x-r._pointerX)<c.DragMovementThreshold&&A(r._startingPointerPosition.y-r._pointerY)<c.DragMovementThreshold&&(r._startingPointerTime=0,n.processTrigger(T.ActionManager.OnLongPressTrigger,T.ActionEvent.CreateNew(e.pickedMesh,i)))},c.LongPressDelay)}}if(e){var t=T.PointerEventTypes.POINTERDOWN;if(this.onPointerDown&&this.onPointerDown(i,e,t),this.onPointerObservable.hasObservers()){var o=new T.PointerInfo(t,i,e);this.onPointerObservable.notifyObservers(o,t)}}return this},c.prototype.simulatePointerUp=function(t,e){var o=new PointerEvent('pointerup',e),r=new p;return r.singleClick=!0,r.ignore=!0,this._processPointerUp(t,o,r)},c.prototype._processPointerUp=function(e,t,i){if(e&&e&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(this.onPointerPick&&this.onPointerPick(t,e),i.singleClick&&!i.ignore&&this.onPointerObservable.hasObservers())){var r=T.PointerEventTypes.POINTERPICK,n=new T.PointerInfo(r,t,e);this.onPointerObservable.notifyObservers(n,r)}e.pickedMesh.actionManager&&(i.ignore&&e.pickedMesh.actionManager.processTrigger(T.ActionManager.OnPickUpTrigger,T.ActionEvent.CreateNew(e.pickedMesh,t)),i.hasSwiped||i.ignore||!i.singleClick||e.pickedMesh.actionManager.processTrigger(T.ActionManager.OnPickTrigger,T.ActionEvent.CreateNew(e.pickedMesh,t)),i.doubleClick&&!i.ignore&&e.pickedMesh.actionManager.hasSpecificTrigger(T.ActionManager.OnDoublePickTrigger)&&e.pickedMesh.actionManager.processTrigger(T.ActionManager.OnDoublePickTrigger,T.ActionEvent.CreateNew(e.pickedMesh,t)))}this._pickedDownMesh&&this._pickedDownMesh.actionManager&&this._pickedDownMesh.actionManager.hasSpecificTrigger(T.ActionManager.OnPickOutTrigger)&&this._pickedDownMesh!==this._pickedUpMesh&&this._pickedDownMesh.actionManager.processTrigger(T.ActionManager.OnPickOutTrigger,T.ActionEvent.CreateNew(this._pickedDownMesh,t));var o=T.PointerEventTypes.POINTERUP;if(this.onPointerObservable.hasObservers())if(i.ignore){var n=new T.PointerInfo(o,t,e);this.onPointerObservable.notifyObservers(n,o)}else if(!i.hasSwiped){if(i.singleClick&&this.onPointerObservable.hasSpecificMask(T.PointerEventTypes.POINTERTAP)){var s=T.PointerEventTypes.POINTERTAP,n=new T.PointerInfo(s,t,e);this.onPointerObservable.notifyObservers(n,s)}if(i.doubleClick&&this.onPointerObservable.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP)){var a=T.PointerEventTypes.POINTERDOUBLETAP,n=new T.PointerInfo(a,t,e);this.onPointerObservable.notifyObservers(n,a)}}return this.onPointerUp&&this.onPointerUp(t,e,o),this},c.prototype.attachControl=function(e,t,r){var _=this;void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===r&&(r=!0),this._initActionManager=function(t){if(!_._meshPickProceed){var e=_.pick(_._unTranslatedPointerX,_._unTranslatedPointerY,_.pointerDownPredicate,!1,_.cameraToUseForPointers);_._currentPickResult=e,e&&(t=e.hit&&e.pickedMesh?e.pickedMesh.actionManager:null),_._meshPickProceed=!0}return t},this._delayedSimpleClick=function(o,e,t){(Date.now()-_._previousStartingPointerTime>c.DoubleClickDelay&&!_._doubleClickOccured||o!==_._previousButtonPressed)&&(_._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1,t(e,_._currentPickResult))},this._initClickEvent=function(e,t,r,o){var i=new p;_._currentPickResult=null;var a=null,n=e.hasSpecificMask(T.PointerEventTypes.POINTERPICK)||t.hasSpecificMask(T.PointerEventTypes.POINTERPICK)||e.hasSpecificMask(T.PointerEventTypes.POINTERTAP)||t.hasSpecificMask(T.PointerEventTypes.POINTERTAP)||e.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP)||t.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP);if(!n&&T.ActionManager&&T.ActionManager.HasPickTriggers&&(a=_._initActionManager(a,i))&&(n=a.hasPickTriggers),n){var s=r.button;if(i.hasSwiped=A(_._startingPointerPosition.x-_._pointerX)>c.DragMovementThreshold||A(_._startingPointerPosition.y-_._pointerY)>c.DragMovementThreshold,!i.hasSwiped){var l=!c.ExclusiveDoubleClickMode;l||(l=!e.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP)&&!t.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP))&&!T.ActionManager.HasSpecificTrigger(T.ActionManager.OnDoublePickTrigger)&&(a=_._initActionManager(a,i))&&(l=!a.hasSpecificTrigger(T.ActionManager.OnDoublePickTrigger)),l?(Date.now()-_._previousStartingPointerTime>c.DoubleClickDelay||s!==_._previousButtonPressed)&&(i.singleClick=!0,o(i,_._currentPickResult)):(_._previousDelayedSimpleClickTimeout=_._delayedSimpleClickTimeout,_._delayedSimpleClickTimeout=window.setTimeout(_._delayedSimpleClick.bind(_,s,i,o),c.DoubleClickDelay));var u=e.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP)||t.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP);!u&&T.ActionManager.HasSpecificTrigger(T.ActionManager.OnDoublePickTrigger)&&(a=_._initActionManager(a,i))&&(u=a.hasSpecificTrigger(T.ActionManager.OnDoublePickTrigger)),u&&(s===_._previousButtonPressed&&Date.now()-_._previousStartingPointerTime<c.DoubleClickDelay&&!_._doubleClickOccured?!i.hasSwiped&&A(_._previousStartingPointerPosition.x-_._startingPointerPosition.x)<c.DragMovementThreshold&&A(_._previousStartingPointerPosition.y-_._startingPointerPosition.y)<c.DragMovementThreshold?(_._previousStartingPointerTime=0,_._doubleClickOccured=!0,i.doubleClick=!0,i.ignore=!1,c.ExclusiveDoubleClickMode&&_._previousDelayedSimpleClickTimeout&&clearTimeout(_._previousDelayedSimpleClickTimeout),_._previousDelayedSimpleClickTimeout=_._delayedSimpleClickTimeout,o(i,_._currentPickResult)):(_._doubleClickOccured=!1,_._previousStartingPointerTime=_._startingPointerTime,_._previousStartingPointerPosition.x=_._startingPointerPosition.x,_._previousStartingPointerPosition.y=_._startingPointerPosition.y,_._previousButtonPressed=s,c.ExclusiveDoubleClickMode?(_._previousDelayedSimpleClickTimeout&&clearTimeout(_._previousDelayedSimpleClickTimeout),_._previousDelayedSimpleClickTimeout=_._delayedSimpleClickTimeout,o(i,_._previousPickResult)):o(i,_._currentPickResult)):(_._doubleClickOccured=!1,_._previousStartingPointerTime=_._startingPointerTime,_._previousStartingPointerPosition.x=_._startingPointerPosition.x,_._previousStartingPointerPosition.y=_._startingPointerPosition.y,_._previousButtonPressed=s))}}i.ignore=!0,o(i,_._currentPickResult)},this._spritePredicate=function(t){return t.isPickable&&t.actionManager&&t.actionManager.hasPointerTriggers},this._onPointerMove=function(e){if(_._updatePointerPosition(e),_.onPrePointerObservable.hasObservers()&&!_._pointerCaptures[e.pointerId]){var t='mousewheel'===e.type||'DOMMouseScroll'===e.type?T.PointerEventTypes.POINTERWHEEL:T.PointerEventTypes.POINTERMOVE,o=new T.PointerInfoPre(t,e,_._unTranslatedPointerX,_._unTranslatedPointerY);if(_.onPrePointerObservable.notifyObservers(o,t),o.skipOnPointerObservable)return}if(_.cameraToUseForPointers||_.activeCamera){_.pointerMovePredicate||(_.pointerMovePredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()&&(t.enablePointerMoveEvents||_.constantlyUpdateMeshUnderPointer||null!==t.actionManager&&void 0!==t.actionManager)});var r=_.pick(_._unTranslatedPointerX,_._unTranslatedPointerY,_.pointerMovePredicate,!1,_.cameraToUseForPointers);_._processPointerMove(r,e)}},this._onPointerDown=function(e){if(_._totalPointersPressed++,_._pickedDownMesh=null,_._meshPickProceed=!1,_._updatePointerPosition(e),_.preventDefaultOnPointerDown&&a&&(e.preventDefault(),a.focus()),_.onPrePointerObservable.hasObservers()){var t=T.PointerEventTypes.POINTERDOWN,o=new T.PointerInfoPre(t,e,_._unTranslatedPointerX,_._unTranslatedPointerY);if(_.onPrePointerObservable.notifyObservers(o,t),o.skipOnPointerObservable)return}if(_.cameraToUseForPointers||_.activeCamera){_._pointerCaptures[e.pointerId]=!0,_._startingPointerPosition.x=_._pointerX,_._startingPointerPosition.y=_._pointerY,_._startingPointerTime=Date.now(),_.pointerDownPredicate||(_.pointerDownPredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()}),_._pickedDownMesh=null;var r=_.pick(_._unTranslatedPointerX,_._unTranslatedPointerY,_.pointerDownPredicate,!1,_.cameraToUseForPointers);if(_._processPointerDown(r,e),_._pickedDownSprite=null,0<_.spriteManagers.length&&(r=_.pickSprite(_._unTranslatedPointerX,_._unTranslatedPointerY,_._spritePredicate,!1,_.cameraToUseForPointers||void 0))&&r.hit&&r.pickedSprite&&r.pickedSprite.actionManager){switch(_._pickedDownSprite=r.pickedSprite,e.button){case 0:r.pickedSprite.actionManager.processTrigger(T.ActionManager.OnLeftPickTrigger,T.ActionEvent.CreateNewFromSprite(r.pickedSprite,_,e));break;case 1:r.pickedSprite.actionManager.processTrigger(T.ActionManager.OnCenterPickTrigger,T.ActionEvent.CreateNewFromSprite(r.pickedSprite,_,e));break;case 2:r.pickedSprite.actionManager.processTrigger(T.ActionManager.OnRightPickTrigger,T.ActionEvent.CreateNewFromSprite(r.pickedSprite,_,e));}r.pickedSprite.actionManager&&r.pickedSprite.actionManager.processTrigger(T.ActionManager.OnPickDownTrigger,T.ActionEvent.CreateNewFromSprite(r.pickedSprite,_,e))}}},this._onPointerUp=function(e){0!==_._totalPointersPressed&&(_._totalPointersPressed--,_._pickedUpMesh=null,_._meshPickProceed=!1,_._updatePointerPosition(e),_._initClickEvent(_.onPrePointerObservable,_.onPointerObservable,e,function(t,r){if(_.onPrePointerObservable.hasObservers()&&!_._pointerCaptures[e.pointerId])if(t.ignore){var i=T.PointerEventTypes.POINTERUP,o=new T.PointerInfoPre(i,e,_._unTranslatedPointerX,_._unTranslatedPointerY);if(_.onPrePointerObservable.notifyObservers(o,i),o.skipOnPointerObservable)return}else if(!t.hasSwiped){if(t.singleClick&&_.onPrePointerObservable.hasSpecificMask(T.PointerEventTypes.POINTERTAP)){var i=T.PointerEventTypes.POINTERTAP,o=new T.PointerInfoPre(i,e,_._unTranslatedPointerX,_._unTranslatedPointerY);if(_.onPrePointerObservable.notifyObservers(o,i),o.skipOnPointerObservable)return}if(t.doubleClick&&_.onPrePointerObservable.hasSpecificMask(T.PointerEventTypes.POINTERDOUBLETAP)){var i=T.PointerEventTypes.POINTERDOUBLETAP,o=new T.PointerInfoPre(i,e,_._unTranslatedPointerX,_._unTranslatedPointerY);if(_.onPrePointerObservable.notifyObservers(o,i),o.skipOnPointerObservable)return}}if(_.cameraToUseForPointers||_.activeCamera){if(_._pointerCaptures[e.pointerId]=!1,_.pointerUpPredicate||(_.pointerUpPredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.isEnabled()}),!_._meshPickProceed&&(T.ActionManager&&T.ActionManager.HasTriggers||_.onPointerObservable.hasObservers())&&_._initActionManager(null,t),r||(r=_._currentPickResult),_._processPointerUp(r,e,t),!t.ignore&&0<_.spriteManagers.length){var a=_.pickSprite(_._unTranslatedPointerX,_._unTranslatedPointerY,_._spritePredicate,!1,_.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(T.ActionManager.OnPickUpTrigger,T.ActionEvent.CreateNewFromSprite(a.pickedSprite,_,e)),a.pickedSprite.actionManager&&A(_._startingPointerPosition.x-_._pointerX)<c.DragMovementThreshold&&A(_._startingPointerPosition.y-_._pointerY)<c.DragMovementThreshold&&a.pickedSprite.actionManager.processTrigger(T.ActionManager.OnPickTrigger,T.ActionEvent.CreateNewFromSprite(a.pickedSprite,_,e))),_._pickedDownSprite&&_._pickedDownSprite.actionManager&&_._pickedDownSprite!==a.pickedSprite&&_._pickedDownSprite.actionManager.processTrigger(T.ActionManager.OnPickOutTrigger,T.ActionEvent.CreateNewFromSprite(_._pickedDownSprite,_,e)))}_._previousPickResult=_._currentPickResult}}))},this._onKeyDown=function(e){var t=T.KeyboardEventTypes.KEYDOWN;if(_.onPreKeyboardObservable.hasObservers()){var o=new T.KeyboardInfoPre(t,e);if(_.onPreKeyboardObservable.notifyObservers(o,t),o.skipOnPointerObservable)return}if(_.onKeyboardObservable.hasObservers()){var o=new T.KeyboardInfo(t,e);_.onKeyboardObservable.notifyObservers(o,t)}_.actionManager&&_.actionManager.processTrigger(T.ActionManager.OnKeyDownTrigger,T.ActionEvent.CreateNewFromScene(_,e))},this._onKeyUp=function(e){var t=T.KeyboardEventTypes.KEYUP;if(_.onPreKeyboardObservable.hasObservers()){var o=new T.KeyboardInfoPre(t,e);if(_.onPreKeyboardObservable.notifyObservers(o,t),o.skipOnPointerObservable)return}if(_.onKeyboardObservable.hasObservers()){var o=new T.KeyboardInfo(t,e);_.onKeyboardObservable.notifyObservers(o,t)}_.actionManager&&_.actionManager.processTrigger(T.ActionManager.OnKeyUpTrigger,T.ActionEvent.CreateNewFromScene(_,e))};var o=this.getEngine();this._onCanvasFocusObserver=o.onCanvasFocusObservable.add(function(){a&&(a.addEventListener('keydown',_._onKeyDown,!1),a.addEventListener('keyup',_._onKeyUp,!1))}),this._onCanvasBlurObserver=o.onCanvasBlurObservable.add(function(){a&&(a.removeEventListener('keydown',_._onKeyDown),a.removeEventListener('keyup',_._onKeyUp))});var i=T.Tools.GetPointerPrefix(),a=this._engine.getRenderingCanvas();a&&(r&&(a.addEventListener(i+'move',this._onPointerMove,!1),a.addEventListener('mousewheel',this._onPointerMove,!1),a.addEventListener('DOMMouseScroll',this._onPointerMove,!1)),t&&a.addEventListener(i+'down',this._onPointerDown,!1),e&&window.addEventListener(i+'up',this._onPointerUp,!1),a.tabIndex=1)},c.prototype.detachControl=function(){var e=this.getEngine(),t=T.Tools.GetPointerPrefix(),o=e.getRenderingCanvas();o&&(o.removeEventListener(t+'move',this._onPointerMove),o.removeEventListener(t+'down',this._onPointerDown),window.removeEventListener(t+'up',this._onPointerUp),this._onCanvasBlurObserver&&e.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onCanvasFocusObserver&&e.onCanvasFocusObservable.remove(this._onCanvasFocusObserver),o.removeEventListener('mousewheel',this._onPointerMove),o.removeEventListener('DOMMouseScroll',this._onPointerMove),o.removeEventListener('keydown',this._onKeyDown),o.removeEventListener('keyup',this._onKeyUp),this.onKeyboardObservable.clear(),this.onPreKeyboardObservable.clear(),this.onPointerObservable.clear(),this.onPrePointerObservable.clear())},c.prototype.isReady=function(){if(this._isDisposed)return!1;if(0<this._pendingData.length)return!1;var e=this.getEngine(),i;for(i=0;i<this._geometries.length;i++)if(this._geometries[i].delayLoadState===T.Engine.DELAYLOADSTATE_LOADING)return!1;for(i=0;i<this.meshes.length;i++){var t=this.meshes[i];if(t.isEnabled()&&t.subMeshes&&0!==t.subMeshes.length){if(!t.isReady(!0))return!1;for(var r='InstancedMesh'===t.getClassName()||e.getCaps().instancedArrays&&0<t.instances.length,n=0,o=this.effectLayers,s;n<o.length;n++)if(s=o[n],s.hasMesh(t))for(var a=0,l=t.subMeshes,m;a<l.length;a++)if(m=l[a],!s.isReady(m,r))return!1}}if(this.activeCameras&&0<this.activeCameras.length){for(var c=0,u=this.activeCameras,f;c<u.length;c++)if(f=u[c],!f.isReady(!0))return!1;}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(var d=0,p=this.particleSystems;d<p.length;d++)if(!p[d].isReady())return!1;return!0},c.prototype.resetCachedMaterial=function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null},c.prototype.registerBeforeRender=function(t){this.onBeforeRenderObservable.add(t)},c.prototype.unregisterBeforeRender=function(t){this.onBeforeRenderObservable.removeCallback(t)},c.prototype.registerAfterRender=function(t){this.onAfterRenderObservable.add(t)},c.prototype.unregisterAfterRender=function(t){this.onAfterRenderObservable.removeCallback(t)},c.prototype._executeOnceBeforeRender=function(r){var e=this,t=function(){r(),setTimeout(function(){e.unregisterBeforeRender(t)})};this.registerBeforeRender(t)},c.prototype.executeOnceBeforeRender=function(r,e){var t=this;void 0===e?this._executeOnceBeforeRender(r):setTimeout(function(){t._executeOnceBeforeRender(r)},e)},c.prototype._addPendingData=function(t){this._pendingData.push(t)},c.prototype._removePendingData=function(r){var e=this.isLoading,t=this._pendingData.indexOf(r);-1!==t&&this._pendingData.splice(t,1),e&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)},c.prototype.getWaitingItemsCount=function(){return this._pendingData.length},Object.defineProperty(c.prototype,'isLoading',{get:function(){return 0<this._pendingData.length},enumerable:!0,configurable:!0}),c.prototype.executeWhenReady=function(r){var e=this;this.onReadyObservable.add(r),-1===this._executeWhenReadyTimeoutId&&(this._executeWhenReadyTimeoutId=setTimeout(function(){e._checkIsReady()},150))},c.prototype.whenReadyAsync=function(){var r=this;return new Promise(function(e){r.executeWhenReady(function(){e()})})},c.prototype._checkIsReady=function(){var t=this;return this.isReady()?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=-1)):void(this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()},150))},c.prototype.beginWeightedAnimation=function(d,e,t,i,r,n,o,s){void 0===i&&(i=1),void 0===n&&(n=1);var a=this.beginAnimation(d,e,t,r,n,o,s,!1);return a.weight=i,a},c.prototype.beginAnimation=function(e,t,i,r,n,o,s,a){if(void 0===n&&(n=1),void 0===a&&(a=!0),t>i&&0<n&&(n*=-1),a&&this.stopAnimation(e),s||(s=new T.Animatable(this,e,t,i,r,n,o)),e.animations&&s.appendAnimations(e,e.animations),e.getAnimatables)for(var l=e.getAnimatables(),d=0;d<l.length;d++)this.beginAnimation(l[d],t,i,r,n,o,s,a);return s.reset(),s},c.prototype.beginDirectAnimation=function(e,t,i,r,n,o,s){return void 0===o&&(o=1),new T.Animatable(this,e,i,r,n,o,s,t)},c.prototype.beginDirectHierarchyAnimation=function(d,e,t,i,r,n,o,s){for(var a=d.getDescendants(e),l=[],p=0,c=a,u;p<c.length;p++)u=c[p],l.push(this.beginDirectAnimation(u,t,i,r,n,o,s));return l},c.prototype.getAnimatableByTarget=function(r){for(var e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===r)return this._activeAnimatables[e];return null},c.prototype.getAllAnimatablesByTarget=function(r){for(var e=[],t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===r&&e.push(this._activeAnimatables[t]);return e},Object.defineProperty(c.prototype,'animatables',{get:function(){return this._activeAnimatables},enumerable:!0,configurable:!0}),c.prototype.stopAnimation=function(o,e){for(var t=this.getAllAnimatablesByTarget(o),i=0,r=t;i<r.length;i++)r[i].stop(e)},c.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].stop();this._activeAnimatables=[]}for(var e=0,t=this.animationGroups;e<t.length;e++)t[e].stop()},c.prototype._animate=function(){if(this.animationsEnabled&&0!==this._activeAnimatables.length){var e=T.Tools.Now;if(!this._animationTimeLast){if(0<this._pendingData.length)return;this._animationTimeLast=e}var t=this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale;this._animationTime+=t,this._animationTimeLast=e;for(var o=0;o<this._activeAnimatables.length;o++)this._activeAnimatables[o]._animate(this._animationTime);this._processLateAnimationBindings()}},c.prototype._registerTargetForLateAnimationBinding=function(r,e){var o=r.target;this._registeredForLateAnimationBindings.pushNoDuplicate(o),o._lateAnimationHolders||(o._lateAnimationHolders={}),o._lateAnimationHolders[r.targetPath]||(o._lateAnimationHolders[r.targetPath]={totalWeight:0,animations:[],originalValue:e}),o._lateAnimationHolders[r.targetPath].animations.push(r),o._lateAnimationHolders[r.targetPath].totalWeight+=r.weight},c.prototype._processLateAnimationBindingsForMatrices=function(e){var t=1,i=T.Tmp.Vector3[0],r=T.Tmp.Vector3[1],n=T.Tmp.Quaternion[0],o=0,s=e.animations[0],a=e.originalValue,l=1;if(1>e.totalWeight)a.decompose(r,n,i),l=1-e.totalWeight;else if(o=1,t=e.totalWeight,s.currentValue.decompose(r,n,i),1==(l=s.weight/t))return s.currentValue;r.scaleInPlace(l),i.scaleInPlace(l),n.scaleInPlace(l);for(var _=o;_<e.animations.length;_++){var c=e.animations[_],l=c.weight/t,u=T.Tmp.Vector3[2],f=T.Tmp.Vector3[3],d=T.Tmp.Quaternion[1];c.currentValue.decompose(f,d,u),f.scaleAndAddToRef(l,r),d.scaleAndAddToRef(l,n),u.scaleAndAddToRef(l,i)}return T.Matrix.ComposeToRef(r,n,i,s._workValue),s._workValue},c.prototype._processLateAnimationBindingsForQuaternions=function(e){var t=e.animations[0],i=e.originalValue;if(1===e.animations.length)return T.Quaternion.Slerp(i,t.currentValue,C(1,e.totalWeight));var r=1,s,n;if(1>e.totalWeight){var o=1-e.totalWeight;s=[],n=[],s.push(i),n.push(o)}else{if(2===e.animations.length)return T.Quaternion.Slerp(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight);s=[],n=[],r=e.totalWeight}for(var a=0,l;a<e.animations.length;a++)l=e.animations[a],s.push(l.currentValue),n.push(l.weight/r);for(var d=0,c=null,p=0;p<s.length;)c?(d+=n[p],T.Quaternion.SlerpToRef(c,s[p],n[p]/d,c),p++):(c=T.Quaternion.Slerp(s[p],s[p+1],n[p+1]/(n[p]+n[p+1])),d=n[p]+n[p+1],p+=2);return c},c.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(var e=0,t;e<this._registeredForLateAnimationBindings.length;e++){for(var i in t=this._registeredForLateAnimationBindings.data[e],t._lateAnimationHolders){var r=t._lateAnimationHolders[i],n=r.animations[0],o=r.originalValue,s=T.Animation.AllowMatrixDecomposeForInterpolation&&o.m,a=void 0;if(s)a=this._processLateAnimationBindingsForMatrices(r);else if(void 0!==o.w)a=this._processLateAnimationBindingsForQuaternions(r);else{var l=0,_=1;if(1>r.totalWeight)a=o.scale?o.scale(1-r.totalWeight):o*(1-r.totalWeight);else{_=r.totalWeight;var c=n.weight/_;a=1==c?n.currentValue:n.currentValue.scale?n.currentValue.scale(c):n.currentValue*c,l=1}for(var u=l;u<r.animations.length;u++){var f=r.animations[u],d=f.weight/_;f.currentValue.scaleAndAddToRef?f.currentValue.scaleAndAddToRef(d,a):a+=f.currentValue*d}}t[i]=a}t._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},c.prototype._switchToAlternateCameraConfiguration=function(t){this._useAlternateCameraConfiguration=t},c.prototype.getViewMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateViewMatrix:this._viewMatrix},c.prototype.getProjectionMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateProjectionMatrix:this._projectionMatrix},c.prototype.getTransformMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateTransformMatrix:this._transformMatrix},c.prototype.setTransformMatrix=function(e,t){if(this._viewUpdateFlag!==e.updateFlag||this._projectionUpdateFlag!==t.updateFlag){if(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?T.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=T.Frustum.GetPlanes(this._transformMatrix),this.activeCamera&&this.activeCamera._alternateCamera){var o=this.activeCamera._alternateCamera;o.getViewMatrix().multiplyToRef(o.getProjectionMatrix(),T.Tmp.Matrix[0]),T.Frustum.GetRightPlaneToRef(T.Tmp.Matrix[0],this._frustumPlanes[3])}this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix('viewProjection',this._transformMatrix),this._sceneUbo.updateMatrix('view',this._viewMatrix),this._sceneUbo.update())}},c.prototype._setAlternateTransformMatrix=function(e,t){this._alternateViewUpdateFlag===e.updateFlag&&this._alternateProjectionUpdateFlag===t.updateFlag||(this._alternateViewUpdateFlag=e.updateFlag,this._alternateProjectionUpdateFlag=t.updateFlag,this._alternateViewMatrix=e,this._alternateProjectionMatrix=t,this._alternateTransformMatrix||(this._alternateTransformMatrix=T.Matrix.Zero()),this._alternateViewMatrix.multiplyToRef(this._alternateProjectionMatrix,this._alternateTransformMatrix),this._alternateSceneUbo||this._createAlternateUbo(),this._alternateSceneUbo.useUbo&&(this._alternateSceneUbo.updateMatrix('viewProjection',this._alternateTransformMatrix),this._alternateSceneUbo.updateMatrix('view',this._alternateViewMatrix),this._alternateSceneUbo.update()))},c.prototype.getSceneUniformBuffer=function(){return this._useAlternateCameraConfiguration?this._alternateSceneUbo:this._sceneUbo},c.prototype.getUniqueId=function(){var t=c._uniqueIdCounter;return c._uniqueIdCounter++,t},c.prototype.addMesh=function(t){this.meshes.push(t),this.collisionCoordinator&&this.collisionCoordinator.onMeshAdded(t),t._resyncLightSources(),this.onNewMeshAddedObservable.notifyObservers(t)},c.prototype.removeMesh=function(o,e){var t=this;void 0===e&&(e=!1);var i=this.meshes.indexOf(o);return-1!==i&&this.meshes.splice(i,1),this.onMeshRemovedObservable.notifyObservers(o),e&&o.getChildMeshes().forEach(function(r){t.removeMesh(r)}),i},c.prototype.addTransformNode=function(t){this.transformNodes.push(t),this.onNewTransformNodeAddedObservable.notifyObservers(t)},c.prototype.removeTransformNode=function(r){var e=this.transformNodes.indexOf(r);return-1!==e&&this.transformNodes.splice(e,1),this.onTransformNodeRemovedObservable.notifyObservers(r),e},c.prototype.removeSkeleton=function(r){var e=this.skeletons.indexOf(r);return-1!==e&&this.skeletons.splice(e,1),e},c.prototype.removeMorphTargetManager=function(r){var e=this.morphTargetManagers.indexOf(r);return-1!==e&&this.morphTargetManagers.splice(e,1),e},c.prototype.removeLight=function(o){var e=this.lights.indexOf(o);if(-1!==e){for(var t=0,i=this.meshes;t<i.length;t++)i[t]._removeLightSource(o);this.lights.splice(e,1),this.sortLightsByPriority()}return this.onLightRemovedObservable.notifyObservers(o),e},c.prototype.removeCamera=function(r){var e=this.cameras.indexOf(r);-1!==e&&this.cameras.splice(e,1);var t=this.activeCameras.indexOf(r);return-1!==t&&this.activeCameras.splice(t,1),this.activeCamera===r&&(0<this.cameras.length?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(r),e},c.prototype.removeParticleSystem=function(r){var e=this.particleSystems.indexOf(r);return-1!==e&&this.particleSystems.splice(e,1),e},c.prototype.removeAnimation=function(r){var e=this.animations.indexOf(r);return-1!==e&&this.animations.splice(e,1),e},c.prototype.removeAnimationGroup=function(r){var e=this.animationGroups.indexOf(r);return-1!==e&&this.animationGroups.splice(e,1),e},c.prototype.removeMultiMaterial=function(r){var e=this.multiMaterials.indexOf(r);return-1!==e&&this.multiMaterials.splice(e,1),e},c.prototype.removeMaterial=function(r){var e=this.materials.indexOf(r);return-1!==e&&this.materials.splice(e,1),e},c.prototype.removeLensFlareSystem=function(r){var e=this.lensFlareSystems.indexOf(r);return-1!==e&&this.lensFlareSystems.splice(e,1),e},c.prototype.removeActionManager=function(r){var e=this._actionManagers.indexOf(r);return-1!==e&&this._actionManagers.splice(e,1),e},c.prototype.removeEffectLayer=function(r){var e=this.effectLayers.indexOf(r);return-1!==e&&this.effectLayers.splice(e,1),e},c.prototype.removeTexture=function(r){var e=this.textures.indexOf(r);return-1!==e&&this.textures.splice(e,1),e},c.prototype.addLight=function(o){this.lights.push(o),this.sortLightsByPriority();for(var e=0,t=this.meshes,i;e<t.length;e++)i=t[e],-1===i._lightSources.indexOf(o)&&(i._lightSources.push(o),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(o)},c.prototype.sortLightsByPriority=function(){this.requireLightSorting&&this.lights.sort(T.Light.CompareLightsPriority)},c.prototype.addCamera=function(t){this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t)},c.prototype.addSkeleton=function(t){this.skeletons.push(t)},c.prototype.addParticleSystem=function(t){this.particleSystems.push(t)},c.prototype.addAnimation=function(t){this.animations.push(t)},c.prototype.addAnimationGroup=function(t){this.animationGroups.push(t)},c.prototype.addMultiMaterial=function(t){this.multiMaterials.push(t)},c.prototype.addMaterial=function(t){this.materials.push(t)},c.prototype.addMorphTargetManager=function(t){this.morphTargetManagers.push(t)},c.prototype.addGeometry=function(t){this._geometries.push(t)},c.prototype.addLensFlareSystem=function(t){this.lensFlareSystems.push(t)},c.prototype.addEffectLayer=function(t){this.effectLayers.push(t)},c.prototype.addActionManager=function(t){this._actionManagers.push(t)},c.prototype.addTexture=function(t){this.textures.push(t)},c.prototype.switchActiveCamera=function(r,e){void 0===e&&(e=!0);var t=this._engine.getRenderingCanvas();t&&(this.activeCamera&&this.activeCamera.detachControl(t),this.activeCamera=r,e&&r.attachControl(t))},c.prototype.setActiveCameraByID=function(r){var e=this.getCameraByID(r);return e?(this.activeCamera=e,e):null},c.prototype.setActiveCameraByName=function(r){var e=this.getCameraByName(r);return e?(this.activeCamera=e,e):null},c.prototype.getAnimationGroupByName=function(r){for(var e=0;e<this.animationGroups.length;e++)if(this.animationGroups[e].name===r)return this.animationGroups[e];return null},c.prototype.getMaterialByID=function(r){for(var e=0;e<this.materials.length;e++)if(this.materials[e].id===r)return this.materials[e];return null},c.prototype.getMaterialByName=function(r){for(var e=0;e<this.materials.length;e++)if(this.materials[e].name===r)return this.materials[e];return null},c.prototype.getLensFlareSystemByName=function(r){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===r)return this.lensFlareSystems[e];return null},c.prototype.getLensFlareSystemByID=function(r){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===r)return this.lensFlareSystems[e];return null},c.prototype.getCameraByID=function(r){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].id===r)return this.cameras[e];return null},c.prototype.getCameraByUniqueID=function(r){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].uniqueId===r)return this.cameras[e];return null},c.prototype.getCameraByName=function(r){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].name===r)return this.cameras[e];return null},c.prototype.getBoneByID=function(o){for(var e=0;e<this.skeletons.length;e++)for(var t=this.skeletons[e],i=0;i<t.bones.length;i++)if(t.bones[i].id===o)return t.bones[i];return null},c.prototype.getBoneByName=function(o){for(var e=0;e<this.skeletons.length;e++)for(var t=this.skeletons[e],i=0;i<t.bones.length;i++)if(t.bones[i].name===o)return t.bones[i];return null},c.prototype.getLightByName=function(r){for(var e=0;e<this.lights.length;e++)if(this.lights[e].name===r)return this.lights[e];return null},c.prototype.getLightByID=function(r){for(var e=0;e<this.lights.length;e++)if(this.lights[e].id===r)return this.lights[e];return null},c.prototype.getLightByUniqueID=function(r){for(var e=0;e<this.lights.length;e++)if(this.lights[e].uniqueId===r)return this.lights[e];return null},c.prototype.getParticleSystemByID=function(r){for(var e=0;e<this.particleSystems.length;e++)if(this.particleSystems[e].id===r)return this.particleSystems[e];return null},c.prototype.getGeometryByID=function(r){for(var e=0;e<this._geometries.length;e++)if(this._geometries[e].id===r)return this._geometries[e];return null},c.prototype.pushGeometry=function(r,e){return(e||!this.getGeometryByID(r.id))&&(this._geometries.push(r),this.collisionCoordinator&&this.collisionCoordinator.onGeometryAdded(r),this.onNewGeometryAddedObservable.notifyObservers(r),!0)},c.prototype.removeGeometry=function(r){var e=this._geometries.indexOf(r);return-1<e&&(this._geometries.splice(e,1),this.collisionCoordinator&&this.collisionCoordinator.onGeometryDeleted(r),this.onGeometryRemovedObservable.notifyObservers(r),!0)},c.prototype.getGeometries=function(){return this._geometries},c.prototype.getMeshByID=function(r){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].id===r)return this.meshes[e];return null},c.prototype.getMeshesByID=function(r){return this.meshes.filter(function(e){return e.id===r})},c.prototype.getTransformNodeByID=function(r){for(var e=0;e<this.transformNodes.length;e++)if(this.transformNodes[e].id===r)return this.transformNodes[e];return null},c.prototype.getTransformNodesByID=function(r){return this.transformNodes.filter(function(e){return e.id===r})},c.prototype.getMeshByUniqueID=function(r){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].uniqueId===r)return this.meshes[e];return null},c.prototype.getLastMeshByID=function(r){for(var e=this.meshes.length-1;0<=e;e--)if(this.meshes[e].id===r)return this.meshes[e];return null},c.prototype.getLastEntryByID=function(r){var e;for(e=this.meshes.length-1;0<=e;e--)if(this.meshes[e].id===r)return this.meshes[e];for(e=this.transformNodes.length-1;0<=e;e--)if(this.transformNodes[e].id===r)return this.transformNodes[e];for(e=this.cameras.length-1;0<=e;e--)if(this.cameras[e].id===r)return this.cameras[e];for(e=this.lights.length-1;0<=e;e--)if(this.lights[e].id===r)return this.lights[e];return null},c.prototype.getNodeByID=function(o){var e=this.getMeshByID(o);if(e)return e;var t=this.getLightByID(o);if(t)return t;var i=this.getCameraByID(o);return i||this.getBoneByID(o)},c.prototype.getNodeByName=function(o){var e=this.getMeshByName(o);if(e)return e;var t=this.getLightByName(o);if(t)return t;var i=this.getCameraByName(o);return i||this.getBoneByName(o)},c.prototype.getMeshByName=function(r){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].name===r)return this.meshes[e];return null},c.prototype.getTransformNodeByName=function(r){for(var e=0;e<this.transformNodes.length;e++)if(this.transformNodes[e].name===r)return this.transformNodes[e];return null},c.prototype.getSoundByName=function(e){var t;if(T.AudioEngine){for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];for(var o=0;o<this.soundTracks.length;o++)for(t=0;t<this.soundTracks[o].soundCollection.length;t++)if(this.soundTracks[o].soundCollection[t].name===e)return this.soundTracks[o].soundCollection[t]}return null},c.prototype.getLastSkeletonByID=function(r){for(var e=this.skeletons.length-1;0<=e;e--)if(this.skeletons[e].id===r)return this.skeletons[e];return null},c.prototype.getSkeletonById=function(r){for(var e=0;e<this.skeletons.length;e++)if(this.skeletons[e].id===r)return this.skeletons[e];return null},c.prototype.getSkeletonByName=function(r){for(var e=0;e<this.skeletons.length;e++)if(this.skeletons[e].name===r)return this.skeletons[e];return null},c.prototype.getMorphTargetManagerById=function(r){for(var e=0;e<this.morphTargetManagers.length;e++)if(this.morphTargetManagers[e].uniqueId===r)return this.morphTargetManagers[e];return null},c.prototype.isActiveMesh=function(t){return-1!==this._activeMeshes.indexOf(t)},c.prototype.getHighlightLayerByName=function(e){for(var t=0;t<this.effectLayers.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===T.HighlightLayer.EffectName)return this.effectLayers[t];return null},c.prototype.getGlowLayerByName=function(e){for(var t=0;t<this.effectLayers.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===T.GlowLayer.EffectName)return this.effectLayers[t];return null},Object.defineProperty(c.prototype,'uid',{get:function(){return this._uid||(this._uid=T.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),c.prototype.addExternalData=function(e,t){return this._externalData||(this._externalData=new T.StringDictionary),this._externalData.add(e,t)},c.prototype.getExternalData=function(t){return this._externalData?this._externalData.get(t):null},c.prototype.getOrAddExternalDataWithFactory=function(e,t){return this._externalData||(this._externalData=new T.StringDictionary),this._externalData.getOrAddWithFactory(e,t)},c.prototype.removeExternalData=function(t){return this._externalData.remove(t)},c.prototype._evaluateSubMesh=function(o,e){if(this.dispatchAllSubMeshesOfActiveMeshes||e.alwaysSelectAsActiveMesh||1===e.subMeshes.length||o.isInFrustum(this._frustumPlanes)){if(e.showSubMeshesBoundingBox){var t=o.getBoundingInfo();null!==t&&void 0!==t&&this.getBoundingBoxRenderer().renderList.push(t.boundingBox)}var i=o.getMaterial();null!==i&&void 0!==i&&(void 0!==i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._renderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._activeIndices.addCount(o.indexCount,!1),this._renderingManager.dispatch(o,e,i))}},c.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()},c.prototype.freeActiveMeshes=function(){if(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras)for(var r=0,e;r<this.activeCameras.length;r++)e=this.activeCameras[r],e&&e._activeMeshes&&e._activeMeshes.dispose()},c.prototype.freeRenderingGroups=function(){if(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures)for(var r=0,e;r<this.textures.length;r++)e=this.textures[r],e&&e.renderList&&e.freeRenderingGroups()},c.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},c.prototype.setActiveMeshCandidateProvider=function(t){this._activeMeshCandidateProvider=t},c.prototype.getActiveMeshCandidateProvider=function(){return this._activeMeshCandidateProvider},c.prototype.freezeActiveMeshes=function(){return this.activeCamera?(this._frustumPlanes||this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this):this},c.prototype.unfreezeActiveMeshes=function(){return this._activeMeshesFrozen=!1,this},c.prototype._evaluateActiveMeshes=function(){if((!this._activeMeshesFrozen||!this._activeMeshes.length)&&this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._boundingBoxRenderer&&this._boundingBoxRenderer.reset();var e=!0,r,t;if(void 0!==this._activeMeshCandidateProvider)r=this._activeMeshCandidateProvider.getMeshes(this),e=!1===this._activeMeshCandidateProvider.checksIsEnabled,t=void 0===r?0:r.length;else if(void 0!==this._selectionOctree){var i=this._selectionOctree.select(this._frustumPlanes);r=i.data,t=i.length}else t=this.meshes.length,r=this.meshes;for(var n=0,a,o;n<t;n++)a=r[n],a.isBlocked||(this._totalVertices.addCount(a.getTotalVertices(),!1),!a.isReady()||e&&!a.isEnabled()||(a.computeWorldMatrix(),a.actionManager&&a.actionManager.hasSpecificTriggers([T.ActionManager.OnIntersectionEnterTrigger,T.ActionManager.OnIntersectionExitTrigger])&&this._meshesForIntersections.pushNoDuplicate(a),void 0!==(o=a.getLOD(this.activeCamera))&&null!==o&&(a._preActivate(),(a.alwaysSelectAsActiveMesh||a.isVisible&&0<a.visibility&&0!=(a.layerMask&this.activeCamera.layerMask)&&a.isInFrustum(this._frustumPlanes))&&(this._activeMeshes.push(a),this.activeCamera._activeMeshes.push(a),a._activate(this._renderId),o!==a&&o._activate(this._renderId),this._activeMesh(a,o)))));if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var s=0,l;s<this.particleSystems.length;s++)if(l=this.particleSystems[s],l.isStarted()&&l.emitter){var d=l.emitter;d.position&&!d.isEnabled()||(this._activeParticleSystems.push(l),l.animate(),this._renderingManager.dispatchParticles(l))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}},c.prototype._activeMesh=function(l,e){if(this.skeletonsEnabled&&null!==e.skeleton&&void 0!==e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&e.skeleton.prepare(),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)),l.showBoundingBox||this.forceShowBoundingBoxes){var t=l.getBoundingInfo();this.getBoundingBoxRenderer().renderList.push(t.boundingBox)}if(void 0!==e&&null!==e&&void 0!==e.subMeshes&&null!==e.subMeshes&&0<e.subMeshes.length){var i,r;if(e.useOctreeForRenderingSelection&&void 0!==e._submeshesOctree&&null!==e._submeshesOctree){var n=e._submeshesOctree.select(this._frustumPlanes);i=n.length,r=n.data}else r=e.subMeshes,i=r.length;for(var o=0,a;o<i;o++)a=r[o],this._evaluateSubMesh(a,e)}},c.prototype.updateTransformMatrix=function(t){this.activeCamera&&this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))},c.prototype.updateAlternateTransformMatrix=function(t){this._setAlternateTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix())},c.prototype._renderForCamera=function(e,y){if(!e||!e._skipRendering){var i=this._engine;if(this.activeCamera=e,!this.activeCamera)throw new Error('Active camera not set');T.Tools.StartPerformanceCounter('Rendering camera '+this.activeCamera.name),i.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,this.updateTransformMatrix(),e._alternateCamera&&(this.updateAlternateTransformMatrix(e._alternateCamera),this._alternateRendering=!0),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var r=0,n;r<this._softwareSkinnedMeshes.length;r++)n=this._softwareSkinnedMeshes.data[r],n.applySkeleton(n.skeleton);this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var o=!1;if(e.customRenderTargets&&0<e.customRenderTargets.length&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),y&&y.customRenderTargets&&0<y.customRenderTargets.length&&this._renderTargets.concatWithNoDuplicate(y.customRenderTargets),this.renderTargetsEnabled&&0<this._renderTargets.length){this._intermediateRendering=!0,T.Tools.StartPerformanceCounter('Render targets',0<this._renderTargets.length);for(var s=0,a;s<this._renderTargets.length;s++)if(a=this._renderTargets.data[s],a._shouldRender()){this._renderId++;var l=a.activeCamera&&a.activeCamera!==this.activeCamera;a.render(l,this.dumpNextRenderTargets)}T.Tools.EndPerformanceCounter('Render targets',0<this._renderTargets.length),this._intermediateRendering=!1,this._renderId++,o=!0}var h=this._engine.getStencilBuffer(),c=!1,u=!1;if(this.renderTargetsEnabled&&this.effectLayers&&0<this.effectLayers.length){this._intermediateRendering=!0;for(var f=0,d;f<this.effectLayers.length;f++)if(d=this.effectLayers[f],d.shouldRender()&&(!d.camera||d.camera.cameraRigMode===T.Camera.RIG_MODE_NONE&&e===d.camera||d.camera.cameraRigMode!==T.Camera.RIG_MODE_NONE&&-1<d.camera._rigCameras.indexOf(e))){c=!0,u=u||d.needStencil();var a=d._mainTexture;a._shouldRender()&&(this._renderId++,a.render(!1,!1),o=!0)}this._intermediateRendering=!1,this._renderId++}o&&i.restoreDefaultFramebuffer(),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager._prepareFrame();var p,_;if(this.layers.length){for(i.setDepthBuffer(!1),p=0;p<this.layers.length;p++)_=this.layers[p],_.isBackground&&0!=(_.layerMask&this.activeCamera.layerMask)&&_.render();i.setDepthBuffer(!0)}if(u&&this._engine.setStencilBuffer(!0),this.onBeforeDrawPhaseObservable.notifyObservers(this),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this),u&&this._engine.setStencilBuffer(h),this._boundingBoxRenderer&&this._boundingBoxRenderer.render(),this.lensFlaresEnabled){T.Tools.StartPerformanceCounter('Lens flares',0<this.lensFlareSystems.length);for(var m=0,g;m<this.lensFlareSystems.length;m++)g=this.lensFlareSystems[m],0!=(e.layerMask&g.layerMask)&&g.render();T.Tools.EndPerformanceCounter('Lens flares',0<this.lensFlareSystems.length)}if(c){i.setDepthBuffer(!1);for(var f=0;f<this.effectLayers.length;f++)this.effectLayers[f].shouldRender()&&this.effectLayers[f].render();i.setDepthBuffer(!0)}if(this.layers.length){for(i.setDepthBuffer(!1),p=0;p<this.layers.length;p++)_=this.layers[p],_.isBackground||0==(_.layerMask&this.activeCamera.layerMask)||_.render();i.setDepthBuffer(!0)}this.postProcessManager._finalizeFrame(e.isIntermediate),this._renderTargets.reset(),this._alternateRendering=!1,this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera),T.Tools.EndPerformanceCounter('Rendering camera '+this.activeCamera.name)}},c.prototype._processSubCameras=function(e){if(e.cameraRigMode===T.Camera.RIG_MODE_NONE)return void this._renderForCamera(e);for(var t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e);this.activeCamera=e,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix())},c.prototype._checkIntersections=function(){for(var e=0,t;e<this._meshesForIntersections.length;e++)if(t=this._meshesForIntersections.data[e],t.actionManager)for(var i=0,r;i<t.actionManager.actions.length;i++)if(r=t.actionManager.actions[i],r.trigger===T.ActionManager.OnIntersectionEnterTrigger||r.trigger===T.ActionManager.OnIntersectionExitTrigger){var n=r.getTriggerParameter(),o=n instanceof T.AbstractMesh?n:n.mesh,s=o.intersectsMesh(t,n.usePreciseIntersection),d=t._intersectionsInProgress.indexOf(o);s&&-1===d?r.trigger===T.ActionManager.OnIntersectionEnterTrigger?(r._executeCurrent(T.ActionEvent.CreateNew(t,void 0,o)),t._intersectionsInProgress.push(o)):r.trigger===T.ActionManager.OnIntersectionExitTrigger&&t._intersectionsInProgress.push(o):!s&&-1<d&&(r.trigger===T.ActionManager.OnIntersectionExitTrigger&&r._executeCurrent(T.ActionEvent.CreateNew(t,void 0,o)),t.actionManager.hasSpecificTrigger(T.ActionManager.OnIntersectionExitTrigger,function(e){var t=e instanceof T.AbstractMesh?e:e.mesh;return o===t})&&r.trigger!==T.ActionManager.OnIntersectionExitTrigger||t._intersectionsInProgress.splice(d,1))}},c.prototype.render=function(){if(!this.isDisposed){if(this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(T.ActionManager.OnEveryFrameTrigger),this.simplificationQueue&&!this.simplificationQueue.running&&this.simplificationQueue.executeNext(),this._engine.isDeterministicLockStep()){var e=W(c.MinDeltaTime,C(this._engine.getDeltaTime(),c.MaxDeltaTime))+this._timeAccumulator,t=1e3/60;this._physicsEngine&&(t=1e3*this._physicsEngine.getTimeStep());var r=0,i=this._engine.getLockstepMaxSteps(),o=ee(e/60);o=C(o,i);do this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=.06*t,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this._physicsEngine&&(this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this)),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;while(0<e&&r<o);this._timeAccumulator=0>e?0:e}else{var e=this.useConstantAnimationDeltaTime?16:W(c.MinDeltaTime,C(this._engine.getDeltaTime(),c.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this._physicsEngine&&(this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this))}if(this._gamepadManager&&this._gamepadManager._isMonitoring&&this._gamepadManager._checkGamepadsStatus(),0<this.activeCameras.length){for(var n=0,a;n<this.activeCameras.length;n++)if(a=this.activeCameras[n],a.update(),a.cameraRigMode!==T.Camera.RIG_MODE_NONE)for(var s=0;s<a._rigCameras.length;s++)a._rigCameras[s].update();}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==T.Camera.RIG_MODE_NONE))for(var s=0;s<this.activeCamera._rigCameras.length;s++)this.activeCamera._rigCameras[s].update();this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var l=this.getEngine(),h=this.activeCamera;if(this.renderTargetsEnabled){T.Tools.StartPerformanceCounter('Custom render targets',0<this.customRenderTargets.length),this._intermediateRendering=!0;for(var u=0,f;u<this.customRenderTargets.length;u++)if(f=this.customRenderTargets[u],f._shouldRender()){if(this._renderId++,this.activeCamera=f.activeCamera||this.activeCamera,!this.activeCamera)throw new Error('Active camera not set');l.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),f.render(h!==this.activeCamera,this.dumpNextRenderTargets)}T.Tools.EndPerformanceCounter('Custom render targets',0<this.customRenderTargets.length),this._intermediateRendering=!1,this._renderId++}if(0<this.customRenderTargets.length&&l.restoreDefaultFramebuffer(),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.activeCamera=h,this.proceduralTexturesEnabled){T.Tools.StartPerformanceCounter('Procedural textures',0<this.proceduralTextures.length);for(var d=0,p;d<this.proceduralTextures.length;d++)p=this.proceduralTextures[d],p._shouldRender()&&p.render();T.Tools.EndPerformanceCounter('Procedural textures',0<this.proceduralTextures.length)}if((this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil),this.shadowsEnabled)for(var _=0;_<this.lights.length;_++){var m=this.lights[_],g=m.getShadowGenerator();if(m.isEnabled()&&m.shadowEnabled&&g){var E=g.getShadowMap();-1!==this.textures.indexOf(E)&&this._renderTargets.push(E)}}for(var y in this._depthRenderer)this._renderTargets.push(this._depthRenderer[y].getDepthMap());if(this._geometryBufferRenderer&&this._renderTargets.push(this._geometryBufferRenderer.getGBuffer()),this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager.update(),0<this.activeCameras.length)for(var n=0;n<this.activeCameras.length;n++)0<n&&this._engine.clear(null,!1,!0,!0),this._processSubCameras(this.activeCameras[n]);else{if(!this.activeCamera)throw new Error('No camera defined');this._processSubCameras(this.activeCamera)}this._checkIntersections(),T.AudioEngine&&this._updateAudioParameters(),this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this);for(var s=0,b;s<this._toBeDisposed.length;s++)b=this._toBeDisposed.data[s],b&&b.dispose(),this._toBeDisposed[s]=null;this._toBeDisposed.reset(),this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0)}},c.prototype._updateAudioParameters=function(){if(this.audioEnabled&&this._mainSoundTrack&&(0!==this._mainSoundTrack.soundCollection.length||1!==this.soundTracks.length)){var e=T.Engine.audioEngine,i;if((i=0<this.activeCameras.length?this.activeCameras[0]:this.activeCamera)&&e.canUseWebAudio&&e.audioContext){e.audioContext.listener.setPosition(i.position.x,i.position.y,i.position.z),i.rigCameras&&0<i.rigCameras.length&&(i=i.rigCameras[0]);var t=T.Matrix.Invert(i.getViewMatrix()),r=T.Vector3.TransformNormal(new T.Vector3(0,0,-1),t);r.normalize(),isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||e.audioContext.listener.setOrientation(r.x,r.y,r.z,0,1,0);var n;for(n=0;n<this.mainSoundTrack.soundCollection.length;n++){var o=this.mainSoundTrack.soundCollection[n];o.useCustomAttenuation&&o.updateDistanceFromListener()}for(n=0;n<this.soundTracks.length;n++)for(var s=0;s<this.soundTracks[n].soundCollection.length;s++)o=this.soundTracks[n].soundCollection[s],o.useCustomAttenuation&&o.updateDistanceFromListener()}}},Object.defineProperty(c.prototype,'audioEnabled',{get:function(){return this._audioEnabled},set:function(e){this._audioEnabled=e,T.AudioEngine&&(this._audioEnabled?this._enableAudio():this._disableAudio())},enumerable:!0,configurable:!0}),c.prototype._disableAudio=function(){var r;for(r=0;r<this.mainSoundTrack.soundCollection.length;r++)this.mainSoundTrack.soundCollection[r].pause();for(r=0;r<this.soundTracks.length;r++)for(var e=0;e<this.soundTracks[r].soundCollection.length;e++)this.soundTracks[r].soundCollection[e].pause()},c.prototype._enableAudio=function(){var r;for(r=0;r<this.mainSoundTrack.soundCollection.length;r++)this.mainSoundTrack.soundCollection[r].isPaused&&this.mainSoundTrack.soundCollection[r].play();for(r=0;r<this.soundTracks.length;r++)for(var e=0;e<this.soundTracks[r].soundCollection.length;e++)this.soundTracks[r].soundCollection[e].isPaused&&this.soundTracks[r].soundCollection[e].play()},Object.defineProperty(c.prototype,'headphone',{get:function(){return this._headphone},set:function(e){this._headphone=e,T.AudioEngine&&(this._headphone?this._switchAudioModeForHeadphones():this._switchAudioModeForNormalSpeakers())},enumerable:!0,configurable:!0}),c.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].switchPanningModelToHRTF()},c.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].switchPanningModelToEqualPower()},c.prototype.enableDepthRenderer=function(e){if(!(e=e||this.activeCamera))throw'No camera available to enable depth renderer';if(!this._depthRenderer[e.id]){var t=0;if(this._engine.getCaps().textureHalfFloatRender)t=T.Engine.TEXTURETYPE_HALF_FLOAT;else{if(!this._engine.getCaps().textureFloatRender)throw'Depth renderer does not support int texture type';t=T.Engine.TEXTURETYPE_FLOAT}this._depthRenderer[e.id]=new T.DepthRenderer(this,t,e)}return this._depthRenderer[e.id]},c.prototype.disableDepthRenderer=function(t){(t=t||this.activeCamera)&&this._depthRenderer[t.id]&&(this._depthRenderer[t.id].dispose(),delete this._depthRenderer[t.id])},c.prototype.enableGeometryBufferRenderer=function(e){return void 0===e&&(e=1),this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new T.GeometryBufferRenderer(this,e),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)},c.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)},c.prototype.freezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].freeze()},c.prototype.unfreezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].unfreeze()},c.prototype.dispose=function(){for(var e in this.beforeRender=null,this.afterRender=null,this.skeletons=[],this.morphTargetManagers=[],this.importedMeshesFiles=[],this.stopAllAnimations(),this.resetCachedMaterial(),this._depthRenderer)this._depthRenderer[e].dispose();this._gamepadManager&&(this._gamepadManager.dispose(),this._gamepadManager=null),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._boundingBoxRenderer&&this._boundingBoxRenderer.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.dispose();for(var t=0,i=this._activeRequests;t<i.length;t++)i[t].abort();this._debugLayer&&this._debugLayer.hide(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeSpritesRenderingObservable.clear(),this.onAfterSpritesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforePhysicsObservable.clear(),this.onAfterPhysicsObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.detachControl(),T.AudioEngine&&this.disposeSounds(),this.VRHelper&&this.VRHelper.dispose();var r=this._engine.getRenderingCanvas();if(r){var a;for(a=0;a<this.cameras.length;a++)this.cameras[a].detachControl(r)}for(;this.animationGroups.length;)this.animationGroups[0].dispose();for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.transformNodes.length;)this.removeTransformNode(this.transformNodes[0]);for(;this.cameras.length;)this.cameras[0].dispose();for(this.defaultMaterial&&this.defaultMaterial.dispose();this.multiMaterials.length;)this.multiMaterials[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.effectLayers.length;)this.effectLayers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this._sceneUbo.dispose(),this._alternateSceneUbo&&this._alternateSceneUbo.dispose(),this.postProcessManager.dispose(),this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),a=this._engine.scenes.indexOf(this),-1<a&&this._engine.scenes.splice(a,1),this._engine.wipeCaches(!0),this._isDisposed=!0},Object.defineProperty(c.prototype,'isDisposed',{get:function(){return this._isDisposed},enumerable:!0,configurable:!0}),c.prototype.disposeSounds=function(){if(this._mainSoundTrack){this.mainSoundTrack.dispose();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].dispose()}},c.prototype.getWorldExtends=function(e){var a=new T.Vector3(S,S,S),l=new T.Vector3(-S,-S,-S);return e=e||function(){return!0},this.meshes.filter(e).forEach(function(e){if(e.computeWorldMatrix(!0),e.subMeshes&&0!==e.subMeshes.length&&!e.infiniteDistance){var t=e.getBoundingInfo(),r=t.boundingBox.minimumWorld,o=t.boundingBox.maximumWorld;T.Tools.CheckExtends(r,a,l),T.Tools.CheckExtends(o,a,l)}}),{min:a,max:l}},c.prototype.createOrUpdateSelectionOctree=function(e,t){void 0===e&&(e=64),void 0===t&&(t=2),this._selectionOctree||(this._selectionOctree=new T.Octree(T.Octree.CreationFuncForMeshes,e,t));var o=this.getWorldExtends();return this._selectionOctree.update(o.min,o.max,this.meshes),this._selectionOctree},c.prototype.createPickingRay=function(e,t,i,r,a){void 0===a&&(a=!1);var o=T.Ray.Zero();return this.createPickingRayToRef(e,t,i,o,r,a),o},c.prototype.createPickingRayToRef=function(e,t,i,r,n,d){void 0===d&&(d=!1);var s=this._engine;if(!n){if(!this.activeCamera)throw new Error('Active camera not set');n=this.activeCamera}var a=n.viewport,l=a.toGlobal(s.getRenderWidth(),s.getRenderHeight());return e=e/this._engine.getHardwareScalingLevel()-l.x,t=t/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-l.y-l.height),r.update(e,t,l.width,l.height,i||T.Matrix.Identity(),d?T.Matrix.Identity():n.getViewMatrix(),n.getProjectionMatrix()),this},c.prototype.createPickingRayInCameraSpace=function(e,t,o){var r=T.Ray.Zero();return this.createPickingRayInCameraSpaceToRef(e,t,r,o),r},c.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,r){if(!T.PickingInfo)return this;var d=this._engine;if(!r){if(!this.activeCamera)throw new Error('Active camera not set');r=this.activeCamera}var o=r.viewport,s=o.toGlobal(d.getRenderWidth(),d.getRenderHeight()),a=T.Matrix.Identity();return e=e/this._engine.getHardwareScalingLevel()-s.x,t=t/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-s.y-s.height),i.update(e,t,s.width,s.height,a,a,r.getProjectionMatrix()),this},c.prototype._internalPick=function(e,t,i){if(!T.PickingInfo)return null;for(var r=null,n=0,o;n<this.meshes.length;n++){if(o=this.meshes[n],t){if(!t(o))continue;}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var s=o.getWorldMatrix(),a=e(s),l=o.intersects(a,i);if(l&&l.hit&&(i||null==r||!(l.distance>=r.distance))&&(r=l,i))break}return r||new T.PickingInfo},c.prototype._internalMultiPick=function(e,t){if(!T.PickingInfo)return null;for(var i=[],r=0,n;r<this.meshes.length;r++){if(n=this.meshes[r],t){if(!t(n))continue;}else if(!n.isEnabled()||!n.isVisible||!n.isPickable)continue;var o=n.getWorldMatrix(),s=e(o),a=n.intersects(s,!1);a&&a.hit&&i.push(a)}return i},c.prototype._internalPickSprites=function(e,t,i,r){if(!T.PickingInfo)return null;var d=null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}if(0<this.spriteManagers.length)for(var o=0,s;o<this.spriteManagers.length;o++)if(s=this.spriteManagers[o],s.isPickable){var a=s.intersects(e,r,t,i);if(a&&a.hit&&(i||null==d||!(a.distance>=d.distance))&&(d=a,i))break}return d||new T.PickingInfo},c.prototype.pick=function(a,t,e,r,i){var o=this;return T.PickingInfo?this._internalPick(function(r){return o.createPickingRayToRef(a,t,r,o._tempPickingRay,i||null),o._tempPickingRay},e,r):null},c.prototype.pickSprite=function(o,e,t,i,r){return this.createPickingRayInCameraSpaceToRef(o,e,this._tempPickingRay,r),this._internalPickSprites(this._tempPickingRay,t,i,r)},c.prototype.pickWithRay=function(e,t,o){var r=this;return this._internalPick(function(t){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=T.Matrix.Identity()),t.invertToRef(r._pickWithRayInverseMatrix),r._cachedRayForTransform||(r._cachedRayForTransform=T.Ray.Zero()),T.Ray.TransformToRef(e,r._pickWithRayInverseMatrix,r._cachedRayForTransform),r._cachedRayForTransform},t,o)},c.prototype.multiPick=function(o,e,t,a){var r=this;return this._internalMultiPick(function(t){return r.createPickingRay(o,e,t,a||null)},t)},c.prototype.multiPickWithRay=function(e,t){var o=this;return this._internalMultiPick(function(t){return o._pickWithRayInverseMatrix||(o._pickWithRayInverseMatrix=T.Matrix.Identity()),t.invertToRef(o._pickWithRayInverseMatrix),o._cachedRayForTransform||(o._cachedRayForTransform=T.Ray.Zero()),T.Ray.TransformToRef(e,o._pickWithRayInverseMatrix,o._cachedRayForTransform),o._cachedRayForTransform},t)},c.prototype.setPointerOverMesh=function(e){this._pointerOverMesh!==e&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(T.ActionManager.OnPointerOutTrigger,T.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=e,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(T.ActionManager.OnPointerOverTrigger,T.ActionEvent.CreateNew(this._pointerOverMesh)))},c.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},c.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(T.ActionManager.OnPointerOutTrigger,T.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(T.ActionManager.OnPointerOverTrigger,T.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)))},c.prototype.getPointerOverSprite=function(){return this._pointerOverSprite},c.prototype.getPhysicsEngine=function(){return this._physicsEngine},c.prototype.enablePhysics=function(e,t){if(void 0===e&&(e=null),this._physicsEngine)return!0;try{return this._physicsEngine=new T.PhysicsEngine(e,t),!0}catch(e){return T.Tools.Error(e.message),!1}},c.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},c.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},c.prototype.deleteCompoundImpostor=function(r){var e=r.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)},c.prototype._rebuildGeometries=function(){for(var d=0,e=this._geometries;d<e.length;d++)e[d]._rebuild();for(var t=0,i=this.meshes;t<i.length;t++)i[t]._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(var r=0,n=this.layers;r<n.length;r++)n[r]._rebuild();for(var o=0,s=this.effectLayers;o<s.length;o++)s[o]._rebuild();this._boundingBoxRenderer&&this._boundingBoxRenderer._rebuild();for(var a=0,l=this.particleSystems;a<l.length;a++)l[a].rebuild();this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager._rebuild()},c.prototype._rebuildTextures=function(){for(var e=0,t=this.textures;e<t.length;e++)t[e]._rebuild();this.markAllMaterialsAsDirty(T.Material.TextureDirtyFlag)},c.prototype.createDefaultLight=function(e){if(void 0===e&&(e=!1),e&&this.lights)for(var t=0;t<this.lights.length;t++)this.lights[t].dispose();0===this.lights.length&&new T.HemisphericLight('default light',T.Vector3.Up(),this)},c.prototype.createDefaultCamera=function(e,t,i){if(void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===i&&(i=!1),t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){var r=this.getWorldExtends(),o=r.max.subtract(r.min),s=r.min.add(o.scale(.5)),a=1.5*o.length(),d;if(isFinite(a)||(a=1,s.copyFromFloats(0,0,0)),e){var n=new T.ArcRotateCamera('default camera',-V/2,V/2,a,s,this);n.lowerRadiusLimit=.01*a,n.wheelPrecision=100/a,d=n}else{var p=new T.FreeCamera('default camera',new T.Vector3(s.x,s.y,-a),this);p.setTarget(s),d=p}d.minZ=.01*a,d.maxZ=1e3*a,d.speed=.2*a,this.activeCamera=d;var c=this.getEngine().getRenderingCanvas();i&&c&&d.attachControl(c)}},c.prototype.createDefaultCameraOrLight=function(r,e,t){void 0===r&&(r=!1),void 0===e&&(e=!1),void 0===t&&(t=!1),this.createDefaultLight(e),this.createDefaultCamera(r,e,t)},c.prototype.createDefaultSkybox=function(e,d,i,r,n){if(void 0===d&&(d=!1),void 0===i&&(i=1e3),void 0===r&&(r=0),void 0===n&&(n=!0),!e)return T.Tools.Warn('Can not create default skybox without environment texture.'),null;n&&e&&(this.environmentTexture=e);var o=T.Mesh.CreateBox('hdrSkyBox',i,this);if(d){var s=new T.PBRMaterial('skyBox',this);s.backFaceCulling=!1,s.reflectionTexture=e.clone(),s.reflectionTexture&&(s.reflectionTexture.coordinatesMode=T.Texture.SKYBOX_MODE),s.microSurface=1-r,s.disableLighting=!0,s.twoSidedLighting=!0,o.infiniteDistance=!0,o.material=s}else{var a=new T.StandardMaterial('skyBox',this);a.backFaceCulling=!1,a.reflectionTexture=e.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=T.Texture.SKYBOX_MODE),a.disableLighting=!0,o.infiniteDistance=!0,o.material=a}return o},c.prototype.createDefaultEnvironment=function(e){return T.EnvironmentHelper?new T.EnvironmentHelper(e,this):null},c.prototype.createDefaultVRExperience=function(e){return void 0===e&&(e={}),new T.VRExperienceHelper(this,e)},c.prototype._getByTags=function(e,t,i){if(void 0===t)return e;var r=[];for(var a in i=i||function(){},e){var o=e[a];T.Tags&&T.Tags.MatchesQuery(o,t)&&(r.push(o),i(o))}return r},c.prototype.getMeshesByTags=function(r,e){return this._getByTags(this.meshes,r,e)},c.prototype.getCamerasByTags=function(r,e){return this._getByTags(this.cameras,r,e)},c.prototype.getLightsByTags=function(r,e){return this._getByTags(this.lights,r,e)},c.prototype.getMaterialByTags=function(r,e){return this._getByTags(this.materials,r,e).concat(this._getByTags(this.multiMaterials,r,e))},c.prototype.setRenderingOrder=function(o,e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._renderingManager.setRenderingOrder(o,e,t,i)},c.prototype.setRenderingAutoClearDepthStencil=function(o,e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!0),this._renderingManager.setRenderingAutoClearDepthStencil(o,e,t,i)},c.prototype.markAllMaterialsAsDirty=function(o,e){for(var t=0,i=this.materials,r;t<i.length;t++)r=i[t],e&&!e(r)||r.markAsDirty(o)},c.prototype._loadFile=function(e,t,i,r,n,o){var s=this,a=T.Tools.LoadFile(e,t,i,r?this.database:void 0,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add(function(t){s._activeRequests.splice(s._activeRequests.indexOf(t),1)}),a},c.prototype._loadFileAsync=function(a,e,t){var i=this;return new Promise(function(r,n){i._loadFile(a,function(t){r(t)},void 0,e,t,function(r,e){n(e)})})},c._FOGMODE_NONE=0,c._FOGMODE_EXP=1,c._FOGMODE_EXP2=2,c._FOGMODE_LINEAR=3,c._uniqueIdCounter=0,c.MinDeltaTime=1,c.MaxDeltaTime=1e3,c.DragMovementThreshold=10,c.LongPressDelay=500,c.DoubleClickDelay=300,c.ExclusiveDoubleClickMode=!1,c}();T.Scene=t}(e||(e={}));var e;!function(r){var o=function(){return function(){this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.lensFlareSystems=[],this.shadowGenerators=[],this.actionManagers=[],this.sounds=[],this.textures=[],this.effectLayers=[]}}();r.KeepAssets=o;var e=function(){function t(t){this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.lensFlareSystems=[],this.shadowGenerators=[],this.actionManagers=[],this.sounds=[],this.textures=[],this.effectLayers=[],this.scene=t}return t.prototype.addAllToScene=function(){var r=this;this.cameras.forEach(function(e){r.scene.addCamera(e)}),this.lights.forEach(function(e){r.scene.addLight(e)}),this.meshes.forEach(function(e){r.scene.addMesh(e)}),this.skeletons.forEach(function(e){r.scene.addSkeleton(e)}),this.particleSystems.forEach(function(e){r.scene.addParticleSystem(e)}),this.animations.forEach(function(e){r.scene.addAnimation(e)}),this.animationGroups.forEach(function(e){r.scene.addAnimationGroup(e)}),this.multiMaterials.forEach(function(e){r.scene.addMultiMaterial(e)}),this.materials.forEach(function(e){r.scene.addMaterial(e)}),this.morphTargetManagers.forEach(function(e){r.scene.addMorphTargetManager(e)}),this.geometries.forEach(function(e){r.scene.addGeometry(e)}),this.transformNodes.forEach(function(e){r.scene.addTransformNode(e)}),this.lensFlareSystems.forEach(function(e){r.scene.addLensFlareSystem(e)}),this.actionManagers.forEach(function(e){r.scene.addActionManager(e)}),this.sounds.forEach(function(e){e.play(),e.autoplay=!0,r.scene.mainSoundTrack.AddSound(e)}),this.textures.forEach(function(e){r.scene.addTexture(e)}),this.effectLayers.forEach(function(e){r.scene.addEffectLayer(e)})},t.prototype.removeAllFromScene=function(){var r=this;this.cameras.forEach(function(e){r.scene.removeCamera(e)}),this.lights.forEach(function(e){r.scene.removeLight(e)}),this.meshes.forEach(function(e){r.scene.removeMesh(e)}),this.skeletons.forEach(function(e){r.scene.removeSkeleton(e)}),this.particleSystems.forEach(function(e){r.scene.removeParticleSystem(e)}),this.animations.forEach(function(e){r.scene.removeAnimation(e)}),this.animationGroups.forEach(function(e){r.scene.removeAnimationGroup(e)}),this.multiMaterials.forEach(function(e){r.scene.removeMultiMaterial(e)}),this.materials.forEach(function(e){r.scene.removeMaterial(e)}),this.morphTargetManagers.forEach(function(e){r.scene.removeMorphTargetManager(e)}),this.geometries.forEach(function(e){r.scene.removeGeometry(e)}),this.transformNodes.forEach(function(e){r.scene.removeTransformNode(e)}),this.lensFlareSystems.forEach(function(e){r.scene.removeLensFlareSystem(e)}),this.actionManagers.forEach(function(e){r.scene.removeActionManager(e)}),this.sounds.forEach(function(e){e.stop(),e.autoplay=!1,r.scene.mainSoundTrack.RemoveSound(e)}),this.textures.forEach(function(e){r.scene.removeTexture(e)}),this.effectLayers.forEach(function(e){r.scene.removeEffectLayer(e)})},t.prototype._moveAssets=function(d,e,t){for(var i=0,r=d;i<r.length;i++){for(var n=r[i],o=!0,s=0,a=t;s<a.length;s++)if(n===a[s]){o=!1;break}o&&e.push(n)}},t.prototype.moveAllFromScene=function(t){void 0===t&&(t=new o),this._moveAssets(this.scene.cameras,this.cameras,t.cameras),this._moveAssets(this.scene.meshes,this.meshes,t.meshes),this._moveAssets(this.scene.getGeometries(),this.geometries,t.geometries),this._moveAssets(this.scene.materials,this.materials,t.materials),this._moveAssets(this.scene._actionManagers,this.actionManagers,t.actionManagers),this._moveAssets(this.scene.animations,this.animations,t.animations),this._moveAssets(this.scene.animationGroups,this.animationGroups,t.animationGroups),this._moveAssets(this.scene.lensFlareSystems,this.lensFlareSystems,t.lensFlareSystems),this._moveAssets(this.scene.lights,this.lights,t.lights),this._moveAssets(this.scene.morphTargetManagers,this.morphTargetManagers,t.morphTargetManagers),this._moveAssets(this.scene.multiMaterials,this.multiMaterials,t.multiMaterials),this._moveAssets(this.scene.skeletons,this.skeletons,t.skeletons),this._moveAssets(this.scene.particleSystems,this.particleSystems,t.particleSystems),this._moveAssets(this.scene.mainSoundTrack.soundCollection,this.sounds,t.sounds),this._moveAssets(this.scene.transformNodes,this.transformNodes,t.transformNodes),this._moveAssets(this.scene.textures,this.textures,t.textures),this._moveAssets(this.scene.effectLayers,this.effectLayers,t.effectLayers),this.removeAllFromScene()},t}();r.AssetContainer=e}(e||(e={}));var e;!function(d){var e=function(){function e(e,l,i,r,n,o,s){void 0===r&&(r=0),void 0===n&&(n=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),this._engine=e instanceof d.Mesh?e.getScene().getEngine():e,this._updatable=i,this._instanced=o,this._data=l,this.byteStride=s?r:r*Float32Array.BYTES_PER_ELEMENT,n||this.create()}return e.prototype.createVertexBuffer=function(e,t,i,r,n,o){void 0===o&&(o=!1);var s=o?t:t*Float32Array.BYTES_PER_ELEMENT,a=r?o?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new d.VertexBuffer(this._engine,this,e,this._updatable,!0,a,void 0===n?this._instanced:n,s,i,void 0,void 0,!0)},e.prototype.isUpdatable=function(){return this._updatable},e.prototype.getData=function(){return this._data},e.prototype.getBuffer=function(){return this._buffer},e.prototype.getStrideSize=function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT},e.prototype.create=function(t){void 0===t&&(t=null),!t&&this._buffer||(t=t||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,t),this._data=t):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(t),this._data=t):this._buffer=this._engine.createVertexBuffer(t))},e.prototype._rebuild=function(){this._buffer=null,this.create(this._data)},e.prototype.update=function(t){this.create(t)},e.prototype.updateDirectly=function(o,e,t,i){void 0===i&&(i=!1),this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,o,i?e:e*Float32Array.BYTES_PER_ELEMENT,t?t*this.byteStride:void 0),this._data=null)},e.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},e}();d.Buffer=e}(e||(e={}));var e;!function(m){var e=function(){function g(e,t,r,i,o,n,a,s,l,c,u,f){if(void 0===u&&(u=!1),void 0===f&&(f=!1),t instanceof m.Buffer?(this._buffer=t,this._ownsBuffer=!1):(this._buffer=new m.Buffer(e,t,i,n,o,a,f),this._ownsBuffer=!0),this._kind=r,void 0==c){var d=this.getData();this.type=g.FLOAT,d instanceof Int8Array?this.type=g.BYTE:d instanceof Uint8Array?this.type=g.UNSIGNED_BYTE:d instanceof Int16Array?this.type=g.SHORT:d instanceof Uint16Array?this.type=g.UNSIGNED_SHORT:d instanceof Int32Array?this.type=g.INT:d instanceof Uint32Array&&(this.type=g.UNSIGNED_INT)}else this.type=c;var p=g.GetTypeByteLength(this.type);f?(this._size=l||(n?n/p:g.DeduceStride(r)),this.byteStride=n||this._buffer.byteStride||this._size*p,this.byteOffset=s||0):(this._size=l||n||g.DeduceStride(r),this.byteStride=n?n*p:this._buffer.byteStride||this._size*p,this.byteOffset=(s||0)*p),this.normalized=u,this._instanced=void 0!==a&&a,this._instanceDivisor=a?1:0}return Object.defineProperty(g.prototype,'instanceDivisor',{get:function(){return this._instanceDivisor},set:function(t){this._instanceDivisor=t,this._instanced=0!=t},enumerable:!0,configurable:!0}),g.prototype._rebuild=function(){this._buffer&&this._buffer._rebuild()},g.prototype.getKind=function(){return this._kind},g.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},g.prototype.getData=function(){return this._buffer.getData()},g.prototype.getBuffer=function(){return this._buffer.getBuffer()},g.prototype.getStrideSize=function(){return this.byteStride/g.GetTypeByteLength(this.type)},g.prototype.getOffset=function(){return this.byteOffset/g.GetTypeByteLength(this.type)},g.prototype.getSize=function(){return this._size},g.prototype.getIsInstanced=function(){return this._instanced},g.prototype.getInstanceDivisor=function(){return this._instanceDivisor},g.prototype.create=function(t){return this._buffer.create(t)},g.prototype.update=function(t){return this._buffer.update(t)},g.prototype.updateDirectly=function(r,e,t){void 0===t&&(t=!1),this._buffer.updateDirectly(r,e,void 0,t)},g.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},g.prototype.forEach=function(t,e){g.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,e)},Object.defineProperty(g,'PositionKind',{get:function(){return g._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'NormalKind',{get:function(){return g._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'TangentKind',{get:function(){return g._TangentKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UVKind',{get:function(){return g._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UV2Kind',{get:function(){return g._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UV3Kind',{get:function(){return g._UV3Kind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UV4Kind',{get:function(){return g._UV4Kind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UV5Kind',{get:function(){return g._UV5Kind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'UV6Kind',{get:function(){return g._UV6Kind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'ColorKind',{get:function(){return g._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'MatricesIndicesKind',{get:function(){return g._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'MatricesWeightsKind',{get:function(){return g._MatricesWeightsKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'MatricesIndicesExtraKind',{get:function(){return g._MatricesIndicesExtraKind},enumerable:!0,configurable:!0}),Object.defineProperty(g,'MatricesWeightsExtraKind',{get:function(){return g._MatricesWeightsExtraKind},enumerable:!0,configurable:!0}),g.DeduceStride=function(t){switch(t){case g.UVKind:case g.UV2Kind:case g.UV3Kind:case g.UV4Kind:case g.UV5Kind:case g.UV6Kind:return 2;case g.NormalKind:case g.PositionKind:return 3;case g.ColorKind:case g.MatricesIndicesKind:case g.MatricesIndicesExtraKind:case g.MatricesWeightsKind:case g.MatricesWeightsExtraKind:case g.TangentKind:return 4;default:throw new Error('Invalid kind \''+t+'\'');}},g.GetTypeByteLength=function(t){switch(t){case g.BYTE:case g.UNSIGNED_BYTE:return 1;case g.SHORT:case g.UNSIGNED_SHORT:return 2;case g.INT:case g.FLOAT:return 4;default:throw new Error('Invalid type \''+t+'\'');}},g.ForEach=function(t,e,i,r,n,o,s,a){if(t instanceof Array)for(var l=e/4,c=0;c<o;c+=r){for(var u=0;u<r;u++)a(t[l+u],c+u);l+=i/4}else for(var f=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),d=g.GetTypeByteLength(n),c=0;c<o;c+=r){for(var p=e,u=0,_;u<r;u++)_=g._GetFloatValue(f,n,p,s),a(_,c+u),p+=d;e+=i}},g._GetFloatValue=function(t,e,i,r){switch(e){case g.BYTE:var a=t.getInt8(i);return r&&(a=W(a/127,-1)),a;case g.UNSIGNED_BYTE:var a=t.getUint8(i);return r&&(a/=255),a;case g.SHORT:var a=t.getInt16(i,!0);return r&&(a=W(a/16383,-1)),a;case g.UNSIGNED_SHORT:var a=t.getUint16(i,!0);return r&&(a/=65535),a;case g.FLOAT:return t.getFloat32(i,!0);default:throw new Error('Invalid component type '+e);}},g.BYTE=5120,g.UNSIGNED_BYTE=5121,g.SHORT=5122,g.UNSIGNED_SHORT=5123,g.INT=5124,g.UNSIGNED_INT=5125,g.FLOAT=5126,g._PositionKind='position',g._NormalKind='normal',g._TangentKind='tangent',g._UVKind='uv',g._UV2Kind='uv2',g._UV3Kind='uv3',g._UV4Kind='uv4',g._UV5Kind='uv5',g._UV6Kind='uv6',g._ColorKind='color',g._MatricesIndicesKind='matricesIndices',g._MatricesWeightsKind='matricesWeights',g._MatricesIndicesExtraKind='matricesIndicesExtra',g._MatricesWeightsExtraKind='matricesWeightsExtra',g}();m.VertexBuffer=e}(e||(e={}));var e;!function(r){var e=function(){return function(){this.previous=null,this.next=null}}();r.DummyInternalTextureTracker=e}(e||(e={}));var e;!function(a){var e=function(){function e(t,o){this.onLoadedObservable=new a.Observable,this.previous=null,this.next=null,this._initialSlot=-1,this._designatedSlot=-1,this._dataSource=e.DATASOURCE_UNKNOWN,this._comparisonFunction=0,this._references=1,this._engine=t,this._dataSource=o,this._webGLTexture=t._createTexture()}return Object.defineProperty(e.prototype,'dataSource',{get:function(){return this._dataSource},enumerable:!0,configurable:!0}),e.prototype.incrementReferences=function(){this._references++},e.prototype.updateSize=function(r,e,t){void 0===t&&(t=1),this.width=r,this.height=e,this.depth=t,this.baseWidth=r,this.baseHeight=e,this.baseDepth=t,this._size=r*e*t},e.prototype._rebuild=function(){var t=this,r;switch(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedAnisotropicFilteringLevel=null,this._dataSource){case e.DATASOURCE_TEMP:return;case e.DATASOURCE_URL:return r=this._engine.createTexture(this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){t.isReady=!0},null,this._buffer,void 0,this.format),void r._swapAndDie(this);case e.DATASOURCE_RAW:return r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case e.DATASOURCE_RAW3D:return r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case e.DATASOURCE_DYNAMIC:return r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),void r._swapAndDie(this);case e.DATASOURCE_RENDERTARGET:var i=new a.RenderTargetCreationOptions;if(i.generateDepthBuffer=this._generateDepthBuffer,i.generateMipMaps=this.generateMipMaps,i.generateStencilBuffer=this._generateStencilBuffer,i.samplingMode=this.samplingMode,i.type=this.type,this.isCube)r=this._engine.createRenderTargetCubeTexture(this.width,i);else{var n={width:this.width,height:this.height};r=this._engine.createRenderTargetTexture(n,i)}return r._swapAndDie(this),void(this.isReady=!0);case e.DATASOURCE_DEPTHTEXTURE:var o={bilinearFiltering:this.samplingMode!==a.Texture.BILINEAR_SAMPLINGMODE,comparisonFunction:this._comparisonFunction,generateStencil:this._generateStencilBuffer,isCube:this.isCube};return r=this._engine.createDepthStencilTexture({width:this.width,height:this.height},o),r._swapAndDie(this),void(this.isReady=!0);case e.DATASOURCE_CUBE:return r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){t.isReady=!0},null,this.format,this._extension),void r._swapAndDie(this);case e.DATASOURCE_CUBERAW:return r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case e.DATASOURCE_CUBEPREFILTERED:return void(r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(r){r&&r._swapAndDie(t),t.isReady=!0},null,this.format,this._extension));}},e.prototype._swapAndDie=function(r){r._webGLTexture=this._webGLTexture,this._framebuffer&&(r._framebuffer=this._framebuffer),this._depthStencilBuffer&&(r._depthStencilBuffer=this._depthStencilBuffer),this._lodTextureHigh&&(r._lodTextureHigh&&r._lodTextureHigh.dispose(),r._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(r._lodTextureMid&&r._lodTextureMid.dispose(),r._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(r._lodTextureLow&&r._lodTextureLow.dispose(),r._lodTextureLow=this._lodTextureLow);var e=this._engine.getLoadedTexturesCache(),t=e.indexOf(this);-1!==t&&e.splice(t,1)},e.prototype.dispose=function(){this._webGLTexture&&0==--this._references&&(this._engine._releaseTexture(this),this._webGLTexture=null,this.previous=null,this.next=null)},e.DATASOURCE_UNKNOWN=0,e.DATASOURCE_URL=1,e.DATASOURCE_TEMP=2,e.DATASOURCE_RAW=3,e.DATASOURCE_DYNAMIC=4,e.DATASOURCE_RENDERTARGET=5,e.DATASOURCE_MULTIRENDERTARGET=6,e.DATASOURCE_CUBE=7,e.DATASOURCE_CUBERAW=8,e.DATASOURCE_CUBEPREFILTERED=9,e.DATASOURCE_RAW3D=10,e.DATASOURCE_DEPTHTEXTURE=11,e}();a.InternalTexture=e}(e||(e={}));var e;!function(r){var e=function(){function e(t){this._hasAlpha=!1,this.getAlphaFromRGB=!1,this.level=1,this.coordinatesIndex=0,this._coordinatesMode=r.Texture.EXPLICIT_MODE,this.wrapU=r.Texture.WRAP_ADDRESSMODE,this.wrapV=r.Texture.WRAP_ADDRESSMODE,this.wrapR=r.Texture.WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this.isCube=!1,this.is3D=!1,this.gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.lodGenerationOffset=0,this.lodGenerationScale=.8,this.isRenderTarget=!1,this.animations=[],this.onDisposeObservable=new r.Observable,this.delayLoadState=r.Engine.DELAYLOADSTATE_NONE,this._scene=t||r.Engine.LastCreatedScene,this._scene&&this._scene.textures.push(this),this._uid=null}return Object.defineProperty(e.prototype,'hasAlpha',{get:function(){return this._hasAlpha},set:function(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(r.Material.TextureDirtyFlag|r.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'coordinatesMode',{get:function(){return this._coordinatesMode},set:function(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(r.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'uid',{get:function(){return this._uid||(this._uid=r.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return this.name},e.prototype.getClassName=function(){return'BaseTexture'},Object.defineProperty(e.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isBlocking',{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getTextureMatrix=function(){return r.Matrix.IdentityReadOnly},e.prototype.getReflectionTextureMatrix=function(){return r.Matrix.IdentityReadOnly},e.prototype.getInternalTexture=function(){return this._texture},e.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()},e.prototype.isReady=function(){return this.delayLoadState===r.Engine.DELAYLOADSTATE_NOTLOADED?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady},e.prototype.getSize=function(){return this._texture&&this._texture.width?new r.Size(this._texture.width,this._texture.height):this._texture&&this._texture._size?new r.Size(this._texture._size,this._texture._size):r.Size.Zero()},e.prototype.getBaseSize=function(){return this.isReady()&&this._texture?this._texture._size?new r.Size(this._texture._size,this._texture._size):new r.Size(this._texture.baseWidth,this._texture.baseHeight):r.Size.Zero()},e.prototype.scale=function(){},Object.defineProperty(e.prototype,'canRescale',{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype._getFromCache=function(a,e,s){if(!this._scene)return null;for(var l=this._scene.getEngine().getLoadedTexturesCache(),r=0,n;r<l.length;r++)if(n=l[r],n.url===a&&n.generateMipMaps===!e&&(!s||s===n.samplingMode))return n.incrementReferences(),n;return null},e.prototype._rebuild=function(){},e.prototype.delayLoad=function(){},e.prototype.clone=function(){return null},Object.defineProperty(e.prototype,'textureType',{get:function(){return this._texture&&void 0!==this._texture.type?this._texture.type:r.Engine.TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'textureFormat',{get:function(){return this._texture&&void 0!==this._texture.format?this._texture.format:r.Engine.TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),e.prototype.readPixels=function(o){if(void 0===o&&(o=0),!this._texture)return null;var e=this.getSize(),t=this.getScene();if(!t)return null;var a=t.getEngine();return this._texture.isCube?a._readTexturePixels(this._texture,e.width,e.height,o):a._readTexturePixels(this._texture,e.width,e.height,-1)},e.prototype.releaseInternalTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null)},Object.defineProperty(e.prototype,'sphericalPolynomial',{get:function(){return this._texture&&r.CubeMapToSphericalPolynomialTools&&this.isReady()?(this._texture._sphericalPolynomial||(this._texture._sphericalPolynomial=r.CubeMapToSphericalPolynomialTools.ConvertCubeMapTextureToSphericalPolynomial(this)),this._texture._sphericalPolynomial):null},set:function(t){this._texture&&(this._texture._sphericalPolynomial=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'_lodTextureHigh',{get:function(){return this._texture?this._texture._lodTextureHigh:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'_lodTextureMid',{get:function(){return this._texture?this._texture._lodTextureMid:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'_lodTextureLow',{get:function(){return this._texture?this._texture._lodTextureLow:null},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){if(this._scene){this._scene.stopAnimation(this),this._scene._removePendingData(this);var t=this._scene.textures.indexOf(this);0<=t&&this._scene.textures.splice(t,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear())}},e.prototype.serialize=function(){if(!this.name)return null;var e=r.SerializationHelper.Serialize(this);return r.Animation.AppendSerializedAnimations(this,e),e},e.WhenAllReady=function(a,e){var t=a.length;if(0===t)return void e();for(var i=0,o,r;i<a.length;i++)!function(){if(o=a[i],o.isReady())0==--t&&e();else{r=o.onLoadObservable;var n=function(){r.removeCallback(n),0==--t&&e()};r.add(n)}}()},e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,g([r.serialize()],e.prototype,'name',void 0),g([r.serialize('hasAlpha')],e.prototype,'_hasAlpha',void 0),g([r.serialize()],e.prototype,'getAlphaFromRGB',void 0),g([r.serialize()],e.prototype,'level',void 0),g([r.serialize()],e.prototype,'coordinatesIndex',void 0),g([r.serialize('coordinatesMode')],e.prototype,'_coordinatesMode',void 0),g([r.serialize()],e.prototype,'wrapU',void 0),g([r.serialize()],e.prototype,'wrapV',void 0),g([r.serialize()],e.prototype,'wrapR',void 0),g([r.serialize()],e.prototype,'anisotropicFilteringLevel',void 0),g([r.serialize()],e.prototype,'isCube',void 0),g([r.serialize()],e.prototype,'is3D',void 0),g([r.serialize()],e.prototype,'gammaSpace',void 0),g([r.serialize()],e.prototype,'invertZ',void 0),g([r.serialize()],e.prototype,'lodLevelInAlpha',void 0),g([r.serialize()],e.prototype,'lodGenerationOffset',void 0),g([r.serialize()],e.prototype,'lodGenerationScale',void 0),g([r.serialize()],e.prototype,'isRenderTarget',void 0),e}();r.BaseTexture=e}(e||(e={}));var e;!function(_){var e=function(m){function e(t,r,i,o,n,a,s,l,c,u){void 0===i&&(i=!1),void 0===o&&(o=!0),void 0===n&&(n=e.TRILINEAR_SAMPLINGMODE),void 0===a&&(a=null),void 0===s&&(s=null),void 0===l&&(l=null),void 0===c&&(c=!1);var f=m.call(this,r)||this;if(f.uOffset=0,f.vOffset=0,f.uScale=1,f.vScale=1,f.uAng=0,f.vAng=0,f.wAng=0,f._isBlocking=!0,f.name=t||'',f.url=t,f._noMipmap=i,f._invertY=o,f._samplingMode=n,f._buffer=l,f._deleteBuffer=c,u&&(f._format=u),!(r=f.getScene()))return f;r.getEngine().onBeforeTextureInitObservable.notifyObservers(f);var d=function(){f._onLoadObservable&&f._onLoadObservable.hasObservers()&&f.onLoadObservable.notifyObservers(f),a&&a(),!f.isBlocking&&r&&r.resetCachedMaterial()};return f.url?(f._texture=f._getFromCache(f.url,i,n),f._texture?f._texture.isReady?_.Tools.SetImmediate(function(){return d()}):f._texture.onLoadedObservable.add(d):r.useDelayedTextureLoading?(f.delayLoadState=_.Engine.DELAYLOADSTATE_NOTLOADED,f._delayedOnLoad=d,f._delayedOnError=s):(f._texture=r.getEngine().createTexture(f.url,i,o,r,f._samplingMode,d,s,f._buffer,void 0,f._format),c&&delete f._buffer),f):(f._delayedOnLoad=d,f._delayedOnError=s,f)}return h(e,m),Object.defineProperty(e.prototype,'noMipmap',{get:function(){return this._noMipmap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isBlocking',{get:function(){return this._isBlocking},set:function(t){this._isBlocking=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'samplingMode',{get:function(){return this._samplingMode},enumerable:!0,configurable:!0}),e.prototype.updateURL=function(e){this.url=e,this.delayLoadState=_.Engine.DELAYLOADSTATE_NOTLOADED,this.delayLoad()},e.prototype.delayLoad=function(){if(this.delayLoadState===_.Engine.DELAYLOADSTATE_NOTLOADED){var e=this.getScene();e&&(this.delayLoadState=_.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode),this._texture?this._delayedOnLoad&&(this._texture.isReady?_.Tools.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format),this._deleteBuffer&&delete this._buffer),this._delayedOnLoad=null,this._delayedOnError=null)}},e.prototype.updateSamplingMode=function(r){if(this._texture){var e=this.getScene();e&&(this._samplingMode=r,e.getEngine().updateTextureSamplingMode(r,this._texture))}},e.prototype._prepareRowForTextureGeneration=function(e,t,o,r){e*=this.uScale,t*=this.vScale,e-=.5*this.uScale,t-=.5*this.vScale,o-=.5,_.Vector3.TransformCoordinatesFromFloatsToRef(e,t,o,this._rowGenerationMatrix,r),r.x+=.5*this.uScale+this.uOffset,r.y+=.5*this.vScale+this.vOffset,r.z+=.5},e.prototype.getTextureMatrix=function(){var r=this;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=_.Matrix.Zero(),this._rowGenerationMatrix=new _.Matrix,this._t0=_.Vector3.Zero(),this._t1=_.Vector3.Zero(),this._t2=_.Vector3.Zero()),_.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),_.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z;var e=this.getScene();return e?(e.markAllMaterialsAsDirty(_.Material.TextureDirtyFlag,function(t){return t.hasTexture(r)}),this._cachedTextureMatrix):this._cachedTextureMatrix},e.prototype.getReflectionTextureMatrix=function(){var o=this,t=this.getScene();if(!t)return this._cachedTextureMatrix;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode){if(this.coordinatesMode!==e.PROJECTION_MODE)return this._cachedTextureMatrix;if(this._cachedProjectionMatrixId===t.getProjectionMatrix().updateFlag)return this._cachedTextureMatrix}switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=_.Matrix.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=_.Matrix.Zero()),this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case e.PLANAR_MODE:_.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case e.PROJECTION_MODE:_.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1;var i=t.getProjectionMatrix();this._cachedProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:_.Matrix.IdentityToRef(this._cachedTextureMatrix);}return t.markAllMaterialsAsDirty(_.Material.TextureDirtyFlag,function(t){return-1!==t.getActiveTextures().indexOf(o)}),this._cachedTextureMatrix},e.prototype.clone=function(){var r=this;return _.SerializationHelper.Clone(function(){return new e(r._texture?r._texture.url:null,r.getScene(),r._noMipmap,r._invertY,r._samplingMode)},this)},Object.defineProperty(e.prototype,'onLoadObservable',{get:function(){return this._onLoadObservable||(this._onLoadObservable=new _.Observable),this._onLoadObservable},enumerable:!0,configurable:!0}),e.prototype.serialize=function(){var t=m.prototype.serialize.call(this);return'string'==typeof this._buffer&&'data:'===this._buffer.substr(0,5)&&(t.base64String=this._buffer,t.name=t.name.replace('data:','')),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t},e.prototype.getClassName=function(){return'Texture'},e.prototype.dispose=function(){m.prototype.dispose.call(this),this.onLoadObservable&&(this.onLoadObservable.clear(),this._onLoadObservable=null),this._delayedOnLoad=null,this._delayedOnError=null},e.CreateFromBase64String=function(i,t,r,n,o,s,a,l,d){return void 0===s&&(s=e.TRILINEAR_SAMPLINGMODE),void 0===a&&(a=null),void 0===l&&(l=null),void 0===d&&(d=_.Engine.TEXTUREFORMAT_RGBA),new e('data:'+t,r,n,o,s,a,l,i,!1,d)},e.Parse=function(i,t,r){if(i.customType){var n=_.Tools.Instantiate(i.customType),o=n.Parse(i,t,r);return i.samplingMode&&o.updateSamplingMode&&o._samplingMode&&o._samplingMode!==i.samplingMode&&o.updateSamplingMode(i.samplingMode),o}if(i.isCube)return _.CubeTexture.Parse(i,t,r);if(!i.name&&!i.isRenderTarget)return null;var s=_.SerializationHelper.Parse(function(){var n=!0;if(i.noMipmap&&(n=!1),i.mirrorPlane){var d=new _.MirrorTexture(i.name,i.renderTargetSize,t,n);return d._waitingRenderList=i.renderList,d.mirrorPlane=_.Plane.FromArray(i.mirrorPlane),d}if(i.isRenderTarget){var s=new _.RenderTargetTexture(i.name,i.renderTargetSize,t,n);return s._waitingRenderList=i.renderList,s}var a;if(i.base64String)a=e.CreateFromBase64String(i.base64String,i.name,t,!n);else{var l=r+i.name;e.UseSerializedUrlIfAny&&i.url&&(l=i.url),a=new e(l,t,!n,i.invertY)}return a},i,t);if(i.samplingMode){var a=i.samplingMode;s._samplingMode!==a&&s.updateSamplingMode(a)}if(i.animations)for(var l=0,d;l<i.animations.length;l++)d=i.animations[l],s.animations.push(_.Animation.Parse(d));return s},e.LoadFromDataString=function(i,t,r,n,o,s,a,l,d,c){return void 0===n&&(n=!1),void 0===o&&(o=!1),void 0===s&&(s=!0),void 0===a&&(a=e.TRILINEAR_SAMPLINGMODE),void 0===l&&(l=null),void 0===d&&(d=null),void 0===c&&(c=_.Engine.TEXTUREFORMAT_RGBA),'data:'!==i.substr(0,5)&&(i='data:'+i),new e(i,r,o,s,a,l,d,t,n,c)},e.NEAREST_SAMPLINGMODE=1,e.NEAREST_NEAREST_MIPLINEAR=1,e.BILINEAR_SAMPLINGMODE=2,e.LINEAR_LINEAR_MIPNEAREST=2,e.TRILINEAR_SAMPLINGMODE=3,e.LINEAR_LINEAR_MIPLINEAR=3,e.NEAREST_NEAREST_MIPNEAREST=4,e.NEAREST_LINEAR_MIPNEAREST=5,e.NEAREST_LINEAR_MIPLINEAR=6,e.NEAREST_LINEAR=7,e.NEAREST_NEAREST=8,e.LINEAR_NEAREST_MIPNEAREST=9,e.LINEAR_NEAREST_MIPLINEAR=10,e.LINEAR_LINEAR=11,e.LINEAR_NEAREST=12,e.EXPLICIT_MODE=0,e.SPHERICAL_MODE=1,e.PLANAR_MODE=2,e.CUBIC_MODE=3,e.PROJECTION_MODE=4,e.SKYBOX_MODE=5,e.INVCUBIC_MODE=6,e.EQUIRECTANGULAR_MODE=7,e.FIXED_EQUIRECTANGULAR_MODE=8,e.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.CLAMP_ADDRESSMODE=0,e.WRAP_ADDRESSMODE=1,e.MIRROR_ADDRESSMODE=2,e.UseSerializedUrlIfAny=!1,g([_.serialize()],e.prototype,'url',void 0),g([_.serialize()],e.prototype,'uOffset',void 0),g([_.serialize()],e.prototype,'vOffset',void 0),g([_.serialize()],e.prototype,'uScale',void 0),g([_.serialize()],e.prototype,'vScale',void 0),g([_.serialize()],e.prototype,'uAng',void 0),g([_.serialize()],e.prototype,'vAng',void 0),g([_.serialize()],e.prototype,'wAng',void 0),g([_.serialize()],e.prototype,'isBlocking',null),e}(_.BaseTexture);_.Texture=e}(e||(e={}));var e;!function(S){var e=function(){return function(){this.mustReturn=!1,this.visibleInstances=[],this.renderSelf=[]}}();S._InstancesBatch=e;var t=function(T){function y(t,r,o,i,a,n){void 0===r&&(r=null),void 0===o&&(o=null),void 0===i&&(i=null),void 0===n&&(n=!0);var s=T.call(this,t,r)||this;if(s.onBeforeRenderObservable=new S.Observable,s.onAfterRenderObservable=new S.Observable,s.onBeforeDrawObservable=new S.Observable,s.delayLoadState=S.Engine.DELAYLOADSTATE_NONE,s.instances=[],s._LODLevels=[],s._visibleInstances={},s._renderIdForInstances=[],s._batchCache=new e,s._instancesBufferSize=2048,s._originalBuilderSideOrientation=y._DEFAULTSIDE,s.overrideMaterialSideOrientation=null,s._areNormalsFrozen=!1,s._source=null,r=s.getScene(),i){s._source=i,i._geometry&&i._geometry.applyToMesh(s),S.Tools.DeepCopy(i,s,['name','material','skeleton','instances','parent','uniqueId','source','metadata','hasLODLevels','geometry','isBlocked','areNormalsFrozen'],['_poseMatrix','_source']),s.metadata=i.metadata&&i.metadata.clone?i.metadata.clone():i.metadata,S.Tags&&S.Tags.HasTags(i)&&S.Tags.AddTagsTo(s,S.Tags.GetTags(i,!0)),s.parent=i.parent,s.setPivotMatrix(i.getPivotMatrix()),s.id=t+'.'+i.id,s.material=i.material;var c;if(!a)for(var u=i.getDescendants(!0),f=0,d;f<u.length;f++)d=u[f],d.clone&&d.clone(t+'.'+d.name,s);var p=s.getScene().getPhysicsEngine();if(n&&p){var _=p.getImpostorForPhysicsObject(i);_&&(s.physicsImpostor=_.clone(s))}for(c=0;c<r.particleSystems.length;c++){var m=r.particleSystems[c];m.emitter===i&&m.clone(m.name,s)}s.computeWorldMatrix(!0)}return null!==o&&(s.parent=o),s}return h(y,T),Object.defineProperty(y,'FRONTSIDE',{get:function(){return y._FRONTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(y,'BACKSIDE',{get:function(){return y._BACKSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(y,'DOUBLESIDE',{get:function(){return y._DOUBLESIDE},enumerable:!0,configurable:!0}),Object.defineProperty(y,'DEFAULTSIDE',{get:function(){return y._DEFAULTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(y,'NO_CAP',{get:function(){return y._NO_CAP},enumerable:!0,configurable:!0}),Object.defineProperty(y,'CAP_START',{get:function(){return y._CAP_START},enumerable:!0,configurable:!0}),Object.defineProperty(y,'CAP_END',{get:function(){return y._CAP_END},enumerable:!0,configurable:!0}),Object.defineProperty(y,'CAP_ALL',{get:function(){return y._CAP_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'onBeforeDraw',{set:function(t){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'morphTargetManager',{get:function(){return this._morphTargetManager},set:function(t){this._morphTargetManager!==t&&(this._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'source',{get:function(){return this._source},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'isUnIndexed',{get:function(){return this._unIndexed},set:function(t){this._unIndexed!==t&&(this._unIndexed=t,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),y.prototype.getClassName=function(){return'Mesh'},y.prototype.toString=function(e){var t=T.prototype.toString.call(this,e);if(t+=', n vertices: '+this.getTotalVertices(),t+=', parent: '+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:'NONE'),this.animations)for(var r=0;r<this.animations.length;r++)t+=', animation[0]: '+this.animations[r].toString(e);if(e)if(this._geometry){var i=this.getIndices(),o=this.getVerticesData(S.VertexBuffer.PositionKind);o&&i&&(t+=', flat shading: '+(o.length/3===i.length?'YES':'NO'))}else t+=', flat shading: UNKNOWN';return t},y.prototype._unBindEffect=function(){T.prototype._unBindEffect.call(this);for(var r=0,e=this.instances;r<e.length;r++)e[r]._unBindEffect()},Object.defineProperty(y.prototype,'hasLODLevels',{get:function(){return 0<this._LODLevels.length},enumerable:!0,configurable:!0}),y.prototype.getLODLevels=function(){return this._LODLevels},y.prototype._sortLODLevels=function(){this._LODLevels.sort(function(r,e){return r.distance<e.distance?1:r.distance>e.distance?-1:0})},y.prototype.addLODLevel=function(e,t){if(t&&t._masterMesh)return S.Tools.Warn('You cannot use a mesh as LOD level twice'),this;var o=new S.MeshLODLevel(e,t);return this._LODLevels.push(o),t&&(t._masterMesh=this),this._sortLODLevels(),this},y.prototype.getLODLevelAtDistance=function(r){for(var e=0,t;e<this._LODLevels.length;e++)if(t=this._LODLevels[e],t.distance===r)return t.mesh;return null},y.prototype.removeLODLevel=function(r){for(var e=0;e<this._LODLevels.length;e++)this._LODLevels[e].mesh===r&&(this._LODLevels.splice(e,1),r&&(r._masterMesh=null));return this._sortLODLevels(),this},y.prototype.getLOD=function(a,e){if(!this._LODLevels||0===this._LODLevels.length)return this;var t=e?e:this.getBoundingInfo().boundingSphere;var i=t.centerWorld.subtract(a.globalPosition).length();if(this._LODLevels[this._LODLevels.length-1].distance>i)return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this._LODLevels[this._LODLevels.length-1].mesh),this;for(var r=0,n;r<this._LODLevels.length;r++)if(n=this._LODLevels[r],n.distance<i)return n.mesh&&(n.mesh._preActivate(),n.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)),this.onLODLevelSelection&&this.onLODLevelSelection(i,this,n.mesh),n.mesh;return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this),this},Object.defineProperty(y.prototype,'geometry',{get:function(){return this._geometry},enumerable:!0,configurable:!0}),y.prototype.getTotalVertices=function(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()},y.prototype.getVerticesData=function(r,e,t){return this._geometry?this._geometry.getVerticesData(r,e,t):null},y.prototype.getVertexBuffer=function(t){return this._geometry?this._geometry.getVertexBuffer(t):null},y.prototype.isVerticesDataPresent=function(t){return this._geometry?this._geometry.isVerticesDataPresent(t):!!this._delayInfo&&-1!==this._delayInfo.indexOf(t)},y.prototype.isVertexBufferUpdatable=function(t){return this._geometry?this._geometry.isVertexBufferUpdatable(t):!!this._delayInfo&&-1!==this._delayInfo.indexOf(t)},y.prototype.getVerticesDataKinds=function(){if(!this._geometry){var r=[];return this._delayInfo&&this._delayInfo.forEach(function(e){r.push(e)}),r}return this._geometry.getVerticesDataKinds()},y.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},y.prototype.getIndices=function(t){return this._geometry?this._geometry.getIndices(t):[]},Object.defineProperty(y.prototype,'isBlocked',{get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh},enumerable:!0,configurable:!0}),y.prototype.isReady=function(e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!1),this.delayLoadState===S.Engine.DELAYLOADSTATE_LOADING)return!1;if(!T.prototype.isReady.call(this,e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;var r=this.getEngine(),n=this.getScene(),o=i||r.getCaps().instancedArrays&&0<this.instances.length;this.computeWorldMatrix();var s=this.material||n.defaultMaterial;if(s)if(s.storeEffectOnSubMeshes)for(var a=0,l=this.subMeshes;a<l.length;a++){var h=l[a],c=h.getMaterial();if(c)if(c.storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,h,o))return!1;}else if(!c.isReady(this,o))return!1}else if(!s.isReady(this,o))return!1;for(var u=0,f=this._lightSources;u<f.length;u++){var d=f[u],p=d.getShadowGenerator();if(p)for(var _=0,m=this.subMeshes,h;_<m.length;_++)if(h=m[_],!p.isReady(h,o))return!1}for(var g=0,x=this._LODLevels,y;g<x.length;g++)if(y=x[g],y.mesh&&!y.mesh.isReady(o))return!1;return!0},Object.defineProperty(y.prototype,'areNormalsFrozen',{get:function(){return this._areNormalsFrozen},enumerable:!0,configurable:!0}),y.prototype.freezeNormals=function(){return this._areNormalsFrozen=!0,this},y.prototype.unfreezeNormals=function(){return this._areNormalsFrozen=!1,this},Object.defineProperty(y.prototype,'overridenInstanceCount',{set:function(t){this._overridenInstanceCount=t},enumerable:!0,configurable:!0}),y.prototype._preActivate=function(){var t=this.getScene().getRenderId();return this._preActivateId===t?this:(this._preActivateId=t,this._visibleInstances=null,this)},y.prototype._preActivateForIntermediateRendering=function(t){return this._visibleInstances&&(this._visibleInstances.intermediateDefaultRenderId=t),this},y.prototype._registerInstanceForRenderId=function(r,e){return this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=e,this._visibleInstances.selfDefaultRenderId=this._renderId),this._visibleInstances[e]||(this._visibleInstances[e]=[]),this._visibleInstances[e].push(r),this},y.prototype.refreshBoundingInfo=function(){return this._refreshBoundingInfo(!1)},y.prototype._refreshBoundingInfo=function(e){if(this._boundingInfo&&this._boundingInfo.isLocked)return this;var t=this._getPositionData(e);if(t){var o=S.Tools.ExtractMinAndMax(t,0,this.getTotalVertices());this._boundingInfo=new S.BoundingInfo(o.minimum,o.maximum)}if(this.subMeshes)for(var r=0;r<this.subMeshes.length;r++)this.subMeshes[r].refreshBoundingInfo();return this._updateBoundingInfo(),this},y.prototype._getPositionData=function(e){var t=this.getVerticesData(S.VertexBuffer.PositionKind);if(t&&e&&this.skeleton){t=S.Tools.Slice(t);var i=this.getVerticesData(S.VertexBuffer.MatricesIndicesKind),r=this.getVerticesData(S.VertexBuffer.MatricesWeightsKind);if(r&&i)for(var n=4<this.numBoneInfluencers,o=n?this.getVerticesData(S.VertexBuffer.MatricesIndicesExtraKind):null,s=n?this.getVerticesData(S.VertexBuffer.MatricesWeightsExtraKind):null,a=this.skeleton.getTransformMatrices(this),l=S.Tmp.Vector3[0],m=S.Tmp.Matrix[0],c=S.Tmp.Matrix[1],u=0,f=0;f<t.length;f+=3,u+=4){m.reset();var d,p;for(d=0;4>d&&!(0>=(p=r[u+d]));d++)S.Matrix.FromFloat32ArrayToRefScaled(a,ee(16*i[u+d]),p,c),m.addToSelf(c);if(n)for(d=0;4>d&&!(0>=(p=s[u+d]));d++)S.Matrix.FromFloat32ArrayToRefScaled(a,ee(16*o[u+d]),p,c),m.addToSelf(c);S.Vector3.TransformCoordinatesFromFloatsToRef(t[f],t[f+1],t[f+2],m,l),l.toArray(t,f)}}return t},y.prototype._createGlobalSubMesh=function(e){var t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&0<this.subMeshes.length){var d=this.getIndices();if(!d)return null;var c=d.length,n=!1;if(e)n=!0;else for(var p=0,s=this.subMeshes,a;p<s.length;p++){if(a=s[p],a.indexStart+a.indexCount>=c){n=!0;break}if(a.verticesStart+a.verticesCount>=t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new S.SubMesh(0,0,t,0,this.getTotalIndices(),this)},y.prototype.subdivide=function(e){if(!(1>e)){for(var t=this.getTotalIndices(),i=0|t/e,r=0;0!=i%3;)i++;this.releaseSubMeshes();for(var a=0;a<e&&!(r>=t);a++)S.SubMesh.CreateFromIndices(0,r,C(i,t-r),this),r+=i;this.synchronizeInstances()}},y.prototype.setVerticesData=function(e,t,i,r){if(void 0===i&&(i=!1),this._geometry)this._geometry.setVerticesData(e,t,i,r);else{var a=new S.VertexData;a.set(t,e);var o=this.getScene();new S.Geometry(S.Geometry.RandomId(),o,a,i,this)}return this},y.prototype.markVerticesDataAsUpdatable=function(r,e){void 0===e&&(e=!0);var t=this.getVertexBuffer(r);t&&t.isUpdatable()!==e&&this.setVerticesData(r,this.getVerticesData(r),e)},y.prototype.setVerticesBuffer=function(e){return this._geometry||(this._geometry=S.Geometry.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e),this},y.prototype.updateVerticesData=function(o,e,t,i){return this._geometry?(i?(this.makeGeometryUnique(),this.updateVerticesData(o,e,t,!1)):this._geometry.updateVerticesData(o,e,t),this):this},y.prototype.updateMeshPositions=function(e,t){void 0===t&&(t=!0);var i=this.getVerticesData(S.VertexBuffer.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(S.VertexBuffer.PositionKind,i,!1,!1),t){var a=this.getIndices(),n=this.getVerticesData(S.VertexBuffer.NormalKind);if(!n)return this;S.VertexData.ComputeNormals(i,a,n),this.updateVerticesData(S.VertexBuffer.NormalKind,n,!1,!1)}return this},y.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;var e=this._geometry,t=this._geometry.copy(S.Geometry.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this},y.prototype.setIndices=function(e,t,i){if(void 0===t&&(t=null),void 0===i&&(i=!1),this._geometry)this._geometry.setIndices(e,t,i);else{var r=new S.VertexData;r.indices=e;var a=this.getScene();new S.Geometry(S.Geometry.RandomId(),a,r,i,this)}return this},y.prototype.updateIndices=function(r,e){return this._geometry?(this._geometry.updateIndices(r,e),this):this},y.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},y.prototype._bind=function(e,t,i){if(!this._geometry)return this;var r=this.getScene().getEngine(),o;if(this._unIndexed)o=null;else switch(i){case S.Material.PointFillMode:o=null;break;case S.Material.WireFrameFillMode:o=e.getLinesIndexBuffer(this.getIndices(),r);break;default:case S.Material.TriangleFillMode:o=this._unIndexed?null:this._geometry.getIndexBuffer();}return this._geometry._bind(t,o),this},y.prototype._draw=function(e,t,i,r){if(void 0===r&&(r=!1),!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this.onBeforeDrawObservable.notifyObservers(this);var l=this.getScene(),o=l.getEngine();if(this._unIndexed||t==S.Material.PointFillMode?o.drawArraysType(t,e.verticesStart,e.verticesCount,i):t==S.Material.WireFrameFillMode?o.drawElementsType(t,0,e.linesIndexCount,i):o.drawElementsType(t,e.indexStart,e.indexCount,i),l._isAlternateRenderingEnabled&&!r){var s=e.effect||this._effectiveMaterial.getEffect();if(!s||!l.activeCamera)return this;l._switchToAlternateCameraConfiguration(!0),this._effectiveMaterial.bindView(s),this._effectiveMaterial.bindViewProjection(s),o.setViewport(l.activeCamera._alternateCamera.viewport),this._draw(e,t,i,!0),o.setViewport(l.activeCamera.viewport),l._switchToAlternateCameraConfiguration(!1),this._effectiveMaterial.bindView(s),this._effectiveMaterial.bindViewProjection(s)}return this},y.prototype.registerBeforeRender=function(t){return this.onBeforeRenderObservable.add(t),this},y.prototype.unregisterBeforeRender=function(t){return this.onBeforeRenderObservable.removeCallback(t),this},y.prototype.registerAfterRender=function(t){return this.onAfterRenderObservable.add(t),this},y.prototype.unregisterAfterRender=function(t){return this.onAfterRenderObservable.removeCallback(t),this},y.prototype._getInstancesRenderList=function(a){var e=this.getScene();if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf[a]=this.isEnabled()&&this.isVisible,this._batchCache.visibleInstances[a]=null,this._visibleInstances){var t=e.getRenderId(),i=e._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId;this._batchCache.visibleInstances[a]=this._visibleInstances[t];var r=this._renderId;!this._batchCache.visibleInstances[a]&&i&&(this._batchCache.visibleInstances[a]=this._visibleInstances[i],t=W(i,t),r=W(this._visibleInstances.selfDefaultRenderId,t));var n=this._batchCache.visibleInstances[a];if(n&&n.length){if(this._renderIdForInstances[a]===t)return this._batchCache.mustReturn=!0,this._batchCache;t!==r&&(this._batchCache.renderSelf[a]=!1)}this._renderIdForInstances[a]=t}return this._batchCache},y.prototype._renderWithInstances=function(e,t,i,r,n){var o=i.visibleInstances[e._id];if(!o)return this;for(var l=o.length+1,a=this._instancesBufferSize,m=this._instancesBuffer;this._instancesBufferSize<4*(16*l);)this._instancesBufferSize*=2;this._instancesData&&a==this._instancesBufferSize||(this._instancesData=new Float32Array(this._instancesBufferSize/4));var c=0,u=0,f=this.getWorldMatrix();if(i.renderSelf[e._id]&&(f.copyToArray(this._instancesData,c),c+=16,u++),o)for(var d=0,p;d<o.length;d++)p=o[d],p.getWorldMatrix().copyToArray(this._instancesData,c),c+=16,u++;return m&&a==this._instancesBufferSize?m.updateDirectly(this._instancesData,0,u):(m&&m.dispose(),m=new S.Buffer(n,this._instancesData,!0,16,!1,!0),this._instancesBuffer=m,this.setVerticesBuffer(m.createVertexBuffer('world0',0,4)),this.setVerticesBuffer(m.createVertexBuffer('world1',4,4)),this.setVerticesBuffer(m.createVertexBuffer('world2',8,4)),this.setVerticesBuffer(m.createVertexBuffer('world3',12,4))),this._bind(e,r,t),this._draw(e,t,u),n.unbindInstanceAttributes(),this},y.prototype._processRendering=function(d,e,t,i,r,n,o){var s=this.getScene(),a=s.getEngine();if(r)this._renderWithInstances(d,t,i,e,a);else{i.renderSelf[d._id]&&(n&&n(!1,this.getWorldMatrix(),o),this._draw(d,t,this._overridenInstanceCount));var l=i.visibleInstances[d._id];if(l)for(var p=0;p<l.length;p++){var c=l[p],u=c.getWorldMatrix();n&&n(!0,u,o),this._draw(d,t)}}return this},y.prototype.render=function(e,t){if(this._checkOcclusionQuery(),this._isOccluded)return this;var i=this.getScene(),r=this._getInstancesRenderList(e._id);if(r.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this.onBeforeRenderObservable.notifyObservers(this);var n=i.getEngine(),o=n.getCaps().instancedArrays&&null!==r.visibleInstances[e._id]&&void 0!==r.visibleInstances[e._id],s=e.getMaterial();if(!s)return this;if(this._effectiveMaterial=s,this._effectiveMaterial.storeEffectOnSubMeshes){if(!this._effectiveMaterial.isReadyForSubMesh(this,e,o))return this;}else if(!this._effectiveMaterial.isReady(this,o))return this;t&&n.setAlphaMode(this._effectiveMaterial.alphaMode);var _=n.getDepthWrite();this.renderOutline&&(n.setDepthWrite(!1),i.getOutlineRenderer().render(e,r),n.setDepthWrite(_));var l;if(!(l=this._effectiveMaterial.storeEffectOnSubMeshes?e.effect:this._effectiveMaterial.getEffect()))return this;var m=this.overrideMaterialSideOrientation;null==m&&(m=this._effectiveMaterial.sideOrientation,0>this._getWorldMatrixDeterminant()&&(m=m===S.Material.ClockWiseSideOrientation?S.Material.CounterClockWiseSideOrientation:S.Material.ClockWiseSideOrientation));var c=this._effectiveMaterial._preBind(l,m);this._effectiveMaterial.forceDepthWrite&&n.setDepthWrite(!0);var g=i.forcePointsCloud?S.Material.PointFillMode:i.forceWireframe?S.Material.WireFrameFillMode:this._effectiveMaterial.fillMode;o||this._bind(e,l,g);var f=this.getWorldMatrix();if(this._effectiveMaterial.storeEffectOnSubMeshes?this._effectiveMaterial.bindForSubMesh(f,this,e):this._effectiveMaterial.bind(f,this),!this._effectiveMaterial.backFaceCulling&&this._effectiveMaterial.separateCullingPass&&(n.setState(!0,this._effectiveMaterial.zOffset,!1,!c),this._processRendering(e,l,g,r,o,this._onBeforeDraw,this._effectiveMaterial),n.setState(!0,this._effectiveMaterial.zOffset,!1,c)),this._processRendering(e,l,g,r,o,this._onBeforeDraw,this._effectiveMaterial),this._effectiveMaterial.unbind(),this.renderOutline&&_&&(n.setDepthWrite(!0),n.setColorWrite(!1),i.getOutlineRenderer().render(e,r),n.setColorWrite(!0)),this.renderOverlay){var d=n.getAlphaMode();n.setAlphaMode(S.Engine.ALPHA_COMBINE),i.getOutlineRenderer().render(e,r,!0),n.setAlphaMode(d)}return this.onAfterRenderObservable.notifyObservers(this),this},y.prototype._onBeforeDraw=function(r,e,t){r&&t&&t.bindOnlyWorldMatrix(e)},y.prototype.getEmittedParticleSystems=function(){for(var r=[],e=0,t;e<this.getScene().particleSystems.length;e++)t=this.getScene().particleSystems[e],t.emitter===this&&r.push(t);return r},y.prototype.getHierarchyEmittedParticleSystems=function(){var o=[],e=this.getDescendants();e.push(this);for(var t=0;t<this.getScene().particleSystems.length;t++){var i=this.getScene().particleSystems[t],r=i.emitter;r.position&&-1!==e.indexOf(r)&&o.push(i)}return o},y.prototype.cleanMatrixWeights=function(){var e=0;if(this.skeleton){e=this.skeleton.bones.length;for(var t=this.getVerticesData(S.VertexBuffer.MatricesIndicesKind),i=this.getVerticesData(S.VertexBuffer.MatricesIndicesExtraKind),r=this.getVerticesData(S.VertexBuffer.MatricesWeightsKind),n=this.getVerticesData(S.VertexBuffer.MatricesWeightsExtraKind),o=this.numBoneInfluencers,s=r.length,a=0;a<s;a+=4){for(var l=0,p=-1,c=0,u;4>c;c++)u=r[a+c],l+=u,.001>u&&0>p&&(p=c);if(n)for(var c=0,u;4>c;c++)u=n[a+c],l+=u,.001>u&&0>p&&(p=c+4);if((0>p||p>o-1)&&(p=o-1),.001<l){for(var f=1/l,c=0;4>c;c++)r[a+c]*=f;if(n)for(var c=0;4>c;c++)n[a+c]*=f}else 4<=p?(n[a+p-4]=1-l,i[a+p-4]=e):(r[a+p]=1-l,t[a+p]=e)}this.setVerticesData(S.VertexBuffer.MatricesIndicesKind,t),i&&this.setVerticesData(S.VertexBuffer.MatricesIndicesExtraKind,i),this.setVerticesData(S.VertexBuffer.MatricesWeightsKind,r),n&&this.setVerticesData(S.VertexBuffer.MatricesWeightsExtraKind,n)}},y.prototype._checkDelayState=function(){var e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===S.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=S.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(e)),this},y.prototype._queueLoad=function(e){var t=this;e._addPendingData(this);var o=-1!==this.delayLoadingFile.indexOf('.babylonbinarymeshdata');return S.Tools.LoadFile(this.delayLoadingFile,function(o){o instanceof ArrayBuffer?t._delayLoadingFunction(o,t):t._delayLoadingFunction(JSON.parse(o),t),t.instances.forEach(function(t){t._syncSubMeshes()}),t.delayLoadState=S.Engine.DELAYLOADSTATE_LOADED,e._removePendingData(t)},function(){},e.database,o),this},y.prototype.isInFrustum=function(e){return this.delayLoadState!==S.Engine.DELAYLOADSTATE_LOADING&&!!T.prototype.isInFrustum.call(this,e)&&(this._checkDelayState(),!0)},y.prototype.setMaterialByID=function(o){var e=this.getScene().materials,i;for(i=e.length-1;-1<i;i--)if(e[i].id===o)return this.material=e[i],this;var t=this.getScene().multiMaterials;for(i=t.length-1;-1<i;i--)if(t[i].id===o)return this.material=t[i],this;return this},y.prototype.getAnimatables=function(){var t=[];return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t},y.prototype.bakeTransformIntoVertices=function(e){if(!this.isVerticesDataPresent(S.VertexBuffer.PositionKind))return this;var t=this.subMeshes.splice(0);this._resetPointsArrayCache();var i=this.getVerticesData(S.VertexBuffer.PositionKind),a=[],o;for(o=0;o<i.length;o+=3)S.Vector3.TransformCoordinates(S.Vector3.FromArray(i,o),e).toArray(a,o);if(this.setVerticesData(S.VertexBuffer.PositionKind,a,this.getVertexBuffer(S.VertexBuffer.PositionKind).isUpdatable()),!this.isVerticesDataPresent(S.VertexBuffer.NormalKind))return this;for(i=this.getVerticesData(S.VertexBuffer.NormalKind),a=[],o=0;o<i.length;o+=3)S.Vector3.TransformNormal(S.Vector3.FromArray(i,o),e).normalize().toArray(a,o);return this.setVerticesData(S.VertexBuffer.NormalKind,a,this.getVertexBuffer(S.VertexBuffer.NormalKind).isUpdatable()),0>e.m[0]*e.m[5]*e.m[10]&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this},y.prototype.bakeCurrentTransformIntoVertices=function(){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=S.Quaternion.Identity()),this._worldMatrix=S.Matrix.Identity(),this},Object.defineProperty(y.prototype,'_positions',{get:function(){return this._geometry?this._geometry._positions:null},enumerable:!0,configurable:!0}),y.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},y.prototype._generatePointsArray=function(){return!!this._geometry&&this._geometry._generatePointsArray()},y.prototype.clone=function(r,e,t,o){return void 0===o&&(o=!0),new y(r,this.getScene(),e,this,t,o)},y.prototype.dispose=function(i,e){var l=this;void 0===e&&(e=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var t=this.getScene().meshes;for(t.forEach(function(r){var e=r;e._source&&e._source===l&&(e._source=null)}),this._source=null,this._instancesBuffer&&(this._instancesBuffer.dispose(),this._instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var r=this.getScene().effectLayers,o=0,n;o<r.length;o++)n=r[o],n&&n._disposeMesh(this);T.prototype.dispose.call(this,i,e)},y.prototype.applyDisplacementMap=function(e,d,i,r,n,o){var s=this,t=this.getScene();return S.Tools.LoadImage(e,function(a){var e=document.createElement('canvas'),t=e.getContext('2d'),l=a.width,p=a.height;e.width=l,e.height=p,t.drawImage(a,0,0);var c=t.getImageData(0,0,l,p).data;s.applyDisplacementMapFromBuffer(c,l,p,d,i,n,o),r&&r(s)},function(){},t.database),this},y.prototype.applyDisplacementMapFromBuffer=function(e,t,i,r,n,o,s){if(!this.isVerticesDataPresent(S.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(S.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(S.VertexBuffer.UVKind))return S.Tools.Warn('Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing'),this;var a=this.getVerticesData(S.VertexBuffer.PositionKind),l=this.getVerticesData(S.VertexBuffer.NormalKind),h=this.getVerticesData(S.VertexBuffer.UVKind),c=S.Vector3.Zero(),u=S.Vector3.Zero(),f=S.Vector2.Zero();o=o||S.Vector2.Zero(),s=s||new S.Vector2(1,1);for(var d=0;d<a.length;d+=3){S.Vector3.FromArrayToRef(a,d,c),S.Vector3.FromArrayToRef(l,d,u),S.Vector2.FromArrayToRef(h,2*(d/3),f);var p=0|A(f.x*s.x+o.x)*t%t,_=0|A(f.y*s.y+o.y)*i%i,m=4*(p+_*t),g=e[m]/255,T=e[m+1]/255,y=e[m+2]/255;u.normalize(),u.scaleInPlace(r+(n-r)*(.3*g+.59*T+.11*y)),c=c.add(u),c.toArray(a,d)}return S.VertexData.ComputeNormals(a,this.getIndices(),l),this.updateVerticesData(S.VertexBuffer.PositionKind,a),this.updateVerticesData(S.VertexBuffer.NormalKind,l),this},y.prototype.convertToFlatShadedMesh=function(){var e=this.getVerticesDataKinds(),r={},n={},o={},s=!1,a,t;for(a=0;a<e.length;a++){t=e[a];var i=this.getVertexBuffer(t);t===S.VertexBuffer.NormalKind?(s=i.isUpdatable(),e.splice(a,1),a--):(r[t]=i,n[t]=r[t].getData(),o[t]=[])}var l=this.subMeshes.slice(0),c=this.getIndices(),u=this.getTotalIndices(),f;for(f=0;f<u;f++){var h=c[f];for(a=0;a<e.length;a++){t=e[a];for(var d=r[t].getStrideSize(),p=0;p<d;p++)o[t].push(n[t][h*d+p])}}var _=[],m=o[S.VertexBuffer.PositionKind];for(f=0;f<u;f+=3){c[f]=f,c[f+1]=f+1,c[f+2]=f+2;for(var g=S.Vector3.FromArray(m,3*f),v=S.Vector3.FromArray(m,3*(f+1)),y=S.Vector3.FromArray(m,3*(f+2)),b=g.subtract(v),x=y.subtract(v),T=S.Vector3.Normalize(S.Vector3.Cross(b,x)),E=0;3>E;E++)_.push(T.x),_.push(T.y),_.push(T.z)}for(this.setIndices(c),this.setVerticesData(S.VertexBuffer.NormalKind,_,s),a=0;a<e.length;a++)t=e[a],this.setVerticesData(t,o[t],r[t].isUpdatable());this.releaseSubMeshes();for(var P=0,A;P<l.length;P++)A=l[P],S.SubMesh.AddToMesh(A.materialIndex,A.indexStart,A.indexCount,A.indexStart,A.indexCount,this);return this.synchronizeInstances(),this},y.prototype.convertToUnIndexedMesh=function(){var e=this.getVerticesDataKinds(),r={},n={},o={},s,t;for(s=0;s<e.length;s++){t=e[s];var i=this.getVertexBuffer(t);r[t]=i,n[t]=r[t].getData(),o[t]=[]}var a=this.subMeshes.slice(0),g=this.getIndices(),c=this.getTotalIndices(),u;for(u=0;u<c;u++){var l=g[u];for(s=0;s<e.length;s++){t=e[s];for(var f=r[t].getStrideSize(),d=0;d<f;d++)o[t].push(n[t][l*f+d])}}for(u=0;u<c;u+=3)g[u]=u,g[u+1]=u+1,g[u+2]=u+2;for(this.setIndices(g),s=0;s<e.length;s++)t=e[s],this.setVerticesData(t,o[t],r[t].isUpdatable());this.releaseSubMeshes();for(var p=0,_;p<a.length;p++)_=a[p],S.SubMesh.AddToMesh(_.materialIndex,_.indexStart,_.indexCount,_.indexStart,_.indexCount,this);return this._unIndexed=!0,this.synchronizeInstances(),this},y.prototype.flipFaces=function(e){void 0===e&&(e=!1);var t=S.VertexData.ExtractFromMesh(this),r;if(e&&this.isVerticesDataPresent(S.VertexBuffer.NormalKind)&&t.normals)for(r=0;r<t.normals.length;r++)t.normals[r]*=-1;if(t.indices){var o;for(r=0;r<t.indices.length;r+=3)o=t.indices[r+1],t.indices[r+1]=t.indices[r+2],t.indices[r+2]=o}return t.applyToMesh(this),this},y.prototype.createInstance=function(e){return new S.InstancedMesh(e,this)},y.prototype.synchronizeInstances=function(){for(var t=0;t<this.instances.length;t++)this.instances[t]._syncSubMeshes();return this},y.prototype.simplify=function(e,o,a,s){return void 0===o&&(o=!0),void 0===a&&(a=S.SimplificationType.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:o,mesh:this,simplificationType:a,successCallback:s}),this},y.prototype.optimizeIndices=function(l){var t=this,i=this.getIndices(),e=this.getVerticesData(S.VertexBuffer.PositionKind);if(!e||!i)return this;for(var d=[],o=0;o<e.length;o+=3)d.push(S.Vector3.FromArray(e,o));var s=[];return S.AsyncLoop.SyncAsyncForLoop(d.length,40,function(o){for(var e=d.length-1-o,t=d[e],i=0,r;i<e;++i)if(r=d[i],t.equals(r)){s[e]=i;break}},function(){for(var r=0;r<i.length;++r)i[r]=s[i[r]]||i[r];var e=t.subMeshes.slice(0);t.setIndices(i),t.subMeshes=e,l&&l(t)}),this},y.prototype.serialize=function(e){e.name=this.name,e.id=this.id,e.type=this.getClassName(),S.Tags&&S.Tags.HasTags(this)&&(e.tags=S.Tags.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,this.parent&&(e.parentId=this.parent.id),e.isUnIndexed=this.isUnIndexed;var t=this._geometry;if(t){var i=t.id;e.geometryId=i,e.subMeshes=[];for(var r=0,n;r<this.subMeshes.length;r++)n=this.subMeshes[r],e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}this.material?e.materialId=this.material.id:this.material=null,this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id);var o=this.getPhysicsImpostor();o&&(e.physicsMass=o.getParam('mass'),e.physicsFriction=o.getParam('friction'),e.physicsRestitution=o.getParam('mass'),e.physicsImpostor=o.type),this.metadata&&(e.metadata=this.metadata),e.instances=[];for(var s=0;s<this.instances.length;s++){var a=this.instances[s],l={name:a.name,id:a.id,position:a.position.asArray(),scaling:a.scaling.asArray()};a.rotationQuaternion?l.rotationQuaternion=a.rotationQuaternion.asArray():a.rotation&&(l.rotation=a.rotation.asArray()),e.instances.push(l),S.Animation.AppendSerializedAnimations(a,l),l.ranges=a.serializeAnimationRanges()}S.Animation.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name))},y.prototype._syncGeometryWithMorphTargetManager=function(){if(this.geometry){this._markSubMeshesAsAttributesDirty();var e=this._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return S.Tools.Error('Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count.'),void(this.morphTargetManager=null);for(var t=0;t<e.numInfluencers;t++){var i=e.getActiveTarget(t),r=i.getPositions();if(!r)return void S.Tools.Error('Invalid morph target. Target must have positions.');this.geometry.setVerticesData(S.VertexBuffer.PositionKind+t,r,!1,3);var a=i.getNormals();a&&this.geometry.setVerticesData(S.VertexBuffer.NormalKind+t,a,!1,3);var o=i.getTangents();o&&this.geometry.setVerticesData(S.VertexBuffer.TangentKind+t,o,!1,3)}}else for(var t=0;this.geometry.isVerticesDataPresent(S.VertexBuffer.PositionKind+t);)this.geometry.removeVerticesData(S.VertexBuffer.PositionKind+t),this.geometry.isVerticesDataPresent(S.VertexBuffer.NormalKind+t)&&this.geometry.removeVerticesData(S.VertexBuffer.NormalKind+t),this.geometry.isVerticesDataPresent(S.VertexBuffer.TangentKind+t)&&this.geometry.removeVerticesData(S.VertexBuffer.TangentKind+t),t++}},y.Parse=function(e,t,r){var i;if(i=e.type&&'GroundMesh'===e.type?S.GroundMesh.Parse(e,t):new y(e.name,t),i.id=e.id,S.Tags&&S.Tags.AddTagsTo(i,e.tags),i.position=S.Vector3.FromArray(e.position),void 0!==e.metadata&&(i.metadata=e.metadata),e.rotationQuaternion?i.rotationQuaternion=S.Quaternion.FromArray(e.rotationQuaternion):e.rotation&&(i.rotation=S.Vector3.FromArray(e.rotation)),i.scaling=S.Vector3.FromArray(e.scaling),e.localMatrix?i.setPreTransformMatrix(S.Matrix.FromArray(e.localMatrix)):e.pivotMatrix&&i.setPivotMatrix(S.Matrix.FromArray(e.pivotMatrix)),i.setEnabled(e.isEnabled),i.isVisible=e.isVisible,i.infiniteDistance=e.infiniteDistance,i.showBoundingBox=e.showBoundingBox,i.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(i.applyFog=e.applyFog),void 0!==e.pickable&&(i.isPickable=e.pickable),void 0!==e.alphaIndex&&(i.alphaIndex=e.alphaIndex),i.receiveShadows=e.receiveShadows,i.billboardMode=e.billboardMode,void 0!==e.visibility&&(i.visibility=e.visibility),i.checkCollisions=e.checkCollisions,void 0!==e.isBlocker&&(i.isBlocker=e.isBlocker),i._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(i._waitingFreezeWorldMatrix=e.freezeWorldMatrix),e.parentId&&(i._waitingParentId=e.parentId),void 0!==e.actions&&(i._waitingActions=e.actions),void 0!==e.overlayAlpha&&(i.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(i.overlayColor=S.Color3.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(i.renderOverlay=e.renderOverlay),i.isUnIndexed=!!e.isUnIndexed,i.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(i.delayLoadState=S.Engine.DELAYLOADSTATE_NOTLOADED,i.delayLoadingFile=r+e.delayLoadingFile,i._boundingInfo=new S.BoundingInfo(S.Vector3.FromArray(e.boundingBoxMinimum),S.Vector3.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(i._binaryInfo=e._binaryInfo),i._delayInfo=[],e.hasUVs&&i._delayInfo.push(S.VertexBuffer.UVKind),e.hasUVs2&&i._delayInfo.push(S.VertexBuffer.UV2Kind),e.hasUVs3&&i._delayInfo.push(S.VertexBuffer.UV3Kind),e.hasUVs4&&i._delayInfo.push(S.VertexBuffer.UV4Kind),e.hasUVs5&&i._delayInfo.push(S.VertexBuffer.UV5Kind),e.hasUVs6&&i._delayInfo.push(S.VertexBuffer.UV6Kind),e.hasColors&&i._delayInfo.push(S.VertexBuffer.ColorKind),e.hasMatricesIndices&&i._delayInfo.push(S.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&i._delayInfo.push(S.VertexBuffer.MatricesWeightsKind),i._delayLoadingFunction=S.Geometry._ImportGeometry,S.SceneLoader.ForceFullSceneLoadingForIncremental&&i._checkDelayState()):S.Geometry._ImportGeometry(e,i),e.materialId?i.setMaterialByID(e.materialId):i.material=null,-1<e.morphTargetManagerId&&(i.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),-1<e.skeletonId&&(i.skeleton=t.getLastSkeletonByID(e.skeletonId),e.numBoneInfluencers&&(i.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var o=0,n;o<e.animations.length;o++)n=e.animations[o],i.animations.push(S.Animation.Parse(n));S.Node.ParseAnimationRanges(i,e,t)}if(e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i.layerMask=e.layerMask&&!isNaN(e.layerMask)?A(parseInt(e.layerMask)):268435455,e.physicsImpostor&&(i.physicsImpostor=new S.PhysicsImpostor(i,e.physicsImpostor,{mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution},t)),e.instances)for(var a=0;a<e.instances.length;a++){var s=e.instances[a],l=i.createInstance(s.name);if(s.id&&(l.id=s.id),S.Tags&&S.Tags.AddTagsTo(l,s.tags),l.position=S.Vector3.FromArray(s.position),s.parentId&&(l._waitingParentId=s.parentId),s.rotationQuaternion?l.rotationQuaternion=S.Quaternion.FromArray(s.rotationQuaternion):s.rotation&&(l.rotation=S.Vector3.FromArray(s.rotation)),l.scaling=S.Vector3.FromArray(s.scaling),l.checkCollisions=i.checkCollisions,e.animations){for(o=0;o<e.animations.length;o++)n=e.animations[o],l.animations.push(S.Animation.Parse(n));S.Node.ParseAnimationRanges(l,e,t)}}return i},y.CreateRibbon=function(e,t,d,c,p,u,s,f,_){return void 0===d&&(d=!1),void 0===s&&(s=!1),S.MeshBuilder.CreateRibbon(e,{pathArray:t,closeArray:d,closePath:c,offset:p,updatable:s,sideOrientation:f,instance:_},u)},y.CreateDisc=function(e,t,a,l,n,d){void 0===l&&(l=null);return S.MeshBuilder.CreateDisc(e,{radius:t,tessellation:a,sideOrientation:d,updatable:n},l)},y.CreateBox=function(e,t,a,r,s){void 0===a&&(a=null);return S.MeshBuilder.CreateBox(e,{size:t,sideOrientation:s,updatable:r},a)},y.CreateSphere=function(e,t,a,l,n,d){return S.MeshBuilder.CreateSphere(e,{segments:t,diameterX:a,diameterY:a,diameterZ:a,sideOrientation:d,updatable:n},l)},y.CreateCylinder=function(e,t,r,d,p,f,_,l,m){void 0!==_&&_ instanceof S.Scene||(void 0!==_&&(m=l||y.DEFAULTSIDE,l=_),_=f,f=1);var g={height:t,diameterTop:r,diameterBottom:d,tessellation:p,subdivisions:f,sideOrientation:m,updatable:l};return S.MeshBuilder.CreateCylinder(e,g,_)},y.CreateTorus=function(e,t,l,d,c,o,p){return S.MeshBuilder.CreateTorus(e,{diameter:t,thickness:l,tessellation:d,sideOrientation:p,updatable:o},c)},y.CreateTorusKnot=function(e,t,d,p,u,f,_,m,l,g){return S.MeshBuilder.CreateTorusKnot(e,{radius:t,tube:d,radialSegments:p,tubularSegments:u,p:f,q:_,sideOrientation:g,updatable:l},m)},y.CreateLines=function(e,t,a,r,l){void 0===a&&(a=null),void 0===r&&(r=!1),void 0===l&&(l=null);var d={points:t,updatable:r,instance:l};return S.MeshBuilder.CreateLines(e,d,a)},y.CreateDashedLines=function(e,t,d,c,p,u,s,f){void 0===u&&(u=null);return S.MeshBuilder.CreateDashedLines(e,{points:t,dashSize:d,gapSize:c,dashNb:p,updatable:s,instance:f},u)},y.CreatePolygon=function(e,t,a,r,l,d){return S.MeshBuilder.CreatePolygon(e,{shape:t,holes:r,updatable:l,sideOrientation:d},a)},y.ExtrudePolygon=function(e,t,l,d,n,c,p){return S.MeshBuilder.ExtrudePolygon(e,{shape:t,holes:n,depth:l,updatable:c,sideOrientation:p},d)},y.ExtrudeShape=function(e,t,r,d,p,_,a,l,m,g){void 0===a&&(a=null);var T={shape:t,path:r,scale:d,rotation:p,cap:0===_?0:_||y.NO_CAP,sideOrientation:m,instance:g,updatable:l};return S.MeshBuilder.ExtrudeShape(e,T,a)},y.ExtrudeShapeCustom=function(e,t,r,_,m,g,T,x,h,c,b,E){var v={shape:t,path:r,scaleFunction:_,rotationFunction:m,ribbonCloseArray:g,ribbonClosePath:T,cap:0===x?0:x||y.NO_CAP,sideOrientation:b,instance:E,updatable:c};return S.MeshBuilder.ExtrudeShapeCustom(e,v,h)},y.CreateLathe=function(e,t,l,d,c,o,p){return S.MeshBuilder.CreateLathe(e,{shape:t,radius:l,tessellation:d,sideOrientation:p,updatable:o},c)},y.CreatePlane=function(e,t,a,r,s){return S.MeshBuilder.CreatePlane(e,{size:t,width:t,height:t,sideOrientation:s,updatable:r},a)},y.CreateGround=function(e,t,a,l,d,o){return S.MeshBuilder.CreateGround(e,{width:t,height:a,subdivisions:l,updatable:o},d)},y.CreateTiledGround=function(e,t,d,c,p,u,f,_,l){return S.MeshBuilder.CreateTiledGround(e,{xmin:t,zmin:d,xmax:c,zmax:p,subdivisions:u,precision:f,updatable:l},_)},y.CreateGroundFromHeightMap=function(e,t,i,d,p,u,f,_,l,m){return S.MeshBuilder.CreateGroundFromHeightMap(e,t,{width:i,height:d,subdivisions:p,minHeight:u,maxHeight:f,updatable:l,onReady:m},_)},y.CreateTube=function(e,t,d,p,u,f,_,a,m,g){return S.MeshBuilder.CreateTube(e,{path:t,radius:d,tessellation:p,radiusFunction:u,arc:1,cap:f,updatable:a,sideOrientation:m,instance:g},_)},y.CreatePolyhedron=function(e,t,o){return S.MeshBuilder.CreatePolyhedron(e,t,o)},y.CreateIcoSphere=function(e,t,o){return S.MeshBuilder.CreateIcoSphere(e,t,o)},y.CreateDecal=function(e,t,i,a,l,d){return S.MeshBuilder.CreateDecal(e,t,{position:i,normal:a,size:l,angle:d})},y.prototype.setPositionsForCPUSkinning=function(){if(!this._sourcePositions){var e=this.getVerticesData(S.VertexBuffer.PositionKind);if(!e)return this._sourcePositions;this._sourcePositions=new Float32Array(e),this.isVertexBufferUpdatable(S.VertexBuffer.PositionKind)||this.setVerticesData(S.VertexBuffer.PositionKind,e,!0)}return this._sourcePositions},y.prototype.setNormalsForCPUSkinning=function(){if(!this._sourceNormals){var e=this.getVerticesData(S.VertexBuffer.NormalKind);if(!e)return this._sourceNormals;this._sourceNormals=new Float32Array(e),this.isVertexBufferUpdatable(S.VertexBuffer.NormalKind)||this.setVerticesData(S.VertexBuffer.NormalKind,e,!0)}return this._sourceNormals},y.prototype.applySkeleton=function(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningRenderId==this.getScene().getRenderId())return this;if(this.geometry._softwareSkinningRenderId=this.getScene().getRenderId(),!this.isVerticesDataPresent(S.VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(S.VertexBuffer.NormalKind))return this;if(!this.isVerticesDataPresent(S.VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(S.VertexBuffer.MatricesWeightsKind))return this;if(!this._sourcePositions){var t=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=t}this._sourceNormals||this.setNormalsForCPUSkinning();var i=this.getVerticesData(S.VertexBuffer.PositionKind);if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i));var y=this.getVerticesData(S.VertexBuffer.NormalKind);if(!y)return this;y instanceof Float32Array||(y=new Float32Array(y));var T=this.getVerticesData(S.VertexBuffer.MatricesIndicesKind),x=this.getVerticesData(S.VertexBuffer.MatricesWeightsKind);if(!x||!T)return this;for(var b=4<this.numBoneInfluencers,l=b?this.getVerticesData(S.VertexBuffer.MatricesIndicesExtraKind):null,h=b?this.getVerticesData(S.VertexBuffer.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),u=S.Vector3.Zero(),f=new S.Matrix,d=new S.Matrix,p=0,_=0,m;_<i.length;_+=3,p+=4){var a;for(m=0;4>m&&0<(a=x[p+m]);m++)S.Matrix.FromFloat32ArrayToRefScaled(c,ee(16*T[p+m]),a,d),f.addToSelf(d);if(b)for(m=0;4>m&&0<(a=h[p+m]);m++)S.Matrix.FromFloat32ArrayToRefScaled(c,ee(16*l[p+m]),a,d),f.addToSelf(d);S.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[_],this._sourcePositions[_+1],this._sourcePositions[_+2],f,u),u.toArray(i,_),S.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[_],this._sourceNormals[_+1],this._sourceNormals[_+2],f,u),u.toArray(y,_),f.reset()}return this.updateVerticesData(S.VertexBuffer.PositionKind,i),this.updateVerticesData(S.VertexBuffer.NormalKind,y),this},y.MinMax=function(e){var t=null,a=null;return e.forEach(function(r){var e=r.getBoundingInfo(),o=e.boundingBox;t&&a?(t.minimizeInPlace(o.minimumWorld),a.maximizeInPlace(o.maximumWorld)):(t=o.minimumWorld,a=o.maximumWorld)}),t&&a?{min:t,max:a}:{min:S.Vector3.Zero(),max:S.Vector3.Zero()}},y.Center=function(e){var t=e instanceof Array?y.MinMax(e):e;return S.Vector3.Center(t.min,t.max)},y.MergeMeshes=function(e,t,r,i,o){void 0===t&&(t=!0);var s;if(!r){var a=0;for(s=0;s<e.length;s++)if(e[s]&&65536<(a+=e[s].getTotalVertices()))return S.Tools.Warn('Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices'),null}var l=null,c=[],p=null,u;for(s=0;s<e.length;s++)e[s]&&(e[s].computeWorldMatrix(!0),u=S.VertexData.ExtractFromMesh(e[s],!0),u.transform(e[s].getWorldMatrix()),l?l.merge(u):(l=u,p=e[s]),o&&c.push(e[s].getTotalIndices()));if(p=p,i||(i=new y(p.name+'_merged',p.getScene())),l.applyToMesh(i),i.material=p.material,i.checkCollisions=p.checkCollisions,t)for(s=0;s<e.length;s++)e[s]&&e[s].dispose();if(o){i.releaseSubMeshes(),s=0;for(var f=0;s<c.length;)S.SubMesh.CreateFromIndices(0,f,c[s],i),f+=c[s],s++}return i},y._FRONTSIDE=0,y._BACKSIDE=1,y._DOUBLESIDE=2,y._DEFAULTSIDE=0,y._NO_CAP=0,y._CAP_START=1,y._CAP_END=2,y._CAP_ALL=3,y}(S.AbstractMesh);S.Mesh=t}(e||(e={}));var e;!function(p){var e=function(){function t(){}return Object.defineProperty(t.prototype,'effect',{get:function(){return this._materialEffect},enumerable:!0,configurable:!0}),t.prototype.setEffect=function(r,e){return(void 0===e&&(e=null),this._materialEffect===r)?void(r||(this._materialDefines=null)):void(this._materialDefines=e,this._materialEffect=r)},t}();p.BaseSubMesh=e;var t=function(d){function u(t,e,c,r,n,o,s,a){void 0===a&&(a=!0);var l=d.call(this)||this;return l.materialIndex=t,l.verticesStart=e,l.verticesCount=c,l.indexStart=r,l.indexCount=n,l._renderId=0,l._mesh=o,l._renderingMesh=s||o,o.subMeshes.push(l),l._trianglePlanes=[],l._id=o.subMeshes.length-1,a&&(l.refreshBoundingInfo(),o.computeWorldMatrix(!0)),l}return h(u,d),u.AddToMesh=function(i,e,t,r,n,o,s,a){return void 0===a&&(a=!0),new u(i,e,t,r,n,o,s,a)},Object.defineProperty(u.prototype,'IsGlobal',{get:function(){return 0===this.verticesStart&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:!0,configurable:!0}),u.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},u.prototype.setBoundingInfo=function(t){return this._boundingInfo=t,this},u.prototype.getMesh=function(){return this._mesh},u.prototype.getRenderingMesh=function(){return this._renderingMesh},u.prototype.getMaterial=function(){var t=this._renderingMesh.material;if(null===t||void 0===t)return this._mesh.getScene().defaultMaterial;if(t.getSubMaterial){var e=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this._materialDefines=null),e}return t},u.prototype.refreshBoundingInfo=function(){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;var e=this._renderingMesh.getVerticesData(p.VertexBuffer.PositionKind);if(!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var o=this._renderingMesh.getIndices(),r;if(0===this.indexStart&&this.indexCount===o.length){var i=this._renderingMesh.getBoundingInfo();r={minimum:i.minimum.clone(),maximum:i.maximum.clone()}}else r=p.Tools.ExtractMinAndMaxIndexed(e,o,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo=new p.BoundingInfo(r.minimum,r.maximum),this},u.prototype._checkCollision=function(t){return this.getBoundingInfo()._checkCollision(t)},u.prototype.updateBoundingInfo=function(r){var e=this.getBoundingInfo();return e||(this.refreshBoundingInfo(),e=this.getBoundingInfo()),e.update(r),this},u.prototype.isInFrustum=function(r){var e=this.getBoundingInfo();return!!e&&e.isInFrustum(r)},u.prototype.isCompletelyInFrustum=function(r){var e=this.getBoundingInfo();return!!e&&e.isCompletelyInFrustum(r)},u.prototype.render=function(t){return this._renderingMesh.render(this,t),this},u.prototype.getLinesIndexBuffer=function(o,e){if(!this._linesIndexBuffer){for(var t=[],i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)t.push(o[i],o[i+1],o[i+1],o[i+2],o[i+2],o[i]);this._linesIndexBuffer=e.createIndexBuffer(t),this.linesIndexCount=t.length}return this._linesIndexBuffer},u.prototype.canIntersects=function(r){var e=this.getBoundingInfo();return!!e&&r.intersectsBox(e.boundingBox)},u.prototype.intersects=function(e,t,i,r){var n=null,_=this.getMaterial();if(!_)return null;switch(_.fillMode){case p.Material.PointListDrawMode:case p.Material.LineListDrawMode:case p.Material.LineLoopDrawMode:case p.Material.LineStripDrawMode:case p.Material.TriangleFanDrawMode:case p.Material.TriangleStripDrawMode:return null;}if(p.LinesMesh&&this._mesh instanceof p.LinesMesh)for(var m=this._mesh,a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){var l=t[i[a]],g=t[i[a+1]],c=e.intersectionSegment(l,g,m.intersectionThreshold);if(!(0>c)&&(r||!n||c<n.distance)&&(n=new p.IntersectionInfo(null,null,c),r))break}else for(var a=this.indexStart;a<this.indexStart+this.indexCount;a+=3){var l=t[i[a]],g=t[i[a+1]],u=t[i[a+2]],f=e.intersectsTriangle(l,g,u);if(f){if(0>f.distance)continue;if((r||!n||f.distance<n.distance)&&(n=f,n.faceId=a/3,r))break}}return n},u.prototype._rebuild=function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)},u.prototype.clone=function(e,t){var r=new u(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){var i=this.getBoundingInfo();if(!i)return r;r._boundingInfo=new p.BoundingInfo(i.minimum,i.maximum)}return r},u.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1)},u.CreateFromIndices=function(i,e,t,r,n){var o=S,s=-S;n=n||r;for(var a=n.getIndices(),l=e,d;l<e+t;l++)d=a[l],d<o&&(o=d),d>s&&(s=d);return new u(i,o,s-o+1,e,t,r,n)},u}(e);p.SubMesh=t}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(s){var e=function(){function t(){this._isDirty=!0,this._areLightsDirty=!0,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1}return Object.defineProperty(t.prototype,'isDirty',{get:function(){return this._isDirty},enumerable:!0,configurable:!0}),t.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areMiscDirty=!1,this._areImageProcessingDirty=!1},t.prototype.markAsUnprocessed=function(){this._isDirty=!0},t.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},t.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},t.prototype.markAsLightDirty=function(){this._areLightsDirty=!0,this._isDirty=!0},t.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},t.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},t.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},t.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},t.prototype.rebuild=function(){this._keys&&delete this._keys,this._keys=[];for(var r=0,e=Object.keys(this),t;r<e.length;r++)t=e[r],'_'!==t[0]&&this._keys.push(t)},t.prototype.isEqual=function(r){if(this._keys.length!==r._keys.length)return!1;for(var e=0,t;e<this._keys.length;e++)if(t=this._keys[e],this[t]!==r[t])return!1;return!0},t.prototype.cloneTo=function(r){this._keys.length!==r._keys.length&&(r._keys=this._keys.slice(0));for(var e=0,t;e<this._keys.length;e++)t=this._keys[e],r[t]=this[t]},t.prototype.reset=function(){for(var r=0,e;r<this._keys.length;r++)switch(e=this._keys[r],typeof this[e]){case'number':this[e]=0;break;case'string':this[e]='';break;default:this[e]=!1;}},t.prototype.toString=function(){for(var o='',e=0;e<this._keys.length;e++){var t=this._keys[e],i=this[t];switch(typeof i){case'number':case'string':o+='#define '+t+' '+i+'\n';break;default:i&&(o+='#define '+t+'\n');}}return o},t}();s.MaterialDefines=e;var t=function(){function a(e,t,r){this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state='',this._alpha=1,this._backFaceCulling=!0,this.doNotSerialize=!1,this.storeEffectOnSubMeshes=!1,this.onDisposeObservable=new s.Observable,this.onBindObservable=new s.Observable,this.onUnBindObservable=new s.Observable,this._alphaMode=s.Engine.ALPHA_COMBINE,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.forceDepthWrite=!1,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this._wasPreviouslyReady=!1,this._fillMode=a.TriangleFillMode,this.name=e,this.id=e||s.Tools.RandomId(),this._scene=t||s.Engine.LastCreatedScene,this.sideOrientation=this._scene.useRightHandedSystem?a.ClockWiseSideOrientation:a.CounterClockWiseSideOrientation,this._uniformBuffer=new s.UniformBuffer(this._scene.getEngine()),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,r||this._scene.materials.push(this)}return Object.defineProperty(a,'TriangleFillMode',{get:function(){return a._TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'WireFrameFillMode',{get:function(){return a._WireFrameFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'PointFillMode',{get:function(){return a._PointFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'PointListDrawMode',{get:function(){return a._PointListDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'LineListDrawMode',{get:function(){return a._LineListDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'LineLoopDrawMode',{get:function(){return a._LineLoopDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'LineStripDrawMode',{get:function(){return a._LineStripDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'TriangleStripDrawMode',{get:function(){return a._TriangleStripDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'TriangleFanDrawMode',{get:function(){return a._TriangleFanDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(a,'ClockWiseSideOrientation',{get:function(){return a._ClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(a,'CounterClockWiseSideOrientation',{get:function(){return a._CounterClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(a,'TextureDirtyFlag',{get:function(){return a._TextureDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(a,'LightDirtyFlag',{get:function(){return a._LightDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(a,'FresnelDirtyFlag',{get:function(){return a._FresnelDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(a,'AttributesDirtyFlag',{get:function(){return a._AttributesDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(a,'MiscDirtyFlag',{get:function(){return a._MiscDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'alpha',{get:function(){return this._alpha},set:function(t){this._alpha!==t&&(this._alpha=t,this.markAsDirty(a.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'backFaceCulling',{get:function(){return this._backFaceCulling},set:function(t){this._backFaceCulling!==t&&(this._backFaceCulling=t,this.markAsDirty(a.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'onBind',{set:function(t){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'alphaMode',{get:function(){return this._alphaMode},set:function(t){this._alphaMode!==t&&(this._alphaMode=t,this.markAsDirty(a.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'needDepthPrePass',{get:function(){return this._needDepthPrePass},set:function(t){this._needDepthPrePass!==t&&(this._needDepthPrePass=t,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'fogEnabled',{get:function(){return this._fogEnabled},set:function(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAsDirty(a.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'wireframe',{get:function(){switch(this._fillMode){case a.WireFrameFillMode:case a.LineListDrawMode:case a.LineLoopDrawMode:case a.LineStripDrawMode:return!0;}return this._scene.forceWireframe},set:function(t){this.fillMode=t?a.WireFrameFillMode:a.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'pointsCloud',{get:function(){switch(this._fillMode){case a.PointFillMode:case a.PointListDrawMode:return!0;}return this._scene.forcePointsCloud},set:function(t){this.fillMode=t?a.PointFillMode:a.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'fillMode',{get:function(){return this._fillMode},set:function(t){this._fillMode!==t&&(this._fillMode=t,this.markAsDirty(a.MiscDirtyFlag))},enumerable:!0,configurable:!0}),a.prototype.toString=function(){return'Name: '+this.name},a.prototype.getClassName=function(){return'Material'},Object.defineProperty(a.prototype,'isFrozen',{get:function(){return this.checkReadyOnlyOnce},enumerable:!0,configurable:!0}),a.prototype.freeze=function(){this.checkReadyOnlyOnce=!0},a.prototype.unfreeze=function(){this.checkReadyOnlyOnce=!1},a.prototype.isReady=function(){return!0},a.prototype.isReadyForSubMesh=function(){return!1},a.prototype.getEffect=function(){return this._effect},a.prototype.getScene=function(){return this._scene},a.prototype.needAlphaBlending=function(){return 1>this.alpha},a.prototype.needAlphaBlendingForMesh=function(t){return this.needAlphaBlending()||1>t.visibility||t.hasVertexAlpha},a.prototype.needAlphaTesting=function(){return!1},a.prototype.getAlphaTestTexture=function(){return null},a.prototype.markDirty=function(){this._wasPreviouslyReady=!1},a.prototype._preBind=function(t,e){void 0===e&&(e=null);var i=this._scene.getEngine(),r=null==e?this.sideOrientation:e,n=r===a.ClockWiseSideOrientation;return i.enableEffect(t||this._effect),i.setState(this.backFaceCulling,this.zOffset,!1,n),n},a.prototype.bind=function(){},a.prototype.bindForSubMesh=function(){},a.prototype.bindOnlyWorldMatrix=function(){},a.prototype.bindSceneUniformBuffer=function(r,e){e.bindToEffect(r,'Scene')},a.prototype.bindView=function(t){this._useUBO?this.bindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()):t.setMatrix('view',this.getScene().getViewMatrix())},a.prototype.bindViewProjection=function(t){this._useUBO?this.bindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()):t.setMatrix('viewProjection',this.getScene().getTransformMatrix())},a.prototype._shouldTurnAlphaTestOn=function(t){return!this.needAlphaBlendingForMesh(t)&&this.needAlphaTesting()},a.prototype._afterBind=function(r){if(this._scene._cachedMaterial=this,this._scene._cachedVisibility=r?r.visibility:1,r&&this.onBindObservable.notifyObservers(r),this.disableDepthWrite){var e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}},a.prototype.unbind=function(){(this.onUnBindObservable.notifyObservers(this),this.disableDepthWrite)&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState)},a.prototype.getActiveTextures=function(){return[]},a.prototype.hasTexture=function(){return!1},a.prototype.clone=function(){return null},a.prototype.getBindedMeshes=function(){for(var r=[],e=0,t;e<this._scene.meshes.length;e++)t=this._scene.meshes[e],t.material===this&&r.push(t);return r},a.prototype.forceCompilation=function(e,t,i){var d=this,n=b({clipPlane:!1},i),o=new s.BaseSubMesh,a=this.getScene(),l=function(){if(d._scene&&d._scene.getEngine()){o._materialDefines&&(o._materialDefines._renderId=-1);var i=a.clipPlane;n.clipPlane&&(a.clipPlane=new s.Plane(0,0,0,1)),d.storeEffectOnSubMeshes?d.isReadyForSubMesh(e,o)?t&&t(d):setTimeout(l,16):d.isReady(e)?t&&t(d):setTimeout(l,16),n.clipPlane&&(a.clipPlane=i)}};l()},a.prototype.forceCompilationAsync=function(o,e){var t=this;return new Promise(function(i){t.forceCompilation(o,function(){i()},e)})},a.prototype.markAsDirty=function(t){t&a.TextureDirtyFlag&&this._markAllSubMeshesAsTexturesDirty(),t&a.LightDirtyFlag&&this._markAllSubMeshesAsLightsDirty(),t&a.FresnelDirtyFlag&&this._markAllSubMeshesAsFresnelDirty(),t&a.AttributesDirtyFlag&&this._markAllSubMeshesAsAttributesDirty(),t&a.MiscDirtyFlag&&this._markAllSubMeshesAsMiscDirty(),this.getScene().resetCachedMaterial()},a.prototype._markAllSubMeshesAsDirty=function(a){for(var e=0,t=this.getScene().meshes,i;e<t.length;e++)if(i=t[e],i.subMeshes)for(var r=0,n=i.subMeshes,o;r<n.length;r++)o=n[r],o.getMaterial()===this&&o._materialDefines&&a(o._materialDefines)},a.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsImageProcessingDirty()})},a.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsTexturesDirty()})},a.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsFresnelDirty()})},a.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty(function(t){t.markAsFresnelDirty(),t.markAsMiscDirty()})},a.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsLightDirty()})},a.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsAttributesDirty()})},a.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(function(t){return t.markAsMiscDirty()})},a.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty(function(t){t.markAsTexturesDirty(),t.markAsMiscDirty()})},a.prototype.dispose=function(t){this.getScene().stopAnimation(this),this.getScene().freeProcessedMaterials();var e=this._scene.materials.indexOf(this);for(0<=e&&this._scene.materials.splice(e,1),e=0;e<this._scene.meshes.length;e++){var i=this._scene.meshes[e];if(i.material===this&&(i.material=null,i.geometry)){var r=i.geometry;if(this.storeEffectOnSubMeshes)for(var n=0,o=i.subMeshes,s;n<o.length;n++)s=o[n],r._releaseVertexArrayObject(s._materialEffect),t&&s._materialEffect&&this._scene.getEngine()._releaseEffect(s._materialEffect);else r._releaseVertexArrayObject(this._effect)}}this._uniformBuffer.dispose(),t&&this._effect&&(this.storeEffectOnSubMeshes||this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBindObservable.clear(),this.onUnBindObservable.clear()},a.prototype.serialize=function(){return s.SerializationHelper.Serialize(this)},a.ParseMultiMaterial=function(e,t){var i=new s.MultiMaterial(e.name,t);i.id=e.id,s.Tags&&s.Tags.AddTagsTo(i,e.tags);for(var r=0,a;r<e.materials.length;r++)a=e.materials[r],a?i.subMaterials.push(t.getMaterialByID(a)):i.subMaterials.push(null);return i},a.Parse=function(e,t,o){return e.customType&&'BABYLON.StandardMaterial'!==e.customType?'BABYLON.PBRMaterial'===e.customType&&e.overloadedAlbedo&&(e.customType='BABYLON.LegacyPBRMaterial',!s.LegacyPBRMaterial)?void s.Tools.Error('Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library.'):s.Tools.Instantiate(e.customType).Parse(e,t,o):s.StandardMaterial.Parse(e,t,o)},a._TriangleFillMode=0,a._WireFrameFillMode=1,a._PointFillMode=2,a._PointListDrawMode=3,a._LineListDrawMode=4,a._LineLoopDrawMode=5,a._LineStripDrawMode=6,a._TriangleStripDrawMode=7,a._TriangleFanDrawMode=8,a._ClockWiseSideOrientation=0,a._CounterClockWiseSideOrientation=1,a._TextureDirtyFlag=1,a._LightDirtyFlag=2,a._FresnelDirtyFlag=4,a._AttributesDirtyFlag=8,a._MiscDirtyFlag=16,g([s.serialize()],a.prototype,'id',void 0),g([s.serialize()],a.prototype,'name',void 0),g([s.serialize()],a.prototype,'checkReadyOnEveryCall',void 0),g([s.serialize()],a.prototype,'checkReadyOnlyOnce',void 0),g([s.serialize()],a.prototype,'state',void 0),g([s.serialize('alpha')],a.prototype,'_alpha',void 0),g([s.serialize('backFaceCulling')],a.prototype,'_backFaceCulling',void 0),g([s.serialize()],a.prototype,'sideOrientation',void 0),g([s.serialize('alphaMode')],a.prototype,'_alphaMode',void 0),g([s.serialize()],a.prototype,'_needDepthPrePass',void 0),g([s.serialize()],a.prototype,'disableDepthWrite',void 0),g([s.serialize()],a.prototype,'forceDepthWrite',void 0),g([s.serialize()],a.prototype,'separateCullingPass',void 0),g([s.serialize('fogEnabled')],a.prototype,'_fogEnabled',void 0),g([s.serialize()],a.prototype,'pointSize',void 0),g([s.serialize()],a.prototype,'zOffset',void 0),g([s.serialize()],a.prototype,'wireframe',null),g([s.serialize()],a.prototype,'pointsCloud',null),g([s.serialize()],a.prototype,'fillMode',null),a}();s.Material=t}(e||(e={}));var e;!function(o){var e=function(){function a(r,e,o){this._engine=r,this._noUBO=!r.supportsUniformBuffers,this._dynamic=o,this._data=e||[],this._uniformLocations={},this._uniformSizes={},this._uniformLocationPointer=0,this._needSync=!1,this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform)}return Object.defineProperty(a.prototype,'useUbo',{get:function(){return!this._noUBO},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'isSync',{get:function(){return!this._needSync},enumerable:!0,configurable:!0}),a.prototype.isDynamic=function(){return void 0!==this._dynamic},a.prototype.getData=function(){return this._bufferData},a.prototype.getBuffer=function(){return this._buffer},a.prototype._fillAlignment=function(o){var e;if(e=2>=o?o:4,0!=this._uniformLocationPointer%e){var t=this._uniformLocationPointer;this._uniformLocationPointer+=e-this._uniformLocationPointer%e;for(var i=this._uniformLocationPointer-t,r=0;r<i;r++)this._data.push(0)}},a.prototype.addUniform=function(o,e){if(!this._noUBO&&void 0===this._uniformLocations[o]){var t;if(e instanceof Array)t=e,e=t.length;else{e=e,t=[];for(var i=0;i<e;i++)t.push(0)}this._fillAlignment(e),this._uniformSizes[o]=e,this._uniformLocations[o]=this._uniformLocationPointer,this._uniformLocationPointer+=e;for(var i=0;i<e;i++)this._data.push(t[i]);this._needSync=!0}},a.prototype.addMatrix=function(r,e){this.addUniform(r,Array.prototype.slice.call(e.toArray()))},a.prototype.addFloat2=function(r,e,t){this.addUniform(r,[e,t])},a.prototype.addFloat3=function(o,e,t,i){this.addUniform(o,[e,t,i])},a.prototype.addColor3=function(r,e){var t=[];e.toArray(t),this.addUniform(r,t)},a.prototype.addColor4=function(o,e,t){var i=[];e.toArray(i),i.push(t),this.addUniform(o,i)},a.prototype.addVector3=function(r,e){var t=[];e.toArray(t),this.addUniform(r,t)},a.prototype.addMatrix3x3=function(t){this.addUniform(t,12)},a.prototype.addMatrix2x2=function(t){this.addUniform(t,8)},a.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},a.prototype._rebuild=function(){this._noUBO||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData))},a.prototype.update=function(){return this._buffer?void((this._dynamic||this._needSync)&&(this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._needSync=!1)):void this.create()},a.prototype.updateUniform=function(e,t,i){var r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void o.Tools.Error('Cannot add an uniform after UBO has been created.');this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(var a=0;a<i;a++)this._bufferData[r+a]=t[a];else{for(var n=!1,a=0;a<i;a++)this._bufferData[r+a]!==t[a]&&(n=!0,this._bufferData[r+a]=t[a]);this._needSync=this._needSync||n}},a.prototype._updateMatrix3x3ForUniform=function(t,e){for(var o=0;3>o;o++)a._tempBuffer[4*o]=e[3*o],a._tempBuffer[4*o+1]=e[3*o+1],a._tempBuffer[4*o+2]=e[3*o+2],a._tempBuffer[4*o+3]=0;this.updateUniform(t,a._tempBuffer,12)},a.prototype._updateMatrix3x3ForEffect=function(r,e){this._currentEffect.setMatrix3x3(r,e)},a.prototype._updateMatrix2x2ForEffect=function(r,e){this._currentEffect.setMatrix2x2(r,e)},a.prototype._updateMatrix2x2ForUniform=function(t,e){for(var o=0;2>o;o++)a._tempBuffer[4*o]=e[2*o],a._tempBuffer[4*o+1]=e[2*o+1],a._tempBuffer[4*o+2]=0,a._tempBuffer[4*o+3]=0;this.updateUniform(t,a._tempBuffer,8)},a.prototype._updateFloatForEffect=function(r,e){this._currentEffect.setFloat(r,e)},a.prototype._updateFloatForUniform=function(t,e){a._tempBuffer[0]=e,this.updateUniform(t,a._tempBuffer,1)},a.prototype._updateFloat2ForEffect=function(o,e,t,i){void 0===i&&(i=''),this._currentEffect.setFloat2(o+i,e,t)},a.prototype._updateFloat2ForUniform=function(t,e,o,r){void 0===r&&(r=''),a._tempBuffer[0]=e,a._tempBuffer[1]=o,this.updateUniform(t,a._tempBuffer,2)},a.prototype._updateFloat3ForEffect=function(o,e,t,i,r){void 0===r&&(r=''),this._currentEffect.setFloat3(o+r,e,t,i)},a.prototype._updateFloat3ForUniform=function(t,e,i,r,n){void 0===n&&(n=''),a._tempBuffer[0]=e,a._tempBuffer[1]=i,a._tempBuffer[2]=r,this.updateUniform(t,a._tempBuffer,3)},a.prototype._updateFloat4ForEffect=function(a,e,t,i,r,n){void 0===n&&(n=''),this._currentEffect.setFloat4(a+n,e,t,i,r)},a.prototype._updateFloat4ForUniform=function(t,e,i,r,n,o){void 0===o&&(o=''),a._tempBuffer[0]=e,a._tempBuffer[1]=i,a._tempBuffer[2]=r,a._tempBuffer[3]=n,this.updateUniform(t,a._tempBuffer,4)},a.prototype._updateMatrixForEffect=function(r,e){this._currentEffect.setMatrix(r,e)},a.prototype._updateMatrixForUniform=function(r,e){this.updateUniform(r,e.toArray(),16)},a.prototype._updateVector3ForEffect=function(r,e){this._currentEffect.setVector3(r,e)},a.prototype._updateVector3ForUniform=function(t,e){e.toArray(a._tempBuffer),this.updateUniform(t,a._tempBuffer,3)},a.prototype._updateVector4ForEffect=function(r,e){this._currentEffect.setVector4(r,e)},a.prototype._updateVector4ForUniform=function(t,e){e.toArray(a._tempBuffer),this.updateUniform(t,a._tempBuffer,4)},a.prototype._updateColor3ForEffect=function(r,e,t){void 0===t&&(t=''),this._currentEffect.setColor3(r+t,e)},a.prototype._updateColor3ForUniform=function(t,e,o){void 0===o&&(o=''),e.toArray(a._tempBuffer),this.updateUniform(t,a._tempBuffer,3)},a.prototype._updateColor4ForEffect=function(o,e,t,i){void 0===i&&(i=''),this._currentEffect.setColor4(o+i,e,t)},a.prototype._updateColor4ForUniform=function(t,e,o,r){void 0===r&&(r=''),e.toArray(a._tempBuffer),a._tempBuffer[3]=o,this.updateUniform(t,a._tempBuffer,4)},a.prototype.setTexture=function(r,e){this._currentEffect.setTexture(r,e)},a.prototype.updateUniformDirectly=function(r,e){this.updateUniform(r,e,e.length),this.update()},a.prototype.bindToEffect=function(r,e){this._currentEffect=r,!this._noUBO&&this._buffer&&r.bindUniformBuffer(this._buffer,e)},a.prototype.dispose=function(){if(!this._noUBO){var t=this._engine._uniformBuffers.indexOf(this);-1!==t&&this._engine._uniformBuffers.splice(t,1),this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},a._MAX_UNIFORM_SIZE=256,a._tempBuffer=new Float32Array(a._MAX_UNIFORM_SIZE),a}();o.UniformBuffer=e}(e||(e={}));var e;!function(re){var e=function(){function te(){}return te.prototype.set=function(e,t){t===re.VertexBuffer.PositionKind?this.positions=e:t===re.VertexBuffer.NormalKind?this.normals=e:t===re.VertexBuffer.TangentKind?this.tangents=e:t===re.VertexBuffer.UVKind?this.uvs=e:t===re.VertexBuffer.UV2Kind?this.uvs2=e:t===re.VertexBuffer.UV3Kind?this.uvs3=e:t===re.VertexBuffer.UV4Kind?this.uvs4=e:t===re.VertexBuffer.UV5Kind?this.uvs5=e:t===re.VertexBuffer.UV6Kind?this.uvs6=e:t===re.VertexBuffer.ColorKind?this.colors=e:t===re.VertexBuffer.MatricesIndicesKind?this.matricesIndices=e:t===re.VertexBuffer.MatricesWeightsKind?this.matricesWeights=e:t===re.VertexBuffer.MatricesIndicesExtraKind?this.matricesIndicesExtra=e:t===re.VertexBuffer.MatricesWeightsExtraKind?this.matricesWeightsExtra=e:void 0},te.prototype.applyToMesh=function(r,e){return this._applyTo(r,e),this},te.prototype.applyToGeometry=function(r,e){return this._applyTo(r,e),this},te.prototype.updateMesh=function(t){return this._update(t),this},te.prototype.updateGeometry=function(t){return this._update(t),this},te.prototype._applyTo=function(e,t){return void 0===t&&(t=!1),this.positions&&e.setVerticesData(re.VertexBuffer.PositionKind,this.positions,t),this.normals&&e.setVerticesData(re.VertexBuffer.NormalKind,this.normals,t),this.tangents&&e.setVerticesData(re.VertexBuffer.TangentKind,this.tangents,t),this.uvs&&e.setVerticesData(re.VertexBuffer.UVKind,this.uvs,t),this.uvs2&&e.setVerticesData(re.VertexBuffer.UV2Kind,this.uvs2,t),this.uvs3&&e.setVerticesData(re.VertexBuffer.UV3Kind,this.uvs3,t),this.uvs4&&e.setVerticesData(re.VertexBuffer.UV4Kind,this.uvs4,t),this.uvs5&&e.setVerticesData(re.VertexBuffer.UV5Kind,this.uvs5,t),this.uvs6&&e.setVerticesData(re.VertexBuffer.UV6Kind,this.uvs6,t),this.colors&&e.setVerticesData(re.VertexBuffer.ColorKind,this.colors,t),this.matricesIndices&&e.setVerticesData(re.VertexBuffer.MatricesIndicesKind,this.matricesIndices,t),this.matricesWeights&&e.setVerticesData(re.VertexBuffer.MatricesWeightsKind,this.matricesWeights,t),this.matricesIndicesExtra&&e.setVerticesData(re.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),this.matricesWeightsExtra&&e.setVerticesData(re.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),this.indices&&e.setIndices(this.indices,null,t),this},te.prototype._update=function(e,t,o){return this.positions&&e.updateVerticesData(re.VertexBuffer.PositionKind,this.positions,t,o),this.normals&&e.updateVerticesData(re.VertexBuffer.NormalKind,this.normals,t,o),this.tangents&&e.updateVerticesData(re.VertexBuffer.TangentKind,this.tangents,t,o),this.uvs&&e.updateVerticesData(re.VertexBuffer.UVKind,this.uvs,t,o),this.uvs2&&e.updateVerticesData(re.VertexBuffer.UV2Kind,this.uvs2,t,o),this.uvs3&&e.updateVerticesData(re.VertexBuffer.UV3Kind,this.uvs3,t,o),this.uvs4&&e.updateVerticesData(re.VertexBuffer.UV4Kind,this.uvs4,t,o),this.uvs5&&e.updateVerticesData(re.VertexBuffer.UV5Kind,this.uvs5,t,o),this.uvs6&&e.updateVerticesData(re.VertexBuffer.UV6Kind,this.uvs6,t,o),this.colors&&e.updateVerticesData(re.VertexBuffer.ColorKind,this.colors,t,o),this.matricesIndices&&e.updateVerticesData(re.VertexBuffer.MatricesIndicesKind,this.matricesIndices,t,o),this.matricesWeights&&e.updateVerticesData(re.VertexBuffer.MatricesWeightsKind,this.matricesWeights,t,o),this.matricesIndicesExtra&&e.updateVerticesData(re.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,o),this.matricesWeightsExtra&&e.updateVerticesData(re.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,o),this.indices&&e.setIndices(this.indices,null),this},te.prototype.transform=function(e){var t=re.Vector3.Zero(),r;if(this.positions){var i=re.Vector3.Zero();for(r=0;r<this.positions.length;r+=3)re.Vector3.FromArrayToRef(this.positions,r,i),re.Vector3.TransformCoordinatesToRef(i,e,t),this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z}if(this.normals){var n=re.Vector3.Zero();for(r=0;r<this.normals.length;r+=3)re.Vector3.FromArrayToRef(this.normals,r,n),re.Vector3.TransformNormalToRef(n,e,t),this.normals[r]=t.x,this.normals[r+1]=t.y,this.normals[r+2]=t.z}if(this.tangents){var o=re.Vector4.Zero(),s=re.Vector4.Zero();for(r=0;r<this.tangents.length;r+=4)re.Vector4.FromArrayToRef(this.tangents,r,o),re.Vector4.TransformNormalToRef(o,e,s),this.tangents[r]=s.x,this.tangents[r+1]=s.y,this.tangents[r+2]=s.z,this.tangents[r+3]=s.w}return this},te.prototype.merge=function(r){if(this._validate(),r._validate(),!this.normals!=!r.normals||!this.tangents!=!r.tangents||!this.uvs!=!r.uvs||!this.uvs2!=!r.uvs2||!this.uvs3!=!r.uvs3||!this.uvs4!=!r.uvs4||!this.uvs5!=!r.uvs5||!this.uvs6!=!r.uvs6||!this.colors!=!r.colors||!this.matricesIndices!=!r.matricesIndices||!this.matricesWeights!=!r.matricesWeights||!this.matricesIndicesExtra!=!r.matricesIndicesExtra||!this.matricesWeightsExtra!=!r.matricesWeightsExtra)throw new Error('Cannot merge vertex data that do not have the same set of attributes');if(r.indices){this.indices||(this.indices=[]);for(var e=this.positions?this.positions.length/3:0,t=0;t<r.indices.length;t++)this.indices.push(r.indices[t]+e)}return this.positions=this._mergeElement(this.positions,r.positions),this.normals=this._mergeElement(this.normals,r.normals),this.tangents=this._mergeElement(this.tangents,r.tangents),this.uvs=this._mergeElement(this.uvs,r.uvs),this.uvs2=this._mergeElement(this.uvs2,r.uvs2),this.uvs3=this._mergeElement(this.uvs3,r.uvs3),this.uvs4=this._mergeElement(this.uvs4,r.uvs4),this.uvs5=this._mergeElement(this.uvs5,r.uvs5),this.uvs6=this._mergeElement(this.uvs6,r.uvs6),this.colors=this._mergeElement(this.colors,r.colors),this.matricesIndices=this._mergeElement(this.matricesIndices,r.matricesIndices),this.matricesWeights=this._mergeElement(this.matricesWeights,r.matricesWeights),this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,r.matricesIndicesExtra),this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,r.matricesWeightsExtra),this},te.prototype._mergeElement=function(l,d){if(!l)return d;if(!d)return l;var c=d.length+l.length,i=l instanceof Float32Array,r=d instanceof Float32Array;if(i){var n=new Float32Array(c);return n.set(l),n.set(d,l.length),n}if(r){for(var o=l.slice(0),s=0,c=d.length;s<c;s++)o.push(d[s]);return o}return l.concat(d)},te.prototype._validate=function(){if(!this.positions)throw new Error('Positions are required');var o=function(e,t){var o=re.VertexBuffer.DeduceStride(e);if(0!=t.length%o)throw new Error('The '+e+'s array count must be a multiple of '+o);return t.length/o},t=o(re.VertexBuffer.PositionKind,this.positions),e=function(i,e){var r=o(i,e);if(r!==t)throw new Error('The '+i+'s element count ('+r+') does not match the positions count ('+t+')')};this.normals&&e(re.VertexBuffer.NormalKind,this.normals),this.tangents&&e(re.VertexBuffer.TangentKind,this.tangents),this.uvs&&e(re.VertexBuffer.UVKind,this.uvs),this.uvs2&&e(re.VertexBuffer.UV2Kind,this.uvs2),this.uvs3&&e(re.VertexBuffer.UV3Kind,this.uvs3),this.uvs4&&e(re.VertexBuffer.UV4Kind,this.uvs4),this.uvs5&&e(re.VertexBuffer.UV5Kind,this.uvs5),this.uvs6&&e(re.VertexBuffer.UV6Kind,this.uvs6),this.colors&&e(re.VertexBuffer.ColorKind,this.colors),this.matricesIndices&&e(re.VertexBuffer.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&e(re.VertexBuffer.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&e(re.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&e(re.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra)},te.prototype.serialize=function(){var t=this.serialize();return this.positions&&(t.positions=this.positions),this.normals&&(t.normals=this.normals),this.tangents&&(t.tangents=this.tangents),this.uvs&&(t.uvs=this.uvs),this.uvs2&&(t.uvs2=this.uvs2),this.uvs3&&(t.uvs3=this.uvs3),this.uvs4&&(t.uvs4=this.uvs4),this.uvs5&&(t.uvs5=this.uvs5),this.uvs6&&(t.uvs6=this.uvs6),this.colors&&(t.colors=this.colors),this.matricesIndices&&(t.matricesIndices=this.matricesIndices,t.matricesIndices._isExpanded=!0),this.matricesWeights&&(t.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(t.matricesIndicesExtra=this.matricesIndicesExtra,t.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(t.matricesWeightsExtra=this.matricesWeightsExtra),t.indices=this.indices,t},te.ExtractFromMesh=function(t,e,o){return te._ExtractFrom(t,e,o)},te.ExtractFromGeometry=function(t,e,o){return te._ExtractFrom(t,e,o)},te._ExtractFrom=function(e,t,r){var i=new te;return e.isVerticesDataPresent(re.VertexBuffer.PositionKind)&&(i.positions=e.getVerticesData(re.VertexBuffer.PositionKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.NormalKind)&&(i.normals=e.getVerticesData(re.VertexBuffer.NormalKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.TangentKind)&&(i.tangents=e.getVerticesData(re.VertexBuffer.TangentKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UVKind)&&(i.uvs=e.getVerticesData(re.VertexBuffer.UVKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UV2Kind)&&(i.uvs2=e.getVerticesData(re.VertexBuffer.UV2Kind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UV3Kind)&&(i.uvs3=e.getVerticesData(re.VertexBuffer.UV3Kind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UV4Kind)&&(i.uvs4=e.getVerticesData(re.VertexBuffer.UV4Kind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UV5Kind)&&(i.uvs5=e.getVerticesData(re.VertexBuffer.UV5Kind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.UV6Kind)&&(i.uvs6=e.getVerticesData(re.VertexBuffer.UV6Kind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.ColorKind)&&(i.colors=e.getVerticesData(re.VertexBuffer.ColorKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.MatricesIndicesKind)&&(i.matricesIndices=e.getVerticesData(re.VertexBuffer.MatricesIndicesKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.MatricesWeightsKind)&&(i.matricesWeights=e.getVerticesData(re.VertexBuffer.MatricesWeightsKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.MatricesIndicesExtraKind)&&(i.matricesIndicesExtra=e.getVerticesData(re.VertexBuffer.MatricesIndicesExtraKind,t,r)),e.isVerticesDataPresent(re.VertexBuffer.MatricesWeightsExtraKind)&&(i.matricesWeightsExtra=e.getVerticesData(re.VertexBuffer.MatricesWeightsExtraKind,t,r)),i.indices=e.getIndices(t),i},te.CreateRibbon=function(e){var t=e.pathArray,r=e.closeArray||!1,i=e.closePath||!1,o=e.invertUV||!1,n=ee(t[0].length/2),a=e.offset||n;a=a>n?n:ee(a);var s=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,l=e.uvs,d=e.colors,p=[],_=[],m=[],g=[],y=[],b=[],x=[],T=[],E=[],v=[],P,h,c,u;if(2>t.length){var f=[],A=[];for(c=0;c<t[0].length-a;c++)f.push(t[0][c]),A.push(t[0][c+a]);t=[f,A]}var S=0,M=i?1:0,O,C;P=t[0].length;var R,I;for(h=0;h<t.length;h++){for(x[h]=0,y[h]=[0],O=t[h],C=O.length,P=P<C?P:C,u=0;u<C;)p.push(O[u].x,O[u].y,O[u].z),0<u&&(R=O[u].subtract(O[u-1]).length(),I=R+x[h],y[h].push(I),x[h]=I),u++;i&&(u--,p.push(O[0].x,O[0].y,O[0].z),R=O[u].subtract(O[0]).length(),I=R+x[h],y[h].push(I),x[h]=I),E[h]=C+M,v[h]=S,S+=C+M}var D=null,B=null,V,L;for(c=0;c<P+M;c++){for(T[c]=0,b[c]=[0],h=0;h<t.length-1;h++)V=t[h],L=t[h+1],c===P?(D=V[0],B=L[0]):(D=V[c],B=L[c]),R=B.subtract(D).length(),I=R+T[c],b[c].push(I),T[c]=I;r&&B&&D&&(V=t[h],L=t[0],c===P&&(B=L[0]),R=B.subtract(D).length(),I=R+T[c],T[c]=I)}var F,N;if(l)for(h=0;h<l.length;h++)g.push(l[h].x,l[h].y);else for(h=0;h<t.length;h++)for(c=0;c<P+M;c++)F=0==x[h]?0:y[h][c]/x[h],N=0==T[c]?0:b[c][h]/T[c],o?g.push(N,F):g.push(F,N);h=0;for(var w=0,U=E[h]-1,z=E[h+1]-1,k=U<z?U:z,G=v[1]-v[0],W=r?E.length:E.length-1;w<=k&&h<W;)_.push(w,w+G,w+1),_.push(w+G+1,w+1,w+G),(w+=1)===k&&(h++,h===E.length-1?(G=v[0]-v[h],U=E[h]-1,z=E[0]-1):(G=v[h+1]-v[h],U=E[h]-1,z=E[h+1]-1),w=v[h],k=U<z?U+w:z+w);if(te.ComputeNormals(p,_,m),i){var H=0,X=0;for(h=0;h<t.length;h++)H=3*v[h],X=h+1<t.length?3*(v[h+1]-1):m.length-3,m[H]=.5*(m[H]+m[X]),m[H+1]=.5*(m[H+1]+m[X+1]),m[H+2]=.5*(m[H+2]+m[X+2]),m[X]=m[H],m[X+1]=m[H+1],m[X+2]=m[H+2]}te._ComputeSides(s,p,_,m,g,e.frontUVs,e.backUVs);var Y=null;if(d){Y=new Float32Array(4*d.length);for(var K=0;K<d.length;K++)Y[4*K]=d[K].r,Y[4*K+1]=d[K].g,Y[4*K+2]=d[K].b,Y[4*K+3]=d[K].a}var Q=new te,j=new Float32Array(p),Z=new Float32Array(m),q=new Float32Array(g);return Q.indices=_,Q.positions=j,Q.normals=Z,Q.uvs=q,Y&&Q.set(Y,re.VertexBuffer.ColorKind),i&&(Q._idx=v),Q},te.CreateBox=function(e){for(var t=[new re.Vector3(0,0,1),new re.Vector3(0,0,-1),new re.Vector3(1,0,0),new re.Vector3(-1,0,0),new re.Vector3(0,1,0),new re.Vector3(0,-1,0)],r=[],i=[],o=[],n=[],a=e.width||e.size||1,s=e.height||e.size||1,l=e.depth||e.size||1,c=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,u=e.faceUV||[,,,,,,],f=e.faceColors,d=[],p=0;6>p;p++)void 0===u[p]&&(u[p]=new re.Vector4(0,0,1,1)),f&&void 0===f[p]&&(f[p]=new re.Color4(1,1,1,1));for(var _=new re.Vector3(a/2,s/2,l/2),m=0;m<t.length;m++){var g=t[m],h=new re.Vector3(g.y,g.z,g.x),y=re.Vector3.Cross(g,h),b=i.length/3;r.push(b),r.push(b+1),r.push(b+2),r.push(b),r.push(b+2),r.push(b+3);var x=g.subtract(h).subtract(y).multiply(_);i.push(x.x,x.y,x.z),o.push(g.x,g.y,g.z),n.push(u[m].z,u[m].w),f&&d.push(f[m].r,f[m].g,f[m].b,f[m].a),x=g.subtract(h).add(y).multiply(_),i.push(x.x,x.y,x.z),o.push(g.x,g.y,g.z),n.push(u[m].x,u[m].w),f&&d.push(f[m].r,f[m].g,f[m].b,f[m].a),x=g.add(h).add(y).multiply(_),i.push(x.x,x.y,x.z),o.push(g.x,g.y,g.z),n.push(u[m].x,u[m].y),f&&d.push(f[m].r,f[m].g,f[m].b,f[m].a),x=g.add(h).subtract(y).multiply(_),i.push(x.x,x.y,x.z),o.push(g.x,g.y,g.z),n.push(u[m].z,u[m].y),f&&d.push(f[m].r,f[m].g,f[m].b,f[m].a)}te._ComputeSides(c,i,r,o,n,e.frontUVs,e.backUVs);var T=new te;if(T.indices=r,T.positions=i,T.normals=o,T.uvs=n,f){var E=c===re.Mesh.DOUBLESIDE?d.concat(d):d;T.colors=E}return T},te.CreateSphere=function(e){for(var t=e.segments||32,r=e.diameterX||e.diameter||1,i=e.diameterY||e.diameter||1,o=e.diameterZ||e.diameter||1,n=e.arc&&(0>=e.arc||1<e.arc)?1:e.arc||1,a=e.slice&&0>=e.slice?1:e.slice||1,s=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,l=new re.Vector3(r/2,i/2,o/2),c=2+t,u=2*c,f=[],d=[],p=[],_=[],m=0;m<=c;m++){for(var g=m/c,h=0;h<=u;h++){var y=h/u,T=re.Matrix.RotationZ(-(g*V*a)),x=re.Matrix.RotationY(2*(y*V)*n),b=re.Vector3.TransformCoordinates(re.Vector3.Up(),T),E=re.Vector3.TransformCoordinates(b,x),v=E.multiply(l),P=E.divide(l).normalize();d.push(v.x,v.y,v.z),p.push(P.x,P.y,P.z),_.push(y,g)}if(0<m)for(var A=d.length/3,S=A-2*(u+1);S+u+2<A;S++)f.push(S),f.push(S+1),f.push(S+u+1),f.push(S+u+1),f.push(S+1),f.push(S+u+2)}te._ComputeSides(s,d,f,p,_,e.frontUVs,e.backUVs);var M=new te;return M.indices=f,M.positions=d,M.normals=p,M.uvs=_,M},te.CreateCylinder=function(e){var R=e.height||2,O=0===e.diameterTop?0:e.diameterTop||e.diameter||1,o=0===e.diameterBottom?0:e.diameterBottom||e.diameter||1,s=e.tessellation||24,t=e.subdivisions||1,i=!!e.hasRings,a=!!e.enclose,K=e.arc&&(0>=e.arc||1<e.arc)?1:e.arc||1,l=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,u=e.faceUV||[,,,],d=e.faceColors,c=1!==K&&a?2:0,p=i?t:1,Q=2+(1+c)*p,f;for(f=0;f<Q;f++)d&&void 0===d[f]&&(d[f]=new re.Color4(1,1,1,1));for(f=0;f<Q;f++)u&&void 0===u[f]&&(u[f]=new re.Vector4(0,0,1,1));var r=[],g=[],P=[],A=[],S=[],_=re.Vector3.Zero(),m=re.Vector3.Zero(),h=re.Vector3.Zero(),M=re.Vector3.Zero(),C=re.Vector3.Zero(),I=re.Axis.Y,D=1,L=1,N=0,w=0,U,k,y,b,x,T;for(b=0;b<=t;b++)for(k=b/t,y=(k*(O-o)+o)/2,D=i&&0!==b&&b!==t?2:1,T=0;T<D;T++){for(i&&(L+=T),a&&(L+=2*T),x=0;x<=s;x++)U=x*(2*V*K/s),_.x=F(-U)*y,_.y=-R/2+k*R,_.z=B(-U)*y,0===O&&b===t?(m.x=P[P.length-3*(s+1)],m.y=P[P.length-3*(s+1)+1],m.z=P[P.length-3*(s+1)+2]):(m.x=_.x,m.z=_.z,m.y=$(m.x*m.x+m.z*m.z)*((o-O)/2/R),m.normalize()),0===x&&(h.copyFrom(_),M.copyFrom(m)),g.push(_.x,_.y,_.z),P.push(m.x,m.y,m.z),w=i?N==L?u[L].w:u[L].y:u[L].y+(u[L].w-u[L].y)*k,A.push(u[L].x+(u[L].z-u[L].x)*x/s,w),d&&S.push(d[L].r,d[L].g,d[L].b,d[L].a);1!==K&&a&&(g.push(_.x,_.y,_.z),g.push(0,_.y,0),g.push(0,_.y,0),g.push(h.x,h.y,h.z),re.Vector3.CrossToRef(I,m,C),C.normalize(),P.push(C.x,C.y,C.z,C.x,C.y,C.z),re.Vector3.CrossToRef(M,I,C),C.normalize(),P.push(C.x,C.y,C.z,C.x,C.y,C.z),w=i?N===L?u[L+1].w:u[L+1].y:u[L+1].y+(u[L+1].w-u[L+1].y)*k,A.push(u[L+1].x,w),A.push(u[L+1].z,w),w=i?N===L?u[L+2].w:u[L+2].y:u[L+2].y+(u[L+2].w-u[L+2].y)*k,A.push(u[L+2].x,w),A.push(u[L+2].z,w),d&&(S.push(d[L+1].r,d[L+1].g,d[L+1].b,d[L+1].a),S.push(d[L+1].r,d[L+1].g,d[L+1].b,d[L+1].a),S.push(d[L+2].r,d[L+2].g,d[L+2].b,d[L+2].a),S.push(d[L+2].r,d[L+2].g,d[L+2].b,d[L+2].a))),N!==L&&(N=L)}var E=1!==K&&a?s+4:s,L;for(b=0,L=0;L<t;L++){var z=0,G=0,W=0,H=0;for(x=0;x<s;x++)z=b*(E+1)+x,G=(b+1)*(E+1)+x,W=b*(E+1)+(x+1),H=(b+1)*(E+1)+(x+1),r.push(z,G,W),r.push(H,W,G);1!==K&&a&&(r.push(z+2,G+2,W+2),r.push(H+2,W+2,G+2),r.push(z+4,G+4,W+4),r.push(H+4,W+4,G+4)),b=i?b+2:b+1}var j=function(e){var t=e?O/2:o/2;if(0!=t){var i=e?u[Q-1]:u[0],a=null,c,p,l;d&&(a=e?d[Q-1]:d[0]);var f=g.length/3,_=e?R/2:-R/2,m=new re.Vector3(0,_,0);g.push(m.x,m.y,m.z),P.push(0,e?1:-1,0),A.push(i.x+.5*(i.z-i.x),i.y+.5*(i.w-i.y)),a&&S.push(a.r,a.g,a.b,a.a);var h=new re.Vector2(.5,.5);for(l=0;l<=s;l++){c=2*V*l*K/s;var y=F(-c),b=B(-c);p=new re.Vector3(y*t,_,b*t);var x=new re.Vector2(y*h.x+.5,b*h.y+.5);g.push(p.x,p.y,p.z),P.push(0,e?1:-1,0),A.push(i.x+(i.z-i.x)*x.x,i.y+(i.w-i.y)*x.y),a&&S.push(a.r,a.g,a.b,a.a)}for(l=0;l<s;l++)e?(r.push(f),r.push(f+(l+2)),r.push(f+(l+1))):(r.push(f),r.push(f+(l+1)),r.push(f+(l+2)))}};j(!1),j(!0),te._ComputeSides(l,g,r,P,A,e.frontUVs,e.backUVs);var X=new te;return X.indices=r,X.positions=g,X.normals=P,X.uvs=A,d&&(X.colors=S),X},te.CreateTorus=function(e){for(var t=[],r=[],i=[],o=[],n=e.diameter||1,a=e.thickness||.5,s=e.tessellation||16,l=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,c=s+1,u=0;u<=s;u++)for(var f=u/s,d=2*(u*V)/s-V/2,p=re.Matrix.Translation(n/2,0,0).multiply(re.Matrix.RotationY(d)),_=0;_<=s;_++){var m=1-_/s,g=2*(_*V)/s+V,h=F(g),y=B(g),b=new re.Vector3(h,y,0),x=b.scale(a/2),T=new re.Vector2(f,m);x=re.Vector3.TransformCoordinates(x,p),b=re.Vector3.TransformNormal(b,p),r.push(x.x,x.y,x.z),i.push(b.x,b.y,b.z),o.push(T.x,T.y);var E=(u+1)%c,v=(_+1)%c;t.push(u*c+_),t.push(u*c+v),t.push(E*c+_),t.push(u*c+v),t.push(E*c+v),t.push(E*c+_)}te._ComputeSides(l,r,t,i,o,e.frontUVs,e.backUVs);var P=new te;return P.indices=t,P.positions=r,P.normals=i,P.uvs=o,P},te.CreateLineSystem=function(t){for(var e=[],i=[],r=t.lines,n=t.colors,o=[],s=0,a=0;a<r.length;a++)for(var l=r[a],d=0;d<l.length;d++){if(i.push(l[d].x,l[d].y,l[d].z),n){var c=n[a];o.push(c[d].r,c[d].g,c[d].b,c[d].a)}0<d&&(e.push(s-1),e.push(s)),s++}var p=new te;return p.indices=e,p.positions=i,n&&(p.colors=o),p},te.CreateDashedLines=function(e){var t=e.dashSize||3,r=e.gapSize||1,i=e.dashNb||200,o=e.points,n=[],a=[],s=re.Vector3.Zero(),l=0,c=0,u=0,f=0,d=0,p=0,_=0;for(_=0;_<o.length-1;_++)o[_+1].subtractToRef(o[_],s),l+=s.length();for(u=l/i,f=t*u/(t+r),_=0;_<o.length-1;_++){o[_+1].subtractToRef(o[_],s),c=ee(s.length()/u),s.normalize();for(var m=0;m<c;m++)d=u*m,n.push(o[_].x+d*s.x,o[_].y+d*s.y,o[_].z+d*s.z),n.push(o[_].x+(d+f)*s.x,o[_].y+(d+f)*s.y,o[_].z+(d+f)*s.z),a.push(p,p+1),p+=2}var g=new te;return g.positions=n,g.indices=a,g},te.CreateGround=function(e){var t=[],o=[],i=[],a=[],s=e.width||1,l=e.height||1,c=e.subdivisionsX||e.subdivisions||1,u=e.subdivisionsY||e.subdivisions||1,f,r;for(f=0;f<=u;f++)for(r=0;r<=c;r++){var n=new re.Vector3(r*s/c-s/2,0,(u-f)*l/u-l/2),d=new re.Vector3(0,1,0);o.push(n.x,n.y,n.z),i.push(d.x,d.y,d.z),a.push(r/c,1-f/u)}for(f=0;f<u;f++)for(r=0;r<c;r++)t.push(r+1+(f+1)*(c+1)),t.push(r+1+f*(c+1)),t.push(r+f*(c+1)),t.push(r+(f+1)*(c+1)),t.push(r+1+(f+1)*(c+1)),t.push(r+f*(c+1));var p=new te;return p.indices=t,p.positions=o,p.normals=i,p.uvs=a,p},te.CreateTiledGround=function(e){var t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,a=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,l=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,c=e.subdivisions||{w:1,h:1},y=e.precision||{w:1,h:1},u=[],d=[],p=[],f=[],_,r,n,o;c.h=1>c.h?1:c.h,c.w=1>c.w?1:c.w,y.w=1>y.w?1:y.w,y.h=1>y.h?1:y.h;var s={w:(a-t)/c.w,h:(l-i)/c.h};for(n=0;n<c.h;n++)for(o=0;o<c.w;o++)!function(e,t,i,o){var n=d.length/3,a=y.w+1;for(_=0;_<y.h;_++)for(r=0;r<y.w;r++){var s=[n+r+_*a,n+(r+1)+_*a,n+(r+1)+(_+1)*a,n+r+(_+1)*a];u.push(s[1]),u.push(s[2]),u.push(s[3]),u.push(s[0]),u.push(s[1]),u.push(s[3])}var l=re.Vector3.Zero(),c=new re.Vector3(0,1,0);for(_=0;_<=y.h;_++)for(l.z=_*(o-t)/y.h+t,r=0;r<=y.w;r++)l.x=r*(i-e)/y.w+e,l.y=0,d.push(l.x,l.y,l.z),p.push(c.x,c.y,c.z),f.push(r/y.w,_/y.h)}(t+o*s.w,i+n*s.h,t+(o+1)*s.w,i+(n+1)*s.h);var m=new te;return m.indices=u,m.positions=d,m.normals=p,m.uvs=f,m},te.CreateGroundFromHeightMap=function(e){var t=[],o=[],i=[],a=[],s=e.colorFilter||new re.Color3(.3,.59,.11),l,r;for(l=0;l<=e.subdivisions;l++)for(r=0;r<=e.subdivisions;r++){var n=new re.Vector3(r*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-l)*e.height/e.subdivisions-e.height/2),c=0|(n.x+e.width/2)/e.width*(e.bufferWidth-1),u=0|(1-(n.z+e.height/2)/e.height)*(e.bufferHeight-1),f=4*(c+u*e.bufferWidth),d=e.buffer[f]/255,p=e.buffer[f+1]/255,_=e.buffer[f+2]/255,m=d*s.r+p*s.g+_*s.b;n.y=e.minHeight+(e.maxHeight-e.minHeight)*m,o.push(n.x,n.y,n.z),i.push(0,0,0),a.push(r/e.subdivisions,1-l/e.subdivisions)}for(l=0;l<e.subdivisions;l++)for(r=0;r<e.subdivisions;r++)t.push(r+1+(l+1)*(e.subdivisions+1)),t.push(r+1+l*(e.subdivisions+1)),t.push(r+l*(e.subdivisions+1)),t.push(r+(l+1)*(e.subdivisions+1)),t.push(r+1+(l+1)*(e.subdivisions+1)),t.push(r+l*(e.subdivisions+1));te.ComputeNormals(o,t,i);var g=new te;return g.indices=t,g.positions=o,g.normals=i,g.uvs=a,g},te.CreatePlane=function(e){var t=[],r=[],i=[],o=[],n=e.width||e.size||1,a=e.height||e.size||1,s=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,l=n/2,d=a/2;r.push(-l,-d,0),i.push(0,0,-1),o.push(0,0),r.push(l,-d,0),i.push(0,0,-1),o.push(1,0),r.push(l,d,0),i.push(0,0,-1),o.push(1,1),r.push(-l,d,0),i.push(0,0,-1),o.push(0,1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),te._ComputeSides(s,r,t,i,o,e.frontUVs,e.backUVs);var p=new te;return p.indices=t,p.positions=r,p.normals=i,p.uvs=o,p},te.CreateDisc=function(e){var t=[],r=[],i=[],o=[],n=e.radius||.5,a=e.tessellation||64,s=e.arc&&(0>=e.arc||1<e.arc)?1:e.arc||1,l=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE;t.push(0,0,0),o.push(.5,.5);for(var c=2*V*s,u=0;u<c;u+=c/a){var d=F(u),p=B(u);t.push(n*d,n*p,0),o.push((d+1)/2,(1-p)/2)}1===s&&(t.push(t[3],t[4],t[5]),o.push(o[2],o[3]));for(var f=t.length/3,_=1;_<f-1;_++)r.push(_+1,0,_);te.ComputeNormals(t,r,i),te._ComputeSides(l,t,r,i,o,e.frontUVs,e.backUVs);var m=new te;return m.indices=r,m.positions=t,m.normals=i,m.uvs=o,m},te.CreatePolygon=function(e,t,r,i,o,n){for(var a=r||[,,,],s=i,l=[],c=0;3>c;c++)void 0===a[c]&&(a[c]=new re.Vector4(0,0,1,1)),s&&void 0===s[c]&&(s[c]=new re.Color4(1,1,1,1));for(var u=e.getVerticesData(re.VertexBuffer.PositionKind),f=e.getVerticesData(re.VertexBuffer.NormalKind),d=e.getVerticesData(re.VertexBuffer.UVKind),p=e.getIndices(),_=0,m=0,g=0;g<f.length;g+=3).001>A(f[g+1])&&(m=1),.001>A(f[g+1]-1)&&(m=0),.001>A(f[g+1]+1)&&(m=2),_=g/3,d[2*_]=(1-d[2*_])*a[m].x+d[2*_]*a[m].z,d[2*_+1]=(1-d[2*_+1])*a[m].y+d[2*_+1]*a[m].w,s&&l.push(s[m].r,s[m].g,s[m].b,s[m].a);te._ComputeSides(t,u,p,f,d,o,n);var h=new te;if(h.indices=p,h.positions=u,h.normals=f,h.uvs=d,s){var y=t===re.Mesh.DOUBLESIDE?l.concat(l):l;h.colors=y}return h},te.CreateIcoSphere=function(e){var t=e.sideOrientation||re.Mesh.DEFAULTSIDE,i=e.radius||1,O=void 0===e.flat||e.flat,s=e.subdivisions||4,a=e.radiusX||i,l=e.radiusY||i,h=e.radiusZ||i,o=(1+2.23606797749979)/2,n=[-1,o,-0,1,o,0,-1,-o,0,1,-o,0,0,-1,-o,0,1,-o,0,-1,o,0,1,o,o,0,1,o,0,-1,-o,0,1,-o,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],d=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],p=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],I=[],g=[],v=[],y=[],b=0,x=[,,,],T=[,,,],_;for(_=0;3>_;_++)x[_]=re.Vector3.Zero(),T[_]=re.Vector2.Zero();for(var r=0;20>r;r++){for(_=0;3>_;_++){var m=c[3*r+_];x[_].copyFromFloats(n[3*d[m]],n[3*d[m]+1],n[3*d[m]+2]),x[_].normalize().scaleInPlace(i),T[_].copyFromFloats(p[2*m]*(138/1024)+60/1024+f[r]*(-40/1024),p[2*m+1]*(239/1024)+26/1024+f[r]*(20/1024))}for(var E=function(e,t,i,r){var n=re.Vector3.Lerp(x[0],x[2],t/s),o=re.Vector3.Lerp(x[1],x[2],t/s),c=s===t?x[2]:re.Vector3.Lerp(n,o,e/(s-t));c.normalize();var u;if(O){var d=re.Vector3.Lerp(x[0],x[2],r/s),p=re.Vector3.Lerp(x[1],x[2],r/s);u=re.Vector3.Lerp(d,p,i/(s-r))}else u=new re.Vector3(c.x,c.y,c.z);u.x/=a,u.y/=l,u.z/=h,u.normalize();var f=re.Vector2.Lerp(T[0],T[2],t/s),_=re.Vector2.Lerp(T[1],T[2],t/s),m=s===t?T[2]:re.Vector2.Lerp(f,_,e/(s-t));g.push(c.x*a,c.y*l,c.z*h),v.push(u.x,u.y,u.z),y.push(m.x,m.y),I.push(b),b++},P=0;P<s;P++)for(var A=0;A+P<s;A++)E(A,P,A+1/3,P+1/3),E(A+1,P,A+1/3,P+1/3),E(A,P+1,A+1/3,P+1/3),A+P+1<s&&(E(A+1,P,A+2/3,P+2/3),E(A+1,P+1,A+2/3,P+2/3),E(A,P+1,A+2/3,P+2/3))}te._ComputeSides(t,g,I,v,y,e.frontUVs,e.backUVs);var S=new te;return S.indices=I,S.positions=g,S.normals=v,S.uvs=y,S},te.CreatePolyhedron=function(e){var t=[];t[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},t[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},t[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},t[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},t[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},t[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},t[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},t[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},t[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},t[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},t[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},t[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},t[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},t[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},t[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var r=e.type&&(0>e.type||e.type>=t.length)?0:e.type||0,i=e.size,c=e.sizeX||i||1,u=e.sizeY||i||1,d=e.sizeZ||i||1,p=e.custom||t[r],f=p.face.length,_=e.faceUV||Array(f),m=e.faceColors,g=void 0===e.flat||e.flat,v=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,b=[],x=[],T=[],E=[],P=[],A=0,M=0,S=[],C=0,R=0,O,n,o,s,a,l;if(g)for(R=0;R<f;R++)m&&void 0===m[R]&&(m[R]=new re.Color4(1,1,1,1)),_&&void 0===_[R]&&(_[R]=new re.Vector4(0,0,1,1));if(g)for(R=0;R<f;R++){var h=p.face[R].length;for(o=2*V/h,s=.5*y(o/2),a=.5,C=0;C<h;C++)b.push(p.vertex[p.face[R][C]][0]*c,p.vertex[p.face[R][C]][1]*u,p.vertex[p.face[R][C]][2]*d),S.push(A),A++,O=_[R].x+(_[R].z-_[R].x)*(.5+s),n=_[R].y+(_[R].w-_[R].y)*(a-.5),E.push(O,n),l=s*F(o)-a*B(o),a=s*B(o)+a*F(o),s=l,m&&P.push(m[R].r,m[R].g,m[R].b,m[R].a);for(C=0;C<h-2;C++)x.push(S[0+M],S[C+2+M],S[C+1+M]);M+=h}else{for(C=0;C<p.vertex.length;C++)b.push(p.vertex[C][0]*c,p.vertex[C][1]*u,p.vertex[C][2]*d),E.push(0,0);for(R=0;R<f;R++)for(C=0;C<p.face[R].length-2;C++)x.push(p.face[R][0],p.face[R][C+2],p.face[R][C+1])}te.ComputeNormals(b,x,T),te._ComputeSides(v,b,x,T,E,e.frontUVs,e.backUVs);var I=new te;return I.positions=b,I.indices=x,I.normals=T,I.uvs=E,m&&g&&(I.colors=P),I},te.CreateTorusKnot=function(e){var t=[],o=[],i=[],a=[],s=e.radius||2,l=e.tube||.5,h=e.radialSegments||32,u=e.tubularSegments||32,f=e.p||2,d=e.q||3,p=0===e.sideOrientation?0:e.sideOrientation||re.Mesh.DEFAULTSIDE,_=function(e){var t=F(e),i=B(e),r=d/f*e,a=F(r),o=.5*(s*B(r));return new re.Vector3(.5*(s*(2+a))*t,.5*(s*(2+a)*i),o)},m,r;for(m=0;m<=h;m++){var n=m%h,g=2*(n/h)*f*V,v=_(g),y=_(g+.01),b=y.subtract(v),x=y.add(v),T=re.Vector3.Cross(b,x);for(x=re.Vector3.Cross(T,b),T.normalize(),x.normalize(),r=0;r<u;r++){var E=r%u,P=2*(E/u)*V,A=-l*F(P),M=l*B(P);o.push(v.x+A*x.x+M*T.x),o.push(v.y+A*x.y+M*T.y),o.push(v.z+A*x.z+M*T.z),a.push(m/h),a.push(r/u)}}for(m=0;m<h;m++)for(r=0;r<u;r++){var S=(r+1)%u,C=m*u+r,R=(m+1)*u+r,O=(m+1)*u+S,I=m*u+S;t.push(I),t.push(R),t.push(C),t.push(I),t.push(O),t.push(R)}te.ComputeNormals(o,t,i),te._ComputeSides(p,o,t,i,a,e.frontUVs,e.backUVs);var D=new te;return D.indices=t,D.positions=o,D.normals=i,D.uvs=a,D},te.ComputeNormals=function(e,t,i,r){var n=0,o=0,s=0,a=0,l=0,h=0,c=0,u=0,f=0,d=0,p=0,_=0,m=0,g=0,v=0,y=0,b=0,x=0,T=0,E=0,P=!1,A=!1,M=!1,S=!1,C=1,R=0,O=null;if(r&&(P=!!r.facetNormals,A=!!r.facetPositions,M=!!r.facetPartitioning,C=!0===r.useRightHandedSystem?-1:1,R=r.ratio||0,S=!!r.depthSort,O=r.distanceTo,S)){void 0===O&&(O=re.Vector3.Zero());var I=r.depthSortedFacets}var D=0,w=0,L=0,F=0;if(M&&r&&r.bbSize){var B=0,V=0,N=0,U=0,k=0,z=0,G=0,W=0,H=0,j=0,X=0,Y=0,K=0,Q=0,Z=0,q=0,J=r.bbSize.x>r.bbSize.y?r.bbSize.x:r.bbSize.y;J=J>r.bbSize.z?J:r.bbSize.z,D=r.subDiv.X*R/r.bbSize.x,w=r.subDiv.Y*R/r.bbSize.y,L=r.subDiv.Z*R/r.bbSize.z,F=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0}for(n=0;n<e.length;n++)i[n]=0;var oe=0|t.length/3;for(n=0;n<oe;n++){if(_=3*t[3*n],m=_+1,g=_+2,v=3*t[3*n+1],y=v+1,b=v+2,x=3*t[3*n+2],T=x+1,E=x+2,o=e[_]-e[v],s=e[m]-e[y],a=e[g]-e[b],l=e[x]-e[v],h=e[T]-e[y],c=e[E]-e[b],u=C*(s*c-a*h),f=C*(a*l-o*c),d=C*(o*h-s*l),p=$(u*u+f*f+d*d),p=0===p?1:p,u/=p,f/=p,d/=p,P&&r&&(r.facetNormals[n].x=u,r.facetNormals[n].y=f,r.facetNormals[n].z=d),A&&r&&(r.facetPositions[n].x=(e[_]+e[v]+e[x])/3,r.facetPositions[n].y=(e[m]+e[y]+e[T])/3,r.facetPositions[n].z=(e[g]+e[b]+e[E])/3),M&&r&&(B=ee((r.facetPositions[n].x-r.bInfo.minimum.x*R)*D),V=ee((r.facetPositions[n].y-r.bInfo.minimum.y*R)*w),N=ee((r.facetPositions[n].z-r.bInfo.minimum.z*R)*L),U=ee((e[_]-r.bInfo.minimum.x*R)*D),k=ee((e[m]-r.bInfo.minimum.y*R)*w),z=ee((e[g]-r.bInfo.minimum.z*R)*L),G=ee((e[v]-r.bInfo.minimum.x*R)*D),W=ee((e[y]-r.bInfo.minimum.y*R)*w),H=ee((e[b]-r.bInfo.minimum.z*R)*L),j=ee((e[x]-r.bInfo.minimum.x*R)*D),X=ee((e[T]-r.bInfo.minimum.y*R)*w),Y=ee((e[E]-r.bInfo.minimum.z*R)*L),Q=U+r.subDiv.max*k+F*z,Z=G+r.subDiv.max*W+F*H,q=j+r.subDiv.max*X+F*Y,K=B+r.subDiv.max*V+F*N,r.facetPartitioning[K]=r.facetPartitioning[K]?r.facetPartitioning[K]:[],r.facetPartitioning[Q]=r.facetPartitioning[Q]?r.facetPartitioning[Q]:[],r.facetPartitioning[Z]=r.facetPartitioning[Z]?r.facetPartitioning[Z]:[],r.facetPartitioning[q]=r.facetPartitioning[q]?r.facetPartitioning[q]:[],r.facetPartitioning[Q].push(n),Z!=Q&&r.facetPartitioning[Z].push(n),q!=Z&&q!=Q&&r.facetPartitioning[q].push(n),K!=Q&&K!=Z&&K!=q&&r.facetPartitioning[K].push(n)),S&&r&&r.facetPositions){var ie=I[n];ie.ind=3*n,ie.sqDistance=re.Vector3.DistanceSquared(r.facetPositions[n],O)}i[_]+=u,i[m]+=f,i[g]+=d,i[v]+=u,i[y]+=f,i[b]+=d,i[x]+=u,i[T]+=f,i[E]+=d}for(n=0;n<i.length/3;n++)u=i[3*n],f=i[3*n+1],d=i[3*n+2],p=$(u*u+f*f+d*d),p=0===p?1:p,u/=p,f/=p,d/=p,i[3*n]=u,i[3*n+1]=f,i[3*n+2]=d},te._ComputeSides=function(e,t,i,r,n,o,s){var a=i.length,c=r.length,u,l;switch(e=e||re.Mesh.DEFAULTSIDE){case re.Mesh.FRONTSIDE:break;case re.Mesh.BACKSIDE:var h;for(u=0;u<a;u+=3)h=i[u],i[u]=i[u+2],i[u+2]=h;for(l=0;l<c;l++)r[l]=-r[l];break;case re.Mesh.DOUBLESIDE:for(var f=t.length,d=f/3,p=0;p<f;p++)t[f+p]=t[p];for(u=0;u<a;u+=3)i[u+a]=i[u+2]+d,i[u+1+a]=i[u+1]+d,i[u+2+a]=i[u]+d;for(l=0;l<c;l++)r[c+l]=-r[l];var _=n.length,m=0;for(m=0;m<_;m++)n[m+_]=n[m];for(o=o||new re.Vector4(0,0,1,1),s=s||new re.Vector4(0,0,1,1),m=0,u=0;u<_/2;u++)n[m]=o.x+(o.z-o.x)*n[m],n[m+1]=o.y+(o.w-o.y)*n[m+1],n[m+_]=s.x+(s.z-s.x)*n[m+_],n[m+_+1]=s.y+(s.w-s.y)*n[m+_+1],m+=2;}},te.ImportVertexData=function(e,t){var r=new te,i=e.positions;i&&r.set(i,re.VertexBuffer.PositionKind);var o=e.normals;o&&r.set(o,re.VertexBuffer.NormalKind);var n=e.tangents;n&&r.set(n,re.VertexBuffer.TangentKind);var a=e.uvs;a&&r.set(a,re.VertexBuffer.UVKind);var s=e.uv2s;s&&r.set(s,re.VertexBuffer.UV2Kind);var l=e.uv3s;l&&r.set(l,re.VertexBuffer.UV3Kind);var c=e.uv4s;c&&r.set(c,re.VertexBuffer.UV4Kind);var u=e.uv5s;u&&r.set(u,re.VertexBuffer.UV5Kind);var f=e.uv6s;f&&r.set(f,re.VertexBuffer.UV6Kind);var d=e.colors;d&&r.set(re.Color4.CheckColors4(d,i.length/3),re.VertexBuffer.ColorKind);var p=e.matricesIndices;p&&r.set(p,re.VertexBuffer.MatricesIndicesKind);var _=e.matricesWeights;_&&r.set(_,re.VertexBuffer.MatricesWeightsKind);var m=e.indices;m&&(r.indices=m),t.setAllVerticesData(r,e.updatable)},te}();re.VertexData=e}(e||(e={}));var e;!function(b){var e=function(){function d(e,a,i,r,n){void 0===r&&(r=!1),void 0===n&&(n=null),this.delayLoadState=b.Engine.DELAYLOADSTATE_NONE,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this.id=e,this._engine=a.getEngine(),this._meshes=[],this._scene=a,this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):(this._totalVertices=0,this._indices=[]),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&('LinesMesh'===n.getClassName()&&(this.boundingBias=new b.Vector2(0,n.intersectionThreshold),this._updateExtend()),this.applyToMesh(n),n.computeWorldMatrix(!0))}return Object.defineProperty(d.prototype,'boundingBias',{get:function(){return this._boundingBias},set:function(t){this._boundingBias&&this._boundingBias.equals(t)||(this._boundingBias=t.clone(),this._updateBoundingInfo(!0,null))},enumerable:!0,configurable:!0}),d.CreateGeometryForMesh=function(t){var e=new d(d.RandomId(),t.getScene());return e.applyToMesh(t),e},Object.defineProperty(d.prototype,'extend',{get:function(){return this._extend},enumerable:!0,configurable:!0}),d.prototype.getScene=function(){return this._scene},d.prototype.getEngine=function(){return this._engine},d.prototype.isReady=function(){return this.delayLoadState===b.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===b.Engine.DELAYLOADSTATE_NONE},Object.defineProperty(d.prototype,'doNotSerialize',{get:function(){for(var t=0;t<this._meshes.length;t++)if(!this._meshes[t].doNotSerialize)return!1;return!0},enumerable:!0,configurable:!0}),d.prototype._rebuild=function(){for(var t in this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._vertexBuffers)this._vertexBuffers[t]._rebuild()},d.prototype.setAllVerticesData=function(r,e){r.applyToGeometry(this,e),this.notifyUpdate()},d.prototype.setVerticesData=function(e,t,i,r){void 0===i&&(i=!1);var a=new b.VertexBuffer(this._engine,t,e,i,0===this._meshes.length,r);this.setVerticesBuffer(a)},d.prototype.removeVerticesData=function(t){this._vertexBuffers[t]&&(this._vertexBuffers[t].dispose(),delete this._vertexBuffers[t])},d.prototype.setVerticesBuffer=function(e,t){void 0===t&&(t=null);var i=e.getKind();if(this._vertexBuffers[i]&&this._vertexBuffers[i].dispose(),this._vertexBuffers[i]=e,i===b.VertexBuffer.PositionKind){var r=e.getData();null==t?null!=r&&(this._totalVertices=r.length/(e.byteStride/4)):this._totalVertices=t,this._updateExtend(r),this._resetPointsArrayCache();for(var n=this._meshes,o=n.length,s=0,a;s<o;s++)a=n[s],a._boundingInfo=new b.BoundingInfo(this._extend.minimum,this._extend.maximum),a._createGlobalSubMesh(!1),a.computeWorldMatrix(!0)}this.notifyUpdate(i),this._vertexArrayObjects&&(this._disposeVertexArrayObjects(),this._vertexArrayObjects={})},d.prototype.updateVerticesDataDirectly=function(o,e,t,i){void 0===i&&(i=!1);var r=this.getVertexBuffer(o);r&&(r.updateDirectly(e,t,i),this.notifyUpdate(o))},d.prototype.updateVerticesData=function(e,t,o){void 0===o&&(o=!1);var r=this.getVertexBuffer(e);r&&(r.update(t),e===b.VertexBuffer.PositionKind&&this._updateBoundingInfo(o,t),this.notifyUpdate(e))},d.prototype._updateBoundingInfo=function(e,t){e&&this._updateExtend(t);var i=this._meshes,r=i.length;this._resetPointsArrayCache();for(var n=0,o;n<r;n++)if(o=i[n],e){o._boundingInfo=new b.BoundingInfo(this._extend.minimum,this._extend.maximum);for(var s=0;s<o.subMeshes.length;s++)o.subMeshes[s].refreshBoundingInfo()}},d.prototype._bind=function(r,e){if(r){void 0===e&&(e=this._indexBuffer);var t=this.getVertexBuffers();if(t){if(e!=this._indexBuffer||!this._vertexArrayObjects)return void this._engine.bindBuffers(t,e,r);this._vertexArrayObjects[r.key]||(this._vertexArrayObjects[r.key]=this._engine.recordVertexArrayObject(t,e,r)),this._engine.bindVertexArrayObject(this._vertexArrayObjects[r.key],e)}}},d.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},d.prototype.getVerticesData=function(e,t,i){var r=this.getVertexBuffer(e);if(!r)return null;var d=r.getData();if(!d)return null;var c=r.getSize()*b.VertexBuffer.GetTypeByteLength(r.type),s=this._totalVertices*r.getSize();if(r.type!==b.VertexBuffer.FLOAT||r.byteStride!==c){var a=Array(s);return r.forEach(s,function(r,e){a[e]=r}),a}if(!(d instanceof Array||d instanceof Float32Array)||0!==r.byteOffset||d.length!==s){if(d instanceof Array){var l=r.byteOffset/4;return b.Tools.Slice(d,l,l+s)}return d instanceof ArrayBuffer?new Float32Array(d,r.byteOffset,s):new Float32Array(d.buffer,d.byteOffset+r.byteOffset,s)}return i||t&&1!==this._meshes.length?b.Tools.Slice(d):d},d.prototype.isVertexBufferUpdatable=function(r){var e=this._vertexBuffers[r];return!!e&&e.isUpdatable()},d.prototype.getVertexBuffer=function(t){return this.isReady()?this._vertexBuffers[t]:null},d.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},d.prototype.isVerticesDataPresent=function(t){return this._vertexBuffers?void 0!==this._vertexBuffers[t]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(t)},d.prototype.getVerticesDataKinds=function(){var r=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)r.push(t);else for(t in this._vertexBuffers)r.push(t);return r},d.prototype.updateIndices=function(r,e){this._indexBuffer&&(this._indexBufferIsUpdatable?this._engine.updateDynamicIndexBuffer(this._indexBuffer,r,e):this.setIndices(r,null,!0))},d.prototype.setIndices=function(a,e,t){void 0===e&&(e=null),void 0===t&&(t=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._disposeVertexArrayObjects(),this._indices=a,this._indexBufferIsUpdatable=t,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,t)),void 0!=e&&(this._totalVertices=e);for(var i=this._meshes,r=i.length,n=0;n<r;n++)i[n]._createGlobalSubMesh(!0);this.notifyUpdate()},d.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},d.prototype.getIndices=function(o){if(!this.isReady())return null;var e=this._indices;if(o&&1!==this._meshes.length){for(var t=e.length,i=[],r=0;r<t;r++)i.push(e[r]);return i}return e},d.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},d.prototype._releaseVertexArrayObject=function(t){void 0===t&&(t=null),t&&this._vertexArrayObjects&&this._vertexArrayObjects[t.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t.key]),delete this._vertexArrayObjects[t.key])},d.prototype.releaseForMesh=function(o,e){var t=this._meshes,i=t.indexOf(o);-1!==i&&(t.splice(i,1),o._geometry=null,0===t.length&&e&&this.dispose())},d.prototype.applyToMesh=function(r){if(r._geometry!==this){var e=r._geometry;e&&e.releaseForMesh(r);var t=this._meshes;r._geometry=this,this._scene.pushGeometry(this),t.push(r),this.isReady()?this._applyToMesh(r):r._boundingInfo=this._boundingInfo}},d.prototype._updateExtend=function(e){void 0===e&&(e=null),e||(e=this.getVerticesData(b.VertexBuffer.PositionKind)),this._extend=b.Tools.ExtractMinAndMax(e,0,this._totalVertices,this.boundingBias,3)},d.prototype._applyToMesh=function(e){var t=this._meshes.length;for(var o in this._vertexBuffers){1===t&&this._vertexBuffers[o].create();var r=this._vertexBuffers[o].getBuffer();r&&(r.references=t),o===b.VertexBuffer.PositionKind&&(this._extend||this._updateExtend(),e._boundingInfo=new b.BoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(!1),e._updateBoundingInfo())}1===t&&this._indices&&0<this._indices.length&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._indexBuffer&&(this._indexBuffer.references=t)},d.prototype.notifyUpdate=function(r){this.onGeometryUpdated&&this.onGeometryUpdated(this,r);for(var e=0,t=this._meshes;e<t.length;e++)t[e]._markSubMeshesAsAttributesDirty()},d.prototype.load=function(e,t){if(this.delayLoadState!==b.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(t&&t());this.delayLoadState=b.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(e,t)}},d.prototype._queueLoad=function(e,t){var i=this;this.delayLoadingFile&&(e._addPendingData(this),e._loadFile(this.delayLoadingFile,function(r){if(i._delayLoadingFunction){i._delayLoadingFunction(JSON.parse(r),i),i.delayLoadState=b.Engine.DELAYLOADSTATE_LOADED,i._delayInfo=[],e._removePendingData(i);for(var n=i._meshes,o=n.length,s=0;s<o;s++)i._applyToMesh(n[s]);t&&t()}},void 0,!0))},d.prototype.toLeftHanded=function(){var e=this.getIndices(!1);if(null!=e&&0<e.length){for(var t=0,i;t<e.length;t+=3)i=e[t+0],e[t+0]=e[t+2],e[t+2]=i;this.setIndices(e)}var r=this.getVerticesData(b.VertexBuffer.PositionKind,!1);if(null!=r&&0<r.length){for(var t=0;t<r.length;t+=3)r[t+2]=-r[t+2];this.setVerticesData(b.VertexBuffer.PositionKind,r,!1)}var a=this.getVerticesData(b.VertexBuffer.NormalKind,!1);if(null!=a&&0<a.length){for(var t=0;t<a.length;t+=3)a[t+2]=-a[t+2];this.setVerticesData(b.VertexBuffer.NormalKind,a,!1)}},d.prototype._resetPointsArrayCache=function(){this._positions=null},d.prototype._generatePointsArray=function(){if(this._positions)return!0;this._positions=[];var e=this.getVerticesData(b.VertexBuffer.PositionKind);if(!e)return!1;for(var r=0;r<e.length;r+=3)this._positions.push(b.Vector3.FromArray(e,r));return!0},d.prototype.isDisposed=function(){return this._isDisposed},d.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var t in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t]);this._vertexArrayObjects={}}},d.prototype.dispose=function(){var e=this._meshes,o=e.length,r;for(r=0;r<o;r++)this.releaseForMesh(e[r]);for(var t in this._meshes=[],this._disposeVertexArrayObjects(),this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=b.Engine.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._isDisposed=!0},d.prototype.copy=function(e){var t=new b.VertexData;t.indices=[];var r=this.getIndices();if(r)for(var i=0;i<r.length;i++)t.indices.push(r[i]);var o=!1,n=!1,p;for(p in this._vertexBuffers){var s=this.getVerticesData(p);if(s instanceof Float32Array?t.set(new Float32Array(s),p):t.set(s.slice(0),p),!n){var f=this.getVertexBuffer(p);f&&(o=f.isUpdatable(),n=!o)}}var c=new d(e,this._scene,t,o);for(p in c.delayLoadState=this.delayLoadState,c.delayLoadingFile=this.delayLoadingFile,c._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)c._delayInfo=c._delayInfo||[],c._delayInfo.push(p);return c._boundingInfo=new b.BoundingInfo(this._extend.minimum,this._extend.maximum),c},d.prototype.serialize=function(){var e={};return e.id=this.id,e.updatable=this._updatable,b.Tags&&b.Tags.HasTags(this)&&(e.tags=b.Tags.GetTags(this)),e},d.prototype.toNumberArray=function(t){return Array.isArray(t)?t:Array.prototype.slice.call(t)},d.prototype.serializeVerticeData=function(){var e=this.serialize();return this.isVerticesDataPresent(b.VertexBuffer.PositionKind)&&(e.positions=this.toNumberArray(this.getVerticesData(b.VertexBuffer.PositionKind)),this.isVertexBufferUpdatable(b.VertexBuffer.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.NormalKind)&&(e.normals=this.toNumberArray(this.getVerticesData(b.VertexBuffer.NormalKind)),this.isVertexBufferUpdatable(b.VertexBuffer.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.TangentKind)&&(e.tangets=this.toNumberArray(this.getVerticesData(b.VertexBuffer.TangentKind)),this.isVertexBufferUpdatable(b.VertexBuffer.TangentKind)&&(e.tangets._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UVKind)&&(e.uvs=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UVKind)),this.isVertexBufferUpdatable(b.VertexBuffer.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UV2Kind)&&(e.uv2s=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UV2Kind)),this.isVertexBufferUpdatable(b.VertexBuffer.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UV3Kind)&&(e.uv3s=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UV3Kind)),this.isVertexBufferUpdatable(b.VertexBuffer.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UV4Kind)&&(e.uv4s=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UV4Kind)),this.isVertexBufferUpdatable(b.VertexBuffer.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UV5Kind)&&(e.uv5s=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UV5Kind)),this.isVertexBufferUpdatable(b.VertexBuffer.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.UV6Kind)&&(e.uv6s=this.toNumberArray(this.getVerticesData(b.VertexBuffer.UV6Kind)),this.isVertexBufferUpdatable(b.VertexBuffer.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.ColorKind)&&(e.colors=this.toNumberArray(this.getVerticesData(b.VertexBuffer.ColorKind)),this.isVertexBufferUpdatable(b.VertexBuffer.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.MatricesIndicesKind)&&(e.matricesIndices=this.toNumberArray(this.getVerticesData(b.VertexBuffer.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(b.VertexBuffer.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(b.VertexBuffer.MatricesWeightsKind)&&(e.matricesWeights=this.toNumberArray(this.getVerticesData(b.VertexBuffer.MatricesWeightsKind)),this.isVertexBufferUpdatable(b.VertexBuffer.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this.toNumberArray(this.getIndices()),e},d.ExtractFromMesh=function(r,e){var t=r._geometry;return t?t.copy(e):null},d.RandomId=function(){return b.Tools.RandomId()},d._ImportGeometry=function(e,t){var r=t.getScene(),i=e.geometryId;if(i){var o=r.getGeometryByID(i);o&&o.applyToMesh(t)}else if(e instanceof ArrayBuffer){var n=t._binaryInfo;if(n.positionsAttrDesc&&0<n.positionsAttrDesc.count){var a=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(b.VertexBuffer.PositionKind,a,!1)}if(n.normalsAttrDesc&&0<n.normalsAttrDesc.count){var s=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(b.VertexBuffer.NormalKind,s,!1)}if(n.tangetsAttrDesc&&0<n.tangetsAttrDesc.count){var l=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(b.VertexBuffer.TangentKind,l,!1)}if(n.uvsAttrDesc&&0<n.uvsAttrDesc.count){var c=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);t.setVerticesData(b.VertexBuffer.UVKind,c,!1)}if(n.uvs2AttrDesc&&0<n.uvs2AttrDesc.count){var u=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);t.setVerticesData(b.VertexBuffer.UV2Kind,u,!1)}if(n.uvs3AttrDesc&&0<n.uvs3AttrDesc.count){var f=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);t.setVerticesData(b.VertexBuffer.UV3Kind,f,!1)}if(n.uvs4AttrDesc&&0<n.uvs4AttrDesc.count){var h=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);t.setVerticesData(b.VertexBuffer.UV4Kind,h,!1)}if(n.uvs5AttrDesc&&0<n.uvs5AttrDesc.count){var p=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);t.setVerticesData(b.VertexBuffer.UV5Kind,p,!1)}if(n.uvs6AttrDesc&&0<n.uvs6AttrDesc.count){var _=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);t.setVerticesData(b.VertexBuffer.UV6Kind,_,!1)}if(n.colorsAttrDesc&&0<n.colorsAttrDesc.count){var m=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(b.VertexBuffer.ColorKind,m,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&0<n.matricesIndicesAttrDesc.count){var g=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count);t.setVerticesData(b.VertexBuffer.MatricesIndicesKind,g,!1)}if(n.matricesWeightsAttrDesc&&0<n.matricesWeightsAttrDesc.count){var v=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(b.VertexBuffer.MatricesWeightsKind,v,!1)}if(n.indicesAttrDesc&&0<n.indicesAttrDesc.count){var y=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(y,null)}if(n.subMeshesAttrDesc&&0<n.subMeshesAttrDesc.count){var L=new Int32Array(e,n.subMeshesAttrDesc.offset,5*n.subMeshesAttrDesc.count);t.subMeshes=[];for(var x=0;x<n.subMeshesAttrDesc.count;x++){var T=L[5*x+0],E=L[5*x+1],P=L[5*x+2],A=L[5*x+3],M=L[5*x+4];b.SubMesh.AddToMesh(T,E,P,A,M,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(b.VertexBuffer.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(b.VertexBuffer.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(b.VertexBuffer.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(b.VertexBuffer.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(b.VertexBuffer.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(b.VertexBuffer.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(b.VertexBuffer.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(b.VertexBuffer.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(b.VertexBuffer.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(b.VertexBuffer.ColorKind,b.Color4.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.VertexBuffer.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{for(var S=[],x=0,C;x<e.matricesIndices.length;x++)C=e.matricesIndices[x],S.push(255&C),S.push((65280&C)>>8),S.push((16711680&C)>>16),S.push(C>>24);t.setVerticesData(b.VertexBuffer.MatricesIndicesKind,S,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.VertexBuffer.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{for(var S=[],x=0,C;x<e.matricesIndicesExtra.length;x++)C=e.matricesIndicesExtra[x],S.push(255&C),S.push((65280&C)>>8),S.push((16711680&C)>>16),S.push(C>>24);t.setVerticesData(b.VertexBuffer.MatricesIndicesExtraKind,S,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(d._CleanMatricesWeights(e,t),t.setVerticesData(b.VertexBuffer.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(b.VertexBuffer.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(var R=0,O;R<e.subMeshes.length;R++)O=e.subMeshes[R],b.SubMesh.AddToMesh(O.materialIndex,O.verticesStart,O.verticesCount,O.indexStart,O.indexCount,t)}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),delete t._shouldGenerateFlatShading),t.computeWorldMatrix(!0);var I=r.selectionOctree;void 0!==I&&null!==I&&I.addMesh(t)},d._CleanMatricesWeights=function(e,t){if(b.SceneLoader.CleanBoneMatrixWeights){var i=0;if(-1<e.skeletonId){var r=t.getScene().getLastSkeletonByID(e.skeletonId);if(r){i=r.bones.length;for(var n=t.getVerticesData(b.VertexBuffer.MatricesIndicesKind),o=t.getVerticesData(b.VertexBuffer.MatricesIndicesExtraKind),s=e.matricesWeights,a=e.matricesWeightsExtra,l=e.numBoneInfluencer,g=s.length,c=0;c<g;c+=4){for(var u=0,f=-1,d=0,p;4>d;d++)p=s[c+d],u+=p,.001>p&&0>f&&(f=d);if(a)for(var d=0,p;4>d;d++)p=a[c+d],u+=p,.001>p&&0>f&&(f=d+4);if((0>f||f>l-1)&&(f=l-1),.001<u){for(var _=1/u,d=0;4>d;d++)s[c+d]*=_;if(a)for(var d=0;4>d;d++)a[c+d]*=_}else 4<=f?(a[c+f-4]=1-u,o[c+f-4]=i):(s[c+f]=1-u,n[c+f]=i)}t.setVerticesData(b.VertexBuffer.MatricesIndicesKind,n),e.matricesWeightsExtra&&t.setVerticesData(b.VertexBuffer.MatricesIndicesExtraKind,o)}}}},d.Parse=function(e,t,r){if(t.getGeometryByID(e.id))return null;var i=new d(e.id,t,void 0,e.updatable);return b.Tags&&b.Tags.AddTagsTo(i,e.tags),e.delayLoadingFile?(i.delayLoadState=b.Engine.DELAYLOADSTATE_NOTLOADED,i.delayLoadingFile=r+e.delayLoadingFile,i._boundingInfo=new b.BoundingInfo(b.Vector3.FromArray(e.boundingBoxMinimum),b.Vector3.FromArray(e.boundingBoxMaximum)),i._delayInfo=[],e.hasUVs&&i._delayInfo.push(b.VertexBuffer.UVKind),e.hasUVs2&&i._delayInfo.push(b.VertexBuffer.UV2Kind),e.hasUVs3&&i._delayInfo.push(b.VertexBuffer.UV3Kind),e.hasUVs4&&i._delayInfo.push(b.VertexBuffer.UV4Kind),e.hasUVs5&&i._delayInfo.push(b.VertexBuffer.UV5Kind),e.hasUVs6&&i._delayInfo.push(b.VertexBuffer.UV6Kind),e.hasColors&&i._delayInfo.push(b.VertexBuffer.ColorKind),e.hasMatricesIndices&&i._delayInfo.push(b.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&i._delayInfo.push(b.VertexBuffer.MatricesWeightsKind),i._delayLoadingFunction=b.VertexData.ImportVertexData):b.VertexData.ImportVertexData(e,i),t.pushGeometry(i,!0),i},d}();b.Geometry=e;var t=function(a){function e(e,s,i,r){void 0===i&&(i=!1),void 0===r&&(r=null);var n=a.call(this,e,s,void 0,!1,r)||this;return n._canBeRegenerated=i,n._beingRegenerated=!0,n.regenerate(),n._beingRegenerated=!1,n}return h(e,a),e.prototype.canBeRegenerated=function(){return this._canBeRegenerated},e.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},e.prototype.asNewGeometry=function(e){return a.prototype.copy.call(this,e)},e.prototype.setAllVerticesData=function(e){this._beingRegenerated&&a.prototype.setAllVerticesData.call(this,e,!1)},e.prototype.setVerticesData=function(e,t){this._beingRegenerated&&a.prototype.setVerticesData.call(this,e,t,!1)},e.prototype._regenerateVertexData=function(){throw new Error('Abstract method')},e.prototype.copy=function(){throw new Error('Must be overriden in sub-classes.')},e.prototype.serialize=function(){var e=a.prototype.serialize.call(this);return e.canBeRegenerated=this.canBeRegenerated(),e},e}(e);b._PrimitiveGeometry=t;var o=function(e){function t(t,d,r,n,o,s,a,l,p){void 0===p&&(p=b.Mesh.DEFAULTSIDE);var c=e.call(this,t,d,a,l)||this;return c.pathArray=r,c.closeArray=n,c.closePath=o,c.offset=s,c.side=p,c}return h(t,e),t.prototype._regenerateVertexData=function(){return b.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})},t.prototype.copy=function(r){return new t(r,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),void 0,this.side)},t}(t);b.RibbonGeometry=o;var r=function(d){function o(e,t,r,n,o,s){void 0===o&&(o=null),void 0===s&&(s=b.Mesh.DEFAULTSIDE);var a=d.call(this,e,t,n,o)||this;return a.size=r,a.side=s,a}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateBox({size:this.size,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.size,this.canBeRegenerated(),void 0,this.side)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.size=this.size,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.size,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.BoxGeometry=r;var i=function(d){function o(e,t,r,n,o,s,a){void 0===s&&(s=null),void 0===a&&(a=b.Mesh.DEFAULTSIDE);var l=d.call(this,e,t,o,s)||this;return l.segments=r,l.diameter=n,l.side=a,l}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.segments=this.segments,t.diameter=this.diameter,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.segments,e.diameter,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.SphereGeometry=i;var n=function(e){function t(t,d,r,n,o,s,a){void 0===s&&(s=null),void 0===a&&(a=b.Mesh.DEFAULTSIDE);var l=e.call(this,t,d,o,s)||this;return l.radius=r,l.tessellation=n,l.side=a,l}return h(t,e),t.prototype._regenerateVertexData=function(){return b.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})},t.prototype.copy=function(r){return new t(r,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)},t}(t);b.DiscGeometry=n;var a=function(d){function o(e,t,r,n,o,s,a,l,p,c){void 0===a&&(a=1),void 0===p&&(p=null),void 0===c&&(c=b.Mesh.DEFAULTSIDE);var u=d.call(this,e,t,l,p)||this;return u.height=r,u.diameterTop=n,u.diameterBottom=o,u.tessellation=s,u.subdivisions=a,u.side=c,u}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.height=this.height,t.diameterTop=this.diameterTop,t.diameterBottom=this.diameterBottom,t.tessellation=this.tessellation,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.height,e.diameterTop,e.diameterBottom,e.tessellation,e.subdivisions,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.CylinderGeometry=a;var s=function(d){function o(e,t,r,n,o,s,a,l){void 0===a&&(a=null),void 0===l&&(l=b.Mesh.DEFAULTSIDE);var p=d.call(this,e,t,s,a)||this;return p.diameter=r,p.thickness=n,p.tessellation=o,p.side=l,p}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.diameter=this.diameter,t.thickness=this.thickness,t.tessellation=this.tessellation,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.diameter,e.thickness,e.tessellation,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.TorusGeometry=s;var l=function(d){function o(t,e,c,r,n,o,s){void 0===s&&(s=null);var a=d.call(this,t,e,o,s)||this;return a.width=c,a.height=r,a.subdivisions=n,a}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.width=this.width,t.height=this.height,t.subdivisions=this.subdivisions,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.width,e.height,e.subdivisions,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.GroundGeometry=l;var c=function(d){function t(t,e,p,r,n,o,s,a,l,f){void 0===f&&(f=null);var c=d.call(this,t,e,l,f)||this;return c.xmin=p,c.zmin=r,c.xmax=n,c.zmax=o,c.subdivisions=s,c.precision=a,c}return h(t,d),t.prototype._regenerateVertexData=function(){return b.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})},t.prototype.copy=function(r){return new t(r,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)},t}(t);b.TiledGroundGeometry=c;var p=function(d){function o(e,t,r,n,o,s){void 0===o&&(o=null),void 0===s&&(s=b.Mesh.DEFAULTSIDE);var a=d.call(this,e,t,n,o)||this;return a.size=r,a.side=s,a}return h(o,d),o.prototype._regenerateVertexData=function(){return b.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},o.prototype.serialize=function(){var t=d.prototype.serialize.call(this);return t.size=this.size,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.size,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.PlaneGeometry=p;var u=function(p){function o(e,t,r,n,o,s,a,l,_,c,u){void 0===c&&(c=null),void 0===u&&(u=b.Mesh.DEFAULTSIDE);var f=p.call(this,e,t,_,c)||this;return f.radius=r,f.tube=n,f.radialSegments=o,f.tubularSegments=s,f.p=a,f.q=l,f.side=u,f}return h(o,p),o.prototype._regenerateVertexData=function(){return b.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})},o.prototype.copy=function(t){return new o(t,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)},o.prototype.serialize=function(){var t=p.prototype.serialize.call(this);return t.radius=this.radius,t.tube=this.tube,t.radialSegments=this.radialSegments,t.tubularSegments=this.tubularSegments,t.p=this.p,t.q=this.q,t},o.Parse=function(e,t){if(t.getGeometryByID(e.id))return null;var r=new o(e.id,t,e.radius,e.tube,e.radialSegments,e.tubularSegments,e.p,e.q,e.canBeRegenerated,null);return b.Tags&&b.Tags.AddTagsTo(r,e.tags),t.pushGeometry(r,!0),r},o}(t);b.TorusKnotGeometry=u}(e||(e={}));var e;!function(d){var e=function(){function e(t){this._vertexBuffers={},this._scene=t}return e.prototype._prepareBuffers=function(){if(!this._vertexBuffers[d.VertexBuffer.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[d.VertexBuffer.PositionKind]=new d.VertexBuffer(this._scene.getEngine(),e,d.VertexBuffer.PositionKind,!1,!1,2),this._buildIndexBuffer()}},e.prototype._buildIndexBuffer=function(){var t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t)},e.prototype._rebuild=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())},e.prototype._prepareFrame=function(r,e){void 0===r&&(r=null),void 0===e&&(e=null);var t=this._scene.activeCamera;if(!t)return!1;var e=e||t._postProcesses.filter(function(t){return null!=t});return e&&0!==e.length&&this._scene.postProcessesEnabled&&(e[0].activate(t,r,null!==e&&void 0!==e),!0)},e.prototype.directRender=function(e,t,i){void 0===t&&(t=null),void 0===i&&(i=!1);for(var r=this._scene.getEngine(),n=0;n<e.length;n++){n<e.length-1?e[n+1].activate(this._scene.activeCamera,t):t?r.bindFramebuffer(t,0,void 0,void 0,i):r.restoreDefaultFramebuffer();var o=e[n],s=o.apply();s&&(o.onBeforeRenderObservable.notifyObservers(s),this._prepareBuffers(),r.bindBuffers(this._vertexBuffers,this._indexBuffer,s),r.drawElementsType(d.Material.TriangleFillMode,0,6),o.onAfterRenderObservable.notifyObservers(s))}r.setDepthBuffer(!0),r.setDepthWrite(!0)},e.prototype._finalizeFrame=function(e,p,i,r,n){void 0===n&&(n=!1);var o=this._scene.activeCamera;if(o&&(r=r||o._postProcesses.filter(function(t){return null!=t}),0!==r.length&&this._scene.postProcessesEnabled)){for(var s=this._scene.getEngine(),a=0,l=r.length,f,c;a<l&&(f=r[a],a<l-1?f._outputTexture=r[a+1].activate(o,p):p?(s.bindFramebuffer(p,i,void 0,void 0,n),f._outputTexture=p):(s.restoreDefaultFramebuffer(),f._outputTexture=null),!e);a++)c=f.apply(),c&&(f.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),s.bindBuffers(this._vertexBuffers,this._indexBuffer,c),s.drawElementsType(d.Material.TriangleFillMode,0,6),f.onAfterRenderObservable.notifyObservers(c));s.setDepthBuffer(!0),s.setDepthWrite(!0),s.setAlphaMode(d.Engine.ALPHA_DISABLE)}},e.prototype.dispose=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[d.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},e}();d.PostProcessManager=e}(e||(e={}));var e;!function(r){var e=function(){function e(r){void 0===r&&(r=30),this._enabled=!0,this._rollingFrameTime=new t(r)}return e.prototype.sampleFrame=function(e){if(void 0===e&&(e=r.Tools.Now),this._enabled){if(null!=this._lastFrameTimeMs){var t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}},Object.defineProperty(e.prototype,'averageFrameTime',{get:function(){return this._rollingFrameTime.average},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'averageFrameTimeVariance',{get:function(){return this._rollingFrameTime.variance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'instantaneousFrameTime',{get:function(){return this._rollingFrameTime.history(0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'averageFPS',{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'instantaneousFPS',{get:function(){var t=this._rollingFrameTime.history(0);return 0===t?0:1e3/t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isSaturated',{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!0,configurable:!0}),e.prototype.enable=function(){this._enabled=!0},e.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(e.prototype,'isEnabled',{get:function(){return this._enabled},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},e}();r.PerformanceMonitor=e;var t=function(){function t(t){this._samples=Array(t),this.reset()}return t.prototype.add=function(r){var e;if(this.isSaturated()){var t=this._samples[this._pos];e=t-this.average,this.average-=e/(this._sampleCount-1),this._m2-=e*(t-this.average)}else this._sampleCount++;e=r-this.average,this.average+=e/this._sampleCount,this._m2+=e*(r-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=r,this._pos++,this._pos%=this._samples.length},t.prototype.history=function(r){if(r>=this._sampleCount||r>=this._samples.length)return 0;var e=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(e-r)]},t.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},t.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},t.prototype._wrapPosition=function(r){var e=this._samples.length;return(r%e+e)%e},t}();r.RollingAverage=t}(e||(e={}));var e;!function(d){var e=function(){function r(){this.colorCurves=new d.ColorCurves,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new d.Color4(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=r.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new d.Observable}return Object.defineProperty(r.prototype,'colorCurvesEnabled',{get:function(){return this._colorCurvesEnabled},set:function(t){this._colorCurvesEnabled!==t&&(this._colorCurvesEnabled=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'colorGradingEnabled',{get:function(){return this._colorGradingEnabled},set:function(t){this._colorGradingEnabled!==t&&(this._colorGradingEnabled=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'colorGradingWithGreenDepth',{get:function(){return this._colorGradingWithGreenDepth},set:function(t){this._colorGradingWithGreenDepth!==t&&(this._colorGradingWithGreenDepth=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'colorGradingBGR',{get:function(){return this._colorGradingBGR},set:function(t){this._colorGradingBGR!==t&&(this._colorGradingBGR=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'exposure',{get:function(){return this._exposure},set:function(t){this._exposure!==t&&(this._exposure=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'toneMappingEnabled',{get:function(){return this._toneMappingEnabled},set:function(t){this._toneMappingEnabled!==t&&(this._toneMappingEnabled=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'contrast',{get:function(){return this._contrast},set:function(t){this._contrast!==t&&(this._contrast=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'vignetteBlendMode',{get:function(){return this._vignetteBlendMode},set:function(t){this._vignetteBlendMode!==t&&(this._vignetteBlendMode=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'vignetteEnabled',{get:function(){return this._vignetteEnabled},set:function(t){this._vignetteEnabled!==t&&(this._vignetteEnabled=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'applyByPostProcess',{get:function(){return this._applyByPostProcess},set:function(t){this._applyByPostProcess!==t&&(this._applyByPostProcess=t,this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'isEnabled',{get:function(){return this._isEnabled},set:function(t){this._isEnabled!==t&&(this._isEnabled=t,this._updateParameters())},enumerable:!0,configurable:!0}),r.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)},r.prototype.getClassName=function(){return'ImageProcessingConfiguration'},r.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push('exposureLinear'),t.CONTRAST&&e.push('contrast'),t.COLORGRADING&&e.push('colorTransformSettings'),t.VIGNETTE&&(e.push('vInverseScreenSize'),e.push('vignetteSettings1'),e.push('vignetteSettings2')),t.COLORCURVES&&d.ColorCurves.PrepareUniforms(e)},r.PrepareSamplers=function(r,e){e.COLORGRADING&&r.push('txColorTransform')},r.prototype.prepareDefines=function(t,e){return(void 0===e&&(e=!1),e!==this.applyByPostProcess||!this._isEnabled)?(t.VIGNETTE=!1,t.TONEMAPPING=!1,t.CONTRAST=!1,t.EXPOSURE=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.IMAGEPROCESSING=!1,void(t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled)):void(t.VIGNETTE=this.vignetteEnabled,t.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===r._VIGNETTEMODE_MULTIPLY,t.VIGNETTEBLENDMODEOPAQUE=!t.VIGNETTEBLENDMODEMULTIPLY,t.TONEMAPPING=this.toneMappingEnabled,t.CONTRAST=1!==this.contrast,t.EXPOSURE=1!==this.exposure,t.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,t.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,t.COLORGRADING3D=!!t.COLORGRADING&&this.colorGradingTexture.is3D,t.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,t.SAMPLER3DBGRMAP=this.colorGradingBGR,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,t.IMAGEPROCESSING=t.VIGNETTE||t.TONEMAPPING||t.CONTRAST||t.EXPOSURE||t.COLORCURVES||t.COLORGRADING)},r.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()},r.prototype.bind=function(e,t){if(void 0===t&&(t=1),this._colorCurvesEnabled&&this.colorCurves&&d.ColorCurves.Bind(this.colorCurves,e),this._vignetteEnabled){var i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();e.setFloat2('vInverseScreenSize',i,r);var n=y(.5*this.vignetteCameraFov),c=n*t,p=$(c*n);c=d.Tools.Mix(c,p,this.vignetteStretch),n=d.Tools.Mix(n,p,this.vignetteStretch),e.setFloat4('vignetteSettings1',c,n,-c*this.vignetteCentreX,-n*this.vignetteCentreY);var a=-2*this.vignetteWeight;e.setFloat4('vignetteSettings2',this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,a)}if(e.setFloat('exposureLinear',this.exposure),e.setFloat('contrast',this.contrast),this.colorGradingTexture){e.setTexture('txColorTransform',this.colorGradingTexture);var l=this.colorGradingTexture.getSize().height;e.setFloat4('colorTransformSettings',(l-1)/l,.5/l,l,this.colorGradingTexture.level)}},r.prototype.clone=function(){return d.SerializationHelper.Clone(function(){return new r},this)},r.prototype.serialize=function(){return d.SerializationHelper.Serialize(this)},r.Parse=function(e){return d.SerializationHelper.Parse(function(){return new r},e,null,null)},Object.defineProperty(r,'VIGNETTEMODE_MULTIPLY',{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:!0,configurable:!0}),Object.defineProperty(r,'VIGNETTEMODE_OPAQUE',{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:!0,configurable:!0}),r._VIGNETTEMODE_MULTIPLY=0,r._VIGNETTEMODE_OPAQUE=1,g([d.serializeAsColorCurves()],r.prototype,'colorCurves',void 0),g([d.serialize()],r.prototype,'_colorCurvesEnabled',void 0),g([d.serializeAsTexture()],r.prototype,'colorGradingTexture',void 0),g([d.serialize()],r.prototype,'_colorGradingEnabled',void 0),g([d.serialize()],r.prototype,'_colorGradingWithGreenDepth',void 0),g([d.serialize()],r.prototype,'_colorGradingBGR',void 0),g([d.serialize()],r.prototype,'_exposure',void 0),g([d.serialize()],r.prototype,'_toneMappingEnabled',void 0),g([d.serialize()],r.prototype,'_contrast',void 0),g([d.serialize()],r.prototype,'vignetteStretch',void 0),g([d.serialize()],r.prototype,'vignetteCentreX',void 0),g([d.serialize()],r.prototype,'vignetteCentreY',void 0),g([d.serialize()],r.prototype,'vignetteWeight',void 0),g([d.serializeAsColor4()],r.prototype,'vignetteColor',void 0),g([d.serialize()],r.prototype,'vignetteCameraFov',void 0),g([d.serialize()],r.prototype,'_vignetteBlendMode',void 0),g([d.serialize()],r.prototype,'_vignetteEnabled',void 0),g([d.serialize()],r.prototype,'_applyByPostProcess',void 0),g([d.serialize()],r.prototype,'_isEnabled',void 0),r}();d.ImageProcessingConfiguration=e}(e||(e={}));var e;!function(T){var e=function(e){function r(t,o){var r=e.call(this,o)||this;return t?(r._engine=o.getEngine(),r._textureMatrix=T.Matrix.Identity(),r.name=t,r.url=t,r.hasAlpha=!1,r.isCube=!1,r.is3D=1<r._engine.webGLVersion,r.wrapU=T.Texture.CLAMP_ADDRESSMODE,r.wrapV=T.Texture.CLAMP_ADDRESSMODE,r.wrapR=T.Texture.CLAMP_ADDRESSMODE,r.anisotropicFilteringLevel=1,r._texture=r._getFromCache(t,!0),r._texture||(o.useDelayedTextureLoading?r.delayLoadState=T.Engine.DELAYLOADSTATE_NOTLOADED:r.loadTexture()),r):r}return h(r,e),r.prototype.getTextureMatrix=function(){return this._textureMatrix},r.prototype.load3dlTexture=function(){var e=this._engine,i;i=1===e.webGLVersion?e.createRawTexture(null,1,1,T.Engine.TEXTUREFORMAT_RGBA,!1,!1,T.Texture.BILINEAR_SAMPLINGMODE):e.createRawTexture3D(null,1,1,1,T.Engine.TEXTUREFORMAT_RGBA,!1,!1,T.Texture.BILINEAR_SAMPLINGMODE),this._texture=i;var t=function(t){if('string'==typeof t){for(var x=null,s=null,a=t.split('\n'),l=0,h=0,c=0,u=0,f=0,d=0,p;d<a.length;d++)if(p=a[d],r._noneEmptyLineRegex.test(p)&&0!==p.indexOf('#')){var o=p.split(' ');if(!(0!==l))l=o.length,x=new Uint8Array(4*(l*l*l)),s=new Float32Array(4*(l*l*l));else if(0!=l){var _=W(parseInt(o[0]),0),m=W(parseInt(o[1]),0),g=W(parseInt(o[2]),0);f=W(_,f),f=W(m,f),f=W(g,f);var E=4*(h+u*l+c*l*l);s&&(s[E+0]=_,s[E+1]=m,s[E+2]=g),u++,0==u%l&&(c++,u=0,0==c%l&&(h++,c=0))}}if(s&&x)for(var d=0;d<s.length;d++)if(0<d&&0==(d+1)%4)x[d]=255;else{var y=s[d];x[d]=255*(y/f)}i.is3D?(i.updateSize(l,l,l),e.updateRawTexture3D(i,x,T.Engine.TEXTUREFORMAT_RGBA,!1)):(i.updateSize(l*l,l),e.updateRawTexture(i,x,T.Engine.TEXTUREFORMAT_RGBA,!1))}},a=this.getScene();return a?a._loadFile(this.url,t):this._engine._loadFile(this.url,t),this._texture},r.prototype.loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf('.3dl')==this.url.length-4&&this.load3dlTexture()},r.prototype.clone=function(){var t=new r(this.url,this.getScene());return t.level=this.level,t},r.prototype.delayLoad=function(){this.delayLoadState===T.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=T.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,!0),this._texture||this.loadTexture())},r.Parse=function(o,e){var t=null;return o.name&&!o.isRenderTarget&&(t=new r(o.name,e),t.name=o.name,t.level=o.level),t},r.prototype.serialize=function(){if(!this.name)return null;var t={};return t.name=this.name,t.level=this.level,t.customType='BABYLON.ColorGradingTexture',t},r._noneEmptyLineRegex=/\S+/,r}(T.BaseTexture);T.ColorGradingTexture=e}(e||(e={}));var e;!function(r){var e=function(){function d(){this._dirty=!0,this._tempColor=new r.Color4(0,0,0,0),this._globalCurve=new r.Color4(0,0,0,0),this._highlightsCurve=new r.Color4(0,0,0,0),this._midtonesCurve=new r.Color4(0,0,0,0),this._shadowsCurve=new r.Color4(0,0,0,0),this._positiveCurve=new r.Color4(0,0,0,0),this._negativeCurve=new r.Color4(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(d.prototype,'globalHue',{get:function(){return this._globalHue},set:function(t){this._globalHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'globalDensity',{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'globalSaturation',{get:function(){return this._globalSaturation},set:function(t){this._globalSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'highlightsHue',{get:function(){return this._highlightsHue},set:function(t){this._highlightsHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'highlightsDensity',{get:function(){return this._highlightsDensity},set:function(t){this._highlightsDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'highlightsSaturation',{get:function(){return this._highlightsSaturation},set:function(t){this._highlightsSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'highlightsExposure',{get:function(){return this._highlightsExposure},set:function(t){this._highlightsExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'midtonesHue',{get:function(){return this._midtonesHue},set:function(t){this._midtonesHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'midtonesDensity',{get:function(){return this._midtonesDensity},set:function(t){this._midtonesDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'midtonesSaturation',{get:function(){return this._midtonesSaturation},set:function(t){this._midtonesSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'midtonesExposure',{get:function(){return this._midtonesExposure},set:function(t){this._midtonesExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'shadowsHue',{get:function(){return this._shadowsHue},set:function(t){this._shadowsHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'shadowsDensity',{get:function(){return this._shadowsDensity},set:function(t){this._shadowsDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'shadowsSaturation',{get:function(){return this._shadowsSaturation},set:function(t){this._shadowsSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'shadowsExposure',{get:function(){return this._shadowsExposure},set:function(t){this._shadowsExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),d.prototype.getClassName=function(){return'ColorCurves'},d.Bind=function(o,e,t,i,r){void 0===t&&(t='vCameraColorCurvePositive'),void 0===i&&(i='vCameraColorCurveNeutral'),void 0===r&&(r='vCameraColorCurveNegative'),o._dirty&&(o._dirty=!1,o.getColorGradingDataToRef(o._globalHue,o._globalDensity,o._globalSaturation,o._globalExposure,o._globalCurve),o.getColorGradingDataToRef(o._highlightsHue,o._highlightsDensity,o._highlightsSaturation,o._highlightsExposure,o._tempColor),o._tempColor.multiplyToRef(o._globalCurve,o._highlightsCurve),o.getColorGradingDataToRef(o._midtonesHue,o._midtonesDensity,o._midtonesSaturation,o._midtonesExposure,o._tempColor),o._tempColor.multiplyToRef(o._globalCurve,o._midtonesCurve),o.getColorGradingDataToRef(o._shadowsHue,o._shadowsDensity,o._shadowsSaturation,o._shadowsExposure,o._tempColor),o._tempColor.multiplyToRef(o._globalCurve,o._shadowsCurve),o._highlightsCurve.subtractToRef(o._midtonesCurve,o._positiveCurve),o._midtonesCurve.subtractToRef(o._shadowsCurve,o._negativeCurve)),e&&(e.setFloat4(t,o._positiveCurve.r,o._positiveCurve.g,o._positiveCurve.b,o._positiveCurve.a),e.setFloat4(i,o._midtonesCurve.r,o._midtonesCurve.g,o._midtonesCurve.b,o._midtonesCurve.a),e.setFloat4(r,o._negativeCurve.r,o._negativeCurve.g,o._negativeCurve.b,o._negativeCurve.a))},d.PrepareUniforms=function(t){t.push('vCameraColorCurveNeutral','vCameraColorCurvePositive','vCameraColorCurveNegative')},d.prototype.getColorGradingDataToRef=function(t,e,i,r,a){null!=t&&(t=d.clamp(t,0,360),e=d.clamp(e,-100,100),i=d.clamp(i,-100,100),r=d.clamp(r,-100,100),e=d.applyColorGradingSliderNonlinear(e),e*=.5,r=d.applyColorGradingSliderNonlinear(r),0>e&&(e*=-1,t=(t+180)%360),d.fromHSBToRef(t,e,50+.25*r,a),a.scaleToRef(2,a),a.a=1+.01*i)},d.applyColorGradingSliderNonlinear=function(r){r/=100;var e=A(r);return e=x(e,2),0>r&&(e*=-1),e*=100},d.fromHSBToRef=function(t,e,i,r){var n=d.clamp(t,0,360),o=d.clamp(e/100,0,1),s=d.clamp(i/100,0,1);if(0===o)r.r=s,r.g=s,r.b=s;else{n/=60;var a=ee(n),l=n-a,p=s*(1-o),c=s*(1-o*l),u=s*(1-o*(1-l));0===a?(r.r=s,r.g=u,r.b=p):1===a?(r.r=c,r.g=s,r.b=p):2===a?(r.r=p,r.g=s,r.b=u):3===a?(r.r=p,r.g=c,r.b=s):4===a?(r.r=u,r.g=p,r.b=s):(r.r=s,r.g=p,r.b=c)}r.a=1},d.clamp=function(r,e,t){return C(W(r,e),t)},d.prototype.clone=function(){return r.SerializationHelper.Clone(function(){return new d},this)},d.prototype.serialize=function(){return r.SerializationHelper.Serialize(this)},d.Parse=function(e){return r.SerializationHelper.Parse(function(){return new d},e,null,null)},g([r.serialize()],d.prototype,'_globalHue',void 0),g([r.serialize()],d.prototype,'_globalDensity',void 0),g([r.serialize()],d.prototype,'_globalSaturation',void 0),g([r.serialize()],d.prototype,'_globalExposure',void 0),g([r.serialize()],d.prototype,'_highlightsHue',void 0),g([r.serialize()],d.prototype,'_highlightsDensity',void 0),g([r.serialize()],d.prototype,'_highlightsSaturation',void 0),g([r.serialize()],d.prototype,'_highlightsExposure',void 0),g([r.serialize()],d.prototype,'_midtonesHue',void 0),g([r.serialize()],d.prototype,'_midtonesDensity',void 0),g([r.serialize()],d.prototype,'_midtonesSaturation',void 0),g([r.serialize()],d.prototype,'_midtonesExposure',void 0),d}();r.ColorCurves=e}(e||(e={}));var e;!function(y){var e=function(){function e(){}return e.BindEyePosition=function(r,e){return e._forcedViewPosition?void r.setVector3('vEyePosition',e._forcedViewPosition):void r.setVector3('vEyePosition',e._mirroredCameraPosition?e._mirroredCameraPosition:e.activeCamera.globalPosition)},e.PrepareDefinesForMergedUV=function(r,e,t){e._needUVs=!0,e[t]=!0,r.getTextureMatrix().isIdentity(!0)?(e[t+'DIRECTUV']=r.coordinatesIndex+1,0===r.coordinatesIndex?e.MAINUV1=!0:e.MAINUV2=!0):e[t+'DIRECTUV']=0},e.BindTextureMatrix=function(o,e,t){var i=o.getTextureMatrix();i.isIdentity(!0)||e.updateMatrix(t+'Matrix',i)},e.PrepareDefinesForMisc=function(e,t,i,r,n,o,s){s._areMiscDirty&&(s.LOGARITHMICDEPTH=i,s.POINTSIZE=r,s.FOG=t.fogEnabled&&e.applyFog&&t.fogMode!==y.Scene.FOGMODE_NONE&&n,s.NONUNIFORMSCALING=e.nonUniformScaling,s.ALPHATEST=o)},e.PrepareDefinesForFrameBoundValues=function(a,e,t,i,r){void 0===r&&(r=null);var n=!1;null==r&&(r=void 0!==a.clipPlane&&null!==a.clipPlane),t.CLIPPLANE!==r&&(t.CLIPPLANE=r,n=!0),t.DEPTHPREPASS!==!e.getColorWrite()&&(t.DEPTHPREPASS=!t.DEPTHPREPASS,n=!0),t.INSTANCES!==i&&(t.INSTANCES=i,n=!0),n&&t.markAsUnprocessed()},e.PrepareDefinesForAttributes=function(e,t,i,r,n,o){if(void 0===n&&(n=!1),void 0===o&&(o=!0),!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;if(t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(y.VertexBuffer.NormalKind),t._needNormals&&e.isVerticesDataPresent(y.VertexBuffer.TangentKind)&&(t.TANGENT=!0),t._needUVs?(t.UV1=e.isVerticesDataPresent(y.VertexBuffer.UVKind),t.UV2=e.isVerticesDataPresent(y.VertexBuffer.UV2Kind)):(t.UV1=!1,t.UV2=!1),i){var s=e.useVertexColors&&e.isVerticesDataPresent(y.VertexBuffer.ColorKind);t.VERTEXCOLOR=s,t.VERTEXALPHA=e.hasVertexAlpha&&s&&o}if(r&&(e.useBones&&e.computeBonesUsingShaders&&e.skeleton?(t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers,t.BonesPerMesh=e.skeleton.bones.length+1):(t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0)),n){var a=e.morphTargetManager;a?(t.MORPHTARGETS_TANGENT=a.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=a.supportsNormals&&t.NORMAL,t.MORPHTARGETS=0<a.numInfluencers,t.NUM_MORPH_INFLUENCERS=a.numInfluencers):(t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}return!0},e.PrepareDefinesForLights=function(e,t,i,r,n,o){if(void 0===n&&(n=4),void 0===o&&(o=!1),!i._areLightsDirty)return i._needNormals;var T=0,a=!1,l=!1,h=!1,c=!1,u=!1;if(e.lightsEnabled&&!o)for(var f=0,d=t._lightSources,p;f<d.length;f++){p=d[f],a=!0,void 0===i['LIGHT'+T]&&(l=!0),i['LIGHT'+T]=!0,i['SPOTLIGHT'+T]=!1,i['HEMILIGHT'+T]=!1,i['POINTLIGHT'+T]=!1,i['DIRLIGHT'+T]=!1;var _;if(p.getTypeID()===y.Light.LIGHTTYPEID_SPOTLIGHT){_='SPOTLIGHT'+T;var m=p;i['PROJECTEDLIGHTTEXTURE'+T]=!!m.projectionTexture}else _=p.getTypeID()===y.Light.LIGHTTYPEID_HEMISPHERICLIGHT?'HEMILIGHT'+T:p.getTypeID()===y.Light.LIGHTTYPEID_POINTLIGHT?'POINTLIGHT'+T:'DIRLIGHT'+T;if(i[_]=!0,r&&!p.specular.equalsFloats(0,0,0)&&(u=!0),i['SHADOW'+T]=!1,i['SHADOWPCF'+T]=!1,i['SHADOWPCSS'+T]=!1,i['SHADOWPOISSON'+T]=!1,i['SHADOWESM'+T]=!1,i['SHADOWCUBE'+T]=!1,i['SHADOWLOWQUALITY'+T]=!1,i['SHADOWMEDIUMQUALITY'+T]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&p.shadowEnabled){var g=p.getShadowGenerator();g&&(c=!0,g.prepareDefines(i,T))}if(p.lightmapMode==y.Light.LIGHTMAP_DEFAULT?(i['LIGHTMAPEXCLUDED'+T]=!1,i['LIGHTMAPNOSPECULAR'+T]=!1):(h=!0,i['LIGHTMAPEXCLUDED'+T]=!0,i['LIGHTMAPNOSPECULAR'+T]=p.lightmapMode==y.Light.LIGHTMAP_SHADOWSONLY),++T===n)break}i.SPECULARTERM=u,i.SHADOWS=c;for(var x=T;x<n;x++)void 0!==i['LIGHT'+x]&&(i['LIGHT'+x]=!1,i['HEMILIGHT'+T]=!1,i['POINTLIGHT'+T]=!1,i['DIRLIGHT'+T]=!1,i['SPOTLIGHT'+T]=!1,i['SHADOW'+T]=!1);var E=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(l=!0),i.SHADOWFLOAT=c&&(E.textureFloatRender&&E.textureFloatLinearFiltering||E.textureHalfFloatRender&&E.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=h,l&&i.rebuild(),a},e.PrepareUniformsAndSamplersList=function(l,e,t,i){void 0===i&&(i=4);var r=null,o;if(l.uniformsNames){var n=l;o=n.uniformsNames,r=n.uniformBuffersNames,e=n.samplers,t=n.defines,i=n.maxSimultaneousLights}else o=l,e||(e=[]);for(var s=0;s<i&&t['LIGHT'+s];s++)o.push('vLightData'+s,'vLightDiffuse'+s,'vLightSpecular'+s,'vLightDirection'+s,'vLightGround'+s,'lightMatrix'+s,'shadowsInfo'+s,'depthValues'+s),r&&r.push('Light'+s),e.push('shadowSampler'+s),e.push('depthSampler'+s),t['PROJECTEDLIGHTTEXTURE'+s]&&(e.push('projectionLightSampler'+s),o.push('textureProjectionMatrix'+s));t.NUM_MORPH_INFLUENCERS&&o.push('morphTargetInfluences')},e.HandleFallbacksForShadows=function(a,e,t,i){void 0===t&&(t=4),void 0===i&&(i=0);for(var r=0,n=0;n<t&&a['LIGHT'+n];n++)0<n&&(r=i+n,e.addFallback(r,'LIGHT'+n)),a.SHADOWS||(a['SHADOW'+n]&&e.addFallback(i,'SHADOW'+n),a['SHADOWPCF'+n]&&e.addFallback(i,'SHADOWPCF'+n),a['SHADOWPCSS'+n]&&e.addFallback(i,'SHADOWPCSS'+n),a['SHADOWPOISSON'+n]&&e.addFallback(i,'SHADOWPOISSON'+n),a['SHADOWESM'+n]&&e.addFallback(i,'SHADOWESM'+n));return r++},e.PrepareAttributesForMorphTargets=function(e,t,i){var r=i.NUM_MORPH_INFLUENCERS;if(0<r&&y.Engine.LastCreatedEngine)for(var n=y.Engine.LastCreatedEngine.getCaps().maxVertexAttribs,o=t.morphTargetManager,s=o&&o.supportsNormals&&i.NORMAL,a=o&&o.supportsTangents&&i.TANGENT,l=0;l<r;l++)e.push(y.VertexBuffer.PositionKind+l),s&&e.push(y.VertexBuffer.NormalKind+l),a&&e.push(y.VertexBuffer.TangentKind+l),e.length>n&&y.Tools.Error('Cannot add more vertex attributes for mesh '+t.name)},e.PrepareAttributesForBones=function(e,t,o,r){0<o.NUM_BONE_INFLUENCERS&&(r.addCPUSkinningFallback(0,t),e.push(y.VertexBuffer.MatricesIndicesKind),e.push(y.VertexBuffer.MatricesWeightsKind),4<o.NUM_BONE_INFLUENCERS&&(e.push(y.VertexBuffer.MatricesIndicesExtraKind),e.push(y.VertexBuffer.MatricesWeightsExtraKind)))},e.PrepareAttributesForInstances=function(r,e){e.INSTANCES&&(r.push('world0'),r.push('world1'),r.push('world2'),r.push('world3'))},e.BindLightShadow=function(a,e,t,i,r){if(a.shadowEnabled&&t.receiveShadows){var n=a.getShadowGenerator();n&&n.bindShadowLight(i,r)}},e.BindLightProperties=function(r,e,t){r.transferToEffect(e,t+'')},e.BindLights=function(t,i,r,n,o,s){void 0===o&&(o=4),void 0===s&&(s=!1);for(var a=C(i._lightSources.length,o),l=0;l<a;l++){var d=i._lightSources[l],c=l.toString(),p=d.getScaledIntensity();d._uniformBuffer.bindToEffect(r,'Light'+l),e.BindLightProperties(d,r,l),d.diffuse.scaleToRef(p,y.Tmp.Color3[0]),d._uniformBuffer.updateColor4('vLightDiffuse',y.Tmp.Color3[0],s?d.radius:d.range,c),n.SPECULARTERM&&(d.specular.scaleToRef(p,y.Tmp.Color3[1]),d._uniformBuffer.updateColor3('vLightSpecular',y.Tmp.Color3[1],c)),t.shadowsEnabled&&this.BindLightShadow(d,t,i,c,r),d._uniformBuffer.update()}},e.BindFogParameters=function(e,t,o){e.fogEnabled&&t.applyFog&&e.fogMode!==y.Scene.FOGMODE_NONE&&(o.setFloat4('vFogInfos',e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),o.setColor3('vFogColor',e.fogColor))},e.BindBonesParameters=function(r,e){if(e&&r&&(r.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(r.computeBonesUsingShaders=!1),r.useBones&&r.computeBonesUsingShaders&&r.skeleton)){var t=r.skeleton.getTransformMatrices(r);t&&e.setMatrices('mBones',t)}},e.BindMorphTargetParameters=function(r,e){var t=r.morphTargetManager;r&&t&&e.setFloatArray('morphTargetInfluences',t.influences)},e.BindLogDepth=function(r,e,t){r.LOGARITHMICDEPTH&&e.setFloat('logarithmicDepthConstant',2/(m(t.activeCamera.maxZ+1)/_))},e.BindClipPlane=function(r,e){if(e.clipPlane){var t=e.clipPlane;r.setFloat4('vClipPlane',t.normal.x,t.normal.y,t.normal.z,t.d)}},e}();y.MaterialHelper=e}(e||(e={}));var e;!function(o){var e=function(a){function e(e,t){var r=a.call(this,e,t)||this;return r._normalMatrix=new o.Matrix,r.storeEffectOnSubMeshes=!0,r}return h(e,a),e.prototype.getEffect=function(){return this._activeEffect},e.prototype.isReady=function(r,o){return!!r&&(!r.subMeshes||0===r.subMeshes.length||this.isReadyForSubMesh(r,r.subMeshes[0],o))},e.prototype.bindOnlyWorldMatrix=function(t){this._activeEffect.setMatrix('world',t)},e.prototype.bindOnlyNormalMatrix=function(t){this._activeEffect.setMatrix('normalMatrix',t)},e.prototype.bind=function(r,e){e&&this.bindForSubMesh(r,e,e.subMeshes[0])},e.prototype._afterBind=function(t,e){void 0===e&&(e=null),a.prototype._afterBind.call(this,t),this.getScene()._cachedEffect=e},e.prototype._mustRebind=function(r,e,t){return void 0===t&&(t=1),r.isCachedMaterialInvalid(this,e,t)},e}(o.Material);o.PushMaterial=e}(e||(e={}));var e;!function(m){var e=function(r){function e(){var e=r.call(this)||this;return e.MAINUV1=!1,e.MAINUV2=!1,e.DIFFUSE=!1,e.DIFFUSEDIRECTUV=0,e.AMBIENT=!1,e.AMBIENTDIRECTUV=0,e.OPACITY=!1,e.OPACITYDIRECTUV=0,e.OPACITYRGB=!1,e.REFLECTION=!1,e.EMISSIVE=!1,e.EMISSIVEDIRECTUV=0,e.SPECULAR=!1,e.SPECULARDIRECTUV=0,e.BUMP=!1,e.BUMPDIRECTUV=0,e.PARALLAX=!1,e.PARALLAXOCCLUSION=!1,e.SPECULAROVERALPHA=!1,e.CLIPPLANE=!1,e.ALPHATEST=!1,e.DEPTHPREPASS=!1,e.ALPHAFROMDIFFUSE=!1,e.POINTSIZE=!1,e.FOG=!1,e.SPECULARTERM=!1,e.DIFFUSEFRESNEL=!1,e.OPACITYFRESNEL=!1,e.REFLECTIONFRESNEL=!1,e.REFRACTIONFRESNEL=!1,e.EMISSIVEFRESNEL=!1,e.FRESNEL=!1,e.NORMAL=!1,e.UV1=!1,e.UV2=!1,e.VERTEXCOLOR=!1,e.VERTEXALPHA=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.GLOSSINESS=!1,e.ROUGHNESS=!1,e.EMISSIVEASILLUMINATION=!1,e.LINKEMISSIVEWITHDIFFUSE=!1,e.REFLECTIONFRESNELFROMSPECULAR=!1,e.LIGHTMAP=!1,e.LIGHTMAPDIRECTUV=0,e.OBJECTSPACE_NORMALMAP=!1,e.USELIGHTMAPASSHADOWMAP=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.LOGARITHMICDEPTH=!1,e.REFRACTION=!1,e.REFRACTIONMAP_3D=!1,e.REFLECTIONOVERALPHA=!1,e.TWOSIDEDLIGHTING=!1,e.SHADOWFLOAT=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.NUM_MORPH_INFLUENCERS=0,e.NONUNIFORMSCALING=!1,e.PREMULTIPLYALPHA=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.IS_REFLECTION_LINEAR=!1,e.IS_REFRACTION_LINEAR=!1,e.EXPOSURE=!1,e.rebuild(),e}return h(e,r),e.prototype.setReflectionMode=function(o){for(var e=['REFLECTIONMAP_CUBIC','REFLECTIONMAP_EXPLICIT','REFLECTIONMAP_PLANAR','REFLECTIONMAP_PROJECTION','REFLECTIONMAP_PROJECTION','REFLECTIONMAP_SKYBOX','REFLECTIONMAP_SPHERICAL','REFLECTIONMAP_EQUIRECTANGULAR','REFLECTIONMAP_EQUIRECTANGULAR_FIXED','REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED'],t=0,i=e,r;t<i.length;t++)r=i[t],this[r]=r===o},e}(m.MaterialDefines);m.StandardMaterialDefines=e;var t=function(a){function y(e,t){var r=a.call(this,e,t)||this;return r.ambientColor=new m.Color3(0,0,0),r.diffuseColor=new m.Color3(1,1,1),r.specularColor=new m.Color3(1,1,1),r.emissiveColor=new m.Color3(0,0,0),r.specularPower=64,r._useAlphaFromDiffuseTexture=!1,r._useEmissiveAsIllumination=!1,r._linkEmissiveWithDiffuse=!1,r._useSpecularOverAlpha=!1,r._useReflectionOverAlpha=!1,r._disableLighting=!1,r._useObjectSpaceNormalMap=!1,r._useParallax=!1,r._useParallaxOcclusion=!1,r.parallaxScaleBias=.05,r._roughness=0,r.indexOfRefraction=.98,r.invertRefractionY=!0,r.alphaCutOff=.4,r._useLightmapAsShadowmap=!1,r._useReflectionFresnelFromSpecular=!1,r._useGlossinessFromSpecularMapAlpha=!1,r._maxSimultaneousLights=4,r._invertNormalMapX=!1,r._invertNormalMapY=!1,r._twoSidedLighting=!1,r._renderTargets=new m.SmartArray(16),r._worldViewProjectionMatrix=m.Matrix.Zero(),r._globalAmbientColor=new m.Color3(0,0,0),r._attachImageProcessingConfiguration(null),r.getRenderTargetTextures=function(){return r._renderTargets.reset(),y.ReflectionTextureEnabled&&r._reflectionTexture&&r._reflectionTexture.isRenderTarget&&r._renderTargets.push(r._reflectionTexture),y.RefractionTextureEnabled&&r._refractionTexture&&r._refractionTexture.isRenderTarget&&r._renderTargets.push(r._refractionTexture),r._renderTargets},r}return h(y,a),Object.defineProperty(y.prototype,'imageProcessingConfiguration',{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!0,configurable:!0}),y.prototype._attachImageProcessingConfiguration=function(r){var e=this;r!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=r||this.getScene().imageProcessingConfiguration,this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){e._markAllSubMeshesAsImageProcessingDirty()}))},Object.defineProperty(y.prototype,'cameraColorCurvesEnabled',{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraColorGradingEnabled',{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraToneMappingEnabled',{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraExposure',{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraContrast',{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraColorGradingTexture',{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this._imageProcessingConfiguration.colorGradingTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,'cameraColorCurves',{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(t){this._imageProcessingConfiguration.colorCurves=t},enumerable:!0,configurable:!0}),y.prototype.getClassName=function(){return'StandardMaterial'},Object.defineProperty(y.prototype,'useLogarithmicDepth',{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()},enumerable:!0,configurable:!0}),y.prototype.needAlphaBlending=function(){return 1>this.alpha||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled},y.prototype.needAlphaTesting=function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha},y.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture},y.prototype.getAlphaTestTexture=function(){return this._diffuseTexture},y.prototype.isReadyForSubMesh=function(t,r,i){if(void 0===i&&(i=!1),r.effect&&this.isFrozen&&this._wasPreviouslyReady&&r.effect)return!0;r._materialDefines||(r._materialDefines=new e);var o=this.getScene(),n=r._materialDefines;if(!this.checkReadyOnEveryCall&&r.effect&&n._renderId===o.getRenderId())return!0;var s=o.getEngine();if(n._needNormals=m.MaterialHelper.PrepareDefinesForLights(o,t,n,!0,this._maxSimultaneousLights,this._disableLighting),n._areTexturesDirty){if(n._needUVs=!1,n.MAINUV1=!1,n.MAINUV2=!1,o.texturesEnabled){if(this._diffuseTexture&&y.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,n,'DIFFUSE')}else n.DIFFUSE=!1;if(this._ambientTexture&&y.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,n,'AMBIENT')}else n.AMBIENT=!1;if(this._opacityTexture&&y.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,n,'OPACITY'),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else n.OPACITY=!1;if(this._reflectionTexture&&y.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(n._needNormals=!0,n.REFLECTION=!0,n.ROUGHNESS=0<this._roughness,n.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,n.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===m.Texture.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this._reflectionTexture.isCube,this._reflectionTexture.coordinatesMode){case m.Texture.EXPLICIT_MODE:n.setReflectionMode('REFLECTIONMAP_EXPLICIT');break;case m.Texture.PLANAR_MODE:n.setReflectionMode('REFLECTIONMAP_PLANAR');break;case m.Texture.PROJECTION_MODE:n.setReflectionMode('REFLECTIONMAP_PROJECTION');break;case m.Texture.SKYBOX_MODE:n.setReflectionMode('REFLECTIONMAP_SKYBOX');break;case m.Texture.SPHERICAL_MODE:n.setReflectionMode('REFLECTIONMAP_SPHERICAL');break;case m.Texture.EQUIRECTANGULAR_MODE:n.setReflectionMode('REFLECTIONMAP_EQUIRECTANGULAR');break;case m.Texture.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode('REFLECTIONMAP_EQUIRECTANGULAR_FIXED');break;case m.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode('REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED');break;case m.Texture.CUBIC_MODE:case m.Texture.INVCUBIC_MODE:default:n.setReflectionMode('REFLECTIONMAP_CUBIC');}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else n.REFLECTION=!1;if(this._emissiveTexture&&y.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,n,'EMISSIVE')}else n.EMISSIVE=!1;if(this._lightmapTexture&&y.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,n,'LIGHTMAP'),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap}else n.LIGHTMAP=!1;if(this._specularTexture&&y.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._specularTexture,n,'SPECULAR'),n.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else n.SPECULAR=!1;if(o.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&y.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;m.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,n,'BUMP'),n.PARALLAX=this._useParallax,n.PARALLAXOCCLUSION=this._useParallaxOcclusion,n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else n.BUMP=!1;if(this._refractionTexture&&y.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;n._needUVs=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this._refractionTexture.isCube}else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),n.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,n.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,n.SPECULAROVERALPHA=this._useSpecularOverAlpha,n.PREMULTIPLYALPHA=this.alphaMode===m.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===m.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF}if(n._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n),n.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}if(n._areFresnelDirty&&(y.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(n.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,n.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,n.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,n.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,n.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,n._needNormals=!0,n.FRESNEL=!0):n.FRESNEL=!1),m.MaterialHelper.PrepareDefinesForMisc(t,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t),n),m.MaterialHelper.PrepareDefinesForAttributes(t,n,!0,!0,!0),m.MaterialHelper.PrepareDefinesForFrameBoundValues(o,s,n,i),n.isDirty){n.markAsProcessed(),o.resetCachedMaterial();var l=new m.EffectFallbacks;n.REFLECTION&&l.addFallback(0,'REFLECTION'),n.SPECULAR&&l.addFallback(0,'SPECULAR'),n.BUMP&&l.addFallback(0,'BUMP'),n.PARALLAX&&l.addFallback(1,'PARALLAX'),n.PARALLAXOCCLUSION&&l.addFallback(0,'PARALLAXOCCLUSION'),n.SPECULAROVERALPHA&&l.addFallback(0,'SPECULAROVERALPHA'),n.FOG&&l.addFallback(1,'FOG'),n.POINTSIZE&&l.addFallback(0,'POINTSIZE'),n.LOGARITHMICDEPTH&&l.addFallback(0,'LOGARITHMICDEPTH'),m.MaterialHelper.HandleFallbacksForShadows(n,l,this._maxSimultaneousLights),n.SPECULARTERM&&l.addFallback(0,'SPECULARTERM'),n.DIFFUSEFRESNEL&&l.addFallback(1,'DIFFUSEFRESNEL'),n.OPACITYFRESNEL&&l.addFallback(2,'OPACITYFRESNEL'),n.REFLECTIONFRESNEL&&l.addFallback(3,'REFLECTIONFRESNEL'),n.EMISSIVEFRESNEL&&l.addFallback(4,'EMISSIVEFRESNEL'),n.FRESNEL&&l.addFallback(4,'FRESNEL');var g=[m.VertexBuffer.PositionKind];n.NORMAL&&g.push(m.VertexBuffer.NormalKind),n.UV1&&g.push(m.VertexBuffer.UVKind),n.UV2&&g.push(m.VertexBuffer.UV2Kind),n.VERTEXCOLOR&&g.push(m.VertexBuffer.ColorKind),m.MaterialHelper.PrepareAttributesForBones(g,t,n,l),m.MaterialHelper.PrepareAttributesForInstances(g,n),m.MaterialHelper.PrepareAttributesForMorphTargets(g,t,n);var T='default',u=['world','view','viewProjection','vEyePosition','vLightsType','vAmbientColor','vDiffuseColor','vSpecularColor','vEmissiveColor','vFogInfos','vFogColor','pointSize','vDiffuseInfos','vAmbientInfos','vOpacityInfos','vReflectionInfos','vEmissiveInfos','vSpecularInfos','vBumpInfos','vLightmapInfos','vRefractionInfos','mBones','vClipPlane','diffuseMatrix','ambientMatrix','opacityMatrix','reflectionMatrix','emissiveMatrix','specularMatrix','bumpMatrix','normalMatrix','lightmapMatrix','refractionMatrix','diffuseLeftColor','diffuseRightColor','opacityParts','reflectionLeftColor','reflectionRightColor','emissiveLeftColor','emissiveRightColor','refractionLeftColor','refractionRightColor','vReflectionPosition','vReflectionSize','logarithmicDepthConstant','vTangentSpaceParams','alphaCutOff'],x=['diffuseSampler','ambientSampler','opacitySampler','reflectionCubeSampler','reflection2DSampler','emissiveSampler','specularSampler','bumpSampler','lightmapSampler','refractionCubeSampler','refraction2DSampler'],b=['Material','Scene'];m.ImageProcessingConfiguration.PrepareUniforms(u,n),m.ImageProcessingConfiguration.PrepareSamplers(x,n),m.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:u,uniformBuffersNames:b,samplers:x,defines:n,maxSimultaneousLights:this._maxSimultaneousLights}),this.customShaderNameResolve&&(T=this.customShaderNameResolve(T,u,b,x,n));var E=n.toString();r.setEffect(o.getEngine().createEffect(T,{attributes:g,uniformsNames:u,uniformBuffersNames:b,samplers:x,defines:E,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS}},s),n),this.buildUniformLayout()}return r.effect&&r.effect.isReady()&&(n._renderId=o.getRenderId(),this._wasPreviouslyReady=!0,!0)},y.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform('diffuseLeftColor',4),this._uniformBuffer.addUniform('diffuseRightColor',4),this._uniformBuffer.addUniform('opacityParts',4),this._uniformBuffer.addUniform('reflectionLeftColor',4),this._uniformBuffer.addUniform('reflectionRightColor',4),this._uniformBuffer.addUniform('refractionLeftColor',4),this._uniformBuffer.addUniform('refractionRightColor',4),this._uniformBuffer.addUniform('emissiveLeftColor',4),this._uniformBuffer.addUniform('emissiveRightColor',4),this._uniformBuffer.addUniform('vDiffuseInfos',2),this._uniformBuffer.addUniform('vAmbientInfos',2),this._uniformBuffer.addUniform('vOpacityInfos',2),this._uniformBuffer.addUniform('vReflectionInfos',2),this._uniformBuffer.addUniform('vReflectionPosition',3),this._uniformBuffer.addUniform('vReflectionSize',3),this._uniformBuffer.addUniform('vEmissiveInfos',2),this._uniformBuffer.addUniform('vLightmapInfos',2),this._uniformBuffer.addUniform('vSpecularInfos',2),this._uniformBuffer.addUniform('vBumpInfos',3),this._uniformBuffer.addUniform('diffuseMatrix',16),this._uniformBuffer.addUniform('ambientMatrix',16),this._uniformBuffer.addUniform('opacityMatrix',16),this._uniformBuffer.addUniform('reflectionMatrix',16),this._uniformBuffer.addUniform('emissiveMatrix',16),this._uniformBuffer.addUniform('lightmapMatrix',16),this._uniformBuffer.addUniform('specularMatrix',16),this._uniformBuffer.addUniform('bumpMatrix',16),this._uniformBuffer.addUniform('vTangentSpaceParams',2),this._uniformBuffer.addUniform('refractionMatrix',16),this._uniformBuffer.addUniform('vRefractionInfos',4),this._uniformBuffer.addUniform('vSpecularColor',4),this._uniformBuffer.addUniform('vEmissiveColor',3),this._uniformBuffer.addUniform('vDiffuseColor',4),this._uniformBuffer.addUniform('pointSize',1),this._uniformBuffer.create()},y.prototype.unbind=function(){if(this._activeEffect){var t=!1;this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&(this._activeEffect.setTexture('reflection2DSampler',null),t=!0),this._refractionTexture&&this._refractionTexture.isRenderTarget&&(this._activeEffect.setTexture('refraction2DSampler',null),t=!0),t&&this._markAllSubMeshesAsTexturesDirty()}a.prototype.unbind.call(this)},y.prototype.bindForSubMesh=function(e,t,r){var i=this.getScene(),o=r._materialDefines;if(o){var n=r.effect;if(n){this._activeEffect=n,this.bindOnlyWorldMatrix(e),o.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var a=this._mustRebind(i,n,t.visibility);if(m.MaterialHelper.BindBonesParameters(t,n),a){if(this._uniformBuffer.bindToEffect(n,'Material'),this.bindViewProjection(n),!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(y.FresnelEnabled&&o.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4('diffuseLeftColor',this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),this._uniformBuffer.updateColor4('diffuseRightColor',this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._uniformBuffer.updateColor4('opacityParts',new m.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4('reflectionLeftColor',this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),this._uniformBuffer.updateColor4('reflectionRightColor',this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4('refractionLeftColor',this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),this._uniformBuffer.updateColor4('refractionRightColor',this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4('emissiveLeftColor',this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._uniformBuffer.updateColor4('emissiveRightColor',this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),i.texturesEnabled){if(this._diffuseTexture&&y.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2('vDiffuseInfos',this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),m.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,'diffuse'),this._diffuseTexture.hasAlpha&&n.setFloat('alphaCutOff',this.alphaCutOff)),this._ambientTexture&&y.AmbientTextureEnabled&&(this._uniformBuffer.updateFloat2('vAmbientInfos',this._ambientTexture.coordinatesIndex,this._ambientTexture.level),m.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,'ambient')),this._opacityTexture&&y.OpacityTextureEnabled&&(this._uniformBuffer.updateFloat2('vOpacityInfos',this._opacityTexture.coordinatesIndex,this._opacityTexture.level),m.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,'opacity')),this._reflectionTexture&&y.ReflectionTextureEnabled&&(this._uniformBuffer.updateFloat2('vReflectionInfos',this._reflectionTexture.level,this.roughness),this._uniformBuffer.updateMatrix('reflectionMatrix',this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var s=this._reflectionTexture;this._uniformBuffer.updateVector3('vReflectionPosition',s.boundingBoxPosition),this._uniformBuffer.updateVector3('vReflectionSize',s.boundingBoxSize)}if(this._emissiveTexture&&y.EmissiveTextureEnabled&&(this._uniformBuffer.updateFloat2('vEmissiveInfos',this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),m.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,'emissive')),this._lightmapTexture&&y.LightmapTextureEnabled&&(this._uniformBuffer.updateFloat2('vLightmapInfos',this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),m.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,'lightmap')),this._specularTexture&&y.SpecularTextureEnabled&&(this._uniformBuffer.updateFloat2('vSpecularInfos',this._specularTexture.coordinatesIndex,this._specularTexture.level),m.MaterialHelper.BindTextureMatrix(this._specularTexture,this._uniformBuffer,'specular')),this._bumpTexture&&i.getEngine().getCaps().standardDerivatives&&y.BumpTextureEnabled&&(this._uniformBuffer.updateFloat3('vBumpInfos',this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),m.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,'bump'),i._mirroredCameraPosition?this._uniformBuffer.updateFloat2('vTangentSpaceParams',this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):this._uniformBuffer.updateFloat2('vTangentSpaceParams',this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&y.RefractionTextureEnabled){var d=1;this._refractionTexture.isCube||(this._uniformBuffer.updateMatrix('refractionMatrix',this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(d=this._refractionTexture.depth)),this._uniformBuffer.updateFloat4('vRefractionInfos',this._refractionTexture.level,this.indexOfRefraction,d,this.invertRefractionY?-1:1)}}this.pointsCloud&&this._uniformBuffer.updateFloat('pointSize',this.pointSize),o.SPECULARTERM&&this._uniformBuffer.updateColor4('vSpecularColor',this.specularColor,this.specularPower),this._uniformBuffer.updateColor3('vEmissiveColor',this.emissiveColor),this._uniformBuffer.updateColor4('vDiffuseColor',this.diffuseColor,this.alpha*t.visibility)}if(i.texturesEnabled&&(this._diffuseTexture&&y.DiffuseTextureEnabled&&n.setTexture('diffuseSampler',this._diffuseTexture),this._ambientTexture&&y.AmbientTextureEnabled&&n.setTexture('ambientSampler',this._ambientTexture),this._opacityTexture&&y.OpacityTextureEnabled&&n.setTexture('opacitySampler',this._opacityTexture),this._reflectionTexture&&y.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?n.setTexture('reflectionCubeSampler',this._reflectionTexture):n.setTexture('reflection2DSampler',this._reflectionTexture)),this._emissiveTexture&&y.EmissiveTextureEnabled&&n.setTexture('emissiveSampler',this._emissiveTexture),this._lightmapTexture&&y.LightmapTextureEnabled&&n.setTexture('lightmapSampler',this._lightmapTexture),this._specularTexture&&y.SpecularTextureEnabled&&n.setTexture('specularSampler',this._specularTexture),this._bumpTexture&&i.getEngine().getCaps().standardDerivatives&&y.BumpTextureEnabled&&n.setTexture('bumpSampler',this._bumpTexture),this._refractionTexture&&y.RefractionTextureEnabled)){var d=1;this._refractionTexture.isCube?n.setTexture('refractionCubeSampler',this._refractionTexture):n.setTexture('refraction2DSampler',this._refractionTexture)}m.MaterialHelper.BindClipPlane(n,i),i.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),m.MaterialHelper.BindEyePosition(n,i),n.setColor3('vAmbientColor',this._globalAmbientColor)}!a&&this.isFrozen||(i.lightsEnabled&&!this._disableLighting&&m.MaterialHelper.BindLights(i,t,n,o,this._maxSimultaneousLights),(i.fogEnabled&&t.applyFog&&i.fogMode!==m.Scene.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture)&&this.bindView(n),m.MaterialHelper.BindFogParameters(i,t,n),o.NUM_MORPH_INFLUENCERS&&m.MaterialHelper.BindMorphTargetParameters(t,n),m.MaterialHelper.BindLogDepth(o,n,i),this._imageProcessingConfiguration.applyByPostProcess||this._imageProcessingConfiguration.bind(this._activeEffect)),this._uniformBuffer.update(),this._afterBind(t,this._activeEffect)}}},y.prototype.getAnimatables=function(){var t=[];return this._diffuseTexture&&this._diffuseTexture.animations&&0<this._diffuseTexture.animations.length&&t.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&0<this._ambientTexture.animations.length&&t.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&0<this._opacityTexture.animations.length&&t.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&0<this._reflectionTexture.animations.length&&t.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&0<this._emissiveTexture.animations.length&&t.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&0<this._specularTexture.animations.length&&t.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&0<this._bumpTexture.animations.length&&t.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&0<this._lightmapTexture.animations.length&&t.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&0<this._refractionTexture.animations.length&&t.push(this._refractionTexture),t},y.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);return this._diffuseTexture&&t.push(this._diffuseTexture),this._ambientTexture&&t.push(this._ambientTexture),this._opacityTexture&&t.push(this._opacityTexture),this._reflectionTexture&&t.push(this._reflectionTexture),this._emissiveTexture&&t.push(this._emissiveTexture),this._specularTexture&&t.push(this._specularTexture),this._bumpTexture&&t.push(this._bumpTexture),this._lightmapTexture&&t.push(this._lightmapTexture),this._refractionTexture&&t.push(this._refractionTexture),t},y.prototype.hasTexture=function(t){return!!a.prototype.hasTexture.call(this,t)||this._diffuseTexture===t||this._ambientTexture===t||this._opacityTexture===t||this._reflectionTexture===t||this._emissiveTexture===t||this._specularTexture===t||this._bumpTexture===t||this._lightmapTexture===t||this._refractionTexture===t},y.prototype.dispose=function(r,e){e&&(this._diffuseTexture&&this._diffuseTexture.dispose(),this._ambientTexture&&this._ambientTexture.dispose(),this._opacityTexture&&this._opacityTexture.dispose(),this._reflectionTexture&&this._reflectionTexture.dispose(),this._emissiveTexture&&this._emissiveTexture.dispose(),this._specularTexture&&this._specularTexture.dispose(),this._bumpTexture&&this._bumpTexture.dispose(),this._lightmapTexture&&this._lightmapTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),a.prototype.dispose.call(this,r,e)},y.prototype.clone=function(e){var t=this,r=m.SerializationHelper.Clone(function(){return new y(e,t.getScene())},this);return r.name=e,r.id=e,r},y.prototype.serialize=function(){return m.SerializationHelper.Serialize(this)},y.Parse=function(e,t,r){return m.SerializationHelper.Parse(function(){return new y(e.name,t)},e,t,r)},Object.defineProperty(y,'DiffuseTextureEnabled',{get:function(){return y._DiffuseTextureEnabled},set:function(e){y._DiffuseTextureEnabled!==e&&(y._DiffuseTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'AmbientTextureEnabled',{get:function(){return y._AmbientTextureEnabled},set:function(e){y._AmbientTextureEnabled!==e&&(y._AmbientTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'OpacityTextureEnabled',{get:function(){return y._OpacityTextureEnabled},set:function(e){y._OpacityTextureEnabled!==e&&(y._OpacityTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'ReflectionTextureEnabled',{get:function(){return y._ReflectionTextureEnabled},set:function(e){y._ReflectionTextureEnabled!==e&&(y._ReflectionTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'EmissiveTextureEnabled',{get:function(){return y._EmissiveTextureEnabled},set:function(e){y._EmissiveTextureEnabled!==e&&(y._EmissiveTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'SpecularTextureEnabled',{get:function(){return y._SpecularTextureEnabled},set:function(e){y._SpecularTextureEnabled!==e&&(y._SpecularTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'BumpTextureEnabled',{get:function(){return y._BumpTextureEnabled},set:function(e){y._BumpTextureEnabled!==e&&(y._BumpTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'LightmapTextureEnabled',{get:function(){return y._LightmapTextureEnabled},set:function(e){y._LightmapTextureEnabled!==e&&(y._LightmapTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'RefractionTextureEnabled',{get:function(){return y._RefractionTextureEnabled},set:function(e){y._RefractionTextureEnabled!==e&&(y._RefractionTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'ColorGradingTextureEnabled',{get:function(){return y._ColorGradingTextureEnabled},set:function(e){y._ColorGradingTextureEnabled!==e&&(y._ColorGradingTextureEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(y,'FresnelEnabled',{get:function(){return y._FresnelEnabled},set:function(e){y._FresnelEnabled!==e&&(y._FresnelEnabled=e,m.Engine.MarkAllMaterialsAsDirty(m.Material.FresnelDirtyFlag))},enumerable:!0,configurable:!0}),y._DiffuseTextureEnabled=!0,y._AmbientTextureEnabled=!0,y._OpacityTextureEnabled=!0,y._ReflectionTextureEnabled=!0,y._EmissiveTextureEnabled=!0,y._SpecularTextureEnabled=!0,y._BumpTextureEnabled=!0,y._LightmapTextureEnabled=!0,y._RefractionTextureEnabled=!0,y._ColorGradingTextureEnabled=!0,y._FresnelEnabled=!0,g([m.serializeAsTexture('diffuseTexture')],y.prototype,'_diffuseTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],y.prototype,'diffuseTexture',void 0),g([m.serializeAsTexture('ambientTexture')],y.prototype,'_ambientTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'ambientTexture',void 0),g([m.serializeAsTexture('opacityTexture')],y.prototype,'_opacityTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],y.prototype,'opacityTexture',void 0),g([m.serializeAsTexture('reflectionTexture')],y.prototype,'_reflectionTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'reflectionTexture',void 0),g([m.serializeAsTexture('emissiveTexture')],y.prototype,'_emissiveTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'emissiveTexture',void 0),g([m.serializeAsTexture('specularTexture')],y.prototype,'_specularTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'specularTexture',void 0),g([m.serializeAsTexture('bumpTexture')],y.prototype,'_bumpTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'bumpTexture',void 0),g([m.serializeAsTexture('lightmapTexture')],y.prototype,'_lightmapTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'lightmapTexture',void 0),g([m.serializeAsTexture('refractionTexture')],y.prototype,'_refractionTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'refractionTexture',void 0),g([m.serializeAsColor3('ambient')],y.prototype,'ambientColor',void 0),g([m.serializeAsColor3('diffuse')],y.prototype,'diffuseColor',void 0),g([m.serializeAsColor3('specular')],y.prototype,'specularColor',void 0),g([m.serializeAsColor3('emissive')],y.prototype,'emissiveColor',void 0),g([m.serialize()],y.prototype,'specularPower',void 0),g([m.serialize('useAlphaFromDiffuseTexture')],y.prototype,'_useAlphaFromDiffuseTexture',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useAlphaFromDiffuseTexture',void 0),g([m.serialize('useEmissiveAsIllumination')],y.prototype,'_useEmissiveAsIllumination',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useEmissiveAsIllumination',void 0),g([m.serialize('linkEmissiveWithDiffuse')],y.prototype,'_linkEmissiveWithDiffuse',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'linkEmissiveWithDiffuse',void 0),g([m.serialize('useSpecularOverAlpha')],y.prototype,'_useSpecularOverAlpha',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useSpecularOverAlpha',void 0),g([m.serialize('useReflectionOverAlpha')],y.prototype,'_useReflectionOverAlpha',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useReflectionOverAlpha',void 0),g([m.serialize('disableLighting')],y.prototype,'_disableLighting',void 0),g([m.expandToProperty('_markAllSubMeshesAsLightsDirty')],y.prototype,'disableLighting',void 0),g([m.serialize('useObjectSpaceNormalMap')],y.prototype,'_useObjectSpaceNormalMap',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useObjectSpaceNormalMap',void 0),g([m.serialize('useParallax')],y.prototype,'_useParallax',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useParallax',void 0),g([m.serialize('useParallaxOcclusion')],y.prototype,'_useParallaxOcclusion',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useParallaxOcclusion',void 0),g([m.serialize()],y.prototype,'parallaxScaleBias',void 0),g([m.serialize('roughness')],y.prototype,'_roughness',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'roughness',void 0),g([m.serialize()],y.prototype,'indexOfRefraction',void 0),g([m.serialize()],y.prototype,'invertRefractionY',void 0),g([m.serialize()],y.prototype,'alphaCutOff',void 0),g([m.serialize('useLightmapAsShadowmap')],y.prototype,'_useLightmapAsShadowmap',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useLightmapAsShadowmap',void 0),g([m.serializeAsFresnelParameters('diffuseFresnelParameters')],y.prototype,'_diffuseFresnelParameters',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelDirty')],y.prototype,'diffuseFresnelParameters',void 0),g([m.serializeAsFresnelParameters('opacityFresnelParameters')],y.prototype,'_opacityFresnelParameters',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelAndMiscDirty')],y.prototype,'opacityFresnelParameters',void 0),g([m.serializeAsFresnelParameters('reflectionFresnelParameters')],y.prototype,'_reflectionFresnelParameters',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelDirty')],y.prototype,'reflectionFresnelParameters',void 0),g([m.serializeAsFresnelParameters('refractionFresnelParameters')],y.prototype,'_refractionFresnelParameters',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelDirty')],y.prototype,'refractionFresnelParameters',void 0),g([m.serializeAsFresnelParameters('emissiveFresnelParameters')],y.prototype,'_emissiveFresnelParameters',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelDirty')],y.prototype,'emissiveFresnelParameters',void 0),g([m.serialize('useReflectionFresnelFromSpecular')],y.prototype,'_useReflectionFresnelFromSpecular',void 0),g([m.expandToProperty('_markAllSubMeshesAsFresnelDirty')],y.prototype,'useReflectionFresnelFromSpecular',void 0),g([m.serialize('useGlossinessFromSpecularMapAlpha')],y.prototype,'_useGlossinessFromSpecularMapAlpha',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'useGlossinessFromSpecularMapAlpha',void 0),g([m.serialize('maxSimultaneousLights')],y.prototype,'_maxSimultaneousLights',void 0),g([m.expandToProperty('_markAllSubMeshesAsLightsDirty')],y.prototype,'maxSimultaneousLights',void 0),g([m.serialize('invertNormalMapX')],y.prototype,'_invertNormalMapX',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'invertNormalMapX',void 0),g([m.serialize('invertNormalMapY')],y.prototype,'_invertNormalMapY',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'invertNormalMapY',void 0),g([m.serialize('twoSidedLighting')],y.prototype,'_twoSidedLighting',void 0),g([m.expandToProperty('_markAllSubMeshesAsTexturesDirty')],y.prototype,'twoSidedLighting',void 0),g([m.serialize()],y.prototype,'useLogarithmicDepth',null),y}(m.PushMaterial);m.StandardMaterial=t}(e||(e={}));var e;!function(m){var d=function(r){function e(){var e=r.call(this)||this;return e.PBR=!0,e.MAINUV1=!1,e.MAINUV2=!1,e.UV1=!1,e.UV2=!1,e.ALBEDO=!1,e.ALBEDODIRECTUV=0,e.VERTEXCOLOR=!1,e.AMBIENT=!1,e.AMBIENTDIRECTUV=0,e.AMBIENTINGRAYSCALE=!1,e.OPACITY=!1,e.VERTEXALPHA=!1,e.OPACITYDIRECTUV=0,e.OPACITYRGB=!1,e.ALPHATEST=!1,e.DEPTHPREPASS=!1,e.ALPHABLEND=!1,e.ALPHAFROMALBEDO=!1,e.ALPHATESTVALUE='0.5',e.SPECULAROVERALPHA=!1,e.RADIANCEOVERALPHA=!1,e.ALPHAFRESNEL=!1,e.LINEARALPHAFRESNEL=!1,e.PREMULTIPLYALPHA=!1,e.EMISSIVE=!1,e.EMISSIVEDIRECTUV=0,e.REFLECTIVITY=!1,e.REFLECTIVITYDIRECTUV=0,e.SPECULARTERM=!1,e.MICROSURFACEFROMREFLECTIVITYMAP=!1,e.MICROSURFACEAUTOMATIC=!1,e.LODBASEDMICROSFURACE=!1,e.MICROSURFACEMAP=!1,e.MICROSURFACEMAPDIRECTUV=0,e.METALLICWORKFLOW=!1,e.ROUGHNESSSTOREINMETALMAPALPHA=!1,e.ROUGHNESSSTOREINMETALMAPGREEN=!1,e.METALLNESSSTOREINMETALMAPBLUE=!1,e.AOSTOREINMETALMAPRED=!1,e.ENVIRONMENTBRDF=!1,e.NORMAL=!1,e.TANGENT=!1,e.BUMP=!1,e.BUMPDIRECTUV=0,e.OBJECTSPACE_NORMALMAP=!1,e.PARALLAX=!1,e.PARALLAXOCCLUSION=!1,e.NORMALXYSCALE=!0,e.LIGHTMAP=!1,e.LIGHTMAPDIRECTUV=0,e.USELIGHTMAPASSHADOWMAP=!1,e.GAMMALIGHTMAP=!1,e.REFLECTION=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.USESPHERICALFROMREFLECTIONMAP=!1,e.USESPHERICALINVERTEX=!1,e.REFLECTIONMAP_OPPOSITEZ=!1,e.LODINREFLECTIONALPHA=!1,e.GAMMAREFLECTION=!1,e.RADIANCEOCCLUSION=!1,e.HORIZONOCCLUSION=!1,e.REFRACTION=!1,e.REFRACTIONMAP_3D=!1,e.REFRACTIONMAP_OPPOSITEZ=!1,e.LODINREFRACTIONALPHA=!1,e.GAMMAREFRACTION=!1,e.LINKREFRACTIONTOTRANSPARENCY=!1,e.INSTANCES=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.NONUNIFORMSCALING=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.NUM_MORPH_INFLUENCERS=0,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.USEPHYSICALLIGHTFALLOFF=!1,e.TWOSIDEDLIGHTING=!1,e.SHADOWFLOAT=!1,e.CLIPPLANE=!1,e.POINTSIZE=!1,e.FOG=!1,e.LOGARITHMICDEPTH=!1,e.FORCENORMALFORWARD=!1,e.SPECULARAA=!1,e.UNLIT=!1,e.rebuild(),e}return h(e,r),e.prototype.reset=function(){r.prototype.reset.call(this),this.ALPHATESTVALUE='0.5',this.PBR=!0},e}(m.MaterialDefines),e=function(o){function e(e,t){var i=o.call(this,e,t)||this;return i._directIntensity=1,i._emissiveIntensity=1,i._environmentIntensity=1,i._specularIntensity=1,i._lightingInfos=new m.Vector4(i._directIntensity,i._emissiveIntensity,i._environmentIntensity,i._specularIntensity),i._disableBumpMap=!1,i._ambientTextureStrength=1,i._ambientColor=new m.Color3(0,0,0),i._albedoColor=new m.Color3(1,1,1),i._reflectivityColor=new m.Color3(1,1,1),i._reflectionColor=new m.Color3(1,1,1),i._emissiveColor=new m.Color3(0,0,0),i._microSurface=.9,i._indexOfRefraction=.66,i._invertRefractionY=!1,i._linkRefractionWithTransparency=!1,i._useLightmapAsShadowmap=!1,i._useHorizonOcclusion=!0,i._useRadianceOcclusion=!0,i._useAlphaFromAlbedoTexture=!1,i._useSpecularOverAlpha=!0,i._useMicroSurfaceFromReflectivityMapAlpha=!1,i._useRoughnessFromMetallicTextureAlpha=!0,i._useRoughnessFromMetallicTextureGreen=!1,i._useMetallnessFromMetallicTextureBlue=!1,i._useAmbientOcclusionFromMetallicTextureRed=!1,i._useAmbientInGrayScale=!1,i._useAutoMicroSurfaceFromReflectivityMap=!1,i._usePhysicalLightFalloff=!0,i._useRadianceOverAlpha=!0,i._useObjectSpaceNormalMap=!1,i._useParallax=!1,i._useParallaxOcclusion=!1,i._parallaxScaleBias=.05,i._disableLighting=!1,i._maxSimultaneousLights=4,i._invertNormalMapX=!1,i._invertNormalMapY=!1,i._twoSidedLighting=!1,i._alphaCutOff=.4,i._forceAlphaTest=!1,i._useAlphaFresnel=!1,i._useLinearAlphaFresnel=!1,i._transparencyMode=null,i._environmentBRDFTexture=null,i._forceIrradianceInFragment=!1,i._forceNormalForward=!1,i._enableSpecularAntiAliasing=!1,i._renderTargets=new m.SmartArray(16),i._globalAmbientColor=new m.Color3(0,0,0),i._unlit=!1,i._attachImageProcessingConfiguration(null),i.getRenderTargetTextures=function(){return i._renderTargets.reset(),m.StandardMaterial.ReflectionTextureEnabled&&i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),m.StandardMaterial.RefractionTextureEnabled&&i._refractionTexture&&i._refractionTexture.isRenderTarget&&i._renderTargets.push(i._refractionTexture),i._renderTargets},i._environmentBRDFTexture=m.TextureTools.GetEnvironmentBRDFTexture(t),i}return h(e,o),e.prototype._attachImageProcessingConfiguration=function(r){var e=this;r!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=r||this.getScene().imageProcessingConfiguration,this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){e._markAllSubMeshesAsImageProcessingDirty()}))},e.prototype.getClassName=function(){return'PBRBaseMaterial'},Object.defineProperty(e.prototype,'useLogarithmicDepth',{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'transparencyMode',{get:function(){return this._transparencyMode},set:function(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===m.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'_disableAlphaBlending',{get:function(){return this._linkRefractionWithTransparency||this._transparencyMode===m.PBRMaterial.PBRMATERIAL_OPAQUE||this._transparencyMode===m.PBRMaterial.PBRMATERIAL_ALPHATEST},enumerable:!0,configurable:!0}),e.prototype.needAlphaBlending=function(){return!this._disableAlphaBlending&&(1>this.alpha||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())},e.prototype.needAlphaBlendingForMesh=function(t){return!this._disableAlphaBlending&&o.prototype.needAlphaBlendingForMesh.call(this,t)},e.prototype.needAlphaTesting=function(){return!!this._forceAlphaTest||!this._linkRefractionWithTransparency&&null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&(null==this._transparencyMode||this._transparencyMode===m.PBRMaterial.PBRMATERIAL_ALPHATEST)},e.prototype._shouldUseAlphaFromAlbedoTexture=function(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==m.PBRMaterial.PBRMATERIAL_OPAQUE},e.prototype.getAlphaTestTexture=function(){return this._albedoTexture},e.prototype.isReadyForSubMesh=function(e,t,r){if(t.effect&&this.isFrozen&&this._wasPreviouslyReady)return!0;t._materialDefines||(t._materialDefines=new d);var i=t._materialDefines;if(!this.checkReadyOnEveryCall&&t.effect&&i._renderId===this.getScene().getRenderId())return!0;var o=this.getScene(),n=o.getEngine();if(i._areTexturesDirty&&o.texturesEnabled){if(this._albedoTexture&&m.StandardMaterial.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&m.StandardMaterial.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&m.StandardMaterial.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var a=this._getReflectionTexture();if(a&&m.StandardMaterial.ReflectionTextureEnabled&&!a.isReadyOrNotBlocking())return!1;if(this._lightmapTexture&&m.StandardMaterial.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&m.StandardMaterial.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(m.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1;}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(n.getCaps().standardDerivatives&&this._bumpTexture&&m.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;var s=this._getRefractionTexture();if(s&&m.StandardMaterial.RefractionTextureEnabled&&!s.isReadyOrNotBlocking())return!1;if(this._environmentBRDFTexture&&m.StandardMaterial.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(i._areImageProcessingDirty&&!this._imageProcessingConfiguration.isReady())return!1;n.getCaps().standardDerivatives||e.isVerticesDataPresent(m.VertexBuffer.NormalKind)||(e.createNormals(!0),m.Tools.Warn('PBRMaterial: Normals have been created for the mesh: '+e.name));var l=this._prepareEffect(e,i,this.onCompiled,this.onError,r);return l&&(o.resetCachedMaterial(),t.setEffect(l,i),this.buildUniformLayout()),t.effect&&t.effect.isReady()&&(i._renderId=o.getRenderId(),this._wasPreviouslyReady=!0,!0)},e.prototype.isMetallicWorkflow=function(){return null!=this._metallic||null!=this._roughness||this._metallicTexture},e.prototype._prepareEffect=function(e,t,g,y,T,o){if(void 0===g&&(g=null),void 0===y&&(y=null),void 0===T&&(T=null),void 0===o&&(o=null),this._prepareDefines(e,t,T,o),!t.isDirty)return null;t.markAsProcessed();var s=this.getScene(),a=s.getEngine(),l=new m.EffectFallbacks,x=0;t.USESPHERICALINVERTEX&&l.addFallback(x++,'USESPHERICALINVERTEX'),t.FOG&&l.addFallback(x,'FOG'),t.SPECULARAA&&l.addFallback(x,'SPECULARAA'),t.POINTSIZE&&l.addFallback(x,'POINTSIZE'),t.LOGARITHMICDEPTH&&l.addFallback(x,'LOGARITHMICDEPTH'),t.PARALLAX&&l.addFallback(x,'PARALLAX'),t.PARALLAXOCCLUSION&&l.addFallback(x++,'PARALLAXOCCLUSION'),t.ENVIRONMENTBRDF&&l.addFallback(x++,'ENVIRONMENTBRDF'),t.TANGENT&&l.addFallback(x++,'TANGENT'),t.BUMP&&l.addFallback(x++,'BUMP'),x=m.MaterialHelper.HandleFallbacksForShadows(t,l,this._maxSimultaneousLights,x++),t.SPECULARTERM&&l.addFallback(x++,'SPECULARTERM'),t.USESPHERICALFROMREFLECTIONMAP&&l.addFallback(x++,'USESPHERICALFROMREFLECTIONMAP'),t.LIGHTMAP&&l.addFallback(x++,'LIGHTMAP'),t.NORMAL&&l.addFallback(x++,'NORMAL'),t.AMBIENT&&l.addFallback(x++,'AMBIENT'),t.EMISSIVE&&l.addFallback(x++,'EMISSIVE'),t.VERTEXCOLOR&&l.addFallback(x++,'VERTEXCOLOR'),0<t.NUM_BONE_INFLUENCERS&&l.addCPUSkinningFallback(x++,e),t.MORPHTARGETS&&l.addFallback(x++,'MORPHTARGETS');var c=[m.VertexBuffer.PositionKind];t.NORMAL&&c.push(m.VertexBuffer.NormalKind),t.TANGENT&&c.push(m.VertexBuffer.TangentKind),t.UV1&&c.push(m.VertexBuffer.UVKind),t.UV2&&c.push(m.VertexBuffer.UV2Kind),t.VERTEXCOLOR&&c.push(m.VertexBuffer.ColorKind),m.MaterialHelper.PrepareAttributesForBones(c,e,t,l),m.MaterialHelper.PrepareAttributesForInstances(c,t),m.MaterialHelper.PrepareAttributesForMorphTargets(c,e,t);var b=['world','view','viewProjection','vEyePosition','vLightsType','vAmbientColor','vAlbedoColor','vReflectivityColor','vEmissiveColor','vReflectionColor','vFogInfos','vFogColor','pointSize','vAlbedoInfos','vAmbientInfos','vOpacityInfos','vReflectionInfos','vReflectionPosition','vReflectionSize','vEmissiveInfos','vReflectivityInfos','vMicroSurfaceSamplerInfos','vBumpInfos','vLightmapInfos','vRefractionInfos','mBones','vClipPlane','albedoMatrix','ambientMatrix','opacityMatrix','reflectionMatrix','emissiveMatrix','reflectivityMatrix','normalMatrix','microSurfaceSamplerMatrix','bumpMatrix','lightmapMatrix','refractionMatrix','vLightingIntensity','logarithmicDepthConstant','vSphericalX','vSphericalY','vSphericalZ','vSphericalXX','vSphericalYY','vSphericalZZ','vSphericalXY','vSphericalYZ','vSphericalZX','vReflectionMicrosurfaceInfos','vRefractionMicrosurfaceInfos','vTangentSpaceParams'],E=['albedoSampler','reflectivitySampler','ambientSampler','emissiveSampler','bumpSampler','lightmapSampler','opacitySampler','refractionSampler','refractionSamplerLow','refractionSamplerHigh','reflectionSampler','reflectionSamplerLow','reflectionSamplerHigh','microSurfaceSampler','environmentBrdfSampler'],v=['Material','Scene'];m.ImageProcessingConfiguration.PrepareUniforms(b,t),m.ImageProcessingConfiguration.PrepareSamplers(E,t),m.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:b,uniformBuffersNames:v,samplers:E,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});var P=t.toString();return a.createEffect('pbr',{attributes:c,uniformsNames:b,uniformBuffersNames:v,samplers:E,defines:P,fallbacks:l,onCompiled:g,onError:y,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS}},a)},e.prototype._prepareDefines=function(e,t,i,d){void 0===i&&(i=null),void 0===d&&(d=null);var n=this.getScene(),o=n.getEngine();if(m.MaterialHelper.PrepareDefinesForLights(n,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,n.texturesEnabled){n.getEngine().getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&m.StandardMaterial.DiffuseTextureEnabled?m.MaterialHelper.PrepareDefinesForMergedUV(this._albedoTexture,t,'ALBEDO'):t.ALBEDO=!1,this._ambientTexture&&m.StandardMaterial.AmbientTextureEnabled?(m.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,t,'AMBIENT'),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&m.StandardMaterial.OpacityTextureEnabled?(m.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,t,'OPACITY'),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;var s=this._getReflectionTexture();if(s&&m.StandardMaterial.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=s.gammaSpace,t.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!s.invertZ:s.invertZ,t.LODINREFLECTIONALPHA=s.lodLevelInAlpha,s.coordinatesMode===m.Texture.INVCUBIC_MODE&&(t.INVERTCUBICMAP=!0),t.REFLECTIONMAP_3D=s.isCube,s.coordinatesMode){case m.Texture.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case m.Texture.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case m.Texture.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case m.Texture.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case m.Texture.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case m.Texture.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case m.Texture.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case m.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case m.Texture.CUBIC_MODE:case m.Texture.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!s.boundingBoxSize;}s.coordinatesMode!==m.Texture.SKYBOX_MODE&&s.sphericalPolynomial&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USESPHERICALINVERTEX=!(this._forceIrradianceInFragment||8>=n.getEngine().getCaps().maxVaryingVectors))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1;this._lightmapTexture&&m.StandardMaterial.LightmapTextureEnabled?(m.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,t,'LIGHTMAP'),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace):t.LIGHTMAP=!1,this._emissiveTexture&&m.StandardMaterial.EmissiveTextureEnabled?m.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,t,'EMISSIVE'):t.EMISSIVE=!1,m.StandardMaterial.SpecularTextureEnabled?(this._metallicTexture?(m.MaterialHelper.PrepareDefinesForMergedUV(this._metallicTexture,t,'REFLECTIVITY'),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed):this._reflectivityTexture?(m.MaterialHelper.PrepareDefinesForMergedUV(this._reflectivityTexture,t,'REFLECTIVITY'),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap):t.REFLECTIVITY=!1,this._microSurfaceTexture?m.MaterialHelper.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,'MICROSURFACEMAP'):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&m.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap?(m.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,t,'BUMP'),this._useParallax&&this._albedoTexture&&m.StandardMaterial.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):t.BUMP=!1;var a=this._getRefractionTexture();a&&m.StandardMaterial.RefractionTextureEnabled?(t.REFRACTION=!0,t.REFRACTIONMAP_3D=a.isCube,t.GAMMAREFRACTION=a.gammaSpace,t.REFRACTIONMAP_OPPOSITEZ=a.invertZ,t.LODINREFRACTIONALPHA=a.lodLevelInAlpha,this._linkRefractionWithTransparency&&(t.LINKREFRACTIONTOTRANSPARENCY=!0)):t.REFRACTION=!1,t.ENVIRONMENTBRDF=!!(this._environmentBRDFTexture&&m.StandardMaterial.ReflectionTextureEnabled),t.ALPHAFROMALBEDO=!!this._shouldUseAlphaFromAlbedoTexture()}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,t.USEPHYSICALLIGHTFALLOFF=this._usePhysicalLightFalloff,t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,t.TWOSIDEDLIGHTING=!(this.backFaceCulling||!this._twoSidedLighting),t.ALPHATESTVALUE=this._alphaCutOff+(0==this._alphaCutOff%1?'.':''),t.PREMULTIPLYALPHA=this.alphaMode===m.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===m.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel,t.SPECULARAA=n.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}t._areImageProcessingDirty&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(m.MaterialHelper.PrepareDefinesForMisc(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(m.VertexBuffer.NormalKind)),m.MaterialHelper.PrepareDefinesForFrameBoundValues(n,o,t,!!i,d),m.MaterialHelper.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==m.PBRMaterial.PBRMATERIAL_OPAQUE)},e.prototype.forceCompilation=function(t,e,i){var r=this,n=b({clipPlane:!1},i),o=new d,a=this._prepareEffect(t,o,void 0,void 0,void 0,n.clipPlane);a.isReady()?e&&e(this):a.onCompileObservable.add(function(){e&&e(r)})},e.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform('vAlbedoInfos',2),this._uniformBuffer.addUniform('vAmbientInfos',3),this._uniformBuffer.addUniform('vOpacityInfos',2),this._uniformBuffer.addUniform('vEmissiveInfos',2),this._uniformBuffer.addUniform('vLightmapInfos',2),this._uniformBuffer.addUniform('vReflectivityInfos',3),this._uniformBuffer.addUniform('vMicroSurfaceSamplerInfos',2),this._uniformBuffer.addUniform('vRefractionInfos',4),this._uniformBuffer.addUniform('vReflectionInfos',2),this._uniformBuffer.addUniform('vReflectionPosition',3),this._uniformBuffer.addUniform('vReflectionSize',3),this._uniformBuffer.addUniform('vBumpInfos',3),this._uniformBuffer.addUniform('albedoMatrix',16),this._uniformBuffer.addUniform('ambientMatrix',16),this._uniformBuffer.addUniform('opacityMatrix',16),this._uniformBuffer.addUniform('emissiveMatrix',16),this._uniformBuffer.addUniform('lightmapMatrix',16),this._uniformBuffer.addUniform('reflectivityMatrix',16),this._uniformBuffer.addUniform('microSurfaceSamplerMatrix',16),this._uniformBuffer.addUniform('bumpMatrix',16),this._uniformBuffer.addUniform('vTangentSpaceParams',2),this._uniformBuffer.addUniform('refractionMatrix',16),this._uniformBuffer.addUniform('reflectionMatrix',16),this._uniformBuffer.addUniform('vReflectionColor',3),this._uniformBuffer.addUniform('vAlbedoColor',4),this._uniformBuffer.addUniform('vLightingIntensity',4),this._uniformBuffer.addUniform('vRefractionMicrosurfaceInfos',3),this._uniformBuffer.addUniform('vReflectionMicrosurfaceInfos',3),this._uniformBuffer.addUniform('vReflectivityColor',4),this._uniformBuffer.addUniform('vEmissiveColor',3),this._uniformBuffer.addUniform('pointSize',1),this._uniformBuffer.create()},e.prototype.unbind=function(){this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture('reflectionSampler',null),this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._uniformBuffer.setTexture('refractionSampler',null),o.prototype.unbind.call(this)},e.prototype.bindForSubMesh=function(e,t,i){var r=this.getScene(),n=i._materialDefines;if(n){var o=i.effect;if(o){this._activeEffect=o,this.bindOnlyWorldMatrix(e),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var s=this._mustRebind(r,o,t.visibility);m.MaterialHelper.BindBonesParameters(t,this._activeEffect);var _=null;if(s){this._uniformBuffer.bindToEffect(o,'Material'),this.bindViewProjection(o),_=this._getReflectionTexture();var l=this._getRefractionTexture();if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(r.texturesEnabled){if(this._albedoTexture&&m.StandardMaterial.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2('vAlbedoInfos',this._albedoTexture.coordinatesIndex,this._albedoTexture.level),m.MaterialHelper.BindTextureMatrix(this._albedoTexture,this._uniformBuffer,'albedo')),this._ambientTexture&&m.StandardMaterial.AmbientTextureEnabled&&(this._uniformBuffer.updateFloat3('vAmbientInfos',this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength),m.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,'ambient')),this._opacityTexture&&m.StandardMaterial.OpacityTextureEnabled&&(this._uniformBuffer.updateFloat2('vOpacityInfos',this._opacityTexture.coordinatesIndex,this._opacityTexture.level),m.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,'opacity')),_&&m.StandardMaterial.ReflectionTextureEnabled){if(this._uniformBuffer.updateMatrix('reflectionMatrix',_.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2('vReflectionInfos',_.level,0),_.boundingBoxSize){var g=_;this._uniformBuffer.updateVector3('vReflectionPosition',g.boundingBoxPosition),this._uniformBuffer.updateVector3('vReflectionSize',g.boundingBoxSize)}var c=_.sphericalPolynomial;n.USESPHERICALFROMREFLECTIONMAP&&c&&(this._activeEffect.setFloat3('vSphericalX',c.x.x,c.x.y,c.x.z),this._activeEffect.setFloat3('vSphericalY',c.y.x,c.y.y,c.y.z),this._activeEffect.setFloat3('vSphericalZ',c.z.x,c.z.y,c.z.z),this._activeEffect.setFloat3('vSphericalXX_ZZ',c.xx.x-c.zz.x,c.xx.y-c.zz.y,c.xx.z-c.zz.z),this._activeEffect.setFloat3('vSphericalYY_ZZ',c.yy.x-c.zz.x,c.yy.y-c.zz.y,c.yy.z-c.zz.z),this._activeEffect.setFloat3('vSphericalZZ',c.zz.x,c.zz.y,c.zz.z),this._activeEffect.setFloat3('vSphericalXY',c.xy.x,c.xy.y,c.xy.z),this._activeEffect.setFloat3('vSphericalYZ',c.yz.x,c.yz.y,c.yz.z),this._activeEffect.setFloat3('vSphericalZX',c.zx.x,c.zx.y,c.zx.z)),this._uniformBuffer.updateFloat3('vReflectionMicrosurfaceInfos',_.getSize().width,_.lodGenerationScale,_.lodGenerationOffset)}if(this._emissiveTexture&&m.StandardMaterial.EmissiveTextureEnabled&&(this._uniformBuffer.updateFloat2('vEmissiveInfos',this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),m.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,'emissive')),this._lightmapTexture&&m.StandardMaterial.LightmapTextureEnabled&&(this._uniformBuffer.updateFloat2('vLightmapInfos',this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),m.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,'lightmap')),m.StandardMaterial.SpecularTextureEnabled&&(this._metallicTexture?(this._uniformBuffer.updateFloat3('vReflectivityInfos',this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),m.MaterialHelper.BindTextureMatrix(this._metallicTexture,this._uniformBuffer,'reflectivity')):this._reflectivityTexture&&(this._uniformBuffer.updateFloat3('vReflectivityInfos',this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),m.MaterialHelper.BindTextureMatrix(this._reflectivityTexture,this._uniformBuffer,'reflectivity')),this._microSurfaceTexture&&(this._uniformBuffer.updateFloat2('vMicroSurfaceSamplerInfos',this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),m.MaterialHelper.BindTextureMatrix(this._microSurfaceTexture,this._uniformBuffer,'microSurfaceSampler'))),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&m.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap&&(this._uniformBuffer.updateFloat3('vBumpInfos',this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),m.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,'bump'),r._mirroredCameraPosition?this._uniformBuffer.updateFloat2('vTangentSpaceParams',this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):this._uniformBuffer.updateFloat2('vTangentSpaceParams',this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),l&&m.StandardMaterial.RefractionTextureEnabled){this._uniformBuffer.updateMatrix('refractionMatrix',l.getReflectionTextureMatrix());var u=1;l.isCube||l.depth&&(u=l.depth),this._uniformBuffer.updateFloat4('vRefractionInfos',l.level,this._indexOfRefraction,u,this._invertRefractionY?-1:1),this._uniformBuffer.updateFloat3('vRefractionMicrosurfaceInfos',l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset)}}this.pointsCloud&&this._uniformBuffer.updateFloat('pointSize',this.pointSize),n.METALLICWORKFLOW?(m.PBRMaterial._scaledReflectivity.r=void 0===this._metallic||null===this._metallic?1:this._metallic,m.PBRMaterial._scaledReflectivity.g=void 0===this._roughness||null===this._roughness?1:this._roughness,this._uniformBuffer.updateColor4('vReflectivityColor',m.PBRMaterial._scaledReflectivity,0)):this._uniformBuffer.updateColor4('vReflectivityColor',this._reflectivityColor,this._microSurface),this._uniformBuffer.updateColor3('vEmissiveColor',this._emissiveColor),this._uniformBuffer.updateColor3('vReflectionColor',this._reflectionColor),this._uniformBuffer.updateColor4('vAlbedoColor',this._albedoColor,this.alpha*t.visibility),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity,this._lightingInfos.w=this._specularIntensity,this._uniformBuffer.updateVector4('vLightingIntensity',this._lightingInfos)}r.texturesEnabled&&(this._albedoTexture&&m.StandardMaterial.DiffuseTextureEnabled&&this._uniformBuffer.setTexture('albedoSampler',this._albedoTexture),this._ambientTexture&&m.StandardMaterial.AmbientTextureEnabled&&this._uniformBuffer.setTexture('ambientSampler',this._ambientTexture),this._opacityTexture&&m.StandardMaterial.OpacityTextureEnabled&&this._uniformBuffer.setTexture('opacitySampler',this._opacityTexture),_&&m.StandardMaterial.ReflectionTextureEnabled&&(n.LODBASEDMICROSFURACE?this._uniformBuffer.setTexture('reflectionSampler',_):(this._uniformBuffer.setTexture('reflectionSampler',_._lodTextureMid||_),this._uniformBuffer.setTexture('reflectionSamplerLow',_._lodTextureLow||_),this._uniformBuffer.setTexture('reflectionSamplerHigh',_._lodTextureHigh||_))),n.ENVIRONMENTBRDF&&this._uniformBuffer.setTexture('environmentBrdfSampler',this._environmentBRDFTexture),l&&m.StandardMaterial.RefractionTextureEnabled&&(n.LODBASEDMICROSFURACE?this._uniformBuffer.setTexture('refractionSampler',l):(this._uniformBuffer.setTexture('refractionSampler',l._lodTextureMid||l),this._uniformBuffer.setTexture('refractionSamplerLow',l._lodTextureLow||l),this._uniformBuffer.setTexture('refractionSamplerHigh',l._lodTextureHigh||l))),this._emissiveTexture&&m.StandardMaterial.EmissiveTextureEnabled&&this._uniformBuffer.setTexture('emissiveSampler',this._emissiveTexture),this._lightmapTexture&&m.StandardMaterial.LightmapTextureEnabled&&this._uniformBuffer.setTexture('lightmapSampler',this._lightmapTexture),m.StandardMaterial.SpecularTextureEnabled&&(this._metallicTexture?this._uniformBuffer.setTexture('reflectivitySampler',this._metallicTexture):this._reflectivityTexture&&this._uniformBuffer.setTexture('reflectivitySampler',this._reflectivityTexture),this._microSurfaceTexture&&this._uniformBuffer.setTexture('microSurfaceSampler',this._microSurfaceTexture)),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&m.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap&&this._uniformBuffer.setTexture('bumpSampler',this._bumpTexture)),m.MaterialHelper.BindClipPlane(this._activeEffect,r),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor);var f=r._forcedViewPosition?r._forcedViewPosition:r._mirroredCameraPosition?r._mirroredCameraPosition:r.activeCamera.globalPosition,d=r.useRightHandedSystem===(null!=r._mirroredCameraPosition);o.setFloat4('vEyePosition',f.x,f.y,f.z,d?-1:1),o.setColor3('vAmbientColor',this._globalAmbientColor)}!s&&this.isFrozen||(r.lightsEnabled&&!this._disableLighting&&m.MaterialHelper.BindLights(r,t,this._activeEffect,n,this._maxSimultaneousLights,this._usePhysicalLightFalloff),(r.fogEnabled&&t.applyFog&&r.fogMode!==m.Scene.FOGMODE_NONE||_)&&this.bindView(o),m.MaterialHelper.BindFogParameters(r,t,this._activeEffect),n.NUM_MORPH_INFLUENCERS&&m.MaterialHelper.BindMorphTargetParameters(t,this._activeEffect),this._imageProcessingConfiguration.bind(this._activeEffect),m.MaterialHelper.BindLogDepth(n,this._activeEffect,r)),this._uniformBuffer.update(),this._afterBind(t,this._activeEffect)}}},e.prototype.getAnimatables=function(){var t=[];return this._albedoTexture&&this._albedoTexture.animations&&0<this._albedoTexture.animations.length&&t.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&0<this._ambientTexture.animations.length&&t.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&0<this._opacityTexture.animations.length&&t.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&0<this._reflectionTexture.animations.length&&t.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&0<this._emissiveTexture.animations.length&&t.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&0<this._metallicTexture.animations.length?t.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&0<this._reflectivityTexture.animations.length&&t.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&0<this._bumpTexture.animations.length&&t.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&0<this._lightmapTexture.animations.length&&t.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&0<this._refractionTexture.animations.length&&t.push(this._refractionTexture),t},e.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},e.prototype._getRefractionTexture=function(){return this._refractionTexture?this._refractionTexture:this._linkRefractionWithTransparency?this.getScene().environmentTexture:null},e.prototype.dispose=function(r,e){e&&(this._albedoTexture&&this._albedoTexture.dispose(),this._ambientTexture&&this._ambientTexture.dispose(),this._opacityTexture&&this._opacityTexture.dispose(),this._reflectionTexture&&this._reflectionTexture.dispose(),this._environmentBRDFTexture&&this.getScene()._environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._emissiveTexture&&this._emissiveTexture.dispose(),this._metallicTexture&&this._metallicTexture.dispose(),this._reflectivityTexture&&this._reflectivityTexture.dispose(),this._bumpTexture&&this._bumpTexture.dispose(),this._lightmapTexture&&this._lightmapTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),o.prototype.dispose.call(this,r,e)},e._scaledReflectivity=new m.Color3,g([m.serializeAsImageProcessingConfiguration()],e.prototype,'_imageProcessingConfiguration',void 0),g([m.serialize()],e.prototype,'useLogarithmicDepth',null),g([m.serialize()],e.prototype,'transparencyMode',null),e}(m.PushMaterial);m.PBRBaseMaterial=e}(e||(e={}));var e;!function(o){var e=function(a){function e(e,t){var r=a.call(this,e,t)||this;return r.maxSimultaneousLights=4,r.disableLighting=!1,r.invertNormalMapX=!1,r.invertNormalMapY=!1,r.emissiveColor=new o.Color3(0,0,0),r.occlusionStrength=1,r.useLightmapAsShadowmap=!1,r._useAlphaFromAlbedoTexture=!0,r._useAmbientInGrayScale=!0,r}return h(e,a),Object.defineProperty(e.prototype,'doubleSided',{get:function(){return this._twoSidedLighting},set:function(t){this._twoSidedLighting!==t&&(this._twoSidedLighting=t,this.backFaceCulling=!t,this._markAllSubMeshesAsTexturesDirty())},enumerable:!0,configurable:!0}),e.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);return this.environmentTexture&&t.push(this.environmentTexture),this.normalTexture&&t.push(this.normalTexture),this.emissiveTexture&&t.push(this.emissiveTexture),this.occlusionTexture&&t.push(this.occlusionTexture),this.lightmapTexture&&t.push(this.lightmapTexture),t},e.prototype.hasTexture=function(t){return!!a.prototype.hasTexture.call(this,t)||this.lightmapTexture===t},e.prototype.getClassName=function(){return'PBRBaseSimpleMaterial'},g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsLightsDirty')],e.prototype,'maxSimultaneousLights',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsLightsDirty')],e.prototype,'disableLighting',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_reflectionTexture')],e.prototype,'environmentTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'invertNormalMapX',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'invertNormalMapY',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_bumpTexture')],e.prototype,'normalTexture',void 0),g([o.serializeAsColor3('emissive'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'emissiveColor',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'emissiveTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_ambientTextureStrength')],e.prototype,'occlusionStrength',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_ambientTexture')],e.prototype,'occlusionTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_alphaCutOff')],e.prototype,'alphaCutOff',void 0),g([o.serialize()],e.prototype,'doubleSided',null),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty',null)],e.prototype,'lightmapTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useLightmapAsShadowmap',void 0),e}(o.PBRBaseMaterial);o.PBRBaseSimpleMaterial=e}(e||(e={}));var e;!function(o){var e=function(a){function e(e,t){var r=a.call(this,e,t)||this;return r.directIntensity=1,r.emissiveIntensity=1,r.environmentIntensity=1,r.specularIntensity=1,r.disableBumpMap=!1,r.ambientTextureStrength=1,r.ambientColor=new o.Color3(0,0,0),r.albedoColor=new o.Color3(1,1,1),r.reflectivityColor=new o.Color3(1,1,1),r.reflectionColor=new o.Color3(1,1,1),r.emissiveColor=new o.Color3(0,0,0),r.microSurface=1,r.indexOfRefraction=.66,r.invertRefractionY=!1,r.linkRefractionWithTransparency=!1,r.useLightmapAsShadowmap=!1,r.useAlphaFromAlbedoTexture=!1,r.forceAlphaTest=!1,r.alphaCutOff=.4,r.useSpecularOverAlpha=!0,r.useMicroSurfaceFromReflectivityMapAlpha=!1,r.useRoughnessFromMetallicTextureAlpha=!0,r.useRoughnessFromMetallicTextureGreen=!1,r.useMetallnessFromMetallicTextureBlue=!1,r.useAmbientOcclusionFromMetallicTextureRed=!1,r.useAmbientInGrayScale=!1,r.useAutoMicroSurfaceFromReflectivityMap=!1,r.usePhysicalLightFalloff=!0,r.useRadianceOverAlpha=!0,r.useObjectSpaceNormalMap=!1,r.useParallax=!1,r.useParallaxOcclusion=!1,r.parallaxScaleBias=.05,r.disableLighting=!1,r.forceIrradianceInFragment=!1,r.maxSimultaneousLights=4,r.invertNormalMapX=!1,r.invertNormalMapY=!1,r.twoSidedLighting=!1,r.useAlphaFresnel=!1,r.useLinearAlphaFresnel=!1,r.environmentBRDFTexture=null,r.forceNormalForward=!1,r.enableSpecularAntiAliasing=!1,r.useHorizonOcclusion=!0,r.useRadianceOcclusion=!0,r.unlit=!1,r._environmentBRDFTexture=o.TextureTools.GetEnvironmentBRDFTexture(t),r}return h(e,a),Object.defineProperty(e,'PBRMATERIAL_OPAQUE',{get:function(){return this._PBRMATERIAL_OPAQUE},enumerable:!0,configurable:!0}),Object.defineProperty(e,'PBRMATERIAL_ALPHATEST',{get:function(){return this._PBRMATERIAL_ALPHATEST},enumerable:!0,configurable:!0}),Object.defineProperty(e,'PBRMATERIAL_ALPHABLEND',{get:function(){return this._PBRMATERIAL_ALPHABLEND},enumerable:!0,configurable:!0}),Object.defineProperty(e,'PBRMATERIAL_ALPHATESTANDBLEND',{get:function(){return this._PBRMATERIAL_ALPHATESTANDBLEND},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'imageProcessingConfiguration',{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraColorCurvesEnabled',{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraColorGradingEnabled',{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraToneMappingEnabled',{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraExposure',{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraContrast',{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraColorGradingTexture',{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this._imageProcessingConfiguration.colorGradingTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'cameraColorCurves',{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(t){this._imageProcessingConfiguration.colorCurves=t},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'PBRMaterial'},e.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);return this._albedoTexture&&t.push(this._albedoTexture),this._ambientTexture&&t.push(this._ambientTexture),this._opacityTexture&&t.push(this._opacityTexture),this._reflectionTexture&&t.push(this._reflectionTexture),this._emissiveTexture&&t.push(this._emissiveTexture),this._reflectivityTexture&&t.push(this._reflectivityTexture),this._metallicTexture&&t.push(this._metallicTexture),this._microSurfaceTexture&&t.push(this._microSurfaceTexture),this._bumpTexture&&t.push(this._bumpTexture),this._lightmapTexture&&t.push(this._lightmapTexture),this._refractionTexture&&t.push(this._refractionTexture),t},e.prototype.hasTexture=function(t){return!!a.prototype.hasTexture.call(this,t)||this._albedoTexture===t||this._ambientTexture===t||this._opacityTexture===t||this._reflectionTexture===t||this._reflectivityTexture===t||this._metallicTexture===t||this._microSurfaceTexture===t||this._bumpTexture===t||this._lightmapTexture===t||this._refractionTexture===t},e.prototype.clone=function(i){var t=this,r=o.SerializationHelper.Clone(function(){return new e(i,t.getScene())},this);return r.id=i,r.name=i,r},e.prototype.serialize=function(){var e=o.SerializationHelper.Serialize(this);return e.customType='BABYLON.PBRMaterial',e},e.Parse=function(i,t,r){return o.SerializationHelper.Parse(function(){return new e(i.name,t)},i,t,r)},e._PBRMATERIAL_OPAQUE=0,e._PBRMATERIAL_ALPHATEST=1,e._PBRMATERIAL_ALPHABLEND=2,e._PBRMATERIAL_ALPHATESTANDBLEND=3,g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'directIntensity',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'emissiveIntensity',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'environmentIntensity',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'specularIntensity',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'disableBumpMap',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'albedoTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'ambientTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'ambientTextureStrength',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],e.prototype,'opacityTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'reflectionTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'emissiveTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'reflectivityTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'metallicTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'metallic',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'roughness',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'microSurfaceTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'bumpTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty',null)],e.prototype,'lightmapTexture',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'refractionTexture',void 0),g([o.serializeAsColor3('ambient'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'ambientColor',void 0),g([o.serializeAsColor3('albedo'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'albedoColor',void 0),g([o.serializeAsColor3('reflectivity'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'reflectivityColor',void 0),g([o.serializeAsColor3('reflection'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'reflectionColor',void 0),g([o.serializeAsColor3('emissive'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'emissiveColor',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'microSurface',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'indexOfRefraction',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'invertRefractionY',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'linkRefractionWithTransparency',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useLightmapAsShadowmap',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],e.prototype,'useAlphaFromAlbedoTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],e.prototype,'forceAlphaTest',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesAndMiscDirty')],e.prototype,'alphaCutOff',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useSpecularOverAlpha',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useMicroSurfaceFromReflectivityMapAlpha',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useRoughnessFromMetallicTextureAlpha',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useRoughnessFromMetallicTextureGreen',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useMetallnessFromMetallicTextureBlue',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useAmbientOcclusionFromMetallicTextureRed',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useAmbientInGrayScale',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useAutoMicroSurfaceFromReflectivityMap',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'usePhysicalLightFalloff',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useRadianceOverAlpha',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useObjectSpaceNormalMap',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useParallax',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useParallaxOcclusion',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'parallaxScaleBias',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsLightsDirty')],e.prototype,'disableLighting',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'forceIrradianceInFragment',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsLightsDirty')],e.prototype,'maxSimultaneousLights',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'invertNormalMapX',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'invertNormalMapY',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'twoSidedLighting',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useAlphaFresnel',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useLinearAlphaFresnel',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'environmentBRDFTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'forceNormalForward',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'enableSpecularAntiAliasing',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useHorizonOcclusion',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'useRadianceOcclusion',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsLightsDirty')],e.prototype,'unlit',void 0),e}(o.PBRBaseMaterial);o.PBRMaterial=e}(e||(e={}));var e;!function(o){var e=function(a){function e(t,e){var o=a.call(this,t,e)||this;return o._useRoughnessFromMetallicTextureAlpha=!1,o._useRoughnessFromMetallicTextureGreen=!0,o._useMetallnessFromMetallicTextureBlue=!0,o.metallic=1,o.roughness=1,o}return h(e,a),e.prototype.getClassName=function(){return'PBRMetallicRoughnessMaterial'},e.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);return this.baseTexture&&t.push(this.baseTexture),this.metallicRoughnessTexture&&t.push(this.metallicRoughnessTexture),t},e.prototype.hasTexture=function(t){return!!a.prototype.hasTexture.call(this,t)||this.baseTexture===t||this.metallicRoughnessTexture===t},e.prototype.clone=function(i){var t=this,r=o.SerializationHelper.Clone(function(){return new e(i,t.getScene())},this);return r.id=i,r.name=i,r},e.prototype.serialize=function(){var e=o.SerializationHelper.Serialize(this);return e.customType='BABYLON.PBRMetallicRoughnessMaterial',e},e.Parse=function(i,t,r){return o.SerializationHelper.Parse(function(){return new e(i.name,t)},i,t,r)},g([o.serializeAsColor3(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_albedoColor')],e.prototype,'baseColor',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_albedoTexture')],e.prototype,'baseTexture',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'metallic',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty')],e.prototype,'roughness',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_metallicTexture')],e.prototype,'metallicRoughnessTexture',void 0),e}(o.PBRBaseSimpleMaterial);o.PBRMetallicRoughnessMaterial=e}(e||(e={}));var e;!function(o){var e=function(a){function e(t,e){var o=a.call(this,t,e)||this;return o._useMicroSurfaceFromReflectivityMapAlpha=!0,o}return h(e,a),e.prototype.getClassName=function(){return'PBRSpecularGlossinessMaterial'},e.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);return this.diffuseTexture&&t.push(this.diffuseTexture),this.specularGlossinessTexture&&t.push(this.specularGlossinessTexture),t},e.prototype.hasTexture=function(t){return!!a.prototype.hasTexture.call(this,t)||this.diffuseTexture===t||this.specularGlossinessTexture===t},e.prototype.clone=function(i){var t=this,r=o.SerializationHelper.Clone(function(){return new e(i,t.getScene())},this);return r.id=i,r.name=i,r},e.prototype.serialize=function(){var e=o.SerializationHelper.Serialize(this);return e.customType='BABYLON.PBRSpecularGlossinessMaterial',e},e.Parse=function(i,t,r){return o.SerializationHelper.Parse(function(){return new e(i.name,t)},i,t,r)},g([o.serializeAsColor3('diffuse'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_albedoColor')],e.prototype,'diffuseColor',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_albedoTexture')],e.prototype,'diffuseTexture',void 0),g([o.serializeAsColor3('specular'),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_reflectivityColor')],e.prototype,'specularColor',void 0),g([o.serialize(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_microSurface')],e.prototype,'glossiness',void 0),g([o.serializeAsTexture(),o.expandToProperty('_markAllSubMeshesAsTexturesDirty','_reflectivityTexture')],e.prototype,'specularGlossinessTexture',void 0),e}(o.PBRBaseSimpleMaterial);o.PBRSpecularGlossinessMaterial=e}(e||(e={}));var e;!function(a){a.CameraInputTypes={};var e=function(){function e(t){this.attached={},this.camera=t,this.checkInputs=function(){}}return e.prototype.add=function(e){var t=e.getSimpleName();return this.attached[t]?void a.Tools.Warn('camera input of type '+t+' already exists on camera'):void(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedElement&&e.attachControl(this.attachedElement))},e.prototype.remove=function(r){for(var e in this.attached){var t=this.attached[e];t===r&&(t.detachControl(this.attachedElement),t.camera=null,delete this.attached[e],this.rebuildInputCheck())}},e.prototype.removeByType=function(r){for(var e in this.attached){var t=this.attached[e];t.getClassName()===r&&(t.detachControl(this.attachedElement),t.camera=null,delete this.attached[e],this.rebuildInputCheck())}},e.prototype._addCheckInputs=function(r){var e=this.checkInputs;return function(){e(),r()}},e.prototype.attachInput=function(t){this.attachedElement&&t.attachControl(this.attachedElement,this.noPreventDefault)},e.prototype.attachElement=function(e,t){if(void 0===t&&(t=!1),!this.attachedElement)for(var o in t=!a.Camera.ForceAttachControlToAlwaysPreventDefault&&t,this.attachedElement=e,this.noPreventDefault=t,this.attached)this.attached[o].attachControl(e,t)},e.prototype.detachElement=function(r,e){if(void 0===e&&(e=!1),this.attachedElement===r){for(var t in this.attached)this.attached[t].detachControl(r),e&&(this.attached[t].camera=null);this.attachedElement=null}},e.prototype.rebuildInputCheck=function(){for(var r in this.checkInputs=function(){},this.attached){var e=this.attached[r];e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e)))}},e.prototype.clear=function(){this.attachedElement&&this.detachElement(this.attachedElement,!0),this.attached={},this.attachedElement=null,this.checkInputs=function(){}},e.prototype.serialize=function(e){var t={};for(var i in this.attached){var r=this.attached[i],n=a.SerializationHelper.Serialize(r);t[r.getClassName()]=n}e.inputsmgr=t},e.prototype.parse=function(e){var t=e.inputsmgr;if(t)for(var i in this.clear(),t){var r=a.CameraInputTypes[i];if(r){var n=t[i],o=a.SerializationHelper.Parse(function(){return new r},n,null);this.add(o)}}else for(var i in this.attached){var r=a.CameraInputTypes[this.attached[i].getClassName()];if(r){var o=a.SerializationHelper.Parse(function(){return new r},e,null);this.remove(this.attached[i]),this.add(o)}}},e}();a.CameraInputsManager=e}(e||(e={}));var e;!function(a){var e=function(l){function e(e,t,r,n){void 0===n&&(n=!0);var o=l.call(this,e,t,r,n)||this;return o.cameraDirection=new a.Vector3(0,0,0),o.cameraRotation=new a.Vector2(0,0),o.rotation=new a.Vector3(0,0,0),o.speed=2,o.noRotationConstraint=!1,o.lockedTarget=null,o._currentTarget=a.Vector3.Zero(),o._viewMatrix=a.Matrix.Zero(),o._camMatrix=a.Matrix.Zero(),o._cameraTransformMatrix=a.Matrix.Zero(),o._cameraRotationMatrix=a.Matrix.Zero(),o._referencePoint=new a.Vector3(0,0,1),o._currentUpVector=new a.Vector3(0,1,0),o._transformedReferencePoint=a.Vector3.Zero(),o._globalCurrentTarget=a.Vector3.Zero(),o._globalCurrentUpVector=a.Vector3.Zero(),o}return h(e,l),e.prototype.getFrontPosition=function(r){this.getWorldMatrix();var e=this.getTarget().subtract(this.position);return e.normalize(),e.scaleInPlace(r),this.globalPosition.add(e)},e.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},e.prototype.storeState=function(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),l.prototype.storeState.call(this)},e.prototype._restoreStateValues=function(){return!!l.prototype._restoreStateValues.call(this)&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)},e.prototype._initCache=function(){l.prototype._initCache.call(this),this._cache.lockedTarget=new a.Vector3(S,S,S),this._cache.rotation=new a.Vector3(S,S,S),this._cache.rotationQuaternion=new a.Quaternion(S,S,S,S)},e.prototype._updateCache=function(t){t||l.prototype._updateCache.call(this);var e=this._getLockedTargetPosition();e?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(e):this._cache.lockedTarget=e.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},e.prototype._isSynchronizedViewMatrix=function(){if(!l.prototype._isSynchronizedViewMatrix.call(this))return!1;var t=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},e.prototype._computeLocalCameraSpeed=function(){var t=this.getEngine();return this.speed*$(t.getDeltaTime()/(100*t.getFps()))},e.prototype.setTarget=function(e){this.upVector.normalize(),a.Matrix.LookAtLHToRef(this.position,e,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=f(this._camMatrix.m[6]/this._camMatrix.m[10]);var t=e.subtract(this.position);this.rotation.y=0<=t.x?-f(t.z/t.x)+V/2:-f(t.z/t.x)-V/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&a.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},e.prototype.getTarget=function(){return this._currentTarget},e.prototype._decideIfNeedsToMove=function(){return 0<A(this.cameraDirection.x)||0<A(this.cameraDirection.y)||0<A(this.cameraDirection.z)},e.prototype._updatePosition=function(){return this.parent?(this.parent.getWorldMatrix().invertToRef(a.Tmp.Matrix[0]),a.Vector3.TransformNormalToRef(this.cameraDirection,a.Tmp.Matrix[0],a.Tmp.Vector3[0]),void this.position.addInPlace(a.Tmp.Vector3[0])):void this.position.addInPlace(this.cameraDirection)},e.prototype._checkInputs=function(){var e=this._decideIfNeedsToMove(),t=0<A(this.cameraRotation.x)||0<A(this.cameraRotation.y);if((e&&this._updatePosition(),t)&&((this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,this.rotationQuaternion)&&this.rotation.lengthSquared()&&a.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion),!this.noRotationConstraint)){var r=.95*(V/2);this.rotation.x>r&&(this.rotation.x=r),this.rotation.x<-r&&(this.rotation.x=-r)}e&&(A(this.cameraDirection.x)<this.speed*a.Epsilon&&(this.cameraDirection.x=0),A(this.cameraDirection.y)<this.speed*a.Epsilon&&(this.cameraDirection.y=0),A(this.cameraDirection.z)<this.speed*a.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),t&&(A(this.cameraRotation.x)<this.speed*a.Epsilon&&(this.cameraRotation.x=0),A(this.cameraRotation.y)<this.speed*a.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),l.prototype._checkInputs.call(this)},e.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):a.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),a.Vector3.TransformNormalToRef(this.upVector,this._cameraRotationMatrix,this._currentUpVector)},e.prototype._getViewMatrix=function(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),a.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this._computeViewMatrix(this.position,this._currentTarget,this._currentUpVector),this._viewMatrix},e.prototype._computeViewMatrix=function(e,t,o){if(this.parent){var r=this.parent.getWorldMatrix();a.Vector3.TransformCoordinatesToRef(this.position,r,this._globalPosition),a.Vector3.TransformCoordinatesToRef(t,r,this._globalCurrentTarget),a.Vector3.TransformNormalToRef(o,r,this._globalCurrentUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(this.position),this._globalCurrentTarget.copyFrom(t),this._globalCurrentUpVector.copyFrom(o);this.getScene().useRightHandedSystem?a.Matrix.LookAtRHToRef(this._globalPosition,this._globalCurrentTarget,this._globalCurrentUpVector,this._viewMatrix):a.Matrix.LookAtLHToRef(this._globalPosition,this._globalCurrentTarget,this._globalCurrentUpVector,this._viewMatrix)},e.prototype.createRigCamera=function(r){if(this.cameraRigMode!==a.Camera.RIG_MODE_NONE){var t=new e(r,this.position.clone(),this.getScene());return this.cameraRigMode!==a.Camera.RIG_MODE_VR&&this.cameraRigMode!==a.Camera.RIG_MODE_WEBVR||(this.rotationQuaternion||(this.rotationQuaternion=new a.Quaternion),t._cameraRigParams={},t.rotationQuaternion=new a.Quaternion),t}return null},e.prototype._updateRigCameras=function(){var e=this._rigCameras[0],t=this._rigCameras[1];switch(this.cameraRigMode){case a.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case a.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case a.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case a.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var r=this.cameraRigMode===a.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,i=this.cameraRigMode===a.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*r,e.position),this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*i,t.position),e.setTarget(this.getTarget()),t.setTarget(this.getTarget());break;case a.Camera.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);}l.prototype._updateRigCameras.call(this)},e.prototype._getRigCamPosition=function(e,t){this._rigCamTransformMatrix||(this._rigCamTransformMatrix=new a.Matrix);var o=this.getTarget();a.Matrix.Translation(-o.x,-o.y,-o.z).multiplyToRef(a.Matrix.RotationY(e),this._rigCamTransformMatrix),this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(a.Matrix.Translation(o.x,o.y,o.z)),a.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,t)},e.prototype.getClassName=function(){return'TargetCamera'},g([a.serializeAsVector3()],e.prototype,'rotation',void 0),g([a.serialize()],e.prototype,'speed',void 0),g([a.serializeAsMeshReference('lockedTargetId')],e.prototype,'lockedTarget',void 0),e}(a.Camera);a.TargetCamera=e}(e||(e={}));var e;!function(s){var e=function(){function e(t){void 0===t&&(t=!0),this.touchEnabled=t,this.buttons=[0,1,2],this.angularSensibility=2e3,this.previousPosition=null}return e.prototype.attachControl=function(e,d){var i=this,r=this.camera.getEngine();this._pointerInput||(this._pointerInput=function(t){var o=t.event;if(!r.isInVRExclusivePointerMode&&(i.touchEnabled||'touch'!==o.pointerType)&&(t.type===s.PointerEventTypes.POINTERMOVE||-1!==i.buttons.indexOf(o.button))){var a=o.srcElement||o.target;if(t.type===s.PointerEventTypes.POINTERDOWN&&a){try{a.setPointerCapture(o.pointerId)}catch(t){}i.previousPosition={x:o.clientX,y:o.clientY},d||(o.preventDefault(),e.focus())}else if(t.type===s.PointerEventTypes.POINTERUP&&a){try{a.releasePointerCapture(o.pointerId)}catch(t){}i.previousPosition=null,d||o.preventDefault()}else if(t.type===s.PointerEventTypes.POINTERMOVE){if(!i.previousPosition||r.isPointerLock)return;var n=o.clientX-i.previousPosition.x;i.camera.getScene().useRightHandedSystem&&(n*=-1),i.camera.parent&&0>i.camera.parent._getWorldMatrixDeterminant()&&(n*=-1),i.camera.cameraRotation.y+=n/i.angularSensibility;var l=o.clientY-i.previousPosition.y;i.camera.cameraRotation.x+=l/i.angularSensibility,i.previousPosition={x:o.clientX,y:o.clientY},d||o.preventDefault()}}}),this._onMouseMove=function(a){if(r.isPointerLock&&!r.isInVRExclusivePointerMode){var e=a.movementX||a.mozMovementX||a.webkitMovementX||a.msMovementX||0;i.camera.getScene().useRightHandedSystem&&(e*=-1),i.camera.parent&&0>i.camera.parent._getWorldMatrixDeterminant()&&(e*=-1),i.camera.cameraRotation.y+=e/i.angularSensibility;var t=a.movementY||a.mozMovementY||a.webkitMovementY||a.msMovementY||0;i.camera.cameraRotation.x+=t/i.angularSensibility,i.previousPosition=null,d||a.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,s.PointerEventTypes.POINTERDOWN|s.PointerEventTypes.POINTERUP|s.PointerEventTypes.POINTERMOVE),e.addEventListener('mousemove',this._onMouseMove,!1)},e.prototype.detachControl=function(t){this._observer&&t&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._onMouseMove&&t.removeEventListener('mousemove',this._onMouseMove),this._observer=null,this._onMouseMove=null,this.previousPosition=null)},e.prototype.getClassName=function(){return'FreeCameraMouseInput'},e.prototype.getSimpleName=function(){return'mouse'},g([s.serialize()],e.prototype,'buttons',void 0),g([s.serialize()],e.prototype,'angularSensibility',void 0),e}();s.FreeCameraMouseInput=e,s.CameraInputTypes.FreeCameraMouseInput=e}(e||(e={}));var e;!function(a){var e=function(){function e(){this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39]}return e.prototype.attachControl=function(e,t){var i=this;this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){i._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(e){var r=e.event;if(e.type===a.KeyboardEventTypes.KEYDOWN){if(-1!==i.keysUp.indexOf(r.keyCode)||-1!==i.keysDown.indexOf(r.keyCode)||-1!==i.keysLeft.indexOf(r.keyCode)||-1!==i.keysRight.indexOf(r.keyCode)){var n=i._keys.indexOf(r.keyCode);-1===n&&i._keys.push(r.keyCode),t||r.preventDefault()}}else if(-1!==i.keysUp.indexOf(r.keyCode)||-1!==i.keysDown.indexOf(r.keyCode)||-1!==i.keysLeft.indexOf(r.keyCode)||-1!==i.keysRight.indexOf(r.keyCode)){var n=i._keys.indexOf(r.keyCode);0<=n&&i._keys.splice(n,1),t||r.preventDefault()}}))},e.prototype.detachControl=function(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},e.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var e=this.camera,t=0;t<this._keys.length;t++){var o=this._keys[t],r=e._computeLocalCameraSpeed();-1===this.keysLeft.indexOf(o)?-1===this.keysUp.indexOf(o)?-1===this.keysRight.indexOf(o)?-1!==this.keysDown.indexOf(o)&&e._localDirection.copyFromFloats(0,0,-r):e._localDirection.copyFromFloats(r,0,0):e._localDirection.copyFromFloats(0,0,r):e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),a.Vector3.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}},e.prototype.getClassName=function(){return'FreeCameraKeyboardMoveInput'},e.prototype._onLostFocus=function(){this._keys=[]},e.prototype.getSimpleName=function(){return'keyboard'},g([a.serialize()],e.prototype,'keysUp',void 0),g([a.serialize()],e.prototype,'keysDown',void 0),g([a.serialize()],e.prototype,'keysLeft',void 0),g([a.serialize()],e.prototype,'keysRight',void 0),e}();a.FreeCameraKeyboardMoveInput=e,a.CameraInputTypes.FreeCameraKeyboardMoveInput=e}(e||(e={}));var e;!function(r){var e=function(o){function e(t){return o.call(this,t)||this}return h(e,o),e.prototype.addKeyboard=function(){return this.add(new r.FreeCameraKeyboardMoveInput),this},e.prototype.addMouse=function(e){return void 0===e&&(e=!0),this.add(new r.FreeCameraMouseInput(e)),this},e.prototype.addGamepad=function(){return this.add(new r.FreeCameraGamepadInput),this},e.prototype.addDeviceOrientation=function(){return this.add(new r.FreeCameraDeviceOrientationInput),this},e.prototype.addTouch=function(){return this.add(new r.FreeCameraTouchInput),this},e.prototype.addVirtualJoystick=function(){return this.add(new r.FreeCameraVirtualJoystickInput),this},e}(r.CameraInputsManager);r.FreeCameraInputsManager=e}(e||(e={}));var e;!function(a){var e=function(e){function t(t,l,r,n){void 0===n&&(n=!0);var o=e.call(this,t,l,r,n)||this;return o.ellipsoid=new a.Vector3(.5,1,.5),o.ellipsoidOffset=new a.Vector3(0,0,0),o.checkCollisions=!1,o.applyGravity=!1,o._needMoveForGravity=!1,o._oldPosition=a.Vector3.Zero(),o._diffPosition=a.Vector3.Zero(),o._newPosition=a.Vector3.Zero(),o._collisionMask=-1,o._onCollisionPositionChange=function(e,t,i){void 0===i&&(i=null),o.getScene().workerCollisions&&t.multiplyInPlace(o._collider._radius),!function(e){o._newPosition.copyFrom(e),o._newPosition.subtractToRef(o._oldPosition,o._diffPosition),o._diffPosition.length()>a.Engine.CollisionsEpsilon&&(o.position.addInPlace(o._diffPosition),o.onCollide&&i&&o.onCollide(i))}(t)},o.inputs=new a.FreeCameraInputsManager(o),o.inputs.addKeyboard().addMouse(),o}return h(t,e),Object.defineProperty(t.prototype,'angularSensibility',{get:function(){var t=this.inputs.attached.mouse;return t?t.angularSensibility:0},set:function(r){var e=this.inputs.attached.mouse;e&&(e.angularSensibility=r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'keysUp',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysUp:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysUp=r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'keysDown',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysDown:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysDown=r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'keysLeft',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysLeft:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysLeft=r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'keysRight',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRight:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysRight=r)},enumerable:!0,configurable:!0}),t.prototype.attachControl=function(r,e){this.inputs.attachElement(r,e)},t.prototype.detachControl=function(e){this.inputs.detachElement(e),this.cameraDirection=new a.Vector3(0,0,0),this.cameraRotation=new a.Vector2(0,0)},Object.defineProperty(t.prototype,'collisionMask',{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!0,configurable:!0}),t.prototype._collideWithWorld=function(e){var t;t=this.parent?a.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset),this._collider||(this._collider=new a.Collider),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var o=e;this.applyGravity&&(o=e.add(this.getScene().gravity)),this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,o,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},t.prototype._checkInputs=function(){this._localDirection||(this._localDirection=a.Vector3.Zero(),this._transformedDirection=a.Vector3.Zero()),this.inputs.checkInputs(),e.prototype._checkInputs.call(this)},t.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||0<A(this.cameraDirection.x)||0<A(this.cameraDirection.y)||0<A(this.cameraDirection.z)},t.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):e.prototype._updatePosition.call(this)},t.prototype.dispose=function(){this.inputs.clear(),e.prototype.dispose.call(this)},t.prototype.getClassName=function(){return'FreeCamera'},g([a.serializeAsVector3()],t.prototype,'ellipsoid',void 0),g([a.serializeAsVector3()],t.prototype,'ellipsoidOffset',void 0),g([a.serialize()],t.prototype,'checkCollisions',void 0),g([a.serialize()],t.prototype,'applyGravity',void 0),t}(a.TargetCamera);a.FreeCamera=e}(e||(e={}));var e;!function(a){var e=function(){function e(){this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0}return e.prototype.attachControl=function(e,t){var i=this;this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){i._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(e){var r=e.event;if(e.type===a.KeyboardEventTypes.KEYDOWN){if(i._ctrlPressed=r.ctrlKey,i._altPressed=r.altKey,-1!==i.keysUp.indexOf(r.keyCode)||-1!==i.keysDown.indexOf(r.keyCode)||-1!==i.keysLeft.indexOf(r.keyCode)||-1!==i.keysRight.indexOf(r.keyCode)||-1!==i.keysReset.indexOf(r.keyCode)){var n=i._keys.indexOf(r.keyCode);-1===n&&i._keys.push(r.keyCode),r.preventDefault&&(t||r.preventDefault())}}else if(-1!==i.keysUp.indexOf(r.keyCode)||-1!==i.keysDown.indexOf(r.keyCode)||-1!==i.keysLeft.indexOf(r.keyCode)||-1!==i.keysRight.indexOf(r.keyCode)||-1!==i.keysReset.indexOf(r.keyCode)){var n=i._keys.indexOf(r.keyCode);0<=n&&i._keys.splice(n,1),r.preventDefault&&(t||r.preventDefault())}}))},e.prototype.detachControl=function(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},e.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var r=this.camera,e=0,t;e<this._keys.length;e++)t=this._keys[e],-1===this.keysLeft.indexOf(t)?-1===this.keysUp.indexOf(t)?-1===this.keysRight.indexOf(t)?-1===this.keysDown.indexOf(t)?-1!==this.keysReset.indexOf(t)&&r.restoreState():this._ctrlPressed&&this.camera._useCtrlForPanning?r.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?r.inertialRadiusOffset-=1/this.zoomingSensibility:r.inertialBetaOffset+=.01:this._ctrlPressed&&this.camera._useCtrlForPanning?r.inertialPanningX+=1/this.panningSensibility:r.inertialAlphaOffset+=.01:this._ctrlPressed&&this.camera._useCtrlForPanning?r.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?r.inertialRadiusOffset+=1/this.zoomingSensibility:r.inertialBetaOffset-=.01:this._ctrlPressed&&this.camera._useCtrlForPanning?r.inertialPanningX-=1/this.panningSensibility:r.inertialAlphaOffset-=.01},e.prototype.getClassName=function(){return'ArcRotateCameraKeyboardMoveInput'},e.prototype.getSimpleName=function(){return'keyboard'},g([a.serialize()],e.prototype,'keysUp',void 0),g([a.serialize()],e.prototype,'keysDown',void 0),g([a.serialize()],e.prototype,'keysLeft',void 0),g([a.serialize()],e.prototype,'keysRight',void 0),g([a.serialize()],e.prototype,'keysReset',void 0),g([a.serialize()],e.prototype,'panningSensibility',void 0),g([a.serialize()],e.prototype,'zoomingSensibility',void 0),g([a.serialize()],e.prototype,'useAltToZoom',void 0),e}();a.ArcRotateCameraKeyboardMoveInput=e,a.CameraInputTypes.ArcRotateCameraKeyboardMoveInput=e}(e||(e={}));var e;!function(n){var e=function(){function e(){this.wheelPrecision=3,this.wheelDeltaPercentage=0}return e.prototype.attachControl=function(e,l){var i=this;this._wheel=function(e){if(e.type===n.PointerEventTypes.POINTERWHEEL){var t=e.event,r=0;if(!t.wheelDelta)t.detail&&(r=-t.detail/i.wheelPrecision);else if(i.wheelDeltaPercentage){var o=.01*t.wheelDelta*i.wheelDeltaPercentage*i.camera.radius;r=0<t.wheelDelta?o/(1+i.wheelDeltaPercentage):o*(1+i.wheelDeltaPercentage)}else r=t.wheelDelta/(40*i.wheelPrecision);r&&(i.camera.inertialRadiusOffset+=r),t.preventDefault&&(l||t.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,n.PointerEventTypes.POINTERWHEEL)},e.prototype.detachControl=function(t){this._observer&&t&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},e.prototype.getClassName=function(){return'ArcRotateCameraMouseWheelInput'},e.prototype.getSimpleName=function(){return'mousewheel'},g([n.serialize()],e.prototype,'wheelPrecision',void 0),g([n.serialize()],e.prototype,'wheelDeltaPercentage',void 0),e}();n.ArcRotateCameraMouseWheelInput=e,n.CameraInputTypes.ArcRotateCameraMouseWheelInput=e}(e||(e={}));var e;!function(d){var e=function(){function e(){this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this._isPanClick=!1,this.pinchInwards=!0}return e.prototype.attachControl=function(f,R){var i=this,n=this.camera.getEngine(),e=null,t=null,o=0,a=0,s=0,l={x:0,y:0,isPaning:!1,isPinching:!1},c;this._pointerInput=function(r){var u=r.event,p='touch'===r.event.pointerType;if(!n.isInVRExclusivePointerMode&&(r.type===d.PointerEventTypes.POINTERMOVE||-1!==i.buttons.indexOf(u.button))){var _=u.srcElement||u.target;if(r.type===d.PointerEventTypes.POINTERDOWN&&_){try{_.setPointerCapture(u.pointerId)}catch(t){}i._isPanClick=u.button===i.camera._panningMouseButton,c={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType},null===e?e=c:null===t&&(t=c),R||(u.preventDefault(),f.focus())}else if(r.type===d.PointerEventTypes.POINTERDOUBLETAP)i.camera.restoreState();else if(r.type===d.PointerEventTypes.POINTERUP&&_){try{_.releasePointerCapture(u.pointerId)}catch(t){}c=null,o=0,l.isPaning=!1,l.isPinching=!1,s=0,a=0,p||(t=null),n._badOS?e=t=null:t&&e&&e.pointerId==u.pointerId?(e=t,t=null,c={x:e.x,y:e.y,pointerId:e.pointerId,type:u.pointerType}):e&&t&&t.pointerId==u.pointerId?(t=null,c={x:e.x,y:e.y,pointerId:e.pointerId,type:u.pointerType}):e=t=null,R||u.preventDefault()}else if(r.type===d.PointerEventTypes.POINTERMOVE)if(R||u.preventDefault(),e&&null===t&&c){if(0!==i.panningSensibility&&(u.ctrlKey&&i.camera._useCtrlForPanning||i._isPanClick))i.camera.inertialPanningX+=-(u.clientX-c.x)/i.panningSensibility,i.camera.inertialPanningY+=(u.clientY-c.y)/i.panningSensibility;else{var m=u.clientX-c.x,g=u.clientY-c.y;i.camera.inertialAlphaOffset-=m/i.angularSensibilityX,i.camera.inertialBetaOffset-=g/i.angularSensibilityY}c.x=u.clientX,c.y=u.clientY}else if(e&&t){var h=e.pointerId===u.pointerId?e:t;h.x=u.clientX,h.y=u.clientY;var y=i.pinchInwards?1:-1,b=e.x-t.x,x=e.y-t.y,T=b*b+x*x,E=$(T);if(0===o)return a=E,o=T,l.x=(e.x+t.x)/2,void(l.y=(e.y+t.y)/2);if(!i.multiTouchPanAndZoom){if(s++,l.isPinching||20>s&&A(E-a)>i.camera.pinchToPanMaxDistance)i.camera.inertialRadiusOffset+=i.pinchDeltaPercentage?.001*(T-o)*i.camera.radius*i.pinchDeltaPercentage:(T-o)/(i.pinchPrecision*((i.angularSensibilityX+i.angularSensibilityY)/2)*y),l.isPaning=!1,l.isPinching=!0;else if(c&&c.pointerId===h.pointerId&&0!==i.panningSensibility&&i.multiTouchPanning){if(!l.isPaning)return l.isPaning=!0,l.isPinching=!1,l.x=h.x,void(l.y=h.y);i.camera.inertialPanningX+=-(h.x-l.x)/i.panningSensibility,i.camera.inertialPanningY+=(h.y-l.y)/i.panningSensibility}c&&c.pointerId===u.pointerId&&(l.x=h.x,l.y=h.y)}else if(i.camera.inertialRadiusOffset+=i.pinchDeltaPercentage?.001*(T-o)*i.camera.radius*i.pinchDeltaPercentage:(T-o)/(i.pinchPrecision*((i.angularSensibilityX+i.angularSensibilityY)/2)*y),0!==i.panningSensibility){var v=(e.x+t.x)/2,P=(e.y+t.y)/2,M=v-l.x,O=P-l.y;l.x=v,l.y=P,i.camera.inertialPanningX+=-M/i.panningSensibility,i.camera.inertialPanningY+=O/i.panningSensibility}o=T}}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,d.PointerEventTypes.POINTERDOWN|d.PointerEventTypes.POINTERUP|d.PointerEventTypes.POINTERMOVE|d.PointerEventTypes._POINTERDOUBLETAP),this._onContextMenu=function(t){t.preventDefault()},this.camera._useCtrlForPanning||f.addEventListener('contextmenu',this._onContextMenu,!1),this._onLostFocus=function(){e=t=null,o=0,l.isPaning=!1,l.isPinching=!1,s=0,c=null,a=0},this._onMouseMove=function(o){if(n.isPointerLock){var e=o.movementX||o.mozMovementX||o.webkitMovementX||o.msMovementX||0,t=o.movementY||o.mozMovementY||o.webkitMovementY||o.msMovementY||0;i.camera.inertialAlphaOffset-=e/i.angularSensibilityX,i.camera.inertialBetaOffset-=t/i.angularSensibilityY,R||o.preventDefault()}},this._onGestureStart=function(t){void 0!==window.MSGesture&&(i._MSGestureHandler||(i._MSGestureHandler=new MSGesture,i._MSGestureHandler.target=f),i._MSGestureHandler.addPointer(t.pointerId))},this._onGesture=function(t){i.camera.radius*=t.scale,t.preventDefault&&(R||(t.stopPropagation(),t.preventDefault()))},f.addEventListener('mousemove',this._onMouseMove,!1),f.addEventListener('MSPointerDown',this._onGestureStart,!1),f.addEventListener('MSGestureChange',this._onGesture,!1),d.Tools.RegisterTopRootEvents([{name:'blur',handler:this._onLostFocus}])},e.prototype.detachControl=function(e){this._onLostFocus&&d.Tools.UnregisterTopRootEvents([{name:'blur',handler:this._onLostFocus}]),e&&this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._onContextMenu&&e.removeEventListener('contextmenu',this._onContextMenu),this._onMouseMove&&e.removeEventListener('mousemove',this._onMouseMove),this._onGestureStart&&e.removeEventListener('MSPointerDown',this._onGestureStart),this._onGesture&&e.removeEventListener('MSGestureChange',this._onGesture),this._isPanClick=!1,this.pinchInwards=!0,this._onMouseMove=null,this._onGestureStart=null,this._onGesture=null,this._MSGestureHandler=null,this._onLostFocus=null,this._onContextMenu=null)},e.prototype.getClassName=function(){return'ArcRotateCameraPointersInput'},e.prototype.getSimpleName=function(){return'pointers'},g([d.serialize()],e.prototype,'buttons',void 0),g([d.serialize()],e.prototype,'angularSensibilityX',void 0),g([d.serialize()],e.prototype,'angularSensibilityY',void 0),g([d.serialize()],e.prototype,'pinchPrecision',void 0),g([d.serialize()],e.prototype,'pinchDeltaPercentage',void 0),g([d.serialize()],e.prototype,'panningSensibility',void 0),g([d.serialize()],e.prototype,'multiTouchPanning',void 0),g([d.serialize()],e.prototype,'multiTouchPanAndZoom',void 0),e}();d.ArcRotateCameraPointersInput=e,d.CameraInputTypes.ArcRotateCameraPointersInput=e}(e||(e={}));var e;!function(r){var e=function(o){function e(t){return o.call(this,t)||this}return h(e,o),e.prototype.addMouseWheel=function(){return this.add(new r.ArcRotateCameraMouseWheelInput),this},e.prototype.addPointers=function(){return this.add(new r.ArcRotateCameraPointersInput),this},e.prototype.addKeyboard=function(){return this.add(new r.ArcRotateCameraKeyboardMoveInput),this},e.prototype.addGamepad=function(){return this.add(new r.ArcRotateCameraGamepadInput),this},e.prototype.addVRDeviceOrientation=function(){return this.add(new r.ArcRotateCameraVRDeviceOrientationInput),this},e}(r.CameraInputsManager);r.ArcRotateCameraInputsManager=e}(e||(e={}));var e;!function(d){var e=function(c){function e(e,t,r,n,o,s,a){void 0===a&&(a=!0);var p=c.call(this,e,d.Vector3.Zero(),s,a)||this;return p.inertialAlphaOffset=0,p.inertialBetaOffset=0,p.inertialRadiusOffset=0,p.lowerAlphaLimit=null,p.upperAlphaLimit=null,p.lowerBetaLimit=.01,p.upperBetaLimit=V,p.lowerRadiusLimit=null,p.upperRadiusLimit=null,p.inertialPanningX=0,p.inertialPanningY=0,p.pinchToPanMaxDistance=20,p.panningDistanceLimit=null,p.panningOriginTarget=d.Vector3.Zero(),p.panningInertia=.9,p.zoomOnFactor=1,p.targetScreenOffset=d.Vector2.Zero(),p.allowUpsideDown=!0,p._viewMatrix=new d.Matrix,p.panningAxis=new d.Vector3(1,1,0),p.onMeshTargetChangedObservable=new d.Observable,p.checkCollisions=!1,p.collisionRadius=new d.Vector3(.5,.5,.5),p._previousPosition=d.Vector3.Zero(),p._collisionVelocity=d.Vector3.Zero(),p._newPosition=d.Vector3.Zero(),p._computationVector=d.Vector3.Zero(),p._onCollisionPositionChange=function(e,t,i){void 0===i&&(i=null),p.getScene().workerCollisions&&p.checkCollisions&&t.multiplyInPlace(p._collider._radius),i?(p.setPosition(t),p.onCollide&&p.onCollide(i)):p._previousPosition.copyFrom(p.position);var r=F(p.alpha),n=B(p.alpha),o=F(p.beta),s=B(p.beta);0===s&&(s=1e-4);var a=p._getTargetPosition();p._computationVector.copyFromFloats(p.radius*r*s,p.radius*o,p.radius*n*s),a.addToRef(p._computationVector,p._newPosition),p.position.copyFrom(p._newPosition);var l=p.upVector;p.allowUpsideDown&&0>p.beta&&(l=l.clone(),l=l.negate()),d.Matrix.LookAtLHToRef(p.position,a,l,p._viewMatrix),p._viewMatrix.m[12]+=p.targetScreenOffset.x,p._viewMatrix.m[13]+=p.targetScreenOffset.y,p._collisionTriggered=!1},p._target=d.Vector3.Zero(),o&&p.setTarget(o),p.alpha=t,p.beta=r,p.radius=n,p.getViewMatrix(),p.inputs=new d.ArcRotateCameraInputsManager(p),p.inputs.addKeyboard().addMouseWheel().addPointers(),p}return h(e,c),Object.defineProperty(e.prototype,'target',{get:function(){return this._target},set:function(t){this.setTarget(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'angularSensibilityX',{get:function(){var t=this.inputs.attached.pointers;return t?t.angularSensibilityX:0},set:function(r){var e=this.inputs.attached.pointers;e&&(e.angularSensibilityX=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'angularSensibilityY',{get:function(){var t=this.inputs.attached.pointers;return t?t.angularSensibilityY:0},set:function(r){var e=this.inputs.attached.pointers;e&&(e.angularSensibilityY=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'pinchPrecision',{get:function(){var t=this.inputs.attached.pointers;return t?t.pinchPrecision:0},set:function(r){var e=this.inputs.attached.pointers;e&&(e.pinchPrecision=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'pinchDeltaPercentage',{get:function(){var t=this.inputs.attached.pointers;return t?t.pinchDeltaPercentage:0},set:function(r){var e=this.inputs.attached.pointers;e&&(e.pinchDeltaPercentage=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'panningSensibility',{get:function(){var t=this.inputs.attached.pointers;return t?t.panningSensibility:0},set:function(r){var e=this.inputs.attached.pointers;e&&(e.panningSensibility=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'keysUp',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysUp:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysUp=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'keysDown',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysDown:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysDown=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'keysLeft',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysLeft:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysLeft=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'keysRight',{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRight:[]},set:function(r){var e=this.inputs.attached.keyboard;e&&(e.keysRight=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'wheelPrecision',{get:function(){var t=this.inputs.attached.mousewheel;return t?t.wheelPrecision:0},set:function(r){var e=this.inputs.attached.mousewheel;e&&(e.wheelPrecision=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'wheelDeltaPercentage',{get:function(){var t=this.inputs.attached.mousewheel;return t?t.wheelDeltaPercentage:0},set:function(r){var e=this.inputs.attached.mousewheel;e&&(e.wheelDeltaPercentage=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'bouncingBehavior',{get:function(){return this._bouncingBehavior},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'useBouncingBehavior',{get:function(){return null!=this._bouncingBehavior},set:function(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new d.BouncingBehavior,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'framingBehavior',{get:function(){return this._framingBehavior},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'useFramingBehavior',{get:function(){return null!=this._framingBehavior},set:function(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new d.FramingBehavior,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'autoRotationBehavior',{get:function(){return this._autoRotationBehavior},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'useAutoRotationBehavior',{get:function(){return null!=this._autoRotationBehavior},set:function(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new d.AutoRotationBehavior,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))},enumerable:!0,configurable:!0}),e.prototype._initCache=function(){c.prototype._initCache.call(this),this._cache._target=new d.Vector3(S,S,S),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=d.Vector2.Zero()},e.prototype._updateCache=function(t){t||c.prototype._updateCache.call(this),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)},e.prototype._getTargetPosition=function(){if(this._targetHost&&this._targetHost.getAbsolutePosition){var r=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?r.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(r)}var e=this._getLockedTargetPosition();return e||this._target},e.prototype.storeState=function(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),c.prototype.storeState.call(this)},e.prototype._restoreStateValues=function(){return!!c.prototype._restoreStateValues.call(this)&&(this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.setTarget(this._storedTarget.clone()),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)},e.prototype._isSynchronizedViewMatrix=function(){return!!c.prototype._isSynchronizedViewMatrix.call(this)&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)},e.prototype.attachControl=function(o,e,t,i){var r=this;void 0===t&&(t=!0),void 0===i&&(i=2),this._useCtrlForPanning=t,this._panningMouseButton=i,this.inputs.attachElement(o,e),this._reset=function(){r.inertialAlphaOffset=0,r.inertialBetaOffset=0,r.inertialRadiusOffset=0,r.inertialPanningX=0,r.inertialPanningY=0}},e.prototype.detachControl=function(t){this.inputs.detachElement(t),this._reset&&this._reset()},e.prototype._checkInputs=function(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){var e=this.inertialAlphaOffset;0>=this.beta&&(e*=-1),this.getScene().useRightHandedSystem&&(e*=-1),this.parent&&0>this.parent._getWorldMatrixDeterminant()&&(e*=-1),this.alpha+=e,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,A(this.inertialAlphaOffset)<d.Epsilon&&(this.inertialAlphaOffset=0),A(this.inertialBetaOffset)<d.Epsilon&&(this.inertialBetaOffset=0),A(this.inertialRadiusOffset)<this.speed*d.Epsilon&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){if(this._localDirection||(this._localDirection=d.Vector3.Zero(),this._transformedDirection=d.Vector3.Zero()),this._localDirection.copyFromFloats(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY),this._localDirection.multiplyInPlace(this.panningAxis),this._viewMatrix.invertToRef(this._cameraTransformMatrix),d.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.panningAxis.y||(this._transformedDirection.y=0),!this._targetHost)if(this.panningDistanceLimit){this._transformedDirection.addInPlace(this._target);var t=d.Vector3.DistanceSquared(this._transformedDirection,this.panningOriginTarget);t<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)}else this._target.addInPlace(this._transformedDirection);this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,A(this.inertialPanningX)<this.speed*d.Epsilon&&(this.inertialPanningX=0),A(this.inertialPanningY)<this.speed*d.Epsilon&&(this.inertialPanningY=0)}this._checkLimits(),c.prototype._checkInputs.call(this)}},e.prototype._checkLimits=function(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>V&&(this.beta-=2*V):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-V&&(this.beta+=2*V):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},e.prototype.rebuildAnglesAndRadius=function(){this.position.subtractToRef(this._getTargetPosition(),this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4),this.alpha=T(this._computationVector.x/$(x(this._computationVector.x,2)+x(this._computationVector.z,2))),0>this._computationVector.z&&(this.alpha=2*V-this.alpha),this.beta=T(this._computationVector.y/this.radius),this._checkLimits()},e.prototype.setPosition=function(t){this.position.equals(t)||(this.position.copyFrom(t),this.rebuildAnglesAndRadius())},e.prototype.setTarget=function(o,e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!1),o.getBoundingInfo)this._targetBoundingCenter=e?o.getBoundingInfo().boundingBox.centerWorld.clone():null,this._targetHost=o,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{var a=o,r=this._getTargetPosition();if(r&&!t&&r.equals(a))return;this._targetHost=null,this._target=a,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}this.rebuildAnglesAndRadius()},e.prototype._getViewMatrix=function(){var e=F(this.alpha),t=B(this.alpha),i=F(this.beta),r=B(this.beta);0===r&&(r=1e-4);var a=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),a.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions)this._collider||(this._collider=new d.Collider),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this.position,this._collisionVelocity),this._collisionTriggered=!0,this.getScene().collisionCoordinator.getNewPosition(this.position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId);else{this.position.copyFrom(this._newPosition);var o=this.upVector;this.allowUpsideDown&&0>r&&(o=o.clone(),o=o.negate()),this._computeViewMatrix(this.position,a,o),this._viewMatrix.m[12]+=this.targetScreenOffset.x,this._viewMatrix.m[13]+=this.targetScreenOffset.y}return this._currentTarget=a,this._viewMatrix},e.prototype.zoomOn=function(e,t){void 0===t&&(t=!1),e=e||this.getScene().meshes;var o=d.Mesh.MinMax(e),r=d.Vector3.Distance(o.min,o.max);this.radius=r*this.zoomOnFactor,this.focusOn({min:o.min,max:o.max,distance:r},t)},e.prototype.focusOn=function(e,t){void 0===t&&(t=!1);var i,r;if(void 0===e.min){var a=e||this.getScene().meshes;i=d.Mesh.MinMax(a),r=d.Vector3.Distance(i.min,i.max)}else{var o=e;i=o,r=o.distance}this._target=d.Mesh.Center(i),t||(this.maxZ=2*r)},e.prototype.createRigCamera=function(i,t){var r=0;switch(this.cameraRigMode){case d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case d.Camera.RIG_MODE_VR:r=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:r=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1);}var a=new e(i,this.alpha+r,this.beta,this.radius,this._target,this.getScene());return a._cameraRigParams={},a},e.prototype._updateRigCameras=function(){var e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,e.radius=t.radius=this.radius,this.cameraRigMode){case d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case d.Camera.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;}c.prototype._updateRigCameras.call(this)},e.prototype.dispose=function(){this.inputs.clear(),c.prototype.dispose.call(this)},e.prototype.getClassName=function(){return'ArcRotateCamera'},g([d.serialize()],e.prototype,'alpha',void 0),g([d.serialize()],e.prototype,'beta',void 0),g([d.serialize()],e.prototype,'radius',void 0),g([d.serializeAsVector3('target')],e.prototype,'_target',void 0),g([d.serialize()],e.prototype,'inertialAlphaOffset',void 0),g([d.serialize()],e.prototype,'inertialBetaOffset',void 0),g([d.serialize()],e.prototype,'inertialRadiusOffset',void 0),g([d.serialize()],e.prototype,'lowerAlphaLimit',void 0),g([d.serialize()],e.prototype,'upperAlphaLimit',void 0),g([d.serialize()],e.prototype,'lowerBetaLimit',void 0),g([d.serialize()],e.prototype,'upperBetaLimit',void 0),g([d.serialize()],e.prototype,'lowerRadiusLimit',void 0),g([d.serialize()],e.prototype,'upperRadiusLimit',void 0),g([d.serialize()],e.prototype,'inertialPanningX',void 0),g([d.serialize()],e.prototype,'inertialPanningY',void 0),g([d.serialize()],e.prototype,'pinchToPanMaxDistance',void 0),g([d.serialize()],e.prototype,'panningDistanceLimit',void 0),g([d.serializeAsVector3()],e.prototype,'panningOriginTarget',void 0),g([d.serialize()],e.prototype,'panningInertia',void 0),g([d.serialize()],e.prototype,'zoomOnFactor',void 0),g([d.serialize()],e.prototype,'allowUpsideDown',void 0),e}(d.TargetCamera);d.ArcRotateCamera=e}(e||(e={}));var e;!function(a){var e=function(e){function t(t,s,r){var n=e.call(this,t,r)||this;return n.groundColor=new a.Color3(0,0,0),n.direction=s||a.Vector3.Up(),n}return h(t,e),t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform('vLightData',4),this._uniformBuffer.addUniform('vLightDiffuse',4),this._uniformBuffer.addUniform('vLightSpecular',3),this._uniformBuffer.addUniform('vLightGround',3),this._uniformBuffer.addUniform('shadowsInfo',3),this._uniformBuffer.addUniform('depthValues',2),this._uniformBuffer.create()},t.prototype.getClassName=function(){return'HemisphericLight'},t.prototype.setDirectionToTarget=function(e){return this.direction=a.Vector3.Normalize(e.subtract(a.Vector3.Zero())),this.direction},t.prototype.getShadowGenerator=function(){return null},t.prototype.transferToEffect=function(e,t){var o=a.Vector3.Normalize(this.direction);return this._uniformBuffer.updateFloat4('vLightData',o.x,o.y,o.z,0,t),this._uniformBuffer.updateColor3('vLightGround',this.groundColor.scale(this.intensity),t),this},t.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=a.Matrix.Identity()),this._worldMatrix},t.prototype.getTypeID=function(){return a.Light.LIGHTTYPEID_HEMISPHERICLIGHT},g([a.serializeAsColor3()],t.prototype,'groundColor',void 0),g([a.serializeAsVector3()],t.prototype,'direction',void 0),t}(a.Light);a.HemisphericLight=e}(e||(e={}));var e;!function(r){var e=function(o){function e(){var t=null!==o&&o.apply(this,arguments)||this;return t._needProjectionMatrixCompute=!0,t}return h(e,o),e.prototype._setPosition=function(t){this._position=t},Object.defineProperty(e.prototype,'position',{get:function(){return this._position},set:function(t){this._setPosition(t)},enumerable:!0,configurable:!0}),e.prototype._setDirection=function(t){this._direction=t},Object.defineProperty(e.prototype,'direction',{get:function(){return this._direction},set:function(t){this._setDirection(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'shadowMinZ',{get:function(){return this._shadowMinZ},set:function(t){this._shadowMinZ=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'shadowMaxZ',{get:function(){return this._shadowMaxZ},set:function(t){this._shadowMaxZ=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),e.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix&&(this.transformedPosition||(this.transformedPosition=r.Vector3.Zero()),r.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=r.Vector3.Zero()),r.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0)},e.prototype.getDepthScale=function(){return 50},e.prototype.getShadowDirection=function(){return this.transformedDirection?this.transformedDirection:this.direction},e.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},e.prototype.setDirectionToTarget=function(e){return this.direction=r.Vector3.Normalize(e.subtract(this.position)),this.direction},e.prototype.getRotation=function(){this.direction.normalize();var e=r.Vector3.Cross(this.direction,r.Axis.Y),t=r.Vector3.Cross(e,this.direction);return r.Vector3.RotationFromAxis(e,t,this.direction)},e.prototype.needCube=function(){return!1},e.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},e.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},e.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=r.Matrix.Identity()),r.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},e.prototype.getDepthMinZ=function(t){return void 0===this.shadowMinZ?t.minZ:this.shadowMinZ},e.prototype.getDepthMaxZ=function(t){return void 0===this.shadowMaxZ?t.maxZ:this.shadowMaxZ},e.prototype.setShadowProjectionMatrix=function(r,e,t){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(e,t,r):this._setDefaultShadowProjectionMatrix(r,e,t),this},g([r.serializeAsVector3()],e.prototype,'position',null),g([r.serializeAsVector3()],e.prototype,'direction',null),g([r.serialize()],e.prototype,'shadowMinZ',null),g([r.serialize()],e.prototype,'shadowMaxZ',null),e}(r.Light);r.ShadowLight=e}(e||(e={}));var e;!function(r){var e=function(o){function e(t,e,a){var r=o.call(this,t,a)||this;return r._shadowAngle=V/2,r.position=e,r}return h(e,o),Object.defineProperty(e.prototype,'shadowAngle',{get:function(){return this._shadowAngle},set:function(t){this._shadowAngle=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'direction',{get:function(){return this._direction},set:function(r){var e=this.needCube();this._direction=r,this.needCube()!==e&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'PointLight'},e.prototype.getTypeID=function(){return r.Light.LIGHTTYPEID_POINTLIGHT},e.prototype.needCube=function(){return!this.direction},e.prototype.getShadowDirection=function(e){if(this.direction)return o.prototype.getShadowDirection.call(this,e);return 0===e?new r.Vector3(1,0,0):1===e?new r.Vector3(-1,0,0):2===e?new r.Vector3(0,-1,0):3===e?new r.Vector3(0,1,0):4===e?new r.Vector3(0,0,1):5===e?new r.Vector3(0,0,-1):r.Vector3.Zero()},e.prototype._setDefaultShadowProjectionMatrix=function(e){var t=this.getScene().activeCamera;t&&r.Matrix.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(t),this.getDepthMaxZ(t),e)},e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform('vLightData',4),this._uniformBuffer.addUniform('vLightDiffuse',4),this._uniformBuffer.addUniform('vLightSpecular',3),this._uniformBuffer.addUniform('shadowsInfo',3),this._uniformBuffer.addUniform('depthValues',2),this._uniformBuffer.create()},e.prototype.transferToEffect=function(r,e){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4('vLightData',this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,e),this):(this._uniformBuffer.updateFloat4('vLightData',this.position.x,this.position.y,this.position.z,0,e),this)},g([r.serialize()],e.prototype,'shadowAngle',null),e}(r.ShadowLight);r.PointLight=e}(e||(e={}));var e;!function(d){var e=function(o){function e(a,e,s){var r=o.call(this,a,s)||this;return r._shadowFrustumSize=0,r._shadowOrthoScale=.1,r.autoUpdateExtends=!0,r._orthoLeft=S,r._orthoRight=t,r._orthoTop=t,r._orthoBottom=S,r.position=e.scale(-1),r.direction=e,r}var t=Number.MIN_VALUE;return h(e,o),Object.defineProperty(e.prototype,'shadowFrustumSize',{get:function(){return this._shadowFrustumSize},set:function(t){this._shadowFrustumSize=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'shadowOrthoScale',{get:function(){return this._shadowOrthoScale},set:function(t){this._shadowOrthoScale=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'DirectionalLight'},e.prototype.getTypeID=function(){return d.Light.LIGHTTYPEID_DIRECTIONALLIGHT},e.prototype._setDefaultShadowProjectionMatrix=function(r,e,t){0<this.shadowFrustumSize?this._setDefaultFixedFrustumShadowProjectionMatrix(r,e):this._setDefaultAutoExtendShadowProjectionMatrix(r,e,t)},e.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(e){var t=this.getScene().activeCamera;t&&d.Matrix.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0===this.shadowMinZ?t.minZ:this.shadowMinZ,void 0===this.shadowMaxZ?t.maxZ:this.shadowMaxZ,e)},e.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(e,p,i){var r=this.getScene().activeCamera;if(r){if(this.autoUpdateExtends||this._orthoLeft===S){var n=d.Vector3.Zero();this._orthoLeft=S,this._orthoRight=t,this._orthoTop=t,this._orthoBottom=S;for(var o=0,s;o<i.length;o++)if(s=i[o],s)for(var a=s.getBoundingInfo(),l=a.boundingBox,_=0;_<l.vectorsWorld.length;_++)d.Vector3.TransformCoordinatesToRef(l.vectorsWorld[_],p,n),n.x<this._orthoLeft&&(this._orthoLeft=n.x),n.y<this._orthoBottom&&(this._orthoBottom=n.y),n.x>this._orthoRight&&(this._orthoRight=n.x),n.y>this._orthoTop&&(this._orthoTop=n.y)}var c=this._orthoRight-this._orthoLeft,u=this._orthoTop-this._orthoBottom;d.Matrix.OrthoOffCenterLHToRef(this._orthoLeft-c*this.shadowOrthoScale,this._orthoRight+c*this.shadowOrthoScale,this._orthoBottom-u*this.shadowOrthoScale,this._orthoTop+u*this.shadowOrthoScale,void 0===this.shadowMinZ?r.minZ:this.shadowMinZ,void 0===this.shadowMaxZ?r.maxZ:this.shadowMaxZ,e)}},e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform('vLightData',4),this._uniformBuffer.addUniform('vLightDiffuse',4),this._uniformBuffer.addUniform('vLightSpecular',3),this._uniformBuffer.addUniform('shadowsInfo',3),this._uniformBuffer.addUniform('depthValues',2),this._uniformBuffer.create()},e.prototype.transferToEffect=function(r,e){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4('vLightData',this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,e),this):(this._uniformBuffer.updateFloat4('vLightData',this.direction.x,this.direction.y,this.direction.z,1,e),this)},e.prototype.getDepthMinZ=function(){return 1},e.prototype.getDepthMaxZ=function(){return 1},g([d.serialize()],e.prototype,'shadowFrustumSize',null),g([d.serialize()],e.prototype,'shadowOrthoScale',null),g([d.serialize()],e.prototype,'autoUpdateExtends',void 0),e}(d.ShadowLight);d.DirectionalLight=e}(e||(e={}));var e;!function(d){var e=function(c){function e(e,t,r,n,o,s){var a=c.call(this,e,s)||this;return a._projectionTextureMatrix=d.Matrix.Zero(),a._projectionTextureLightNear=1e-6,a._projectionTextureLightFar=1e3,a._projectionTextureUpDirection=d.Vector3.Up(),a._projectionTextureViewLightDirty=!0,a._projectionTextureProjectionLightDirty=!0,a._projectionTextureDirty=!0,a._projectionTextureViewTargetVector=d.Vector3.Zero(),a._projectionTextureViewLightMatrix=d.Matrix.Zero(),a._projectionTextureProjectionLightMatrix=d.Matrix.Zero(),a._projectionTextureScalingMatrix=d.Matrix.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),a.position=t,a.direction=r,a.angle=n,a.exponent=o,a}return h(e,c),Object.defineProperty(e.prototype,'angle',{get:function(){return this._angle},set:function(t){this._angle=t,this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'shadowAngleScale',{get:function(){return this._shadowAngleScale},set:function(t){this._shadowAngleScale=t,this.forceProjectionMatrixCompute()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'projectionTextureMatrix',{get:function(){return this._projectionTextureMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'projectionTextureLightNear',{get:function(){return this._projectionTextureLightNear},set:function(t){this._projectionTextureLightNear=t,this._projectionTextureProjectionLightDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'projectionTextureLightFar',{get:function(){return this._projectionTextureLightFar},set:function(t){this._projectionTextureLightFar=t,this._projectionTextureProjectionLightDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'projectionTextureUpDirection',{get:function(){return this._projectionTextureUpDirection},set:function(t){this._projectionTextureUpDirection=t,this._projectionTextureProjectionLightDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'projectionTexture',{get:function(){return this._projectionTexture},set:function(t){this._projectionTexture=t,this._projectionTextureDirty=!0},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'SpotLight'},e.prototype.getTypeID=function(){return d.Light.LIGHTTYPEID_SPOTLIGHT},e.prototype._setDirection=function(t){c.prototype._setDirection.call(this,t),this._projectionTextureViewLightDirty=!0},e.prototype._setPosition=function(t){c.prototype._setPosition.call(this,t),this._projectionTextureViewLightDirty=!0},e.prototype._setDefaultShadowProjectionMatrix=function(e){var t=this.getScene().activeCamera;if(t){this._shadowAngleScale=this._shadowAngleScale||1;var r=this._shadowAngleScale*this._angle;d.Matrix.PerspectiveFovLHToRef(r,1,this.getDepthMinZ(t),this.getDepthMaxZ(t),e)}},e.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),d.Matrix.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)},e.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;var e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),a=1/y(this._angle/2);d.Matrix.FromValuesToRef(a/1,0,0,0,0,a,0,0,0,0,i,1,0,0,-i*t,0,this._projectionTextureProjectionLightMatrix)},e.prototype._computeProjectionTextureMatrix=function(){this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)},e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform('vLightData',4),this._uniformBuffer.addUniform('vLightDiffuse',4),this._uniformBuffer.addUniform('vLightSpecular',3),this._uniformBuffer.addUniform('vLightDirection',3),this._uniformBuffer.addUniform('shadowsInfo',3),this._uniformBuffer.addUniform('depthValues',2),this._uniformBuffer.create()},e.prototype.transferToEffect=function(e,t){var o;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4('vLightData',this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),o=d.Vector3.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4('vLightData',this.position.x,this.position.y,this.position.z,this.exponent,t),o=d.Vector3.Normalize(this.direction)),this._uniformBuffer.updateFloat4('vLightDirection',o.x,o.y,o.z,F(.5*this.angle),t),this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix('textureProjectionMatrix'+t,this._projectionTextureMatrix),e.setTexture('projectionLightSampler'+t,this.projectionTexture)),this},e.prototype.dispose=function(){c.prototype.dispose.call(this),this._projectionTexture&&this._projectionTexture.dispose()},g([d.serialize()],e.prototype,'angle',null),g([d.serialize()],e.prototype,'shadowAngleScale',null),g([d.serialize()],e.prototype,'exponent',void 0),g([d.serialize()],e.prototype,'projectionTextureLightNear',null),g([d.serialize()],e.prototype,'projectionTextureLightFar',null),g([d.serialize()],e.prototype,'projectionTextureUpDirection',null),g([d.serializeAsTexture('projectedLightTexture')],e.prototype,'_projectionTexture',void 0),e}(d.ShadowLight);d.SpotLight=e}(e||(e={}));var e;!function(r){var e=function(){return function(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=r.Animation.ANIMATIONLOOPMODE_CYCLE}}();r.AnimationPropertiesOverride=e}(e||(e={}));var e;!function(d){var a=function(){function t(r,o,t){this.name=r,this.from=o,this.to=t}return t.prototype.clone=function(){return new t(this.name,this.from,this.to)},t}();d.AnimationRange=a;var e=function(){function t(r,o,t){this.frame=r,this.action=o,this.onlyOnce=t,this.isDone=!1}return t}();d.AnimationEvent=e;var t=function(){function e(t){this.path=t,this._onchange=[],this.value=0,this.animations=[]}return e.prototype.getPoint=function(){var e=this.path.getPointAtLengthPosition(this.value);return new d.Vector3(e.x,0,e.y)},e.prototype.moveAhead=function(t){return void 0===t&&(t=.002),this.move(t),this},e.prototype.moveBack=function(t){return void 0===t&&(t=.002),this.move(-t),this},e.prototype.move=function(t){if(1<A(t))throw'step size should be less than 1.';return this.value+=t,this.ensureLimits(),this.raiseOnChange(),this},e.prototype.ensureLimits=function(){for(;1<this.value;)this.value-=1;for(;0>this.value;)this.value+=1;return this},e.prototype.raiseOnChange=function(){var r=this;return this._onchange.forEach(function(e){return e(r)}),this},e.prototype.onchange=function(t){return this._onchange.push(t),this},e}();d.PathCursor=t;var h;!function(t){t[t.STEP=1]='STEP'}(h=d.AnimationKeyInterpolation||(d.AnimationKeyInterpolation={}));var r=function(){function E(i,e,t,r,a,o){this.name=i,this.targetProperty=e,this.framePerSecond=t,this.dataType=r,this.loopMode=a,this.enableBlending=o,this._runtimeAnimations=[],this._events=[],this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=e.split('.'),this.dataType=r,this.loopMode=void 0===a?E.ANIMATIONLOOPMODE_CYCLE:a}return E._PrepareAnimation=function(e,t,r,i,n,p,f,l){var _;if(!isNaN(parseFloat(n))&&isFinite(n)?_=E.ANIMATIONTYPE_FLOAT:n instanceof d.Quaternion?_=E.ANIMATIONTYPE_QUATERNION:n instanceof d.Vector3?_=E.ANIMATIONTYPE_VECTOR3:n instanceof d.Vector2?_=E.ANIMATIONTYPE_VECTOR2:n instanceof d.Color3?_=E.ANIMATIONTYPE_COLOR3:n instanceof d.Size&&(_=E.ANIMATIONTYPE_SIZE),void 0==_)return null;var c=new E(e,t,r,_,f);return c.setKeys([{frame:0,value:n},{frame:i,value:p}]),void 0!==l&&c.setEasingFunction(l),c},E.CreateAnimation=function(i,e,t,r){var a=new E(i+'Animation',i,t,e,E.ANIMATIONLOOPMODE_CONSTANT);return a.setEasingFunction(r),a},E.CreateAndStartAnimation=function(i,e,t,r,n,o,s,a,l,d){var c=E._PrepareAnimation(i,t,r,n,o,s,a,l);return c?e.getScene().beginDirectAnimation(e,[c],0,n,1===c.loopMode,1,d):null},E.CreateAndStartHierarchyAnimation=function(i,e,t,r,n,o,s,a,l,d,c){var p=E._PrepareAnimation(i,r,n,o,s,a,l,d);return p?e.getScene().beginDirectHierarchyAnimation(e,t,[p],0,o,1===p.loopMode,1,c):null},E.CreateMergeAndStartAnimation=function(i,e,t,r,n,o,s,a,l,d){var c=E._PrepareAnimation(i,t,r,n,o,s,a,l);return c?(e.animations.push(c),e.getScene().beginAnimation(e,0,n,1===c.loopMode,1,d)):null},E.TransitionTo=function(d,e,c,i,r,n,o,s){if(void 0===s&&(s=null),0>=o)return c[d]=e,s&&s(),null;var a=r*(o/1e3);n.setKeys([{frame:0,value:c[d].clone?c[d].clone():c[d]},{frame:a,value:e}]),c.animations||(c.animations=[]),c.animations.push(n);var p=i.beginAnimation(c,0,a,!1);return p.onAnimationEnd=s,p},Object.defineProperty(E.prototype,'runtimeAnimations',{get:function(){return this._runtimeAnimations},enumerable:!0,configurable:!0}),Object.defineProperty(E.prototype,'hasRunningRuntimeAnimations',{get:function(){for(var r=0,e=this._runtimeAnimations;r<e.length;r++)if(!e[r].isStopped)return!0;return!1},enumerable:!0,configurable:!0}),E.prototype.toString=function(o){var e='Name: '+this.name+', property: '+this.targetProperty;if(e+=', datatype: '+['Float','Vector3','Quaternion','Matrix','Color3','Vector2'][this.dataType],e+=', nKeys: '+(this._keys?this._keys.length:'none'),e+=', nRanges: '+(this._ranges?Object.keys(this._ranges).length:'none'),o){e+=', Ranges: {';var t=!0;for(var i in this._ranges)t&&(e+=', ',t=!1),e+=i;e+='}'}return e},E.prototype.addEvent=function(t){this._events.push(t)},E.prototype.removeEvents=function(r){for(var e=0;e<this._events.length;e++)this._events[e].frame===r&&(this._events.splice(e,1),e--)},E.prototype.getEvents=function(){return this._events},E.prototype.createRange=function(t,e,o){this._ranges[t]||(this._ranges[t]=new a(t,e,o))},E.prototype.deleteRange=function(a,e){void 0===e&&(e=!0);var t=this._ranges[a];if(t){if(e)for(var i=t.from,r=t.to,n=this._keys.length-1;0<=n;n--)this._keys[n].frame>=i&&this._keys[n].frame<=r&&this._keys.splice(n,1);this._ranges[a]=null}},E.prototype.getRange=function(t){return this._ranges[t]},E.prototype.getKeys=function(){return this._keys},E.prototype.getHighestFrame=function(){for(var r=0,e=0,t=this._keys.length;e<t;e++)r<this._keys[e].frame&&(r=this._keys[e].frame);return r},E.prototype.getEasingFunction=function(){return this._easingFunction},E.prototype.setEasingFunction=function(t){this._easingFunction=t},E.prototype.floatInterpolateFunction=function(e,t,o){return d.Scalar.Lerp(e,t,o)},E.prototype.floatInterpolateFunctionWithTangents=function(e,t,i,r,a){return d.Scalar.Hermite(e,t,i,r,a)},E.prototype.quaternionInterpolateFunction=function(e,t,o){return d.Quaternion.Slerp(e,t,o)},E.prototype.quaternionInterpolateFunctionWithTangents=function(e,t,i,r,a){return d.Quaternion.Hermite(e,t,i,r,a).normalize()},E.prototype.vector3InterpolateFunction=function(e,t,o){return d.Vector3.Lerp(e,t,o)},E.prototype.vector3InterpolateFunctionWithTangents=function(e,t,i,r,a){return d.Vector3.Hermite(e,t,i,r,a)},E.prototype.vector2InterpolateFunction=function(e,t,o){return d.Vector2.Lerp(e,t,o)},E.prototype.vector2InterpolateFunctionWithTangents=function(e,t,i,r,a){return d.Vector2.Hermite(e,t,i,r,a)},E.prototype.sizeInterpolateFunction=function(e,t,o){return d.Size.Lerp(e,t,o)},E.prototype.color3InterpolateFunction=function(e,t,o){return d.Color3.Lerp(e,t,o)},E.prototype._getKeyValue=function(t){return'function'==typeof t?t():t},E.prototype._interpolate=function(i,e,t,r,o,n){if(r===E.ANIMATIONLOOPMODE_CONSTANT&&0<e)return n.clone?n.clone():n;var a=this.getKeys(),s=W(0,C(a.length-1,ee(a.length*(i-a[0].frame)/(a[a.length-1].frame-a[0].frame))-1));if(a[s].frame>=i)for(;0<=s-1&&a[s].frame>=i;)s--;for(var l=s,c;l<a.length;l++)if(c=a[l+1],c.frame>=i){var u=a[l],f=this._getKeyValue(u.value);if(u.interpolation===h.STEP)return f;var d=this._getKeyValue(c.value),p=void 0!==u.outTangent&&void 0!==c.inTangent,_=c.frame-u.frame,m=(i-u.frame)/_,g=this.getEasingFunction();switch(null!=g&&(m=g.ease(m)),this.dataType){case E.ANIMATIONTYPE_FLOAT:var v=p?this.floatInterpolateFunctionWithTangents(f,u.outTangent*_,d,c.inTangent*_,m):this.floatInterpolateFunction(f,d,m);switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:return v;case E.ANIMATIONLOOPMODE_RELATIVE:return o*e+v;}break;case E.ANIMATIONTYPE_QUATERNION:var y=p?this.quaternionInterpolateFunctionWithTangents(f,u.outTangent.scale(_),d,c.inTangent.scale(_),m):this.quaternionInterpolateFunction(f,d,m);return r===E.ANIMATIONLOOPMODE_CYCLE||r===E.ANIMATIONLOOPMODE_CONSTANT?y:r===E.ANIMATIONLOOPMODE_RELATIVE?y.addInPlace(o.scale(e)):y;case E.ANIMATIONTYPE_VECTOR3:var b=p?this.vector3InterpolateFunctionWithTangents(f,u.outTangent.scale(_),d,c.inTangent.scale(_),m):this.vector3InterpolateFunction(f,d,m);switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:return b;case E.ANIMATIONLOOPMODE_RELATIVE:return b.add(o.scale(e));}case E.ANIMATIONTYPE_VECTOR2:var x=p?this.vector2InterpolateFunctionWithTangents(f,u.outTangent.scale(_),d,c.inTangent.scale(_),m):this.vector2InterpolateFunction(f,d,m);switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:return x;case E.ANIMATIONLOOPMODE_RELATIVE:return x.add(o.scale(e));}case E.ANIMATIONTYPE_SIZE:switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(f,d,m);case E.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(f,d,m).add(o.scale(e));}case E.ANIMATIONTYPE_COLOR3:switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:return this.color3InterpolateFunction(f,d,m);case E.ANIMATIONLOOPMODE_RELATIVE:return this.color3InterpolateFunction(f,d,m).add(o.scale(e));}case E.ANIMATIONTYPE_MATRIX:switch(r){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:if(E.AllowMatricesInterpolation)return this.matrixInterpolateFunction(f,d,m,t);case E.ANIMATIONLOOPMODE_RELATIVE:return f;}}break}return this._getKeyValue(a[a.length-1].value)},E.prototype.matrixInterpolateFunction=function(e,t,r,i){return E.AllowMatrixDecomposeForInterpolation?i?(d.Matrix.DecomposeLerpToRef(e,t,r,i),i):d.Matrix.DecomposeLerp(e,t,r):i?(d.Matrix.LerpToRef(e,t,r,i),i):d.Matrix.Lerp(e,t,r)},E.prototype.clone=function(){var o=new E(this.name,this.targetPropertyPath.join('.'),this.framePerSecond,this.dataType,this.loopMode);if(o.enableBlending=this.enableBlending,o.blendingSpeed=this.blendingSpeed,this._keys&&o.setKeys(this._keys),this._ranges)for(var e in o._ranges={},this._ranges){var t=this._ranges[e];t&&(o._ranges[e]=t.clone())}return o},E.prototype.setKeys=function(t){this._keys=t.slice(0)},E.prototype.serialize=function(){var i={name:this.name,property:this.targetProperty,framePerSecond:this.framePerSecond,dataType:this.dataType,loopBehavior:this.loopMode,enableBlending:this.enableBlending,blendingSpeed:this.blendingSpeed},e=this.dataType;i.keys=[];for(var t=this.getKeys(),r=0;r<t.length;r++){var n=t[r],o={};switch(o.frame=n.frame,e){case E.ANIMATIONTYPE_FLOAT:o.values=[n.value];break;case E.ANIMATIONTYPE_QUATERNION:case E.ANIMATIONTYPE_MATRIX:case E.ANIMATIONTYPE_VECTOR3:case E.ANIMATIONTYPE_COLOR3:o.values=n.value.asArray();}i.keys.push(o)}for(var s in i.ranges=[],this._ranges){var a=this._ranges[s];if(a){var l={};l.name=s,l.from=a.from,l.to=a.to,i.ranges.push(l)}}return i},Object.defineProperty(E,'ANIMATIONTYPE_FLOAT',{get:function(){return E._ANIMATIONTYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_VECTOR3',{get:function(){return E._ANIMATIONTYPE_VECTOR3},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_VECTOR2',{get:function(){return E._ANIMATIONTYPE_VECTOR2},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_SIZE',{get:function(){return E._ANIMATIONTYPE_SIZE},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_QUATERNION',{get:function(){return E._ANIMATIONTYPE_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_MATRIX',{get:function(){return E._ANIMATIONTYPE_MATRIX},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONTYPE_COLOR3',{get:function(){return E._ANIMATIONTYPE_COLOR3},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONLOOPMODE_RELATIVE',{get:function(){return E._ANIMATIONLOOPMODE_RELATIVE},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONLOOPMODE_CYCLE',{get:function(){return E._ANIMATIONLOOPMODE_CYCLE},enumerable:!0,configurable:!0}),Object.defineProperty(E,'ANIMATIONLOOPMODE_CONSTANT',{get:function(){return E._ANIMATIONLOOPMODE_CONSTANT},enumerable:!0,configurable:!0}),E._UniversalLerp=function(o,e,t){var i=o.constructor;return i.Lerp?i.Lerp(o,e,t):i.Slerp?i.Slerp(o,e,t):o.toFixed?o*(1-t)+t*e:e},E.Parse=function(e){var t=new E(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),o=e.dataType,i=[],a,r;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),r=0;r<e.keys.length;r++){var n=e.keys[r],s,l;switch(o){case E.ANIMATIONTYPE_FLOAT:a=n.values[0],1<=n.values.length&&(s=n.values[1]),2<=n.values.length&&(l=n.values[2]);break;case E.ANIMATIONTYPE_QUATERNION:if(a=d.Quaternion.FromArray(n.values),8<=n.values.length){var c=d.Quaternion.FromArray(n.values.slice(4,8));c.equals(d.Quaternion.Zero())||(s=c)}if(12<=n.values.length){var p=d.Quaternion.FromArray(n.values.slice(8,12));p.equals(d.Quaternion.Zero())||(l=p)}break;case E.ANIMATIONTYPE_MATRIX:a=d.Matrix.FromArray(n.values);break;case E.ANIMATIONTYPE_COLOR3:a=d.Color3.FromArray(n.values);break;case E.ANIMATIONTYPE_VECTOR3:default:a=d.Vector3.FromArray(n.values);}var u={};u.frame=n.frame,u.value=a,void 0!=s&&(u.inTangent=s),void 0!=l&&(u.outTangent=l),i.push(u)}if(t.setKeys(i),e.ranges)for(r=0;r<e.ranges.length;r++)a=e.ranges[r],t.createRange(a.name,a.from,a.to);return t},E.AppendSerializedAnimations=function(o,e){if(o.animations){e.animations=[];for(var t=0,i;t<o.animations.length;t++)i=o.animations[t],e.animations.push(i.serialize())}},E.AllowMatricesInterpolation=!1,E.AllowMatrixDecomposeForInterpolation=!0,E._ANIMATIONTYPE_FLOAT=0,E._ANIMATIONTYPE_VECTOR3=1,E._ANIMATIONTYPE_QUATERNION=2,E._ANIMATIONTYPE_MATRIX=3,E._ANIMATIONTYPE_COLOR3=4,E._ANIMATIONTYPE_VECTOR2=5,E._ANIMATIONTYPE_SIZE=6,E._ANIMATIONLOOPMODE_RELATIVE=0,E._ANIMATIONLOOPMODE_CYCLE=1,E._ANIMATIONLOOPMODE_CONSTANT=2,E}();d.Animation=r}(e||(e={}));var e;!function(r){var e=function(){return function(){}}();r.TargetedAnimation=e;var t=function(){function e(e,o){void 0===o&&(o=null),this.name=e,this._targetedAnimations=[],this._animatables=[],this._from=S,this._to=-S,this._speedRatio=1,this.onAnimationEndObservable=new r.Observable,this._scene=o||r.Engine.LastCreatedScene,this._scene.animationGroups.push(this)}return Object.defineProperty(e.prototype,'from',{get:function(){return this._from},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'to',{get:function(){return this._to},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isStarted',{get:function(){return this._isStarted},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'speedRatio',{get:function(){return this._speedRatio},set:function(r){if(this._speedRatio!==r){this._speedRatio=r;for(var e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'targetedAnimations',{get:function(){return this._targetedAnimations},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'animatables',{get:function(){return this._animatables},enumerable:!0,configurable:!0}),e.prototype.addTargetedAnimation=function(o,a){var n={animation:o,target:a},i=o.getKeys();return this._from>i[0].frame&&(this._from=i[0].frame),this._to<i[i.length-1].frame&&(this._to=i[i.length-1].frame),this._targetedAnimations.push(n),n},e.prototype.normalize=function(l,d){void 0===l&&(l=null),void 0===d&&(d=null),null==l&&(l=this._from),null==d&&(d=this._to);for(var c=0;c<this._targetedAnimations.length;c++){var i=this._targetedAnimations[c],r=i.animation.getKeys(),n=r[0],o=r[r.length-1];if(n.frame>l){var s={frame:l,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};r.splice(0,0,s)}if(o.frame<d){var s={frame:d,value:o.value,inTangent:o.outTangent,outTangent:o.outTangent,interpolation:o.interpolation};r.push(s)}}return this._from=l,this._to=d,this},e.prototype.start=function(d,e,t,i){var r=this;if(void 0===d&&(d=!1),void 0===e&&(e=1),this._isStarted||0===this._targetedAnimations.length)return this;for(var n=this,o=0,s=this._targetedAnimations,a;o<s.length;o++)a=s[o],!function(o){n._animatables.push(n._scene.beginDirectAnimation(o.target,[o.animation],void 0===t?n._from:t,void 0===i?n._to:i,d,e,function(){r.onAnimationEndObservable.notifyObservers(o)}))}(a);return this._speedRatio=e,this._isStarted=!0,this},e.prototype.pause=function(){if(!this._isStarted)return this;for(var t=0;t<this._animatables.length;t++)this._animatables[t].pause();return this},e.prototype.play=function(r){if(this.isStarted){if(void 0!==r)for(var e=0,t;e<this._animatables.length;e++)t=this._animatables[e],t.loopAnimation=r;this.restart()}else this.start(r,this._speedRatio);return this},e.prototype.reset=function(){if(!this._isStarted)return this;for(var t=0;t<this._animatables.length;t++)this._animatables[t].reset();return this},e.prototype.restart=function(){if(!this._isStarted)return this;for(var t=0;t<this._animatables.length;t++)this._animatables[t].restart();return this},e.prototype.stop=function(){if(!this._isStarted)return this;for(var t=0;t<this._animatables.length;t++)this._animatables[t].stop();return this._isStarted=!1,this},e.prototype.setWeightForAllAnimatables=function(r){for(var e=0;e<this._animatables.length;e++)this._animatables[e].weight=r;return this},e.prototype.syncAllAnimationsWith=function(r){for(var e=0;e<this._animatables.length;e++)this._animatables[e].syncWith(r);return this},e.prototype.goToFrame=function(r){if(!this._isStarted)return this;for(var e=0;e<this._animatables.length;e++)this._animatables[e].goToFrame(r);return this},e.prototype.dispose=function(){this._targetedAnimations=[],this._animatables=[];var t=this._scene.animationGroups.indexOf(this);-1<t&&this._scene.animationGroups.splice(t,1)},e}();r.AnimationGroup=t}(e||(e={}));var e;!function(v){var e=function(){function e(o,e,a,i){this._currentFrame=0,this._originalValue=[],this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._targetPath='',this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._animation=e,this._target=o,this._scene=a,this._host=i,e._runtimeAnimations.push(this)}return Object.defineProperty(e.prototype,'currentFrame',{get:function(){return this._currentFrame},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'weight',{get:function(){return this._weight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'currentValue',{get:function(){return this._currentValue},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'targetPath',{get:function(){return this._targetPath},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'target',{get:function(){return this._activeTarget},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'animation',{get:function(){return this._animation},enumerable:!0,configurable:!0}),e.prototype.reset=function(o){if(void 0===o&&(o=!1),o)if(this._target instanceof Array)for(var e=0,t=0,i=this._target,r;t<i.length;t++)r=i[t],void 0!==this._originalValue[e]&&this._setValue(r,this._originalValue[e],-1),e++;else void 0!==this._originalValue[0]&&this._setValue(this._target,this._originalValue[0],-1);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0,this._originalValue=[]},e.prototype.isStopped=function(){return this._stopped},e.prototype.dispose=function(){var t=this._animation.runtimeAnimations.indexOf(this);-1<t&&this._animation.runtimeAnimations.splice(t,1)},e.prototype._interpolate=function(e,t,i,r,a){return this._currentFrame=e,this._animation.dataType!==v.Animation.ANIMATIONTYPE_MATRIX||this._workValue||(this._workValue=v.Matrix.Zero()),this._animation._interpolate(e,t,this._workValue,i,r,a)},e.prototype.setValue=function(a,e){if(void 0===e&&(e=1),this._target instanceof Array)for(var t=0,i=0,r=this._target,n;i<r.length;i++)n=r[i],this._setValue(n,a,e,t),t++;else this._setValue(this._target,a,e)},e.prototype._setValue=function(e,t,i,r){void 0===r&&(r=0);var n=this._animation.targetPropertyPath,a,o;if(1<n.length){for(var s=e[n[0]],l=1;l<n.length-1;l++)s=s[n[l]];a=n[n.length-1],o=s}else a=n[0],o=e;if(this._targetPath=a,this._activeTarget=o,this._weight=i,void 0===this._originalValue[r]){var d;d=o.getRestPose&&'_matrix'===a?o.getRestPose():o[a],this._originalValue[r]=d&&d.clone?d.clone():d}if((e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending)&&1>=this._blendingFactor){if(!this._originalBlendValue){var d=o[a];this._originalBlendValue=d.clone?d.clone():d}this._originalBlendValue.m?v.Animation.AllowMatrixDecomposeForInterpolation?this._currentValue?v.Matrix.DecomposeLerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=v.Matrix.DecomposeLerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue?v.Matrix.LerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=v.Matrix.Lerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue=v.Animation._UniversalLerp(this._originalBlendValue,t,this._blendingFactor);var c=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=c}else this._currentValue=t;-1===i?o[a]=this._currentValue:this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]),e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)},e.prototype._getCorrectLoopMode=function(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode},e.prototype.goToFrame=function(r){var e=this._animation.getKeys();r<e[0].frame?r=e[0].frame:r>e[e.length-1].frame&&(r=e[e.length-1].frame);var t=this._interpolate(r,0,this._getCorrectLoopMode());this.setValue(t,-1)},e.prototype._prepareForSpeedRatioChange=function(r){var e=this._previousDelay*(this._animation.framePerSecond*r)/1e3;this._ratioOffset=this._previousRatio-e},e.prototype.animate=function(e,t,i,r,A,o){void 0===o&&(o=-1);var s=this._animation.targetPropertyPath;if(!s||1>s.length)return this._stopped=!0,!1;var S=!0,l=this._animation.getKeys();if(0!==l[0].frame){var h={frame:0,value:l[0].value};l.splice(0,0,h)}(t<l[0].frame||t>l[l.length-1].frame)&&(t=l[0].frame),(i<l[0].frame||i>l[l.length-1].frame)&&(i=l[l.length-1].frame),t===i&&(t>l[0].frame?t--:i<l[l.length-1].frame&&i++);var c=i-t,f=e*(this._animation.framePerSecond*A)/1e3+this._ratioOffset,d=0,p;if(this._previousDelay=e,this._previousRatio=f,(i>t&&f>c||t>i&&f<c)&&!r)S=!1,d=this._animation._getKeyValue(l[l.length-1].value);else if(this._getCorrectLoopMode()!==v.Animation.ANIMATIONLOOPMODE_CYCLE){var u=i.toString()+t.toString();if(!this._offsetsCache[u]){var _=this._interpolate(t,0,v.Animation.ANIMATIONLOOPMODE_CYCLE),m=this._interpolate(i,0,v.Animation.ANIMATIONLOOPMODE_CYCLE);switch(this._animation.dataType){case v.Animation.ANIMATIONTYPE_FLOAT:this._offsetsCache[u]=m-_;break;case v.Animation.ANIMATIONTYPE_QUATERNION:this._offsetsCache[u]=m.subtract(_);break;case v.Animation.ANIMATIONTYPE_VECTOR3:this._offsetsCache[u]=m.subtract(_);case v.Animation.ANIMATIONTYPE_VECTOR2:this._offsetsCache[u]=m.subtract(_);case v.Animation.ANIMATIONTYPE_SIZE:this._offsetsCache[u]=m.subtract(_);case v.Animation.ANIMATIONTYPE_COLOR3:this._offsetsCache[u]=m.subtract(_);}this._highLimitsCache[u]=m}d=this._highLimitsCache[u],p=this._offsetsCache[u]}if(void 0===p)switch(this._animation.dataType){case v.Animation.ANIMATIONTYPE_FLOAT:p=0;break;case v.Animation.ANIMATIONTYPE_QUATERNION:p=new v.Quaternion(0,0,0,0);break;case v.Animation.ANIMATIONTYPE_VECTOR3:p=v.Vector3.Zero();break;case v.Animation.ANIMATIONTYPE_VECTOR2:p=v.Vector2.Zero();break;case v.Animation.ANIMATIONTYPE_SIZE:p=v.Size.Zero();break;case v.Animation.ANIMATIONTYPE_COLOR3:p=v.Color3.Black();}var g=S?t+f%c:i;if(this._host&&this._host.syncRoot){var y=this._host.syncRoot;g=t+(i-t)*((y.masterFrame-y.fromFrame)/(y.toFrame-y.fromFrame))}var b=this._interpolate(g,f/c>>0,this._getCorrectLoopMode(),p,d);this.setValue(b,o);for(var x=this._animation.getEvents(),T=0;T<x.length;T++)if(0<c&&g>=x[T].frame&&x[T].frame>=t||0>c&&g<=x[T].frame&&x[T].frame<=t){var E=x[T];E.isDone||(E.onlyOnce&&(x.splice(T,1),T--),E.isDone=!0,E.action())}else x[T].isDone&&!x[T].onlyOnce&&(x[T].isDone=!1);return S||(this._stopped=!0),S},e}();v.RuntimeAnimation=e}(e||(e={}));var e;!function(o){var e=function(){function e(l,e,d,i,r,n,o,s){void 0===d&&(d=0),void 0===i&&(i=100),void 0===r&&(r=!1),void 0===n&&(n=1),this.target=e,this.fromFrame=d,this.toFrame=i,this.loopAnimation=r,this.onAnimationEnd=o,this._localDelayOffset=null,this._pausedDelay=null,this._runtimeAnimations=[],this._paused=!1,this._speedRatio=1,this._weight=-1,this.animationStarted=!1,this._scene=l,s&&this.appendAnimations(e,s),this._speedRatio=n,l._activeAnimatables.push(this)}return Object.defineProperty(e.prototype,'syncRoot',{get:function(){return this._syncRoot},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'masterFrame',{get:function(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'weight',{get:function(){return this._weight},set:function(t){return-1===t?void(this._weight=-1):void(this._weight=C(W(t,0),1))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'speedRatio',{get:function(){return this._speedRatio},set:function(r){for(var e=0;e<this._runtimeAnimations.length;e++)this._runtimeAnimations[e]._prepareForSpeedRatioChange(r);this._speedRatio=r},enumerable:!0,configurable:!0}),e.prototype.syncWith=function(r){if(this._syncRoot=r,r){var e=this._scene._activeAnimatables.indexOf(this);-1<e&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this},e.prototype.getAnimations=function(){return this._runtimeAnimations},e.prototype.appendAnimations=function(e,t){for(var i=0,r;i<t.length;i++)r=t[i],this._runtimeAnimations.push(new o.RuntimeAnimation(e,r,this._scene,this))},e.prototype.getAnimationByTargetProperty=function(r){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)if(e[t].animation.targetProperty===r)return e[t].animation;return null},e.prototype.getRuntimeAnimationByTargetProperty=function(r){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)if(e[t].animation.targetProperty===r)return e[t];return null},e.prototype.reset=function(){for(var r=this._runtimeAnimations,e=0;e<r.length;e++)r[e].reset(!0);this._localDelayOffset=null,this._pausedDelay=null},e.prototype.enableBlending=function(r){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)e[t].animation.enableBlending=!0,e[t].animation.blendingSpeed=r},e.prototype.disableBlending=function(){for(var r=this._runtimeAnimations,e=0;e<r.length;e++)r[e].animation.enableBlending=!1},e.prototype.goToFrame=function(a){var e=this._runtimeAnimations;if(e[0]){var t=e[0].animation.framePerSecond,i=e[0].currentFrame,r=1e3*(a-i)/(t*this.speedRatio);null===this._localDelayOffset&&(this._localDelayOffset=0),this._localDelayOffset-=r}for(var o=0;o<e.length;o++)e[o].goToFrame(a)},e.prototype.pause=function(){this._paused||(this._paused=!0)},e.prototype.restart=function(){this._paused=!1},e.prototype.stop=function(o){if(o){var a=this._scene._activeAnimatables.indexOf(this);if(-1<a){for(var t=this._runtimeAnimations,i=t.length-1;0<=i;i--)'string'==typeof o&&t[i].animation.name!=o||(t[i].dispose(),t.splice(i,1));0==t.length&&(this._scene._activeAnimatables.splice(a,1),this.onAnimationEnd&&this.onAnimationEnd())}}else{var i=this._scene._activeAnimatables.indexOf(this);if(-1<i){this._scene._activeAnimatables.splice(i,1);for(var t=this._runtimeAnimations,i=0;i<t.length;i++)t[i].dispose();this.onAnimationEnd&&this.onAnimationEnd()}}},e.prototype._animate=function(a){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=a),!0;if(null===this._localDelayOffset?(this._localDelayOffset=a,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=a-this._pausedDelay,this._pausedDelay=null),0===this._weight)return!0;var e=!1,s=this._runtimeAnimations,r;for(r=0;r<s.length;r++){var t=s[r],n=t.animate(a-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);e=e||n}if(this.animationStarted=e,!e)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<s.length;r++)s[r].dispose();return!e&&this.onAnimationEnd&&(this.onAnimationEnd(),this.onAnimationEnd=null),e},e}();o.Animatable=e}(e||(e={}));var e;!function(o){var e=function(){function r(){this._easingMode=r.EASINGMODE_EASEIN}return Object.defineProperty(r,'EASINGMODE_EASEIN',{get:function(){return r._EASINGMODE_EASEIN},enumerable:!0,configurable:!0}),Object.defineProperty(r,'EASINGMODE_EASEOUT',{get:function(){return r._EASINGMODE_EASEOUT},enumerable:!0,configurable:!0}),Object.defineProperty(r,'EASINGMODE_EASEINOUT',{get:function(){return r._EASINGMODE_EASEINOUT},enumerable:!0,configurable:!0}),r.prototype.setEasingMode=function(r){var e=C(W(r,0),2);this._easingMode=e},r.prototype.getEasingMode=function(){return this._easingMode},r.prototype.easeInCore=function(){throw new Error('You must implement this method')},r.prototype.ease=function(e){switch(this._easingMode){case r.EASINGMODE_EASEIN:return this.easeInCore(e);case r.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e);}return .5<=e?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)},r._EASINGMODE_EASEIN=0,r._EASINGMODE_EASEOUT=1,r._EASINGMODE_EASEINOUT=2,r}();o.EasingFunction=e;var t=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return t=W(0,C(1,t)),1-$(1-t*t)},e}(e);o.CircleEase=t;var i=function(r){function e(e){void 0===e&&(e=1);var o=r.call(this)||this;return o.amplitude=e,o}return h(e,r),e.prototype.easeInCore=function(r){var e=W(0,this.amplitude);return x(r,3)-r*e*B(3.141592653589793*r)},e}(e);o.BackEase=i;var r=function(o){function e(e,a){void 0===e&&(e=3),void 0===a&&(a=2);var i=o.call(this)||this;return i.bounces=e,i.bounciness=a,i}return h(e,o),e.prototype.easeInCore=function(s){var e=W(0,this.bounces),t=this.bounciness;1>=t&&(t=1.001);var i=x(t,e),r=1-t,n=(1-i)/r+.5*i,o=m(-(s*n)*(1-t)+1)/m(t),a=ee(o),l=(1-x(t,a))/(r*n),c=(1-x(t,a+1))/(r*n),u=.5*(l+c),f=s-u,d=u-l;return-x(1/t,e-a)/(d*d)*(f-d)*(f+d)},e}(e);o.BounceEase=r;var n=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return t*t*t},e}(e);o.CubicEase=n;var s=function(o){function e(e,a){void 0===e&&(e=3),void 0===a&&(a=3);var i=o.call(this)||this;return i.oscillations=e,i.springiness=a,i}return h(e,o),e.prototype.easeInCore=function(r){var e=W(0,this.oscillations),t=W(0,this.springiness);return(0==t?r:(u(t*r)-1)/(u(t)-1))*B((6.283185307179586*e+1.5707963267948966)*r)},e}(e);o.ElasticEase=s;var a=function(r){function e(e){void 0===e&&(e=2);var o=r.call(this)||this;return o.exponent=e,o}return h(e,r),e.prototype.easeInCore=function(t){return 0>=this.exponent?t:(u(this.exponent*t)-1)/(u(this.exponent)-1)},e}(e);o.ExponentialEase=a;var l=function(r){function e(e){void 0===e&&(e=2);var o=r.call(this)||this;return o.power=e,o}return h(e,r),e.prototype.easeInCore=function(r){var e=W(0,this.power);return x(r,e)},e}(e);o.PowerEase=l;var _=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return t*t},e}(e);o.QuadraticEase=_;var c=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return t*t*t*t},e}(e);o.QuarticEase=c;var g=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return t*t*t*t*t},e}(e);o.QuinticEase=g;var f=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.easeInCore=function(t){return 1-B(1.5707963267948966*(1-t))},e}(e);o.SineEase=f;var d=function(a){function e(t,e,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===s&&(s=1),void 0===r&&(r=1);var n=a.call(this)||this;return n.x1=t,n.y1=e,n.x2=s,n.y2=r,n}return h(e,a),e.prototype.easeInCore=function(e){return o.BezierCurve.interpolate(e,this.x1,this.y1,this.x2,this.y2)},e}(e);o.BezierCurveEase=d}(e||(e={}));var e;!function(o){var e=function(){function t(t){this._actionManager=t}return t.prototype.isValid=function(){return!0},t.prototype._getProperty=function(t){return this._actionManager._getProperty(t)},t.prototype._getEffectiveTarget=function(r,e){return this._actionManager._getEffectiveTarget(r,e)},t.prototype.serialize=function(){},t.prototype._serialize=function(t){return{type:2,children:[],name:t.name,properties:t.properties}},t}();o.Condition=e;var t=function(l){function t(i,e,r,n,o){void 0===o&&(o=t.IsEqual);var s=l.call(this,i)||this;return s.propertyPath=r,s.value=n,s.operator=o,s._target=e,s._effectiveTarget=s._getEffectiveTarget(e,s.propertyPath),s._property=s._getProperty(s.propertyPath),s}return h(t,l),Object.defineProperty(t,'IsEqual',{get:function(){return t._IsEqual},enumerable:!0,configurable:!0}),Object.defineProperty(t,'IsDifferent',{get:function(){return t._IsDifferent},enumerable:!0,configurable:!0}),Object.defineProperty(t,'IsGreater',{get:function(){return t._IsGreater},enumerable:!0,configurable:!0}),Object.defineProperty(t,'IsLesser',{get:function(){return t._IsLesser},enumerable:!0,configurable:!0}),t.prototype.isValid=function(){switch(this.operator){case t.IsGreater:return this._effectiveTarget[this._property]>this.value;case t.IsLesser:return this._effectiveTarget[this._property]<this.value;case t.IsEqual:case t.IsDifferent:var r;return r=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===t.IsEqual?r:!r;}return!1},t.prototype.serialize=function(){return this._serialize({name:'ValueCondition',properties:[o.Action._GetTargetProperty(this._target),{name:'propertyPath',value:this.propertyPath},{name:'value',value:o.Action._SerializeValueAsString(this.value)},{name:'operator',value:t.GetOperatorName(this.operator)}]})},t.GetOperatorName=function(r){return r===t._IsEqual?'IsEqual':r===t._IsDifferent?'IsDifferent':r===t._IsGreater?'IsGreater':r===t._IsLesser?'IsLesser':''},t._IsEqual=0,t._IsDifferent=1,t._IsGreater=2,t._IsLesser=3,t}(e);o.ValueCondition=t;var i=function(o){function e(e,a){var i=o.call(this,e)||this;return i.predicate=a,i}return h(e,o),e.prototype.isValid=function(){return this.predicate()},e}(e);o.PredicateCondition=i;var r=function(a){function e(t,e,o){var r=a.call(this,t)||this;return r.value=o,r._target=e,r}return h(e,a),e.prototype.isValid=function(){return this._target.state===this.value},e.prototype.serialize=function(){return this._serialize({name:'StateCondition',properties:[o.Action._GetTargetProperty(this._target),{name:'value',value:this.value}]})},e}(e);o.StateCondition=r}(e||(e={}));var e;!function(r){var e=function(){function e(e,o){this.triggerOptions=e,this.onBeforeExecuteObservable=new r.Observable,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):this.trigger=e,this._nextActiveAction=this,this._condition=o}return e.prototype._prepare=function(){},e.prototype.getTriggerParameter=function(){return this._triggerParameter},e.prototype._executeCurrent=function(r){if(this._nextActiveAction._condition){var e=this._nextActiveAction._condition,t=this._actionManager.getScene().getRenderId();if(!(e._evaluationId===t)){if(e._evaluationId=t,!e.isValid())return void(e._currentResult=!1);e._currentResult=!0}else if(!e._currentResult)return}this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(r),this.skipToNextActiveAction()},e.prototype.execute=function(){},e.prototype.skipToNextActiveAction=function(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this},e.prototype.then=function(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t},e.prototype._getProperty=function(t){return this._actionManager._getProperty(t)},e.prototype._getEffectiveTarget=function(r,e){return this._actionManager._getEffectiveTarget(r,e)},e.prototype.serialize=function(){},e.prototype._serialize=function(o,e){var t={type:1,children:[],name:o.name,properties:o.properties||[]};if(this._child&&this._child.serialize(t),this._condition){var i=this._condition.serialize();return i.children.push(t),e&&e.children.push(i),i}return e&&e.children.push(t),t},e._SerializeValueAsString=function(e){return'number'==typeof e?e.toString():'boolean'==typeof e?e?'true':'false':e instanceof r.Vector2?e.x+', '+e.y:e instanceof r.Vector3?e.x+', '+e.y+', '+e.z:e instanceof r.Color3?e.r+', '+e.g+', '+e.b:e instanceof r.Color4?e.r+', '+e.g+', '+e.b+', '+e.a:e},e._GetTargetProperty=function(e){return{name:'target',targetType:e instanceof r.Mesh?'MeshProperties':e instanceof r.Light?'LightProperties':e instanceof r.Camera?'CameraProperties':'SceneProperties',value:e instanceof r.Scene?'Scene':e.name}},e}();r.Action=e}(e||(e={}));var e;!function(A){var e=function(){function o(a,s,t,i,r,n){this.source=a,this.pointerX=s,this.pointerY=t,this.meshUnderPointer=i,this.sourceEvent=r,this.additionalData=n}return o.CreateNew=function(e,t,i){var r=e.getScene();return new o(e,r.pointerX,r.pointerY,r.meshUnderPointer,t,i)},o.CreateNewFromSprite=function(e,t,i,r){return new o(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)},o.CreateNewFromScene=function(e,t){return new o(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)},o.CreateNewFromPrimitive=function(e,t,i,r){return new o(e,t.x,t.y,null,i,r)},o}();A.ActionEvent=e;var t=function(){function _(e){this.actions=[],this.hoverCursor='',this._scene=e||A.Engine.LastCreatedScene,e._actionManagers.push(this)}return Object.defineProperty(_,'NothingTrigger',{get:function(){return _._NothingTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPickTrigger',{get:function(){return _._OnPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnLeftPickTrigger',{get:function(){return _._OnLeftPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnRightPickTrigger',{get:function(){return _._OnRightPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnCenterPickTrigger',{get:function(){return _._OnCenterPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPickDownTrigger',{get:function(){return _._OnPickDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnDoublePickTrigger',{get:function(){return _._OnDoublePickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPickUpTrigger',{get:function(){return _._OnPickUpTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPickOutTrigger',{get:function(){return _._OnPickOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnLongPressTrigger',{get:function(){return _._OnLongPressTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPointerOverTrigger',{get:function(){return _._OnPointerOverTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnPointerOutTrigger',{get:function(){return _._OnPointerOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnEveryFrameTrigger',{get:function(){return _._OnEveryFrameTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnIntersectionEnterTrigger',{get:function(){return _._OnIntersectionEnterTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnIntersectionExitTrigger',{get:function(){return _._OnIntersectionExitTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnKeyDownTrigger',{get:function(){return _._OnKeyDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(_,'OnKeyUpTrigger',{get:function(){return _._OnKeyUpTrigger},enumerable:!0,configurable:!0}),_.prototype.dispose=function(){for(var t=this._scene._actionManagers.indexOf(this),e=0,o;e<this.actions.length;e++)o=this.actions[e],_.Triggers[o.trigger]--,0===_.Triggers[o.trigger]&&delete _.Triggers[o.trigger];-1<t&&this._scene._actionManagers.splice(t,1)},_.prototype.getScene=function(){return this._scene},_.prototype.hasSpecificTriggers=function(r){for(var e=0,t;e<this.actions.length;e++)if(t=this.actions[e],-1<r.indexOf(t.trigger))return!0;return!1},_.prototype.hasSpecificTrigger=function(o,e){for(var a=0,i;a<this.actions.length;a++)if(i=this.actions[a],i.trigger===o){if(!e)return!0;if(e(i.getTriggerParameter()))return!0}return!1},Object.defineProperty(_.prototype,'hasPointerTriggers',{get:function(){for(var t=0,e;t<this.actions.length;t++)if(e=this.actions[t],e.trigger>=_._OnPickTrigger&&e.trigger<=_._OnPointerOutTrigger)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,'hasPickTriggers',{get:function(){for(var t=0,e;t<this.actions.length;t++)if(e=this.actions[t],e.trigger>=_._OnPickTrigger&&e.trigger<=_._OnPickUpTrigger)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(_,'HasTriggers',{get:function(){for(var t in _.Triggers)if(_.Triggers.hasOwnProperty(t))return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(_,'HasPickTriggers',{get:function(){for(var t in _.Triggers)if(_.Triggers.hasOwnProperty(t)){var e=parseInt(t);if(e>=_._OnPickTrigger&&e<=_._OnPickUpTrigger)return!0}return!1},enumerable:!0,configurable:!0}),_.HasSpecificTrigger=function(t){for(var e in _.Triggers)if(_.Triggers.hasOwnProperty(e)){var o=parseInt(e);if(o===t)return!0}return!1},_.prototype.registerAction=function(e){return e.trigger===_.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(A.Tools.Warn('OnEveryFrameTrigger can only be used with scene.actionManager'),null):(this.actions.push(e),_.Triggers[e.trigger]?_.Triggers[e.trigger]++:_.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)},_.prototype.unregisterAction=function(t){var e=this.actions.indexOf(t);return-1!==e&&(this.actions.splice(e,1),_.Triggers[t.trigger]-=1,0===_.Triggers[t.trigger]&&delete _.Triggers[t.trigger],delete t._actionManager,!0)},_.prototype.processTrigger=function(t,e){for(var i=0,r;i<this.actions.length;i++)if(r=this.actions[i],r.trigger===t){if(e&&(t===_.OnKeyUpTrigger||t===_.OnKeyDownTrigger)){var n=r.getTriggerParameter();if(n&&n!==e.sourceEvent.keyCode){if(!n.toLowerCase)continue;var l=n.toLowerCase();if(l!==e.sourceEvent.key){var s=e.sourceEvent.charCode?e.sourceEvent.charCode:e.sourceEvent.keyCode;if(o(s).toLowerCase()!==l)continue}}}r._executeCurrent(e)}},_.prototype._getEffectiveTarget=function(o,e){for(var t=e.split('.'),i=0;i<t.length-1;i++)o=o[t[i]];return o},_.prototype._getProperty=function(r){var e=r.split('.');return e[e.length-1]},_.prototype.serialize=function(e){for(var t={children:[],name:e,type:3,properties:[]},r=0;r<this.actions.length;r++){var n={type:0,children:[],name:_.GetTriggerName(this.actions[r].trigger),properties:[]},o=this.actions[r].triggerOptions;if(o&&'number'!=typeof o)if(o.parameter instanceof A.Node)n.properties.push(A.Action._GetTargetProperty(o.parameter));else{var l={};A.Tools.DeepCopy(o.parameter,l,['mesh']),o.parameter.mesh&&(l._meshId=o.parameter.mesh.id),n.properties.push({name:'parameter',targetType:null,value:l})}this.actions[r].serialize(n),t.children.push(n)}return t},_.Parse=function(e,t,r){var n=new _(r);null===t?r.actionManager=n:t.actionManager=n;for(var o=function(e,t){var o=Object.create(A.Tools.Instantiate('BABYLON.'+e).prototype);return o.constructor.apply(o,t),o},s=function(e,t,i,d){if(null===d){var n=parseFloat(t);return'true'===t||'false'===t?'true'==t:isNaN(n)?t:n}for(var o=d.split('.'),s=t.split(','),a=0;a<o.length;a++)i=i[o[a]];if('boolean'==typeof i)return'true'===s[0];if('string'==typeof i)return s[0];for(var l=[],a=0;a<s.length;a++)l.push(parseFloat(s[a]));return i instanceof A.Vector3?A.Vector3.FromArray(l):i instanceof A.Vector4?A.Vector4.FromArray(l):i instanceof A.Color3?A.Color3.FromArray(l):i instanceof A.Color4?A.Color4.FromArray(l):parseFloat(s[0])},a=function(e,t,i,l,c){if(void 0===c&&(c=null),!e.detached){var u=[],f=null,d=null,p=e.combine&&0<e.combine.length;if(2===e.type?u.push(n):u.push(t),p){for(var h=[],m=0;m<e.combine.length;m++)a(e.combine[m],_.NothingTrigger,i,l,h);u.push(h)}else for(var g=0;g<e.properties.length;g++){var v=e.properties[g].value,y=e.properties[g].name,b=e.properties[g].targetType;'target'===y?v=f=null!==b&&'SceneProperties'===b?r:r.getNodeByName(v):'parent'===y?v=r.getNodeByName(v):'sound'===y?v=r.getSoundByName(v):'propertyPath'===y?d=v:v=2===e.type&&'operator'===y?A.ValueCondition[v]:s(0,v,f,'value'===y?d:null),u.push(v)}if(null===c?u.push(i):u.push(null),'InterpolateValueAction'===e.name){var x=u[u.length-2];u[u.length-1]=x,u[u.length-2]=i}var T=o(e.name,u);if(T instanceof A.Condition&&null!==i){var E=new A.DoNothingAction(t,i);l?l.then(E):n.registerAction(E),l=E}null===c?T instanceof A.Condition?(i=T,T=l):(i=null,l?l.then(T):n.registerAction(T)):c.push(T);for(var g=0;g<e.children.length;g++)a(e.children[g],t,i,T,null)}},i=0;i<e.children.length;i++){var l=e.children[i],u;if(0<l.properties.length){var c=l.properties[0].value,f=null===l.properties[0].targetType?c:r.getMeshByName(c);f._meshId&&(f.mesh=r.getMeshByID(f._meshId)),u={trigger:_[l.name],parameter:f}}else u=_[l.name];for(var m=0;m<l.children.length;m++)l.detached||a(l.children[m],u,null,null)}},_.GetTriggerName=function(t){return 0===t?'NothingTrigger':1===t?'OnPickTrigger':2===t?'OnLeftPickTrigger':3===t?'OnRightPickTrigger':4===t?'OnCenterPickTrigger':5===t?'OnPickDownTrigger':6===t?'OnPickUpTrigger':7===t?'OnLongPressTrigger':8===t?'OnPointerOverTrigger':9===t?'OnPointerOutTrigger':10===t?'OnEveryFrameTrigger':11===t?'OnIntersectionEnterTrigger':12===t?'OnIntersectionExitTrigger':13===t?'OnKeyDownTrigger':14===t?'OnKeyUpTrigger':15===t?'OnPickOutTrigger':''},_._NothingTrigger=0,_._OnPickTrigger=1,_._OnLeftPickTrigger=2,_._OnRightPickTrigger=3,_._OnCenterPickTrigger=4,_._OnPickDownTrigger=5,_._OnDoublePickTrigger=6,_._OnPickUpTrigger=7,_._OnLongPressTrigger=8,_._OnPointerOverTrigger=9,_._OnPointerOutTrigger=10,_._OnEveryFrameTrigger=11,_._OnIntersectionEnterTrigger=12,_._OnIntersectionExitTrigger=13,_._OnKeyDownTrigger=14,_._OnKeyUpTrigger=15,_._OnPickOutTrigger=16,_.Triggers={},_}();A.ActionManager=t}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===o&&(o=1e3);var u=e.call(this,t,s)||this;return u.propertyPath=r,u.value=n,u.duration=o,u.stopOtherAnimations=a,u.onInterpolationDone=l,u.onInterpolationDoneObservable=new d.Observable,u._target=u._effectiveTarget=p,u}return h(t,e),t.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},t.prototype.execute=function(){var e=this,i=this._actionManager.getScene(),r=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}],a;if('number'==typeof this.value)a=d.Animation.ANIMATIONTYPE_FLOAT;else if(this.value instanceof d.Color3)a=d.Animation.ANIMATIONTYPE_COLOR3;else if(this.value instanceof d.Vector3)a=d.Animation.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof d.Matrix)a=d.Animation.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof d.Quaternion))return void d.Tools.Warn('InterpolateValueAction: Unsupported type ('+typeof this.value+')');a=d.Animation.ANIMATIONTYPE_QUATERNION}var t=new d.Animation('InterpolateValueAction',this._property,100*(1e3/this.duration),a,d.Animation.ANIMATIONLOOPMODE_CONSTANT);t.setKeys(r),this.stopOtherAnimations&&i.stopAnimation(this._effectiveTarget);i.beginDirectAnimation(this._effectiveTarget,[t],0,100,!1,1,function(){e.onInterpolationDoneObservable.notifyObservers(e),e.onInterpolationDone&&e.onInterpolationDone()})},t.prototype.serialize=function(t){return e.prototype._serialize.call(this,{name:'InterpolateValueAction',properties:[d.Action._GetTargetProperty(this._target),{name:'propertyPath',value:this.propertyPath},{name:'value',value:d.Action._SerializeValueAsString(this.value)},{name:'duration',value:d.Action._SerializeValueAsString(this.duration)},{name:'stopOtherAnimations',value:d.Action._SerializeValueAsString(this.stopOtherAnimations)||!1}]},t)},t}(d.Action);d.InterpolateValueAction=e}(e||(e={}));var e;!function(o){var e=function(a){function e(t,e,s,r){var n=a.call(this,t,r)||this;return n.propertyPath=s,n._target=n._effectiveTarget=e,n}return h(e,a),e.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},e.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'SwitchBooleanAction',properties:[o.Action._GetTargetProperty(this._target),{name:'propertyPath',value:this.propertyPath}]},e)},e}(o.Action);o.SwitchBooleanAction=e;var t=function(a){function e(t,e,s,r){var n=a.call(this,t,r)||this;return n.value=s,n._target=e,n}return h(e,a),e.prototype.execute=function(){this._target.state=this.value},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'SetStateAction',properties:[o.Action._GetTargetProperty(this._target),{name:'value',value:this.value}]},e)},e}(o.Action);o.SetStateAction=t;var i=function(a){function e(t,e,l,r,n){var o=a.call(this,t,n)||this;return o.propertyPath=l,o.value=r,o._target=o._effectiveTarget=e,o}return h(e,a),e.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},e.prototype.execute=function(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'SetValueAction',properties:[o.Action._GetTargetProperty(this._target),{name:'propertyPath',value:this.propertyPath},{name:'value',value:o.Action._SerializeValueAsString(this.value)}]},e)},e}(o.Action);o.SetValueAction=i;var r=function(a){function e(t,e,l,r,n){var o=a.call(this,t,n)||this;return o.propertyPath=l,o.value=r,o._target=o._effectiveTarget=e,o}return h(e,a),e.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),'number'!=typeof this._effectiveTarget[this._property]&&o.Tools.Warn('Warning: IncrementValueAction can only be used with number values')},e.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'IncrementValueAction',properties:[o.Action._GetTargetProperty(this._target),{name:'propertyPath',value:this.propertyPath},{name:'value',value:o.Action._SerializeValueAsString(this.value)}]},e)},e}(o.Action);o.IncrementValueAction=r;var n=function(l){function e(t,e,d,r,n,o){var s=l.call(this,t,o)||this;return s.from=d,s.to=r,s.loop=n,s._target=e,s}return h(e,l),e.prototype._prepare=function(){},e.prototype.execute=function(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)},e.prototype.serialize=function(e){return l.prototype._serialize.call(this,{name:'PlayAnimationAction',properties:[o.Action._GetTargetProperty(this._target),{name:'from',value:this.from+''},{name:'to',value:this.to+''},{name:'loop',value:o.Action._SerializeValueAsString(this.loop)||!1}]},e)},e}(o.Action);o.PlayAnimationAction=n;var s=function(a){function e(t,e,o){var r=a.call(this,t,o)||this;return r._target=e,r}return h(e,a),e.prototype._prepare=function(){},e.prototype.execute=function(){this._actionManager.getScene().stopAnimation(this._target)},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'StopAnimationAction',properties:[o.Action._GetTargetProperty(this._target)]},e)},e}(o.Action);o.StopAnimationAction=s;var a=function(a){function e(e,t){return void 0===e&&(e=o.ActionManager.NothingTrigger),a.call(this,e,t)||this}return h(e,a),e.prototype.execute=function(){},e.prototype.serialize=function(t){return a.prototype._serialize.call(this,{name:'DoNothingAction',properties:[]},t)},e}(o.Action);o.DoNothingAction=a;var l=function(o){function e(e,a,i){var r=o.call(this,e,i)||this;return r.children=a,r}return h(e,o),e.prototype._prepare=function(){for(var t=0;t<this.children.length;t++)this.children[t]._actionManager=this._actionManager,this.children[t]._prepare()},e.prototype.execute=function(r){for(var e=0;e<this.children.length;e++)this.children[e].execute(r)},e.prototype.serialize=function(e){for(var t=o.prototype._serialize.call(this,{name:'CombineAction',properties:[],combine:[]},e),i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t},e}(o.Action);o.CombineAction=l;var p=function(o){function e(e,a,i){var r=o.call(this,e,i)||this;return r.func=a,r}return h(e,o),e.prototype.execute=function(t){this.func(t)},e}(o.Action);o.ExecuteCodeAction=p;var c=function(a){function e(t,e,s,r){var n=a.call(this,t,r)||this;return n._target=e,n._parent=s,n}return h(e,a),e.prototype._prepare=function(){},e.prototype.execute=function(){if(this._target.parent!==this._parent){var e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=o.Vector3.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}},e.prototype.serialize=function(e){return a.prototype._serialize.call(this,{name:'SetParentAction',properties:[o.Action._GetTargetProperty(this._target),o.Action._GetTargetProperty(this._parent)]},e)},e}(o.Action);o.SetParentAction=c;var u=function(o){function e(e,a,i){var r=o.call(this,e,i)||this;return r._sound=a,r}return h(e,o),e.prototype._prepare=function(){},e.prototype.execute=function(){void 0!==this._sound&&this._sound.play()},e.prototype.serialize=function(e){return o.prototype._serialize.call(this,{name:'PlaySoundAction',properties:[{name:'sound',value:this._sound.name}]},e)},e}(o.Action);o.PlaySoundAction=u;var f=function(o){function e(e,a,i){var r=o.call(this,e,i)||this;return r._sound=a,r}return h(e,o),e.prototype._prepare=function(){},e.prototype.execute=function(){void 0!==this._sound&&this._sound.stop()},e.prototype.serialize=function(e){return o.prototype._serialize.call(this,{name:'StopSoundAction',properties:[{name:'sound',value:this._sound.name}]},e)},e}(o.Action);o.StopSoundAction=f}(e||(e={}));var e;!function(m){var e=function(){function e(e,_,i,r,n,o,s){if(void 0===o&&(o=.01),void 0===s&&(s=m.Texture.TRILINEAR_SAMPLINGMODE),this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.fogEnabled=!0,this.isPickable=!1,this.onDisposeObservable=new m.Observable,this._vertexBuffers={},this._capacity=i,this._spriteTexture=new m.Texture(_,n,!0,!1,s),this._spriteTexture.wrapU=m.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=m.Texture.CLAMP_ADDRESSMODE,r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else{if(void 0===r)return;this.cellWidth=r,this.cellHeight=r}this._epsilon=o,this._scene=n,this._scene.spriteManagers.push(this);for(var a=[],l=0,g=0;g<i;g++)a.push(l),a.push(l+1),a.push(l+2),a.push(l),a.push(l+2),a.push(l+3),l+=4;this._indexBuffer=n.getEngine().createIndexBuffer(a),this._vertexData=new Float32Array(4*(16*i)),this._buffer=new m.Buffer(n.getEngine(),this._vertexData,!0,16);var c=this._buffer.createVertexBuffer(m.VertexBuffer.PositionKind,0,4),u=this._buffer.createVertexBuffer('options',4,4),f=this._buffer.createVertexBuffer('cellInfo',8,4),d=this._buffer.createVertexBuffer(m.VertexBuffer.ColorKind,12,4);this._vertexBuffers[m.VertexBuffer.PositionKind]=c,this._vertexBuffers.options=u,this._vertexBuffers.cellInfo=f,this._vertexBuffers[m.VertexBuffer.ColorKind]=d,this._effectBase=this._scene.getEngine().createEffect('sprites',[m.VertexBuffer.PositionKind,'options','cellInfo',m.VertexBuffer.ColorKind],['view','projection','textureInfos','alphaTest'],['diffuseSampler'],''),this._effectFog=this._scene.getEngine().createEffect('sprites',[m.VertexBuffer.PositionKind,'options','cellInfo',m.VertexBuffer.ColorKind],['view','projection','textureInfos','alphaTest','vFogInfos','vFogColor'],['diffuseSampler'],'#define FOG')}return Object.defineProperty(e.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'texture',{get:function(){return this._spriteTexture},set:function(t){this._spriteTexture=t},enumerable:!0,configurable:!0}),e.prototype._appendSpriteVertex=function(a,e,t,i,r){var n=16*a;0===t?t=this._epsilon:1===t&&(t=1-this._epsilon),0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),this._vertexData[n]=e.position.x,this._vertexData[n+1]=e.position.y,this._vertexData[n+2]=e.position.z,this._vertexData[n+3]=e.angle,this._vertexData[n+4]=e.width,this._vertexData[n+5]=e.height,this._vertexData[n+6]=t,this._vertexData[n+7]=i,this._vertexData[n+8]=e.invertU?1:0,this._vertexData[n+9]=e.invertV?1:0;var o=e.cellIndex/r>>0;this._vertexData[n+10]=e.cellIndex-o*r,this._vertexData[n+11]=o,this._vertexData[n+12]=e.color.r,this._vertexData[n+13]=e.color.g,this._vertexData[n+14]=e.color.b,this._vertexData[n+15]=e.color.a},e.prototype.intersects=function(e,t,i,r){for(var n=C(this._capacity,this.sprites.length),o=m.Vector3.Zero(),s=m.Vector3.Zero(),a=S,l=null,g=m.Vector3.Zero(),c=t.getViewMatrix(),u=0,f;u<n;u++)if(f=this.sprites[u],f){if(i){if(!i(f))continue;}else if(!f.isPickable)continue;if(m.Vector3.TransformCoordinatesToRef(f.position,c,g),o.copyFromFloats(g.x-f.width/2,g.y-f.height/2,g.z),s.copyFromFloats(g.x+f.width/2,g.y+f.height/2,g.z),e.intersectsBoxMinMax(o,s)){var d=m.Vector3.Distance(g,e.origin);if(a>d&&(a=d,l=f,r))break}}if(l){var p=new m.PickingInfo;return p.hit=!0,p.pickedSprite=l,p.distance=a,p}return null},e.prototype.render=function(){if(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()){for(var e=this._scene.getEngine(),t=this._spriteTexture.getBaseSize(),i=e.getDeltaTime(),r=C(this._capacity,this.sprites.length),n=t.width/this.cellWidth,o=0,s=0,a;s<r;s++)a=this.sprites[s],a&&(a._animate(i),this._appendSpriteVertex(o++,a,0,0,n),this._appendSpriteVertex(o++,a,1,0,n),this._appendSpriteVertex(o++,a,1,1,n),this._appendSpriteVertex(o++,a,0,1,n));this._buffer.update(this._vertexData);var l=this._effectBase;this._scene.fogEnabled&&this._scene.fogMode!==m.Scene.FOGMODE_NONE&&this.fogEnabled&&(l=this._effectFog),e.enableEffect(l);var d=this._scene.getViewMatrix();l.setTexture('diffuseSampler',this._spriteTexture),l.setMatrix('view',d),l.setMatrix('projection',this._scene.getProjectionMatrix()),l.setFloat2('textureInfos',this.cellWidth/t.width,this.cellHeight/t.height),this._scene.fogEnabled&&this._scene.fogMode!==m.Scene.FOGMODE_NONE&&this.fogEnabled&&(l.setFloat4('vFogInfos',this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),l.setColor3('vFogColor',this._scene.fogColor)),e.bindBuffers(this._vertexBuffers,this._indexBuffer,l),e.setDepthFunctionToLessOrEqual(),l.setBool('alphaTest',!0),e.setColorWrite(!1),e.drawElementsType(m.Material.TriangleFillMode,0,6*r),e.setColorWrite(!0),l.setBool('alphaTest',!1),e.setAlphaMode(m.Engine.ALPHA_COMBINE),e.drawElementsType(m.Material.TriangleFillMode,0,6*r),e.setAlphaMode(m.Engine.ALPHA_DISABLE)}},e.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);var t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e}();m.SpriteManager=e}(e||(e={}));var e;!function(r){var e=function(){function e(e,o){this.name=e,this.color=new r.Color4(1,1,1,1),this.width=1,this.height=1,this.angle=0,this.cellIndex=0,this.invertU=0,this.invertV=0,this.animations=[],this.isPickable=!1,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._manager=o,this._manager.sprites.push(this),this.position=r.Vector3.Zero()}return Object.defineProperty(e.prototype,'size',{get:function(){return this.width},set:function(t){this.width=t,this.height=t},enumerable:!0,configurable:!0}),e.prototype.playAnimation=function(o,e,t,i,r){this._fromIndex=o,this._toIndex=e,this._loopAnimation=t,this._delay=i,this._animationStarted=!0,this._direction=o<e?1:-1,this.cellIndex=o,this._time=0,this._onAnimationEnd=r},e.prototype.stopAnimation=function(){this._animationStarted=!1},e.prototype._animate=function(t){this._animationStarted&&(this._time+=t,this._time>this._delay&&(this._time%=this._delay,this.cellIndex+=this._direction,this.cellIndex>this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()))))},e.prototype.dispose=function(){for(var t=0;t<this._manager.sprites.length;t++)this._manager.sprites[t]==this&&this._manager.sprites.splice(t,1)},e}();r.Sprite=e}(e||(e={}));var e;!function(_){var e=function(){function t(r,o,t){this.bu=r,this.bv=o,this.distance=t,this.faceId=0,this.subMeshId=0}return t}();_.IntersectionInfo=e;var t=function(){function e(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshId=0,this.pickedSprite=null}return e.prototype.getNormal=function(e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(_.VertexBuffer.NormalKind))return null;var i=this.pickedMesh.getIndices();if(!i)return null;var m;if(t){var n=this.pickedMesh.getVerticesData(_.VertexBuffer.NormalKind),o=_.Vector3.FromArray(n,3*i[3*this.faceId]),s=_.Vector3.FromArray(n,3*i[3*this.faceId+1]),a=_.Vector3.FromArray(n,3*i[3*this.faceId+2]);o=o.scale(this.bu),s=s.scale(this.bv),a=a.scale(1-this.bu-this.bv),m=new _.Vector3(o.x+s.x+a.x,o.y+s.y+a.y,o.z+s.z+a.z)}else{var l=this.pickedMesh.getVerticesData(_.VertexBuffer.PositionKind),g=_.Vector3.FromArray(l,3*i[3*this.faceId]),c=_.Vector3.FromArray(l,3*i[3*this.faceId+1]),u=_.Vector3.FromArray(l,3*i[3*this.faceId+2]),f=g.subtract(c),d=u.subtract(c);m=_.Vector3.Cross(f,d)}return e&&(m=_.Vector3.TransformNormal(m,this.pickedMesh.getWorldMatrix())),_.Vector3.Normalize(m)},e.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(_.VertexBuffer.UVKind))return null;var e=this.pickedMesh.getIndices();if(!e)return null;var a=this.pickedMesh.getVerticesData(_.VertexBuffer.UVKind);if(!a)return null;var s=_.Vector2.FromArray(a,2*e[3*this.faceId]),r=_.Vector2.FromArray(a,2*e[3*this.faceId+1]),n=_.Vector2.FromArray(a,2*e[3*this.faceId+2]);return s=s.scale(1-this.bu-this.bv),r=r.scale(this.bu),n=n.scale(this.bv),new _.Vector2(s.x+r.x+n.x,s.y+r.y+n.y)},e}();_.PickingInfo=t}(e||(e={}));var e;!function(E){var e=function(){function P(r,e,o){void 0===o&&(o=S),this.origin=r,this.direction=e,this.length=o}return P.prototype.intersectsBoxMinMax=function(l,e){var t=0,s=S,a,i,r,n;if(1e-7>A(this.direction.x)){if(this.origin.x<l.x||this.origin.x>e.x)return!1;}else if(a=1/this.direction.x,i=(l.x-this.origin.x)*a,r=(e.x-this.origin.x)*a,r===-1/0&&(r=1/0),i>r&&(n=i,i=r,r=n),t=W(i,t),s=C(r,s),t>s)return!1;if(1e-7>A(this.direction.y)){if(this.origin.y<l.y||this.origin.y>e.y)return!1;}else if(a=1/this.direction.y,i=(l.y-this.origin.y)*a,r=(e.y-this.origin.y)*a,r===-1/0&&(r=1/0),i>r&&(n=i,i=r,r=n),t=W(i,t),s=C(r,s),t>s)return!1;if(1e-7>A(this.direction.z)){if(this.origin.z<l.z||this.origin.z>e.z)return!1;}else if(a=1/this.direction.z,i=(l.z-this.origin.z)*a,r=(e.z-this.origin.z)*a,r===-1/0&&(r=1/0),i>r&&(n=i,i=r,r=n),t=W(i,t),s=C(r,s),t>s)return!1;return!0},P.prototype.intersectsBox=function(t){return this.intersectsBoxMinMax(t.minimum,t.maximum)},P.prototype.intersectsSphere=function(a){var e=a.center.x-this.origin.x,t=a.center.y-this.origin.y,i=a.center.z-this.origin.z,r=e*e+t*t+i*i,n=a.radius*a.radius;if(r<=n)return!0;var o=e*this.direction.x+t*this.direction.y+i*this.direction.z;return!(0>o)&&r-o*o<=n},P.prototype.intersectsTriangle=function(e,t,i){this._edge1||(this._edge1=E.Vector3.Zero(),this._edge2=E.Vector3.Zero(),this._pvec=E.Vector3.Zero(),this._tvec=E.Vector3.Zero(),this._qvec=E.Vector3.Zero()),t.subtractToRef(e,this._edge1),i.subtractToRef(e,this._edge2),E.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var r=E.Vector3.Dot(this._edge1,this._pvec);if(0===r)return null;var n=1/r;this.origin.subtractToRef(e,this._tvec);var o=E.Vector3.Dot(this._tvec,this._pvec)*n;if(0>o||1<o)return null;E.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec);var s=E.Vector3.Dot(this.direction,this._qvec)*n;if(0>s||1<o+s)return null;var a=E.Vector3.Dot(this._edge2,this._qvec)*n;return a>this.length?null:new E.IntersectionInfo(o,s,a)},P.prototype.intersectsPlane=function(e){var t=E.Vector3.Dot(e.normal,this.direction),r;if(9.99999997475243e-7>A(t))return null;var o=E.Vector3.Dot(e.normal,this.origin);return r=(-e.d-o)/t,0>r?-9.99999997475243e-7>r?null:0:r},P.prototype.intersectsMesh=function(e,t){var r=E.Tmp.Matrix[0];return e.getWorldMatrix().invertToRef(r),this._tmpRay?P.TransformToRef(this,r,this._tmpRay):this._tmpRay=P.Transform(this,r),e.intersects(this._tmpRay,t)},P.prototype.intersectsMeshes=function(o,e,t){t?t.length=0:t=[];for(var i=0,r;i<o.length;i++)r=this.intersectsMesh(o[i],e),r.hit&&t.push(r);return t.sort(this._comparePickingInfo),t},P.prototype._comparePickingInfo=function(r,e){return r.distance<e.distance?-1:r.distance>e.distance?1:0},P.prototype.intersectionSegment=function(e,t,r){var i=this.origin.add(this.direction.multiplyByFloats(P.rayl,P.rayl,P.rayl)),n=t.subtract(e),c=i.subtract(this.origin),u=e.subtract(this.origin),f=E.Vector3.Dot(n,n),d=E.Vector3.Dot(n,c),p=E.Vector3.Dot(c,c),_=E.Vector3.Dot(n,u),h=E.Vector3.Dot(c,u),g=f*p-d*d,v=g,y=g,b,o,s,a;g<P.smallnum?(o=0,v=1,a=h,y=p):(o=d*h-p*_,a=f*h-d*_,0>o?(o=0,a=h,y=p):o>v&&(o=v,a=h+d,y=p)),0>a?(a=0,0>-_?o=0:-_>f?o=v:(o=-_,v=f)):a>y&&(a=y,0>-_+d?o=0:-_+d>f?o=v:(o=-_+d,v=f)),b=A(o)<P.smallnum?0:o/v,s=A(a)<P.smallnum?0:a/y;var l=c.multiplyByFloats(s,s,s),x=u.add(n.multiplyByFloats(b,b,b)).subtract(l);return 0<s&&s<=this.length&&x.lengthSquared()<r*r?l.length():-1},P.prototype.update=function(e,t,i,r,n,o,s){return E.Vector3.UnprojectFloatsToRef(e,t,0,i,r,n,o,s,this.origin),E.Vector3.UnprojectFloatsToRef(e,t,1,i,r,n,o,s,E.Tmp.Vector3[0]),E.Tmp.Vector3[0].subtractToRef(this.origin,this.direction),this.direction.normalize(),this},P.Zero=function(){return new P(E.Vector3.Zero(),E.Vector3.Zero())},P.CreateNew=function(t,e,i,r,n,o,s){return P.Zero().update(t,e,i,r,n,o,s)},P.CreateNewFromTo=function(e,t,r){void 0===r&&(r=E.Matrix.Identity());var i=t.subtract(e),o=$(i.x*i.x+i.y*i.y+i.z*i.z);return i.normalize(),P.Transform(new P(e,i,o),r)},P.Transform=function(e,t){var r=new P(new E.Vector3(0,0,0),new E.Vector3(0,0,0));return P.TransformToRef(e,t,r),r},P.TransformToRef=function(e,t,i){E.Vector3.TransformCoordinatesToRef(e.origin,t,i.origin),E.Vector3.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;var r=i.direction,a=r.length();if(0!==a&&1!==a){var o=1/a;r.x*=o,r.y*=o,r.z*=o,i.length*=a}},P.smallnum=1e-8,P.rayl=1e9,P}();E.Ray=e}(e||(e={}));var e;!function(S){var e=function(o,e,t,i){return!(o.x>t.x+i)&&!(t.x-i>e.x)&&!(o.y>t.y+i)&&!(t.y-i>e.y)&&!(o.z>t.z+i)&&!(t.z-i>e.z)},t=function(){var d={root:0,found:!1};return function(e,t,c,r){d.root=0,d.found=!1;var n=t*t-4*e*c;if(0>n)return d;var o=$(n),s=(-t-o)/(2*e),a=(-t+o)/(2*e);if(s>a){var l=a;a=s,s=l}return 0<s&&s<r?(d.root=s,d.found=!0,d):0<a&&a<r?(d.root=a,d.found=!0,d):d}}(),o=function(){function o(){this._collisionPoint=S.Vector3.Zero(),this._planeIntersectionPoint=S.Vector3.Zero(),this._tempVector=S.Vector3.Zero(),this._tempVector2=S.Vector3.Zero(),this._tempVector3=S.Vector3.Zero(),this._tempVector4=S.Vector3.Zero(),this._edge=S.Vector3.Zero(),this._baseToVertex=S.Vector3.Zero(),this._destinationPoint=S.Vector3.Zero(),this._slidePlaneNormal=S.Vector3.Zero(),this._displacementVector=S.Vector3.Zero(),this._radius=S.Vector3.One(),this._retry=0,this._basePointWorld=S.Vector3.Zero(),this._velocityWorld=S.Vector3.Zero(),this._normalizedVelocity=S.Vector3.Zero(),this._collisionMask=-1}return Object.defineProperty(o.prototype,'collisionMask',{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'slidePlaneNormal',{get:function(){return this._slidePlaneNormal},enumerable:!0,configurable:!0}),o.prototype._initialize=function(e,t,o){this._velocity=t,S.Vector3.NormalizeToRef(t,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=o,this.collisionFound=!1},o.prototype._checkPointInTriangle=function(e,t,i,r,a){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),S.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var o=S.Vector3.Dot(this._tempVector4,a);return!(0>o)&&(r.subtractToRef(e,this._tempVector3),S.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),!(0>(o=S.Vector3.Dot(this._tempVector4,a)))&&(S.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),0<=(o=S.Vector3.Dot(this._tempVector4,a))))},o.prototype._canDoCollision=function(t,i,r,n){var o=S.Vector3.Distance(this._basePointWorld,t),s=W(this._radius.x,this._radius.y,this._radius.z);return!(o>this._velocityWorldLength+s+i)&&!!e(r,n,this._basePointWorld,this._velocityWorldLength+s)},o.prototype._testTriangle=function(e,i,r,n,o,s){var a=!1,h;i||(i=[]),i[e]||(i[e]=new S.Plane(0,0,0,0),i[e].copyFromPoints(r,n,o));var l=i[e];if(s||l.isFrontFacingTo(this._normalizedVelocity,0)){var c=l.signedDistanceTo(this._basePoint),u=S.Vector3.Dot(l.normal,this._velocity);if(0==u){if(1<=A(c))return;a=!0,h=0}else{h=(-1-c)/u;var f=(1-c)/u;if(h>f){var d=f;f=h,h=d}if(1<h||0>f)return;0>h&&(h=0),1<h&&(h=1)}this._collisionPoint.copyFromFloats(0,0,0);var p=!1,C=1;if(a||(this._basePoint.subtractToRef(l.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(h,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,r,n,o,l.normal)&&(p=!0,C=h,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!p){var m=this._velocity.lengthSquared(),R=m;this._basePoint.subtractToRef(r,this._tempVector);var v=2*S.Vector3.Dot(this._velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,b=t(R,v,y,C);b.found&&(C=b.root,p=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(n,this._tempVector),v=2*S.Vector3.Dot(this._velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,b=t(R,v,y,C),b.found&&(C=b.root,p=!0,this._collisionPoint.copyFrom(n)),this._basePoint.subtractToRef(o,this._tempVector),v=2*S.Vector3.Dot(this._velocity,this._tempVector),y=this._tempVector.lengthSquared()-1,b=t(R,v,y,C),b.found&&(C=b.root,p=!0,this._collisionPoint.copyFrom(o)),n.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex);var x=this._edge.lengthSquared(),T=S.Vector3.Dot(this._edge,this._velocity),E=S.Vector3.Dot(this._edge,this._baseToVertex);if(R=x*-m+T*T,v=x*(2*S.Vector3.Dot(this._velocity,this._baseToVertex))-2*T*E,y=x*(1-this._baseToVertex.lengthSquared())+E*E,b=t(R,v,y,C),b.found){var P=(T*b.root-E)/x;0<=P&&1>=P&&(C=b.root,p=!0,this._edge.scaleInPlace(P),r.addToRef(this._edge,this._collisionPoint))}o.subtractToRef(n,this._edge),n.subtractToRef(this._basePoint,this._baseToVertex),x=this._edge.lengthSquared(),T=S.Vector3.Dot(this._edge,this._velocity),E=S.Vector3.Dot(this._edge,this._baseToVertex),R=x*-m+T*T,v=x*(2*S.Vector3.Dot(this._velocity,this._baseToVertex))-2*T*E,y=x*(1-this._baseToVertex.lengthSquared())+E*E,b=t(R,v,y,C),b.found&&0<=(P=(T*b.root-E)/x)&&1>=P&&(C=b.root,p=!0,this._edge.scaleInPlace(P),n.addToRef(this._edge,this._collisionPoint)),r.subtractToRef(o,this._edge),o.subtractToRef(this._basePoint,this._baseToVertex),x=this._edge.lengthSquared(),T=S.Vector3.Dot(this._edge,this._velocity),E=S.Vector3.Dot(this._edge,this._baseToVertex),R=x*-m+T*T,v=x*(2*S.Vector3.Dot(this._velocity,this._baseToVertex))-2*T*E,y=x*(1-this._baseToVertex.lengthSquared())+E*E,b=t(R,v,y,C),b.found&&0<=(P=(T*b.root-E)/x)&&1>=P&&(C=b.root,p=!0,this._edge.scaleInPlace(P),o.addToRef(this._edge,this._collisionPoint))}if(p){var O=C*this._velocity.length();(!this.collisionFound||O<this._nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistance=O,this.collisionFound=!0)}}},o.prototype._collide=function(d,e,t,i,r,n,o){for(var s=i;s<r;s+=3){var a=e[t[s]-n],l=e[t[s+1]-n],p=e[t[s+2]-n];this._testTriangle(s,d,p,l,a,o)}},o.prototype._getResponse=function(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(S.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)},o}();S.Collider=o}(e||(e={}));var e;!function(d){d.CollisionWorker='';var c;!function(t){t[t.INIT=0]='INIT',t[t.UPDATE=1]='UPDATE',t[t.COLLIDE=2]='COLLIDE'}(c=d.WorkerTaskType||(d.WorkerTaskType={}));var e;!function(t){t[t.SUCCESS=0]='SUCCESS',t[t.UNKNOWN_ERROR=1]='UNKNOWN_ERROR'}(e=d.WorkerReplyType||(d.WorkerReplyType={}));var t=function(){function t(){var p=this;this._scaledPosition=d.Vector3.Zero(),this._scaledVelocity=d.Vector3.Zero(),this.onMeshUpdated=function(r){p._addUpdateMeshesList[r.uniqueId]=t.SerializeMesh(r)},this.onGeometryUpdated=function(r){p._addUpdateGeometriesList[r.id]=t.SerializeGeometry(r)},this._afterRender=function(){if(p._init&&!(0==p._toRemoveGeometryArray.length&&0==p._toRemoveMeshesArray.length&&0==Object.keys(p._addUpdateGeometriesList).length&&0==Object.keys(p._addUpdateMeshesList).length||4<p._runningUpdated)){++p._runningUpdated;var t={updatedMeshes:p._addUpdateMeshesList,updatedGeometries:p._addUpdateGeometriesList,removedGeometries:p._toRemoveGeometryArray,removedMeshes:p._toRemoveMeshesArray},a={payload:t,taskType:c.UPDATE},i=[];for(var r in t.updatedGeometries)t.updatedGeometries.hasOwnProperty(r)&&(i.push(a.payload.updatedGeometries[r].indices.buffer),i.push(a.payload.updatedGeometries[r].normals.buffer),i.push(a.payload.updatedGeometries[r].positions.buffer));p._worker.postMessage(a,i),p._addUpdateMeshesList={},p._addUpdateGeometriesList={},p._toRemoveGeometryArray=[],p._toRemoveMeshesArray=[]}},this._onMessageFromWorker=function(t){var r=t.data;if(r.error!=e.SUCCESS)return void d.Tools.Warn('error returned from worker!');switch(r.taskType){case c.INIT:p._init=!0,p._scene.meshes.forEach(function(t){p.onMeshAdded(t)}),p._scene.getGeometries().forEach(function(t){p.onGeometryAdded(t)});break;case c.UPDATE:p._runningUpdated--;break;case c.COLLIDE:var o=r.payload;if(!p._collisionsCallbackArray[o.collisionId])return;var i=p._collisionsCallbackArray[o.collisionId];if(i){var a=p._scene.getMeshByUniqueID(o.collidedMeshUniqueId);a&&i(o.collisionId,d.Vector3.FromArray(o.newPosition),a)}p._collisionsCallbackArray[o.collisionId]=null;}},this._collisionsCallbackArray=[],this._init=!1,this._runningUpdated=0,this._addUpdateMeshesList={},this._addUpdateGeometriesList={},this._toRemoveGeometryArray=[],this._toRemoveMeshesArray=[]}return t.prototype.getNewPosition=function(t,e,i,r,d,o,s){if(this._init&&!this._collisionsCallbackArray[s]&&!this._collisionsCallbackArray[s+1e5]){t.divideToRef(i._radius,this._scaledPosition),e.divideToRef(i._radius,this._scaledVelocity),this._collisionsCallbackArray[s]=o;var p={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:i._radius.asArray()},collisionId:s,excludedMeshUniqueId:d?d.uniqueId:null,maximumRetry:r},u={payload:p,taskType:c.COLLIDE};this._worker.postMessage(u)}},t.prototype.init=function(e){this._scene=e,this._scene.registerAfterRender(this._afterRender);var t=d.WorkerIncluded?d.Engine.CodeRepository+'Collisions/babylon.collisionWorker.js':URL.createObjectURL(new Blob([d.CollisionWorker],{type:'application/javascript'}));this._worker=new Worker(t),this._worker.onmessage=this._onMessageFromWorker;var r={payload:{},taskType:c.INIT};this._worker.postMessage(r)},t.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender),this._worker.terminate()},t.prototype.onMeshAdded=function(t){t.registerAfterWorldMatrixUpdate(this.onMeshUpdated),this.onMeshUpdated(t)},t.prototype.onMeshRemoved=function(t){this._toRemoveMeshesArray.push(t.uniqueId)},t.prototype.onGeometryAdded=function(t){t.onGeometryUpdated=this.onGeometryUpdated,this.onGeometryUpdated(t)},t.prototype.onGeometryDeleted=function(t){this._toRemoveGeometryArray.push(t.id)},t.SerializeMesh=function(e){var t=[];e.subMeshes&&(t=e.subMeshes.map(function(r,e){var o=r.getBoundingInfo();return{position:e,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount,hasMaterial:!!r.getMaterial(),sphereCenter:o.boundingSphere.centerWorld.asArray(),sphereRadius:o.boundingSphere.radiusWorld,boxMinimum:o.boundingBox.minimumWorld.asArray(),boxMaximum:o.boundingBox.maximumWorld.asArray()}}));var a=null;if(e instanceof d.Mesh){var s=e.geometry;a=s?s.id:null}else if(e instanceof d.InstancedMesh){var s=e.sourceMesh&&e.sourceMesh.geometry;a=s?s.id:null}var n=e.getBoundingInfo();return{uniqueId:e.uniqueId,id:e.id,name:e.name,geometryId:a,sphereCenter:n.boundingSphere.centerWorld.asArray(),sphereRadius:n.boundingSphere.radiusWorld,boxMinimum:n.boundingBox.minimumWorld.asArray(),boxMaximum:n.boundingBox.maximumWorld.asArray(),worldMatrixFromCache:e.worldMatrixFromCache.asArray(),subMeshes:t,checkCollisions:e.checkCollisions}},t.SerializeGeometry=function(e){return{id:e.id,positions:new Float32Array(e.getVerticesData(d.VertexBuffer.PositionKind)||[]),normals:new Float32Array(e.getVerticesData(d.VertexBuffer.NormalKind)||[]),indices:new Uint32Array(e.getIndices()||[])}},t}();d.CollisionCoordinatorWorker=t;var r=function(){function e(){this._scaledPosition=d.Vector3.Zero(),this._scaledVelocity=d.Vector3.Zero(),this._finalPosition=d.Vector3.Zero()}return e.prototype.getNewPosition=function(a,e,t,i,r,n,o){a.divideToRef(t._radius,this._scaledPosition),e.divideToRef(t._radius,this._scaledVelocity),t.collidedMesh=null,t._retry=0,t._initialVelocity=this._scaledVelocity,t._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,t,i,this._finalPosition,r),this._finalPosition.multiplyInPlace(t._radius),n(o,this._finalPosition,t.collidedMesh)},e.prototype.init=function(t){this._scene=t},e.prototype.destroy=function(){},e.prototype.onMeshAdded=function(){},e.prototype.onMeshUpdated=function(){},e.prototype.onMeshRemoved=function(){},e.prototype.onGeometryAdded=function(){},e.prototype.onGeometryUpdated=function(){},e.prototype.onGeometryDeleted=function(){},e.prototype._collideWithWorld=function(e,t,i,r,n,o){void 0===o&&(o=null);var s=10*d.Engine.CollisionsEpsilon;if(i._retry>=r)return void n.copyFrom(e);var a=o?o.collisionMask:i.collisionMask;i._initialize(e,t,s);for(var l=0,p;l<this._scene.meshes.length;l++)p=this._scene.meshes[l],p.isEnabled()&&p.checkCollisions&&p.subMeshes&&p!==o&&0!=(a&p.collisionGroup)&&p._checkCollision(i);return i.collisionFound?(0===t.x&&0===t.y&&0===t.z||i._getResponse(e,t),t.length()<=s?void n.copyFrom(e):(i._retry++,void this._collideWithWorld(e,t,i,r,n,o))):void e.addToRef(t,n)},e}();d.CollisionCoordinatorLegacy=r}(e||(e={}));var e;!function(r){var e=function(){function e(e){this.particleSystem=e,this.position=r.Vector3.Zero(),this.direction=r.Vector3.Zero(),this.color=new r.Color4(0,0,0,0),this.colorStep=new r.Color4(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._currentFrameCounter=0,this.particleSystem.isAnimationSheetEnabled&&this.updateCellInfoFromSystem()}return e.prototype.updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID,this.updateCellIndex=0==this.particleSystem.spriteCellChangeSpeed?this._updateCellIndexWithSpeedCalculated:this._updateCellIndexWithCustomSpeed},e.prototype._updateCellIndexWithSpeedCalculated=function(r){var e=(this.lifeTime-this.age)/r/(this.particleSystem.endSpriteCellID+1-this.cellIndex);this._currentFrameCounter+=r,this._currentFrameCounter>=e*r&&(this._currentFrameCounter=0,++this.cellIndex>this.particleSystem.endSpriteCellID&&(this.cellIndex=this.particleSystem.endSpriteCellID))},e.prototype._updateCellIndexWithCustomSpeed=function(){this._currentFrameCounter>=this.particleSystem.spriteCellChangeSpeed?(this.cellIndex++,this._currentFrameCounter=0,this.cellIndex>this.particleSystem.endSpriteCellID&&(this.particleSystem.spriteCellLoop?this.cellIndex=this.particleSystem.startSpriteCellID:this.cellIndex=this.particleSystem.endSpriteCellID)):this._currentFrameCounter++},e.prototype.copyTo=function(t){t.position.copyFrom(this.position),t.direction.copyFrom(this.direction),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t.size=this.size,t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex},e}();r.Particle=e}(e||(e={}));var e;!function(d){var e=function(){function e(t,i,r,n,o,s){void 0===n&&(n=null),void 0===o&&(o=!1),void 0===s&&(s=.01);var a=this;this.animations=[],this.renderingGroupId=0,this.emitter=null,this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.onAnimationEnd=null,this.blendMode=e.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.gravity=d.Vector3.Zero(),this.color1=new d.Color4(1,1,1,1),this.color2=new d.Color4(1,1,1,1),this.colorDead=new d.Color4(0,0,0,1),this.textureMask=new d.Color4(1,1,1,1),this.spriteCellLoop=!0,this.spriteCellChangeSpeed=0,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.onDisposeObservable=new d.Observable,this._particles=[],this._stockParticles=[],this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new d.Color4(0,0,0,0),this._colorDiff=new d.Color4(0,0,0,0),this._scaledDirection=d.Vector3.Zero(),this._scaledGravity=d.Vector3.Zero(),this._currentRenderId=-1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._vertexBufferSize=11,this.recycleParticle=function(r){var e=a._particles.pop();e!==r&&e.copyTo(r),a._stockParticles.push(e)},this._createParticle=function(){var e;return 0===a._stockParticles.length?e=new d.Particle(a):(e=a._stockParticles.pop(),e.age=0,e.cellIndex=a.startSpriteCellID),e},this._emitFromParticle=function(r){if(a.subEmitters&&0!==a.subEmitters.length){var e=ee(Math.random()*a.subEmitters.length),t=a.subEmitters[e].clone(a.name+'_sub',r.position.clone());t._rootParticleSystem=a,a.activeSubSystems.push(t),t.start()}},this._appendParticleVertexes=null,this.id=t,this.name=t,this._capacity=i,this._epsilon=s,this._isAnimationSheetEnabled=o,o&&(this._vertexBufferSize=12),this._scene=r||d.Engine.LastCreatedScene,this._customEffect=n,r.particleSystems.push(this),this._createIndexBuffer(),this._vertexData=new Float32Array(4*(i*this._vertexBufferSize)),this._vertexBuffer=new d.Buffer(r.getEngine(),this._vertexData,!0,this._vertexBufferSize);var l=this._vertexBuffer.createVertexBuffer(d.VertexBuffer.PositionKind,0,3),p=this._vertexBuffer.createVertexBuffer(d.VertexBuffer.ColorKind,3,4),c=this._vertexBuffer.createVertexBuffer('options',7,4);if(this._isAnimationSheetEnabled){var u=this._vertexBuffer.createVertexBuffer('cellIndex',11,1);this._vertexBuffers.cellIndex=u}this._vertexBuffers[d.VertexBuffer.PositionKind]=l,this._vertexBuffers[d.VertexBuffer.ColorKind]=p,this._vertexBuffers.options=c,this.particleEmitterType=new d.BoxParticleEmitter,this.updateFunction=function(r){for(var e=0,t;e<r.length;e++)t=r[e],t.age+=a._scaledUpdateSpeed,t.age>=t.lifeTime?(a._emitFromParticle(t),a.recycleParticle(t),e--):(t.colorStep.scaleToRef(a._scaledUpdateSpeed,a._scaledColorStep),t.color.addInPlace(a._scaledColorStep),0>t.color.a&&(t.color.a=0),t.angle+=t.angularSpeed*a._scaledUpdateSpeed,t.direction.scaleToRef(a._scaledUpdateSpeed,a._scaledDirection),t.position.addInPlace(a._scaledDirection),a.gravity.scaleToRef(a._scaledUpdateSpeed,a._scaledGravity),t.direction.addInPlace(a._scaledGravity),a._isAnimationSheetEnabled&&t.updateCellIndex(a._scaledUpdateSpeed))}}return Object.defineProperty(e.prototype,'direction1',{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:d.Vector3.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'direction2',{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:d.Vector3.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'minEmitBox',{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:d.Vector3.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'maxEmitBox',{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:d.Vector3.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isAnimationSheetEnabled',{get:function(){return this._isAnimationSheetEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'particles',{get:function(){return this._particles},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'ParticleSystem'},e.prototype._createIndexBuffer=function(){for(var r=[],e=0,t=0;t<this._capacity;t++)r.push(e),r.push(e+1),r.push(e+2),r.push(e),r.push(e+2),r.push(e+3),e+=4;this._indexBuffer=this._scene.getEngine().createIndexBuffer(r)},e.prototype.getCapacity=function(){return this._capacity},e.prototype.isAlive=function(){return this._alive},e.prototype.isStarted=function(){return this._started},e.prototype.start=function(){this._started=!0,this._stopped=!1,this._actualFrame=0,this.subEmitters&&0!=this.subEmitters.length&&(this.activeSubSystems=[])},e.prototype.stop=function(t){void 0===t&&(t=!0),this._stopped=!0,t&&this._stopSubEmitters()},e.prototype.reset=function(){this._stockParticles=[],this._particles=[]},e.prototype._appendParticleVertex=function(o,e,t,i){var r=o*this._vertexBufferSize;this._vertexData[r]=e.position.x,this._vertexData[r+1]=e.position.y,this._vertexData[r+2]=e.position.z,this._vertexData[r+3]=e.color.r,this._vertexData[r+4]=e.color.g,this._vertexData[r+5]=e.color.b,this._vertexData[r+6]=e.color.a,this._vertexData[r+7]=e.angle,this._vertexData[r+8]=e.size,this._vertexData[r+9]=t,this._vertexData[r+10]=i},e.prototype._appendParticleVertexWithAnimation=function(o,e,t,i){0===t?t=this._epsilon:1===t&&(t=1-this._epsilon),0===i?i=this._epsilon:1===i&&(i=1-this._epsilon);var r=o*this._vertexBufferSize;this._vertexData[r]=e.position.x,this._vertexData[r+1]=e.position.y,this._vertexData[r+2]=e.position.z,this._vertexData[r+3]=e.color.r,this._vertexData[r+4]=e.color.g,this._vertexData[r+5]=e.color.b,this._vertexData[r+6]=e.color.a,this._vertexData[r+7]=e.angle,this._vertexData[r+8]=e.size,this._vertexData[r+9]=t,this._vertexData[r+10]=i,this._vertexData[r+11]=e.cellIndex},e.prototype._stopSubEmitters=function(){this.activeSubSystems&&(this.activeSubSystems.forEach(function(t){t.stop(!0)}),this.activeSubSystems=[])},e.prototype._removeFromRoot=function(){if(this._rootParticleSystem){var t=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==t&&this._rootParticleSystem.activeSubSystems.splice(t,1)}},e.prototype._update=function(e){this._alive=0<this._particles.length,this.updateFunction(this._particles);var t;if(this.emitter.position)t=this.emitter.getWorldMatrix();else{var i=this.emitter;t=d.Matrix.Translation(i.x,i.y,i.z)}for(var r=0,o;r<e&&this._particles.length!==this._capacity;r++){o=this._createParticle(),this._particles.push(o);var n=d.Scalar.RandomRange(this.minEmitPower,this.maxEmitPower);this.startPositionFunction?this.startPositionFunction(t,o.position,o):this.particleEmitterType.startPositionFunction(t,o.position,o),this.startDirectionFunction?this.startDirectionFunction(n,t,o.direction,o):this.particleEmitterType.startDirectionFunction(n,t,o.direction,o),o.lifeTime=d.Scalar.RandomRange(this.minLifeTime,this.maxLifeTime),o.size=d.Scalar.RandomRange(this.minSize,this.maxSize),o.angularSpeed=d.Scalar.RandomRange(this.minAngularSpeed,this.maxAngularSpeed);var s=d.Scalar.RandomRange(0,1);d.Color4.LerpToRef(this.color1,this.color2,s,o.color),this.colorDead.subtractToRef(o.color,this._colorDiff),this._colorDiff.scaleToRef(1/o.lifeTime,o.colorStep)}},e.prototype._getEffect=function(){if(this._customEffect)return this._customEffect;var e=[];this._scene.clipPlane&&e.push('#define CLIPPLANE'),this._isAnimationSheetEnabled&&e.push('#define ANIMATESHEET');var t=e.join('\n');if(this._cachedDefines!==t){this._cachedDefines=t;var o,r;this._isAnimationSheetEnabled?(o=[d.VertexBuffer.PositionKind,d.VertexBuffer.ColorKind,'options','cellIndex'],r=['invView','view','projection','particlesInfos','vClipPlane','textureMask']):(o=[d.VertexBuffer.PositionKind,d.VertexBuffer.ColorKind,'options'],r=['invView','view','projection','vClipPlane','textureMask']),this._effect=this._scene.getEngine().createEffect('particles',o,r,['diffuseSampler'],t)}return this._effect},e.prototype.animate=function(){if(this._started){var o=this._getEffect();if(this.emitter&&o.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId()){this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var e;-1<this.manualEmitCount?(e=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0):(e=this.emitRate*this._scaledUpdateSpeed>>0,this._newPartsExcess+=this.emitRate*this._scaledUpdateSpeed-e),1<this._newPartsExcess&&(e+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?e=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(e),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene._toBeDisposed.push(this))),this._appendParticleVertexes=this._isAnimationSheetEnabled?this._appenedParticleVertexesWithSheet:this._appenedParticleVertexesNoSheet;for(var t=0,i=0,r;i<this._particles.length;i++)r=this._particles[i],this._appendParticleVertexes(t,r),t+=4;this._vertexBuffer&&this._vertexBuffer.update(this._vertexData),0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}}},e.prototype._appenedParticleVertexesWithSheet=function(r,e){this._appendParticleVertexWithAnimation(r++,e,0,0),this._appendParticleVertexWithAnimation(r++,e,1,0),this._appendParticleVertexWithAnimation(r++,e,1,1),this._appendParticleVertexWithAnimation(r++,e,0,1)},e.prototype._appenedParticleVertexesNoSheet=function(r,e){this._appendParticleVertex(r++,e,0,0),this._appendParticleVertex(r++,e,1,0),this._appendParticleVertex(r++,e,1,1),this._appendParticleVertex(r++,e,0,1)},e.prototype.rebuild=function(){this._createIndexBuffer(),this._vertexBuffer&&this._vertexBuffer._rebuild()},e.prototype.isReady=function(){var t=this._getEffect();return!!(this.emitter&&t.isReady()&&this.particleTexture&&this.particleTexture.isReady())},e.prototype.render=function(){var t=this._getEffect();if(!this.isReady()||!this._particles.length)return 0;var i=this._scene.getEngine();i.enableEffect(t),i.setState(!1);var r=this._scene.getViewMatrix();if(t.setTexture('diffuseSampler',this.particleTexture),t.setMatrix('view',r),t.setMatrix('projection',this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var n=this.particleTexture.getBaseSize();t.setFloat3('particlesInfos',this.spriteCellWidth/n.width,this.spriteCellHeight/n.height,n.width/this.spriteCellWidth)}if(t.setFloat4('textureMask',this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._scene.clipPlane){var o=this._scene.clipPlane,s=r.clone();s.invert(),t.setMatrix('invView',s),t.setFloat4('vClipPlane',o.normal.x,o.normal.y,o.normal.z,o.d)}return i.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.blendMode===e.BLENDMODE_ONEONE?i.setAlphaMode(d.Engine.ALPHA_ONEONE):i.setAlphaMode(d.Engine.ALPHA_COMBINE),this.forceDepthWrite&&i.setDepthWrite(!0),i.drawElementsType(d.Material.TriangleFillMode,0,6*this._particles.length),i.setAlphaMode(d.Engine.ALPHA_DISABLE),this._particles.length},e.prototype.dispose=function(r){void 0===r&&(r=!0),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),r&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),this._removeFromRoot();var e=this._scene.particleSystems.indexOf(this);-1<e&&this._scene.particleSystems.splice(e,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e.prototype.createSphereEmitter=function(e){void 0===e&&(e=1);var t=new d.SphereParticleEmitter(e);return this.particleEmitterType=t,t},e.prototype.createDirectedSphereEmitter=function(e,t,o){void 0===e&&(e=1),void 0===t&&(t=new d.Vector3(0,1,0)),void 0===o&&(o=new d.Vector3(0,1,0));var r=new d.SphereDirectedParticleEmitter(e,t,o);return this.particleEmitterType=r,r},e.prototype.createConeEmitter=function(e,t){void 0===e&&(e=1),void 0===t&&(t=V/4);var o=new d.ConeParticleEmitter(e,t);return this.particleEmitterType=o,o},e.prototype.createBoxEmitter=function(e,t,i,r){var a=new d.BoxParticleEmitter;return this.particleEmitterType=a,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,a},e.prototype.clone=function(t,i){var r=null,n=null;if(null!=this.customShader){n=this.customShader;var o=0<n.shaderOptions.defines.length?n.shaderOptions.defines.join('\n'):'';r=this._scene.getEngine().createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,o)}var s=new e(t,this._capacity,this._scene,r);return s.customShader=n,d.Tools.DeepCopy(this,s,['particles','customShader']),void 0===i&&(i=this.emitter),s.emitter=i,this.particleTexture&&(s.particleTexture=new d.Texture(this.particleTexture.url,this._scene)),this.preventAutoStart||s.start(),s},e.prototype.serialize=function(){var e={};if(e.name=this.name,e.id=this.id,this.emitter.position){var t=this.emitter;e.emitterId=t.id}else{var o=this.emitter;e.emitter=o.asArray()}return e.capacity=this.getCapacity(),this.particleTexture&&(e.textureName=this.particleTexture.name),d.Animation.AppendSerializedAnimations(this,e),e.minAngularSpeed=this.minAngularSpeed,e.maxAngularSpeed=this.maxAngularSpeed,e.minSize=this.minSize,e.maxSize=this.maxSize,e.minEmitPower=this.minEmitPower,e.maxEmitPower=this.maxEmitPower,e.minLifeTime=this.minLifeTime,e.maxLifeTime=this.maxLifeTime,e.emitRate=this.emitRate,e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e.gravity=this.gravity.asArray(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.color1=this.color1.asArray(),e.color2=this.color2.asArray(),e.colorDead=this.colorDead.asArray(),e.updateSpeed=this.updateSpeed,e.targetStopDuration=this.targetStopDuration,e.textureMask=this.textureMask.asArray(),e.blendMode=this.blendMode,e.customShader=this.customShader,e.preventAutoStart=this.preventAutoStart,e.startSpriteCellID=this.startSpriteCellID,e.endSpriteCellID=this.endSpriteCellID,e.spriteCellLoop=this.spriteCellLoop,e.spriteCellChangeSpeed=this.spriteCellChangeSpeed,e.spriteCellWidth=this.spriteCellWidth,e.spriteCellHeight=this.spriteCellHeight,e.isAnimationSheetEnabled=this._isAnimationSheetEnabled,this.particleEmitterType&&(e.particleEmitterType=this.particleEmitterType.serialize()),e},e.Parse=function(t,i,r){var n=t.name,o=null,s=null;if(t.customShader){s=t.customShader;var a=0<s.shaderOptions.defines.length?s.shaderOptions.defines.join('\n'):'';o=i.getEngine().createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,a)}var l=new e(n,t.capacity,i,o,t.isAnimationSheetEnabled);if(l.customShader=s,t.id&&(l.id=t.id),t.preventAutoStart&&(l.preventAutoStart=t.preventAutoStart),t.textureName&&(l.particleTexture=new d.Texture(r+t.textureName,i),l.particleTexture.name=t.textureName),l.emitter=t.emitterId?i.getLastMeshByID(t.emitterId):d.Vector3.FromArray(t.emitter),t.animations)for(var p=0,c;p<t.animations.length;p++)c=t.animations[p],l.animations.push(d.Animation.Parse(c));return t.autoAnimate&&i.beginAnimation(l,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),l.minAngularSpeed=t.minAngularSpeed,l.maxAngularSpeed=t.maxAngularSpeed,l.minSize=t.minSize,l.maxSize=t.maxSize,l.minLifeTime=t.minLifeTime,l.maxLifeTime=t.maxLifeTime,l.minEmitPower=t.minEmitPower,l.maxEmitPower=t.maxEmitPower,l.emitRate=t.emitRate,l.minEmitBox=d.Vector3.FromArray(t.minEmitBox),l.maxEmitBox=d.Vector3.FromArray(t.maxEmitBox),l.gravity=d.Vector3.FromArray(t.gravity),l.direction1=d.Vector3.FromArray(t.direction1),l.direction2=d.Vector3.FromArray(t.direction2),l.color1=d.Color4.FromArray(t.color1),l.color2=d.Color4.FromArray(t.color2),l.colorDead=d.Color4.FromArray(t.colorDead),l.updateSpeed=t.updateSpeed,l.targetStopDuration=t.targetStopDuration,l.textureMask=d.Color4.FromArray(t.textureMask),l.blendMode=t.blendMode,l.startSpriteCellID=t.startSpriteCellID,l.endSpriteCellID=t.endSpriteCellID,l.spriteCellLoop=t.spriteCellLoop,l.spriteCellChangeSpeed=t.spriteCellChangeSpeed,l.spriteCellWidth=t.spriteCellWidth,l.spriteCellHeight=t.spriteCellHeight,l.preventAutoStart||l.start(),l},e.BLENDMODE_ONEONE=0,e.BLENDMODE_STANDARD=1,e}();d.ParticleSystem=e}(e||(e={}));var e;!function(l){var e=function(){function e(){this.direction1=new l.Vector3(0,1,0),this.direction2=new l.Vector3(0,1,0),this.minEmitBox=new l.Vector3(-.5,-.5,-.5),this.maxEmitBox=new l.Vector3(.5,.5,.5)}return e.prototype.startDirectionFunction=function(e,t,i){var r=l.Scalar.RandomRange(this.direction1.x,this.direction2.x),o=l.Scalar.RandomRange(this.direction1.y,this.direction2.y),n=l.Scalar.RandomRange(this.direction1.z,this.direction2.z);l.Vector3.TransformNormalFromFloatsToRef(r*e,o*e,n*e,t,i)},e.prototype.startPositionFunction=function(e,t){var r=l.Scalar.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),i=l.Scalar.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=l.Scalar.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);l.Vector3.TransformCoordinatesFromFloatsToRef(r,i,o,e,t)},e.prototype.clone=function(){var t=new e;return l.Tools.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setVector3('direction1',this.direction1),t.setVector3('direction2',this.direction2),t.setVector3('minEmitBox',this.minEmitBox),t.setVector3('maxEmitBox',this.maxEmitBox)},e.prototype.getEffectDefines=function(){return'#define BOXEMITTER'},e.prototype.getClassName=function(){return'BoxEmitter'},e.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t},e.prototype.parse=function(t){this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2),this.minEmitBox.copyFrom(t.minEmitBox),this.maxEmitBox.copyFrom(t.maxEmitBox)},e}();l.BoxParticleEmitter=e}(e||(e={}));var e;!function(d){var e=function(){function e(r,e,o){void 0===r&&(r=1),void 0===e&&(e=V),void 0===o&&(o=0),this.angle=e,this.directionRandomizer=o,this.radius=r}return Object.defineProperty(e.prototype,'radius',{get:function(){return this._radius},set:function(t){this._radius=t,this._height=0===this.angle?1:t/y(this.angle/2)},enumerable:!0,configurable:!0}),e.prototype.startDirectionFunction=function(e,t,i,r){if(0===this.angle)d.Vector3.TransformNormalFromFloatsToRef(0,e,0,t,i);else{var n=r.position.subtract(t.getTranslation()).normalize(),o=d.Scalar.RandomRange(0,this.directionRandomizer),s=d.Scalar.RandomRange(0,this.directionRandomizer),a=d.Scalar.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=s,n.z+=a,n.normalize(),d.Vector3.TransformNormalFromFloatsToRef(n.x*e,n.y*e,n.z*e,t,i)}},e.prototype.startPositionFunction=function(e,t){var r=d.Scalar.RandomRange(0,2*V),i=d.Scalar.RandomRange(0,1);i=1-i*i;var o=d.Scalar.RandomRange(0,this._radius);o*=i;var n=o*B(r),a=o*F(r),s=i*this._height;d.Vector3.TransformCoordinatesFromFloatsToRef(n,s,a,e,t)},e.prototype.clone=function(){var t=new e(this.radius,this.angle,this.directionRandomizer);return d.Tools.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat('radius',this.radius),t.setFloat('angle',this.angle),t.setFloat('height',this._height),t.setFloat('directionRandomizer',this.directionRandomizer)},e.prototype.getEffectDefines=function(){return'#define CONEEMITTER'},e.prototype.getClassName=function(){return'ConeEmitter'},e.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.angle=this.angle,t.directionRandomizer=this.directionRandomizer,t},e.prototype.parse=function(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer},e}();d.ConeParticleEmitter=e}(e||(e={}));var e;!function(d){var e=function(){function e(r,e){void 0===r&&(r=1),void 0===e&&(e=0),this.radius=r,this.directionRandomizer=e}return e.prototype.startDirectionFunction=function(e,t,i,r){var n=r.position.subtract(t.getTranslation()).normalize(),o=d.Scalar.RandomRange(0,this.directionRandomizer),s=d.Scalar.RandomRange(0,this.directionRandomizer),a=d.Scalar.RandomRange(0,this.directionRandomizer);n.x+=o,n.y+=s,n.z+=a,n.normalize(),d.Vector3.TransformNormalFromFloatsToRef(n.x*e,n.y*e,n.z*e,t,i)},e.prototype.startPositionFunction=function(e,t){var r=d.Scalar.RandomRange(0,2*V),i=d.Scalar.RandomRange(0,Math.PI),o=d.Scalar.RandomRange(0,this.radius),n=o*F(r)*B(i),a=o*F(i),s=o*B(r)*B(i);d.Vector3.TransformCoordinatesFromFloatsToRef(n,a,s,e,t)},e.prototype.clone=function(){var t=new e(this.radius,this.directionRandomizer);return d.Tools.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat('radius',this.radius),t.setFloat('directionRandomizer',this.directionRandomizer)},e.prototype.getEffectDefines=function(){return'#define SPHEREEMITTER'},e.prototype.getClassName=function(){return'SphereParticleEmitter'},e.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.directionRandomizer=this.directionRandomizer,t},e.prototype.parse=function(t){this.radius=t.radius,this.directionRandomizer=t.directionRandomizer},e}();d.SphereParticleEmitter=e;var t=function(a){function e(e,t,r){void 0===e&&(e=1),void 0===t&&(t=new d.Vector3(0,1,0)),void 0===r&&(r=new d.Vector3(0,1,0));var n=a.call(this,e)||this;return n.direction1=t,n.direction2=r,n}return h(e,a),e.prototype.startDirectionFunction=function(e,t,i){var r=d.Scalar.RandomRange(this.direction1.x,this.direction2.x),o=d.Scalar.RandomRange(this.direction1.y,this.direction2.y),n=d.Scalar.RandomRange(this.direction1.z,this.direction2.z);d.Vector3.TransformNormalFromFloatsToRef(r*e,o*e,n*e,t,i)},e.prototype.clone=function(){var r=new e(this.radius,this.direction1,this.direction2);return d.Tools.DeepCopy(this,r),r},e.prototype.applyToShader=function(t){t.setFloat('radius',this.radius),t.setVector3('direction1',this.direction1),t.setVector3('direction2',this.direction2)},e.prototype.getEffectDefines=function(){return'#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER'},e.prototype.getClassName=function(){return'SphereDirectedParticleEmitter'},e.prototype.serialize=function(){var t=a.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},e.prototype.parse=function(t){a.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},e}(e);d.SphereDirectedParticleEmitter=t}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(d){var e=function(){function e(e,s,i){this.emitter=null,this.renderingGroupId=0,this.layerMask=268435455,this._targetIndex=0,this._currentRenderId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this._attributesStrideSize=14,this._actualFrame=0,this.animations=[],this.onDisposeObservable=new d.Observable,this.updateSpeed=.01,this.targetStopDuration=0,this.blendMode=d.ParticleSystem.BLENDMODE_ONEONE,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.color1=new d.Color4(1,1,1,1),this.color2=new d.Color4(1,1,1,1),this.colorDead=new d.Color4(0,0,0,0),this.emitRate=100,this.gravity=d.Vector3.Zero(),this.minEmitPower=1,this.maxEmitPower=1,this.forceDepthWrite=!1,this.id=e,this.name=e,this._scene=i||d.Engine.LastCreatedScene,this._engine=this._scene.getEngine();var r=b({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},s);this._capacity=r.capacity,this._activeCount=r.capacity,this._currentActiveCount=0,this._scene.particleSystems.push(this),this._updateEffectOptions={attributes:['position','age','life','seed','size','color','direction'],uniformsNames:['currentCount','timeDelta','generalRandoms','emitterWM','lifeTime','color1','color2','sizeRange','gravity','emitPower','direction1','direction2','minEmitBox','maxEmitBox','radius','directionRandomizer','height','angle','stopFactor'],uniformBuffersNames:[],samplers:['randomSampler'],defines:'',fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:['outPosition','outAge','outLife','outSeed','outSize','outColor','outDirection']};for(var n=C(this._engine.getCaps().maxTextureSize,r.randomTextureSize),o=[],a=0;a<n;++a)o.push(Math.random()),o.push(Math.random()),o.push(Math.random()),o.push(Math.random());this._randomTexture=new d.RawTexture(new Float32Array(o),n,1,d.Engine.TEXTUREFORMAT_RGBA32F,this._scene,!1,!1,d.Texture.NEAREST_SAMPLINGMODE,d.Engine.TEXTURETYPE_FLOAT),this._randomTexture.wrapU=d.Texture.WRAP_ADDRESSMODE,this._randomTexture.wrapV=d.Texture.WRAP_ADDRESSMODE,this._randomTextureSize=n,this.particleEmitterType=new d.BoxParticleEmitter}return Object.defineProperty(e,'IsSupported',{get:function(){return!!d.Engine.LastCreatedEngine&&1<d.Engine.LastCreatedEngine.webGLVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'direction1',{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:d.Vector3.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'direction2',{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:d.Vector3.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'minEmitBox',{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:d.Vector3.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'maxEmitBox',{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:d.Vector3.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!0,configurable:!0}),e.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(e.prototype,'activeParticleCount',{get:function(){return this._activeCount},set:function(t){this._activeCount=C(t,this._capacity)},enumerable:!0,configurable:!0}),e.prototype.isReady=function(){return this._updateEffect?!!(this.emitter&&this._updateEffect.isReady()&&this._renderEffect.isReady()&&this.particleTexture&&this.particleTexture.isReady()):(this._recreateUpdateEffect(),this._recreateRenderEffect(),!1)},e.prototype.isStarted=function(){return this._started},e.prototype.start=function(){this._started=!0,this._stopped=!1},e.prototype.stop=function(){this._stopped=!0},e.prototype.reset=function(){this._releaseBuffers(),this._releaseVAOs(),this._currentActiveCount=0,this._targetIndex=0},e.prototype.getClassName=function(){return'GPUParticleSystem'},e.prototype._createUpdateVAO=function(r){var e={position:r.createVertexBuffer('position',0,3),age:r.createVertexBuffer('age',3,1),life:r.createVertexBuffer('life',4,1),seed:r.createVertexBuffer('seed',5,1),size:r.createVertexBuffer('size',6,1),color:r.createVertexBuffer('color',7,4),direction:r.createVertexBuffer('direction',11,3)},t=this._engine.recordVertexArrayObject(e,null,this._updateEffect);return this._engine.bindArrayBuffer(null),t},e.prototype._createRenderVAO=function(o,e){var t={position:o.createVertexBuffer('position',0,3,this._attributesStrideSize,!0),age:o.createVertexBuffer('age',3,1,this._attributesStrideSize,!0),life:o.createVertexBuffer('life',4,1,this._attributesStrideSize,!0),size:o.createVertexBuffer('size',6,1,this._attributesStrideSize,!0),color:o.createVertexBuffer('color',7,4,this._attributesStrideSize,!0),offset:e.createVertexBuffer('offset',0,2),uv:e.createVertexBuffer('uv',2,2)},i=this._engine.recordVertexArrayObject(t,null,this._renderEffect);return this._engine.bindArrayBuffer(null),i},e.prototype._initialize=function(e){if(void 0===e&&(e=!1),!this._buffer0||e){for(var t=this._scene.getEngine(),i=[],r=0;r<this._capacity;r++)i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0);var a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,-.5,-.5,0,0,.5,-.5,1,0]);this._buffer0=new d.Buffer(t,i,!1,this._attributesStrideSize),this._buffer1=new d.Buffer(t,i,!1,this._attributesStrideSize),this._spriteBuffer=new d.Buffer(t,a,!1,4),this._updateVAO=[],this._updateVAO.push(this._createUpdateVAO(this._buffer0)),this._updateVAO.push(this._createUpdateVAO(this._buffer1)),this._renderVAO=[],this._renderVAO.push(this._createRenderVAO(this._buffer1,this._spriteBuffer)),this._renderVAO.push(this._createRenderVAO(this._buffer0,this._spriteBuffer)),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},e.prototype._recreateUpdateEffect=function(){var e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():'';this._updateEffect&&this._updateEffectOptions.defines===e||(this._updateEffectOptions.defines=e,this._updateEffect=new d.Effect('gpuUpdateParticles',this._updateEffectOptions,this._scene.getEngine()))},e.prototype._recreateRenderEffect=function(){var e='';this._scene.clipPlane&&(e='\n#define CLIPPLANE'),this._renderEffect&&this._renderEffect.defines===e||(this._renderEffect=new d.Effect('gpuRenderParticles',['position','age','life','size','color','offset','uv'],['view','projection','colorDead','invView','vClipPlane'],['textureSampler'],this._scene.getEngine(),e))},e.prototype.animate=function(){this._timeDelta=this.updateSpeed*this._scene.getAnimationRatio(),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},e.prototype.render=function(){if(!this._started)return 0;if(this._recreateUpdateEffect(),this._recreateRenderEffect(),!this.isReady())return 0;if(this._currentRenderId===this._scene.getRenderId())return 0;this._currentRenderId=this._scene.getRenderId(),this._initialize(),this._currentActiveCount=C(this._activeCount,0|this._currentActiveCount+this.emitRate*this._timeDelta),this._engine.enableEffect(this._updateEffect),this._engine.setState(!1),this._updateEffect.setFloat('currentCount',this._currentActiveCount),this._updateEffect.setFloat('timeDelta',this._timeDelta),this._updateEffect.setFloat('stopFactor',this._stopped?0:1),this._updateEffect.setFloat3('generalRandoms',Math.random(),Math.random(),Math.random()),this._updateEffect.setTexture('randomSampler',this._randomTexture),this._updateEffect.setFloat2('lifeTime',this.minLifeTime,this.maxLifeTime),this._updateEffect.setFloat2('emitPower',this.minEmitPower,this.maxEmitPower),this._updateEffect.setDirectColor4('color1',this.color1),this._updateEffect.setDirectColor4('color2',this.color2),this._updateEffect.setFloat2('sizeRange',this.minSize,this.maxSize),this._updateEffect.setVector3('gravity',this.gravity),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateEffect);var e;if(this.emitter.position)e=this.emitter.getWorldMatrix();else{var t=this.emitter;e=d.Matrix.Translation(t.x,t.y,t.z)}this._updateEffect.setMatrix('emitterWM',e),this._engine.bindVertexArrayObject(this._updateVAO[this._targetIndex],null),this._engine.bindTransformFeedbackBuffer(this._targetBuffer.getBuffer()),this._engine.setRasterizerState(!1),this._engine.beginTransformFeedback(),this._engine.drawArraysType(d.Material.PointListDrawMode,0,this._currentActiveCount),this._engine.endTransformFeedback(),this._engine.setRasterizerState(!0),this._engine.bindTransformFeedbackBuffer(null),this._engine.enableEffect(this._renderEffect);var i=this._scene.getViewMatrix();if(this._renderEffect.setMatrix('view',i),this._renderEffect.setMatrix('projection',this._scene.getProjectionMatrix()),this._renderEffect.setTexture('textureSampler',this.particleTexture),this._renderEffect.setDirectColor4('colorDead',this.colorDead),this._scene.clipPlane){var r=this._scene.clipPlane,a=i.clone();a.invert(),this._renderEffect.setMatrix('invView',a),this._renderEffect.setFloat4('vClipPlane',r.normal.x,r.normal.y,r.normal.z,r.d)}this.blendMode===d.ParticleSystem.BLENDMODE_ONEONE?this._engine.setAlphaMode(d.Engine.ALPHA_ONEONE):this._engine.setAlphaMode(d.Engine.ALPHA_COMBINE),this.forceDepthWrite&&this._engine.setDepthWrite(!0),this._engine.bindVertexArrayObject(this._renderVAO[this._targetIndex],null),this._engine.drawArraysType(d.Material.TriangleFanDrawMode,0,4,this._currentActiveCount),this._engine.setAlphaMode(d.Engine.ALPHA_DISABLE),2==++this._targetIndex&&(this._targetIndex=0);var o=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=o,this._currentActiveCount},e.prototype.rebuild=function(){this._initialize(!0)},e.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null)},e.prototype._releaseVAOs=function(){if(this._updateVAO){for(var t=0;t<this._updateVAO.length;t++)this._engine.releaseVertexArrayObject(this._updateVAO[t]);this._updateVAO=[];for(var t=0;t<this._renderVAO.length;t++)this._engine.releaseVertexArrayObject(this._renderVAO[t]);this._renderVAO=[]}},e.prototype.dispose=function(r){void 0===r&&(r=!0);var e=this._scene.particleSystems.indexOf(this);-1<e&&this._scene.particleSystems.splice(e,1),this._releaseBuffers(),this._releaseVAOs(),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),r&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e.prototype.clone=function(t,o){var r=new e(t,{capacity:this._capacity,randomTextureSize:this._randomTextureSize},this._scene);return d.Tools.DeepCopy(this,r),void 0===o&&(o=this.emitter),r.emitter=o,this.particleTexture&&(r.particleTexture=new d.Texture(this.particleTexture.url,this._scene)),r},e.prototype.serialize=function(){var e={};if(e.name=this.name,e.id=this.id,this.emitter.position){var t=this.emitter;e.emitterId=t.id}else{var o=this.emitter;e.emitter=o.asArray()}return e.capacity=this.getCapacity(),this.particleTexture&&(e.textureName=this.particleTexture.name),d.Animation.AppendSerializedAnimations(this,e),e.activeParticleCount=this.activeParticleCount,e.randomTextureSize=this._randomTextureSize,e.minSize=this.minSize,e.maxSize=this.maxSize,e.minEmitPower=this.minEmitPower,e.maxEmitPower=this.maxEmitPower,e.minLifeTime=this.minLifeTime,e.maxLifeTime=this.maxLifeTime,e.emitRate=this.emitRate,e.gravity=this.gravity.asArray(),e.color1=this.color1.asArray(),e.color2=this.color2.asArray(),e.colorDead=this.colorDead.asArray(),e.updateSpeed=this.updateSpeed,e.targetStopDuration=this.targetStopDuration,e.blendMode=this.blendMode,this.particleEmitterType&&(e.particleEmitterType=this.particleEmitterType.serialize()),e},e.Parse=function(t,i,r){var n=t.name,o=new e(n,{capacity:t.capacity,randomTextureSize:t.randomTextureSize},i);if(t.id&&(o.id=t.id),t.textureName&&(o.particleTexture=new d.Texture(r+t.textureName,i),o.particleTexture.name=t.textureName),o.emitter=t.emitterId?i.getLastMeshByID(t.emitterId):d.Vector3.FromArray(t.emitter),t.animations)for(var s=0,a;s<t.animations.length;s++)a=t.animations[s],o.animations.push(d.Animation.Parse(a));if(o.activeParticleCount=t.activeParticleCount,o.minSize=t.minSize,o.maxSize=t.maxSize,o.minLifeTime=t.minLifeTime,o.maxLifeTime=t.maxLifeTime,o.minEmitPower=t.minEmitPower,o.maxEmitPower=t.maxEmitPower,o.emitRate=t.emitRate,o.gravity=d.Vector3.FromArray(t.gravity),o.color1=d.Color4.FromArray(t.color1),o.color2=d.Color4.FromArray(t.color2),o.colorDead=d.Color4.FromArray(t.colorDead),o.updateSpeed=t.updateSpeed,o.targetStopDuration=t.targetStopDuration,o.blendMode=t.blendMode,t.particleEmitterType){var l;switch(t.particleEmitterType.type){case'SphereEmitter':l=new d.SphereParticleEmitter;break;case'SphereDirectedParticleEmitter':l=new d.SphereDirectedParticleEmitter;break;case'ConeEmitter':l=new d.ConeParticleEmitter;break;case'BoxEmitter':default:l=new d.BoxParticleEmitter;}l.parse(t.particleEmitterType),o.particleEmitterType=l}return o},e}();d.GPUParticleSystem=e}(e||(e={}));var e;!function(d){var e=function(){function e(e,c,i,r,n,o,s,a){void 0===a&&(a=null),this.idx=0,this.color=new d.Color4(1,1,1,1),this.position=d.Vector3.Zero(),this.rotation=d.Vector3.Zero(),this.scaling=d.Vector3.One(),this.uvs=new d.Vector4(0,0,1,1),this.velocity=d.Vector3.Zero(),this.pivot=d.Vector3.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=d.Vector3.Zero(),this.idx=e,this._pos=c,this._ind=i,this._model=r,this.shapeId=n,this.idxInShape=o,this._sps=s,a&&(this._modelBoundingInfo=a,this._boundingInfo=new d.BoundingInfo(a.minimum,a.maximum))}return Object.defineProperty(e.prototype,'scale',{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'quaternion',{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!0,configurable:!0}),e.prototype.intersectsMesh=function(e){return this._boundingInfo&&e._boundingInfo&&(this._sps._bSphereOnly?d.BoundingSphere.Intersects(this._boundingInfo.boundingSphere,e._boundingInfo.boundingSphere):this._boundingInfo.intersects(e._boundingInfo,!1))},e}();d.SolidParticle=e;var t=function(){function t(a,s,t,i,r,n){this._indicesLength=0,this.shapeID=a,this._shape=s,this._indicesLength=t,this._shapeUV=i,this._positionFunction=r,this._vertexFunction=n}return t}();d.ModelShape=t;var o=function(){return function(){this.ind=0,this.indicesLength=0,this.sqDistance=0}}();d.DepthSortedParticle=o}(e||(e={}));var e;!function(I){var e=function(){function e(e,o,i){this.particles=[],this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!0,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=[],this._indices=[],this._normals=[],this._colors=[],this._uvs=[],this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._shapeCounter=0,this._copy=new I.SolidParticle(0,0,0,null,0,0,this),this._color=new I.Color4(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._cam_axisZ=I.Vector3.Zero(),this._cam_axisY=I.Vector3.Zero(),this._cam_axisX=I.Vector3.Zero(),this._axisZ=I.Axis.Z,this._camDir=I.Vector3.Zero(),this._camInvertedPosition=I.Vector3.Zero(),this._rotMatrix=new I.Matrix,this._invertMatrix=new I.Matrix,this._rotated=I.Vector3.Zero(),this._quaternion=new I.Quaternion,this._vertex=I.Vector3.Zero(),this._normal=I.Vector3.Zero(),this._yaw=0,this._pitch=0,this._roll=0,this._halfroll=0,this._halfpitch=0,this._halfyaw=0,this._sinRoll=0,this._cosRoll=0,this._sinPitch=0,this._cosPitch=0,this._sinYaw=0,this._cosYaw=0,this._mustUnrotateFixedNormals=!1,this._minimum=I.Vector3.Zero(),this._maximum=I.Vector3.Zero(),this._minBbox=I.Vector3.Zero(),this._maxBbox=I.Vector3.Zero(),this._particlesIntersect=!1,this._depthSortFunction=function(r,e){return e.sqDistance-r.sqDistance},this._needs32Bits=!1,this._pivotBackTranslation=I.Vector3.Zero(),this._scaledPivot=I.Vector3.Zero(),this._particleHasParent=!1,this.name=e,this._scene=o||I.Engine.LastCreatedScene,this._camera=o.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._updatable=!(i&&i.updatable)||i.updatable,this._pickable&&(this.pickedParticles=[]),this._depthSort&&(this.depthSortedParticles=[])}return e.prototype.buildMesh=function(){if(0===this.nbParticles){var e=I.MeshBuilder.CreateDisc('',{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),this.recomputeNormals&&I.VertexData.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var t=new I.VertexData;t.indices=this._depthSort?this._indices:this._indices32,t.set(this._positions32,I.VertexBuffer.PositionKind),t.set(this._normals32,I.VertexBuffer.NormalKind),0<this._uvs32.length&&t.set(this._uvs32,I.VertexBuffer.UVKind),0<this._colors32.length&&t.set(this._colors32,I.VertexBuffer.ColorKind);var o=new I.Mesh(this.name,this._scene);return t.applyToMesh(o,this._updatable),this.mesh=o,this.mesh.isPickable=this._pickable,this._depthSort||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0),o},e.prototype.digest=function(e,t){var i=t&&t.facetNb||1,r=t&&t.number||0,n=t&&t.delta||0,o=e.getVerticesData(I.VertexBuffer.PositionKind),s=e.getIndices(),a=e.getVerticesData(I.VertexBuffer.UVKind),l=e.getVerticesData(I.VertexBuffer.ColorKind),h=e.getVerticesData(I.VertexBuffer.NormalKind),c=0,u=s.length/3;r?(r=r>u?u:r,i=O(u/r),n=0):i=i>u?u:i;for(var f=[],d=[],p=[],_=[],m=I.Vector3.Zero(),g=i;c<u;){i=g+ee((1+n)*Math.random()),c>u-i&&(i=u-c),f.length=0,d.length=0,p.length=0,_.length=0;for(var v=0,y=3*c;y<3*(c+i);y++){d.push(v);var b=s[y];f.push(o[3*b],o[3*b+1],o[3*b+2]),a&&p.push(a[2*b],a[2*b+1]),l&&_.push(l[4*b],l[4*b+1],l[4*b+2],l[4*b+3]),v++}var x=this.nbParticles,E=this._posToShape(f),P=this._uvsToShapeUV(p),A;for(A=0;A<E.length;A++)m.addInPlace(E[A]);for(m.scaleInPlace(1/E.length),A=0;A<E.length;A++)E[A].subtractInPlace(m);var T;this._particlesIntersect&&(T=new I.BoundingInfo(m,m));var M=new I.ModelShape(this._shapeCounter,E,3*i,P,null,null),S=this._positions.length,C=this._indices.length;this._meshBuilder(this._index,E,this._positions,d,this._indices,p,this._uvs,_,this._colors,h,this._normals,x,0,null),this._addParticle(x,S,C,M,this._shapeCounter,0,T),this.particles[this.nbParticles].position.addInPlace(m),this._index+=E.length,x++,this.nbParticles++,this._shapeCounter++,c+=i}return this},e.prototype._unrotateFixedNormals=function(){for(var e=0,t=0,o=0;o<this.particles.length;o++){this._particle=this.particles[o],this._shape=this._particle._model._shape,this._particle.rotationQuaternion?this._quaternion.copyFrom(this._particle.rotationQuaternion):(this._yaw=this._particle.rotation.y,this._pitch=this._particle.rotation.x,this._roll=this._particle.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),this._rotMatrix.invertToRef(this._invertMatrix);for(var r=0;r<this._shape.length;r++)t=e+3*r,I.Vector3.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],this._invertMatrix,this._normal),this._fixedNormal32[t]=this._normal.x,this._fixedNormal32[t+1]=this._normal.y,this._fixedNormal32[t+2]=this._normal.z;e=t+3}},e.prototype._resetCopy=function(){this._copy.position.x=0,this._copy.position.y=0,this._copy.position.z=0,this._copy.rotation.x=0,this._copy.rotation.y=0,this._copy.rotation.z=0,this._copy.rotationQuaternion=null,this._copy.scaling.x=1,this._copy.scaling.y=1,this._copy.scaling.z=1,this._copy.uvs.x=0,this._copy.uvs.y=0,this._copy.uvs.z=1,this._copy.uvs.w=1,this._copy.color=null,this._copy.translateFromPivot=!1},e.prototype._meshBuilder=function(e,t,i,r,n,o,s,a,l,h,c,u,T,d){var p=0,m=0,g=0,x;for(this._resetCopy(),d&&d.positionFunction&&(d.positionFunction(this._copy,u,T),this._mustUnrotateFixedNormals=!0),this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),this._scaledPivot.x=this._copy.pivot.x*this._copy.scaling.x,this._scaledPivot.y=this._copy.pivot.y*this._copy.scaling.y,this._scaledPivot.z=this._copy.pivot.z*this._copy.scaling.z,this._copy.translateFromPivot?this._pivotBackTranslation.copyFromFloats(0,0,0):this._pivotBackTranslation.copyFrom(this._scaledPivot),x=0;x<t.length;x++)this._vertex.x=t[x].x,this._vertex.y=t[x].y,this._vertex.z=t[x].z,d&&d.vertexFunction&&d.vertexFunction(this._copy,this._vertex,x),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,this._vertex.x-=this._scaledPivot.x,this._vertex.y-=this._scaledPivot.y,this._vertex.z-=this._scaledPivot.z,I.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),this._rotated.addInPlace(this._pivotBackTranslation),i.push(this._copy.position.x+this._rotated.x,this._copy.position.y+this._rotated.y,this._copy.position.z+this._rotated.z),o&&(s.push((this._copy.uvs.z-this._copy.uvs.x)*o[p]+this._copy.uvs.x,(this._copy.uvs.w-this._copy.uvs.y)*o[p+1]+this._copy.uvs.y),p+=2),this._copy.color?this._color=this._copy.color:a&&void 0!==a[m]?(this._color.r=a[m],this._color.g=a[m+1],this._color.b=a[m+2],this._color.a=a[m+3]):(this._color.r=1,this._color.g=1,this._color.b=1,this._color.a=1),l.push(this._color.r,this._color.g,this._color.b,this._color.a),m+=4,!this.recomputeNormals&&h&&(this._normal.x=h[g],this._normal.y=h[g+1],this._normal.z=h[g+2],I.Vector3.TransformNormalToRef(this._normal,this._rotMatrix,this._normal),c.push(this._normal.x,this._normal.y,this._normal.z),g+=3);for(x=0;x<r.length;x++){var E=e+r[x];n.push(E),65535<E&&(this._needs32Bits=!0)}if(this._pickable){var y=r.length/3;for(x=0;x<y;x++)this.pickedParticles.push({idx:u,faceId:x})}return this._depthSort&&this.depthSortedParticles.push(new I.DepthSortedParticle),this._copy},e.prototype._posToShape=function(e){for(var t=[],o=0;o<e.length;o+=3)t.push(new I.Vector3(e[o],e[o+1],e[o+2]));return t},e.prototype._uvsToShapeUV=function(r){var e=[];if(r)for(var t=0;t<r.length;t++)e.push(r[t]);return e},e.prototype._addParticle=function(e,t,i,r,n,o,s){void 0===s&&(s=null);var a=new I.SolidParticle(e,t,i,r,n,o,this,s);return this.particles.push(a),a},e.prototype.addShape=function(e,t,i){var r=e.getVerticesData(I.VertexBuffer.PositionKind),o=e.getIndices(),s=e.getVerticesData(I.VertexBuffer.UVKind),a=e.getVerticesData(I.VertexBuffer.ColorKind),l=e.getVerticesData(I.VertexBuffer.NormalKind),h;this._particlesIntersect&&(h=e.getBoundingInfo());for(var n=this._posToShape(r),f=this._uvsToShapeUV(s),d=i?i.positionFunction:null,p=i?i.vertexFunction:null,_=new I.ModelShape(this._shapeCounter,n,o.length,f,d,p),m=this.nbParticles,g=0,T,c;g<t;g++){var u=this._positions.length,y=this._indices.length;c=this._meshBuilder(this._index,n,this._positions,o,this._indices,s,this._uvs,a,this._colors,l,this._normals,m,g,i),this._updatable&&(T=this._addParticle(m,u,y,_,this._shapeCounter,g,h),T.position.copyFrom(c.position),T.rotation.copyFrom(c.rotation),c.rotationQuaternion&&T.rotationQuaternion&&T.rotationQuaternion.copyFrom(c.rotationQuaternion),c.color&&T.color&&T.color.copyFrom(c.color),T.scaling.copyFrom(c.scaling),T.uvs.copyFrom(c.uvs)),this._index+=n.length,m++}return this.nbParticles+=t,++this._shapeCounter-1},e.prototype._rebuildParticle=function(e){this._resetCopy(),e._model._positionFunction&&e._model._positionFunction(this._copy,e.idx,e.idxInShape),this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),this._scaledPivot.x=this._particle.pivot.x*this._particle.scaling.x,this._scaledPivot.y=this._particle.pivot.y*this._particle.scaling.y,this._scaledPivot.z=this._particle.pivot.z*this._particle.scaling.z,this._copy.translateFromPivot?this._pivotBackTranslation.copyFromFloats(0,0,0):this._pivotBackTranslation.copyFrom(this._scaledPivot),this._shape=e._model._shape;for(var t=0;t<this._shape.length;t++)this._vertex.x=this._shape[t].x,this._vertex.y=this._shape[t].y,this._vertex.z=this._shape[t].z,e._model._vertexFunction&&e._model._vertexFunction(this._copy,this._vertex,t),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,this._vertex.x-=this._scaledPivot.x,this._vertex.y-=this._scaledPivot.y,this._vertex.z-=this._scaledPivot.z,I.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),this._rotated.addInPlace(this._pivotBackTranslation),this._positions32[e._pos+3*t]=this._copy.position.x+this._rotated.x,this._positions32[e._pos+3*t+1]=this._copy.position.y+this._rotated.y,this._positions32[e._pos+3*t+2]=this._copy.position.z+this._rotated.z;e.position.x=0,e.position.y=0,e.position.z=0,e.rotation.x=0,e.rotation.y=0,e.rotation.z=0,e.rotationQuaternion=null,e.scaling.x=1,e.scaling.y=1,e.scaling.z=1,e.uvs.x=0,e.uvs.y=0,e.uvs.z=1,e.uvs.w=1,e.pivot.x=0,e.pivot.y=0,e.pivot.z=0,e.translateFromPivot=!1,e.parentId=null},e.prototype.rebuildMesh=function(){for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e]);return this.mesh.updateVerticesData(I.VertexBuffer.PositionKind,this._positions32,!1,!1),this},e.prototype.setParticles=function(e,t,i){if(void 0===e&&(e=0),void 0===t&&(t=this.nbParticles-1),void 0===i&&(i=!0),!this._updatable)return this;if(this.beforeUpdateParticles(e,t,i),this._cam_axisX.x=1,this._cam_axisX.y=0,this._cam_axisX.z=0,this._cam_axisY.x=0,this._cam_axisY.y=1,this._cam_axisY.z=0,this._cam_axisZ.x=0,this._cam_axisZ.y=0,this._cam_axisZ.z=1,(this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(this._invertMatrix)),this.billboard){this._camera.getDirectionToRef(this._axisZ,this._camDir),I.Vector3.TransformNormalToRef(this._camDir,this._invertMatrix,this._cam_axisZ),this._cam_axisZ.normalize();var r=this._camera.getViewMatrix(!0);I.Vector3.TransformNormalFromFloatsToRef(r.m[1],r.m[5],r.m[9],this._invertMatrix,this._cam_axisY),I.Vector3.CrossToRef(this._cam_axisY,this._cam_axisZ,this._cam_axisX),this._cam_axisY.normalize(),this._cam_axisX.normalize()}this._depthSort&&I.Vector3.TransformCoordinatesToRef(this._camera.globalPosition,this._invertMatrix,this._camInvertedPosition),I.Matrix.IdentityToRef(this._rotMatrix);var n=0,o=0,s=0,a=0,l=0,h=0,c=0;this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0==e&&t==this.nbParticles-1?(I.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this._minimum),I.Vector3.FromFloatsToRef(-S,-S,-S,this._maximum)):this.mesh._boundingInfo&&(this._minimum.copyFrom(this.mesh._boundingInfo.boundingBox.minimum),this._maximum.copyFrom(this.mesh._boundingInfo.boundingBox.maximum))),o=this.particles[e]._pos;var u=0|o/3;a=4*u,h=2*u;for(var f=e;f<=t;f++){if(this._particle=this.particles[f],this._shape=this._particle._model._shape,this._shapeUV=this._particle._model._shapeUV,this.updateParticle(this._particle),this._depthSort&&this._depthSortParticles){var d=this.depthSortedParticles[f];d.ind=this._particle._ind,d.indicesLength=this._particle._model._indicesLength,d.sqDistance=I.Vector3.DistanceSquared(this._particle.position,this._camInvertedPosition)}if(!this._particle.alive||this._particle._stillInvisible&&!this._particle.isVisible)c=this._shape.length,o+=3*c,a+=4*c,h+=2*c;else{if(this._particle.isVisible)for(this._particle._stillInvisible=!1,this._particleHasParent=null!==this._particle.parentId,this._scaledPivot.x=this._particle.pivot.x*this._particle.scaling.x,this._scaledPivot.y=this._particle.pivot.y*this._particle.scaling.y,this._scaledPivot.z=this._particle.pivot.z*this._particle.scaling.z,this.billboard&&(this._particle.rotation.x=0,this._particle.rotation.y=0),(this._computeParticleRotation||this.billboard)&&(this._particle.rotationQuaternion?this._quaternion.copyFrom(this._particle.rotationQuaternion):(this._yaw=this._particle.rotation.y,this._pitch=this._particle.rotation.x,this._roll=this._particle.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix()),this._particleHasParent?(this._parent=this.particles[this._particle.parentId],this._rotated.x=this._particle.position.x*this._parent._rotationMatrix[0]+this._particle.position.y*this._parent._rotationMatrix[3]+this._particle.position.z*this._parent._rotationMatrix[6],this._rotated.y=this._particle.position.x*this._parent._rotationMatrix[1]+this._particle.position.y*this._parent._rotationMatrix[4]+this._particle.position.z*this._parent._rotationMatrix[7],this._rotated.z=this._particle.position.x*this._parent._rotationMatrix[2]+this._particle.position.y*this._parent._rotationMatrix[5]+this._particle.position.z*this._parent._rotationMatrix[8],this._particle._globalPosition.x=this._parent._globalPosition.x+this._rotated.x,this._particle._globalPosition.y=this._parent._globalPosition.y+this._rotated.y,this._particle._globalPosition.z=this._parent._globalPosition.z+this._rotated.z,(this._computeParticleRotation||this.billboard)&&(this._particle._rotationMatrix[0]=this._rotMatrix.m[0]*this._parent._rotationMatrix[0]+this._rotMatrix.m[1]*this._parent._rotationMatrix[3]+this._rotMatrix.m[2]*this._parent._rotationMatrix[6],this._particle._rotationMatrix[1]=this._rotMatrix.m[0]*this._parent._rotationMatrix[1]+this._rotMatrix.m[1]*this._parent._rotationMatrix[4]+this._rotMatrix.m[2]*this._parent._rotationMatrix[7],this._particle._rotationMatrix[2]=this._rotMatrix.m[0]*this._parent._rotationMatrix[2]+this._rotMatrix.m[1]*this._parent._rotationMatrix[5]+this._rotMatrix.m[2]*this._parent._rotationMatrix[8],this._particle._rotationMatrix[3]=this._rotMatrix.m[4]*this._parent._rotationMatrix[0]+this._rotMatrix.m[5]*this._parent._rotationMatrix[3]+this._rotMatrix.m[6]*this._parent._rotationMatrix[6],this._particle._rotationMatrix[4]=this._rotMatrix.m[4]*this._parent._rotationMatrix[1]+this._rotMatrix.m[5]*this._parent._rotationMatrix[4]+this._rotMatrix.m[6]*this._parent._rotationMatrix[7],this._particle._rotationMatrix[5]=this._rotMatrix.m[4]*this._parent._rotationMatrix[2]+this._rotMatrix.m[5]*this._parent._rotationMatrix[5]+this._rotMatrix.m[6]*this._parent._rotationMatrix[8],this._particle._rotationMatrix[6]=this._rotMatrix.m[8]*this._parent._rotationMatrix[0]+this._rotMatrix.m[9]*this._parent._rotationMatrix[3]+this._rotMatrix.m[10]*this._parent._rotationMatrix[6],this._particle._rotationMatrix[7]=this._rotMatrix.m[8]*this._parent._rotationMatrix[1]+this._rotMatrix.m[9]*this._parent._rotationMatrix[4]+this._rotMatrix.m[10]*this._parent._rotationMatrix[7],this._particle._rotationMatrix[8]=this._rotMatrix.m[8]*this._parent._rotationMatrix[2]+this._rotMatrix.m[9]*this._parent._rotationMatrix[5]+this._rotMatrix.m[10]*this._parent._rotationMatrix[8])):(this._particle._globalPosition.x=this._particle.position.x,this._particle._globalPosition.y=this._particle.position.y,this._particle._globalPosition.z=this._particle.position.z,(this._computeParticleRotation||this.billboard)&&(this._particle._rotationMatrix[0]=this._rotMatrix.m[0],this._particle._rotationMatrix[1]=this._rotMatrix.m[1],this._particle._rotationMatrix[2]=this._rotMatrix.m[2],this._particle._rotationMatrix[3]=this._rotMatrix.m[4],this._particle._rotationMatrix[4]=this._rotMatrix.m[5],this._particle._rotationMatrix[5]=this._rotMatrix.m[6],this._particle._rotationMatrix[6]=this._rotMatrix.m[8],this._particle._rotationMatrix[7]=this._rotMatrix.m[9],this._particle._rotationMatrix[8]=this._rotMatrix.m[10])),this._particle.translateFromPivot?(this._pivotBackTranslation.x=0,this._pivotBackTranslation.y=0,this._pivotBackTranslation.z=0):(this._pivotBackTranslation.x=this._scaledPivot.x,this._pivotBackTranslation.y=this._scaledPivot.y,this._pivotBackTranslation.z=this._scaledPivot.z),c=0;c<this._shape.length;c++)n=o+3*c,s=a+4*c,l=h+2*c,this._vertex.x=this._shape[c].x,this._vertex.y=this._shape[c].y,this._vertex.z=this._shape[c].z,this._computeParticleVertex&&this.updateParticleVertex(this._particle,this._vertex,c),this._vertex.x*=this._particle.scaling.x,this._vertex.y*=this._particle.scaling.y,this._vertex.z*=this._particle.scaling.z,this._vertex.x-=this._scaledPivot.x,this._vertex.y-=this._scaledPivot.y,this._vertex.z-=this._scaledPivot.z,this._rotated.x=this._vertex.x*this._particle._rotationMatrix[0]+this._vertex.y*this._particle._rotationMatrix[3]+this._vertex.z*this._particle._rotationMatrix[6],this._rotated.y=this._vertex.x*this._particle._rotationMatrix[1]+this._vertex.y*this._particle._rotationMatrix[4]+this._vertex.z*this._particle._rotationMatrix[7],this._rotated.z=this._vertex.x*this._particle._rotationMatrix[2]+this._vertex.y*this._particle._rotationMatrix[5]+this._vertex.z*this._particle._rotationMatrix[8],this._rotated.x+=this._pivotBackTranslation.x,this._rotated.y+=this._pivotBackTranslation.y,this._rotated.z+=this._pivotBackTranslation.z,this._positions32[n]=this._particle._globalPosition.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._positions32[n+1]=this._particle._globalPosition.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._positions32[n+2]=this._particle._globalPosition.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z,this._computeBoundingBox&&(this._positions32[n]<this._minimum.x&&(this._minimum.x=this._positions32[n]),this._positions32[n]>this._maximum.x&&(this._maximum.x=this._positions32[n]),this._positions32[n+1]<this._minimum.y&&(this._minimum.y=this._positions32[n+1]),this._positions32[n+1]>this._maximum.y&&(this._maximum.y=this._positions32[n+1]),this._positions32[n+2]<this._minimum.z&&(this._minimum.z=this._positions32[n+2]),this._positions32[n+2]>this._maximum.z&&(this._maximum.z=this._positions32[n+2])),this._computeParticleVertex||(this._normal.x=this._fixedNormal32[n],this._normal.y=this._fixedNormal32[n+1],this._normal.z=this._fixedNormal32[n+2],this._rotated.x=this._normal.x*this._particle._rotationMatrix[0]+this._normal.y*this._particle._rotationMatrix[3]+this._normal.z*this._particle._rotationMatrix[6],this._rotated.y=this._normal.x*this._particle._rotationMatrix[1]+this._normal.y*this._particle._rotationMatrix[4]+this._normal.z*this._particle._rotationMatrix[7],this._rotated.z=this._normal.x*this._particle._rotationMatrix[2]+this._normal.y*this._particle._rotationMatrix[5]+this._normal.z*this._particle._rotationMatrix[8],this._normals32[n]=this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._normals32[n+1]=this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._normals32[n+2]=this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z),this._computeParticleColor&&this._particle.color&&(this._colors32[s]=this._particle.color.r,this._colors32[s+1]=this._particle.color.g,this._colors32[s+2]=this._particle.color.b,this._colors32[s+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[l]=this._shapeUV[2*c]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[l+1]=this._shapeUV[2*c+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);else for(this._particle._stillInvisible=!0,c=0;c<this._shape.length;c++)n=o+3*c,s=a+4*c,l=h+2*c,this._positions32[n]=0,this._positions32[n+1]=0,this._positions32[n+2]=0,this._normals32[n]=0,this._normals32[n+1]=0,this._normals32[n+2]=0,this._computeParticleColor&&this._particle.color&&(this._colors32[s]=this._particle.color.r,this._colors32[s+1]=this._particle.color.g,this._colors32[s+2]=this._particle.color.b,this._colors32[s+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[l]=this._shapeUV[2*c]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[l+1]=this._shapeUV[2*c+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);if(this._particlesIntersect){var p=this._particle._boundingInfo,_=p.boundingBox,m=p.boundingSphere;if(!this._bSphereOnly){for(var g=0;g<_.vectors.length;g++)this._vertex.x=this._particle._modelBoundingInfo.boundingBox.vectors[g].x*this._particle.scaling.x,this._vertex.y=this._particle._modelBoundingInfo.boundingBox.vectors[g].y*this._particle.scaling.y,this._vertex.z=this._particle._modelBoundingInfo.boundingBox.vectors[g].z*this._particle.scaling.z,this._rotated.x=this._vertex.x*this._particle._rotationMatrix[0]+this._vertex.y*this._particle._rotationMatrix[3]+this._vertex.z*this._particle._rotationMatrix[6],this._rotated.y=this._vertex.x*this._particle._rotationMatrix[1]+this._vertex.y*this._particle._rotationMatrix[4]+this._vertex.z*this._particle._rotationMatrix[7],this._rotated.z=this._vertex.x*this._particle._rotationMatrix[2]+this._vertex.y*this._particle._rotationMatrix[5]+this._vertex.z*this._particle._rotationMatrix[8],_.vectors[g].x=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,_.vectors[g].y=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,_.vectors[g].z=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z;_._update(this.mesh._worldMatrix)}this._minBbox.x=this._particle._modelBoundingInfo.minimum.x*this._particle.scaling.x,this._minBbox.y=this._particle._modelBoundingInfo.minimum.y*this._particle.scaling.y,this._minBbox.z=this._particle._modelBoundingInfo.minimum.z*this._particle.scaling.z,this._maxBbox.x=this._particle._modelBoundingInfo.maximum.x*this._particle.scaling.x,this._maxBbox.y=this._particle._modelBoundingInfo.maximum.y*this._particle.scaling.y,this._maxBbox.z=this._particle._modelBoundingInfo.maximum.z*this._particle.scaling.z,m.center.x=this._particle._globalPosition.x+.5*(this._minBbox.x+this._maxBbox.x),m.center.y=this._particle._globalPosition.y+.5*(this._minBbox.y+this._maxBbox.y),m.center.z=this._particle._globalPosition.z+.5*(this._minBbox.z+this._maxBbox.z),m.radius=.5*this._bSphereRadiusFactor*$((this._maxBbox.x-this._minBbox.x)*(this._maxBbox.x-this._minBbox.x)+(this._maxBbox.y-this._minBbox.y)*(this._maxBbox.y-this._minBbox.y)+(this._maxBbox.z-this._minBbox.z)*(this._maxBbox.z-this._minBbox.z)),m._update(this.mesh._worldMatrix)}o=n+3,a=s+4,h=l+2}}if(i){if(this._computeParticleColor&&this.mesh.updateVerticesData(I.VertexBuffer.ColorKind,this._colors32,!1,!1),this._computeParticleTexture&&this.mesh.updateVerticesData(I.VertexBuffer.UVKind,this._uvs32,!1,!1),this.mesh.updateVerticesData(I.VertexBuffer.PositionKind,this._positions32,!1,!1),!this.mesh.areNormalsFrozen||this.mesh.isFacetDataEnabled){if(this._computeParticleVertex||this.mesh.isFacetDataEnabled){var v=this.mesh.isFacetDataEnabled?this.mesh.getFacetDataParameters():null;I.VertexData.ComputeNormals(this._positions32,this._indices32,this._normals32,v);for(var y=0;y<this._normals32.length;y++)this._fixedNormal32[y]=this._normals32[y]}this.mesh.areNormalsFrozen||this.mesh.updateVerticesData(I.VertexBuffer.NormalKind,this._normals32,!1,!1)}if(this._depthSort&&this._depthSortParticles){this.depthSortedParticles.sort(this._depthSortFunction);var b=this.depthSortedParticles.length,x=0,T=0,E=0,P=0;for(x=0;x<b;x++){T=this.depthSortedParticles[x].indicesLength,E=this.depthSortedParticles[x].ind;for(var y=0;y<T;y++)this._indices32[P]=this._indices[E+y],P++}this.mesh.updateIndices(this._indices32)}}return this._computeBoundingBox&&(this.mesh._boundingInfo=new I.BoundingInfo(this._minimum,this._maximum),this.mesh._boundingInfo.update(this.mesh._worldMatrix)),this.afterUpdateParticles(e,t,i),this},e.prototype._quaternionRotationYPR=function(){this._halfroll=.5*this._roll,this._halfpitch=.5*this._pitch,this._halfyaw=.5*this._yaw,this._sinRoll=B(this._halfroll),this._cosRoll=F(this._halfroll),this._sinPitch=B(this._halfpitch),this._cosPitch=F(this._halfpitch),this._sinYaw=B(this._halfyaw),this._cosYaw=F(this._halfyaw),this._quaternion.x=this._cosYaw*this._sinPitch*this._cosRoll+this._sinYaw*this._cosPitch*this._sinRoll,this._quaternion.y=this._sinYaw*this._cosPitch*this._cosRoll-this._cosYaw*this._sinPitch*this._sinRoll,this._quaternion.z=this._cosYaw*this._cosPitch*this._sinRoll-this._sinYaw*this._sinPitch*this._cosRoll,this._quaternion.w=this._cosYaw*this._cosPitch*this._cosRoll+this._sinYaw*this._sinPitch*this._sinRoll},e.prototype._quaternionToRotationMatrix=function(){this._rotMatrix.m[0]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.z*this._quaternion.z),this._rotMatrix.m[1]=2*(this._quaternion.x*this._quaternion.y+this._quaternion.z*this._quaternion.w),this._rotMatrix.m[2]=2*(this._quaternion.z*this._quaternion.x-this._quaternion.y*this._quaternion.w),this._rotMatrix.m[3]=0,this._rotMatrix.m[4]=2*(this._quaternion.x*this._quaternion.y-this._quaternion.z*this._quaternion.w),this._rotMatrix.m[5]=1-2*(this._quaternion.z*this._quaternion.z+this._quaternion.x*this._quaternion.x),this._rotMatrix.m[6]=2*(this._quaternion.y*this._quaternion.z+this._quaternion.x*this._quaternion.w),this._rotMatrix.m[7]=0,this._rotMatrix.m[8]=2*(this._quaternion.z*this._quaternion.x+this._quaternion.y*this._quaternion.w),this._rotMatrix.m[9]=2*(this._quaternion.y*this._quaternion.z-this._quaternion.x*this._quaternion.w),this._rotMatrix.m[10]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.x*this._quaternion.x),this._rotMatrix.m[11]=0,this._rotMatrix.m[12]=0,this._rotMatrix.m[13]=0,this._rotMatrix.m[14]=0,this._rotMatrix.m[15]=1},e.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null},e.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},e.prototype.setVisibilityBox=function(e){var t=e/2;this.mesh._boundingInfo=new I.BoundingInfo(new I.Vector3(-t,-t,-t),new I.Vector3(t,t,t))},Object.defineProperty(e.prototype,'isAlwaysVisible',{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isVisibilityBoxLocked',{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t,this.mesh.getBoundingInfo().isLocked=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'computeParticleRotation',{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'computeParticleColor',{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'computeParticleTexture',{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'computeParticleVertex',{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'computeBoundingBox',{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'depthSortParticles',{get:function(){return this._depthSortParticles},set:function(t){this._depthSortParticles=t},enumerable:!0,configurable:!0}),e.prototype.initParticles=function(){},e.prototype.recycleParticle=function(t){return t},e.prototype.updateParticle=function(t){return t},e.prototype.updateParticleVertex=function(r,e){return e},e.prototype.beforeUpdateParticles=function(){},e.prototype.afterUpdateParticles=function(){},e}();I.SolidParticleSystem=e}(e||(e={}));var e;!function(d){var e=function(a){function o(e,t,r,n){var o=a.call(this,e,t)||this;return o._textures={},o._textureArrays={},o._floats={},o._ints={},o._floatsArrays={},o._colors3={},o._colors3Arrays={},o._colors4={},o._vectors2={},o._vectors3={},o._vectors4={},o._matrices={},o._matrices3x3={},o._matrices2x2={},o._vectors2Arrays={},o._vectors3Arrays={},o._cachedWorldViewMatrix=new d.Matrix,o._shaderPath=r,n.needAlphaBlending=n.needAlphaBlending||!1,n.needAlphaTesting=n.needAlphaTesting||!1,n.attributes=n.attributes||['position','normal','uv'],n.uniforms=n.uniforms||['worldViewProjection'],n.uniformBuffers=n.uniformBuffers||[],n.samplers=n.samplers||[],n.defines=n.defines||[],o._options=n,o}return h(o,a),o.prototype.getClassName=function(){return'ShaderMaterial'},o.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},o.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},o.prototype._checkUniform=function(t){-1===this._options.uniforms.indexOf(t)&&this._options.uniforms.push(t)},o.prototype.setTexture=function(r,e){return-1===this._options.samplers.indexOf(r)&&this._options.samplers.push(r),this._textures[r]=e,this},o.prototype.setTextureArray=function(r,e){return-1===this._options.samplers.indexOf(r)&&this._options.samplers.push(r),this._checkUniform(r),this._textureArrays[r]=e,this},o.prototype.setFloat=function(r,e){return this._checkUniform(r),this._floats[r]=e,this},o.prototype.setInt=function(r,e){return this._checkUniform(r),this._ints[r]=e,this},o.prototype.setFloats=function(r,e){return this._checkUniform(r),this._floatsArrays[r]=e,this},o.prototype.setColor3=function(r,e){return this._checkUniform(r),this._colors3[r]=e,this},o.prototype.setColor3Array=function(r,e){return this._checkUniform(r),this._colors3Arrays[r]=e.reduce(function(r,e){return e.toArray(r,r.length),r},[]),this},o.prototype.setColor4=function(r,e){return this._checkUniform(r),this._colors4[r]=e,this},o.prototype.setVector2=function(r,e){return this._checkUniform(r),this._vectors2[r]=e,this},o.prototype.setVector3=function(r,e){return this._checkUniform(r),this._vectors3[r]=e,this},o.prototype.setVector4=function(r,e){return this._checkUniform(r),this._vectors4[r]=e,this},o.prototype.setMatrix=function(r,e){return this._checkUniform(r),this._matrices[r]=e,this},o.prototype.setMatrix3x3=function(r,e){return this._checkUniform(r),this._matrices3x3[r]=e,this},o.prototype.setMatrix2x2=function(r,e){return this._checkUniform(r),this._matrices2x2[r]=e,this},o.prototype.setArray2=function(r,e){return this._checkUniform(r),this._vectors2Arrays[r]=e,this},o.prototype.setArray3=function(r,e){return this._checkUniform(r),this._vectors3Arrays[r]=e,this},o.prototype._checkCache=function(r,e){return!e||(this._effect&&this._effect.defines.indexOf('#define INSTANCES'),!1)},o.prototype.isReady=function(e,t){var i=this.getScene(),r=i.getEngine();if(!this.checkReadyOnEveryCall&&this._renderId===i.getRenderId()&&this._checkCache(i,e,t))return!0;var n=[],o=[],p=new d.EffectFallbacks;t&&n.push('#define INSTANCES');for(var f=0;f<this._options.defines.length;f++)n.push(this._options.defines[f]);for(var f=0;f<this._options.attributes.length;f++)o.push(this._options.attributes[f]);for(var l in e&&e.isVerticesDataPresent(d.VertexBuffer.ColorKind)&&(o.push(d.VertexBuffer.ColorKind),n.push('#define VERTEXCOLOR')),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton?(o.push(d.VertexBuffer.MatricesIndicesKind),o.push(d.VertexBuffer.MatricesWeightsKind),4<e.numBoneInfluencers&&(o.push(d.VertexBuffer.MatricesIndicesExtraKind),o.push(d.VertexBuffer.MatricesWeightsExtraKind)),n.push('#define NUM_BONE_INFLUENCERS '+e.numBoneInfluencers),n.push('#define BonesPerMesh '+(e.skeleton.bones.length+1)),p.addCPUSkinningFallback(0,e),-1===this._options.uniforms.indexOf('mBones')&&this._options.uniforms.push('mBones')):n.push('#define NUM_BONE_INFLUENCERS 0'),this._textures)if(!this._textures[l].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&n.push('#define ALPHATEST');var _=this._effect,c=n.join('\n');return this._effect=r.createEffect(this._shaderPath,{attributes:o,uniformsNames:this._options.uniforms,uniformBuffersNames:this._options.uniformBuffers,samplers:this._options.samplers,defines:c,fallbacks:p,onCompiled:this.onCompiled,onError:this.onError},r),!!this._effect.isReady()&&(_!==this._effect&&i.resetCachedMaterial(),this._renderId=i.getRenderId(),!0)},o.prototype.bindOnlyWorldMatrix=function(r){var e=this.getScene();this._effect&&(-1!==this._options.uniforms.indexOf('world')&&this._effect.setMatrix('world',r),-1!==this._options.uniforms.indexOf('worldView')&&(r.multiplyToRef(e.getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix('worldView',this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf('worldViewProjection')&&this._effect.setMatrix('worldViewProjection',r.multiply(e.getTransformMatrix())))},o.prototype.bind=function(e,t){if(this.bindOnlyWorldMatrix(e),this._effect&&this.getScene().getCachedMaterial()!==this){-1!==this._options.uniforms.indexOf('view')&&this._effect.setMatrix('view',this.getScene().getViewMatrix()),-1!==this._options.uniforms.indexOf('projection')&&this._effect.setMatrix('projection',this.getScene().getProjectionMatrix()),-1!==this._options.uniforms.indexOf('viewProjection')&&this._effect.setMatrix('viewProjection',this.getScene().getTransformMatrix()),d.MaterialHelper.BindBonesParameters(t,this._effect);for(var o in this._textures)this._effect.setTexture(o,this._textures[o]);for(o in this._textureArrays)this._effect.setTextureArray(o,this._textureArrays[o]);for(o in this._ints)this._effect.setInt(o,this._ints[o]);for(o in this._floats)this._effect.setFloat(o,this._floats[o]);for(o in this._floatsArrays)this._effect.setArray(o,this._floatsArrays[o]);for(o in this._colors3)this._effect.setColor3(o,this._colors3[o]);for(o in this._colors3Arrays)this._effect.setArray3(o,this._colors3Arrays[o]);for(o in this._colors4){var r=this._colors4[o];this._effect.setFloat4(o,r.r,r.g,r.b,r.a)}for(o in this._vectors2)this._effect.setVector2(o,this._vectors2[o]);for(o in this._vectors3)this._effect.setVector3(o,this._vectors3[o]);for(o in this._vectors4)this._effect.setVector4(o,this._vectors4[o]);for(o in this._matrices)this._effect.setMatrix(o,this._matrices[o]);for(o in this._matrices3x3)this._effect.setMatrix3x3(o,this._matrices3x3[o]);for(o in this._matrices2x2)this._effect.setMatrix2x2(o,this._matrices2x2[o]);for(o in this._vectors2Arrays)this._effect.setArray2(o,this._vectors2Arrays[o]);for(o in this._vectors3Arrays)this._effect.setArray3(o,this._vectors3Arrays[o])}this._afterBind(t)},o.prototype.getActiveTextures=function(){var t=a.prototype.getActiveTextures.call(this);for(var e in this._textures)t.push(this._textures[e]);for(var e in this._textureArrays)for(var o=this._textureArrays[e],r=0;r<o.length;r++)t.push(o[r]);return t},o.prototype.hasTexture=function(t){if(a.prototype.hasTexture.call(this,t))return!0;for(var e in this._textures)if(this._textures[e]===t)return!0;for(var e in this._textureArrays)for(var o=this._textureArrays[e],r=0;r<o.length;r++)if(o[r]===t)return!0;return!1},o.prototype.clone=function(t){return new o(t,this.getScene(),this._shaderPath,this._options)},o.prototype.dispose=function(t,e){if(e){for(var i in this._textures)this._textures[i].dispose();for(i in this._textureArrays)for(var r=this._textureArrays[i],n=0;n<r.length;n++)r[n].dispose()}this._textures={},a.prototype.dispose.call(this,t,e)},o.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);e.customType='BABYLON.ShaderMaterial',e.options=this._options,e.shaderPath=this._shaderPath;for(var t in e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];for(var o=this._textureArrays[t],r=0;r<o.length;r++)e.textureArrays[t].push(o[r].serialize())}for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.FloatArrays={},this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];return e},o.Parse=function(e,t,r){var i=d.SerializationHelper.Parse(function(){return new o(e.name,t,e.shaderPath,e.options)},e,t,r),n;for(n in e.textures)i.setTexture(n,d.Texture.Parse(e.textures[n],t,r));for(n in e.textureArrays){for(var o=e.textureArrays[n],a=[],s=0;s<o.length;s++)a.push(d.Texture.Parse(o[s],t,r));i.setTextureArray(n,a)}for(n in e.floats)i.setFloat(n,e.floats[n]);for(n in e.floatsArrays)i.setFloats(n,e.floatsArrays[n]);for(n in e.colors3)i.setColor3(n,d.Color3.FromArray(e.colors3[n]));for(n in e.colors3Arrays){var l=e.colors3Arrays[n].reduce(function(r,e,t){return 0==t%3?r.push([e]):r[r.length-1].push(e),r},[]).map(function(e){return d.Color3.FromArray(e)});i.setColor3Array(n,l)}for(n in e.colors4)i.setColor4(n,d.Color4.FromArray(e.colors4[n]));for(n in e.vectors2)i.setVector2(n,d.Vector2.FromArray(e.vectors2[n]));for(n in e.vectors3)i.setVector3(n,d.Vector3.FromArray(e.vectors3[n]));for(n in e.vectors4)i.setVector4(n,d.Vector4.FromArray(e.vectors4[n]));for(n in e.matrices)i.setMatrix(n,d.Matrix.FromArray(e.matrices[n]));for(n in e.matrices3x3)i.setMatrix3x3(n,e.matrices3x3[n]);for(n in e.matrices2x2)i.setMatrix2x2(n,e.matrices2x2[n]);for(n in e.vectors2Arrays)i.setArray2(n,e.vectors2Arrays[n]);for(n in e.vectors3Arrays)i.setArray3(n,e.vectors3Arrays[n]);return i},o}(d.Material);d.ShaderMaterial=e}(e||(e={}));var e;!function(E){var e=function(o){function a(t,e){var a=o.call(this,t,e)||this;return a.generateOctree=!1,a}return h(a,o),a.prototype.getClassName=function(){return'GroundMesh'},Object.defineProperty(a.prototype,'subdivisions',{get:function(){return C(this._subdivisionsX,this._subdivisionsY)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'subdivisionsX',{get:function(){return this._subdivisionsX},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'subdivisionsY',{get:function(){return this._subdivisionsY},enumerable:!0,configurable:!0}),a.prototype.optimize=function(r,e){void 0===e&&(e=32),this._subdivisionsX=r,this._subdivisionsY=r,this.subdivide(r),this.createOrUpdateSubmeshesOctree(e)},a.prototype.getHeightAtCoordinates=function(e,t){var i=this.getWorldMatrix(),r=E.Tmp.Matrix[5];i.invertToRef(r);var n=E.Tmp.Vector3[8];if(E.Vector3.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var o=this._getFacetAt(e,t),s=-(o.x*e+o.z*t+o.w)/o.y;return E.Vector3.TransformCoordinatesFromFloatsToRef(0,s,0,i,n),n.y},a.prototype.getNormalAtCoordinates=function(e,t){var o=new E.Vector3(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,o),o},a.prototype.getNormalAtCoordinatesToRef=function(e,t,i){var r=this.getWorldMatrix(),n=E.Tmp.Matrix[5];r.invertToRef(n);var o=E.Tmp.Vector3[8];if(E.Vector3.TransformCoordinatesFromFloatsToRef(e,0,t,n,o),e=o.x,t=o.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var s=this._getFacetAt(e,t);return E.Vector3.TransformNormalFromFloatsToRef(s.x,s.y,s.z,r,i),this},a.prototype.updateCoordinateHeights=function(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this},a.prototype._getFacetAt=function(o,e){var t=ee((o+this._maxX)*this._subdivisionsX/this._width),i=ee(-(e+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[i*this._subdivisionsX+t];return e<r.slope.x*o+r.slope.y?r.facet1:r.facet2},a.prototype._initHeightQuads=function(){var e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=[];for(var i=0;i<t;i++)for(var r=0,a;r<e;r++)a={slope:E.Vector2.Zero(),facet1:new E.Vector4(0,0,0,0),facet2:new E.Vector4(0,0,0,0)},this._heightQuads[i*e+r]=a;return this},a.prototype._computeHeightQuads=function(){var e=this.getVerticesData(E.VertexBuffer.PositionKind);if(!e)return this;for(var P=E.Tmp.Vector3[3],i=E.Tmp.Vector3[2],r=E.Tmp.Vector3[1],n=E.Tmp.Vector3[0],o=E.Tmp.Vector3[4],s=E.Tmp.Vector3[5],a=E.Tmp.Vector3[6],l=E.Tmp.Vector3[7],h=E.Tmp.Vector3[8],c=0,u=0,f=0,d=0,p=0,_=0,m=0,g=this._subdivisionsX,v=this._subdivisionsY,y=0;y<v;y++)for(var b=0;b<g;b++){c=3*b,u=3*(y*(g+1)),f=3*((y+1)*(g+1)),P.x=e[u+c],P.y=e[u+c+1],P.z=e[u+c+2],i.x=e[u+c+3],i.y=e[u+c+4],i.z=e[u+c+5],r.x=e[f+c],r.y=e[f+c+1],r.z=e[f+c+2],n.x=e[f+c+3],n.y=e[f+c+4],n.z=e[f+c+5],d=(n.z-P.z)/(n.x-P.x),p=P.z-d*P.x,i.subtractToRef(P,o),r.subtractToRef(P,s),n.subtractToRef(P,a),E.Vector3.CrossToRef(a,s,l),E.Vector3.CrossToRef(o,a,h),l.normalize(),h.normalize(),_=-(l.x*P.x+l.y*P.y+l.z*P.z),m=-(h.x*i.x+h.y*i.y+h.z*i.z);var x=this._heightQuads[y*g+b];x.slope.copyFromFloats(d,p),x.facet1.copyFromFloats(l.x,l.y,l.z,_),x.facet2.copyFromFloats(h.x,h.y,h.z,m)}return this},a.prototype.serialize=function(t){o.prototype.serialize.call(this,t),t.subdivisionsX=this._subdivisionsX,t.subdivisionsY=this._subdivisionsY,t.minX=this._minX,t.maxX=this._maxX,t.minZ=this._minZ,t.maxZ=this._maxZ,t.width=this._width,t.height=this._height},a.Parse=function(o,e){var t=new a(o.name,e);return t._subdivisionsX=o.subdivisionsX||1,t._subdivisionsY=o.subdivisionsY||1,t._minX=o.minX,t._maxX=o.maxX,t._minZ=o.minZ,t._maxZ=o.maxZ,t._width=o.width,t._height=o.height,t},a}(E.Mesh);E.GroundMesh=e}(e||(e={}));var e;!function(a){var e=function(o){function e(t,e){var a=o.call(this,t,e.getScene())||this;return e.instances.push(a),a._sourceMesh=e,a.position.copyFrom(e.position),a.rotation.copyFrom(e.rotation),a.scaling.copyFrom(e.scaling),e.rotationQuaternion&&(a.rotationQuaternion=e.rotationQuaternion.clone()),a.infiniteDistance=e.infiniteDistance,a.setPivotMatrix(e.getPivotMatrix()),a.refreshBoundingInfo(),a._syncSubMeshes(),a}return h(e,o),e.prototype.getClassName=function(){return'InstancedMesh'},Object.defineProperty(e.prototype,'receiveShadows',{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'material',{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'visibility',{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'skeleton',{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'renderingGroupId',{get:function(){return this._sourceMesh.renderingGroupId},set:function(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&a.Tools.Warn('Note - setting renderingGroupId of an instanced mesh has no effect on the scene')},enumerable:!0,configurable:!0}),e.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(e.prototype,'sourceMesh',{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),e.prototype.isReady=function(t){return void 0===t&&(t=!1),this._sourceMesh.isReady(t,!0)},e.prototype.getVerticesData=function(r,e){return this._sourceMesh.getVerticesData(r,e)},e.prototype.setVerticesData=function(o,e,t,i){return this.sourceMesh&&this.sourceMesh.setVerticesData(o,e,t,i),this.sourceMesh},e.prototype.updateVerticesData=function(o,e,t,i){return this.sourceMesh&&this.sourceMesh.updateVerticesData(o,e,t,i),this.sourceMesh},e.prototype.setIndices=function(r,e){return void 0===e&&(e=null),this.sourceMesh&&this.sourceMesh.setIndices(r,e),this.sourceMesh},e.prototype.isVerticesDataPresent=function(t){return this._sourceMesh.isVerticesDataPresent(t)},e.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(e.prototype,'_positions',{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),e.prototype.refreshBoundingInfo=function(){var e=this._sourceMesh.getBoundingInfo();return this._boundingInfo=new a.BoundingInfo(e.minimum.clone(),e.maximum.clone()),this._updateBoundingInfo(),this},e.prototype._preActivate=function(){return this._currentLOD&&this._currentLOD._preActivate(),this},e.prototype._activate=function(t){return this._currentLOD&&this._currentLOD._registerInstanceForRenderId(this,t),this},e.prototype.getLOD=function(r){if(!r)return this;var o=this.getBoundingInfo();return this._currentLOD=this.sourceMesh.getLOD(r,o.boundingSphere),this._currentLOD===this.sourceMesh?this:this._currentLOD},e.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var t=0;t<this._sourceMesh.subMeshes.length;t++)this._sourceMesh.subMeshes[t].clone(this,this._sourceMesh);return this},e.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},e.prototype.clone=function(e,t,i){var l=this._sourceMesh.createInstance(e);if(a.Tools.DeepCopy(this,l,['name','subMeshes','uniqueId'],[]),this.refreshBoundingInfo(),t&&(l.parent=t),!i)for(var n=0,o;n<this.getScene().meshes.length;n++)o=this.getScene().meshes[n],o.parent===this&&o.clone(o.name,l);return l.computeWorldMatrix(!0),l},e.prototype.dispose=function(t,e){void 0===e&&(e=!1);var i=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(i,1),o.prototype.dispose.call(this,t,e)},e}(a.AbstractMesh);a.InstancedMesh=e}(e||(e={}));var e;!function(d){var e=function(c){function o(e,t,r,n,o,s,a){void 0===t&&(t=null),void 0===r&&(r=null);var l=c.call(this,e,t,r,n,o)||this;l.useVertexColor=s,l.useVertexAlpha=a,l.color=new d.Color3(1,1,1),l.alpha=1,n&&(l.color=n.color.clone(),l.alpha=n.alpha,l.useVertexColor=n.useVertexColor,l.useVertexAlpha=n.useVertexAlpha),l._intersectionThreshold=.1;var p={attributes:[d.VertexBuffer.PositionKind],uniforms:['world','viewProjection'],needAlphaBlending:!0,defines:[]};return!1===a&&(p.needAlphaBlending=!1),s?(p.defines.push('#define VERTEXCOLOR'),p.attributes.push(d.VertexBuffer.ColorKind)):p.uniforms.push('color'),l._colorShader=new d.ShaderMaterial('colorShader',l.getScene(),'color',p),l}return h(o,c),Object.defineProperty(o.prototype,'intersectionThreshold',{get:function(){return this._intersectionThreshold},set:function(e){this._intersectionThreshold!==e&&(this._intersectionThreshold=e,this.geometry&&(this.geometry.boundingBias=new d.Vector2(0,e)))},enumerable:!0,configurable:!0}),o.prototype.getClassName=function(){return'LinesMesh'},Object.defineProperty(o.prototype,'material',{get:function(){return this._colorShader},set:function(){},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'checkCollisions',{get:function(){return!1},enumerable:!0,configurable:!0}),o.prototype.createInstance=function(){throw new Error('LinesMeshes do not support createInstance.')},o.prototype._bind=function(){return this._geometry?(this._geometry._bind(this._colorShader.getEffect()),this.useVertexColor||this._colorShader.setColor4('color',this.color.toColor4(this.alpha)),this):this},o.prototype._draw=function(e){return this._geometry&&this._geometry.getVertexBuffers()&&(this._unIndexed||this._geometry.getIndexBuffer())?(this.getScene().getEngine().drawElementsType(d.Material.LineListDrawMode,e.indexStart,e.indexCount),this):this},o.prototype.dispose=function(t){this._colorShader.dispose(),c.prototype.dispose.call(this,t)},o.prototype.clone=function(i,e,t){return new o(i,this.getScene(),e,this,t)},o}(d.Mesh);d.LinesMesh=e}(e||(e={}));var e;!function(O){var e=function(){function M(){}return M.updateSideOrientation=function(e){return e==O.Mesh.DOUBLESIDE?O.Mesh.DOUBLESIDE:void 0===e||null===e?O.Mesh.FRONTSIDE:e},M.CreateBox=function(e,t,r){void 0===r&&(r=null);var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateBox(t).applyToMesh(i,t.updatable),i},M.CreateSphere=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateSphere(t).applyToMesh(i,t.updatable),i},M.CreateDisc=function(e,t,r){void 0===r&&(r=null);var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateDisc(t).applyToMesh(i,t.updatable),i},M.CreateIcoSphere=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateIcoSphere(t).applyToMesh(i,t.updatable),i},M.CreateRibbon=function(e,t,r){void 0===r&&(r=null);var P=t.pathArray,o=t.closeArray,i=t.closePath,a=M.updateSideOrientation(t.sideOrientation),A=t.instance,n=t.updatable;if(A){O.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,O.Tmp.Vector3[0]),O.Vector3.FromFloatsToRef(-S,-S,-S,O.Tmp.Vector3[1]);var s=A.getVerticesData(O.VertexBuffer.PositionKind);if(function(e){for(var t=P[0].length,o=0,r=A._originalBuilderSideOrientation===O.Mesh.DOUBLESIDE?2:1,i=1;i<=r;i++)for(var n=0;n<P.length;n++){var a=P[n],s=a.length;t=t<s?t:s;for(var l=0;l<t;)e[o]=a[l].x,e[o+1]=a[l].y,e[o+2]=a[l].z,a[l].x<O.Tmp.Vector3[0].x&&(O.Tmp.Vector3[0].x=a[l].x),a[l].x>O.Tmp.Vector3[1].x&&(O.Tmp.Vector3[1].x=a[l].x),a[l].y<O.Tmp.Vector3[0].y&&(O.Tmp.Vector3[0].y=a[l].y),a[l].y>O.Tmp.Vector3[1].y&&(O.Tmp.Vector3[1].y=a[l].y),a[l].z<O.Tmp.Vector3[0].z&&(O.Tmp.Vector3[0].z=a[l].z),a[l].z>O.Tmp.Vector3[1].z&&(O.Tmp.Vector3[1].z=a[l].z),l++,o+=3;A._closePath&&(e[o]=a[0].x,e[o+1]=a[0].y,e[o+2]=a[0].z,o+=3)}}(s),A._boundingInfo=new O.BoundingInfo(O.Tmp.Vector3[0],O.Tmp.Vector3[1]),A._boundingInfo.update(A._worldMatrix),A.updateVerticesData(O.VertexBuffer.PositionKind,s,!1,!1),t.colors){for(var l=A.getVerticesData(O.VertexBuffer.ColorKind),c=0;c<t.colors.length;c++)l[4*c]=t.colors[c].r,l[4*c+1]=t.colors[c].g,l[4*c+2]=t.colors[c].b,l[4*c+3]=t.colors[c].a;A.updateVerticesData(O.VertexBuffer.ColorKind,l,!1,!1)}if(t.uvs){for(var d=A.getVerticesData(O.VertexBuffer.UVKind),p=0;p<t.uvs.length;p++)d[2*p]=t.uvs[p].x,d[2*p+1]=t.uvs[p].y;A.updateVerticesData(O.VertexBuffer.UVKind,d,!1,!1)}if(!A.areNormalsFrozen||A.isFacetDataEnabled){var u=A.getIndices(),f=A.getVerticesData(O.VertexBuffer.NormalKind),_=A.isFacetDataEnabled?A.getFacetDataParameters():null;if(O.VertexData.ComputeNormals(s,u,f,_),A._closePath)for(var m=0,g=0,h=0;h<P.length;h++)m=3*A._idx[h],g=h+1<P.length?3*(A._idx[h+1]-1):f.length-3,f[m]=.5*(f[m]+f[g]),f[m+1]=.5*(f[m+1]+f[g+1]),f[m+2]=.5*(f[m+2]+f[g+2]),f[g]=f[m],f[g+1]=f[m+1],f[g+2]=f[m+2];A.areNormalsFrozen||A.updateVerticesData(O.VertexBuffer.NormalKind,f,!1,!1)}return A}var y=new O.Mesh(e,r);y._originalBuilderSideOrientation=a;var T=O.VertexData.CreateRibbon(t);return i&&(y._idx=T._idx),y._closePath=i,y._closeArray=o,T.applyToMesh(y,n),y},M.CreateCylinder=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateCylinder(t).applyToMesh(i,t.updatable),i},M.CreateTorus=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateTorus(t).applyToMesh(i,t.updatable),i},M.CreateTorusKnot=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreateTorusKnot(t).applyToMesh(i,t.updatable),i},M.CreateLineSystem=function(e,t,i){var r=t.instance,n=t.lines,o=t.colors;if(r){var _=r.getVerticesData(O.VertexBuffer.PositionKind),g,a;o&&(g=r.getVerticesData(O.VertexBuffer.ColorKind));for(var l=0,c=0,u=0;u<n.length;u++)for(var f=n[u],d=0;d<f.length;d++)_[l]=f[d].x,_[l+1]=f[d].y,_[l+2]=f[d].z,o&&g&&(a=o[u],g[c]=a[d].r,g[c+1]=a[d].g,g[c+2]=a[d].b,g[c+3]=a[d].a,c+=4),l+=3;return r.updateVerticesData(O.VertexBuffer.PositionKind,_,!1,!1),o&&g&&r.updateVerticesData(O.VertexBuffer.ColorKind,g,!1,!1),r}var p=new O.LinesMesh(e,i,null,void 0,void 0,!!o,t.useVertexAlpha);return O.VertexData.CreateLineSystem(t).applyToMesh(p,t.updatable),p},M.CreateLines=function(t,e,o){void 0===o&&(o=null);var r=e.colors?[e.colors]:null;return M.CreateLineSystem(t,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:r,useVertexAlpha:e.useVertexAlpha},o)},M.CreateDashedLines=function(e,t,i){void 0===i&&(i=null);var p=t.points,n=t.instance,r=t.gapSize||1,o=t.dashSize||3;if(n){var a=function(e){var t=O.Vector3.Zero(),o=e.length/6,r=0,i=0,a=0,s=0,l=0,c=0,u=0,f=0;for(u=0;u<p.length-1;u++)p[u+1].subtractToRef(p[u],t),r+=t.length();for(a=r/o,s=n.dashSize*a/(n.dashSize+n.gapSize),u=0;u<p.length-1;u++)for(p[u+1].subtractToRef(p[u],t),i=ee(t.length()/a),t.normalize(),f=0;f<i&&c<e.length;)l=a*f,e[c]=p[u].x+l*t.x,e[c+1]=p[u].y+l*t.y,e[c+2]=p[u].z+l*t.z,e[c+3]=p[u].x+(l+s)*t.x,e[c+4]=p[u].y+(l+s)*t.y,e[c+5]=p[u].z+(l+s)*t.z,c+=6,f++;for(;c<e.length;)e[c]=p[u].x,e[c+1]=p[u].y,e[c+2]=p[u].z,c+=3};return n.updateMeshPositions(a,!1),n}var s=new O.LinesMesh(e,i);return O.VertexData.CreateDashedLines(t).applyToMesh(s,t.updatable),s.dashSize=o,s.gapSize=r,s},M.ExtrudeShape=function(e,t,r){void 0===r&&(r=null);var i=t.path,o=t.shape,n=t.scale||1,a=t.rotation||0,s=0===t.cap?0:t.cap||O.Mesh.NO_CAP,l=t.updatable,p=M.updateSideOrientation(t.sideOrientation),u=t.instance||null,f=t.invertUV||!1;return M._ExtrudeShapeGeneric(e,o,i,n,a,null,null,!1,!1,s,!1,r,!!l,p,u,f,t.frontUVs||null,t.backUVs||null)},M.ExtrudeShapeCustom=function(e,t,r){var i=t.path,o=t.shape,n=t.scaleFunction||function(){return 1},a=t.rotationFunction||function(){return 0},s=t.ribbonCloseArray||!1,l=t.ribbonClosePath||!1,c=0===t.cap?0:t.cap||O.Mesh.NO_CAP,u=t.updatable,m=M.updateSideOrientation(t.sideOrientation),d=t.instance,p=t.invertUV||!1;return M._ExtrudeShapeGeneric(e,o,i,null,null,n,a,s,l,c,!0,r,!!u,m,d||null,p,t.frontUVs||null,t.backUVs||null)},M.CreateLathe=function(e,t,r){var i=t.arc?0>=t.arc||1<t.arc?1:t.arc:1,n=void 0===t.closed||t.closed,s=t.shape,l=t.radius||1,p=t.tessellation||64,c=t.updatable,h=M.updateSideOrientation(t.sideOrientation),T=t.cap||O.Mesh.NO_CAP,d=[],x=t.invertUV||!1,E=0,g=0,v=2*V/p*i,y=[],b;for(E=0;E<=p;E++){var y=[];for(T!=O.Mesh.CAP_START&&T!=O.Mesh.CAP_ALL||(y.push(new O.Vector3(0,s[0].y,0)),y.push(new O.Vector3(F(E*v)*s[0].x*l,s[0].y,B(E*v)*s[0].x*l))),g=0;g<s.length;g++)b=new O.Vector3(F(E*v)*s[g].x*l,s[g].y,B(E*v)*s[g].x*l),y.push(b);T!=O.Mesh.CAP_END&&T!=O.Mesh.CAP_ALL||(y.push(new O.Vector3(F(E*v)*s[s.length-1].x*l,s[s.length-1].y,B(E*v)*s[s.length-1].x*l)),y.push(new O.Vector3(0,s[s.length-1].y,0))),d.push(y)}return M.CreateRibbon(e,{pathArray:d,closeArray:n,sideOrientation:h,updatable:c,invertUV:x,frontUVs:t.frontUVs,backUVs:t.backUVs},r)},M.CreatePlane=function(e,t,r){var i=new O.Mesh(e,r);if(t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreatePlane(t).applyToMesh(i,t.updatable),t.sourcePlane){i.translate(t.sourcePlane.normal,t.sourcePlane.d);var o=T(O.Vector3.Dot(t.sourcePlane.normal,O.Axis.Z)),n=O.Vector3.Cross(O.Axis.Z,t.sourcePlane.normal);i.rotate(n,o)}return i},M.CreateGround=function(e,t,o){var r=new O.GroundMesh(e,o);return r._setReady(!1),r._subdivisionsX=t.subdivisionsX||t.subdivisions||1,r._subdivisionsY=t.subdivisionsY||t.subdivisions||1,r._width=t.width||1,r._height=t.height||1,r._maxX=r._width/2,r._maxZ=r._height/2,r._minX=-r._maxX,r._minZ=-r._maxZ,O.VertexData.CreateGround(t).applyToMesh(r,t.updatable),r._setReady(!0),r},M.CreateTiledGround=function(e,t,o){var r=new O.Mesh(e,o);return O.VertexData.CreateTiledGround(t).applyToMesh(r,t.updatable),r},M.CreateGroundFromHeightMap=function(e,t,i,g){var n=i.width||10,y=i.height||10,T=i.subdivisions||1,x=i.minHeight||0,b=i.maxHeight||1,E=i.colorFilter||new O.Color3(.3,.59,.11),v=i.updatable,u=i.onReady,f=new O.GroundMesh(e,g);f._subdivisionsX=T,f._subdivisionsY=T,f._width=n,f._height=y,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);return O.Tools.LoadImage(t,function(e){var t=document.createElement('canvas'),i=t.getContext('2d');if(!i)throw new Error('Unable to get 2d context for CreateGroundFromHeightMap');if(!g.isDisposed){var d=e.width,P=e.height;t.width=d,t.height=P,i.drawImage(e,0,0);var A=i.getImageData(0,0,d,P).data;O.VertexData.CreateGroundFromHeightMap({width:n,height:y,subdivisions:T,minHeight:x,maxHeight:b,colorFilter:E,buffer:A,bufferWidth:d,bufferHeight:P}).applyToMesh(f,v),u&&u(f),f._setReady(!0)}},function(){},g.database),f},M.CreatePolygon=function(e,t,r){t.sideOrientation=M.updateSideOrientation(t.sideOrientation);for(var i=t.shape,o=t.holes||[],n=t.depth||0,a=[],s=[],l=0;l<i.length;l++)a[l]=new O.Vector2(i[l].x,i[l].z);a[0].equalsWithEpsilon(a[a.length-1],1e-8)&&a.pop();for(var c=new O.PolygonMeshBuilder(e,a,r),u=0;u<o.length;u++){s=[];for(var f=0;f<o[u].length;f++)s.push(new O.Vector2(o[u][f].x,o[u][f].z));c.addHole(s)}var d=c.build(t.updatable,n);return d._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreatePolygon(d,t.sideOrientation,t.faceUV,t.faceColors,t.frontUVs,t.backUVs).applyToMesh(d,t.updatable),d},M.ExtrudePolygon=function(t,e,o){return M.CreatePolygon(t,e,o)},M.CreateTube=function(e,t,r){var i=t.path,o=t.instance,n=1;o&&(n=o.radius),void 0!==t.radius&&(n=t.radius);var a=t.tessellation||64,l=t.radiusFunction||null,h=t.cap||O.Mesh.NO_CAP,c=t.invertUV||!1,T=t.updatable,x=M.updateSideOrientation(t.sideOrientation);t.arc=t.arc&&(0>=t.arc||1<t.arc)?1:t.arc||1;var b=function(m,e,t,r,i,o,n,a){for(var s=e.getTangents(),l=e.getNormals(),d=e.getDistances(),p=function(){return r},_=O.Tmp.Matrix[0],g=n===O.Mesh._NO_CAP||n===O.Mesh.CAP_END?0:2,y=0,T,h,c,u;y<m.length;y++){h=(o||p)(y,d[y]),T=[],c=l[y];for(var f=0;f<i;f++)O.Matrix.RotationAxisToRef(s[y],2*V/i*a*f,_),u=T[f]?T[f]:O.Vector3.Zero(),O.Vector3.TransformCoordinatesToRef(c,_,u),u.scaleInPlace(h).addInPlace(m[y]),T[f]=u;t[g]=T,g++}var x=function(t,e){for(var o=[],r=0;r<t;r++)o.push(m[e]);return o};switch(n){case O.Mesh.NO_CAP:break;case O.Mesh.CAP_START:t[0]=x(i,0),t[1]=t[2].slice(0);break;case O.Mesh.CAP_END:t[g]=t[g-1].slice(0),t[g+1]=x(i,m.length-1);break;case O.Mesh.CAP_ALL:t[0]=x(i,0),t[1]=t[2].slice(0),t[g]=t[g-1].slice(0),t[g+1]=x(i,m.length-1);}return t},m,p;if(o){var E=t.arc||o.arc;return m=o.path3D.update(i),p=b(i,m,o.pathArray,n,o.tessellation,l,o.cap,E),o=M.CreateRibbon('',{pathArray:p,instance:o}),o.path3D=m,o.pathArray=p,o.arc=E,o.radius=n,o}m=new O.Path3D(i);h=0>h||3<h?0:h,p=b(i,m,[],n,a,l,h,t.arc);var g=M.CreateRibbon(e,{pathArray:p,closePath:!0,closeArray:!1,updatable:T,sideOrientation:x,invertUV:c,frontUVs:t.frontUVs,backUVs:t.backUVs},r);return g.pathArray=p,g.path3D=m,g.tessellation=a,g.cap=h,g.arc=t.arc,g.radius=n,g},M.CreatePolyhedron=function(e,t,r){var i=new O.Mesh(e,r);return t.sideOrientation=M.updateSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,O.VertexData.CreatePolyhedron(t).applyToMesh(i,t.updatable),i},M.CreateDecal=function(e,t,i){var D=t.getIndices(),L=t.getVerticesData(O.VertexBuffer.PositionKind),F=t.getVerticesData(O.VertexBuffer.NormalKind),r=i.position||O.Vector3.Zero(),a=i.normal||O.Vector3.Up(),B=i.size||O.Vector3.One(),h=i.angle||0;if(!a){var c=new O.Vector3(0,0,1),u=t.getScene().activeCamera,f=O.Vector3.TransformCoordinates(c,u.getWorldMatrix());a=u.globalPosition.subtract(f)}var d=-I(a.z,a.x)-V/2,p=$(a.x*a.x+a.z*a.z),_=I(a.y,p),m=O.Matrix.RotationYawPitchRoll(d,_,h).multiply(O.Matrix.Translation(r.x,r.y,r.z)),g=O.Matrix.Invert(m),v=t.getWorldMatrix(),y=v.multiply(g),b=new O.VertexData;b.indices=[],b.positions=[],b.normals=[],b.uvs=[];for(var x=0,T=function(e){var t=new O.PositionNormalVertex;if(!D||!L||!F)return t;var i=D[e];return t.position=new O.Vector3(L[3*i],L[3*i+1],L[3*i+2]),t.position=O.Vector3.TransformCoordinates(t.position,y),t.normal=new O.Vector3(F[3*i],F[3*i+1],F[3*i+2]),t.normal=O.Vector3.TransformNormal(t.normal,y),t},E=function(e,h){if(0===e.length)return e;for(var i=.5*A(O.Vector3.Dot(B,h)),t=function(e,t){var r=O.Vector3.GetClipFactor(e.position,t.position,h,i);return new O.PositionNormalVertex(O.Vector3.Lerp(e.position,t.position,r),O.Vector3.Lerp(e.normal,t.normal,r))},r=[],o=0;o<e.length;o+=3){var n=null,s=null,u=null,d=null,p=O.Vector3.Dot(e[o].position,h)-i,f=O.Vector3.Dot(e[o+1].position,h)-i,_=O.Vector3.Dot(e[o+2].position,h)-i,m,a,l;switch(m=0<p,a=0<f,l=0<_,(m?1:0)+(a?1:0)+(l?1:0)){case 0:r.push(e[o]),r.push(e[o+1]),r.push(e[o+2]);break;case 1:if(m&&(n=e[o+1],s=e[o+2],u=t(e[o],n),d=t(e[o],s)),a){n=e[o],s=e[o+2],u=t(e[o+1],n),d=t(e[o+1],s),r.push(u),r.push(s.clone()),r.push(n.clone()),r.push(s.clone()),r.push(u.clone()),r.push(d);break}l&&(n=e[o],s=e[o+1],u=t(e[o+2],n),d=t(e[o+2],s)),n&&s&&u&&d&&(r.push(n.clone()),r.push(s.clone()),r.push(u),r.push(d),r.push(u.clone()),r.push(s.clone()));break;case 2:m||(n=e[o].clone(),s=t(n,e[o+1]),u=t(n,e[o+2]),r.push(n),r.push(s),r.push(u)),a||(n=e[o+1].clone(),s=t(n,e[o+2]),u=t(n,e[o]),r.push(n),r.push(s),r.push(u)),l||(n=e[o+2].clone(),s=t(n,e[o]),u=t(n,e[o+1]),r.push(n),r.push(s),r.push(u));}}return r},P=0,N;P<D.length;P+=3)if(N=[],N.push(T(P)),N.push(T(P+1)),N.push(T(P+2)),N=E(N,new O.Vector3(1,0,0)),N=E(N,new O.Vector3(-1,0,0)),N=E(N,new O.Vector3(0,1,0)),N=E(N,new O.Vector3(0,-1,0)),N=E(N,new O.Vector3(0,0,1)),N=E(N,new O.Vector3(0,0,-1)),0!==N.length)for(var M=0,S;M<N.length;M++)S=N[M],b.indices.push(x),S.position.toArray(b.positions,3*x),S.normal.toArray(b.normals,3*x),b.uvs.push(.5+S.position.x/B.x),b.uvs.push(.5+S.position.y/B.y),x++;var C=new O.Mesh(e,t.getScene());return b.applyToMesh(C),C.position=r.clone(),C.rotation=new O.Vector3(_,d,h),C},M._ExtrudeShapeGeneric=function(e,t,r,i,o,n,a,s,l,E,u,f,d,A,S,m,C,v){var y=function(e,t,i,r,n,o,s,a,l,h){for(var c=i.getTangents(),u=i.getNormals(),f=i.getBinormals(),d=i.getDistances(),p=0,_=function(){return null===n?1:n},m=function(){return null===o?0:o},g=h&&a?a:m,v=h&&s?s:_,y=l===O.Mesh.NO_CAP||l===O.Mesh.CAP_END?0:2,b=O.Tmp.Matrix[0],x=0;x<t.length;x++){for(var T=[],E=g(x,d[x]),P=v(x,d[x]),A=0;A<e.length;A++){O.Matrix.RotationAxisToRef(c[x],p,b);var M=c[x].scale(e[A].z).add(u[x].scale(e[A].x)).add(f[x].scale(e[A].y)),S=T[A]?T[A]:O.Vector3.Zero();O.Vector3.TransformCoordinatesToRef(M,b,S),S.scaleInPlace(P).addInPlace(t[x]),T[A]=S}r[y]=T,p+=E,y++}var C=function(e){var t=[],r=O.Vector3.Zero(),o;for(o=0;o<e.length;o++)r.addInPlace(e[o]);for(r.scaleInPlace(1/e.length),o=0;o<e.length;o++)t.push(r);return t};switch(l){case O.Mesh.NO_CAP:break;case O.Mesh.CAP_START:r[0]=C(r[2]),r[1]=r[2];break;case O.Mesh.CAP_END:r[y]=r[y-1],r[y+1]=C(r[y-1]);break;case O.Mesh.CAP_ALL:r[0]=C(r[2]),r[1]=r[2],r[y]=r[y-1],r[y+1]=C(r[y-1]);}return r},T,b;if(S)return T=S.path3D.update(r),b=y(t,r,S.path3D,S.pathArray,i,o,n,a,S.cap,u),S=O.Mesh.CreateRibbon('',b,!1,!1,0,f||void 0,!1,0,S);T=new O.Path3D(r);E=0>E||3<E?0:E,b=y(t,r,T,[],i,o,n,a,E,u);var R=M.CreateRibbon(e,{pathArray:b,closeArray:s,closePath:l,updatable:d,sideOrientation:A,invertUV:m,frontUVs:C||void 0,backUVs:v||void 0},f);return R.pathArray=b,R.path3D=T,R.cap=E,R},M}();O.MeshBuilder=e}(e||(e={}));var e;!function(T){var e=function(){function o(){}return Object.defineProperty(o,'DecoderAvailable',{get:function(){if('undefined'!=typeof DracoDecoderModule)return!0;var t=o.Configuration.decoder;if(t){if(t.wasmUrl&&t.wasmBinaryUrl&&'object'==typeof WebAssembly)return!0;if(t.fallbackUrl)return!0}return!1},enumerable:!0,configurable:!0}),o.prototype.dispose=function(){},o.prototype.decodeMeshAsync=function(e,t){return o._GetDecoderModule().then(function(r){var i=r.module,n=new T.VertexData,o=new i.DecoderBuffer;o.Init(e,e.byteLength);var s=new i.Decoder,h,a;try{var l=s.GetEncodedGeometryType(o);switch(l){case i.TRIANGULAR_MESH:h=new i.Mesh,a=s.DecodeBufferToMesh(o,h);break;case i.POINT_CLOUD:h=new i.PointCloud,a=s.DecodeBufferToPointCloud(o,h);break;default:throw new Error('Invalid geometry type '+l);}if(!a.ok()||!h.ptr)throw new Error(a.error_msg());var c=h.num_points();if(l===i.TRIANGULAR_MESH){var u=h.num_faces(),f=new i.DracoInt32Array;try{for(var d=new Uint32Array(3*u),p=0;p<u;p++){s.GetFaceFromMesh(h,p,f);var _=3*p;d[_+0]=f.GetValue(0),d[_+1]=f.GetValue(1),d[_+2]=f.GetValue(2)}n.indices=d}finally{i.destroy(f)}}for(var m in t){var g=t[m],E=s.GetAttributeByUniqueId(h,g),y=new i.DracoFloat32Array;try{s.GetAttributeFloatForAllPoints(h,E,y);for(var b=new Float32Array(c*E.num_components()),p=0;p<b.length;p++)b[p]=y.GetValue(p);n.set(b,m)}finally{i.destroy(y)}}}finally{h&&i.destroy(h),i.destroy(s),i.destroy(o)}return n})},o._GetDecoderModule=function(){if(!o._DecoderModulePromise){var t=null,a={};if('undefined'!=typeof DracoDecoderModule)t=Promise.resolve();else{var i=o.Configuration.decoder;i&&(i.wasmUrl&&i.wasmBinaryUrl&&'object'==typeof WebAssembly?t=Promise.all([o._LoadScriptAsync(i.wasmUrl),o._LoadFileAsync(i.wasmBinaryUrl).then(function(t){a.wasmBinary=t})]):i.fallbackUrl&&(t=o._LoadScriptAsync(i.fallbackUrl)))}if(!t)throw new Error('Draco decoder module is not available');o._DecoderModulePromise=t.then(function(){return new Promise(function(r){a.onModuleLoaded=function(e){r({module:e})},DracoDecoderModule(a)})})}return o._DecoderModulePromise},o._LoadScriptAsync=function(e){return new Promise(function(t,o){T.Tools.LoadScript(e,function(){t()},function(t){o(new Error(t))})})},o._LoadFileAsync=function(e){return new Promise(function(t,o){T.Tools.LoadFile(e,function(r){t(r)},void 0,void 0,!0,function(r,e){o(e)})})},o.Configuration={decoder:{wasmUrl:'https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js',wasmBinaryUrl:'https://preview.babylonjs.com/draco_decoder_gltf.wasm',fallbackUrl:'https://preview.babylonjs.com/draco_decoder_gltf.js'}},o}();T.DracoCompression=e}(e||(e={}));var e;!function(r){var e=function(){function e(){this._audioContext=null,this._audioContextInitialized=!1,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.unlocked=!1,this.isMP3supported=!1,this.isOGGsupported=!1,void 0===window.AudioContext&&void 0===window.webkitAudioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var t=document.createElement('audio');try{t&&t.canPlayType&&t.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,'')&&(this.isMP3supported=!0)}catch(t){}try{t&&t.canPlayType&&t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,'')&&(this.isOGGsupported=!0)}catch(t){}/iPad|iPhone|iPod/.test(navigator.platform)?this._unlockiOSaudio():this.unlocked=!0}return Object.defineProperty(e.prototype,'audioContext',{get:function(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext},enumerable:!0,configurable:!0}),e.prototype._unlockiOSaudio=function(){var o=this,e=function(){if(o.audioContext){var t=o.audioContext.createBuffer(1,1,22050),i=o.audioContext.createBufferSource();i.buffer=t,i.connect(o.audioContext.destination),i.start(0),setTimeout(function(){i.playbackState!==i.PLAYING_STATE&&i.playbackState!==i.FINISHED_STATE||(o.unlocked=!0,window.removeEventListener('touchend',e,!1),o.onAudioUnlocked&&o.onAudioUnlocked())},0)}};window.addEventListener('touchend',e,!1)},e.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext=new AudioContext,this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this._audioContext.destination),this._audioContextInitialized=!0)}catch(e){this.canUseWebAudio=!1,r.Tools.Error('Web Audio: '+e.message)}},e.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1},e.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},e.prototype.setGlobalVolume=function(t){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=t)},e.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},e}();r.AudioEngine=e}(e||(e={}));var e;!function(d){var e=function(){function p(e,p,f,r,n){void 0===r&&(r=null);var o=this;if(this.autoplay=!1,this.loop=!1,this.useCustomAttenuation=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel='linear',this._panningModel='equalpower',this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=d.Vector3.Zero(),this._localDirection=new d.Vector3(1,0,0),this._volume=1,this._isReadyToPlay=!1,this.isPlaying=!1,this.isPaused=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType='Unknown',this.name=e,this._scene=f,this._readyToPlayCallback=r,this._customAttenuationFunction=function(r,e,t){return e<t?r*(1-e/t):0},n&&(this.autoplay=n.autoplay||!1,this.loop=n.loop||!1,void 0!==n.volume&&(this._volume=n.volume),this.spatialSound=n.spatialSound||!1,this.maxDistance=n.maxDistance||100,this.useCustomAttenuation=n.useCustomAttenuation||!1,this.rolloffFactor=n.rolloffFactor||1,this.refDistance=n.refDistance||1,this.distanceModel=n.distanceModel||'linear',this._playbackRate=n.playbackRate||1,this._streaming=n.streaming||!1),d.Engine.audioEngine.canUseWebAudio&&d.Engine.audioEngine.audioContext){this._soundGain=d.Engine.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._ouputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.AddSound(this);var s=!0;if(p)try{'string'==typeof p&&(this._urlType='String'),Array.isArray(p)&&(this._urlType='Array'),p instanceof ArrayBuffer&&(this._urlType='ArrayBuffer');var a=[],l=!1;switch(this._urlType){case'ArrayBuffer':0<p.byteLength&&(l=!0,this._soundLoaded(p));break;case'String':a.push(p);case'Array':0===a.length&&(a=p);for(var _=0,c;_<a.length;_++)if(c=a[_],-1!==c.indexOf('.mp3',c.length-4)&&d.Engine.audioEngine.isMP3supported&&(l=!0),-1!==c.indexOf('.ogg',c.length-4)&&d.Engine.audioEngine.isOGGsupported&&(l=!0),-1!==c.indexOf('.wav',c.length-4)&&(l=!0),-1!==c.indexOf('blob:')&&(l=!0),l){this._streaming?(this._htmlAudioElement=new Audio(c),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,d.Tools.SetCorsBehavior(c,this._htmlAudioElement),this._htmlAudioElement.preload='auto',this._htmlAudioElement.addEventListener('canplaythrough',function(){o._isReadyToPlay=!0,o.autoplay&&o.play(),o._readyToPlayCallback&&o._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement)):this._scene._loadFile(c,function(t){o._soundLoaded(t)},void 0,!0,!0,function(e){e&&d.Tools.Error('XHR '+e.status+' error on: '+c+'.'),d.Tools.Error('Sound creation aborted.'),o._scene.mainSoundTrack.RemoveSound(o)});break}break;default:s=!1;}s?l||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback&&o._readyToPlayCallback()},1e3)):d.Tools.Error('Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.')}catch(e){d.Tools.Error('Unexpected error. Sound creation aborted.'),this._scene.mainSoundTrack.RemoveSound(this)}}else this._scene.mainSoundTrack.AddSound(this),d.Engine.audioEngine.WarnedWebAudioUnsupported||(d.Tools.Error('Web Audio is not supported by your browser.'),d.Engine.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback&&o._readyToPlayCallback()},1e3)}return p.prototype.dispose=function(){d.Engine.audioEngine.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.RemoveSound(this):this._scene.soundTracks[this.soundTrackId].RemoveSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src='',document.body.removeChild(this._htmlAudioElement)),this._connectedMesh&&this._registerFunc&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedMesh=null))},p.prototype.isReady=function(){return this._isReadyToPlay},p.prototype._soundLoaded=function(e){var r=this;d.Engine.audioEngine.audioContext&&d.Engine.audioEngine.audioContext.decodeAudioData(e,function(t){r._audioBuffer=t,r._isReadyToPlay=!0,r.autoplay&&r.play(),r._readyToPlayCallback&&r._readyToPlayCallback()},function(e){d.Tools.Error('Error while decoding audio data for: '+r.name+' / Error: '+e)})},p.prototype.setAudioBuffer=function(e){d.Engine.audioEngine.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)},p.prototype.updateOptions=function(t){t&&(this.loop=t.loop||this.loop,this.maxDistance=t.maxDistance||this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation||this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor||this.rolloffFactor,this.refDistance=t.refDistance||this.refDistance,this.distanceModel=t.distanceModel||this.distanceModel,this._playbackRate=t.playbackRate||this._playbackRate,this._updateSpatialParameters(),this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate)))},p.prototype._createSpatialParameters=function(){d.Engine.audioEngine.canUseWebAudio&&d.Engine.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel='HRTF'),this._soundPanner=d.Engine.audioEngine.audioContext.createPanner(),this._updateSpatialParameters(),this._soundPanner.connect(this._ouputAudioNode),this._inputAudioNode=this._soundPanner)},p.prototype._updateSpatialParameters=function(){this.spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel='linear',this._soundPanner.maxDistance=S,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},p.prototype.switchPanningModelToHRTF=function(){this._panningModel='HRTF',this._switchPanningModel()},p.prototype.switchPanningModelToEqualPower=function(){this._panningModel='equalpower',this._switchPanningModel()},p.prototype._switchPanningModel=function(){d.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},p.prototype.connectToSoundTrackAudioNode=function(e){d.Engine.audioEngine.canUseWebAudio&&(this._isOutputConnected&&this._ouputAudioNode.disconnect(),this._ouputAudioNode.connect(e),this._isOutputConnected=!0)},p.prototype.setDirectionalCone=function(e,t,o){return t<e?void d.Tools.Error('setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.'):void(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=o,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play()))},p.prototype.setPosition=function(e){this._position=e,d.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},p.prototype.setLocalDirectionToMesh=function(e){this._localDirection=e,d.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.isPlaying&&this._updateDirection()},p.prototype._updateDirection=function(){if(this._connectedMesh&&this._soundPanner){var e=this._connectedMesh.getWorldMatrix(),t=d.Vector3.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.setOrientation(t.x,t.y,t.z)}},p.prototype.updateDistanceFromListener=function(){if(d.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var e=this._connectedMesh.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}},p.prototype.setAttenuationFunction=function(t){this._customAttenuationFunction=t},p.prototype.play=function(e,t){var o=this;if(this._isReadyToPlay&&this._scene.audioEnabled&&d.Engine.audioEngine.audioContext)try{0>this._startOffset&&(e=-this._startOffset,this._startOffset=0);var r=e?d.Engine.audioEngine.audioContext.currentTime+e:d.Engine.audioEngine.audioContext.currentTime;this._soundSource&&this._streamingSource||this.spatialSound&&this._soundPanner&&(this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedMesh?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming?(this._streamingSource||(this._streamingSource=d.Engine.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){o._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement.play()):(this._soundSource=d.Engine.audioEngine.audioContext.createBufferSource(),this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=function(){o._onended()},this._soundSource.buffer&&this._soundSource.start(r,this.isPaused?this._startOffset%this._soundSource.buffer.duration:t||0)),this._startTime=r,this.isPlaying=!0,this.isPaused=!1}catch(e){d.Tools.Error('Error while trying to play audio: '+this.name+', '+e.message)}},p.prototype._onended=function(){this.isPlaying=!1,this.onended&&this.onended()},p.prototype.stop=function(e){if(this.isPlaying){if(this._streaming)this._htmlAudioElement.pause(),0<this._htmlAudioElement.currentTime&&(this._htmlAudioElement.currentTime=0);else if(d.Engine.audioEngine.audioContext&&this._soundSource){var t=e?d.Engine.audioEngine.audioContext.currentTime+e:d.Engine.audioEngine.audioContext.currentTime;this._soundSource.stop(t),this._soundSource.onended=function(){},this.isPaused||(this._startOffset=0)}this.isPlaying=!1}},p.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement.pause():d.Engine.audioEngine.audioContext&&(this.stop(0),this._startOffset+=d.Engine.audioEngine.audioContext.currentTime-this._startTime))},p.prototype.setVolume=function(e,t){d.Engine.audioEngine.canUseWebAudio&&this._soundGain&&(t&&d.Engine.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(d.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,d.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,d.Engine.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e},p.prototype.setPlaybackRate=function(t){this._playbackRate=t,this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},p.prototype.getVolume=function(){return this._volume},p.prototype.attachToMesh=function(r){var o=this;this._connectedMesh&&this._registerFunc&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedMesh=r,this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play())),this._onRegisterAfterWorldMatrixUpdate(this._connectedMesh),this._registerFunc=function(t){return o._onRegisterAfterWorldMatrixUpdate(t)},r.registerAfterWorldMatrixUpdate(this._registerFunc)},p.prototype.detachFromMesh=function(){this._connectedMesh&&this._registerFunc&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedMesh=null)},p.prototype._onRegisterAfterWorldMatrixUpdate=function(e){if(e.getBoundingInfo){var t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld),d.Engine.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}},p.prototype.clone=function(){var t=this;if(this._streaming)return null;var e=function(){t._isReadyToPlay?(r._audioBuffer=t.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play()):window.setTimeout(e,300)},o={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new p(this.name+'_cloned',new ArrayBuffer(0),this._scene,null,o);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),e(),r},p.prototype.getAudioBuffer=function(){return this._audioBuffer},p.prototype.serialize=function(){var t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId};return this.spatialSound&&(this._connectedMesh&&(t.connectedMeshId=this._connectedMesh.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t},p.Parse=function(e,t,r,i){var o=e.name,a;a=e.url?r+e.url:r+o;var n={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate},s;if(i){var l=function(){i._isReadyToPlay?(s._audioBuffer=i.getAudioBuffer(),s._isReadyToPlay=!0,s.autoplay&&s.play()):window.setTimeout(l,300)};s=new p(o,new ArrayBuffer(0),t,null,n),l()}else s=new p(o,a,t,function(){t._removePendingData(s)},n),t._addPendingData(s);if(e.position){var c=d.Vector3.FromArray(e.position);s.setPosition(c)}if(e.isDirectional&&(s.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){var u=d.Vector3.FromArray(e.localDirectionToMesh);s.setLocalDirectionToMesh(u)}if(e.connectedMeshId){var f=t.getMeshByID(e.connectedMeshId);f&&s.attachToMesh(f)}return s},p}();d.Sound=e}(e||(e={}));var e;!function(r){var e=function(){function e(r,e){this.id=-1,this._isMainTrack=!1,this._isInitialized=!1,this._scene=r,this.soundCollection=[],this._options=e,this._isMainTrack||(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}return e.prototype._initializeSoundTrackAudioGraph=function(){r.Engine.audioEngine.canUseWebAudio&&r.Engine.audioEngine.audioContext&&(this._outputAudioNode=r.Engine.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(r.Engine.audioEngine.masterGain),this._options&&(this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._options.mainTrack&&(this._isMainTrack=this._options.mainTrack)),this._isInitialized=!0)},e.prototype.dispose=function(){if(r.Engine.audioEngine&&r.Engine.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},e.prototype.AddSound=function(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),r.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.RemoveSound(e):this._scene.soundTracks[e.soundTrackId].RemoveSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id},e.prototype.RemoveSound=function(r){var e=this.soundCollection.indexOf(r);-1!==e&&this.soundCollection.splice(e,1)},e.prototype.setVolume=function(e){r.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)},e.prototype.switchPanningModelToHRTF=function(){if(r.Engine.audioEngine.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()},e.prototype.switchPanningModelToEqualPower=function(){if(r.Engine.audioEngine.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()},e.prototype.connectToAnalyser=function(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,r.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,r.Engine.audioEngine.masterGain))},e}();r.SoundTrack=e}(e||(e={}));var e;!function(r){var e=function(){function e(e){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},this._scene=e,this._audioEngine=r.Engine.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))}return e.prototype.getFrequencyBinCount=function(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0},e.prototype.getByteFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs},e.prototype.getByteTimeDomainData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime},e.prototype.getFloatFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs},e.prototype.drawDebugCanvas=function(){var d=this;if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement('canvas'),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position='absolute',this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+'px',this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+'px',this._debugCanvasContext=this._debugCanvas.getContext('2d'),document.body.appendChild(this._debugCanvas),this._registerFunc=function(){d.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){var e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle='rgb(0, 0, 0)',this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var t=0;t<this.getFrequencyBinCount();t++){var i=e[t],r=i/this.BARGRAPHAMPLITUDE,n=this.DEBUGCANVASSIZE.height*r,o=this.DEBUGCANVASSIZE.height-n-1,s=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),a=360*(t/this.getFrequencyBinCount());this._debugCanvasContext.fillStyle='hsl('+a+', 100%, 50%)',this._debugCanvasContext.fillRect(t*s,o,s,n)}}},e.prototype.stopDebugCanvas=function(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)},e.prototype.connectAudioNodes=function(r,e){this._audioEngine.canUseWebAudio&&(r.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(e))},e.prototype.dispose=function(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()},e}();r.Analyser=e}(e||(e={}));var e;!function(_){var e=function(e){function o(t,g,r,n,o,y,a,l,h,c){void 0===r&&(r=null),void 0===n&&(n=!1),void 0===o&&(o=null),void 0===y&&(y=null),void 0===a&&(a=null),void 0===l&&(l=_.Engine.TEXTUREFORMAT_RGBA),void 0===h&&(h=!1),void 0===c&&(c=null);var u=e.call(this,g)||this;if(u.coordinatesMode=_.Texture.CUBIC_MODE,u.boundingBoxPosition=_.Vector3.Zero(),u._rotationY=0,u.name=t,u.url=t,u._noMipmap=n,u.hasAlpha=!1,u._format=l,u._prefiltered=h,u.isCube=!0,u._textureMatrix=_.Matrix.Identity(),h&&(u.gammaSpace=!1),!t&&!o)return u;u._texture=u._getFromCache(t,n);var f=t.lastIndexOf('.'),d=c||(-1<f?t.substring(f).toLowerCase():'');if(!o&&('.dds'===d||r||(r=['_px.jpg','_py.jpg','_pz.jpg','_nx.jpg','_ny.jpg','_nz.jpg']),o=[],r))for(var p=0;p<r.length;p++)o.push(t+r[p]);return u._files=o,u._texture?y&&(u._texture.isReady?_.Tools.SetImmediate(function(){return y()}):u._texture.onLoadedObservable.add(y)):g.useDelayedTextureLoading?u.delayLoadState=_.Engine.DELAYLOADSTATE_NOTLOADED:u._texture=h?g.getEngine().createPrefilteredCubeTexture(t,g,u.lodGenerationScale,u.lodGenerationOffset,y,a,l,c):g.getEngine().createCubeTexture(t,g,o,n,y,a,u._format,c),u}return h(o,e),Object.defineProperty(o.prototype,'boundingBoxSize',{get:function(){return this._boundingBoxSize},set:function(e){if(!this._boundingBoxSize||!this._boundingBoxSize.equals(e)){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(_.Material.TextureDirtyFlag)}},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'rotationY',{get:function(){return this._rotationY},set:function(e){this._rotationY=e,this.setReflectionTextureMatrix(_.Matrix.RotationY(this._rotationY))},enumerable:!0,configurable:!0}),o.CreateFromImages=function(i,e,t){var r='';return i.forEach(function(t){return r+=t}),new o(r,e,null,t,i)},o.CreateFromPrefilteredData=function(i,e,t){return void 0===t&&(t=null),new o(i,e,null,!1,null,null,null,void 0,!0,t)},o.prototype.delayLoad=function(){if(this.delayLoadState===_.Engine.DELAYLOADSTATE_NOTLOADED){var e=this.getScene();e&&(this.delayLoadState=_.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._prefiltered?this._texture=e.getEngine().createPrefilteredCubeTexture(this.url,e,this.lodGenerationScale,this.lodGenerationOffset,void 0,void 0,this._format):this._texture=e.getEngine().createCubeTexture(this.url,e,this._files,this._noMipmap,void 0,void 0,this._format)))}},o.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},o.prototype.setReflectionTextureMatrix=function(t){this._textureMatrix=t},o.Parse=function(i,t,r){var e=_.SerializationHelper.Parse(function(){var a=!1;return i.prefiltered&&(a=i.prefiltered),new o(r+i.name,t,i.extensions,!1,null,null,null,void 0,a)},i,t);if(i.boundingBoxPosition&&(e.boundingBoxPosition=_.Vector3.FromArray(i.boundingBoxPosition)),i.boundingBoxSize&&(e.boundingBoxSize=_.Vector3.FromArray(i.boundingBoxSize)),i.animations)for(var n=0,s;n<i.animations.length;n++)s=i.animations[n],e.animations.push(_.Animation.Parse(s));return e},o.prototype.clone=function(){var r=this;return _.SerializationHelper.Clone(function(){var t=r.getScene();return t?new o(r.url,t,r._extensions,r._noMipmap,r._files):r},this)},g([_.serialize('rotationY')],o.prototype,'_rotationY',void 0),o}(_.BaseTexture);_.CubeTexture=e}(e||(e={}));var e;!function(p){var e=function(_){function r(e,t,r,n,m,s,g,l,y,T,x){void 0===m&&(m=!0),void 0===s&&(s=p.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===g&&(g=!1),void 0===l&&(l=p.Texture.TRILINEAR_SAMPLINGMODE),void 0===y&&(y=!0),void 0===T&&(T=!1),void 0===x&&(x=!1);var f=_.call(this,null,r,!n)||this;return f.isCube=g,f.renderList=[],f.renderParticles=!0,f.renderSprites=!1,f.coordinatesMode=p.Texture.PROJECTION_MODE,f.ignoreCameraViewport=!1,f.onBeforeBindObservable=new p.Observable,f.onAfterUnbindObservable=new p.Observable,f.onBeforeRenderObservable=new p.Observable,f.onAfterRenderObservable=new p.Observable,f.onClearObservable=new p.Observable,f._currentRefreshId=-1,f._refreshRate=1,f._samples=1,f.boundingBoxPosition=p.Vector3.Zero(),(r=f.getScene())?(f._engine=r.getEngine(),f.name=e,f.isRenderTarget=!0,f._initialSizeParameter=t,f._processSizeParameter(t),f._resizeObserver=f.getScene().getEngine().onResizeObservable.add(function(){}),f._generateMipMaps=!!n,f._doNotChangeAspectRatio=m,f._renderingManager=new p.RenderingManager(r),x?f:(f._renderTargetOptions={generateMipMaps:n,type:s,samplingMode:l,generateDepthBuffer:y,generateStencilBuffer:T},l===p.Texture.NEAREST_SAMPLINGMODE&&(f.wrapU=p.Texture.CLAMP_ADDRESSMODE,f.wrapV=p.Texture.CLAMP_ADDRESSMODE),g?(f._texture=r.getEngine().createRenderTargetCubeTexture(f.getRenderSize(),f._renderTargetOptions),f.coordinatesMode=p.Texture.INVCUBIC_MODE,f._textureMatrix=p.Matrix.Identity()):f._texture=r.getEngine().createRenderTargetTexture(f._size,f._renderTargetOptions),f)):f}return h(r,_),Object.defineProperty(r,'REFRESHRATE_RENDER_ONCE',{get:function(){return r._REFRESHRATE_RENDER_ONCE},enumerable:!0,configurable:!0}),Object.defineProperty(r,'REFRESHRATE_RENDER_ONEVERYFRAME',{get:function(){return r._REFRESHRATE_RENDER_ONEVERYFRAME},enumerable:!0,configurable:!0}),Object.defineProperty(r,'REFRESHRATE_RENDER_ONEVERYTWOFRAMES',{get:function(){return r._REFRESHRATE_RENDER_ONEVERYTWOFRAMES},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'onAfterUnbind',{set:function(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'onBeforeRender',{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'onAfterRender',{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'onClear',{set:function(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'renderTargetOptions',{get:function(){return this._renderTargetOptions},enumerable:!0,configurable:!0}),r.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(r.prototype,'boundingBoxSize',{get:function(){return this._boundingBoxSize},set:function(e){if(!this._boundingBoxSize||!this._boundingBoxSize.equals(e)){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(p.Material.TextureDirtyFlag)}},enumerable:!0,configurable:!0}),r.prototype.createDepthStencilTexture=function(o,a,n){if(void 0===o&&(o=0),void 0===a&&(a=!0),void 0===n&&(n=!1),this.getScene()){var s=this.getScene().getEngine();this.depthStencilTexture=s.createDepthStencilTexture(this._size,{bilinearFiltering:a,comparisonFunction:o,generateStencil:n,isCube:this.isCube}),s.setFrameBufferDepthStencilTexture(this)}},r.prototype._processSizeParameter=function(t){t.ratio?(this._sizeRatio=t.ratio,this._size={width:this._bestReflectionRenderTargetDimension(this._engine.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(this._engine.getRenderHeight(),this._sizeRatio)}):this._size=t},Object.defineProperty(r.prototype,'samples',{get:function(){return this._samples},set:function(r){if(this._samples!==r){var e=this.getScene();e&&(this._samples=e.getEngine().updateRenderTargetTextureSampleCount(this._texture,r))}},enumerable:!0,configurable:!0}),r.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(r.prototype,'refreshRate',{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),r.prototype.addPostProcess=function(e){if(!this._postProcessManager){var t=this.getScene();if(!t)return;this._postProcessManager=new p.PostProcessManager(t),this._postProcesses=[]}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1},r.prototype.clearPostProcesses=function(o){if(this._postProcesses){if(o)for(var e=0,t=this._postProcesses,i;e<t.length;e++)i=t[e],i.dispose();this._postProcesses=[]}},r.prototype.removePostProcess=function(r){if(this._postProcesses){var e=this._postProcesses.indexOf(r);-1!==e&&(this._postProcesses.splice(e,1),0<this._postProcesses.length&&(this._postProcesses[0].autoClear=!1))}},r.prototype._shouldRender=function(){return-1===this._currentRefreshId?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},r.prototype.getRenderSize=function(){return this._size.width?this._size.width:this._size},r.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},r.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},Object.defineProperty(r.prototype,'canRescale',{get:function(){return!0},enumerable:!0,configurable:!0}),r.prototype.scale=function(r){var e=this.getRenderSize()*r;this.resize(e)},r.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:_.prototype.getReflectionTextureMatrix.call(this)},r.prototype.resize=function(r){this.releaseInternalTexture();var e=this.getScene();e&&(this._processSizeParameter(r),this._texture=this.isCube?e.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):e.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions))},r.prototype.render=function(T,e){void 0===T&&(T=!1),void 0===e&&(e=!1);var t=this.getScene();if(t){var x=t.getEngine();if(void 0!==this.useCameraPostProcesses&&(T=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var r=0;r<this._waitingRenderList.length;r++){var n=this._waitingRenderList[r],o=t.getMeshByID(n);o&&this.renderList.push(o)}delete this._waitingRenderList}if(this.renderListPredicate){this.renderList?this.renderList.splice(0):this.renderList=[];var t=this.getScene();if(!t)return;for(var s=t.meshes,r=0,a;r<s.length;r++)a=s[r],this.renderListPredicate(a)&&this.renderList.push(a)}this.onBeforeBindObservable.notifyObservers(this);var l;this.activeCamera?(l=this.activeCamera,x.setViewport(this.activeCamera.viewport,this.getRenderWidth(),this.getRenderHeight()),this.activeCamera!==t.activeCamera&&t.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(!0))):(l=t.activeCamera)&&x.setViewport(l.viewport,this.getRenderWidth(),this.getRenderHeight()),this._renderingManager.reset();for(var h=this.renderList?this.renderList:t.getActiveMeshes().data,c=this.renderList?this.renderList.length:t.getActiveMeshes().length,u=t.getRenderId(),f=0,a;f<c;f++)if(a=h[f],a){if(!a.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}a._preActivateForIntermediateRendering(u);var d=void 0;if(d=!this.renderList&&l&&0==(a.layerMask&l.layerMask),a.isEnabled()&&a.isVisible&&a.subMeshes&&!d){a._activate(u);for(var E=0,_;E<a.subMeshes.length;E++)_=a.subMeshes[E],t._activeIndices.addCount(_.indexCount,!1),this._renderingManager.dispatch(_,a)}}for(var m=0;m<t.particleSystems.length;m++){var g=t.particleSystems[m],v=g.emitter;g.isStarted()&&v&&v.position&&v.isEnabled()&&0<=h.indexOf(v)&&this._renderingManager.dispatchParticles(g)}if(this.isCube)for(var y=0;6>y;y++)this.renderToTarget(y,h,c,T,e),t.incrementRenderId(),t.resetCachedMaterial();else this.renderToTarget(0,h,c,T,e);this.onAfterUnbindObservable.notifyObservers(this),t.activeCamera&&(this.activeCamera&&this.activeCamera!==t.activeCamera&&t.setTransformMatrix(t.activeCamera.getViewMatrix(),t.activeCamera.getProjectionMatrix(!0)),x.setViewport(t.activeCamera.viewport)),t.resetCachedMaterial()}},r.prototype._bestReflectionRenderTargetDimension=function(e,t){var o=e*t,r=p.Tools.NearestPOT(o+16384/(128+o));return C(p.Tools.FloorPOT(e),r)},r.prototype.unbindFrameBuffer=function(r,e){var t=this;this._texture&&r.unBindFramebuffer(this._texture,this.isCube,function(){t.onAfterRenderObservable.notifyObservers(e)})},r.prototype.renderToTarget=function(e,t,i,r,n){var o=this.getScene();if(o){var s=o.getEngine();this._texture&&(this._postProcessManager?this._postProcessManager._prepareFrame(this._texture,this._postProcesses):r&&o.postProcessManager._prepareFrame(this._texture)||this._texture&&s.bindFramebuffer(this._texture,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,this.depthStencilTexture?this.depthStencilTexture:void 0),this.onBeforeRenderObservable.notifyObservers(e),this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(s):s.clear(this.clearColor||o.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0),this._renderingManager.render(this.customRenderFunction,t,this.renderParticles,this.renderSprites),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._texture,e,this._postProcesses,this.ignoreCameraViewport):r&&o.postProcessManager._finalizeFrame(!1,this._texture,e),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0),n&&p.Tools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),s),this.isCube&&5!==e?this.onAfterRenderObservable.notifyObservers(e):(this.isCube&&5===e&&s.generateMipMapsForCubemap(this._texture),this.unbindFrameBuffer(s,e)))}},r.prototype.setRenderingOrder=function(o,e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._renderingManager.setRenderingOrder(o,e,t,i)},r.prototype.setRenderingAutoClearDepthStencil=function(r,e){this._renderingManager.setRenderingAutoClearDepthStencil(r,e)},r.prototype.clone=function(){var o=this.getSize(),e=new r(this.name,o,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.coordinatesMode=this.coordinatesMode,this.renderList&&(e.renderList=this.renderList.slice(0)),e},r.prototype.serialize=function(){if(!this.name)return null;var t=_.prototype.serialize.call(this);if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(var e=0;e<this.renderList.length;e++)t.renderList.push(this.renderList[e].id);return t},r.prototype.disposeFramebufferObjects=function(){var r=this.getInternalTexture(),e=this.getScene();r&&e&&e.getEngine()._releaseFramebufferObjects(r)},r.prototype.dispose=function(){this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var t=this.getScene();if(t){var e=t.customRenderTargets.indexOf(this);0<=e&&t.customRenderTargets.splice(e,1);for(var i=0,r=t.cameras,a;i<r.length;i++)a=r[i],e=a.customRenderTargets.indexOf(this),0<=e&&a.customRenderTargets.splice(e,1);_.prototype.dispose.call(this)}},r.prototype._rebuild=function(){this.refreshRate===r.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=r.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},r.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},r._REFRESHRATE_RENDER_ONCE=0,r._REFRESHRATE_RENDER_ONEVERYFRAME=1,r._REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,r}(p.Texture);p.RenderTargetTexture=e}(e||(e={}));var e;!function(r){var e=function(e){function t(t,m,g,y,o){var T=this,a=o&&o.generateMipMaps&&o.generateMipMaps,x=o&&o.generateDepthTexture&&o.generateDepthTexture,b=!o||void 0===o.doNotChangeAspectRatio||o.doNotChangeAspectRatio;if(T=e.call(this,t,m,y,a,b)||this,T._engine=y.getEngine(),!T.isSupported)return void T.dispose();for(var c=[],E=[],v=0;v<g;v++)o&&o.types&&void 0!==o.types[v]?c.push(o.types[v]):c.push(o&&o.defaultType?o.defaultType:r.Engine.TEXTURETYPE_UNSIGNED_INT),o&&o.samplingModes&&void 0!==o.samplingModes[v]?E.push(o.samplingModes[v]):E.push(r.Texture.BILINEAR_SAMPLINGMODE);var d=!o||void 0===o.generateDepthBuffer||o.generateDepthBuffer,P=o&&void 0!==o.generateStencilBuffer&&o.generateStencilBuffer;return T._size=m,T._multiRenderTargetOptions={samplingModes:E,generateMipMaps:a,generateDepthBuffer:d,generateStencilBuffer:P,generateDepthTexture:x,types:c,textureCount:g},T._createInternalTextures(),T._createTextures(),T}return h(t,e),Object.defineProperty(t.prototype,'isSupported',{get:function(){return 1<this._engine.webGLVersion||this._engine.getCaps().drawBuffersExtension},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'textures',{get:function(){return this._textures},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'depthTexture',{get:function(){return this._textures[this._textures.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'wrapU',{set:function(r){if(this._textures)for(var e=0;e<this._textures.length;e++)this._textures[e].wrapU=r},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'wrapV',{set:function(r){if(this._textures)for(var e=0;e<this._textures.length;e++)this._textures[e].wrapV=r},enumerable:!0,configurable:!0}),t.prototype._rebuild=function(){this.releaseInternalTextures(),this._createInternalTextures();for(var t=0;t<this._internalTextures.length;t++)this._textures[t]._texture=this._internalTextures[t];this._texture=this._internalTextures[0]},t.prototype._createInternalTextures=function(){this._internalTextures=this._engine.createMultipleRenderTarget(this._size,this._multiRenderTargetOptions)},t.prototype._createTextures=function(){this._textures=[];for(var e=0,t;e<this._internalTextures.length;e++)t=new r.Texture(null,this.getScene()),t._texture=this._internalTextures[e],this._textures.push(t);this._texture=this._internalTextures[0]},Object.defineProperty(t.prototype,'samples',{get:function(){return this._samples},set:function(t){this._samples!==t&&(this._samples=this._engine.updateMultipleRenderTargetTextureSampleCount(this._internalTextures,t))},enumerable:!0,configurable:!0}),t.prototype.resize=function(t){this.releaseInternalTextures(),this._internalTextures=this._engine.createMultipleRenderTarget(t,this._multiRenderTargetOptions),this._createInternalTextures()},t.prototype.unbindFrameBuffer=function(r,e){var t=this;r.unBindMultiColorAttachmentFramebuffer(this._internalTextures,this.isCube,function(){t.onAfterRenderObservable.notifyObservers(e)})},t.prototype.dispose=function(){this.releaseInternalTextures(),e.prototype.dispose.call(this)},t.prototype.releaseInternalTextures=function(){if(this._internalTextures)for(var t=this._internalTextures.length-1;0<=t;t--)void 0!==this._internalTextures[t]&&(this._internalTextures[t].dispose(),this._internalTextures.splice(t,1))},t}(r.RenderTargetTexture);r.MultiRenderTarget=e}(e||(e={}));var e;!function(d){var e=function(c){function o(e,t,r,n,o,s,a){void 0===o&&(o=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===s&&(s=d.Texture.BILINEAR_SAMPLINGMODE),void 0===a&&(a=!0);var l=c.call(this,e,t,r,n,!0,o,!1,s,a)||this;return l.scene=r,l.mirrorPlane=new d.Plane(0,1,0,1),l._transformMatrix=d.Matrix.Zero(),l._mirrorMatrix=d.Matrix.Zero(),l._adaptiveBlurKernel=0,l._blurKernelX=0,l._blurKernelY=0,l._blurRatio=1,l.ignoreCameraViewport=!0,l._updateGammaSpace(),l._imageProcessingConfigChangeObserver=r.imageProcessingConfiguration.onUpdateParameters.add(function(){l._updateGammaSpace}),l.onBeforeRenderObservable.add(function(){d.Matrix.ReflectionToRef(l.mirrorPlane,l._mirrorMatrix),l._savedViewMatrix=r.getViewMatrix(),l._mirrorMatrix.multiplyToRef(l._savedViewMatrix,l._transformMatrix),r.setTransformMatrix(l._transformMatrix,r.getProjectionMatrix()),r.clipPlane=l.mirrorPlane,r.getEngine().cullBackFaces=!1,r._mirroredCameraPosition=d.Vector3.TransformCoordinates(r.activeCamera.globalPosition,l._mirrorMatrix)}),l.onAfterRenderObservable.add(function(){r.setTransformMatrix(l._savedViewMatrix,r.getProjectionMatrix()),r.getEngine().cullBackFaces=!0,r._mirroredCameraPosition=null,delete r.clipPlane}),l}return h(o,c),Object.defineProperty(o.prototype,'blurRatio',{get:function(){return this._blurRatio},set:function(t){this._blurRatio!==t&&(this._blurRatio=t,this._preparePostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'adaptiveBlurKernel',{set:function(t){this._adaptiveBlurKernel=t,this._autoComputeBlurKernel()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'blurKernel',{set:function(t){this.blurKernelX=t,this.blurKernelY=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'blurKernelX',{get:function(){return this._blurKernelX},set:function(t){this._blurKernelX!==t&&(this._blurKernelX=t,this._preparePostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'blurKernelY',{get:function(){return this._blurKernelY},set:function(t){this._blurKernelY!==t&&(this._blurKernelY=t,this._preparePostProcesses())},enumerable:!0,configurable:!0}),o.prototype._autoComputeBlurKernel=function(){var r=this.getScene().getEngine(),e=this.getRenderWidth()/r.getRenderWidth(),t=this.getRenderHeight()/r.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*e,this.blurKernelY=this._adaptiveBlurKernel*t},o.prototype._onRatioRescale=function(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()},o.prototype._updateGammaSpace=function(){this.gammaSpace=!this.scene.imageProcessingConfiguration.isEnabled||!this.scene.imageProcessingConfiguration.applyByPostProcess},o.prototype._preparePostProcesses=function(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){var e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender?d.Engine.TEXTURETYPE_FLOAT:d.Engine.TEXTURETYPE_HALF_FLOAT;this._blurX=new d.BlurPostProcess('horizontal blur',new d.Vector2(1,0),this._blurKernelX,this._blurRatio,null,d.Texture.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&2>this.samples&&this._texture?this._blurX.inputTexture=this._texture:this._blurX.alwaysForcePOT=!0,this._blurY=new d.BlurPostProcess('vertical blur',new d.Vector2(0,1),this._blurKernelY,this._blurRatio,null,d.Texture.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)},o.prototype.clone=function(){var i=this.getScene();if(!i)return this;var a=this.getSize(),t=new o(this.name,a.width,i,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(t.renderList=this.renderList.slice(0)),t},o.prototype.serialize=function(){if(!this.name)return null;var t=c.prototype.serialize.call(this);return t.mirrorPlane=this.mirrorPlane.asArray(),t},o.prototype.dispose=function(){c.prototype.dispose.call(this),this.scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver)},o}(d.RenderTargetTexture);d.MirrorTexture=e}(e||(e={}));var e;!function(a){var e=function(l){function o(e,t,r,n){var o=l.call(this,e,t,r,n,!0)||this;return o.refractionPlane=new a.Plane(0,1,0,1),o.depth=2,o.onBeforeRenderObservable.add(function(){r.clipPlane=o.refractionPlane}),o.onAfterRenderObservable.add(function(){delete r.clipPlane}),o}return h(o,l),o.prototype.clone=function(){var i=this.getScene();if(!i)return this;var a=this.getSize(),t=new o(this.name,a.width,i,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.refractionPlane=this.refractionPlane.clone(),this.renderList&&(t.renderList=this.renderList.slice(0)),t.depth=this.depth,t},o.prototype.serialize=function(){if(!this.name)return null;var t=l.prototype.serialize.call(this);return t.mirrorPlane=this.refractionPlane.asArray(),t.depth=this.depth,t},o}(a.RenderTargetTexture);a.RefractionTexture=e}(e||(e={}));var e;!function(d){var e=function(e){function o(t,c,r,n,p,s){void 0===r&&(r=null),void 0===p&&(p=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===s&&(s=d.Engine.TEXTUREFORMAT_RGBA);var a=e.call(this,null,r,!n,void 0,p,void 0,void 0,void 0,void 0,s)||this;a.name=t,a._engine=a.getScene().getEngine(),a.wrapU=d.Texture.CLAMP_ADDRESSMODE,a.wrapV=d.Texture.CLAMP_ADDRESSMODE,a._generateMipMaps=n,c.getContext?(a._canvas=c,a._texture=a._engine.createDynamicTexture(c.width,c.height,n,p)):(a._canvas=document.createElement('canvas'),a._texture=c.width||0===c.width?a._engine.createDynamicTexture(c.width,c.height,n,p):a._engine.createDynamicTexture(c,c,n,p));var l=a.getSize();return a._canvas.width=l.width,a._canvas.height=l.height,a._context=a._canvas.getContext('2d'),a}return h(o,e),Object.defineProperty(o.prototype,'canRescale',{get:function(){return!0},enumerable:!0,configurable:!0}),o.prototype._recreate=function(t){this._canvas.width=t.width,this._canvas.height=t.height,this.releaseInternalTexture(),this._texture=this._engine.createDynamicTexture(t.width,t.height,this._generateMipMaps,this._samplingMode)},o.prototype.scale=function(r){var e=this.getSize();e.width*=r,e.height*=r,this._recreate(e)},o.prototype.scaleTo=function(r,e){var t=this.getSize();t.width=r,t.height=e,this._recreate(t)},o.prototype.getContext=function(){return this._context},o.prototype.clear=function(){var t=this.getSize();this._context.fillRect(0,0,t.width,t.height)},o.prototype.update=function(t){this._engine.updateDynamicTexture(this._texture,this._canvas,void 0===t||t,void 0,this._format||void 0)},o.prototype.drawText=function(d,e,t,i,r,n,o,s){void 0===s&&(s=!0);var a=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,a.width,a.height)),this._context.font=i,null===e||void 0===e){var l=this._context.measureText(d);e=(a.width-l.width)/2}if(null===t||void 0===t){var p=parseInt(i.replace(/\D/g,''));t=a.height/2+p/3.65}this._context.fillStyle=r,this._context.fillText(d,e,t),s&&this.update(o)},o.prototype.clone=function(){var i=this.getScene();if(!i)return this;var a=this.getSize(),t=new o(this.name,a,i,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t},o.prototype._rebuild=function(){this.update()},o}(d.Texture);d.DynamicTexture=e}(e||(e={}));var e;!function(d){var e=function(e){function o(t,c,r,n,p,s,a){void 0===n&&(n=!1),void 0===p&&(p=!1),void 0===s&&(s=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===a&&(a={autoPlay:!0,loop:!0,autoUpdateTexture:!0});var l=e.call(this,null,r,!n,p)||this;return l._stillImageCaptured=!1,l._createInternalTexture=function(){if(null==l._texture)if(!l._engine.needPOTTextures||d.Tools.IsExponentOfTwo(l.video.videoWidth)&&d.Tools.IsExponentOfTwo(l.video.videoHeight)?(l.wrapU=d.Texture.WRAP_ADDRESSMODE,l.wrapV=d.Texture.WRAP_ADDRESSMODE):(l.wrapU=d.Texture.CLAMP_ADDRESSMODE,l.wrapV=d.Texture.CLAMP_ADDRESSMODE,l._generateMipMaps=!1),l._texture=l._engine.createDynamicTexture(l.video.videoWidth,l.video.videoHeight,l._generateMipMaps,l._samplingMode),l.video.autoplay)l._texture.isReady=!0,l._updateInternalTexture(),l._onLoadObservable&&l._onLoadObservable.hasObservers()&&l.onLoadObservable.notifyObservers(l);else{var e=l.video.onplaying;l.video.onplaying=function(){l.video.onplaying=e,l._texture.isReady=!0,l._updateInternalTexture(),l.video.pause(),l._onLoadObservable&&l._onLoadObservable.hasObservers()&&l.onLoadObservable.notifyObservers(l)},l.video.play()}},l.reset=function(){null!=l._texture&&(l._texture.dispose(),l._texture=null)},l._updateInternalTexture=function(){null!=l._texture&&l._texture.isReady&&(l.video.readyState<l.video.HAVE_CURRENT_DATA||l._engine.updateVideoTexture(l._texture,l.video,l._invertY))},l._engine=l.getScene().getEngine(),l._generateMipMaps=n,l._samplingMode=s,l.autoUpdateTexture=a.autoUpdateTexture,l.name=t||l._getName(c),l.video=l._getVideo(c),void 0!==a.autoPlay&&(l.video.autoplay=a.autoPlay),void 0!==a.loop&&(l.video.loop=a.loop),l.video.addEventListener('canplay',l._createInternalTexture),l.video.addEventListener('paused',l._updateInternalTexture),l.video.addEventListener('seeked',l._updateInternalTexture),l.video.addEventListener('emptied',l.reset),l.video.readyState>=l.video.HAVE_CURRENT_DATA&&l._createInternalTexture(),l}return h(o,e),o.prototype._getName=function(t){return t instanceof HTMLVideoElement?t.currentSrc:'object'==typeof t?t.toString():t},o.prototype._getVideo=function(e){if(e instanceof HTMLVideoElement)return d.Tools.SetCorsBehavior(e.currentSrc,e),e;var r=document.createElement('video');return'string'==typeof e?(d.Tools.SetCorsBehavior(e,r),r.src=e):(d.Tools.SetCorsBehavior(e[0],r),e.forEach(function(o){var e=document.createElement('source');e.src=o,r.appendChild(e)})),r},o.prototype._rebuild=function(){this.update()},o.prototype.update=function(){this.autoUpdateTexture&&this.updateTexture(!0)},o.prototype.updateTexture=function(t){t&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))},o.prototype.updateURL=function(t){this.video.src=t},o.prototype.dispose=function(){e.prototype.dispose.call(this),this.video.removeEventListener('canplay',this._createInternalTexture),this.video.removeEventListener('paused',this._updateInternalTexture),this.video.removeEventListener('seeked',this._updateInternalTexture),this.video.removeEventListener('emptied',this.reset),this.video.pause()},o.CreateFromWebCam=function(i,t,e){var r=document.createElement('video'),a;e&&e.deviceId&&(a={exact:e.deviceId}),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:e}).then(function(a){void 0===r.mozSrcObject?r.srcObject=a:r.mozSrcObject=a;var e=function(){t&&t(new o('video',r,i,!0,!0)),r.removeEventListener('playing',e)};r.addEventListener('playing',e),r.play()}).catch(function(e){d.Tools.Error(e.name)}):(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia&&navigator.getUserMedia({video:{deviceId:a,width:{min:e&&e.minWidth||256,max:e&&e.maxWidth||640},height:{min:e&&e.minHeight||256,max:e&&e.maxHeight||480}}},function(a){void 0===r.mozSrcObject?r.src=window.URL&&window.URL.createObjectURL(a)||a:r.mozSrcObject=a,r.play(),t&&t(new o('video',r,i,!0,!0))},function(e){d.Tools.Error(e.name)}))},o}(d.Texture);d.VideoTexture=e}(e||(e={}));var e;!function(d){var e=function(e){function c(t,p,r,n,o,s,f,l,_){void 0===s&&(s=!0),void 0===f&&(f=!1),void 0===l&&(l=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===_&&(_=d.Engine.TEXTURETYPE_UNSIGNED_INT);var c=e.call(this,null,o,!s,f)||this;return c.format=n,c._engine=o.getEngine(),c._texture=o.getEngine().createRawTexture(t,p,r,n,s,f,l,null,_),c.wrapU=d.Texture.CLAMP_ADDRESSMODE,c.wrapV=d.Texture.CLAMP_ADDRESSMODE,c}return h(c,e),c.prototype.update=function(t){this._engine.updateRawTexture(this._texture,t,this._texture.format,this._texture.invertY,void 0,this._texture.type)},c.CreateLuminanceTexture=function(e,t,r,i,o,n,a){return void 0===o&&(o=!0),void 0===n&&(n=!1),void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE),new c(e,t,r,d.Engine.TEXTUREFORMAT_LUMINANCE,i,o,n,a)},c.CreateLuminanceAlphaTexture=function(e,t,r,i,o,n,a){return void 0===o&&(o=!0),void 0===n&&(n=!1),void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE),new c(e,t,r,d.Engine.TEXTUREFORMAT_LUMINANCE_ALPHA,i,o,n,a)},c.CreateAlphaTexture=function(e,t,r,i,o,n,a){return void 0===o&&(o=!0),void 0===n&&(n=!1),void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE),new c(e,t,r,d.Engine.TEXTUREFORMAT_ALPHA,i,o,n,a)},c.CreateRGBTexture=function(e,t,r,i,o,n,a,s){return void 0===o&&(o=!0),void 0===n&&(n=!1),void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===s&&(s=d.Engine.TEXTURETYPE_UNSIGNED_INT),new c(e,t,r,d.Engine.TEXTUREFORMAT_RGB,i,o,n,a,s)},c.CreateRGBATexture=function(e,t,r,i,o,n,a,s){return void 0===o&&(o=!0),void 0===n&&(n=!1),void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===s&&(s=d.Engine.TEXTURETYPE_UNSIGNED_INT),new c(e,t,r,d.Engine.TEXTUREFORMAT_RGBA,i,o,n,a,s)},c}(d.Texture);d.RawTexture=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,f,_){void 0===a&&(a=!0),void 0===f&&(f=!1),void 0===_&&(_=d.Texture.TRILINEAR_SAMPLINGMODE);var c=e.call(this,null,s,!a,f)||this;return c.format=o,c._engine=s.getEngine(),c._texture=s.getEngine().createRawTexture3D(t,p,r,n,o,a,f,_),c.is3D=!0,c}return h(t,e),t.prototype.update=function(t){this._texture&&this._engine.updateRawTexture3D(this._texture,t,this._texture.format,this._texture.invertY)},t}(d.Texture);d.RawTexture3D=e}(e||(e={}));var e;!function(y){var e=function(){function e(e,_,i,r,n,o,s,a,l,m,c,u,f,d){void 0===s&&(s=y.Texture.NEAREST_SAMPLINGMODE),void 0===m&&(m=null),void 0===c&&(c=y.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===u&&(u='postprocess'),void 0===d&&(d=!1),this.name=e,this.width=-1,this.height=-1,this._outputTexture=null,this.autoClear=!0,this.alphaMode=y.Engine.ALPHA_DISABLE,this.animations=[],this.enablePixelPerfectMode=!1,this.scaleMode=y.Engine.SCALEMODE_FLOOR,this.alwaysForcePOT=!1,this.samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._textures=new y.SmartArray(2),this._currentRenderTextureInd=0,this._scaleRatio=new y.Vector2(1,1),this._texelSize=y.Vector2.Zero(),this.onActivateObservable=new y.Observable,this.onSizeChangedObservable=new y.Observable,this.onApplyObservable=new y.Observable,this.onBeforeRenderObservable=new y.Observable,this.onAfterRenderObservable=new y.Observable,null==o?a&&(this._engine=a,this._engine.postProcesses.push(this)):(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this)),this._options=n,this.renderTargetSamplingMode=s||y.Texture.NEAREST_SAMPLINGMODE,this._reusable=l||!1,this._textureType=c,this._samplers=r||[],this._samplers.push('textureSampler'),this._fragmentUrl=_,this._vertexUrl=u,this._parameters=i||[],this._parameters.push('scale'),this._indexParameters=f,d||this.updateEffect(m)}return Object.defineProperty(e.prototype,'onActivate',{set:function(t){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),t&&(this._onActivateObserver=this.onActivateObservable.add(t))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onSizeChanged',{set:function(t){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onApply',{set:function(t){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onBeforeRender',{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onAfterRender',{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'inputTexture',{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(t){this._forcedOutputTexture=t},enumerable:!0,configurable:!0}),e.prototype.getCamera=function(){return this._camera},Object.defineProperty(e.prototype,'texelSize',{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!0,configurable:!0}),e.prototype.getEngine=function(){return this._engine},e.prototype.getEffect=function(){return this._effect},e.prototype.shareOutputWith=function(t){return this._disposeTextures(),this._shareOutputWithPostProcess=t,this},e.prototype.useOwnOutput=function(){0==this._textures.length&&(this._textures=new y.SmartArray(2)),this._shareOutputWithPostProcess=null},e.prototype.updateEffect=function(a,e,t,i,r,n){void 0===a&&(a=null),void 0===e&&(e=null),void 0===t&&(t=null),this._effect=this._engine.createEffect({vertex:this._vertexUrl,fragment:this._fragmentUrl},['position'],e||this._parameters,t||this._samplers,null===a?'':a,void 0,r,n,i||this._indexParameters)},e.prototype.isReusable=function(){return this._reusable},e.prototype.markTextureDirty=function(){this.width=-1},e.prototype.activate=function(e,t,i){var r=this;void 0===t&&(t=null),e=e||this._camera;var n=e.getScene(),o=n.getEngine(),s=o.getCaps().maxTextureSize,a=0|(t?t.width:this._engine.getRenderWidth(!0))*this._options,l=0|(t?t.height:this._engine.getRenderHeight(!0))*this._options,h=e.parent;h&&(h.leftCamera==e||h.rightCamera==e)&&(a/=2);var c=this._options.width||a,u=this._options.height||l;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var f=o.currentViewport;f&&(c*=f.width,u*=f.height)}if((this.renderTargetSamplingMode===y.Texture.TRILINEAR_SAMPLINGMODE||this.alwaysForcePOT)&&(this._options.width||(c=o.needPOTTextures?y.Tools.GetExponentOfTwo(c,s,this.scaleMode):c),this._options.height||(u=o.needPOTTextures?y.Tools.GetExponentOfTwo(u,s,this.scaleMode):u)),this.width!==c||this.height!==u){if(0<this._textures.length){for(var d=0;d<this._textures.length;d++)this._engine._releaseTexture(this._textures.data[d]);this._textures.reset()}this.width=c,this.height=u;var p={width:this.width,height:this.height},_={generateMipMaps:!1,generateDepthBuffer:i||0===e._postProcesses.indexOf(this),generateStencilBuffer:(i||0===e._postProcesses.indexOf(this))&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(p,_)),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture(p,_)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}this._textures.forEach(function(t){t.samples!==r.samples&&r._engine.updateRenderTargetTextureSampleCount(t,r.samples)})}var m;return this._shareOutputWithPostProcess?m=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?(m=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height):m=this.inputTexture,this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(a/c,l/u),this._engine.bindFramebuffer(m,0,a,l,!0)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(m,0,void 0,void 0,!0)),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===y.Engine.ALPHA_DISABLE&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,!0,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),m},Object.defineProperty(e.prototype,'isSupported',{get:function(){return this._effect.isSupported},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'aspectRatio',{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!0,configurable:!0}),e.prototype.isReady=function(){return this._effect&&this._effect.isReady()},e.prototype.apply=function(){if(!this._effect||!this._effect.isReady())return null;this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var t;return t=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this._effect._bindTexture('textureSampler',t),this._effect.setVector2('scale',this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect},e.prototype._disposeTextures=function(){if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(0<this._textures.length)for(var t=0;t<this._textures.length;t++)this._engine._releaseTexture(this._textures.data[t]);this._textures.dispose()}},e.prototype.dispose=function(o){if(o=o||this._camera,this._disposeTextures(),this._scene){var e=this._scene.postProcesses.indexOf(this);-1!==e&&this._scene.postProcesses.splice(e,1)}else{var t=this._engine.postProcesses.indexOf(this);-1!==t&&this._engine.postProcesses.splice(t,1)}if(o){if(o.detachPostProcess(this),0===o._postProcesses.indexOf(this)&&0<o._postProcesses.length){var i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},e}();y.PostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,c,r,n,o,s,a,l){return void 0===r&&(r=null),void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===l&&(l=!1),e.call(this,t,'pass',null,null,c,r,n,o,s,void 0,a,void 0,null,l)||this}return h(t,e),t}(d.PostProcess);d.PassPostProcess=e}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(d){var e=function(){function a(e,t,r){this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=a.FILTER_NONE,this._filteringQuality=a.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=d.Vector3.Zero(),this._viewMatrix=d.Matrix.Zero(),this._projectionMatrix=d.Matrix.Zero(),this._transformMatrix=d.Matrix.Zero(),this._cachedPosition=new d.Vector3(S,S,S),this._cachedDirection=new d.Vector3(S,S,S),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=d.Matrix.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),t._shadowGenerator=this;var i=this._scene.getEngine().getCaps();this._textureType=r?i.textureFloatRender&&i.textureFloatLinearFiltering?d.Engine.TEXTURETYPE_FLOAT:i.textureHalfFloatRender&&i.textureHalfFloatLinearFiltering?d.Engine.TEXTURETYPE_HALF_FLOAT:d.Engine.TEXTURETYPE_UNSIGNED_INT:i.textureHalfFloatRender&&i.textureHalfFloatLinearFiltering?d.Engine.TEXTURETYPE_HALF_FLOAT:i.textureFloatRender&&i.textureFloatLinearFiltering?d.Engine.TEXTURETYPE_FLOAT:d.Engine.TEXTURETYPE_UNSIGNED_INT,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(a.prototype,'bias',{get:function(){return this._bias},set:function(t){this._bias=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'normalBias',{get:function(){return this._normalBias},set:function(t){this._normalBias=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'blurBoxOffset',{get:function(){return this._blurBoxOffset},set:function(t){this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._disposeBlurPostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'blurScale',{get:function(){return this._blurScale},set:function(t){this._blurScale!==t&&(this._blurScale=t,this._disposeBlurPostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'blurKernel',{get:function(){return this._blurKernel},set:function(t){this._blurKernel!==t&&(this._blurKernel=t,this._disposeBlurPostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useKernelBlur',{get:function(){return this._useKernelBlur},set:function(t){this._useKernelBlur!==t&&(this._useKernelBlur=t,this._disposeBlurPostProcesses())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'depthScale',{get:function(){return void 0===this._depthScale?this._light.getDepthScale():this._depthScale},set:function(t){this._depthScale=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'filter',{get:function(){return this._filter},set:function(t){if(this._light.needCube()){if(t===a.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(t===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(t===a.FILTER_PCF||t===a.FILTER_PCSS)return void(this.usePoissonSampling=!0)}return(t===a.FILTER_PCF||t===a.FILTER_PCSS)&&1===this._scene.getEngine().webGLVersion?void(this.usePoissonSampling=!0):void(this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'usePoissonSampling',{get:function(){return this.filter===a.FILTER_POISSONSAMPLING},set:function(t){(t||this.filter===a.FILTER_POISSONSAMPLING)&&(this.filter=t?a.FILTER_POISSONSAMPLING:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useVarianceShadowMap',{get:function(){return d.Tools.Warn('VSM are now replaced by ESM. Please use useExponentialShadowMap instead.'),this.useExponentialShadowMap},set:function(e){d.Tools.Warn('VSM are now replaced by ESM. Please use useExponentialShadowMap instead.'),this.useExponentialShadowMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useBlurVarianceShadowMap',{get:function(){return d.Tools.Warn('VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.'),this.useBlurExponentialShadowMap},set:function(e){d.Tools.Warn('VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.'),this.useBlurExponentialShadowMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useExponentialShadowMap',{get:function(){return this.filter===a.FILTER_EXPONENTIALSHADOWMAP},set:function(t){(t||this.filter===a.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=t?a.FILTER_EXPONENTIALSHADOWMAP:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useBlurExponentialShadowMap',{get:function(){return this.filter===a.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(t){(t||this.filter===a.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=t?a.FILTER_BLUREXPONENTIALSHADOWMAP:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useCloseExponentialShadowMap',{get:function(){return this.filter===a.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(t){(t||this.filter===a.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=t?a.FILTER_CLOSEEXPONENTIALSHADOWMAP:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useBlurCloseExponentialShadowMap',{get:function(){return this.filter===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(t){(t||this.filter===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=t?a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'usePercentageCloserFiltering',{get:function(){return this.filter===a.FILTER_PCF},set:function(t){(t||this.filter===a.FILTER_PCF)&&(this.filter=t?a.FILTER_PCF:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'filteringQuality',{get:function(){return this._filteringQuality},set:function(t){this._filteringQuality=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'useContactHardeningShadow',{get:function(){return this.filter===a.FILTER_PCSS},set:function(t){(t||this.filter===a.FILTER_PCSS)&&(this.filter=t?a.FILTER_PCSS:a.FILTER_NONE)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'contactHardeningLightSizeUVRatio',{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(t){this._contactHardeningLightSizeUVRatio=t},enumerable:!0,configurable:!0}),a.prototype.getDarkness=function(){return this._darkness},a.prototype.setDarkness=function(t){return this._darkness=1<=t?1:0>=t?0:t,this},a.prototype.setTransparencyShadow=function(t){return this._transparencyShadow=t,this},a.prototype.getShadowMap=function(){return this._shadowMap},a.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},a.prototype.addShadowCaster=function(r,e){return void 0===e&&(e=!0),this._shadowMap?(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.push(r),e&&(t=this._shadowMap.renderList).push.apply(t,r.getChildMeshes()),this):this;var t},a.prototype.removeShadowCaster=function(a,e){if(void 0===e&&(e=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var t=this._shadowMap.renderList.indexOf(a);if(-1!==t&&this._shadowMap.renderList.splice(t,1),e)for(var i=0,r=a.getChildren(),n;i<r.length;i++)n=r[i],this.removeShadowCaster(n);return this},a.prototype.getLight=function(){return this._light},a.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},a.prototype._initializeShadowMap=function(){var t=this,i=this._scene.getEngine();1<i.webGLVersion?(this._shadowMap=new d.RenderTargetTexture(this._light.name+'_shadowMap',this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(d.Engine.LESS,!0)):this._shadowMap=new d.RenderTargetTexture(this._light.name+'_shadowMap',this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(d.Texture.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._shadowMap.onBeforeRenderObservable.add(function(r){t._currentFaceIndex=r,t._filter===a.FILTER_PCF&&i.setColorWrite(!1)}),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.onAfterUnbindObservable.add(function(){if(t._filter===a.FILTER_PCF&&i.setColorWrite(!0),t.useBlurExponentialShadowMap||t.useBlurCloseExponentialShadowMap){var r=t.getShadowMapForRendering();r&&t._scene.postProcessManager.directRender(t._blurPostProcesses,r.getInternalTexture(),!0)}});var r=new d.Color4(0,0,0,0),n=new d.Color4(1,1,1,1);this._shadowMap.onClearObservable.add(function(o){t._filter===a.FILTER_PCF?o.clear(n,!1,!0,!1):t.useExponentialShadowMap||t.useBlurExponentialShadowMap?o.clear(r,!0,!0,!1):o.clear(n,!0,!0,!1)})},a.prototype._initializeBlurRTTAndPostProcesses=function(){var o=this,e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new d.RenderTargetTexture(this._light.name+'_shadowMap2',t,this._scene,!1,!0,this._textureType),this._shadowMap2.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(d.Texture.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new d.BlurPostProcess(this._light.name+'KernelBlurX',new d.Vector2(1,0),this.blurKernel,1,null,d.Texture.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.onApplyObservable.add(function(t){t.setTexture('textureSampler',o._shadowMap)}),this._kernelBlurYPostprocess=new d.BlurPostProcess(this._light.name+'KernelBlurY',new d.Vector2(0,1),this.blurKernel,1,null,d.Texture.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===d.Engine.TEXTURETYPE_UNSIGNED_INT&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new d.PostProcess(this._light.name+'DepthBoxBlur','depthBoxBlur',['screenSize','boxOffset'],[],1,null,d.Texture.BILINEAR_SAMPLINGMODE,e,!1,'#define OFFSET '+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.onApplyObservable.add(function(r){r.setFloat2('screenSize',t,t),r.setTexture('textureSampler',o._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},a.prototype._renderForShadowMap=function(a,e,t,i){var r=this._scene.getEngine(),o;if(i.length){for(r.setColorWrite(!1),o=0;o<i.length;o++)this._renderSubMeshForShadowMap(i.data[o]);r.setColorWrite(!0)}for(o=0;o<a.length;o++)this._renderSubMeshForShadowMap(a.data[o]);for(o=0;o<e.length;o++)this._renderSubMeshForShadowMap(e.data[o]);if(this._transparencyShadow)for(o=0;o<t.length;o++)this._renderSubMeshForShadowMap(t.data[o])},a.prototype._renderSubMeshForShadowMap=function(e){var c=this,t=e.getRenderingMesh(),r=this._scene,i=r.getEngine(),o=e.getMaterial();if(o){i.setState(o.backFaceCulling);var n=t._getInstancesRenderList(e._id);if(!n.mustReturn){var a=i.getCaps().instancedArrays&&null!==n.visibleInstances[e._id]&&void 0!==n.visibleInstances[e._id];if(this.isReady(e,a)){if(i.enableEffect(this._effect),t._bind(e,this._effect,d.Material.TriangleFillMode),this._effect.setFloat3('biasAndScale',this.bias,this.normalBias,this.depthScale),this._effect.setMatrix('viewProjection',this.getTransformMatrix()),this.getLight().getTypeID()===d.Light.LIGHTTYPEID_DIRECTIONALLIGHT?this._effect.setVector3('lightData',this._cachedDirection):this._effect.setVector3('lightData',this._cachedPosition),r.activeCamera&&this._effect.setFloat2('depthValues',this.getLight().getDepthMinZ(r.activeCamera),this.getLight().getDepthMinZ(r.activeCamera)+this.getLight().getDepthMaxZ(r.activeCamera)),o&&o.needAlphaTesting()){var s=o.getAlphaTestTexture();s&&(this._effect.setTexture('diffuseSampler',s),this._effect.setMatrix('diffuseMatrix',s.getTextureMatrix()||this._defaultTextureMatrix))}t.useBones&&t.computeBonesUsingShaders&&this._effect.setMatrices('mBones',t.skeleton.getTransformMatrices(t)),d.MaterialHelper.BindMorphTargetParameters(t,this._effect),this.forceBackFacesOnly&&i.setState(!0,0,!1,!0),t._processRendering(e,this._effect,d.Material.TriangleFillMode,n,a,function(r,e){return c._effect.setMatrix('world',e)}),this.forceBackFacesOnly&&i.setState(!0,0,!1,!1)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},a.prototype._applyFilterValues=function(){this._shadowMap&&(this.filter===a.FILTER_NONE||this.filter===a.FILTER_PCSS?this._shadowMap.updateSamplingMode(d.Texture.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(d.Texture.BILINEAR_SAMPLINGMODE))},a.prototype.forceCompilation=function(s,e){var t=this,i=b({useInstances:!1},e),r=this.getShadowMap();if(!r)return void(s&&s(this));var d=r.renderList;if(!d)return void(s&&s(this));for(var p=[],a=0,l=d,_;a<l.length;a++)_=l[a],p.push.apply(p,_.subMeshes);if(0===p.length)return void(s&&s(this));var c=0,u=function(){if(t._scene&&t._scene.getEngine()){for(;t.isReady(p[c],i.useInstances);)if(++c>=p.length)return void(s&&s(t));setTimeout(u,16)}};u()},a.prototype.forceCompilationAsync=function(r){var e=this;return new Promise(function(t){e.forceCompilation(function(){t()},r)})},a.prototype.isReady=function(e,t){var i=[];this._textureType!==d.Engine.TEXTURETYPE_UNSIGNED_INT&&i.push('#define FLOAT'),this.useExponentialShadowMap||this.useBlurExponentialShadowMap?i.push('#define ESM'):(this.usePercentageCloserFiltering||this.useContactHardeningShadow)&&i.push('#define DEPTHTEXTURE');var r=[d.VertexBuffer.PositionKind],n=e.getMesh(),o=e.getMaterial();if(this.normalBias&&n.isVerticesDataPresent(d.VertexBuffer.NormalKind)&&(r.push(d.VertexBuffer.NormalKind),i.push('#define NORMAL'),n.nonUniformScaling&&i.push('#define NONUNIFORMSCALING'),this.getLight().getTypeID()===d.Light.LIGHTTYPEID_DIRECTIONALLIGHT&&i.push('#define DIRECTIONINLIGHTDATA')),o&&o.needAlphaTesting()){var s=o.getAlphaTestTexture();s&&(i.push('#define ALPHATEST'),n.isVerticesDataPresent(d.VertexBuffer.UVKind)&&(r.push(d.VertexBuffer.UVKind),i.push('#define UV1')),n.isVerticesDataPresent(d.VertexBuffer.UV2Kind)&&1===s.coordinatesIndex&&(r.push(d.VertexBuffer.UV2Kind),i.push('#define UV2')))}n.useBones&&n.computeBonesUsingShaders?(r.push(d.VertexBuffer.MatricesIndicesKind),r.push(d.VertexBuffer.MatricesWeightsKind),4<n.numBoneInfluencers&&(r.push(d.VertexBuffer.MatricesIndicesExtraKind),r.push(d.VertexBuffer.MatricesWeightsExtraKind)),i.push('#define NUM_BONE_INFLUENCERS '+n.numBoneInfluencers),i.push('#define BonesPerMesh '+(n.skeleton.bones.length+1))):i.push('#define NUM_BONE_INFLUENCERS 0');var a=n.morphTargetManager,l=0;a&&0<a.numInfluencers&&(i.push('#define MORPHTARGETS'),l=a.numInfluencers,i.push('#define NUM_MORPH_INFLUENCERS '+l),d.MaterialHelper.PrepareAttributesForMorphTargets(r,n,{NUM_MORPH_INFLUENCERS:l})),t&&(i.push('#define INSTANCES'),r.push('world0'),r.push('world1'),r.push('world2'),r.push('world3'));var p=i.join('\n');return this._cachedDefines!==p&&(this._cachedDefines=p,this._effect=this._scene.getEngine().createEffect('shadowMap',r,['world','mBones','viewProjection','diffuseMatrix','lightData','depthValues','biasAndScale','morphTargetInfluences'],['diffuseSampler'],p,void 0,void 0,void 0,{maxSimultaneousMorphTargets:l})),!!this._effect.isReady()&&((this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),(!this._kernelBlurXPostprocess||this._kernelBlurXPostprocess.isReady())&&(!this._kernelBlurYPostprocess||this._kernelBlurYPostprocess.isReady())&&(!this._boxBlurPostprocess||this._boxBlurPostprocess.isReady()))},a.prototype.prepareDefines=function(t,e){var o=this._scene,r=this._light;o.shadowsEnabled&&r.shadowEnabled&&(t['SHADOW'+e]=!0,this.useContactHardeningShadow&&(t['SHADOWPCSS'+e]=!0,this._filteringQuality===a.QUALITY_LOW?t['SHADOWLOWQUALITY'+e]=!0:this._filteringQuality===a.QUALITY_MEDIUM&&(t['SHADOWMEDIUMQUALITY'+e]=!0)),this.usePercentageCloserFiltering?(t['SHADOWPCF'+e]=!0,this._filteringQuality===a.QUALITY_LOW?t['SHADOWLOWQUALITY'+e]=!0:this._filteringQuality===a.QUALITY_MEDIUM&&(t['SHADOWMEDIUMQUALITY'+e]=!0)):this.usePoissonSampling?t['SHADOWPOISSON'+e]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t['SHADOWESM'+e]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t['SHADOWCLOSEESM'+e]=!0),r.needCube()&&(t['SHADOWCUBE'+e]=!0))},a.prototype.bindShadowLight=function(t,e){var i=this._light,r=this._scene;if(r.shadowsEnabled&&i.shadowEnabled){var n=r.activeCamera;if(n){var o=this.getShadowMap();o&&(i.needCube()||e.setMatrix('lightMatrix'+t,this.getTransformMatrix()),this._filter===a.FILTER_PCF?(e.setDepthStencilTexture('shadowSampler'+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4('shadowsInfo',this.getDarkness(),o.getSize().width,1/o.getSize().width,this.frustumEdgeFalloff,t)):this._filter===a.FILTER_PCSS?(e.setDepthStencilTexture('shadowSampler'+t,this.getShadowMapForRendering()),e.setTexture('depthSampler'+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4('shadowsInfo',this.getDarkness(),1/o.getSize().width,this._contactHardeningLightSizeUVRatio*o.getSize().width,this.frustumEdgeFalloff,t)):(e.setTexture('shadowSampler'+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4('shadowsInfo',this.getDarkness(),this.blurScale/o.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),i._uniformBuffer.updateFloat2('depthValues',this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),t))}}},a.prototype.getTransformMatrix=function(){var e=this._scene;if(this._currentRenderID===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderID=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),d.Vector3.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===A(d.Vector3.Dot(this._lightDirection,d.Vector3.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),d.Matrix.LookAtLHToRef(t,t.add(this._lightDirection),d.Vector3.Up(),this._viewMatrix);var o=this.getShadowMap();if(o){var r=o.renderList;r&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,r)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},a.prototype.recreateShadowMap=function(){var r=this._shadowMap;if(r){var e=r.renderList;this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this.filter,this._applyFilterValues(),this._shadowMap.renderList=e}},a.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},a.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},a.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty())},a.prototype.serialize=function(){var o={},e=this.getShadowMap();if(!e)return o;if(o.lightId=this._light.id,o.mapSize=e.getRenderSize(),o.useExponentialShadowMap=this.useExponentialShadowMap,o.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,o.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,o.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,o.usePoissonSampling=this.usePoissonSampling,o.forceBackFacesOnly=this.forceBackFacesOnly,o.depthScale=this.depthScale,o.darkness=this.getDarkness(),o.blurBoxOffset=this.blurBoxOffset,o.blurKernel=this.blurKernel,o.blurScale=this.blurScale,o.useKernelBlur=this.useKernelBlur,o.transparencyShadow=this._transparencyShadow,o.bias=this.bias,o.normalBias=this.normalBias,o.usePercentageCloserFiltering=this.usePercentageCloserFiltering,o.useContactHardeningShadow=this.useContactHardeningShadow,o.filteringQuality=this.filteringQuality,o.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,o.renderList=[],e.renderList)for(var a=0,i;a<e.renderList.length;a++)i=e.renderList[a],o.renderList.push(i.id);return o},a.Parse=function(t,e){for(var i=e.getLightByID(t.lightId),r=new a(t.mapSize,i),n=r.getShadowMap(),o=0;o<t.renderList.length;o++)e.getMeshesByID(t.renderList[o]).forEach(function(t){n&&(n.renderList||(n.renderList=[]),n.renderList.push(t))});return t.usePoissonSampling?r.usePoissonSampling=!0:t.useExponentialShadowMap?r.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:t.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:t.useContactHardeningShadow&&(r.useContactHardeningShadow=!0),t.filteringQuality&&(r.filteringQuality=t.filteringQuality),t.contactHardeningLightSizeUVRatio?r.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio:t.useVarianceShadowMap?r.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),t.depthScale&&(r.depthScale=t.depthScale),t.blurScale&&(r.blurScale=t.blurScale),t.blurBoxOffset&&(r.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(r.useKernelBlur=t.useKernelBlur),t.blurKernel&&(r.blurKernel=t.blurKernel),void 0!==t.bias&&(r.bias=t.bias),void 0!==t.normalBias&&(r.normalBias=t.normalBias),t.darkness&&r.setDarkness(t.darkness),t.transparencyShadow&&r.setTransparencyShadow(!0),r.forceBackFacesOnly=t.forceBackFacesOnly,r},a.FILTER_NONE=0,a.FILTER_EXPONENTIALSHADOWMAP=1,a.FILTER_POISSONSAMPLING=2,a.FILTER_BLUREXPONENTIALSHADOWMAP=3,a.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,a.FILTER_PCF=6,a.FILTER_PCSS=7,a.QUALITY_HIGH=0,a.QUALITY_MEDIUM=1,a.QUALITY_LOW=2,a}();d.ShadowGenerator=e}(e||(e={}));var e;!function(r){var e=function(){function t(o,a,t){void 0===a&&(a=''),void 0===t&&(t='black');var i=this;this._renderingCanvas=o,this._loadingText=a,this._loadingDivBackgroundColor=t,this._resizeLoadingUI=function(){var r=i._renderingCanvas.getBoundingClientRect(),e=window.getComputedStyle(i._renderingCanvas).position;i._loadingDiv&&(i._loadingDiv.style.position='fixed'===e?'fixed':'absolute',i._loadingDiv.style.left=r.left+'px',i._loadingDiv.style.top=r.top+'px',i._loadingDiv.style.width=r.width+'px',i._loadingDiv.style.height=r.height+'px')}}return t.prototype.displayLoadingUI=function(){if(!this._loadingDiv){this._loadingDiv=document.createElement('div'),this._loadingDiv.id='babylonjsLoadingDiv',this._loadingDiv.style.opacity='0',this._loadingDiv.style.transition='opacity 1.5s ease',this._loadingDiv.style.pointerEvents='none',this._loadingTextDiv=document.createElement('div'),this._loadingTextDiv.style.position='absolute',this._loadingTextDiv.style.left='0',this._loadingTextDiv.style.top='50%',this._loadingTextDiv.style.marginTop='80px',this._loadingTextDiv.style.width='100%',this._loadingTextDiv.style.height='20px',this._loadingTextDiv.style.fontFamily='Arial',this._loadingTextDiv.style.fontSize='14px',this._loadingTextDiv.style.color='white',this._loadingTextDiv.style.textAlign='center',this._loadingTextDiv.innerHTML='Loading',this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText;var r=document.createElement('style');r.type='text/css',r.innerHTML='@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }',document.getElementsByTagName('head')[0].appendChild(r);var e=new Image;e.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAYq0lEQVR4Xu2dCZRcVZnHScAJUZSwjSOIbAJmEAZwQCCMoAInYRGIg8AwegQx7AFzUBBmzAFlE4EAwxz2GRk2w7AnAURZBiEOZgyEQDAQAjmEJqTpNd3V1V3Vmd+/6utKV7/1vnpVXd2p/zn3vOV+27vfu/fd/W3QQAPrBZqbm7fJZrN79vf3T+/r67uf4wO9vb37WXQDIwWtra0Tenp6voQTv5XP56/BkfcR3iLk1g6B7hEeI+zP5V+ZiAbqBZ2dnZ8lV+6Gg87CobfhpOc4byf0FjwYE9DneBkWcXrM2tmzNzTxDdQKJPyETCazI46YgiMuI9zJuXJltuChFIHsP/PSfIfTjU19A2mira1tcxy3ey6XO5vEnkV4kes11XBmENDVj97XOT2O03FmWgMuoNLzGRJva8IUnPkzjjcT/kLoKCZzfQB7XiX8M2G8md7AUJgzJ+Z6e88gZ1xGuj3HsY17PcVkrG9gp7CUF/F8PUvxqdZDrFq1ahNVfKjwTCYxZuDE2wjKlc2WViMePM+HPNsFPOdf22OPblD5OZQHvphnV65cjTMzxaQY3eA5V9OO/hmnm1lSjE7woFsQbiXki4++foHnXkW4mLC1JUl947333tsMY3emqfB9jtPJlXN5U0+bOXPmWCPxgOccSy4+AfqPio+9/oFnbyatbqVE28GSZfjQ1NT0KQzaHMcdyPfyaNoE12HcvdxT29K3Fkv8A2vWrPmcifAFZNtD91yRY+SBZ+9UsMtEgD+jTpeenp6JXI6xpKkuUDqRcA6Kr0Wpens+InQTnIpV6Fdi+BQT64ulS5eOIzefD62na7CeoGcnLCM8ykt5OWlzcPv772/BS/w3nP+K+xU11+DvQe5dcrQlTfWAwbNMb8XA8AyGX80xtLlA6TAJuteMbVhhia1v5VMcr+LWMeoZ4xiYw7q6urbhHbgG+paCkIRQehHu4pO3O5fVydEomF5Ulx548JfVD2wqfKE2I3R3ob/f2GoC1DWhdz7HG3i5j2pvb9+Z24m6HvVZQtYsZFWcowlzePEP4jJdR/OQhxTVpAs9NMXxmZxuZKo8IG4s+v8R2tUFphSBTBWzH+OAFwn/gS3TuN55xYoVqfc6dXd3fwHZ1xFaTX0iyGbwjJqXXAammxP00EXx6UMGEx7ram7+vKnzBZ/87Xiwp40tEdDTgYwlHG/CmadSjO7L+XiialOZAej7POFG2VK0Khngl6Pn8/LL0YEtlFh4n8oDAqvaAYH8tzH2iNDm1IIFn8Ax50G7xtgCAU07CfAG4RHOz+vLZL7e0dGxlYlKHaj8BHo25xgrsfV5wrYH4KmouxV+ZZDnCUdwmXxMGgFvFUVWD+jQuOot6rI0tb4gcfaG9v+MrcAn+wj38gL8C7cObmlp2ZRjOkWYD6ypuAf6zjFHLSJ0c/6YQ813DM/yZXgehreiVgP8cvSfsOeExYsXuzs6n8v9j8mqBRZQmdjXVPuira1NHSpn8UDf4Xu0vd2uCtDzacJOlDDf5ng94X8JTWarB8R1EK7ju7udiYgEz/v3pLFKm4oHUHhh3iZdfshpaEYpA4pvKLLXBujLYKRq71XLhUHg27z12rW9B6L/QhLrWWxRH7nzeDK8awi/5HRTEx0K6MZQ694LHk0DqrgfADkreIYz1q5c+UlTEQzesIuMryrggYQWjNL3RGO7p2tuFMeqjaOidgzyCz1yJMTJ6L6d66WEVCcHIO/dQkI75Chs2g97Hoc3jRz9Lge1ED5l4r0gckqRPB0gTw34t1B+h3IqxZkmrn2SULUa7ezZszdE5xfR9130Xsm5ilrnHrmkQOcKvrkncxqrIiY6wlewbw7BOUfDo/b84zzvj9C7J7eCS0NrUiRKCPjUE7ScMBdlF/B2HqBi0ERXBcuXL99YnQz9fX2ah3Up4UnsWGEmDRuUhoTn+Z5PfvbZZ2N/fuCZRJgnfhNVBu73EZoIKt7l0L2UBsYeDZg016nb5EUCWuXQewinUtTuyq2aTStF14a8SD+VDQVj6hDYxjuXf4Hjl83sSMCmTp8j4FtoMuRQ5dAZcii3kk/0s2bBhxIcBxjxUlib1hWInEDO/6qKV+y4geO5HAMntEE/pq+nZyo0ywsG1SmwL4Orf+0yqGCfmvR73LAn9lAeBjQTEhkA+1h49a08iRflcq4H5iuXFU9cz4lqihC/LXS/NZa6Bc+pz5gql5ub6VXD2tZWTSPeyS7XgeLhXrMnEhj6MSHSwaIhFGZH8oA/JzzFeexvJbRN2HW03moT6cEChx6w4QY2rurn85JWrxsiCy0FwjcIqos8w7GZNPulkawDEbFHlaBtjzODEDrVztuKXMmADPWA3RaljyJeNdKq98ilAez8iJdyGqfO31V4NoV/EvyaCqR54V2EshE5Lqcb+TrkstkTLD4WKB4PNNZQ8P05HAelMXNSPWChC8JsYvwthJo0jSoF6fIqjjqe08Aat+LIkd+AVjn09zxbZFqK3tjXAUbXUaWDjTUSyN4J45YZX2Igo4cEOVfFson2ALIxSjR0jog5YNgpfNHM90BxIjDyWIB8Z2NfB01HISJ20wPaw4w1FlavXq1v8aPGXhFw9JNRFTDItifU/RwwpfmKxYsDK180kU4x0lhAXvOSJUs+bezlIDL2N4xi4GpjK4MGCuzUA+SPxzn3m4iKgKyV2DCV08DeMWg0B+zHHOt2DpjS3Mz1BfFOM25C5ZH4LxldJBB0g7GVARkaXgv8VsKqZtIMPpN9RUnJgRzU5Wfp22vifcG3+2vQvmdsdQXsX2pm+oKX+GYjjQXkPWqsXshpRhcJ0RpbGShSHiSuheP37ZYHsGusVHOrU1lMxkO9od4eE+8LlSzQqfetpnPAooBN/2Um+gISp89MkF8K4G3RrMJYoOhbYGxlQEGhSOGogfoLwipExGtUZVVBYIVAluaAaUpuWA+YujlPF22Ra/iBLYEOsV6tV4w0FiitfmLsXiBMU0NiAVrfsp77Zd8MHPgbDoHtva6uLs1jiv1piAKy5tCG+4KJ9wVO/p6RDzvy+b5rzSwP9Okh/WKPERiCWzfk4K8bUSTiOljAyCdx5DZG4gE8W5Dov+NYUfsV/j50fUC4dmXIQDh0qQ6PVgJsOcLM8oA410Ggvo6Ojr81di+g2TKuQOiyJOKWxlpCJpM5zUjKAL3awTsamQfEbYhjtDGKa5tPsyn/wAuiURftlBO56h6aunEwCMxxvV1d+2Fr7Jce2vAu5LUtLeoGi/19gtbToCaR97BoD6BvUs+WkXqgbw6OuhC6wH5l4rRGaCFOvYnjYbyxnpcsCvDVhYOxo6+zszNwSNHVTtJEmSiwzlMAQmNPwIPW42Dds2hfEK/5WJo0Fth+5VNxFHSlkoTzFRh/N3wnq0OGWxXtdoO8enFwaI4jsyidYgNZTxhrMEjEJ4w+En65ESWRXZ7Q4K/COqDAPlhka87WedB8KawmngTIHREOJs5pMiRp+p/GGgxL1FiA9hxjK6G1tVVdhJGAV15+cPXq1f7dahVC20Wg4miCp0uTe3Xh4Hwu93rY1B7SR/t7xQbP5R1FGgpy8IlKe+MJhZ9Aa7u5jPm+pGLX2BMDOZ+hDXgQiXIJ5xoXHZg96anEEFcvOTi0SMUXS4w0FijSTzTWYEA3hkTSEtDI2qw6RoytDLA6jctCvzKqJ8oPFOO7kAhnYe9cZGiWiZ/N9ezguWaSL4h3TUfvKJIfoN0I4sjigYSdZyxlcDVMgEczEY41ER6oZFBOh2Yqegf2zYoziFC3DuZZrjSTPLDtMlxaNPmPP/54W2OPxksrVozP5fLPGr8vEOpbxJCr3jQSJyDvGRNRhv7iHh8vE5LMpKznHBz4zSTOaXwe+mXGGh9tbWvVQf+iyfCAON/ZlTj4v43ECfB94Le4CuMrWVpTtw7O9fZOM5M8oD7xVSOLBdLuNWN1g7bgJUF8+4qpBjf7Te9M6hD4tBDc0289Wh2MHbuaSR7gsHOMLBaQ9W/G6o5MJrNDPu9dcYdQ33Yc95I6OFV5hnp2cGCliDingX5KU+9MShd0dmqta/k8J4zwnV2JsuuNxAnI83VwNpO52kiSoC4djA255cuXBzYPycGzjTQWkPdNY00OfRcQVLafRnd39ySLLsG1i20AyPZ3cDb7AyNJgnp1cOhUHUhcFiL045v9jTUa8Gjlm29fsQQhb3DzJLUEhC+oiK7EISPOwapoEh+7JQJti5YfGXs0YNC62ouC1h9lsrlToClsjc/RM7uSe0kd3EmlzTO/Kqk8Q106mM/Yw2aOB9jnOg6sWTHxJ9FraSJMy6nGz7RbZUDYmN7e3BnQ5Gisez7u3J9c0JwA6Pb0aCFvNObgwKk6NoU59uJwaJ8y1viAT4vCtEFXYO8SFQGtCZpllyXQtNqL+4lmZ/BN/5qJKQFZozEHe9JtAGSaw4wsFnie4JmUQcjleh8yZq0Fnmq3y0D02IzPMgnonYqYIfA4pC+TcXrgIahLB+PEb5s5HrjaR0b7kbHGB0pK7TDO1/T39x1lUZGAPlUH0xTbz+KSoC4dDDx2DQCHzTCaWOB5zjbW+KCSpW0IS0BIJmy6zWCk7WDuxZ4r5oO6dHB7e/sBZo4H2OfUsYOv9jHW+ECJdkAtA/c6MpmMd+XaEKj7km9M4F5TEfBzSKovDLKG1cHobw+b6EDa3WOksYBPAhevBUJMxl8GJTRhFyMLBKSJFn5ls9nvmogS0DfaHOzb3h8AcUuNNBLQNiWa0gRv4MwMMyBwCqxAfCIH82JdYSJKQN+ocjA5NHD2I/e1aj/23iPyhbG6A+bAgXsZoUEII/UAkkQORu71JqIE7o22HBw4VaelpWU74mPPDc/39d1trO5Qb4vJ8QXxbwat06WofcTInMCzeToAtN4VXUn/l1AXDkan9tDSfmL6C81BZooHxDkN9CMveLFZFFAWWZtDwVta3G0sJcAbe3bmYEiniShBXabcL+wflQDD5mD0yKlvk0b/Tk33AG5F7idG+/ibRe54oEl1nLG6A+ZYe1jyAIuG/u2LB3MazxwAfL5vJFGJinxQUwcju6c/n3+FNPm5JhJyy2k/sQTp5nm+2HBJCGi1X1WpwzuBoQXAN+IcjDz8mdePKi/WhH1uxd7GcCjIVBcWpUYDfZ0VbclEJSr2akMBhVrdX6j+Jx3DpSh7vKB8CIiqKwcrcXGqdr05k3RKbU9ryTQVkUB3aHMrEshw7kGCXiv8xxG0h6Uzent6Fpn6MhA17A6GT/3yTxNO1coJbgWur3JFf1fXNuTes5AZe18xXobFHJKv04JZc3O7CtIcgGL9KW03u3QCfL4D4b292dhrpoYgsYOhEz4kaOuHqXKqiagYiN9QnUlyKgX84JUYsQFP9GKzMFRSe8XJb9upE9Dn62CK/KQT75wdTLz+NXgPNdrDuYzeUd0ByN4Wp07n+EdCRZuTY1/ymZQDwIjQye9pA32xdw6IiUgHc639mN8kzCLRjkxzQRzitUpkZ8LZBP1CILUd55EVvdgsCrzJl5i8mgCja+Zgjst4Pq3DUnMmtSWqyNIuQruRU3+CbO08n+pvBAZAjf1IU5kcGJc0YRMBfVV3MPd2RN4+YbvYukI/3sSpe+LUmbw0ryG/6ts1oSLeYrMw6C0xeaFAGc+Wq3hbfeRk582b55lrzf3UHJwWkD0Wp+6BQ3+BfXEXw6UCdHX4TVB0BoJi9Y1Cp59XbUWN8HW7lRjLli3zbINE+1hNiCRI1cGakIhT99ani/A6z1z1nDoUqNQfbO40kyqDfrCBwMg3E5rsCy+8sFlHR8dEnFzRTq/I8hQ9NFFOtGhXVOxgFeUqfknUK7Ctpjl1ANKJ/vmUkvrdwRZmWjpA4J9MTyja2toKY8TQa/ufxP/Whdd5c5cQJHIwfBsTvkKiaqd6/fRyOHKqavdL0H+V2sxmWvrQCAeKItfmQlNyDG/8SVwnetMHyxmA7lm0K2I7GFrlVBW/V6FPP9GqeU4V0Kt2+O2yhctUN6AJBEWD9ngMnessJxh5AfCoQe+8q+xQOYLuWbQrQh2MXP1XYh8S9DKC2sI1z6kCatW3/RCZ6Vj9fNPMqx2wQVNJQlcNEl/mGG5pv48bi7HxMVSOoHsW7QqPg5GlvnJtk6/B9+HMqYUfaXE6rampqWy4dVhgi8FfLprnBXEex+i/wCSkNiSNDSpUxxt7Ccj2nQQYAwUHc9yE3HEotuifDklnfFYMdGNC/lWCxotDf4PvB/jHZTs71c+f2n+ryqCPPcb5/pKdGrTvbH2MUjH4ByOLBDpON9YSFi5cuI1FOwFbbyTox5T6y+iwFL8CqvWvwVtolWgSv/N4sXbl5ZP3r8hRLT50d56KgYJDCYXVhYOhtqqReKDdZuGJtSQSOk8f67x581SspvH3lpoBe9Vefbg/lzveaXmnAf6tEDMNGRp3LnV3ch29o10lQIf+bOKZc+XnmMGARF2EK4vUwQiSw33n7ZlqDWwcaK9Ob29vd26vwj+OT8m3kKFxdd9tlILSJ1Wo8Y8RZT/YiKOY4le5P3SGZJAc7telg7FroL16Jc/n/a1cBBCxsSblwT8LOfofcCh4AQ4x1uoCXZtgVKnYDXLMUECnPSQD29VBcrhfVw7GHrVXb6WylGg0SvUZcrr+YPYuwWVfaE9ltmpA2Q6EQq2UY+yigzf2oqCH4v4MIysD94fdwdig9uqDnB4T5/d+gwHPGNVFcOopyJiPLOfmGTwa0Ek8qS8RKDKORLFWH95utwbDd94SRqqN/Cv4PDXbTFfXfUZWBvRUPJCRBJiIqfnnccy0Dz74wHkWoypY2D4ZGU8gK+kKjQKQ8RcTW1uQI2fmc7nH7LIMFEW+sw6xdyN4CgvNByNIDjp+ZyRVhzlV7dVLaZc7t1cRoW0w9of/No6ptbuRdZupqC3QPZY33HchMkbJiRPssgyaHkN82XaJXPtOJuN+JRuixQI6Cu1VXiZtJehcFGpeNPyXI6cqPWTIvsxU1R7o912akevre4OHfTHot3fEfRbD3y8+Qu0djO5Ce5UXNGl7dTt4z0RGqnOuhgLZgmcPk2FHrrd3jgwkAVQ58e1ioxjcHeMLPWQcq+5gZKm9+hJHjXo5z4xQBQsxxyDjEfir+nNq5GfQo/nYh6f9e4NUgGEFx3DEzvw1nPrOhSJ+kh6GUBUHw6//Kmls96dJ2qv6FxNF9z8g405kVLVXDfkaiFAd4JIkttYUGFpyDOf91Ch/YVEe8DA/gORpuywDfLNMjBOQt4qEupbTPTX4YeJig+/qrnoxkfMeIdH2UHGBfP0H6kFepElc1rY5lBQYXZbzuO7BWYH7b3V3d/+TX1FEG/JSExEJdOi7qsnrx3DuNM8Zdg2NqnN/BjK0EXlVhxORr56wP6Lv/DT+X1FzYLynaOWe2s1TjCQW4An9t6Jk4hBVdH6YpB9YNXoS+SRk/JaQZHd5J2CnesLuyGaze3KZ2hTemoNcpO+uB3pAQuzvC7SeJSfc0258Wo97aX9PT+TmMEMB73jsO0wJzXnVx4llL7pe5kWaFtSqGHHgu6rpPr5jsdx+hyI59G+hA4C25GDO1V69mbf/77h0+lZpzZX44B+Ye1X1cWKz92pKrYlcjtzc6gfN+ufhApd/ErcwTvuTRNI0m4c4Tg77u6gfbCHdTuQcrRFaRKiFU7Xl1O/RqX9RObevRxR43gmEBYUn9wEJIMeF/jk0yVKTta2tE0jg43kx1OatWifEYKDrHYKGDnfkMrU1xHUPaoh7k8i+030EvoV3c6i4aTCoc/9+9NVkFgh6BmZFaig08he3oxYkwBEkQGCzg7gfG6kzaDvuSyLfgIyqt1cF6SAspoS4iJf3c9xaf3JrGEgUzZcOGgvO4agzjTQUkI9V5z4851MuLhBvUUp1gR7tjXEHL+shXFZnduNIBomi6T73FVLLByQePu4N3CxMbVxyzfeQUTYZrdpA3yvoPVf/1jdTGggC6aXx0ieLSecFcWoj72vkhU4IcswU7gVORksb6FHnufbouJ4Xbv+gf1g0EADav9uSeO9YenpA3IfURFVZ0gqEms1rRg0qCzM4TuYy1T061jt0dXXpX0xJ96FMDXIqQXtJ3tSfze6OaY0KU1ogfTUgUJMK0lBIL06dS/F/LJeRe0k2kAAk7BgSWN2GVW/aCOjRuPCbBHVGBG6J3ECKIN3VlfjroguqA+RrMsFvCNqisf5mRox2qPlB4s8vuiMdIE/fVjVvLlRnhKlqYLig7QIpOiva40PAqR2E22neJFrN10AVgWMOIDgPuMOjmRFa+HVaR0fHliaugXoEOe80nBWrZg2dZkZoYffuaW5u1kCVkadmbT70AGdqJodWOhxHqP2eFg1UDvsLatnSFq41M+KKnp6eXbhsdB2OdGiCeX8+/2ecqgnmk/VXNYtqYLSAnNposzpjgw3+H/belpVa8J7TAAAAAElFTkSuQmCC',e.style.position='absolute',e.style.left='50%',e.style.top='50%',e.style.marginLeft='-60px',e.style.marginTop='-60px',e.style.animation='spin1 2s infinite ease-in-out',e.style.webkitAnimation='spin1 2s infinite ease-in-out',e.style.transformOrigin='50% 50%',e.style.webkitTransformOrigin='50% 50%',this._loadingDiv.appendChild(e),this._resizeLoadingUI(),window.addEventListener('resize',this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity='1'}},t.prototype.hideLoadingUI=function(){var r=this;if(this._loadingDiv){var e=function(){r._loadingDiv&&(document.body.removeChild(r._loadingDiv),window.removeEventListener('resize',r._resizeLoadingUI),r._loadingDiv=null)};this._loadingDiv.style.opacity='0',this._loadingDiv.addEventListener('transitionend',e)}},Object.defineProperty(t.prototype,'loadingUIText',{set:function(t){this._loadingText=t,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'loadingUIBackgroundColor',{get:function(){return this._loadingDivBackgroundColor},set:function(t){this._loadingDivBackgroundColor=t,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)},enumerable:!0,configurable:!0}),t}();r.DefaultLoadingScreen=e}(e||(e={}));var e;!function(y){var r=function(){function r(r,o,t){this.lengthComputable=r,this.loaded=o,this.total=t}return r.FromProgressEvent=function(e){return new r(e.lengthComputable,e.loaded,e.total)},r}();y.SceneLoaderProgressEvent=r;var e=function(){function S(){}return Object.defineProperty(S,'NO_LOGGING',{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(S,'MINIMAL_LOGGING',{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(S,'SUMMARY_LOGGING',{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(S,'DETAILED_LOGGING',{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(S,'ForceFullSceneLoadingForIncremental',{get:function(){return S._ForceFullSceneLoadingForIncremental},set:function(t){S._ForceFullSceneLoadingForIncremental=t},enumerable:!0,configurable:!0}),Object.defineProperty(S,'ShowLoadingScreen',{get:function(){return S._ShowLoadingScreen},set:function(t){S._ShowLoadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(S,'loggingLevel',{get:function(){return S._loggingLevel},set:function(t){S._loggingLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(S,'CleanBoneMatrixWeights',{get:function(){return S._CleanBoneMatrixWeights},set:function(t){S._CleanBoneMatrixWeights=t},enumerable:!0,configurable:!0}),S._getDefaultPlugin=function(){return S._registeredPlugins['.babylon']},S._getPluginForExtension=function(e){var t=S._registeredPlugins[e];return t||(y.Tools.Warn('Unable to find a plugin to load '+e+' files. Trying to use .babylon default plugin.'),S._getDefaultPlugin())},S._getPluginForDirectLoad=function(o){for(var e in S._registeredPlugins){var t=S._registeredPlugins[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(o))return S._registeredPlugins[e]}return S._getDefaultPlugin()},S._getPluginForFilename=function(o){o.name&&(o=o.name);var e=o.indexOf('?');-1!==e&&(o=o.substring(0,e));var t=o.lastIndexOf('.'),r=o.substring(t,o.length).toLowerCase();return S._getPluginForExtension(r)},S._getDirectLoad=function(t){return t.substr&&'data:'===t.substr(0,5)?t.substr(5):null},S._loadData=function(e,t,i,o,n,a,s,l){var c=S._getDirectLoad(t),f=l?S._getPluginForExtension(l):c?S._getPluginForDirectLoad(t):S._getPluginForFilename(t),d;d=f.plugin.createPlugin?f.plugin.createPlugin():f.plugin;var u=f.isBinary,_;S.OnPluginActivatedObservable.notifyObservers(d);var p=function(r,e){return i.isDisposed?void a('Scene has been disposed'):void(i.database=_,o(d,r,e))},m=null,g=!1,h=d.onDisposeObservable;h&&h.add(function(){g=!0,m&&(m.abort(),m=null),s()});var C=function(){if(!g){m=y.Tools.LoadFile(e+t,p,n?function(t){n(r.FromProgressEvent(t))}:void 0,_,u,function(r,e){a('Failed to load scene.'+(e?'':' '+e.message),e)})}};if(c)return p(c),d;if(-1===e.indexOf('file:')){var b=i.getEngine(),x=b.enableOfflineSupport;if(x){for(var T=!1,R=0,P=i.disableOfflineSupportExceptionRules;R<P.length;R++)if(P[R].test(e+t)){T=!0;break}x=!T}x?_=new y.Database(e+t,C,b.disableManifestCheck):C()}else{var A=t;A.name?m=y.Tools.ReadFile(A,p,n,u):y.FilesInput.FilesToLoad[t]?m=y.Tools.ReadFile(y.FilesInput.FilesToLoad[t],p,n,u):a('Unable to find file named '+t)}return d},S.GetPluginForExtension=function(t){return S._getPluginForExtension(t).plugin},S.IsPluginForExtensionAvailable=function(t){return!!S._registeredPlugins[t]},S.RegisterPlugin=function(o){if('string'==typeof o.extensions){var i=o.extensions;S._registeredPlugins[i.toLowerCase()]={plugin:o,isBinary:!1}}else{var a=o.extensions;Object.keys(a).forEach(function(r){S._registeredPlugins[r.toLowerCase()]={plugin:o,isBinary:a[r].isBinary}})}},S.ImportMesh=function(e,_,r,n,o,t,a,i){if(void 0===o&&(o=null),void 0===t&&(t=null),void 0===a&&(a=null),void 0===i&&(i=null),r.substr&&'/'===r.substr(0,1))return y.Tools.Error('Wrong sceneFilename parameter'),null;var s={};n._addPendingData(s);var l=function(){n._removePendingData(s)},m=function(e,t){var o='Unable to import meshes from '+_+r+': '+e;a?a(n,o,t):y.Tools.Error(o),l()},f=t?function(r){try{t(r)}catch(t){m('Error in onProgress callback',t)}}:void 0,d=function(l,e,t,i){if(n.importedMeshesFiles.push(_+r),o)try{o(l,e,t,i)}catch(t){m('Error in onSuccess callback',t)}n._removePendingData(s)};return S._loadData(_,r,n,function(t,o,i){if(t.rewriteRootURL&&(_=t.rewriteRootURL(_,i)),''===r&&''===r&&(_=y.Tools.GetFolderPath(_,!0)),t.importMesh){var a=[],s=[],l=[];if(!t.importMesh(e,n,o,_,a,s,l,m))return;n.loadingPluginName=t.name,d(a,s,l,[])}else t.importMeshAsync(e,n,o,_,f).then(function(r){n.loadingPluginName=t.name,d(r.meshes,r.particleSystems,r.skeletons,r.animationGroups)}).catch(function(t){m(t.message,t)})},f,m,l,i)},S.ImportMeshAsync=function(i,e,t,r,n,o){return void 0===n&&(n=null),void 0===o&&(o=null),new Promise(function(s,a){S.ImportMesh(i,e,t,r,function(o,a,n,l){s({meshes:o,particleSystems:a,skeletons:n,animationGroups:l})},n,function(r,e,t){a(t||new Error(e))},o)})},S.Load=function(e,t,r,i,o,n,a){return void 0===i&&(i=null),void 0===o&&(o=null),void 0===n&&(n=null),void 0===a&&(a=null),S.Append(e,t,new y.Scene(r),i,o,n,a)},S.LoadAsync=function(i,e,t,r,n){return void 0===r&&(r=null),void 0===n&&(n=null),new Promise(function(o,s){S.Load(i,e,t,function(t){o(t)},r,function(r,e,t){s(t||new Error(e))},n)})},S.Append=function(e,t,r,i,o,n,a){if(void 0===i&&(i=null),void 0===o&&(o=null),void 0===n&&(n=null),void 0===a&&(a=null),t.substr&&'/'===t.substr(0,1))return y.Tools.Error('Wrong sceneFilename parameter'),null;S.ShowLoadingScreen&&r.getEngine().displayLoadingUI();var s={};r._addPendingData(s);var l=function(){r._removePendingData(s),r.getEngine().hideLoadingUI()},c=function(a,i){var o='Unable to load from '+e+t+(a?': '+a:'');n?n(r,o,i):y.Tools.Error(o),l()},p=o?function(t){try{o(t)}catch(t){c('Error in onProgress callback',t)}}:void 0,u=function(){if(i)try{i(r)}catch(t){c('Error in onSuccess callback',t)}r._removePendingData(s)};return S._loadData(e,t,r,function(i,o){if(''===t&&(e=y.Tools.GetFolderPath(e,!0)),i.load){if(!i.load(r,o,e,c))return;r.loadingPluginName=i.name,u()}else i.loadAsync(r,o,e,p).then(function(){r.loadingPluginName=i.name,u()}).catch(function(t){c(t.message,t)});S.ShowLoadingScreen&&r.executeWhenReady(function(){r.getEngine().hideLoadingUI()})},p,c,l,a)},S.AppendAsync=function(i,e,t,r,n){return void 0===r&&(r=null),void 0===n&&(n=null),new Promise(function(o,s){S.Append(i,e,t,function(t){o(t)},r,function(r,e,t){s(t||new Error(e))},n)})},S.LoadAssetContainer=function(p,e,_,t,r,n,o){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=null),void 0===o&&(o=null),e.substr&&'/'===e.substr(0,1))return y.Tools.Error('Wrong sceneFilename parameter'),null;var i={};_._addPendingData(i);var a=function(){_._removePendingData(i)},s=function(t,r){var o='Unable to load assets from '+p+e+(t?': '+t:'');n?n(_,o,r):y.Tools.Error(o),a()},l=r?function(t){try{r(t)}catch(t){s('Error in onProgress callback',t)}}:void 0,c=function(r){if(t)try{t(r)}catch(t){s('Error in onSuccess callback',t)}_._removePendingData(i)};return S._loadData(p,e,_,function(o,e){if(o.loadAssetContainer){var t=o.loadAssetContainer(_,e,p,s);if(!t)return;_.loadingPluginName=o.name,c(t)}else if(o.loadAssetContainerAsync){o.loadAssetContainerAsync(_,e,p,l).then(function(e){_.loadingPluginName=o.name,c(e)}).catch(function(t){s(t.message,t)})}else s('LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.');S.ShowLoadingScreen&&_.executeWhenReady(function(){_.getEngine().hideLoadingUI()})},l,s,a,o)},S.LoadAssetContainerAsync=function(i,e,t,r,n){return void 0===r&&(r=null),void 0===n&&(n=null),new Promise(function(o,s){S.LoadAssetContainer(i,e,t,function(t){o(t)},r,function(r,e,t){s(t||new Error(e))},n)})},S._ForceFullSceneLoadingForIncremental=!1,S._ShowLoadingScreen=!0,S._CleanBoneMatrixWeights=!1,S._loggingLevel=S.NO_LOGGING,S.OnPluginActivatedObservable=new y.Observable,S._registeredPlugins={},S}();y.SceneLoader=e}(e||(e={}));var e;!function(_e){var e=function(e,t,i,r){for(var n=0,o=t.materials.length,s;n<o;n++)if(s=t.materials[n],s.id===e)return _e.Material.Parse(s,i,r);return null},t=function(o,e,t){for(var i in e)if(o.name===e[i])return t.push(o.id),!0;return o.parentId&&-1!==t.indexOf(o.parentId)&&(t.push(o.id),!0)},i=function(r,e){return r+' of '+(e?e.file+' from '+e.name+' version: '+e.version+', exporter version: '+e.exporter_version:'unknown')},m=function(e,t,r,n,me){void 0===me&&(me=!1);var s=new _e.AssetContainer(e),a='importScene has failed JSON parse';try{var l=JSON.parse(t);a='';var h=_e.SceneLoader.loggingLevel===_e.SceneLoader.DETAILED_LOGGING,f,c;if(void 0!==l.lights&&null!==l.lights)for(f=0,c=l.lights.length;f<c;f++){var u=l.lights[f],d=_e.Light.Parse(u,e);d&&(s.lights.push(d),a+=0===f?'\n\tLights:':'',a+='\n\t\t'+d.toString(h))}if(void 0!==l.animations&&null!==l.animations)for(f=0,c=l.animations.length;f<c;f++){var p=l.animations[f],_=_e.Animation.Parse(p);e.animations.push(_),s.animations.push(_),a+=0===f?'\n\tAnimations:':'',a+='\n\t\t'+_.toString(h)}if(void 0!==l.materials&&null!==l.materials)for(f=0,c=l.materials.length;f<c;f++){var m=l.materials[f],g=_e.Material.Parse(m,e,r);s.materials.push(g),a+=0===f?'\n\tMaterials:':'',a+='\n\t\t'+g.toString(h)}if(void 0!==l.multiMaterials&&null!==l.multiMaterials)for(f=0,c=l.multiMaterials.length;f<c;f++){var v=l.multiMaterials[f],y=_e.Material.ParseMultiMaterial(v,e);s.multiMaterials.push(y),a+=0===f?'\n\tMultiMaterials:':'',a+='\n\t\t'+y.toString(h)}if(void 0!==l.morphTargetManagers&&null!==l.morphTargetManagers)for(var b=0,x=l.morphTargetManagers,T;b<x.length;b++)T=x[b],s.morphTargetManagers.push(_e.MorphTargetManager.Parse(T,e));if(void 0!==l.skeletons&&null!==l.skeletons)for(f=0,c=l.skeletons.length;f<c;f++){var E=l.skeletons[f],P=_e.Skeleton.Parse(E,e);s.skeletons.push(P),a+=0===f?'\n\tSkeletons:':'',a+='\n\t\t'+P.toString(h)}var A=l.geometries;if(void 0!==A&&null!==A){var M=[],S=A.boxes;if(void 0!==S&&null!==S)for(f=0,c=S.length;f<c;f++){var C=S[f];M.push(_e.BoxGeometry.Parse(C,e))}var R=A.spheres;if(void 0!==R&&null!==R)for(f=0,c=R.length;f<c;f++){var O=R[f];M.push(_e.SphereGeometry.Parse(O,e))}var I=A.cylinders;if(void 0!==I&&null!==I)for(f=0,c=I.length;f<c;f++){var D=I[f];M.push(_e.CylinderGeometry.Parse(D,e))}var w=A.toruses;if(void 0!==w&&null!==w)for(f=0,c=w.length;f<c;f++){var L=w[f];M.push(_e.TorusGeometry.Parse(L,e))}var F=A.grounds;if(void 0!==F&&null!==F)for(f=0,c=F.length;f<c;f++){var B=F[f];M.push(_e.GroundGeometry.Parse(B,e))}var V=A.planes;if(void 0!==V&&null!==V)for(f=0,c=V.length;f<c;f++){var N=V[f];M.push(_e.PlaneGeometry.Parse(N,e))}var U=A.torusKnots;if(void 0!==U&&null!==U)for(f=0,c=U.length;f<c;f++){var k=U[f];M.push(_e.TorusKnotGeometry.Parse(k,e))}var z=A.vertexData;if(void 0!==z&&null!==z)for(f=0,c=z.length;f<c;f++){var G=z[f];M.push(_e.Geometry.Parse(G,e,r))}M.forEach(function(t){t&&s.geometries.push(t)})}if(void 0!==l.transformNodes&&null!==l.transformNodes)for(f=0,c=l.transformNodes.length;f<c;f++){var W=l.transformNodes[f],H=_e.TransformNode.Parse(W,e,r);s.transformNodes.push(H)}if(void 0!==l.meshes&&null!==l.meshes)for(f=0,c=l.meshes.length;f<c;f++){var j=l.meshes[f],X=_e.Mesh.Parse(j,e,r);s.meshes.push(X),a+=0===f?'\n\tMeshes:':'',a+='\n\t\t'+X.toString(h)}if(void 0!==l.cameras&&null!==l.cameras)for(f=0,c=l.cameras.length;f<c;f++){var Y=l.cameras[f],K=_e.Camera.Parse(Y,e);s.cameras.push(K),a+=0===f?'\n\tCameras:':'',a+='\n\t\t'+K.toString(h)}for(f=0,c=e.cameras.length;f<c;f++){var K=e.cameras[f];K._waitingParentId&&(K.parent=e.getLastEntryByID(K._waitingParentId),K._waitingParentId=null)}for(f=0,c=e.lights.length;f<c;f++){var Q=e.lights[f];Q&&Q._waitingParentId&&(Q.parent=e.getLastEntryByID(Q._waitingParentId),Q._waitingParentId=null)}var Z=[],J;if(_e.AudioEngine&&void 0!==l.sounds&&null!==l.sounds)for(f=0,c=l.sounds.length;f<c;f++){var q=l.sounds[f];_e.Engine.audioEngine.canUseWebAudio?(q.url||(q.url=q.name),Z[q.url]?s.sounds.push(_e.Sound.Parse(q,e,r,Z[q.url])):(J=_e.Sound.Parse(q,e,r),Z[q.url]=J,s.sounds.push(J))):s.sounds.push(new _e.Sound(q.name,null,e))}for(Z=[],f=0,c=e.transformNodes.length;f<c;f++){var $=e.transformNodes[f];$._waitingParentId&&($.parent=e.getLastEntryByID($._waitingParentId),$._waitingParentId=null)}for(f=0,c=e.meshes.length;f<c;f++){var X=e.meshes[f];X._waitingParentId&&(X.parent=e.getLastEntryByID(X._waitingParentId),X._waitingParentId=null),X._waitingActions&&(_e.ActionManager.Parse(X._waitingActions,X,e),X._waitingActions=null)}for(f=0,c=e.meshes.length;f<c;f++){var ee=e.meshes[f];ee._waitingFreezeWorldMatrix?(ee.freezeWorldMatrix(),ee._waitingFreezeWorldMatrix=null):ee.computeWorldMatrix(!0)}if(void 0!==l.particleSystems&&null!==l.particleSystems)for(f=0,c=l.particleSystems.length;f<c;f++){var te=l.particleSystems[f];if(te.activeParticleCount){var ie=_e.GPUParticleSystem.Parse(te,e,r);s.particleSystems.push(ie)}else{var ie=_e.ParticleSystem.Parse(te,e,r);s.particleSystems.push(ie)}}if(void 0!==l.lensFlareSystems&&null!==l.lensFlareSystems)for(f=0,c=l.lensFlareSystems.length;f<c;f++){var re=l.lensFlareSystems[f],ne=_e.LensFlareSystem.Parse(re,e,r);s.lensFlareSystems.push(ne)}if(void 0!==l.shadowGenerators&&null!==l.shadowGenerators)for(f=0,c=l.shadowGenerators.length;f<c;f++){var oe=l.shadowGenerators[f],se=_e.ShadowGenerator.Parse(oe,e);s.shadowGenerators.push(se)}for(f=0,c=e.lights.length;f<c;f++){var ae=e.lights[f];if(0<ae._excludedMeshesIds.length){for(var le=0,ge;le<ae._excludedMeshesIds.length;le++)ge=e.getMeshByID(ae._excludedMeshesIds[le]),ge&&ae.excludedMeshes.push(ge);ae._excludedMeshesIds=[]}if(0<ae._includedOnlyMeshesIds.length){for(var ce=0,ue;ce<ae._includedOnlyMeshesIds.length;ce++)ue=e.getMeshByID(ae._includedOnlyMeshesIds[ce]),ue&&ae.includedOnlyMeshes.push(ue);ae._includedOnlyMeshesIds=[]}}if(l.effectLayers)for(f=0;f<l.effectLayers.length;f++){var fe=_e.EffectLayer.Parse(l.effectLayers[f],e,r);s.effectLayers.push(fe)}void 0!==l.actions&&null!==l.actions&&_e.ActionManager.Parse(l.actions,null,e),me||s.removeAllFromScene()}catch(e){var de=i('loadAssts',l?l.producer:'Unknown')+a;if(!n)throw _e.Tools.Log(de),e;n(de,e)}finally{null!==a&&_e.SceneLoader.loggingLevel!==_e.SceneLoader.NO_LOGGING&&_e.Tools.Log(i('loadAssts',l?l.producer:'Unknown')+(_e.SceneLoader.loggingLevel===_e.SceneLoader.MINIMAL_LOGGING?'':a))}return s};_e.SceneLoader.RegisterPlugin({name:'babylon.js',extensions:'.babylon',canDirectLoad:function(t){return-1!==t.indexOf('babylon')},importMesh:function(r,n,o,s,a,l,h,c){var G='importMesh has failed JSON parse';try{var f=JSON.parse(o);G='';var d=_e.SceneLoader.loggingLevel===_e.SceneLoader.DETAILED_LOGGING;r?Array.isArray(r)||(r=[r]):r=null;var p=[];if(void 0!==f.meshes&&null!==f.meshes){var _=[],v=[],y,m;for(y=0,m=f.meshes.length;y<m;y++){var g=f.meshes[y];if(null===r||t(g,r,p)){if(null!==r&&delete r[r.indexOf(g.name)],void 0!==g.geometryId&&null!==g.geometryId&&void 0!==f.geometries&&null!==f.geometries){var b=!1;['boxes','spheres','cylinders','toruses','grounds','planes','torusKnots','vertexData'].forEach(function(e){!0!=b&&f.geometries[e]&&Array.isArray(f.geometries[e])&&f.geometries[e].forEach(function(t){t.id===g.geometryId&&('boxes'===e?_e.BoxGeometry.Parse(t,n):'spheres'===e?_e.SphereGeometry.Parse(t,n):'cylinders'===e?_e.CylinderGeometry.Parse(t,n):'toruses'===e?_e.TorusGeometry.Parse(t,n):'grounds'===e?_e.GroundGeometry.Parse(t,n):'planes'===e?_e.PlaneGeometry.Parse(t,n):'torusKnots'===e?_e.TorusKnotGeometry.Parse(t,n):'vertexData'===e?_e.Geometry.Parse(t,n,s):void 0,b=!0)})}),!1==b&&_e.Tools.Warn('Geometry not found for mesh '+g.id)}if(g.materialId){var x=-1!==v.indexOf(g.materialId);if(!1==x&&void 0!==f.multiMaterials&&null!==f.multiMaterials)for(var T=0,E=f.multiMaterials.length,P;T<E;T++)if(P=f.multiMaterials[T],P.id===g.materialId){for(var A=0,M=P.materials.length,S;A<M;A++){S=P.materials[A],v.push(S);var C=e(S,f,n,s);C&&(G+='\n\tMaterial '+C.toString(d))}v.push(P.id);var R=_e.Material.ParseMultiMaterial(P,n);R&&(x=!0,G+='\n\tMulti-Material '+R.toString(d));break}if(!1==x){v.push(g.materialId);var C=e(g.materialId,f,n,s);C?G+='\n\tMaterial '+C.toString(d):_e.Tools.Warn('Material not found for mesh '+g.id)}}if(-1<g.skeletonId&&void 0!==f.skeletons&&null!==f.skeletons&&!1==-1<_.indexOf(g.skeletonId))for(var O=0,I=f.skeletons.length,D;O<I;O++)if(D=f.skeletons[O],D.id===g.skeletonId){var w=_e.Skeleton.Parse(D,n);h.push(w),_.push(D.id),G+='\n\tSkeleton '+w.toString(d)}if(void 0!==f.morphTargetManagers&&null!==f.morphTargetManagers)for(var L=0,F=f.morphTargetManagers,B;L<F.length;L++)B=F[L],_e.MorphTargetManager.Parse(B,n);var V=_e.Mesh.Parse(g,n,s);a.push(V),G+='\n\tMesh '+V.toString(d)}}var N;for(y=0,m=n.meshes.length;y<m;y++)N=n.meshes[y],N._waitingParentId&&(N.parent=n.getLastEntryByID(N._waitingParentId),N._waitingParentId=null);for(y=0,m=n.meshes.length;y<m;y++)N=n.meshes[y],N._waitingFreezeWorldMatrix?(N.freezeWorldMatrix(),N._waitingFreezeWorldMatrix=null):N.computeWorldMatrix(!0)}if(void 0!==f.particleSystems&&null!==f.particleSystems)for(y=0,m=f.particleSystems.length;y<m;y++){var U=f.particleSystems[y];-1!==p.indexOf(U.emitterId)&&l.push(_e.ParticleSystem.Parse(U,n,s))}return!0}catch(e){var k=i('importMesh',f?f.producer:'Unknown')+G;if(!c)throw _e.Tools.Log(k),e;c(k,e)}finally{null!==G&&_e.SceneLoader.loggingLevel!==_e.SceneLoader.NO_LOGGING&&_e.Tools.Log(i('importMesh',f?f.producer:'Unknown')+(_e.SceneLoader.loggingLevel===_e.SceneLoader.MINIMAL_LOGGING?'':G))}return!1},load:function(e,t,r,o){var n='importScene has failed JSON parse';try{var a=JSON.parse(t);if(n='',void 0!==a.useDelayedTextureLoading&&null!==a.useDelayedTextureLoading&&(e.useDelayedTextureLoading=a.useDelayedTextureLoading&&!_e.SceneLoader.ForceFullSceneLoadingForIncremental),void 0!==a.autoClear&&null!==a.autoClear&&(e.autoClear=a.autoClear),void 0!==a.clearColor&&null!==a.clearColor&&(e.clearColor=_e.Color4.FromArray(a.clearColor)),void 0!==a.ambientColor&&null!==a.ambientColor&&(e.ambientColor=_e.Color3.FromArray(a.ambientColor)),void 0!==a.gravity&&null!==a.gravity&&(e.gravity=_e.Vector3.FromArray(a.gravity)),a.fogMode&&0!==a.fogMode)switch(e.fogMode=a.fogMode,e.fogColor=_e.Color3.FromArray(a.fogColor),e.fogStart=a.fogStart,e.fogEnd=a.fogEnd,e.fogDensity=a.fogDensity,n+='\tFog mode for scene:  ',e.fogMode){case 1:n+='exp\n';break;case 2:n+='exp2\n';break;case 3:n+='linear\n';}if(a.physicsEnabled){var l;'cannon'===a.physicsEngine?l=new _e.CannonJSPlugin:'oimo'===a.physicsEngine&&(l=new _e.OimoJSPlugin),n='\tPhysics engine '+(a.physicsEngine?a.physicsEngine:'oimo')+' enabled\n';var g=a.physicsGravity?_e.Vector3.FromArray(a.physicsGravity):null;e.enablePhysics(g,l)}if(void 0!==a.metadata&&null!==a.metadata&&(e.metadata=a.metadata),void 0!==a.collisionsEnabled&&null!==a.collisionsEnabled&&(e.collisionsEnabled=a.collisionsEnabled),e.workerCollisions=!!a.workerCollisions,!m(e,t,r,o,!0))return!1;if(a.autoAnimate&&e.beginAnimation(e,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1),void 0!==a.activeCameraID&&null!==a.activeCameraID&&e.setActiveCameraByID(a.activeCameraID),void 0!==a.environmentTexture&&null!==a.environmentTexture){if(a.environmentTextureType&&'BABYLON.HDRCubeTexture'===a.environmentTextureType){var c=a.environmentTextureSize?a.environmentTextureSize:128,u=new _e.HDRCubeTexture(r+a.environmentTexture,e,c);a.environmentTextureRotationY&&(u.rotationY=a.environmentTextureRotationY),e.environmentTexture=u}else{var f=_e.CubeTexture.CreateFromPrefilteredData(r+a.environmentTexture,e);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),e.environmentTexture=f}if(!0===a.createDefaultSkybox){var d=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,p=a.skyboxBlurLevel||0;e.createDefaultSkybox(void 0,!0,d,p)}}return!0}catch(e){var _=i('importScene',a?a.producer:'Unknown')+n;if(!o)throw _e.Tools.Log(_),e;o(_,e)}finally{null!==n&&_e.SceneLoader.loggingLevel!==_e.SceneLoader.NO_LOGGING&&_e.Tools.Log(i('importScene',a?a.producer:'Unknown')+(_e.SceneLoader.loggingLevel===_e.SceneLoader.MINIMAL_LOGGING?'':n))}return!1},loadAssetContainer:function(o,e,t,i){return m(o,e,t,i)}})}(e||(e={}));var e;!function(r){var e=function(){function o(d,e,c,i,r,n,o,s,a){this.onProcessFileCallback=function(){return!0},this._engine=d,this._currentScene=e,this._sceneLoadedCallback=c,this._progressCallback=i,this._additionalRenderLoopLogicCallback=r,this._textureLoadingCallback=n,this._startingProcessingFilesCallback=o,this._onReloadCallback=s,this._errorCallback=a}return o.prototype.monitorElementForDragNDrop=function(r){var o=this;r&&(this._elementToMonitor=r,this._dragEnterHandler=function(t){o.drag(t)},this._dragOverHandler=function(t){o.drag(t)},this._dropHandler=function(t){o.drop(t)},this._elementToMonitor.addEventListener('dragenter',this._dragEnterHandler,!1),this._elementToMonitor.addEventListener('dragover',this._dragOverHandler,!1),this._elementToMonitor.addEventListener('drop',this._dropHandler,!1))},o.prototype.dispose=function(){this._elementToMonitor&&(this._elementToMonitor.removeEventListener('dragenter',this._dragEnterHandler),this._elementToMonitor.removeEventListener('dragover',this._dragOverHandler),this._elementToMonitor.removeEventListener('drop',this._dropHandler))},o.prototype.renderFunction=function(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var t=this._currentScene.getWaitingItemsCount();0<t&&this._textureLoadingCallback(t)}this._currentScene.render()}},o.prototype.drag=function(t){t.stopPropagation(),t.preventDefault()},o.prototype.drop=function(t){t.stopPropagation(),t.preventDefault(),this.loadFiles(t)},o.prototype._traverseFolder=function(a,d,t,i){var r=this,e=a.createReader(),o=a.fullPath.replace(/^\//,'').replace(/(.+?)\/?$/,'$1/');e.readEntries(function(n){t.count+=n.length;for(var e=0,s=n,a;e<s.length;e++)a=s[e],a.isFile?a.file(function(r){r.correctName=o+r.name,d.push(r),0==--t.count&&i()}):a.isDirectory&&r._traverseFolder(a,d,t,i);--t.count&&i()})},o.prototype._processFiles=function(t){for(var e=0;e<t.length;e++){var i=t[e].correctName.toLowerCase(),r=i.split('.').pop();this.onProcessFileCallback(t[e],i,r)&&('babylon'!==r&&'stl'!==r&&'obj'!==r&&'gltf'!==r&&'glb'!==r||-1!==i.indexOf('.binary.babylon')||-1!==i.indexOf('.incremental.babylon')?o.FilesToLoad[i]=t[e]:this._sceneFileToLoad=t[e])}},o.prototype.loadFiles=function(p){var e=this;if(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(),p&&p.dataTransfer&&p.dataTransfer.files&&(this._filesToLoad=p.dataTransfer.files),p&&p.target&&p.target.files&&(this._filesToLoad=p.target.files),this._filesToLoad&&0<this._filesToLoad.length){for(var t=[],i=[],r=p.dataTransfer?p.dataTransfer.items:null,n=0;n<this._filesToLoad.length;n++){var o=this._filesToLoad[n],s=o.name.toLowerCase(),a=void 0;if(o.correctName=s,r){var l=r[n];l.getAsEntry?a=l.getAsEntry():l.webkitGetAsEntry&&(a=l.webkitGetAsEntry())}a&&a.isDirectory?i.push(a):t.push(o)}if(0===i.length)this._processFiles(t),this._processReload();else for(var _={count:i.length},c=0,u=i,f;c<u.length;c++)f=u[c],this._traverseFolder(f,t,_,function(){e._processFiles(t),0===_.count&&e._processReload()})}},o.prototype._processReload=function(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()},o.prototype.reload=function(){var o=this;this._sceneFileToLoad?(this._currentScene&&(0<r.Tools.errorsCount&&r.Tools.ClearLogCache(),this._engine.stopRenderLoop(),this._currentScene.dispose()),r.SceneLoader.LoadAsync('file:',this._sceneFileToLoad,this._engine,function(t){o._progressCallback&&o._progressCallback(t)}).then(function(t){o._currentScene=t,o._sceneLoadedCallback&&o._sceneLoadedCallback(o._sceneFileToLoad,o._currentScene),o._currentScene.executeWhenReady(function(){o._engine.runRenderLoop(function(){o.renderFunction()})})}).catch(function(t){o._errorCallback&&o._errorCallback(o._sceneFileToLoad,o._currentScene,t.message)})):r.Tools.Error('Please provide a valid .babylon file.')},o.FilesToLoad={},o}();r.FilesInput=e}(e||(e={}));var e;!function(r){var e=function(){function t(){this._count=0,this._data={}}return t.prototype.copyFrom=function(r){var o=this;this.clear(),r.forEach(function(t,e){return o.add(t,e)})},t.prototype.get=function(r){var e=this._data[r];if(void 0!==e)return e},t.prototype.getOrAddWithFactory=function(r,e){var t=this.get(r);return void 0===t?(t=e(r),t&&this.add(r,t),t):t},t.prototype.getOrAdd=function(r,e){var t=this.get(r);return void 0===t?(this.add(r,e),e):t},t.prototype.contains=function(t){return void 0!==this._data[t]},t.prototype.add=function(r,e){return void 0===this._data[r]&&(this._data[r]=e,++this._count,!0)},t.prototype.set=function(r,e){return void 0!==this._data[r]&&(this._data[r]=e,!0)},t.prototype.getAndRemove=function(r){var e=this.get(r);return void 0===e?null:(delete this._data[r],--this._count,e)},t.prototype.remove=function(t){return!!this.contains(t)&&(delete this._data[t],--this._count,!0)},t.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(t.prototype,'count',{get:function(){return this._count},enumerable:!0,configurable:!0}),t.prototype.forEach=function(r){for(var e in this._data)r(e,this._data[e])},t.prototype.first=function(o){for(var e in this._data){var t=this._data[e],i=o(e,t);if(i)return i}return null},t}();r.StringDictionary=e}(e||(e={}));var e;!function(o){var e=function(){function a(){}return a.EnableFor=function(t){t._tags=t._tags||{},t.hasTags=function(){return a.HasTags(t)},t.addTags=function(e){return a.AddTagsTo(t,e)},t.removeTags=function(e){return a.RemoveTagsFrom(t,e)},t.matchesTagsQuery=function(e){return a.MatchesQuery(t,e)}},a.DisableFor=function(t){delete t._tags,delete t.hasTags,delete t.addTags,delete t.removeTags,delete t.matchesTagsQuery},a.HasTags=function(e){return!!e._tags&&!o.Tools.IsEmpty(e._tags)},a.GetTags=function(o,e){if(void 0===e&&(e=!0),!o._tags)return null;if(e){var t=[];for(var i in o._tags)o._tags.hasOwnProperty(i)&&!0===o._tags[i]&&t.push(i);return t.join(' ')}return o._tags},a.AddTagsTo=function(t,e){e&&'string'==typeof e&&e.split(' ').forEach(function(e){a._AddTagTo(t,e)})},a._AddTagTo=function(t,e){''!==(e=e.trim())&&'true'!==e&&'false'!==e&&(e.match(/[\s]/)||e.match(/^([!]|([|]|[&]){2})/)||(a.EnableFor(t),t._tags[e]=!0))},a.RemoveTagsFrom=function(t,e){if(a.HasTags(t)){var o=e.split(' ');for(var r in o)a._RemoveTagFrom(t,o[r])}},a._RemoveTagFrom=function(r,e){delete r._tags[e]},a.MatchesQuery=function(t,e){return void 0===e||(''===e?a.HasTags(t):o.AndOrNotEvaluator.Eval(e,function(r){return a.HasTags(t)&&t._tags[r]}))},a}();o.Tags=e}(e||(e={}));var e;!function(r){var e=function(){function d(){}return d.Eval=function(e,r){return'true'===(e=e.match(/\([^\(\)]*\)/g)?e.replace(/\([^\(\)]*\)/g,function(e){return e=e.slice(1,e.length-1),d._HandleParenthesisContent(e,r)}):d._HandleParenthesisContent(e,r))||'false'!==e&&d.Eval(e,r)},d._HandleParenthesisContent=function(e,t){t=t||function(t){return'true'===t};var i=e.split('||'),n;for(var r in i)if(i.hasOwnProperty(r)){var o=d._SimplifyNegation(i[r].trim()),s=o.split('&&');if(1<s.length)for(var a=0,l;a<s.length;++a)if(l=d._SimplifyNegation(s[a].trim()),!(n='true'!==l&&'false'!==l?'!'===l[0]?!t(l.substring(1)):t(l):'true'===l)){o='false';break}if(n||'true'===o){n=!0;break}n='true'!==o&&'false'!==o?'!'===o[0]?!t(o.substring(1)):t(o):'true'===o}return n?'true':'false'},d._SimplifyNegation=function(t){return t=t.replace(/^[\s!]+/,function(t){return t=t.replace(/[\s]/g,function(){return''}),t.length%2?'!':''}),t=t.trim(),'!true'===t?t='false':'!false'===t&&(t='true'),t},d}();r.AndOrNotEvaluator=e}(e||(e={}));var e;!function(d){var e=function(){function c(e,t,r){void 0===r&&(r=!1);var i=this;this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,this.callbackManifestChecked=t,this.currentSceneUrl=c._ReturnFullUrlLocation(e),this.db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this.manifestVersionFound=0,this.mustUpdateRessources=!1,this.hasReachedQuota=!1,c.IDBStorageEnabled?r?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this.manifestVersionFound=1,d.Tools.SetImmediate(function(){i.callbackManifestChecked(!0)})):this._checkManifestFile():this.callbackManifestChecked(!0)}return Object.defineProperty(c.prototype,'enableSceneOffline',{get:function(){return this._enableSceneOffline},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,'enableTexturesOffline',{get:function(){return this._enableTexturesOffline},enumerable:!0,configurable:!0}),c.prototype._checkManifestFile=function(){var e=this,t=function(){e._enableSceneOffline=!1,e._enableTexturesOffline=!1,e.callbackManifestChecked(!1)},i=!1,r=this.currentSceneUrl+'.manifest',a=new XMLHttpRequest;navigator.onLine&&(i=!0,r=r+(null==r.match(/\?/)?'?':'&')+Date.now()),a.open('GET',r,!0),a.addEventListener('load',function(){if(200===a.status||d.Tools.ValidateXHRData(a,1))try{var o=JSON.parse(a.response);e._enableSceneOffline=o.enableSceneOffline,e._enableTexturesOffline=o.enableTexturesOffline,o.version&&!isNaN(parseInt(o.version))&&(e.manifestVersionFound=o.version),e.callbackManifestChecked&&e.callbackManifestChecked(!0)}catch(r){t()}else t()},!1),a.addEventListener('error',function(){if(i){i=!1;var r=e.currentSceneUrl+'.manifest';a.open('GET',r,!0),a.send()}else t()},!1);try{a.send()}catch(e){d.Tools.Error('Error on XHR send request.'),this.callbackManifestChecked(!1)}},c.prototype.openAsync=function(e,t){var i=this,r=function(){i.isSupported=!1,t&&t()};if(!(this.idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline)))this.isSupported=!1,t&&t();else if(this.db)e&&e();else{this.hasReachedQuota=!1,this.isSupported=!0;var a=this.idbFactory.open('babylonjs',1);a.onerror=function(){r()},a.onblocked=function(){d.Tools.Error('IDB request blocked. Please reload the page.'),r()},a.onsuccess=function(){i.db=a.result,e()},a.onupgradeneeded=function(e){if(i.db=e.target.result,i.db)try{i.db.createObjectStore('scenes',{keyPath:'sceneUrl'}),i.db.createObjectStore('versions',{keyPath:'sceneUrl'}),i.db.createObjectStore('textures',{keyPath:'textureUrl'})}catch(e){d.Tools.Error('Error while creating object stores. Exception: '+e.message),r()}}}},c.prototype.loadImageFromDB=function(t,e){var i=this,r=c._ReturnFullUrlLocation(t),a=function(){i.hasReachedQuota||null===i.db?e.src=t:i._saveImageIntoDBAsync(r,e)};this.mustUpdateRessources?a():this._loadImageFromDBAsync(r,e,a)},c.prototype._loadImageFromDBAsync=function(e,t,i){if(this.isSupported&&null!==this.db){var r=this.db.transaction(['textures']),o;r.onabort=function(){t.src=e},r.oncomplete=function(){var r;if(o){var n=window.URL||window.webkitURL;r=n.createObjectURL(o.data,{oneTimeOnly:!0}),t.onerror=function(){d.Tools.Error('Error loading image from blob URL: '+r+' switching back to web url: '+e),t.src=e},t.src=r}else i()};var a=r.objectStore('textures').get(e);a.onsuccess=function(t){o=t.target.result},a.onerror=function(){d.Tools.Error('Error loading texture '+e+' from DB.'),t.src=e}}else d.Tools.Error('Error: IndexedDB not supported by your browser or BabylonJS Database is not open.'),t.src=e},c.prototype._saveImageIntoDBAsync=function(t,p){var r=this;if(this.isSupported){var n=function(){var r;if(a){var e=window.URL||window.webkitURL;try{r=e.createObjectURL(a,{oneTimeOnly:!0})}catch(t){r=e.createObjectURL(a)}}r&&(p.src=r)};if(c.IsUASupportingBlobStorage){var o=new XMLHttpRequest,a;o.open('GET',t,!0),o.responseType='blob',o.addEventListener('load',function(){if(200===o.status&&r.db){a=o.response;var d=r.db.transaction(['textures'],'readwrite');d.onabort=function(o){try{var e=o.srcElement||o.target,t=e.error;t&&'QuotaExceededError'===t.name&&(r.hasReachedQuota=!0)}catch(t){}n()},d.oncomplete=function(){n()};var e={textureUrl:t,data:a};try{var l=d.objectStore('textures').put(e);l.onsuccess=function(){},l.onerror=function(){n()}}catch(r){25===r.code&&(c.IsUASupportingBlobStorage=!1),p.src=t}}else p.src=t},!1),o.addEventListener('error',function(){d.Tools.Error('Error in XHR request in BABYLON.Database.'),p.src=t},!1),o.send()}else p.src=t}else d.Tools.Error('Error: IndexedDB not supported by your browser or BabylonJS Database is not open.'),p.src=t},c.prototype._checkVersionFromDB=function(r,e){var t=this;this._loadVersionFromDBAsync(r,e,function(){t._saveVersionIntoDBAsync(r,e)})},c.prototype._loadVersionFromDBAsync=function(e,l,t){var r=this;if(this.isSupported&&this.db){var i;try{var o=this.db.transaction(['versions']);o.oncomplete=function(){i?r.manifestVersionFound===i.data?l(i.data):(r.mustUpdateRessources=!0,t()):(r.mustUpdateRessources=!0,t())},o.onabort=function(){l(-1)};var n=o.objectStore('versions').get(e);n.onsuccess=function(t){i=t.target.result},n.onerror=function(){d.Tools.Error('Error loading version for scene '+e+' from DB.'),l(-1)}}catch(e){d.Tools.Error('Error while accessing \'versions\' object store (READ OP). Exception: '+e.message),l(-1)}}else d.Tools.Error('Error: IndexedDB not supported by your browser or BabylonJS Database is not open.'),l(-1)},c.prototype._saveVersionIntoDBAsync=function(e,a){var i=this;if(this.isSupported&&!this.hasReachedQuota&&this.db)try{var r=this.db.transaction(['versions'],'readwrite');r.onabort=function(r){try{var e=r.srcElement.error;e&&'QuotaExceededError'===e.name&&(i.hasReachedQuota=!0)}catch(t){}a(-1)},r.oncomplete=function(){a(i.manifestVersionFound)};var n={sceneUrl:e,data:this.manifestVersionFound},o=r.objectStore('versions').put(n);o.onsuccess=function(){},o.onerror=function(){d.Tools.Error('Error in DB add version request in BABYLON.Database.')}}catch(e){d.Tools.Error('Error while accessing \'versions\' object store (WRITE OP). Exception: '+e.message),a(-1)}else a(-1)},c.prototype.loadFileFromDB=function(t,d,i,r,n){var o=this,s=c._ReturnFullUrlLocation(t),a=function(){o._saveFileIntoDBAsync(s,d,i)};this._checkVersionFromDB(s,function(t){-1===t?r&&r():o.mustUpdateRessources?o._saveFileIntoDBAsync(s,d,i,n):o._loadFileFromDBAsync(s,d,a,n)})},c.prototype._loadFileFromDBAsync=function(e,t,i){if(this.isSupported&&this.db){var r=-1===e.indexOf('.babylon')?'textures':'scenes';var o=this.db.transaction([r]),a;o.oncomplete=function(){a?t(a.data):i()},o.onabort=function(){i()};var n=o.objectStore(r).get(e);n.onsuccess=function(t){a=t.target.result},n.onerror=function(){d.Tools.Error('Error loading file '+e+' from DB.'),i()}}else d.Tools.Error('Error: IndexedDB not supported by your browser or BabylonJS Database is not open.'),t()},c.prototype._saveFileIntoDBAsync=function(e,p,i,u){var n=this;if(this.isSupported){var o=-1===e.indexOf('.babylon')?'textures':'scenes';var s=new XMLHttpRequest,l;s.open('GET',e,!0),u&&(s.responseType='arraybuffer'),i&&(s.onprogress=i),s.addEventListener('load',function(){if(!(200===s.status||d.Tools.ValidateXHRData(s,u?6:1)))p();else if(l=u?s.response:s.responseText,!n.hasReachedQuota&&n.db){var i=n.db.transaction([o],'readwrite');i.onabort=function(r){try{var e=r.srcElement.error;e&&'QuotaExceededError'===e.name&&(n.hasReachedQuota=!0)}catch(t){}p(l)},i.oncomplete=function(){p(l)};var r='scenes'===o?{sceneUrl:e,data:l,version:n.manifestVersionFound}:{textureUrl:e,data:l};try{var f=i.objectStore(o).put(r);f.onsuccess=function(){},f.onerror=function(){d.Tools.Error('Error in DB add file request in BABYLON.Database.')}}catch(t){p(l)}}else p(l)},!1),s.addEventListener('error',function(){d.Tools.Error('error on XHR request.'),p()},!1),s.send()}else d.Tools.Error('Error: IndexedDB not supported by your browser or BabylonJS Database is not open.'),p()},c.IsUASupportingBlobStorage=!0,c.IDBStorageEnabled=!0,c._ParseURL=function(r){document.createElement('a').href=r;var e=r.substring(0,r.lastIndexOf('#')),t=r.substring(e.lastIndexOf('/')+1,r.length);return r.substring(0,r.indexOf(t,0))},c._ReturnFullUrlLocation=function(t){return-1===t.indexOf('http:/')&&-1===t.indexOf('https:/')?c._ParseURL(window.location.href)+t:t},c}();d.Database=e}(e||(e={}));var e;!function(o){var e=function(){function e(){this._isEnabled=!0,this.leftColor=o.Color3.White(),this.rightColor=o.Color3.Black(),this.bias=0,this.power=1}return Object.defineProperty(e.prototype,'isEnabled',{get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,o.Engine.MarkAllMaterialsAsDirty(o.Material.FresnelDirtyFlag|o.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=new e;return o.Tools.DeepCopy(this,t),t},e.prototype.serialize=function(){var t={};return t.isEnabled=this.isEnabled,t.leftColor=this.leftColor.asArray(),t.rightColor=this.rightColor.asArray(),t.bias=this.bias,t.power=this.power,t},e.Parse=function(t){var i=new e;return i.isEnabled=t.isEnabled,i.leftColor=o.Color3.FromArray(t.leftColor),i.rightColor=o.Color3.FromArray(t.rightColor),i.bias=t.bias,i.power=t.power||1,i},e}();o.FresnelParameters=e}(e||(e={}));var e;!function(o){var e=function(a){function l(t,e){var o=a.call(this,t,e,!0)||this;return e.multiMaterials.push(o),o.subMaterials=[],o.storeEffectOnSubMeshes=!0,o}return h(l,a),Object.defineProperty(l.prototype,'subMaterials',{get:function(){return this._subMaterials},set:function(t){this._subMaterials=t,this._hookArray(t)},enumerable:!0,configurable:!0}),l.prototype._hookArray=function(a){var e=this,t=a.push;a.push=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];var n=t.apply(a,i);return e._markAllSubMeshesAsTexturesDirty(),n};var s=a.splice;a.splice=function(t,r){var i=s.apply(a,[t,r]);return e._markAllSubMeshesAsTexturesDirty(),i}},l.prototype.getSubMaterial=function(t){return 0>t||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]},l.prototype.getActiveTextures=function(){return(t=a.prototype.getActiveTextures.call(this)).concat.apply(t,this.subMaterials.map(function(t){return t?t.getActiveTextures():[]}));var t},l.prototype.getClassName=function(){return'MultiMaterial'},l.prototype.isReadyForSubMesh=function(o,e,t){for(var i=0,r;i<this.subMaterials.length;i++)if(r=this.subMaterials[i],r){if(r.storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(o,e,t))return!1;continue}if(!r.isReady(o))return!1}return!0},l.prototype.clone=function(i,e){for(var t=new l(i,this.getScene()),r=0;r<this.subMaterials.length;r++){var a=null,o=this.subMaterials[r];a=e&&o?o.clone(i+'-'+o.name):this.subMaterials[r],t.subMaterials.push(a)}return t},l.prototype.serialize=function(){var e={};e.name=this.name,e.id=this.id,o.Tags&&(e.tags=o.Tags.GetTags(this)),e.materials=[];for(var t=0,i;t<this.subMaterials.length;t++)i=this.subMaterials[t],i?e.materials.push(i.id):e.materials.push(null);return e},l.prototype.dispose=function(t,e){var o=this.getScene();if(o){var r=o.multiMaterials.indexOf(this);0<=r&&o.multiMaterials.splice(r,1),a.prototype.dispose.call(this,t,e)}},l}(o.Material);o.MultiMaterial=e}(e||(e={}));var e;!function(o){var e=function(){function e(){this._offsetX=null,this._offsetY=null,this._pointerPressed=[],this.touchAngularSensibility=2e5,this.touchMoveSensibility=250}return e.prototype.attachControl=function(e,t){var i=this,r=null;void 0===this._pointerInput&&(this._onLostFocus=function(){i._offsetX=null,i._offsetY=null},this._pointerInput=function(e){var l=e.event;if('mouse'!==l.pointerType)if(e.type===o.PointerEventTypes.POINTERDOWN){if(t||l.preventDefault(),i._pointerPressed.push(l.pointerId),1!==i._pointerPressed.length)return;r={x:l.clientX,y:l.clientY}}else if(e.type===o.PointerEventTypes.POINTERUP){t||l.preventDefault();var s=i._pointerPressed.indexOf(l.pointerId);if(-1===s)return;if(i._pointerPressed.splice(s,1),0!=s)return;r=null,i._offsetX=null,i._offsetY=null}else if(e.type===o.PointerEventTypes.POINTERMOVE){if(t||l.preventDefault(),!r)return;var s=i._pointerPressed.indexOf(l.pointerId);if(0!=s)return;i._offsetX=l.clientX-r.x,i._offsetY=-(l.clientY-r.y)}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,o.PointerEventTypes.POINTERDOWN|o.PointerEventTypes.POINTERUP|o.PointerEventTypes.POINTERMOVE),this._onLostFocus&&e.addEventListener('blur',this._onLostFocus)},e.prototype.detachControl=function(t){this._pointerInput&&t&&(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus&&(t.removeEventListener('blur',this._onLostFocus),this._onLostFocus=null),this._pointerPressed=[],this._offsetX=null,this._offsetY=null)},e.prototype.checkInputs=function(){if(this._offsetX&&this._offsetY){var e=this.camera;if(e.cameraRotation.y+=this._offsetX/this.touchAngularSensibility,1<this._pointerPressed.length)e.cameraRotation.x+=-this._offsetY/this.touchAngularSensibility;else{var t=e._computeLocalCameraSpeed(),i=new o.Vector3(0,0,t*this._offsetY/this.touchMoveSensibility);o.Matrix.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(o.Vector3.TransformCoordinates(i,e._cameraRotationMatrix))}}},e.prototype.getClassName=function(){return'FreeCameraTouchInput'},e.prototype.getSimpleName=function(){return'touch'},g([o.serialize()],e.prototype,'touchAngularSensibility',void 0),g([o.serialize()],e.prototype,'touchMoveSensibility',void 0),e}();o.FreeCameraTouchInput=e,o.CameraInputTypes.FreeCameraTouchInput=e}(e||(e={}));var e;!function(r){var e=function(o){function e(e,a,i){var r=o.call(this,e,a,i)||this;return r.inputs.addTouch(),r._setupInputs(),r}return h(e,o),Object.defineProperty(e.prototype,'touchAngularSensibility',{get:function(){var t=this.inputs.attached.touch;return t?t.touchAngularSensibility:0},set:function(r){var e=this.inputs.attached.touch;e&&(e.touchAngularSensibility=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'touchMoveSensibility',{get:function(){var t=this.inputs.attached.touch;return t?t.touchMoveSensibility:0},set:function(r){var e=this.inputs.attached.touch;e&&(e.touchMoveSensibility=r)},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'TouchCamera'},e.prototype._setupInputs=function(){var t=this.inputs.attached.mouse;t&&(t.touchEnabled=!1)},e}(r.FreeCamera);r.TouchCamera=e}(e||(e={}));var e;!function(d){var e=function(e){function r(t,p,r,n,o,s,u){void 0===o&&(o=null),void 0===s&&(s=!0),void 0===u&&(u=!1);var l=e.call(this,null,n,!s)||this;l.isCube=u,l.isEnabled=!0,l._currentRefreshId=-1,l._refreshRate=1,l._vertexBuffers={},l._uniforms=[],l._samplers=[],l._textures={},l._floats={},l._floatsArrays={},l._colors3={},l._colors4={},l._vectors2={},l._vectors3={},l._matrices={},l._fallbackTextureUsed=!1,n.proceduralTextures.push(l),l._engine=n.getEngine(),l.name=t,l.isRenderTarget=!0,l._size=p,l._generateMipMaps=s,l.setFragment(r),l._fallbackTexture=o,u?(l._texture=l._engine.createRenderTargetCubeTexture(p,{generateMipMaps:s}),l.setFloat('face',0)):l._texture=l._engine.createRenderTargetTexture(p,s);var f=[];return f.push(1,1),f.push(-1,1),f.push(-1,-1),f.push(1,-1),l._vertexBuffers[d.VertexBuffer.PositionKind]=new d.VertexBuffer(l._engine,f,d.VertexBuffer.PositionKind,!1,!1,2),l._createIndexBuffer(),l}return h(r,e),r.prototype._createIndexBuffer=function(){var r=this._engine,e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=r.createIndexBuffer(e)},r.prototype._rebuild=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===d.RenderTargetTexture.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=d.RenderTargetTexture.REFRESHRATE_RENDER_ONCE)},r.prototype.reset=function(){void 0!==this._effect&&this._engine._releaseEffect(this._effect)},r.prototype.isReady=function(){var e=this,o=this._engine,r;return!!this._fragment&&(!!this._fallbackTextureUsed||(r=void 0===this._fragment.fragmentElement?{vertex:'procedural',fragment:this._fragment}:{vertex:'procedural',fragmentElement:this._fragment.fragmentElement},this._effect=o.createEffect(r,[d.VertexBuffer.PositionKind],this._uniforms,this._samplers,'',void 0,void 0,function(){e.releaseInternalTexture(),e._fallbackTexture&&(e._texture=e._fallbackTexture._texture,e._texture&&e._texture.incrementReferences()),e._fallbackTextureUsed=!0}),this._effect.isReady()))},r.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},r.prototype.setFragment=function(t){this._fragment=t},Object.defineProperty(r.prototype,'refreshRate',{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),r.prototype._shouldRender=function(){return!!(this.isEnabled&&this.isReady()&&this._texture)&&!this._fallbackTextureUsed&&(-1===this._currentRefreshId?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1))},r.prototype.getRenderSize=function(){return this._size},r.prototype.resize=function(r,e){this._fallbackTextureUsed||(this.releaseInternalTexture(),this._texture=this._engine.createRenderTargetTexture(r,e))},r.prototype._checkUniform=function(t){-1===this._uniforms.indexOf(t)&&this._uniforms.push(t)},r.prototype.setTexture=function(r,e){return-1===this._samplers.indexOf(r)&&this._samplers.push(r),this._textures[r]=e,this},r.prototype.setFloat=function(r,e){return this._checkUniform(r),this._floats[r]=e,this},r.prototype.setFloats=function(r,e){return this._checkUniform(r),this._floatsArrays[r]=e,this},r.prototype.setColor3=function(r,e){return this._checkUniform(r),this._colors3[r]=e,this},r.prototype.setColor4=function(r,e){return this._checkUniform(r),this._colors4[r]=e,this},r.prototype.setVector2=function(r,e){return this._checkUniform(r),this._vectors2[r]=e,this},r.prototype.setVector3=function(r,e){return this._checkUniform(r),this._vectors3[r]=e,this},r.prototype.setMatrix=function(r,e){return this._checkUniform(r),this._matrices[r]=e,this},r.prototype.render=function(){var e=this.getScene();if(e){var t=this._engine;for(var r in t.enableEffect(this._effect),t.setState(!1),this._textures)this._effect.setTexture(r,this._textures[r]);for(r in this._floats)this._effect.setFloat(r,this._floats[r]);for(r in this._floatsArrays)this._effect.setArray(r,this._floatsArrays[r]);for(r in this._colors3)this._effect.setColor3(r,this._colors3[r]);for(r in this._colors4){var i=this._colors4[r];this._effect.setFloat4(r,i.r,i.g,i.b,i.a)}for(r in this._vectors2)this._effect.setVector2(r,this._vectors2[r]);for(r in this._vectors3)this._effect.setVector3(r,this._vectors3[r]);for(r in this._matrices)this._effect.setMatrix(r,this._matrices[r]);if(this._texture){if(this.isCube)for(var o=0;6>o;o++)t.bindFramebuffer(this._texture,o,void 0,void 0,!0),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this._effect.setFloat('face',o),t.clear(e.clearColor,!0,!0,!0),t.drawElementsType(d.Material.TriangleFillMode,0,6),5===o&&t.generateMipMapsForCubemap(this._texture);else t.bindFramebuffer(this._texture,0,void 0,void 0,!0),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),t.clear(e.clearColor,!0,!0,!0),t.drawElementsType(d.Material.TriangleFillMode,0,6);t.unBindFramebuffer(this._texture,this.isCube),this.onGenerated&&this.onGenerated()}}},r.prototype.clone=function(){var o=this.getSize(),e=new r(this.name,o.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.coordinatesMode=this.coordinatesMode,e},r.prototype.dispose=function(){var t=this.getScene();if(t){var o=t.proceduralTextures.indexOf(this);0<=o&&t.proceduralTextures.splice(o,1);var r=this._vertexBuffers[d.VertexBuffer.PositionKind];r&&(r.dispose(),this._vertexBuffers[d.VertexBuffer.PositionKind]=null),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),e.prototype.dispose.call(this)}},r}(d.Texture);d.ProceduralTexture=e}(e||(e={}));var e;!function(a){var e=function(l){function e(t,e,d,r,n,o){var s=l.call(this,t,d,null,r,n,o)||this;return s._animate=!0,s._time=0,s._texturePath=e,s.loadJson(e),s.refreshRate=1,s}return h(e,l),e.prototype.loadJson=function(e){var t=this,i=function(){a.Tools.Log('No config file found in '+e+' trying to use ShadersStore or DOM element');try{t.setFragment(t._texturePath)}catch(e){a.Tools.Error('No json or ShaderStore or DOM element found for CustomProceduralTexture')}},r=new XMLHttpRequest;r.open('GET',e+'/config.json',!0),r.addEventListener('load',function(){if(200===r.status||a.Tools.ValidateXHRData(r,1))try{t._config=JSON.parse(r.response),t.updateShaderUniforms(),t.updateTextures(),t.setFragment(t._texturePath+'/custom'),t._animate=t._config.animate,t.refreshRate=t._config.refreshrate}catch(t){i()}else i()},!1),r.addEventListener('error',function(){i()},!1);try{r.send()}catch(e){a.Tools.Error('CustomProceduralTexture: Error on XHR send request.')}},e.prototype.isReady=function(){if(!l.prototype.isReady.call(this))return!1;for(var t in this._textures)if(!this._textures[t].isReady())return!1;return!0},e.prototype.render=function(t){var e=this.getScene();this._animate&&e&&(this._time+=.03*e.getAnimationRatio(),this.updateShaderUniforms()),l.prototype.render.call(this,t)},e.prototype.updateTextures=function(){for(var e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new a.Texture(this._texturePath+'/'+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))},e.prototype.updateShaderUniforms=function(){if(this._config)for(var e=0,t;e<this._config.uniforms.length;e++)switch(t=this._config.uniforms[e],t.type){case'float':this.setFloat(t.name,t.value);break;case'color3':this.setColor3(t.name,new a.Color3(t.r,t.g,t.b));break;case'color4':this.setColor4(t.name,new a.Color4(t.r,t.g,t.b,t.a));break;case'vector2':this.setVector2(t.name,new a.Vector2(t.x,t.y));break;case'vector3':this.setVector3(t.name,new a.Vector3(t.x,t.y,t.z));}this.setFloat('time',this._time)},Object.defineProperty(e.prototype,'animate',{get:function(){return this._animate},set:function(t){this._animate=t},enumerable:!0,configurable:!0}),e}(a.ProceduralTexture);a.CustomProceduralTexture=e}(e||(e={}));var e;!function(d){var e=function(){function e(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this._cameraTransform=d.Matrix.Identity(),this._deltaTransform=d.Vector3.Zero(),this._vector3=d.Vector3.Zero(),this._vector2=d.Vector2.Zero()}return e.prototype.attachControl=function(){var o=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(e){e.type!==d.Gamepad.POSE_ENABLED&&(o.gamepad&&e.type!==d.Gamepad.XBOX||(o.gamepad=e))}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(t){o.gamepad===t&&(o.gamepad=null)}),this.gamepad=e.getGamepadByType(d.Gamepad.XBOX)},e.prototype.detachControl=function(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},e.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var e=this.camera,t=this.gamepad.leftStick,i=t.x/this.gamepadMoveSensibility,r=t.y/this.gamepadMoveSensibility;t.x=.005<A(i)?0+i:0,t.y=.005<A(r)?0+r:0;var n=this.gamepad.rightStick;if(n){var o=n.x/this.gamepadAngularSensibility,s=n.y/this.gamepadAngularSensibility;n.x=.001<A(o)?0+o:0,n.y=.001<A(s)?0+s:0}else n={x:0,y:0};e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):d.Matrix.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);var a=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*a,0,-t.y*a),d.Vector3.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(n.y,n.x),e.cameraRotation.addInPlace(this._vector2)}},e.prototype.getClassName=function(){return'FreeCameraGamepadInput'},e.prototype.getSimpleName=function(){return'gamepad'},g([d.serialize()],e.prototype,'gamepadAngularSensibility',void 0),g([d.serialize()],e.prototype,'gamepadMoveSensibility',void 0),e}();d.FreeCameraGamepadInput=e,d.CameraInputTypes.FreeCameraGamepadInput=e}(e||(e={}));var e;!function(o){var e=function(){function e(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40}return e.prototype.attachControl=function(){var i=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(e){e.type!==o.Gamepad.POSE_ENABLED&&(i.gamepad&&e.type!==o.Gamepad.XBOX||(i.gamepad=e))}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(t){i.gamepad===t&&(i.gamepad=null)}),this.gamepad=e.getGamepadByType(o.Gamepad.XBOX)},e.prototype.detachControl=function(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},e.prototype.checkInputs=function(){if(this.gamepad){var a=this.camera,e=this.gamepad.rightStick;if(e){if(0!=e.x){var t=e.x/this.gamepadRotationSensibility;0!=t&&.005<A(t)&&(a.inertialAlphaOffset+=t)}if(0!=e.y){var i=e.y/this.gamepadRotationSensibility;0!=i&&.005<A(i)&&(a.inertialBetaOffset+=i)}}var r=this.gamepad.leftStick;if(r&&0!=r.y){var n=r.y/this.gamepadMoveSensibility;0!=n&&.005<A(n)&&(this.camera.inertialRadiusOffset-=n)}}},e.prototype.getClassName=function(){return'ArcRotateCameraGamepadInput'},e.prototype.getSimpleName=function(){return'gamepad'},g([o.serialize()],e.prototype,'gamepadRotationSensibility',void 0),g([o.serialize()],e.prototype,'gamepadMoveSensibility',void 0),e}();o.ArcRotateCameraGamepadInput=e,o.CameraInputTypes.ArcRotateCameraGamepadInput=e}(e||(e={}));var e;!function(o){var e=function(){function e(e){var a=this;this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new o.Observable,o.Tools.IsWindowObjectExist()?(this._gamepadEventSupported='GamepadEvent'in window,this._gamepadSupport=navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new o.Observable(function(o){for(var e in a._babylonGamepads){var t=a._babylonGamepads[e];t&&t._isConnected&&a.onGamepadConnectedObservable.notifyObserver(o,t)}}),this._onGamepadConnectedEvent=function(o){var e=o.gamepad;if(!(e.index in a._babylonGamepads&&a._babylonGamepads[e.index].isConnected)){var t;a._babylonGamepads[e.index]?(t=a._babylonGamepads[e.index],t.browserGamepad=e,t._isConnected=!0):t=a._addNewGamepad(e),a.onGamepadConnectedObservable.notifyObservers(t),a._startMonitoringGamepads()}},this._onGamepadDisconnectedEvent=function(o){var e=o.gamepad;for(var t in a._babylonGamepads)if(a._babylonGamepads[t].index===e.index){var r=a._babylonGamepads[t];r._isConnected=!1,a.onGamepadDisconnectedObservable.notifyObservers(r);break}},this._gamepadSupport&&(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported?(window.addEventListener('gamepadconnected',this._onGamepadConnectedEvent,!1),window.addEventListener('gamepaddisconnected',this._onGamepadDisconnectedEvent,!1)):this._startMonitoringGamepads())}return Object.defineProperty(e.prototype,'gamepads',{get:function(){return this._babylonGamepads},enumerable:!0,configurable:!0}),e.prototype.getGamepadByType=function(e){void 0===e&&(e=o.Gamepad.XBOX);for(var t=0,i=this._babylonGamepads,r;t<i.length;t++)if(r=i[t],r&&r.type===e)return r;return null},e.prototype.dispose=function(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener('gamepadconnected',this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener('gamepaddisconnected',this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(function(t){t.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]},e.prototype._addNewGamepad=function(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);var t=-1!==e.id.search('Xbox One'),r;return r=t||-1!==e.id.search('Xbox 360')||-1!==e.id.search('xinput')?new o.Xbox360Pad(e.id,e.index,e,t):e.pose?o.PoseEnabledControllerHelper.InitiateController(e):new o.GenericPad(e.id,e.index,e),this._babylonGamepads[r.index]=r,r},e.prototype._startMonitoringGamepads=function(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())},e.prototype._stopMonitoringGamepads=function(){this._isMonitoring=!1},e.prototype._checkGamepadsStatus=function(){var e=this;for(var t in this._updateGamepadObjects(),this._babylonGamepads){var i=this._babylonGamepads[t];i&&i.isConnected&&i.update()}this._isMonitoring&&!this._scene&&o.Tools.QueueNewFrame(function(){e._checkGamepadsStatus()})},e.prototype._updateGamepadObjects=function(){for(var o=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e=0,t;e<o.length;e++)if(t=o[e],t)if(this._babylonGamepads[t.index])this._babylonGamepads[e].browserGamepad=t,this._babylonGamepads[e].isConnected||(this._babylonGamepads[e]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[e]));else{var i=this._addNewGamepad(t);this.onGamepadConnectedObservable.notifyObservers(i)}},e}();o.GamepadManager=e}(e||(e={}));var e;!function(a){var e=function(){function t(r,o){this.x=r,this.y=o}return t}();a.StickValues=e;var l=function(){function l(e,t,i,r,n,o,s){void 0===r&&(r=0),void 0===n&&(n=1),void 0===o&&(o=2),void 0===s&&(s=3),this.id=e,this.index=t,this.browserGamepad=i,this._isConnected=!0,this._invertLeftStickY=!1,this.type=l.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=n,this._rightStickAxisX=o,this._rightStickAxisY=s,2<=this.browserGamepad.axes.length&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),4<=this.browserGamepad.axes.length&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return Object.defineProperty(l.prototype,'isConnected',{get:function(){return this._isConnected},enumerable:!0,configurable:!0}),l.prototype.onleftstickchanged=function(t){this._onleftstickchanged=t},l.prototype.onrightstickchanged=function(t){this._onrightstickchanged=t},Object.defineProperty(l.prototype,'leftStick',{get:function(){return this._leftStick},set:function(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,'rightStick',{get:function(){return this._rightStick},set:function(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t},enumerable:!0,configurable:!0}),l.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},l.prototype.dispose=function(){},l.GAMEPAD=0,l.GENERIC=1,l.XBOX=2,l.POSE_ENABLED=3,l}();a.Gamepad=l;var t=function(i){function e(e,t,n){var o=i.call(this,e,t,n)||this;return o.onButtonDownObservable=new a.Observable,o.onButtonUpObservable=new a.Observable,o.type=l.GENERIC,o._buttons=Array(n.buttons.length),o}return h(e,i),e.prototype.onbuttondown=function(t){this._onbuttondown=t},e.prototype.onbuttonup=function(t){this._onbuttonup=t},e.prototype._setButtonValue=function(r,e,t){return r!==e&&(1===r&&(this._onbuttondown&&this._onbuttondown(t),this.onButtonDownObservable.notifyObservers(t)),0===r&&(this._onbuttonup&&this._onbuttonup(t),this.onButtonUpObservable.notifyObservers(t))),r},e.prototype.update=function(){i.prototype.update.call(this);for(var t=0;t<this._buttons.length;t++)this._buttons[t]=this._setButtonValue(this.browserGamepad.buttons[t].value,this._buttons[t],t)},e.prototype.dispose=function(){i.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()},e}(l);a.GenericPad=t}(e||(e={}));var e;!function(a){var o;!function(t){t[t.A=0]='A',t[t.B=1]='B',t[t.X=2]='X',t[t.Y=3]='Y',t[t.Start=4]='Start',t[t.Back=5]='Back',t[t.LB=6]='LB',t[t.RB=7]='RB',t[t.LeftStick=8]='LeftStick',t[t.RightStick=9]='RightStick'}(o=a.Xbox360Button||(a.Xbox360Button={}));var t;!function(t){t[t.Up=0]='Up',t[t.Down=1]='Down',t[t.Left=2]='Left',t[t.Right=3]='Right'}(t=a.Xbox360Dpad||(a.Xbox360Dpad={}));var e=function(e){function r(r,t,i,l){void 0===l&&(l=!1);var o=e.call(this,r,t,i,0,1,2,3)||this;return o._leftTrigger=0,o._rightTrigger=0,o.onButtonDownObservable=new a.Observable,o.onButtonUpObservable=new a.Observable,o.onPadDownObservable=new a.Observable,o.onPadUpObservable=new a.Observable,o._buttonA=0,o._buttonB=0,o._buttonX=0,o._buttonY=0,o._buttonBack=0,o._buttonStart=0,o._buttonLB=0,o._buttonRB=0,o._buttonLeftStick=0,o._buttonRightStick=0,o._dPadUp=0,o._dPadDown=0,o._dPadLeft=0,o._dPadRight=0,o._isXboxOnePad=!1,o.type=a.Gamepad.XBOX,o._isXboxOnePad=l,o}return h(r,e),r.prototype.onlefttriggerchanged=function(t){this._onlefttriggerchanged=t},r.prototype.onrighttriggerchanged=function(t){this._onrighttriggerchanged=t},Object.defineProperty(r.prototype,'leftTrigger',{get:function(){return this._leftTrigger},set:function(t){this._onlefttriggerchanged&&this._leftTrigger!==t&&this._onlefttriggerchanged(t),this._leftTrigger=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'rightTrigger',{get:function(){return this._rightTrigger},set:function(t){this._onrighttriggerchanged&&this._rightTrigger!==t&&this._onrighttriggerchanged(t),this._rightTrigger=t},enumerable:!0,configurable:!0}),r.prototype.onbuttondown=function(t){this._onbuttondown=t},r.prototype.onbuttonup=function(t){this._onbuttonup=t},r.prototype.ondpaddown=function(t){this._ondpaddown=t},r.prototype.ondpadup=function(t){this._ondpadup=t},r.prototype._setButtonValue=function(r,e,t){return r!==e&&(1===r&&(this._onbuttondown&&this._onbuttondown(t),this.onButtonDownObservable.notifyObservers(t)),0===r&&(this._onbuttonup&&this._onbuttonup(t),this.onButtonUpObservable.notifyObservers(t))),r},r.prototype._setDPadValue=function(r,e,t){return r!==e&&(1===r&&(this._ondpaddown&&this._ondpaddown(t),this.onPadDownObservable.notifyObservers(t)),0===r&&(this._ondpadup&&this._ondpadup(t),this.onPadUpObservable.notifyObservers(t))),r},Object.defineProperty(r.prototype,'buttonA',{get:function(){return this._buttonA},set:function(t){this._buttonA=this._setButtonValue(t,this._buttonA,o.A)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonB',{get:function(){return this._buttonB},set:function(t){this._buttonB=this._setButtonValue(t,this._buttonB,o.B)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonX',{get:function(){return this._buttonX},set:function(t){this._buttonX=this._setButtonValue(t,this._buttonX,o.X)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonY',{get:function(){return this._buttonY},set:function(t){this._buttonY=this._setButtonValue(t,this._buttonY,o.Y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonStart',{get:function(){return this._buttonStart},set:function(t){this._buttonStart=this._setButtonValue(t,this._buttonStart,o.Start)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonBack',{get:function(){return this._buttonBack},set:function(t){this._buttonBack=this._setButtonValue(t,this._buttonBack,o.Back)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonLB',{get:function(){return this._buttonLB},set:function(t){this._buttonLB=this._setButtonValue(t,this._buttonLB,o.LB)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonRB',{get:function(){return this._buttonRB},set:function(t){this._buttonRB=this._setButtonValue(t,this._buttonRB,o.RB)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonLeftStick',{get:function(){return this._buttonLeftStick},set:function(t){this._buttonLeftStick=this._setButtonValue(t,this._buttonLeftStick,o.LeftStick)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'buttonRightStick',{get:function(){return this._buttonRightStick},set:function(t){this._buttonRightStick=this._setButtonValue(t,this._buttonRightStick,o.RightStick)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'dPadUp',{get:function(){return this._dPadUp},set:function(r){this._dPadUp=this._setDPadValue(r,this._dPadUp,t.Up)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'dPadDown',{get:function(){return this._dPadDown},set:function(r){this._dPadDown=this._setDPadValue(r,this._dPadDown,t.Down)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'dPadLeft',{get:function(){return this._dPadLeft},set:function(r){this._dPadLeft=this._setDPadValue(r,this._dPadLeft,t.Left)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,'dPadRight',{get:function(){return this._dPadRight},set:function(r){this._dPadRight=this._setDPadValue(r,this._dPadRight,t.Right)},enumerable:!0,configurable:!0}),r.prototype.update=function(){e.prototype.update.call(this),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.axes[2],this.rightTrigger=this.browserGamepad.axes[5],this.buttonBack=this.browserGamepad.buttons[9].value,this.buttonStart=this.browserGamepad.buttons[8].value,this.buttonLeftStick=this.browserGamepad.buttons[6].value,this.buttonRightStick=this.browserGamepad.buttons[7].value,this.dPadUp=this.browserGamepad.buttons[11].value,this.dPadDown=this.browserGamepad.buttons[12].value,this.dPadLeft=this.browserGamepad.buttons[13].value,this.dPadRight=this.browserGamepad.buttons[14].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},r}(a.Gamepad);a.Xbox360Pad=e}(e||(e={}));var e;!function(a){var e;!function(t){t[t.VIVE=0]='VIVE',t[t.OCULUS=1]='OCULUS',t[t.WINDOWS=2]='WINDOWS',t[t.GEAR_VR=3]='GEAR_VR',t[t.DAYDREAM=4]='DAYDREAM',t[t.GENERIC=5]='GENERIC'}(e=a.PoseEnabledControllerType||(a.PoseEnabledControllerType={}));var t=function(){function e(){}return e.InitiateController=function(e){return-1===e.id.indexOf('Oculus Touch')?0===e.id.indexOf(a.WindowsMotionController.GAMEPAD_ID_PREFIX)?new a.WindowsMotionController(e):-1===e.id.toLowerCase().indexOf('openvr')?0===e.id.indexOf(a.GearVRController.GAMEPAD_ID_PREFIX)?new a.GearVRController(e):0===e.id.indexOf(a.DaydreamController.GAMEPAD_ID_PREFIX)?new a.DaydreamController(e):new a.GenericController(e):new a.ViveController(e):new a.OculusTouchController(e)},e}();a.PoseEnabledControllerHelper=t;var o=function(o){function t(t){var i=o.call(this,t.id,t.index,t)||this;return i._deviceRoomPosition=a.Vector3.Zero(),i._deviceRoomRotationQuaternion=new a.Quaternion,i.devicePosition=a.Vector3.Zero(),i.deviceRotationQuaternion=new a.Quaternion,i.deviceScaleFactor=1,i._leftHandSystemQuaternion=new a.Quaternion,i._deviceToWorld=a.Matrix.Identity(),i._pointingPoseNode=null,i._workingMatrix=a.Matrix.Identity(),i._meshAttachedObservable=new a.Observable,i.type=a.Gamepad.POSE_ENABLED,i.controllerType=e.GENERIC,i.position=a.Vector3.Zero(),i.rotationQuaternion=new a.Quaternion,i._calculatedPosition=a.Vector3.Zero(),i._calculatedRotation=new a.Quaternion,a.Quaternion.RotationYawPitchRollToRef(Math.PI,0,0,i._leftHandSystemQuaternion),i}return h(t,o),t.prototype.update=function(){o.prototype.update.call(this);var e=this.browserGamepad.pose;this.updateFromDevice(e),a.Vector3.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),a.Quaternion.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))},t.prototype.updateFromDevice=function(r){if(r){this.rawPose=r,r.position&&(this._deviceRoomPosition.copyFromFloats(r.position[0],r.position[1],-r.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));var e=this.rawPose;r.orientation&&e.orientation&&(this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}},t.prototype.attachToMesh=function(e){this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new a.Quaternion),this._meshAttachedObservable.notifyObservers(e)},t.prototype.attachToPoseControlledCamera=function(t){this._poseControlledCamera=t,this._mesh&&(this._mesh.parent=this._poseControlledCamera)},t.prototype.dispose=function(){this._mesh&&this._mesh.dispose(),this._mesh=null,o.prototype.dispose.call(this)},Object.defineProperty(t.prototype,'mesh',{get:function(){return this._mesh},enumerable:!0,configurable:!0}),t.prototype.getForwardRay=function(e){if(void 0===e&&(e=100),!this.mesh)return new a.Ray(a.Vector3.Zero(),new a.Vector3(0,0,1),e);var t=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),i=t.getTranslation(),r=new a.Vector3(0,0,-1),n=a.Vector3.TransformNormal(r,t),o=a.Vector3.Normalize(n);return new a.Ray(i,o,e)},t.POINTING_POSE='POINTING_POSE',t}(a.Gamepad);a.PoseEnabledController=o}(e||(e={}));var e;!function(o){var e=function(a){function e(e){var t=a.call(this,e)||this;return t.onTriggerStateChangedObservable=new o.Observable,t.onMainButtonStateChangedObservable=new o.Observable,t.onSecondaryButtonStateChangedObservable=new o.Observable,t.onPadStateChangedObservable=new o.Observable,t.onPadValuesChangedObservable=new o.Observable,t.pad={x:0,y:0},t._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},t._buttons=Array(e.buttons.length),t.hand=e.hand,t}return h(e,a),e.prototype.onButtonStateChange=function(t){this._onButtonStateChange=t},Object.defineProperty(e.prototype,'defaultModel',{get:function(){return this._defaultModel},enumerable:!0,configurable:!0}),e.prototype.update=function(){a.prototype.update.call(this);for(var t=0;t<this._buttons.length;t++)this._setButtonValue(this.browserGamepad.buttons[t],this._buttons[t],t);this.leftStick.x===this.pad.x&&this.leftStick.y===this.pad.y||(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))},e.prototype._setButtonValue=function(r,e,o){return(r||(r={pressed:!1,touched:!1,value:0}),!e)?void(this._buttons[o]={pressed:r.pressed,touched:r.touched,value:r.value}):void(this._checkChanges(r,e),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,o,r),this._handleButtonChange(o,r,this._changes)),this._buttons[o].pressed=r.pressed,this._buttons[o].touched=r.touched,this._buttons[o].value=1e-8>r.value?0:r.value)},e.prototype._checkChanges=function(r,e){return this._changes.pressChanged=r.pressed!==e.pressed,this._changes.touchChanged=r.touched!==e.touched,this._changes.valueChanged=r.value!==e.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes},e.prototype.dispose=function(){a.prototype.dispose.call(this),this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()},e}(o.PoseEnabledController);o.WebVRController=e}(e||(e={}));var e;!function(a){var e=function(e){function s(t){var o=e.call(this,t)||this;return o.onSecondaryTriggerStateChangedObservable=new a.Observable,o.onThumbRestChangedObservable=new a.Observable,o.controllerType=a.PoseEnabledControllerType.OCULUS,o}return h(s,e),s.prototype.initControllerMesh=function(e,t){var r=this,o;o='left'===this.hand?s.MODEL_LEFT_FILENAME:s.MODEL_RIGHT_FILENAME,a.SceneLoader.ImportMesh('',s.MODEL_BASE_URL,o,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),t&&t(r._defaultModel)})},Object.defineProperty(s.prototype,'onAButtonStateChangedObservable',{get:function(){if('right'===this.hand)return this.onMainButtonStateChangedObservable;throw new Error('No A button on left hand')},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'onBButtonStateChangedObservable',{get:function(){if('right'===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error('No B button on left hand')},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'onXButtonStateChangedObservable',{get:function(){if('left'===this.hand)return this.onMainButtonStateChangedObservable;throw new Error('No X button on right hand')},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'onYButtonStateChangedObservable',{get:function(){if('left'===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error('No Y button on right hand')},enumerable:!0,configurable:!0}),s.prototype._handleButtonChange=function(o,e){var t=e,r='right'===this.hand?-1:1;return 0===o?void this.onPadStateChangedObservable.notifyObservers(t):1===o?(this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=.2*-t.value,this._defaultModel.getChildren()[3].position.y=.005*-t.value,this._defaultModel.getChildren()[3].position.z=.005*-t.value),void this.onTriggerStateChangedObservable.notifyObservers(t)):2===o?(this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=.0035*(r*t.value)),void this.onSecondaryTriggerStateChangedObservable.notifyObservers(t)):3===o?(this._defaultModel&&(t.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),void this.onMainButtonStateChangedObservable.notifyObservers(t)):4===o?(this._defaultModel&&(t.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(t)):5===o?void this.onThumbRestChangedObservable.notifyObservers(t):void 0},s.MODEL_BASE_URL='https://controllers.babylonjs.com/oculus/',s.MODEL_LEFT_FILENAME='left.babylon',s.MODEL_RIGHT_FILENAME='right.babylon',s}(a.WebVRController);a.OculusTouchController=e}(e||(e={}));var e;!function(o){var e=function(e){function a(t){var a=e.call(this,t)||this;return a.controllerType=o.PoseEnabledControllerType.VIVE,a._invertLeftStickY=!0,a}return h(a,e),a.prototype.initControllerMesh=function(e,t){var r=this;o.SceneLoader.ImportMesh('',a.MODEL_BASE_URL,a.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),t&&t(r._defaultModel)})},Object.defineProperty(a.prototype,'onLeftButtonStateChangedObservable',{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'onRightButtonStateChangedObservable',{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'onMenuButtonStateChangedObservable',{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!0,configurable:!0}),a.prototype._handleButtonChange=function(o,e){var t=e;return 0===o?void this.onPadStateChangedObservable.notifyObservers(t):1===o?(this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=.15*-t.value),void this.onTriggerStateChangedObservable.notifyObservers(t)):2===o?void this.onMainButtonStateChangedObservable.notifyObservers(t):3===o?(this._defaultModel&&(t.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(t)):void 0},a.MODEL_BASE_URL='https://controllers.babylonjs.com/vive/',a.MODEL_FILENAME='wand.babylon',a}(o.WebVRController);o.ViveController=e}(e||(e={}));var e;!function(o){var e=function(r){function e(t){return r.call(this,t)||this}return h(e,r),e.prototype.initControllerMesh=function(i,t){var r=this;o.SceneLoader.ImportMesh('',e.MODEL_BASE_URL,e.MODEL_FILENAME,i,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),t&&t(r._defaultModel)})},e.prototype._handleButtonChange=function(r,e){console.log('Button id: '+r+'state: '),console.dir(e)},e.MODEL_BASE_URL='https://controllers.babylonjs.com/generic/',e.MODEL_FILENAME='generic.babylon',e}(o.WebVRController);o.GenericController=e}(e||(e={}));var e;!function(d){var e=function(){return function(){this.buttonMeshes={},this.axisMeshes={}}}(),t=function(l){function t(e){var t=l.call(this,e)||this;return t._mapping={buttons:['thumbstick','trigger','grip','menu','trackpad'],buttonMeshNames:{trigger:'SELECT',menu:'MENU',grip:'GRASP',thumbstick:'THUMBSTICK_PRESS',trackpad:'TOUCHPAD_PRESS'},buttonObservableNames:{trigger:'onTriggerStateChangedObservable',menu:'onSecondaryButtonStateChangedObservable',grip:'onMainButtonStateChangedObservable',thumbstick:'onPadStateChangedObservable',trackpad:'onTrackpadChangedObservable'},axisMeshNames:['THUMBSTICK_X','THUMBSTICK_Y','TOUCHPAD_TOUCH_X','TOUCHPAD_TOUCH_Y'],pointingPoseMeshName:d.PoseEnabledController.POINTING_POSE},t.onTrackpadChangedObservable=new d.Observable,t.onTrackpadValuesChangedObservable=new d.Observable,t.trackpad={x:0,y:0},t.controllerType=d.PoseEnabledControllerType.WINDOWS,t._loadedMeshInfo=null,t}return h(t,l),Object.defineProperty(t.prototype,'onTriggerButtonStateChangedObservable',{get:function(){return this.onTriggerStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'onMenuButtonStateChangedObservable',{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'onGripButtonStateChangedObservable',{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'onThumbstickButtonStateChangedObservable',{get:function(){return this.onPadStateChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'onTouchpadButtonStateChangedObservable',{get:function(){return this.onTrackpadChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'onTouchpadValuesChangedObservable',{get:function(){return this.onTrackpadValuesChangedObservable},enumerable:!0,configurable:!0}),t.prototype.update=function(){if(l.prototype.update.call(this),this.browserGamepad.axes&&(this.browserGamepad.axes[2]==this.trackpad.x&&this.browserGamepad.axes[3]==this.trackpad.y||(this.trackpad.x=this.browserGamepad.axes[2],this.trackpad.y=this.browserGamepad.axes[3],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad)),this._loadedMeshInfo))for(var t=0;t<this._mapping.axisMeshNames.length;t++)this._lerpAxisTransform(t,this.browserGamepad.axes[t])},t.prototype._handleButtonChange=function(o,e){var t=this._mapping.buttons[o];if(t){var r=this[this._mapping.buttonObservableNames[t]];r&&r.notifyObservers(e),this._lerpButtonTransform(t,e.value)}},t.prototype._lerpButtonTransform=function(e,t){if(this._loadedMeshInfo){var o=this._loadedMeshInfo.buttonMeshes[e];o.unpressed.rotationQuaternion&&o.pressed.rotationQuaternion&&o.value.rotationQuaternion&&(d.Quaternion.SlerpToRef(o.unpressed.rotationQuaternion,o.pressed.rotationQuaternion,t,o.value.rotationQuaternion),d.Vector3.LerpToRef(o.unpressed.position,o.pressed.position,t,o.value.position))}},t.prototype._lerpAxisTransform=function(e,t){if(this._loadedMeshInfo){var o=this._loadedMeshInfo.axisMeshes[e];if(o&&o.min.rotationQuaternion&&o.max.rotationQuaternion&&o.value.rotationQuaternion){var r=.5*t+.5;d.Quaternion.SlerpToRef(o.min.rotationQuaternion,o.max.rotationQuaternion,r,o.value.rotationQuaternion),d.Vector3.LerpToRef(o.min.position,o.max.position,r,o.value.position)}}},t.prototype.initControllerMesh=function(r,c,e){var i=this;void 0===e&&(e=!1);var o,s;if(d.SceneLoader.IsPluginForExtensionAvailable('.glb')){var a='default';if(this.id&&!e){var l=this.id.match(t.GAMEPAD_ID_PATTERN);a=l&&l[0]||a}s='left'===this.hand?t.MODEL_LEFT_FILENAME:t.MODEL_RIGHT_FILENAME,o=t.MODEL_BASE_URL+a+'/'}else d.Tools.Warn('You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models'),o=d.GenericController.MODEL_BASE_URL,s=d.GenericController.MODEL_FILENAME;d.SceneLoader.ImportMesh('',o,s,r,function(t){i._loadedMeshInfo=i.processModel(r,t),i._loadedMeshInfo&&(i._defaultModel=i._loadedMeshInfo.rootNode,i.attachToMesh(i._defaultModel),c&&c(i._defaultModel))},null,function(a,t){d.Tools.Log(t),d.Tools.Warn('Failed to retrieve controller model from the remote server: '+o+s),e||i.initControllerMesh(a,c,!0)})},t.prototype.processModel=function(e,t){for(var i=null,r=new d.Mesh(this.id+' '+this.hand,e),n=null,o=0,s;o<t.length;o++)if(s=t[o],!s.parent){s.isPickable=!1,n=s;break}return n?(n.setParent(r),i=this.createMeshInfo(r)):d.Tools.Warn('Could not find root node in model file.'),i},t.prototype.createMeshInfo=function(t){function i(r,o){return r.getChildMeshes(!1,function(t){return t.name===o})[0]}function r(r,o){return r.getChildMeshes(!0,function(t){return t.name==o})[0]}var n=new e,s;for(n.rootNode=t,n.buttonMeshes={},n.axisMeshes={},s=0;s<this._mapping.buttons.length;s++){var p=this._mapping.buttonMeshNames[this._mapping.buttons[s]];if(p){var a=i(t,p);if(a){var l={index:s,value:r(a,'VALUE'),pressed:r(a,'PRESSED'),unpressed:r(a,'UNPRESSED')};l.value&&l.pressed&&l.unpressed?n.buttonMeshes[this._mapping.buttons[s]]=l:d.Tools.Warn('Missing button submesh under mesh with name: '+p+'(VALUE: '+!!l.value+', PRESSED: '+!!l.pressed+', UNPRESSED:'+!!l.unpressed+')')}else d.Tools.Warn('Missing button mesh with name: '+p)}else d.Tools.Log('Skipping unknown button at index: '+s+' with mapped name: '+this._mapping.buttons[s])}for(s=0;s<this._mapping.axisMeshNames.length;s++){var _=this._mapping.axisMeshNames[s];if(_){var c=i(t,_);if(c){var u={index:s,value:r(c,'VALUE'),min:r(c,'MIN'),max:r(c,'MAX')};u.value&&u.min&&u.max?n.axisMeshes[s]=u:d.Tools.Warn('Missing axis submesh under mesh with name: '+_+'(VALUE: '+!!u.value+', MIN: '+!!u.min+', MAX:'+!!u.max+')')}else d.Tools.Warn('Missing axis mesh with name: '+_)}else d.Tools.Log('Skipping unknown axis at index: '+s)}return n.pointingPoseNode=i(t,this._mapping.pointingPoseMeshName),n.pointingPoseNode||d.Tools.Warn('Missing pointing pose mesh with name: '+this._mapping.pointingPoseMeshName),n},t.prototype.getForwardRay=function(e){if(void 0===e&&(e=100),!this._loadedMeshInfo||!this._loadedMeshInfo.pointingPoseNode)return l.prototype.getForwardRay.call(this,e);var t=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),r=t.getTranslation(),i=new d.Vector3(0,0,-1),o=d.Vector3.TransformNormal(i,t),n=d.Vector3.Normalize(o);return new d.Ray(r,n,e)},t.prototype.dispose=function(){l.prototype.dispose.call(this),this.onTrackpadChangedObservable.clear()},t.MODEL_BASE_URL='https://controllers.babylonjs.com/microsoft/',t.MODEL_LEFT_FILENAME='left.glb',t.MODEL_RIGHT_FILENAME='right.glb',t.GAMEPAD_ID_PREFIX='Spatial Controller (Spatial Interaction Source) ',t.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/,t}(d.WebVRController);d.WindowsMotionController=t}(e||(e={}));var e;!function(o){var e=function(e){function a(t){var a=e.call(this,t)||this;return a._buttonIndexToObservableNameMap=['onTrackpadChangedObservable','onTriggerStateChangedObservable'],a.controllerType=o.PoseEnabledControllerType.GEAR_VR,a}return h(a,e),a.prototype.initControllerMesh=function(e,t){var r=this;o.SceneLoader.ImportMesh('',a.MODEL_BASE_URL,a.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),t&&t(r._defaultModel)})},a.prototype._handleButtonChange=function(o,e){if(o<this._buttonIndexToObservableNameMap.length){var t=this._buttonIndexToObservableNameMap[o],r=this[t];r&&r.notifyObservers(e)}},a.MODEL_BASE_URL='https://controllers.babylonjs.com/generic/',a.MODEL_FILENAME='generic.babylon',a.GAMEPAD_ID_PREFIX='Gear VR',a}(o.WebVRController);o.GearVRController=e}(e||(e={}));var e;!function(o){var e=function(e){function a(t){var a=e.call(this,t)||this;return a.controllerType=o.PoseEnabledControllerType.DAYDREAM,a}return h(a,e),a.prototype.initControllerMesh=function(e,t){var r=this;o.SceneLoader.ImportMesh('',a.MODEL_BASE_URL,a.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),t&&t(r._defaultModel)})},a.prototype._handleButtonChange=function(e,t){if(0===e){var r=this.onTriggerStateChangedObservable;r&&r.notifyObservers(t)}else o.Tools.Warn('Unrecognized Daydream button index: '+e)},a.MODEL_BASE_URL='https://controllers.babylonjs.com/generic/',a.MODEL_FILENAME='generic.babylon',a.GAMEPAD_ID_PREFIX='Daydream',a}(o.WebVRController);o.DaydreamController=e}(e||(e={}));var e;!function(p){var e=function(a){function e(t,e,s,r){void 0===r&&(r=null);var n=a.call(this,t,e,s)||this;return n.radius=12,n.rotationOffset=0,n.heightOffset=4,n.cameraAcceleration=.05,n.maxCameraSpeed=20,n.lockedTarget=r,n}return h(e,a),e.prototype.getRadians=function(t){return t*V/180},e.prototype.follow=function(e){if(e){var t;if(e.rotationQuaternion){var i=new p.Matrix;e.rotationQuaternion.toRotationMatrix(i),t=I(i.m[8],i.m[10])}else t=e.rotation.y;var r=this.getRadians(this.rotationOffset)+t,n=e.getAbsolutePosition(),o=n.x+B(r)*this.radius,s=n.z+F(r)*this.radius,a=o-this.position.x,l=n.y+this.heightOffset-this.position.y,_=s-this.position.z,c=2*(a*this.cameraAcceleration),u=l*this.cameraAcceleration,f=2*(_*this.cameraAcceleration);(c>this.maxCameraSpeed||c<-this.maxCameraSpeed)&&(c=1>c?-this.maxCameraSpeed:this.maxCameraSpeed),(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=1>u?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=1>f?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new p.Vector3(this.position.x+c,this.position.y+u,this.position.z+f),this.setTarget(n)}},e.prototype._checkInputs=function(){a.prototype._checkInputs.call(this),this.lockedTarget&&this.follow(this.lockedTarget)},e.prototype.getClassName=function(){return'FollowCamera'},g([p.serialize()],e.prototype,'radius',void 0),g([p.serialize()],e.prototype,'rotationOffset',void 0),g([p.serialize()],e.prototype,'heightOffset',void 0),g([p.serialize()],e.prototype,'cameraAcceleration',void 0),g([p.serialize()],e.prototype,'maxCameraSpeed',void 0),g([p.serializeAsMeshReference('lockedTargetId')],e.prototype,'lockedTarget',void 0),e}(p.TargetCamera);p.FollowCamera=e;var t=function(e){function t(t,d,r,n,o,s){var a=e.call(this,t,p.Vector3.Zero(),s)||this;return a.alpha=d,a.beta=r,a.radius=n,a.target=o,a._cartesianCoordinates=p.Vector3.Zero(),a.follow(),a}return h(t,e),t.prototype.follow=function(){if(this.target){this._cartesianCoordinates.x=this.radius*F(this.alpha)*F(this.beta),this._cartesianCoordinates.y=this.radius*B(this.beta),this._cartesianCoordinates.z=this.radius*B(this.alpha)*F(this.beta);var t=this.target.getAbsolutePosition();this.position=t.add(this._cartesianCoordinates),this.setTarget(t)}},t.prototype._checkInputs=function(){e.prototype._checkInputs.call(this),this.follow()},t.prototype.getClassName=function(){return'ArcFollowCamera'},t}(p.TargetCamera);p.ArcFollowCamera=t}(e||(e={}));var e;!function(r){var e=function(o){function e(e,a,i){var r=o.call(this,e,a,i)||this;return r.inputs.addGamepad(),r}return h(e,o),Object.defineProperty(e.prototype,'gamepadAngularSensibility',{get:function(){var t=this.inputs.attached.gamepad;return t?t.gamepadAngularSensibility:0},set:function(r){var e=this.inputs.attached.gamepad;e&&(e.gamepadAngularSensibility=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'gamepadMoveSensibility',{get:function(){var t=this.inputs.attached.gamepad;return t?t.gamepadMoveSensibility:0},set:function(r){var e=this.inputs.attached.gamepad;e&&(e.gamepadMoveSensibility=r)},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'UniversalCamera'},e}(r.TouchCamera);r.UniversalCamera=e}(e||(e={}));var e;!function(r){var e=function(o){function e(e,a,i){return o.call(this,e,a,i)||this}return h(e,o),Object.defineProperty(e.prototype,'gamepadAngularSensibility',{get:function(){var t=this.inputs.attached.gamepad;return t?t.gamepadAngularSensibility:0},set:function(r){var e=this.inputs.attached.gamepad;e&&(e.gamepadAngularSensibility=r)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'gamepadMoveSensibility',{get:function(){var t=this.inputs.attached.gamepad;return t?t.gamepadMoveSensibility:0},set:function(r){var e=this.inputs.attached.gamepad;e&&(e.gamepadMoveSensibility=r)},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'GamepadCamera'},e}(r.UniversalCamera);r.GamepadCamera=e}(e||(e={}));var e;!function(r){var e=function(){function t(){this._renderPipelines={}}return t.prototype.addPipeline=function(t){this._renderPipelines[t._name]=t},t.prototype.attachCamerasToRenderPipeline=function(o,e,t){void 0===t&&(t=!1);var i=this._renderPipelines[o];i&&i._attachCameras(e,t)},t.prototype.detachCamerasFromRenderPipeline=function(r,e){var t=this._renderPipelines[r];t&&t._detachCameras(e)},t.prototype.enableEffectInPipeline=function(o,e,t){var i=this._renderPipelines[o];i&&i._enableEffect(e,t)},t.prototype.disableEffectInPipeline=function(o,e,t){var i=this._renderPipelines[o];i&&i._disableEffect(e,t)},t.prototype.update=function(){for(var r in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(r)){var e=this._renderPipelines[r];e.isSupported?e._update():(e.dispose(),delete this._renderPipelines[r])}},t.prototype._rebuild=function(){for(var r in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(r)){var e=this._renderPipelines[r];e._rebuild()}},t.prototype.dispose=function(){for(var r in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(r)){var e=this._renderPipelines[r];e.dispose()}},t}();r.PostProcessRenderPipelineManager=e}(e||(e={}));var e;!function(d){var e=function(){function e(o,e,a,i){this._name=e,this._singleInstance=i||!0,this._getPostProcesses=a,this._cameras={},this._indicesForCamera={},this._postProcesses={}}return Object.defineProperty(e.prototype,'isSupported',{get:function(){for(var r in this._postProcesses)if(this._postProcesses.hasOwnProperty(r))for(var e=this._postProcesses[r],t=0;t<e.length;t++)if(!e[t].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype._update=function(){},e.prototype._attachCameras=function(e){var c=this,t=d.Tools.MakeArray(e||this._cameras),r;if(t)for(var i=0;i<t.length;i++){var o=t[i],n=o.name;if(r=this._singleInstance?0:n,!this._postProcesses[r]){var a=this._getPostProcesses();a&&(this._postProcesses[r]=Array.isArray(a)?a:[a])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[r].forEach(function(r){var e=o.attachPostProcess(r);c._indicesForCamera[n].push(e)}),this._cameras[n]||(this._cameras[n]=o)}},e.prototype._detachCameras=function(e){var t=d.Tools.MakeArray(e||this._cameras);if(t)for(var i=0;i<t.length;i++){var r=t[i],a=r.name;this._postProcesses[this._singleInstance?0:a].forEach(function(t){r.detachPostProcess(t)}),this._cameras[a]&&(this._cameras[a]=null)}},e.prototype._enable=function(e){var t=this,i=d.Tools.MakeArray(e||this._cameras);if(i)for(var r=0;r<i.length;r++)for(var n=i[r],o=n.name,s=0;s<this._indicesForCamera[o].length;s++)void 0!==n._postProcesses[this._indicesForCamera[o][s]]&&null!==n._postProcesses[this._indicesForCamera[o][s]]||this._postProcesses[this._singleInstance?0:o].forEach(function(a){i[r].attachPostProcess(a,t._indicesForCamera[o][s])})},e.prototype._disable=function(e){var t=d.Tools.MakeArray(e||this._cameras);if(t)for(var i=0;i<t.length;i++){var r=t[i],a=r.name;this._postProcesses[this._singleInstance?0:a].forEach(function(t){r.detachPostProcess(t)})}},e.prototype.getPostProcesses=function(t){return this._singleInstance?this._postProcesses[0]:t?this._postProcesses[t.name]:null},e}();d.PostProcessRenderEffect=e}(e||(e={}));var e;!function(d){var e=function(){function e(r,e){this.engine=r,this._name=e,this._renderEffects={},this._renderEffectsForIsolatedPass=[],this._cameras=[]}return e.prototype.getClassName=function(){return'PostProcessRenderPipeline'},Object.defineProperty(e.prototype,'isSupported',{get:function(){for(var t in this._renderEffects)if(this._renderEffects.hasOwnProperty(t)&&!this._renderEffects[t].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype.addEffect=function(t){this._renderEffects[t._name]=t},e.prototype._rebuild=function(){},e.prototype._enableEffect=function(e,t){var o=this._renderEffects[e];o&&o._enable(d.Tools.MakeArray(t||this._cameras))},e.prototype._disableEffect=function(e,t){var o=this._renderEffects[e];o&&o._disable(d.Tools.MakeArray(t||this._cameras))},e.prototype._attachCameras=function(e,t){var i=d.Tools.MakeArray(e||this._cameras);if(i){var r=[],o;for(o=0;o<i.length;o++){var n=i[o],s=n.name;-1===this._cameras.indexOf(n)?this._cameras[s]=n:t&&r.push(o)}for(o=0;o<r.length;o++)e.splice(r[o],1);for(var a in this._renderEffects)this._renderEffects.hasOwnProperty(a)&&this._renderEffects[a]._attachCameras(i)}},e.prototype._detachCameras=function(e){var t=d.Tools.MakeArray(e||this._cameras);if(t){for(var o in this._renderEffects)this._renderEffects.hasOwnProperty(o)&&this._renderEffects[o]._detachCameras(t);for(var r=0;r<t.length;r++)this._cameras.splice(this._cameras.indexOf(t[r]),1)}},e.prototype._update=function(){for(var r in this._renderEffects)this._renderEffects.hasOwnProperty(r)&&this._renderEffects[r]._update();for(var e=0,t;e<this._cameras.length;e++)t=this._cameras[e].name,this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()},e.prototype._reset=function(){this._renderEffects={},this._renderEffectsForIsolatedPass=[]},e.prototype._enableMSAAOnFirstPostProcess=function(r){var e=Object.keys(this._renderEffects);if(2<=this.engine.webGLVersion&&0<e.length){var t=this._renderEffects[e[0]].getPostProcesses();if(t)return t[0].samples=r,!0}return!1},e.prototype.dispose=function(){},g([d.serialize()],e.prototype,'_name',void 0),e}();d.PostProcessRenderPipeline=e}(e||(e={}));var e;!function(d){var e=function(){function e(e,a,i){void 0===a&&(a=d.Engine.TEXTURETYPE_FLOAT),void 0===i&&(i=null);var p=this;this._scene=e,this._camera=i;var l=e.getEngine();this._depthMap=new d.RenderTargetTexture('depthMap',{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,a),this._depthMap.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._depthMap.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(e){e.clear(new d.Color4(1,1,1,1),!0,!0,!0)});var o=function(e){var t=e.getRenderingMesh(),i=p._scene,r=i.getEngine(),o=e.getMaterial();if(o){r.setState(o.backFaceCulling,0,!1,i.useRightHandedSystem);var n=t._getInstancesRenderList(e._id);if(!n.mustReturn){var a=r.getCaps().instancedArrays&&null!==n.visibleInstances[e._id],s=p._camera||i.activeCamera;if(p.isReady(e,a)&&s){if(r.enableEffect(p._effect),t._bind(e,p._effect,d.Material.TriangleFillMode),p._effect.setMatrix('viewProjection',i.getTransformMatrix()),p._effect.setFloat2('depthValues',s.minZ,s.minZ+s.maxZ),o&&o.needAlphaTesting()){var l=o.getAlphaTestTexture();l&&(p._effect.setTexture('diffuseSampler',l),p._effect.setMatrix('diffuseMatrix',l.getTextureMatrix()))}t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&p._effect.setMatrices('mBones',t.skeleton.getTransformMatrices(t)),t._processRendering(e,p._effect,d.Material.TriangleFillMode,n,a,function(r,e){return p._effect.setMatrix('world',e)})}}}};this._depthMap.customRenderFunction=function(a,e,t,i){var r;if(i.length){for(l.setColorWrite(!1),r=0;r<i.length;r++)o(i.data[r]);l.setColorWrite(!0)}for(r=0;r<a.length;r++)o(a.data[r]);for(r=0;r<e.length;r++)o(e.data[r])}}return e.prototype.isReady=function(e,t){var i=e.getMaterial();if(i.disableDepthWrite)return!1;var r=[],n=[d.VertexBuffer.PositionKind],o=e.getMesh();i&&i.needAlphaTesting()&&i.getAlphaTestTexture()&&(r.push('#define ALPHATEST'),o.isVerticesDataPresent(d.VertexBuffer.UVKind)&&(n.push(d.VertexBuffer.UVKind),r.push('#define UV1')),o.isVerticesDataPresent(d.VertexBuffer.UV2Kind)&&(n.push(d.VertexBuffer.UV2Kind),r.push('#define UV2'))),o.useBones&&o.computeBonesUsingShaders?(n.push(d.VertexBuffer.MatricesIndicesKind),n.push(d.VertexBuffer.MatricesWeightsKind),4<o.numBoneInfluencers&&(n.push(d.VertexBuffer.MatricesIndicesExtraKind),n.push(d.VertexBuffer.MatricesWeightsExtraKind)),r.push('#define NUM_BONE_INFLUENCERS '+o.numBoneInfluencers),r.push('#define BonesPerMesh '+(o.skeleton?o.skeleton.bones.length+1:0))):r.push('#define NUM_BONE_INFLUENCERS 0'),t&&(r.push('#define INSTANCES'),n.push('world0'),n.push('world1'),n.push('world2'),n.push('world3'));var s=r.join('\n');return this._cachedDefines!==s&&(this._cachedDefines=s,this._effect=this._scene.getEngine().createEffect('depth',n,['world','mBones','viewProjection','diffuseMatrix','depthValues'],['diffuseSampler'],s)),this._effect.isReady()},e.prototype.getDepthMap=function(){return this._depthMap},e.prototype.dispose=function(){this._depthMap.dispose()},e}();d.DepthRenderer=e}(e||(e={}));var e;!function(d){var e=function(c){function e(e,t,r,n){var o=c.call(this,t.getEngine(),e)||this;o.SSAOOriginalSceneColorEffect='SSAOOriginalSceneColorEffect',o.SSAORenderEffect='SSAORenderEffect',o.SSAOBlurHRenderEffect='SSAOBlurHRenderEffect',o.SSAOBlurVRenderEffect='SSAOBlurVRenderEffect',o.SSAOCombineRenderEffect='SSAOCombineRenderEffect',o.totalStrength=1,o.radius=1e-4,o.area=.0075,o.fallOff=1e-6,o.base=.5,o._firstUpdate=!0,o._scene=t,o._createRandomTexture(),o._depthTexture=t.enableDepthRenderer().getDepthMap();var s=r.ssaoRatio||r,a=r.combineRatio||r;return o._originalColorPostProcess=new d.PassPostProcess('SSAOOriginalSceneColor',a,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),o._createSSAOPostProcess(s),o._createBlurPostProcess(s),o._createSSAOCombinePostProcess(a),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),t.postProcessRenderPipelineManager.addPipeline(o),n&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,n),o}return h(e,c),e.prototype.dispose=function(t){void 0===t&&(t=!1);for(var e=0,o;e<this._scene.cameras.length;e++)o=this._scene.cameras[e],this._originalColorPostProcess.dispose(o),this._ssaoPostProcess.dispose(o),this._blurHPostProcess.dispose(o),this._blurVPostProcess.dispose(o),this._ssaoCombinePostProcess.dispose(o);this._randomTexture.dispose(),t&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),c.prototype.dispose.call(this)},e.prototype._createBlurPostProcess=function(e){var t=this;this._blurHPostProcess=new d.BlurPostProcess('BlurH',new d.Vector2(1,0),16,e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d.Engine.TEXTURETYPE_UNSIGNED_INT),this._blurVPostProcess=new d.BlurPostProcess('BlurV',new d.Vector2(0,1),16,e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d.Engine.TEXTURETYPE_UNSIGNED_INT),this._blurHPostProcess.onActivateObservable.add(function(){var r=t._blurHPostProcess.width/t._scene.getEngine().getRenderWidth();t._blurHPostProcess.kernel=16*r}),this._blurVPostProcess.onActivateObservable.add(function(){var r=t._blurVPostProcess.height/t._scene.getEngine().getRenderHeight();t._blurVPostProcess.kernel=16*r})},e.prototype._rebuild=function(){this._firstUpdate=!0,c.prototype._rebuild.call(this)},e.prototype._createSSAOPostProcess=function(e){var t=this,o=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new d.PostProcess('ssao','ssao',['sampleSphere','samplesFactor','randTextureTiles','totalStrength','radius','area','fallOff','base','range','viewport'],['randomSampler'],e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,'#define SAMPLES 16\n#define SSAO'),this._ssaoPostProcess.onApply=function(r){t._firstUpdate&&(r.setArray3('sampleSphere',o),r.setFloat('samplesFactor',1/16),r.setFloat('randTextureTiles',4)),r.setFloat('totalStrength',t.totalStrength),r.setFloat('radius',t.radius),r.setFloat('area',t.area),r.setFloat('fallOff',t.fallOff),r.setFloat('base',t.base),r.setTexture('textureSampler',t._depthTexture),r.setTexture('randomSampler',t._randomTexture)}},e.prototype._createSSAOCombinePostProcess=function(e){var t=this;this._ssaoCombinePostProcess=new d.PostProcess('ssaoCombine','ssaoCombine',[],['originalColor'],e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(r){r.setTextureFromPostProcess('originalColor',t._originalColorPostProcess)}},e.prototype._createRandomTexture=function(){this._randomTexture=new d.DynamicTexture('SSAORandomTexture',512,this._scene,!1,d.Texture.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=d.Texture.WRAP_ADDRESSMODE,this._randomTexture.wrapV=d.Texture.WRAP_ADDRESSMODE;for(var e=this._randomTexture.getContext(),t=function(r,e){return Math.random()*(e-r)+r},i=d.Vector3.Zero(),r=0;512>r;r++)for(var a=0;512>a;a++)i.x=ee(255*t(-1,1)),i.y=ee(255*t(-1,1)),i.z=ee(255*t(-1,1)),e.fillStyle='rgb('+i.x+', '+i.y+', '+i.z+')',e.fillRect(r,a,1,1);this._randomTexture.update(!1)},g([d.serialize()],e.prototype,'totalStrength',void 0),g([d.serialize()],e.prototype,'radius',void 0),g([d.serialize()],e.prototype,'area',void 0),g([d.serialize()],e.prototype,'fallOff',void 0),g([d.serialize()],e.prototype,'base',void 0),e}(d.PostProcessRenderPipeline);d.SSAORenderingPipeline=e}(e||(e={}));var e;!function(d){var e=function(c){function e(e,t,r,n){var o=c.call(this,t.getEngine(),e)||this;if(o.SSAOOriginalSceneColorEffect='SSAOOriginalSceneColorEffect',o.SSAORenderEffect='SSAORenderEffect',o.SSAOBlurHRenderEffect='SSAOBlurHRenderEffect',o.SSAOBlurVRenderEffect='SSAOBlurVRenderEffect',o.SSAOCombineRenderEffect='SSAOCombineRenderEffect',o.totalStrength=1,o.maxZ=100,o.minZAspect=.2,o._samples=8,o._expensiveBlur=!0,o.radius=2,o.base=.1,o._firstUpdate=!0,o._scene=t,o._ratio=r,!o.isSupported)return d.Tools.Error('SSAO 2 needs WebGL 2 support.'),o;var s=o._ratio.ssaoRatio||r,a=o._ratio.blurRatio||r,l=t.enableGeometryBufferRenderer();return o._createRandomTexture(),o._depthTexture=l.getGBuffer().textures[0],o._normalTexture=l.getGBuffer().textures[1],o._originalColorPostProcess=new d.PassPostProcess('SSAOOriginalSceneColor',1,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),o._createSSAOPostProcess(1),o._createBlurPostProcess(s,a),o._createSSAOCombinePostProcess(a),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),o.addEffect(new d.PostProcessRenderEffect(t.getEngine(),o.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),t.postProcessRenderPipelineManager.addPipeline(o),n&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,n),o}return h(e,c),Object.defineProperty(e.prototype,'samples',{get:function(){return this._samples},set:function(t){this._ssaoPostProcess.updateEffect('#define SAMPLES '+t+'\n#define SSAO'),this._samples=t,this._sampleSphere=this._generateHemisphere(),this._firstUpdate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'expensiveBlur',{get:function(){return this._expensiveBlur},set:function(t){this._blurHPostProcess.updateEffect('#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE '+(t?'1':'0')+'\n',null,['textureSampler','depthSampler']),this._blurVPostProcess.updateEffect('#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE '+(t?'1':'0')+'\n',null,['textureSampler','depthSampler']),this._expensiveBlur=t,this._firstUpdate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e,'IsSupported',{get:function(){var e=d.Engine.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension},enumerable:!0,configurable:!0}),e.prototype.dispose=function(t){void 0===t&&(t=!1);for(var e=0,o;e<this._scene.cameras.length;e++)o=this._scene.cameras[e],this._originalColorPostProcess.dispose(o),this._ssaoPostProcess.dispose(o),this._blurHPostProcess.dispose(o),this._blurVPostProcess.dispose(o),this._ssaoCombinePostProcess.dispose(o);this._randomTexture.dispose(),t&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),c.prototype.dispose.call(this)},e.prototype._createBlurPostProcess=function(e,t){var i=this;this._samplerOffsets=[];for(var r=this.expensiveBlur,a=-8;8>a;a++)this._samplerOffsets.push(2*a+.5);this._blurHPostProcess=new d.PostProcess('BlurH','ssao2',['outSize','samplerOffsets','near','far','radius'],['depthSampler'],e,null,d.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,'#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE '+(r?'1':'0')+'\n'),this._blurHPostProcess.onApply=function(t){i._scene.activeCamera&&(t.setFloat('outSize',0<i._ssaoCombinePostProcess.width?i._ssaoCombinePostProcess.width:i._originalColorPostProcess.width),t.setFloat('near',i._scene.activeCamera.minZ),t.setFloat('far',i._scene.activeCamera.maxZ),t.setFloat('radius',i.radius),t.setTexture('depthSampler',i._depthTexture),i._firstUpdate&&t.setArray('samplerOffsets',i._samplerOffsets))},this._blurVPostProcess=new d.PostProcess('BlurV','ssao2',['outSize','samplerOffsets','near','far','radius'],['depthSampler'],t,null,d.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,'#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE '+(r?'1':'0')+'\n'),this._blurVPostProcess.onApply=function(t){i._scene.activeCamera&&(t.setFloat('outSize',0<i._ssaoCombinePostProcess.height?i._ssaoCombinePostProcess.height:i._originalColorPostProcess.height),t.setFloat('near',i._scene.activeCamera.minZ),t.setFloat('far',i._scene.activeCamera.maxZ),t.setFloat('radius',i.radius),t.setTexture('depthSampler',i._depthTexture),i._firstUpdate&&(t.setArray('samplerOffsets',i._samplerOffsets),i._firstUpdate=!1))}},e.prototype._rebuild=function(){this._firstUpdate=!0,c.prototype._rebuild.call(this)},e.prototype._generateHemisphere=function(){for(var e=this.samples,r=[],a=function(r,e){return Math.random()*(e-r)+r},o=0,n,t;o<e;)n=new d.Vector3(a(-1,1),a(-1,1),a(.3,1)),n.normalize(),t=o/e,t=d.Scalar.Lerp(.1,1,t*t),n.scaleInPlace(t),r.push(n.x,n.y,n.z),o++;return r},e.prototype._createSSAOPostProcess=function(e){var t=this,o=this.samples;this._sampleSphere=this._generateHemisphere(),this._ssaoPostProcess=new d.PostProcess('ssao2','ssao2',['sampleSphere','samplesFactor','randTextureTiles','totalStrength','radius','base','range','projection','near','far','texelSize','xViewport','yViewport','maxZ','minZAspect'],['randomSampler','normalSampler'],e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,'#define SAMPLES '+o+'\n#define SSAO'),this._ssaoPostProcess.onApply=function(r){t._firstUpdate&&(r.setArray3('sampleSphere',t._sampleSphere),r.setFloat('randTextureTiles',4)),t._scene.activeCamera&&(r.setFloat('samplesFactor',1/t.samples),r.setFloat('totalStrength',t.totalStrength),r.setFloat2('texelSize',1/t._ssaoPostProcess.width,1/t._ssaoPostProcess.height),r.setFloat('radius',t.radius),r.setFloat('maxZ',t.maxZ),r.setFloat('minZAspect',t.minZAspect),r.setFloat('base',t.base),r.setFloat('near',t._scene.activeCamera.minZ),r.setFloat('far',t._scene.activeCamera.maxZ),r.setFloat('xViewport',y(t._scene.activeCamera.fov/2)*t._scene.getEngine().getAspectRatio(t._scene.activeCamera,!0)),r.setFloat('yViewport',y(t._scene.activeCamera.fov/2)),r.setMatrix('projection',t._scene.getProjectionMatrix()),r.setTexture('textureSampler',t._depthTexture),r.setTexture('normalSampler',t._normalTexture),r.setTexture('randomSampler',t._randomTexture))}},e.prototype._createSSAOCombinePostProcess=function(e){var t=this;this._ssaoCombinePostProcess=new d.PostProcess('ssaoCombine','ssaoCombine',[],['originalColor'],e,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(r){r.setTextureFromPostProcess('originalColor',t._originalColorPostProcess)}},e.prototype._createRandomTexture=function(){this._randomTexture=new d.DynamicTexture('SSAORandomTexture',512,this._scene,!1,d.Texture.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=d.Texture.WRAP_ADDRESSMODE,this._randomTexture.wrapV=d.Texture.WRAP_ADDRESSMODE;for(var e=this._randomTexture.getContext(),t=function(r,e){return Math.random()*(e-r)+r},i=d.Vector3.Zero(),r=0;512>r;r++)for(var a=0;512>a;a++)i.x=t(0,1),i.y=t(0,1),i.z=0,i.normalize(),i.scaleInPlace(255),i.x=ee(i.x),i.y=ee(i.y),e.fillStyle='rgb('+i.x+', '+i.y+', '+i.z+')',e.fillRect(r,a,1,1);this._randomTexture.update(!1)},e.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);return e.customType='SSAO2RenderingPipeline',e},e.Parse=function(o,t,r){return d.SerializationHelper.Parse(function(){return new e(o._name,t,o._ratio)},o,t,r)},g([d.serialize()],e.prototype,'totalStrength',void 0),g([d.serialize()],e.prototype,'maxZ',void 0),g([d.serialize()],e.prototype,'minZAspect',void 0),g([d.serialize('samples')],e.prototype,'_samples',void 0),g([d.serialize()],e.prototype,'_ratio',void 0),g([d.serialize('expensiveBlur')],e.prototype,'_expensiveBlur',void 0),g([d.serialize()],e.prototype,'radius',void 0),g([d.serialize()],e.prototype,'base',void 0),e}(d.PostProcessRenderPipeline);d.SSAO2RenderingPipeline=e}(e||(e={}));var e;!function(l){var e=function(e){function t(t,d,r,n,o){void 0===n&&(n=1);var s=e.call(this,r.getEngine(),t)||this;return s.LensChromaticAberrationEffect='LensChromaticAberrationEffect',s.HighlightsEnhancingEffect='HighlightsEnhancingEffect',s.LensDepthOfFieldEffect='LensDepthOfFieldEffect',s._scene=r,s._depthTexture=r.enableDepthRenderer().getDepthMap(),d.grain_texture?s._grainTexture=d.grain_texture:s._createGrainTexture(),s._edgeBlur=d.edge_blur?d.edge_blur:0,s._grainAmount=d.grain_amount?d.grain_amount:0,s._chromaticAberration=d.chromatic_aberration?d.chromatic_aberration:0,s._distortion=d.distortion?d.distortion:0,s._highlightsGain=void 0===d.dof_gain?-1:d.dof_gain,s._highlightsThreshold=d.dof_threshold?d.dof_threshold:1,s._dofDistance=void 0===d.dof_focus_distance?-1:d.dof_focus_distance,s._dofAperture=d.dof_aperture?d.dof_aperture:1,s._dofDarken=d.dof_darken?d.dof_darken:0,s._dofPentagon=void 0===d.dof_pentagon||d.dof_pentagon,s._blurNoise=void 0===d.blur_noise||d.blur_noise,s._createChromaticAberrationPostProcess(n),s._createHighlightsPostProcess(n),s._createDepthOfFieldPostProcess(n/4),s.addEffect(new l.PostProcessRenderEffect(r.getEngine(),s.LensChromaticAberrationEffect,function(){return s._chromaticAberrationPostProcess},!0)),s.addEffect(new l.PostProcessRenderEffect(r.getEngine(),s.HighlightsEnhancingEffect,function(){return s._highlightsPostProcess},!0)),s.addEffect(new l.PostProcessRenderEffect(r.getEngine(),s.LensDepthOfFieldEffect,function(){return s._depthOfFieldPostProcess},!0)),-1===s._highlightsGain&&s._disableEffect(s.HighlightsEnhancingEffect,null),r.postProcessRenderPipelineManager.addPipeline(s),o&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,o),s}return h(t,e),t.prototype.setEdgeBlur=function(t){this._edgeBlur=t},t.prototype.disableEdgeBlur=function(){this._edgeBlur=0},t.prototype.setGrainAmount=function(t){this._grainAmount=t},t.prototype.disableGrain=function(){this._grainAmount=0},t.prototype.setChromaticAberration=function(t){this._chromaticAberration=t},t.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},t.prototype.setEdgeDistortion=function(t){this._distortion=t},t.prototype.disableEdgeDistortion=function(){this._distortion=0},t.prototype.setFocusDistance=function(t){this._dofDistance=t},t.prototype.disableDepthOfField=function(){this._dofDistance=-1},t.prototype.setAperture=function(t){this._dofAperture=t},t.prototype.setDarkenOutOfFocus=function(t){this._dofDarken=t},t.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect('#define PENTAGON\n')},t.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()},t.prototype.enableNoiseBlur=function(){this._blurNoise=!0},t.prototype.disableNoiseBlur=function(){this._blurNoise=!1},t.prototype.setHighlightsGain=function(t){this._highlightsGain=t},t.prototype.setHighlightsThreshold=function(t){-1===this._highlightsGain&&(this._highlightsGain=1),this._highlightsThreshold=t},t.prototype.disableHighlights=function(){this._highlightsGain=-1},t.prototype.dispose=function(t){void 0===t&&(t=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),t&&this._scene.disableDepthRenderer()},t.prototype._createChromaticAberrationPostProcess=function(e){var t=this;this._chromaticAberrationPostProcess=new l.PostProcess('LensChromaticAberration','chromaticAberration',['chromatic_aberration','screen_width','screen_height','direction','radialIntensity','centerPosition'],[],e,null,l.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(r){r.setFloat('chromatic_aberration',t._chromaticAberration),r.setFloat('screen_width',t._scene.getEngine().getRenderWidth()),r.setFloat('screen_height',t._scene.getEngine().getRenderHeight()),r.setFloat('radialIntensity',1),r.setFloat2('direction',17,17),r.setFloat2('centerPosition',.5,.5)}},t.prototype._createHighlightsPostProcess=function(e){var t=this;this._highlightsPostProcess=new l.PostProcess('LensHighlights','lensHighlights',['gain','threshold','screen_width','screen_height'],[],e,null,l.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?'#define PENTAGON\n':''),this._highlightsPostProcess.onApply=function(r){r.setFloat('gain',t._highlightsGain),r.setFloat('threshold',t._highlightsThreshold),r.setTextureFromPostProcess('textureSampler',t._chromaticAberrationPostProcess),r.setFloat('screen_width',t._scene.getEngine().getRenderWidth()),r.setFloat('screen_height',t._scene.getEngine().getRenderHeight())}},t.prototype._createDepthOfFieldPostProcess=function(e){var t=this;this._depthOfFieldPostProcess=new l.PostProcess('LensDepthOfField','depthOfField',['grain_amount','blur_noise','screen_width','screen_height','distortion','dof_enabled','screen_distance','aperture','darken','edge_blur','highlights','near','far'],['depthSampler','grainSampler','highlightsSampler'],e,null,l.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.onApply=function(r){r.setTexture('depthSampler',t._depthTexture),r.setTexture('grainSampler',t._grainTexture),r.setTextureFromPostProcess('textureSampler',t._highlightsPostProcess),r.setTextureFromPostProcess('highlightsSampler',t._depthOfFieldPostProcess),r.setFloat('grain_amount',t._grainAmount),r.setBool('blur_noise',t._blurNoise),r.setFloat('screen_width',t._scene.getEngine().getRenderWidth()),r.setFloat('screen_height',t._scene.getEngine().getRenderHeight()),r.setFloat('distortion',t._distortion),r.setBool('dof_enabled',-1!==t._dofDistance),r.setFloat('screen_distance',1/(.1-1/t._dofDistance)),r.setFloat('aperture',t._dofAperture),r.setFloat('darken',t._dofDarken),r.setFloat('edge_blur',t._edgeBlur),r.setBool('highlights',-1!==t._highlightsGain),t._scene.activeCamera&&(r.setFloat('near',t._scene.activeCamera.minZ),r.setFloat('far',t._scene.activeCamera.maxZ))}},t.prototype._createGrainTexture=function(){this._grainTexture=new l.DynamicTexture('LensNoiseTexture',512,this._scene,!1,l.Texture.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=l.Texture.WRAP_ADDRESSMODE,this._grainTexture.wrapV=l.Texture.WRAP_ADDRESSMODE;for(var e=this._grainTexture.getContext(),o=0,r;512>o;o++)for(var t=0;512>t;t++)r=ee(255*function(r,e){return Math.random()*(e-r)+r}(.42,.58)),e.fillStyle='rgb('+r+', '+r+', '+r+')',e.fillRect(o,t,1,1);this._grainTexture.update(!1)},t}(l.PostProcessRenderPipeline);l.LensRenderingPipeline=e}(e||(e={}));var e;!function(d){var e=function(e){function p(t,l,r,n,o){void 0===n&&(n=null);var s=e.call(this,l.getEngine(),t)||this;return s.downSampleX4PostProcess=null,s.brightPassPostProcess=null,s.blurHPostProcesses=[],s.blurVPostProcesses=[],s.textureAdderPostProcess=null,s.volumetricLightPostProcess=null,s.volumetricLightSmoothXPostProcess=null,s.volumetricLightSmoothYPostProcess=null,s.volumetricLightMergePostProces=null,s.volumetricLightFinalPostProcess=null,s.luminancePostProcess=null,s.luminanceDownSamplePostProcesses=[],s.hdrPostProcess=null,s.textureAdderFinalPostProcess=null,s.lensFlareFinalPostProcess=null,s.hdrFinalPostProcess=null,s.lensFlarePostProcess=null,s.lensFlareComposePostProcess=null,s.motionBlurPostProcess=null,s.depthOfFieldPostProcess=null,s.brightThreshold=1,s.blurWidth=512,s.horizontalBlur=!1,s.exposure=1,s.lensTexture=null,s.volumetricLightCoefficient=.2,s.volumetricLightPower=4,s.volumetricLightBlurScale=64,s.sourceLight=null,s.hdrMinimumLuminance=1,s.hdrDecreaseRate=.5,s.hdrIncreaseRate=.5,s.lensColorTexture=null,s.lensFlareStrength=20,s.lensFlareGhostDispersal=1.4,s.lensFlareHaloWidth=.7,s.lensFlareDistortionStrength=16,s.lensStarTexture=null,s.lensFlareDirtTexture=null,s.depthOfFieldDistance=10,s.depthOfFieldBlurWidth=64,s.motionStrength=1,s.animations=[],s._currentDepthOfFieldSource=null,s._hdrCurrentLuminance=1,s._bloomEnabled=!0,s._depthOfFieldEnabled=!1,s._vlsEnabled=!1,s._lensFlareEnabled=!1,s._hdrEnabled=!1,s._motionBlurEnabled=!1,s._motionBlurSamples=64,s._volumetricLightStepsCount=50,s._cameras=o||[],s._scene=l,s._basePostProcess=n,s._ratio=r,s._floatTextureType=l.getEngine().getCaps().textureFloatRender?d.Engine.TEXTURETYPE_FLOAT:d.Engine.TEXTURETYPE_HALF_FLOAT,l.postProcessRenderPipelineManager.addPipeline(s),s._buildPipeline(),s}return h(p,e),Object.defineProperty(p.prototype,'BloomEnabled',{get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled!==t&&(this._bloomEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'DepthOfFieldEnabled',{get:function(){return this._depthOfFieldEnabled},set:function(t){this._depthOfFieldEnabled!==t&&(this._depthOfFieldEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'LensFlareEnabled',{get:function(){return this._lensFlareEnabled},set:function(t){this._lensFlareEnabled!==t&&(this._lensFlareEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'HDREnabled',{get:function(){return this._hdrEnabled},set:function(t){this._hdrEnabled!==t&&(this._hdrEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'VLSEnabled',{get:function(){return this._vlsEnabled},set:function(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void d.Tools.Warn('Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline');this._vlsEnabled=e,this._buildPipeline()}},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'MotionBlurEnabled',{get:function(){return this._motionBlurEnabled},set:function(t){this._motionBlurEnabled!==t&&(this._motionBlurEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'volumetricLightStepsCount',{get:function(){return this._volumetricLightStepsCount},set:function(t){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect('#define VLS\n#define NB_STEPS '+t.toFixed(1)),this._volumetricLightStepsCount=t},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'motionBlurSamples',{get:function(){return this._motionBlurSamples},set:function(t){this.motionBlurPostProcess&&this.motionBlurPostProcess.updateEffect('#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES '+t.toFixed(1)),this._motionBlurSamples=t},enumerable:!0,configurable:!0}),p.prototype._buildPipeline=function(){var e=this,t=this._ratio,o=this._scene;this._disposePostProcesses(),this._reset(),this._basePostProcess?this.originalPostProcess=this._basePostProcess:(this.originalPostProcess=new d.PostProcess('HDRPass','standard',[],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,o.getEngine(),!1,'#define PASS_POST_PROCESS',this._floatTextureType),this.originalPostProcess.onApply=function(){e._currentDepthOfFieldSource=e.originalPostProcess}),this.addEffect(new d.PostProcessRenderEffect(o.getEngine(),'HDRPassPostProcess',function(){return e.originalPostProcess},!0)),this._currentDepthOfFieldSource=this.originalPostProcess,this._bloomEnabled&&(this._createDownSampleX4PostProcess(o,t/2),this._createBrightPassPostProcess(o,t/2),this._createBlurPostProcesses(o,t/4,1),this._createTextureAdderPostProcess(o,t),this.textureAdderFinalPostProcess=new d.PostProcess('HDRDepthOfFieldSource','standard',[],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,o.getEngine(),!1,'#define PASS_POST_PROCESS',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(o.getEngine(),'HDRBaseDepthOfFieldSource',function(){return e.textureAdderFinalPostProcess},!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(o,t),this.volumetricLightFinalPostProcess=new d.PostProcess('HDRVLSFinal','standard',[],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,o.getEngine(),!1,'#define PASS_POST_PROCESS',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(o.getEngine(),'HDRVLSFinal',function(){return e.volumetricLightFinalPostProcess},!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(o,t),this.lensFlareFinalPostProcess=new d.PostProcess('HDRPostLensFlareDepthOfFieldSource','standard',[],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,o.getEngine(),!1,'#define PASS_POST_PROCESS',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(o.getEngine(),'HDRPostLensFlareDepthOfFieldSource',function(){return e.lensFlareFinalPostProcess},!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(o,this._floatTextureType),this._createHdrPostProcess(o,t),this.hdrFinalPostProcess=new d.PostProcess('HDRPostHDReDepthOfFieldSource','standard',[],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,o.getEngine(),!1,'#define PASS_POST_PROCESS',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(o.getEngine(),'HDRPostHDReDepthOfFieldSource',function(){return e.hdrFinalPostProcess},!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(o,t/2,3,'depthOfFieldBlurWidth'),this._createDepthOfFieldPostProcess(o,t)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(o,t),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)},p.prototype._createDownSampleX4PostProcess=function(e,t){var l=this,r=Array(32);this.downSampleX4PostProcess=new d.PostProcess('HDRDownSampleX4','standard',['dsOffsets'],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define DOWN_SAMPLE_X4',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.downSampleX4PostProcess.onApply=function(n){for(var e=0,t=l.downSampleX4PostProcess.width,i=l.downSampleX4PostProcess.height,o=-2;2>o;o++)for(var s=-2;2>s;s++)r[e]=(o+.5)*(1/t),r[e+1]=(s+.5)*(1/i),e+=2;n.setArray2('dsOffsets',r)},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRDownSampleX4',function(){return l.downSampleX4PostProcess},!0))},p.prototype._createBrightPassPostProcess=function(e,t){var o=this,r=Array(8);this.brightPassPostProcess=new d.PostProcess('HDRBrightPass','standard',['dsOffsets','brightThreshold'],[],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define BRIGHT_PASS',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.brightPassPostProcess.onApply=function(a){var e=1/o.brightPassPostProcess.width,t=1/o.brightPassPostProcess.height;r[0]=-.5*e,r[1]=.5*t,r[2]=.5*e,r[3]=.5*t,r[4]=-.5*e,r[5]=-.5*t,r[6]=.5*e,r[7]=-.5*t,a.setArray2('dsOffsets',r),a.setFloat('brightThreshold',o.brightThreshold)},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRBrightPass',function(){return o.brightPassPostProcess},!0))},p.prototype._createBlurPostProcesses=function(e,t,i,r){var n=this;void 0===r&&(r='blurWidth');var o=e.getEngine(),s=new d.BlurPostProcess('HDRBlurH_'+i,new d.Vector2(1,0),this[r],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,d.Engine.TEXTURETYPE_UNSIGNED_INT),a=new d.BlurPostProcess('HDRBlurV_'+i,new d.Vector2(0,1),this[r],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,d.Engine.TEXTURETYPE_UNSIGNED_INT);s.onActivateObservable.add(function(){var t=s.width/o.getRenderWidth();s.kernel=n[r]*t}),a.onActivateObservable.add(function(){var t=a.height/o.getRenderHeight();a.kernel=n.horizontalBlur?64*t:n[r]*t}),this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRBlurH'+i,function(){return s},!0)),this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRBlurV'+i,function(){return a},!0)),this.blurHPostProcesses.push(s),this.blurVPostProcesses.push(a)},p.prototype._createTextureAdderPostProcess=function(e,t){var o=this;this.textureAdderPostProcess=new d.PostProcess('HDRTextureAdder','standard',['exposure'],['otherSampler','lensSampler'],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define TEXTURE_ADDER',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.textureAdderPostProcess.onApply=function(t){t.setTextureFromPostProcess('otherSampler',o._vlsEnabled?o._currentDepthOfFieldSource:o.originalPostProcess),t.setTexture('lensSampler',o.lensTexture),t.setFloat('exposure',o.exposure),o._currentDepthOfFieldSource=o.textureAdderFinalPostProcess},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRTextureAdder',function(){return o.textureAdderPostProcess},!0))},p.prototype._createVolumetricLightPostProcess=function(e,t){var i=this,r=e.enableGeometryBufferRenderer();r.enablePosition=!0;var a=r.getGBuffer();this.volumetricLightPostProcess=new d.PostProcess('HDRVLS','standard',['shadowViewProjection','cameraPosition','sunDirection','sunColor','scatteringCoefficient','scatteringPower','depthValues'],['shadowMapSampler','positionSampler'],t/8,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define VLS\n#define NB_STEPS '+this._volumetricLightStepsCount.toFixed(1));var o=d.Vector2.Zero();this.volumetricLightPostProcess.onApply=function(r){if(i.sourceLight&&i.sourceLight.getShadowGenerator()&&i._scene.activeCamera){var e=i.sourceLight.getShadowGenerator();r.setTexture('shadowMapSampler',e.getShadowMap()),r.setTexture('positionSampler',a.textures[2]),r.setColor3('sunColor',i.sourceLight.diffuse),r.setVector3('sunDirection',i.sourceLight.getShadowDirection()),r.setVector3('cameraPosition',i._scene.activeCamera.globalPosition),r.setMatrix('shadowViewProjection',e.getTransformMatrix()),r.setFloat('scatteringCoefficient',i.volumetricLightCoefficient),r.setFloat('scatteringPower',i.volumetricLightPower),o.x=e.getLight().getDepthMinZ(i._scene.activeCamera),o.y=e.getLight().getDepthMaxZ(i._scene.activeCamera),r.setVector2('depthValues',o)}},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRVLS',function(){return i.volumetricLightPostProcess},!0)),this._createBlurPostProcesses(e,t/4,0,'volumetricLightBlurScale'),this.volumetricLightMergePostProces=new d.PostProcess('HDRVLSMerge','standard',[],['originalSampler'],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define VLSMERGE'),this.volumetricLightMergePostProces.onApply=function(t){t.setTextureFromPostProcess('originalSampler',i._bloomEnabled?i.textureAdderFinalPostProcess:i.originalPostProcess),i._currentDepthOfFieldSource=i.volumetricLightFinalPostProcess},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRVLSMerge',function(){return i.volumetricLightMergePostProces},!0))},p.prototype._createLuminancePostProcesses=function(e,t){var u=this,r=x(3,p.LuminanceSteps);this.luminancePostProcess=new d.PostProcess('HDRLuminance','standard',['lumOffsets'],[],{width:r,height:r},null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define LUMINANCE',t);var n=[];this.luminancePostProcess.onApply=function(r){var e=1/u.luminancePostProcess.width,t=1/u.luminancePostProcess.height;n[0]=-.5*e,n[1]=.5*t,n[2]=.5*e,n[3]=.5*t,n[4]=-.5*e,n[5]=-.5*t,n[6]=.5*e,n[7]=-.5*t,r.setArray2('lumOffsets',n)},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRLuminance',function(){return u.luminancePostProcess},!0));for(var i=p.LuminanceSteps-1;0<=i;i--){var r=x(3,i),a='#define LUMINANCE_DOWN_SAMPLE\n';0===i&&(a+='#define FINAL_DOWN_SAMPLER');var s=new d.PostProcess('HDRLuminanceDownSample'+i,'standard',['dsOffsets','halfDestPixelSize'],[],{width:r,height:r},null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,t);this.luminanceDownSamplePostProcesses.push(s)}var l=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(n,i){var r=Array(18);n.onApply=function(o){if(l){for(var e=0,t=-1;2>t;t++)for(var s=-1;2>s;s++)r[e]=t/l.width,r[e+1]=s/l.height,e+=2;o.setArray2('dsOffsets',r),o.setFloat('halfDestPixelSize',.5/l.width),l=i===u.luminanceDownSamplePostProcesses.length-1?u.luminancePostProcess:n}},i===u.luminanceDownSamplePostProcesses.length-1&&(n.onAfterRender=function(){var t=e.getEngine().readPixels(0,0,1,1),r=new d.Vector4(1/16581375,1/65025,1/255,1);u._hdrCurrentLuminance=(t[0]*r.x+t[1]*r.y+t[2]*r.z+t[3]*r.w)/100}),u.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRLuminanceDownSample'+i,function(){return n},!0))})},p.prototype._createHdrPostProcess=function(e,t){var l=this;this.hdrPostProcess=new d.PostProcess('HDR','standard',['averageLuminance'],['textureAdderSampler'],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define HDR',d.Engine.TEXTURETYPE_UNSIGNED_INT);var r=1,n=0,o=0;this.hdrPostProcess.onApply=function(t){if(t.setTextureFromPostProcess('textureAdderSampler',l._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),0>r)r=l._hdrCurrentLuminance;else{var i=(o-n)/1e3;l._hdrCurrentLuminance<r+l.hdrDecreaseRate*i?r+=l.hdrDecreaseRate*i:l._hdrCurrentLuminance>r-l.hdrIncreaseRate*i?r-=l.hdrIncreaseRate*i:r=l._hdrCurrentLuminance}r=d.Scalar.Clamp(r,l.hdrMinimumLuminance,1e20),t.setFloat('averageLuminance',r),o=n,l._currentDepthOfFieldSource=l.hdrFinalPostProcess},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDR',function(){return l.hdrPostProcess},!0))},p.prototype._createLensFlarePostProcess=function(e,t){var c=this;this.lensFlarePostProcess=new d.PostProcess('HDRLensFlare','standard',['strength','ghostDispersal','haloWidth','resolution','distortionStrength'],['lensColorSampler'],t/2,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define LENS_FLARE',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRLensFlare',function(){return c.lensFlarePostProcess},!0)),this._createBlurPostProcesses(e,t/4,2),this.lensFlareComposePostProcess=new d.PostProcess('HDRLensFlareCompose','standard',['lensStarMatrix'],['otherSampler','lensDirtSampler','lensStarSampler'],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define LENS_FLARE_COMPOSE',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRLensFlareCompose',function(){return c.lensFlareComposePostProcess},!0));var r=new d.Vector2(0,0);this.lensFlarePostProcess.onApply=function(t){t.setTextureFromPostProcess('textureSampler',c._bloomEnabled?c.blurHPostProcesses[0]:c.originalPostProcess),t.setTexture('lensColorSampler',c.lensColorTexture),t.setFloat('strength',c.lensFlareStrength),t.setFloat('ghostDispersal',c.lensFlareGhostDispersal),t.setFloat('haloWidth',c.lensFlareHaloWidth),r.x=c.lensFlarePostProcess.width,r.y=c.lensFlarePostProcess.height,t.setVector2('resolution',r),t.setFloat('distortionStrength',c.lensFlareDistortionStrength)};var p=d.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),o=d.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(e){if(c._scene.activeCamera){e.setTextureFromPostProcess('otherSampler',c._currentDepthOfFieldSource),e.setTexture('lensDirtSampler',c.lensFlareDirtTexture),e.setTexture('lensStarSampler',c.lensStarTexture);var t=c._scene.activeCamera.getViewMatrix().getRow(0),r=c._scene.activeCamera.getViewMatrix().getRow(2),i=d.Vector3.Dot(t.toVector3(),new d.Vector3(1,0,0))+d.Vector3.Dot(r.toVector3(),new d.Vector3(0,0,1));i*=4;var a=d.Matrix.FromValues(.5*F(i),-B(i),0,0,B(i),.5*F(i),0,0,0,0,1,0,0,0,0,1),n=o.multiply(a).multiply(p);e.setMatrix('lensStarMatrix',n),c._currentDepthOfFieldSource=c.lensFlareFinalPostProcess}}},p.prototype._createDepthOfFieldPostProcess=function(e,t){var o=this;this.depthOfFieldPostProcess=new d.PostProcess('HDRDepthOfField','standard',['distance'],['otherSampler','depthSampler'],t,null,d.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,'#define DEPTH_OF_FIELD',d.Engine.TEXTURETYPE_UNSIGNED_INT),this.depthOfFieldPostProcess.onApply=function(t){t.setTextureFromPostProcess('otherSampler',o._currentDepthOfFieldSource),t.setTexture('depthSampler',o._getDepthTexture()),t.setFloat('distance',o.depthOfFieldDistance)},this.addEffect(new d.PostProcessRenderEffect(e.getEngine(),'HDRDepthOfField',function(){return o.depthOfFieldPostProcess},!0))},p.prototype._createMotionBlurPostProcess=function(c,e){var t=this;this.motionBlurPostProcess=new d.PostProcess('HDRMotionBlur','standard',['inverseViewProjection','prevViewProjection','screenSize','motionScale','motionStrength'],['depthSampler'],e,null,d.Texture.BILINEAR_SAMPLINGMODE,c.getEngine(),!1,'#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES '+this.motionBlurSamples.toFixed(1),d.Engine.TEXTURETYPE_UNSIGNED_INT);var r=0,i=d.Matrix.Identity(),o=d.Matrix.Identity(),n=d.Matrix.Identity(),a=d.Vector2.Zero();this.motionBlurPostProcess.onApply=function(s){n=c.getProjectionMatrix().multiply(c.getViewMatrix()),n.invertToRef(o),s.setMatrix('inverseViewProjection',o),s.setMatrix('prevViewProjection',i),i=n,a.x=t.motionBlurPostProcess.width,a.y=t.motionBlurPostProcess.height,s.setVector2('screenSize',a),r=c.getEngine().getFps()/60,s.setFloat('motionScale',r),s.setFloat('motionStrength',t.motionStrength),s.setTexture('depthSampler',t._getDepthTexture())},this.addEffect(new d.PostProcessRenderEffect(c.getEngine(),'HDRMotionBlur',function(){return t.motionBlurPostProcess},!0))},p.prototype._getDepthTexture=function(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()},p.prototype._disposePostProcesses=function(){for(var r=0,e;r<this._cameras.length;r++){e=this._cameras[r],this.originalPostProcess&&this.originalPostProcess.dispose(e),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(e),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(e),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(e),this.textureAdderFinalPostProcess&&this.textureAdderFinalPostProcess.dispose(e),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(e),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(e),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(e),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(e),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(e),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(e),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(e);for(var t=0;t<this.luminanceDownSamplePostProcesses.length;t++)this.luminanceDownSamplePostProcesses[t].dispose(e);this.luminancePostProcess&&this.luminancePostProcess.dispose(e),this.hdrPostProcess&&this.hdrPostProcess.dispose(e),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(e),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(e),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(e);for(var t=0;t<this.blurHPostProcesses.length;t++)this.blurHPostProcesses[t].dispose(e);for(var t=0;t<this.blurVPostProcesses.length;t++)this.blurVPostProcesses[t].dispose(e)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.luminanceDownSamplePostProcesses=[],this.blurHPostProcesses=[],this.blurVPostProcesses=[]},p.prototype.dispose=function(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),e.prototype.dispose.call(this)},p.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),e.customType='StandardRenderingPipeline',e},p.Parse=function(e,t,r){var i=d.SerializationHelper.Parse(function(){return new p(e._name,t,e._ratio)},e,t,r);return e.sourceLightId&&(i.sourceLight=t.getLightByID(e.sourceLightId)),i},p.LuminanceSteps=6,g([d.serialize()],p.prototype,'brightThreshold',void 0),g([d.serialize()],p.prototype,'blurWidth',void 0),g([d.serialize()],p.prototype,'horizontalBlur',void 0),g([d.serialize()],p.prototype,'exposure',void 0),g([d.serializeAsTexture('lensTexture')],p.prototype,'lensTexture',void 0),g([d.serialize()],p.prototype,'volumetricLightCoefficient',void 0),g([d.serialize()],p.prototype,'volumetricLightPower',void 0),g([d.serialize()],p.prototype,'volumetricLightBlurScale',void 0),g([d.serialize()],p.prototype,'hdrMinimumLuminance',void 0),g([d.serialize()],p.prototype,'hdrDecreaseRate',void 0),g([d.serialize()],p.prototype,'hdrIncreaseRate',void 0),g([d.serializeAsTexture('lensColorTexture')],p.prototype,'lensColorTexture',void 0),g([d.serialize()],p.prototype,'lensFlareStrength',void 0),g([d.serialize()],p.prototype,'lensFlareGhostDispersal',void 0),g([d.serialize()],p.prototype,'lensFlareHaloWidth',void 0),g([d.serialize()],p.prototype,'lensFlareDistortionStrength',void 0),g([d.serializeAsTexture('lensStarTexture')],p.prototype,'lensStarTexture',void 0),g([d.serializeAsTexture('lensFlareDirtTexture')],p.prototype,'lensFlareDirtTexture',void 0),g([d.serialize()],p.prototype,'depthOfFieldDistance',void 0),g([d.serialize()],p.prototype,'depthOfFieldBlurWidth',void 0),g([d.serialize()],p.prototype,'motionStrength',void 0),g([d.serialize()],p.prototype,'_ratio',void 0),g([d.serialize()],p.prototype,'BloomEnabled',null),g([d.serialize()],p.prototype,'DepthOfFieldEnabled',null),g([d.serialize()],p.prototype,'LensFlareEnabled',null),g([d.serialize()],p.prototype,'HDREnabled',null),g([d.serialize()],p.prototype,'VLSEnabled',null),g([d.serialize()],p.prototype,'MotionBlurEnabled',null),g([d.serialize()],p.prototype,'volumetricLightStepsCount',null),g([d.serialize()],p.prototype,'motionBlurSamples',null),p}(d.PostProcessRenderPipeline);d.StandardRenderingPipeline=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a){void 0===r&&(r=null),void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT);var l=e.call(this,t,'fxaa',['texelSize'],null,p,r,n||d.Texture.BILINEAR_SAMPLINGMODE,o,s,null,a,'fxaa',void 0,!0)||this,u=l._getDefines();return l.updateEffect(u),l.onApplyObservable.add(function(r){var e=l.texelSize;r.setFloat2('texelSize',e.x,e.y)}),l}return h(t,e),t.prototype._getDefines=function(){var r=this.getEngine();if(!r)return null;var o=r.getGlInfo();return o&&o.renderer&&-1<o.renderer.toLowerCase().indexOf('mali')?'#define MALI 1\n':null},t}(d.PostProcess);d.FxaaPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l,_,c){void 0===_&&(_=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===c&&(c=!1);var u=e.call(this,t,'chromaticAberration',['chromatic_aberration','screen_width','screen_height','direction','radialIntensity','centerPosition'],[],n,o,s,a,l,null,_,void 0,null,c)||this;return u.aberrationAmount=30,u.radialIntensity=0,u.direction=new d.Vector2(.707,.707),u.centerPosition=new d.Vector2(.5,.5),u.onApplyObservable.add(function(t){t.setFloat('chromatic_aberration',u.aberrationAmount),t.setFloat('screen_width',p),t.setFloat('screen_height',r),t.setFloat('radialIntensity',u.radialIntensity),t.setFloat2('direction',u.direction.x,u.direction.y),t.setFloat2('centerPosition',u.centerPosition.x,u.centerPosition.y)}),u}return h(t,e),t}(d.PostProcess);d.ChromaticAberrationPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===l&&(l=!1);var u=e.call(this,t,'grain',['intensity','animatedSeed'],[],p,r,n,o,s,null,a,void 0,null,l)||this;return u.intensity=30,u.animated=!1,u.onApplyObservable.add(function(t){t.setFloat('intensity',u.intensity),t.setFloat('animatedSeed',u.animated?Math.random()+1:1)}),u}return h(t,e),t}(d.PostProcess);d.GrainPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===l&&(l=!1);var u=e.call(this,t,'sharpen',['sharpnessAmounts','screenSize'],null,p,r,n,o,s,null,a,void 0,null,l)||this;return u.colorAmount=1,u.edgeAmount=.3,u.onApply=function(t){t.setFloat2('screenSize',u.width,u.height),t.setFloat2('sharpnessAmounts',u.edgeAmount,u.colorAmount)},u}return h(t,e),t}(d.PostProcess);d.SharpenPostProcess=e}(e||(e={}));var e;!function(p){var e=function(E){function e(e,t,r,n,o,s,a,l,_,c,u){void 0===s&&(s=p.Texture.BILINEAR_SAMPLINGMODE),void 0===_&&(_=p.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===c&&(c=''),void 0===u&&(u=!1);var f=E.call(this,e,'kernelBlur',['delta','direction','cameraMinMaxZ'],['circleOfConfusionSampler'],n,o,s,a,l,null,_,'kernelBlur',{varyingCount:0,depCount:0},!0)||this;return f.direction=t,f.blockCompilation=u,f._packedFloat=!1,f._staticDefines='',f._staticDefines=c,f.onApplyObservable.add(function(t){f._outputTexture?t.setFloat2('delta',1/f._outputTexture.width*f.direction.x,1/f._outputTexture.height*f.direction.y):t.setFloat2('delta',1/f.width*f.direction.x,1/f.height*f.direction.y)}),f.kernel=r,f}return h(e,E),Object.defineProperty(e.prototype,'kernel',{get:function(){return this._idealKernel},set:function(t){this._idealKernel!==t&&(t=W(t,1),this._idealKernel=t,this._kernel=this._nearestBestKernel(t),this.blockCompilation||this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'packedFloat',{get:function(){return this._packedFloat},set:function(t){this._packedFloat!==t&&(this._packedFloat=t,this.blockCompilation||this._updateParameters())},enumerable:!0,configurable:!0}),e.prototype.updateEffect=function(a,e,t,i,r,n){void 0===a&&(a=null),void 0===e&&(e=null),void 0===t&&(t=null),this._updateParameters(r,n)},e.prototype._updateParameters=function(t,e){for(var i=this._kernel,r=(i-1)/2,n=[],o=[],s=0,a=0;a<i;a++){var l=a/(i-1),h=this._gaussianWeight(2*l-1);n[a]=a-r,o[a]=h,s+=h}for(var a=0;a<o.length;a++)o[a]/=s;for(var c=[],u=[],f=[],a=0,d;a<=r;a+=2)if(d=C(a+1,ee(r)),a===d)f.push({o:n[a],w:o[a]});else{var p=d===r,_=o[a]+o[d]*(p?.5:1),P=n[a]+1/(1+o[a]/o[d]);0===P?(f.push({o:n[a],w:o[a]}),f.push({o:n[a+1],w:o[a+1]})):(f.push({o:P,w:_}),f.push({o:-P,w:_}))}for(var a=0;a<f.length;a++)u[a]=f[a].o,c[a]=f[a].w;n=u,o=c;var A=this.getEngine().getCaps().maxVaryingVectors,v=W(A,0)-1,y=C(n.length,v),S='';S+=this._staticDefines,-1!=this._staticDefines.indexOf('DOF')&&(S+='#define CENTER_WEIGHT '+this._glslFloat(o[y-1])+'\r\n',y--);for(var a=0;a<y;a++)S+='#define KERNEL_OFFSET'+a+' '+this._glslFloat(n[a])+'\r\n',S+='#define KERNEL_WEIGHT'+a+' '+this._glslFloat(o[a])+'\r\n';for(var x=0,a=v;a<n.length;a++)S+='#define KERNEL_DEP_OFFSET'+x+' '+this._glslFloat(n[a])+'\r\n',S+='#define KERNEL_DEP_WEIGHT'+x+' '+this._glslFloat(o[a])+'\r\n',x++;this.packedFloat&&(S+='#define PACKEDFLOAT 1'),this.blockCompilation=!1,E.prototype.updateEffect.call(this,S,null,null,{varyingCount:y,depCount:x},t,e)},e.prototype._nearestBestKernel=function(o){for(var e=O(o),t=0,i=[e,e-1,e+1,e-2,e+2],r;t<i.length;t++)if(r=i[t],0!=r%2&&0==ee(r/2)%2&&0<r)return W(r,3);return W(e,3)},e.prototype._gaussianWeight=function(r){var o=$(2*V)*(1/3);return 1/o*u(-r*r/(2*(1/3)*(1/3)))},e.prototype._glslFloat=function(r,e){return void 0===e&&(e=8),r.toFixed(e).replace(/0+$/,'')},e}(p.PostProcess);p.BlurPostProcess=e}(e||(e={}));var e;!function(m){var e=function(e){function t(t,g,r,n,o,s,a,l,h,c,u,f,d){void 0===l&&(l=null),void 0===h&&(h=m.Texture.BILINEAR_SAMPLINGMODE),void 0===f&&(f=m.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===d&&(d=!1);var p=e.call(this,t,r,n,o,s,h=m.Texture.BILINEAR_SAMPLINGMODE,c,u,f=m.Engine.TEXTURETYPE_UNSIGNED_INT,'#define DOF 1\r\n',d)||this;return p.direction=r,p.onApplyObservable.add(function(t){null!=l&&t.setTextureFromPostProcess('textureSampler',l),t.setTextureFromPostProcessOutput('circleOfConfusionSampler',a),g.activeCamera&&t.setFloat2('cameraMinMaxZ',g.activeCamera.minZ,g.activeCamera.maxZ)}),p}return h(t,e),t}(m.BlurPostProcess);m.DepthOfFieldBlurPostProcess=e}(e||(e={}));var e;!function(p){var e=function(){return function(){}}();p.DepthOfFieldMergePostProcessOptions=e;var t=function(_){function e(e,t,r,n,o,s,a,l,m,c,u){void 0===c&&(c=p.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===u&&(u=!1);var f=_.call(this,e,'depthOfFieldMerge',[],['circleOfConfusionSampler','blurStep0','blurStep1','blurStep2'],o,s,a,l,m,null,c,void 0,null,!0)||this;return f.blurSteps=n,f.onApplyObservable.add(function(o){o.setTextureFromPostProcess('textureSampler',t),o.setTextureFromPostProcessOutput('circleOfConfusionSampler',r),n.forEach(function(e,t){o.setTextureFromPostProcessOutput('blurStep'+(n.length-t-1),e)})}),u||f.updateEffect(),f}return h(e,_),e.prototype.updateEffect=function(t,e,i,r,a,o){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),t||(t='',t+='#define BLUR_LEVEL '+(this.blurSteps.length-1)+'\n'),_.prototype.updateEffect.call(this,t,e,i,r,a,o)},e}(p.PostProcess);p.DepthOfFieldMergePostProcess=t}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l,f){void 0===l&&(l=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===f&&(f=!1);var c=e.call(this,t,'circleOfConfusion',['cameraMinMaxZ','focusDistance','cocPrecalculation'],['depthSampler'],r,n,o,s,a,null,l,void 0,null,f)||this;return c.lensSize=50,c.fStop=1.4,c.focusDistance=2e3,c.focalLength=50,c._depthTexture=null,c._depthTexture=p,c.onApplyObservable.add(function(e){if(!c._depthTexture)return void d.Tools.Warn('No depth texture set on CircleOfConfusionPostProcess');e.setTexture('depthSampler',c._depthTexture);var t=c.lensSize/c.fStop,o=t*c.focalLength/(c.focusDistance-c.focalLength);e.setFloat('focusDistance',c.focusDistance),e.setFloat('cocPrecalculation',o),e.setFloat2('cameraMinMaxZ',c._depthTexture.activeCamera.minZ,c._depthTexture.activeCamera.maxZ)}),c}return h(t,e),Object.defineProperty(t.prototype,'depthTexture',{set:function(t){this._depthTexture=t},enumerable:!0,configurable:!0}),t}(d.PostProcess);d.CircleOfConfusionPostProcess=e}(e||(e={}));var e;!function(m){var e;!function(t){t[t.Low=0]='Low',t[t.Medium=1]='Medium',t[t.High=2]='High'}(e=m.DepthOfFieldEffectBlurLevel||(m.DepthOfFieldEffectBlurLevel={}));var t=function(t){function o(i,g,n,o,s){void 0===n&&(n=e.Low),void 0===o&&(o=0),void 0===s&&(s=!1);var a=t.call(this,i.getEngine(),'depth of field',function(){return a._effects},!0)||this;a._effects=[],a._circleOfConfusion=new m.CircleOfConfusionPostProcess('circleOfConfusion',g,1,null,m.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,o,s),a._depthOfFieldBlurY=[],a._depthOfFieldBlurX=[];var l=1,h=15;n===e.High?(l=3,h=51):n===e.Medium?(l=2,h=31):(h=15,l=1);for(var c=h/x(2,l-1),u=1,f=0,d;f<l;f++){d=new m.DepthOfFieldBlurPostProcess('verticle blur',i,new m.Vector2(0,1),c,u,null,a._circleOfConfusion,0==f?a._circleOfConfusion:null,m.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,o,s),d.autoClear=!1,u=.75/x(2,f);var p=new m.DepthOfFieldBlurPostProcess('horizontal blur',i,new m.Vector2(1,0),c,u,null,a._circleOfConfusion,null,m.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,o,s);p.autoClear=!1,a._depthOfFieldBlurY.push(d),a._depthOfFieldBlurX.push(p)}a._effects=[a._circleOfConfusion];for(var f=0;f<a._depthOfFieldBlurX.length;f++)a._effects.push(a._depthOfFieldBlurY[f]),a._effects.push(a._depthOfFieldBlurX[f]);return a._dofMerge=new m.DepthOfFieldMergePostProcess('dofMerge',a._circleOfConfusion,a._circleOfConfusion,a._depthOfFieldBlurX,u,null,m.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,o,s),a._dofMerge.autoClear=!1,a._effects.push(a._dofMerge),a}return h(o,t),Object.defineProperty(o.prototype,'focalLength',{get:function(){return this._circleOfConfusion.focalLength},set:function(t){this._circleOfConfusion.focalLength=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'fStop',{get:function(){return this._circleOfConfusion.fStop},set:function(t){this._circleOfConfusion.fStop=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'focusDistance',{get:function(){return this._circleOfConfusion.focusDistance},set:function(t){this._circleOfConfusion.focusDistance=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'lensSize',{get:function(){return this._circleOfConfusion.lensSize},set:function(t){this._circleOfConfusion.lensSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'depthTexture',{set:function(t){this._circleOfConfusion.depthTexture=t},enumerable:!0,configurable:!0}),o.prototype.disposeEffects=function(r){for(var e=0;e<this._effects.length;e++)this._effects[e].dispose(r)},o.prototype._updateEffects=function(){for(var t=0;t<this._effects.length;t++)this._effects[t].updateEffect()},o.prototype._isReady=function(){for(var t=0;t<this._effects.length;t++)if(!this._effects[t].isReady())return!1;return!0},o}(m.PostProcessRenderEffect);m.DepthOfFieldEffect=t}(e||(e={}));var e;!function(p){var e=function(e){function t(t,_,r,n,o,s,a,l,m,c,u){void 0===c&&(c=p.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===u&&(u=!1);var f=e.call(this,t,'bloomMerge',['bloomWeight'],['circleOfConfusionSampler','blurStep0','blurStep1','blurStep2','bloomBlur'],o,s,a,l,m,null,c,void 0,null,!0)||this;return f.weight=n,f.onApplyObservable.add(function(t){t.setTextureFromPostProcess('textureSampler',_),t.setTextureFromPostProcessOutput('bloomBlur',r),t.setFloat('bloomWeight',f.weight)}),u||f.updateEffect(),f}return h(t,e),t}(p.PostProcess);p.BloomMergePostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===l&&(l=!1);var u=e.call(this,t,'extractHighlights',['threshold','exposure'],null,p,r,n,o,s,null,a,void 0,null,l)||this;return u.threshold=.9,u._exposure=1,u._inputPostProcess=null,u.onApplyObservable.add(function(e){u._inputPostProcess&&e.setTextureFromPostProcess('textureSampler',u._inputPostProcess),e.setFloat('threshold',x(u.threshold,d.ToGammaSpace)),e.setFloat('exposure',u._exposure)}),u}return h(t,e),t}(d.PostProcess);d.ExtractHighlightsPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,c,r,n,o,s){void 0===o&&(o=0),void 0===s&&(s=!1);var a=e.call(this,t.getEngine(),'bloom',function(){return a._effects},!0)||this;return a.bloomScale=c,a._effects=[],a._downscale=new d.ExtractHighlightsPostProcess('highlights',1,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._blurX=new d.BlurPostProcess('horizontal blur',new d.Vector2(1,0),10,c,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,void 0,s),a._blurX.alwaysForcePOT=!0,a._blurX.autoClear=!1,a._blurY=new d.BlurPostProcess('vertical blur',new d.Vector2(0,1),10,c,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,void 0,s),a._blurY.alwaysForcePOT=!0,a._blurY.autoClear=!1,a.kernel=n,a._effects=[a._downscale,a._blurX,a._blurY],a._merge=new d.BloomMergePostProcess('bloomMerge',a._downscale,a._blurY,r,c,null,d.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._merge.autoClear=!1,a._effects.push(a._merge),a}return h(t,e),Object.defineProperty(t.prototype,'threshold',{get:function(){return this._downscale.threshold},set:function(t){this._downscale.threshold=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'weight',{get:function(){return this._merge.weight},set:function(t){this._merge.weight=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'kernel',{get:function(){return this._blurX.kernel/this.bloomScale},set:function(t){this._blurX.kernel=t*this.bloomScale,this._blurY.kernel=t*this.bloomScale},enumerable:!0,configurable:!0}),t.prototype.disposeEffects=function(r){for(var e=0;e<this._effects.length;e++)this._effects[e].dispose(r)},t.prototype._updateEffects=function(){for(var t=0;t<this._effects.length;t++)this._effects[t].updateEffect()},t.prototype._isReady=function(){for(var t=0;t<this._effects.length;t++)if(!this._effects[t].isReady())return!1;return!0},t}(d.PostProcessRenderEffect);d.BloomEffect=e}(e||(e={}));var e;!function(d){var e=function(e){function o(t,c,r,n,o){void 0===o&&(o=!0);var s=e.call(this,r.getEngine(),t)||this;s._originalCameras=[],s.SharpenPostProcessId='SharpenPostProcessEffect',s.ImageProcessingPostProcessId='ImageProcessingPostProcessEffect',s.FxaaPostProcessId='FxaaPostProcessEffect',s.ChromaticAberrationPostProcessId='ChromaticAberrationPostProcessEffect',s.GrainPostProcessId='GrainPostProcessEffect',s.animations=[],s._imageProcessingConfigurationObserver=null,s._sharpenEnabled=!1,s._bloomEnabled=!1,s._depthOfFieldEnabled=!1,s._depthOfFieldBlurLevel=d.DepthOfFieldEffectBlurLevel.Low,s._fxaaEnabled=!1,s._imageProcessingEnabled=!0,s._bloomScale=.5,s._chromaticAberrationEnabled=!1,s._grainEnabled=!1,s._buildAllowed=!0,s._resizeObserver=null,s._hardwareScaleLevel=1,s._bloomKernel=64,s._bloomWeight=.15,s._bloomThreshold=.9,s._samples=1,s._hasCleared=!1,s._prevPostProcess=null,s._prevPrevPostProcess=null,s._cameras=n||[],s._originalCameras=s._cameras.slice(),s._buildAllowed=o,s._scene=r;var a=s._scene.getEngine().getCaps();s._hdr=c&&(a.textureHalfFloatRender||a.textureFloatRender),s._hdr?a.textureHalfFloatRender?s._defaultPipelineTextureType=d.Engine.TEXTURETYPE_HALF_FLOAT:a.textureFloatRender&&(s._defaultPipelineTextureType=d.Engine.TEXTURETYPE_FLOAT):s._defaultPipelineTextureType=d.Engine.TEXTURETYPE_UNSIGNED_INT,r.postProcessRenderPipelineManager.addPipeline(s);var l=s._scene.getEngine();return s.sharpen=new d.SharpenPostProcess('sharpen',1,null,d.Texture.BILINEAR_SAMPLINGMODE,l,!1,s._defaultPipelineTextureType,!0),s._sharpenEffect=new d.PostProcessRenderEffect(l,s.SharpenPostProcessId,function(){return s.sharpen},!0),s.depthOfField=new d.DepthOfFieldEffect(s._scene,null,s._depthOfFieldBlurLevel,s._defaultPipelineTextureType,!0),s.bloom=new d.BloomEffect(s._scene,s._bloomScale,s._bloomWeight,s.bloomKernel,s._defaultPipelineTextureType,!0),s.chromaticAberration=new d.ChromaticAberrationPostProcess('ChromaticAberration',l.getRenderWidth(),l.getRenderHeight(),1,null,d.Texture.BILINEAR_SAMPLINGMODE,l,!1,s._defaultPipelineTextureType,!0),s._chromaticAberrationEffect=new d.PostProcessRenderEffect(l,s.ChromaticAberrationPostProcessId,function(){return s.chromaticAberration},!0),s.grain=new d.GrainPostProcess('Grain',1,null,d.Texture.BILINEAR_SAMPLINGMODE,l,!1,s._defaultPipelineTextureType,!0),s._grainEffect=new d.PostProcessRenderEffect(l,s.GrainPostProcessId,function(){return s.grain},!0),s._resizeObserver=l.onResizeObservable.add(function(){s._hardwareScaleLevel=l.getHardwareScalingLevel(),s.bloomKernel=s.bloomKernel}),s._imageProcessingConfigurationObserver=s._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){s.bloom._downscale._exposure=s._scene.imageProcessingConfiguration.exposure}),s._buildPipeline(),s}return h(o,e),Object.defineProperty(o.prototype,'sharpenEnabled',{get:function(){return this._sharpenEnabled},set:function(t){this._sharpenEnabled!==t&&(this._sharpenEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'bloomKernel',{get:function(){return this._bloomKernel},set:function(t){this._bloomKernel=t,this.bloom.kernel=t/this._hardwareScaleLevel},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'bloomWeight',{get:function(){return this._bloomWeight},set:function(t){this._bloomWeight!==t&&(this.bloom.weight=t,this._bloomWeight=t)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'bloomThreshold',{get:function(){return this._bloomThreshold},set:function(t){this._bloomThreshold!==t&&(this.bloom.threshold=t,this._bloomThreshold=t)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'bloomScale',{get:function(){return this._bloomScale},set:function(t){this._bloomScale!==t&&(this._bloomScale=t,this._rebuildBloom(),this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'bloomEnabled',{get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled!==t&&(this._bloomEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),o.prototype._rebuildBloom=function(){var e=this.bloom;this.bloom=new d.BloomEffect(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(var t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])},Object.defineProperty(o.prototype,'depthOfFieldEnabled',{get:function(){return this._depthOfFieldEnabled},set:function(t){this._depthOfFieldEnabled!==t&&(this._depthOfFieldEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'depthOfFieldBlurLevel',{get:function(){return this._depthOfFieldBlurLevel},set:function(e){if(this._depthOfFieldBlurLevel!==e){this._depthOfFieldBlurLevel=e;var t=this.depthOfField;this.depthOfField=new d.DepthOfFieldEffect(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(var o=0;o<this._cameras.length;o++)t.disposeEffects(this._cameras[o]);this._buildPipeline()}},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'fxaaEnabled',{get:function(){return this._fxaaEnabled},set:function(t){this._fxaaEnabled!==t&&(this._fxaaEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'samples',{get:function(){return this._samples},set:function(t){this._samples!==t&&(this._samples=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'imageProcessingEnabled',{get:function(){return this._imageProcessingEnabled},set:function(t){this._imageProcessingEnabled!==t&&(this._imageProcessingEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'chromaticAberrationEnabled',{get:function(){return this._chromaticAberrationEnabled},set:function(t){this._chromaticAberrationEnabled!==t&&(this._chromaticAberrationEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'grainEnabled',{get:function(){return this._grainEnabled},set:function(t){this._grainEnabled!==t&&(this._grainEnabled=t,this._buildPipeline())},enumerable:!0,configurable:!0}),o.prototype.prepare=function(){var t=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=t},o.prototype._setAutoClearAndTextureSharing=function(r,e){void 0===e&&(e=!1),this._hasCleared?r.autoClear=!1:(r.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),e||(this._prevPrevPostProcess?r.shareOutputWith(this._prevPrevPostProcess):r.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=r)},o.prototype._buildPipeline=function(){var e=this;if(this._buildAllowed){this._scene.autoClear=!0;var t=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._originalCameras.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){var o=this._scene.enableDepthRenderer(this._cameras[0]).getDepthMap();this.depthOfField.depthTexture=o,this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new d.ImageProcessingPostProcess('imageProcessing',1,null,d.Texture.BILINEAR_SAMPLINGMODE,t,!1,this._defaultPipelineTextureType),this._hdr?(this.addEffect(new d.PostProcessRenderEffect(t,this.ImageProcessingPostProcessId,function(){return e.imageProcessing},!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new d.FxaaPostProcess('fxaa',1,null,d.Texture.BILINEAR_SAMPLINGMODE,t,!1,this._defaultPipelineTextureType),this.addEffect(new d.PostProcessRenderEffect(t,this.FxaaPostProcessId,function(){return e.fxaa},!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this.samples)&&1<this.samples&&d.Tools.Warn('MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0')}},o.prototype._disposePostProcesses=function(r){void 0===r&&(r=!1);for(var e=0,t;e<this._cameras.length;e++)t=this._cameras[e],this.imageProcessing&&this.imageProcessing.dispose(t),this.fxaa&&this.fxaa.dispose(t),r&&(this.sharpen&&this.sharpen.dispose(t),this.depthOfField&&this.depthOfField.disposeEffects(t),this.bloom&&this.bloom.disposeEffects(t),this.chromaticAberration&&this.chromaticAberration.dispose(t),this.grain&&this.grain.dispose(t));this.imageProcessing=null,this.fxaa=null,r&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null)},o.prototype.dispose=function(){this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),e.prototype.dispose.call(this)},o.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);return e.customType='DefaultRenderingPipeline',e},o.Parse=function(e,t,r){return d.SerializationHelper.Parse(function(){return new o(e._name,e._name._hdr,t)},e,t,r)},g([d.serialize()],o.prototype,'sharpenEnabled',null),g([d.serialize()],o.prototype,'bloomKernel',null),g([d.serialize()],o.prototype,'_bloomWeight',void 0),g([d.serialize()],o.prototype,'_bloomThreshold',void 0),g([d.serialize()],o.prototype,'_hdr',void 0),g([d.serialize()],o.prototype,'bloomWeight',null),g([d.serialize()],o.prototype,'bloomThreshold',null),g([d.serialize()],o.prototype,'bloomScale',null),g([d.serialize()],o.prototype,'bloomEnabled',null),g([d.serialize()],o.prototype,'depthOfFieldEnabled',null),g([d.serialize()],o.prototype,'depthOfFieldBlurLevel',null),g([d.serialize()],o.prototype,'fxaaEnabled',null),g([d.serialize()],o.prototype,'samples',null),g([d.serialize()],o.prototype,'imageProcessingEnabled',null),g([d.serialize()],o.prototype,'chromaticAberrationEnabled',null),g([d.serialize()],o.prototype,'grainEnabled',null),o}(d.PostProcessRenderPipeline);d.DefaultRenderingPipeline=e}(e||(e={}));var e;!function(d){var e=function(){function e(r,e){void 0===e&&(e=1),this._enablePosition=!1,this._scene=r,this._ratio=e,this._createRenderTargets()}return Object.defineProperty(e.prototype,'renderList',{set:function(t){this._multiRenderTarget.renderList=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'isSupported',{get:function(){return this._multiRenderTarget.isSupported},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'enablePosition',{get:function(){return this._enablePosition},set:function(t){this._enablePosition=t,this.dispose(),this._createRenderTargets()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'scene',{get:function(){return this._scene},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'ratio',{get:function(){return this._ratio},enumerable:!0,configurable:!0}),e.prototype.isReady=function(e,t){var i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;var r=[],n=[d.VertexBuffer.PositionKind,d.VertexBuffer.NormalKind],o=e.getMesh();i&&i.needAlphaTesting()&&(r.push('#define ALPHATEST'),o.isVerticesDataPresent(d.VertexBuffer.UVKind)&&(n.push(d.VertexBuffer.UVKind),r.push('#define UV1')),o.isVerticesDataPresent(d.VertexBuffer.UV2Kind)&&(n.push(d.VertexBuffer.UV2Kind),r.push('#define UV2'))),this._enablePosition&&r.push('#define POSITION'),o.useBones&&o.computeBonesUsingShaders?(n.push(d.VertexBuffer.MatricesIndicesKind),n.push(d.VertexBuffer.MatricesWeightsKind),4<o.numBoneInfluencers&&(n.push(d.VertexBuffer.MatricesIndicesExtraKind),n.push(d.VertexBuffer.MatricesWeightsExtraKind)),r.push('#define NUM_BONE_INFLUENCERS '+o.numBoneInfluencers),r.push('#define BonesPerMesh '+(o.skeleton?o.skeleton.bones.length+1:0))):r.push('#define NUM_BONE_INFLUENCERS 0'),t&&(r.push('#define INSTANCES'),n.push('world0'),n.push('world1'),n.push('world2'),n.push('world3'));var s=r.join('\n');return this._cachedDefines!==s&&(this._cachedDefines=s,this._effect=this._scene.getEngine().createEffect('geometry',n,['world','mBones','viewProjection','diffuseMatrix','view'],['diffuseSampler'],s,void 0,void 0,void 0,{buffersCount:this._enablePosition?3:2})),this._effect.isReady()},e.prototype.getGBuffer=function(){return this._multiRenderTarget},Object.defineProperty(e.prototype,'samples',{get:function(){return this._multiRenderTarget.samples},set:function(t){this._multiRenderTarget.samples=t},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.getGBuffer().dispose()},e.prototype._createRenderTargets=function(){var c=this,e=this._scene.getEngine(),t=this._enablePosition?3:2;if(this._multiRenderTarget=new d.MultiRenderTarget('gBuffer',{width:e.getRenderWidth()*this._ratio,height:e.getRenderHeight()*this._ratio},t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:d.Engine.TEXTURETYPE_FLOAT}),this.isSupported){this._multiRenderTarget.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(function(e){e.clear(new d.Color4(0,0,0,1),!0,!0,!0)});var r=function(e){var t=e.getRenderingMesh(),r=c._scene,i=r.getEngine(),o=e.getMaterial();if(o){i.setState(o.backFaceCulling,0,!1,r.useRightHandedSystem);var n=t._getInstancesRenderList(e._id);if(!n.mustReturn){var a=i.getCaps().instancedArrays&&null!==n.visibleInstances[e._id];if(c.isReady(e,a)){if(i.enableEffect(c._effect),t._bind(e,c._effect,d.Material.TriangleFillMode),c._effect.setMatrix('viewProjection',r.getTransformMatrix()),c._effect.setMatrix('view',r.getViewMatrix()),o&&o.needAlphaTesting()){var s=o.getAlphaTestTexture();s&&(c._effect.setTexture('diffuseSampler',s),c._effect.setMatrix('diffuseMatrix',s.getTextureMatrix()))}t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&c._effect.setMatrices('mBones',t.skeleton.getTransformMatrices(t)),t._processRendering(e,c._effect,d.Material.TriangleFillMode,n,a,function(t,e){return c._effect.setMatrix('world',e)})}}}};this._multiRenderTarget.customRenderFunction=function(i,a,t,n){var o;if(n.length){for(e.setColorWrite(!1),o=0;o<n.length;o++)r(n.data[o]);e.setColorWrite(!0)}for(o=0;o<i.length;o++)r(i.data[o]);for(o=0;o<a.length;o++)r(a.data[o])}}},e}();d.GeometryBufferRenderer=e}(e||(e={}));var e;!function(o){var e=function(d){function e(e,p,t,r,n,s,a,l,_,c){var u=d.call(this,e,'refraction',['baseColor','depth','colorLevel'],['refractionSampler'],s,a,l,_,c)||this;return u.color=t,u.depth=r,u.colorLevel=n,u._ownRefractionTexture=!0,u.onActivateObservable.add(function(e){u._refTexture=u._refTexture||new o.Texture(p,e.getScene())}),u.onApplyObservable.add(function(t){t.setColor3('baseColor',u.color),t.setFloat('depth',u.depth),t.setFloat('colorLevel',u.colorLevel),t.setTexture('refractionSampler',u._refTexture)}),u}return h(e,d),Object.defineProperty(e.prototype,'refractionTexture',{get:function(){return this._refTexture},set:function(t){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=t,this._ownRefractionTexture=!1},enumerable:!0,configurable:!0}),e.prototype.dispose=function(t){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),d.prototype.dispose.call(this,t)},e}(o.PostProcess);o.RefractionPostProcess=e}(e||(e={}));var e;!function(r){var e=function(l){function e(e,d,i,r,n,o){var s=l.call(this,e,'blackAndWhite',['degree'],null,d,i,r,n,o)||this;return s.degree=1,s.onApplyObservable.add(function(t){t.setFloat('degree',s.degree)}),s}return h(e,l),e}(r.PostProcess);r.BlackAndWhitePostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===l&&(l=d.Engine.TEXTURETYPE_UNSIGNED_INT);var u=e.call(this,t,'convolution',['kernel','screenSize'],null,r,n,o,s,a,null,l)||this;return u.kernel=p,u.onApply=function(t){t.setFloat2('screenSize',u.width,u.height),t.setArray('kernel',u.kernel)},u}return h(t,e),t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],t}(d.PostProcess);d.ConvolutionPostProcess=e}(e||(e={}));var e;!function(r){var e=function(d){function e(e,c,i,r,n,o,s){var a=d.call(this,e,'filter',['kernelMatrix'],null,i,r,n,o,s)||this;return a.kernelMatrix=c,a.onApply=function(t){t.setMatrix('kernelMatrix',a.kernelMatrix)},a}return h(e,d),e}(r.PostProcess);r.FilterPostProcess=e}(e||(e={}));var e;!function(d){var e=function(p){function e(t,r,i,o,n,a,s,l,c){void 0===n&&(n=100),void 0===a&&(a=d.Texture.BILINEAR_SAMPLINGMODE);var u=p.call(this,t,'volumetricLightScattering',['decay','exposure','weight','meshPositionOnScreen','density'],['lightScatteringSampler'],r.postProcessRatio||r,i,a,s,l,'#define NUM_SAMPLES '+n)||this;return u._screenCoordinates=d.Vector2.Zero(),u.customMeshPosition=d.Vector3.Zero(),u.useCustomMeshPosition=!1,u.invert=!0,u.excludedMeshes=[],u.exposure=.3,u.decay=.96815,u.weight=.58767,u.density=.926,c=null===i?c:i.getScene(),s=c.getEngine(),u._viewPort=new d.Viewport(0,0,1,1).toGlobal(s.getRenderWidth(),s.getRenderHeight()),u.mesh=null===o?e.CreateDefaultMesh('VolumetricLightScatteringMesh',c):o,u._createPass(c,r.passRatio||r),u.onActivate=function(t){u.isSupported||u.dispose(t),u.onActivate=null},u.onApplyObservable.add(function(t){u._updateMeshScreenCoordinates(c),t.setTexture('lightScatteringSampler',u._volumetricLightScatteringRTT),t.setFloat('exposure',u.exposure),t.setFloat('decay',u.decay),t.setFloat('weight',u.weight),t.setFloat('density',u.density),t.setVector2('meshPositionOnScreen',u._screenCoordinates)}),u}return h(e,p),Object.defineProperty(e.prototype,'useDiffuseColor',{get:function(){return d.Tools.Warn('VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead'),!1},set:function(){d.Tools.Warn('VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead')},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'VolumetricLightScatteringPostProcess'},e.prototype._isReady=function(e,t){var i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);var r=[],n=[d.VertexBuffer.PositionKind],o=e.getMaterial();o&&(o.needAlphaTesting()&&r.push('#define ALPHATEST'),i.isVerticesDataPresent(d.VertexBuffer.UVKind)&&(n.push(d.VertexBuffer.UVKind),r.push('#define UV1')),i.isVerticesDataPresent(d.VertexBuffer.UV2Kind)&&(n.push(d.VertexBuffer.UV2Kind),r.push('#define UV2'))),i.useBones&&i.computeBonesUsingShaders?(n.push(d.VertexBuffer.MatricesIndicesKind),n.push(d.VertexBuffer.MatricesWeightsKind),r.push('#define NUM_BONE_INFLUENCERS '+i.numBoneInfluencers),r.push('#define BonesPerMesh '+(i.skeleton?i.skeleton.bones.length+1:0))):r.push('#define NUM_BONE_INFLUENCERS 0'),t&&(r.push('#define INSTANCES'),n.push('world0'),n.push('world1'),n.push('world2'),n.push('world3'));var s=r.join('\n');return this._cachedDefines!==s&&(this._cachedDefines=s,this._volumetricLightScatteringPass=i.getScene().getEngine().createEffect({vertexElement:'depth',fragmentElement:'volumetricLightScatteringPass'},n,['world','mBones','viewProjection','diffuseMatrix'],['diffuseSampler'],s)),this._volumetricLightScatteringPass.isReady()},e.prototype.setCustomMeshPosition=function(t){this.customMeshPosition=t},e.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},e.prototype.dispose=function(t){var e=t.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==e&&t.getScene().customRenderTargets.splice(e,1),this._volumetricLightScatteringRTT.dispose(),p.prototype.dispose.call(this,t)},e.prototype.getPass=function(){return this._volumetricLightScatteringRTT},e.prototype._meshExcluded=function(t){return 0<this.excludedMeshes.length&&-1!==this.excludedMeshes.indexOf(t)},e.prototype._createPass=function(e,t){var p=this,r=e.getEngine();this._volumetricLightScatteringRTT=new d.RenderTargetTexture('volumetricLightScatteringMap',{width:r.getRenderWidth()*t,height:r.getRenderHeight()*t},e,!1,!0,d.Engine.TEXTURETYPE_UNSIGNED_INT),this._volumetricLightScatteringRTT.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;var i=this.getCamera();i?i.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);var n=function(e){var t=e.getRenderingMesh();if(!p._meshExcluded(t)){var r=e.getMaterial();if(r){var i=t.getScene(),o=i.getEngine();o.setState(r.backFaceCulling);var n=t._getInstancesRenderList(e._id);if(!n.mustReturn){var a=o.getCaps().instancedArrays&&null!==n.visibleInstances[e._id];if(p._isReady(e,a)){var s=p._volumetricLightScatteringPass;if(t===p.mesh&&(s=e.effect?e.effect:r.getEffect()),o.enableEffect(s),t._bind(e,s,d.Material.TriangleFillMode),t===p.mesh)r.bind(t.getWorldMatrix(),t);else{if(p._volumetricLightScatteringPass.setMatrix('viewProjection',i.getTransformMatrix()),r&&r.needAlphaTesting()){var l=r.getAlphaTestTexture();p._volumetricLightScatteringPass.setTexture('diffuseSampler',l),l&&p._volumetricLightScatteringPass.setMatrix('diffuseMatrix',l.getTextureMatrix())}t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&p._volumetricLightScatteringPass.setMatrices('mBones',t.skeleton.getTransformMatrices(t))}t._processRendering(e,p._volumetricLightScatteringPass,d.Material.TriangleFillMode,n,a,function(r,e){return s.setMatrix('world',e)})}}}}},o=new d.Color4(0,0,0,1),a;this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){a=e.clearColor,e.clearColor=o}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=a}),this._volumetricLightScatteringRTT.customRenderFunction=function(t,i,r,a){var o=e.getEngine(),l;if(a.length){for(o.setColorWrite(!1),l=0;l<a.length;l++)n(a.data[l]);o.setColorWrite(!0)}for(l=0;l<t.length;l++)n(t.data[l]);for(l=0;l<i.length;l++)n(i.data[l]);if(r.length){for(l=0;l<r.length;l++){var s=r.data[l],p=s.getBoundingInfo();p&&e.activeCamera&&(s._alphaIndex=s.getMesh().alphaIndex,s._distanceToCamera=p.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}var c=r.data.slice(0,r.length);for(c.sort(function(r,e){return r._alphaIndex>e._alphaIndex?1:r._alphaIndex<e._alphaIndex?-1:r._distanceToCamera<e._distanceToCamera?1:r._distanceToCamera>e._distanceToCamera?-1:0}),o.setAlphaMode(d.Engine.ALPHA_COMBINE),l=0;l<c.length;l++)n(c[l]);o.setAlphaMode(d.Engine.ALPHA_DISABLE)}}},e.prototype._updateMeshScreenCoordinates=function(e){var t=e.getTransformMatrix(),r;r=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var o=d.Vector3.Project(r,d.Matrix.Identity(),t,this._viewPort);this._screenCoordinates.x=o.x/this._viewPort.width,this._screenCoordinates.y=o.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},e.CreateDefaultMesh=function(e,t){var o=d.Mesh.CreatePlane(e,1,t);o.billboardMode=d.AbstractMesh.BILLBOARDMODE_ALL;var r=new d.StandardMaterial(e+'Material',t);return r.emissiveColor=new d.Color3(1,1,1),o.material=r,o},g([d.serializeAsVector3()],e.prototype,'customMeshPosition',void 0),g([d.serialize()],e.prototype,'useCustomMeshPosition',void 0),g([d.serialize()],e.prototype,'invert',void 0),g([d.serializeAsMeshReference()],e.prototype,'mesh',void 0),g([d.serialize()],e.prototype,'excludedMeshes',void 0),g([d.serialize()],e.prototype,'exposure',void 0),g([d.serialize()],e.prototype,'decay',void 0),g([d.serialize()],e.prototype,'weight',void 0),g([d.serialize()],e.prototype,'density',void 0),e}(d.PostProcess);d.VolumetricLightScatteringPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,c,r,n,o,s,a){var l=e.call(this,t,'colorCorrection',null,['colorTable'],r,n,o,s,a)||this;return l._colorTableTexture=new d.Texture(c,n.getScene(),!0,!1,d.Texture.TRILINEAR_SAMPLINGMODE),l._colorTableTexture.anisotropicFilteringLevel=1,l._colorTableTexture.wrapU=d.Texture.CLAMP_ADDRESSMODE,l._colorTableTexture.wrapV=d.Texture.CLAMP_ADDRESSMODE,l.onApply=function(t){t.setTexture('colorTable',l._colorTableTexture)},l}return h(t,e),t}(d.PostProcess);d.ColorCorrectionPostProcess=e}(e||(e={}));var e;!function(d){var e;!function(t){t[t.Hable=0]='Hable',t[t.Reinhard=1]='Reinhard',t[t.HejiDawson=2]='HejiDawson',t[t.Photographic=3]='Photographic'}(e=d.TonemappingOperator||(d.TonemappingOperator={}));var t=function(t){function o(i,p,n,o,s,a,l){void 0===s&&(s=d.Texture.BILINEAR_SAMPLINGMODE),void 0===l&&(l=d.Engine.TEXTURETYPE_UNSIGNED_INT);var f=t.call(this,i,'tonemap',['_ExposureAdjustment'],null,1,o,s,a,!0,null,l)||this;f._operator=p,f.exposureAdjustment=n;var c='#define ';return f._operator===e.Hable?c+='HABLE_TONEMAPPING':f._operator===e.Reinhard?c+='REINHARD_TONEMAPPING':f._operator===e.HejiDawson?c+='OPTIMIZED_HEJIDAWSON_TONEMAPPING':f._operator===e.Photographic&&(c+='PHOTOGRAPHIC_TONEMAPPING'),f.updateEffect(c),f.onApply=function(t){t.setFloat('_ExposureAdjustment',f.exposureAdjustment)},f}return h(o,t),o}(d.PostProcess);d.TonemapPostProcess=t}(e||(e={}));var e;!function(r){var e=function(a){function e(e,l,i,r,n,o){return a.call(this,e,'displayPass',['passSampler'],['passSampler'],l,i,r,n,o)||this}return h(e,a),e}(r.PostProcess);r.DisplayPassPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,c,r,n,o,s,a){return void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT),e.call(this,t,'highlights',null,null,c,r,n,o,s,null,a)||this}return h(t,e),t}(d.PostProcess);d.HighlightsPostProcess=e}(e||(e={}));var e;!function(d){var e=function(p){function e(e,t,r,n,o,s,a,l){void 0===r&&(r=null),void 0===a&&(a=d.Engine.TEXTURETYPE_UNSIGNED_INT);var u=p.call(this,e,'imageProcessing',[],[],t,r,n,o,s,null,a,'postprocess',null,!0)||this;return u._fromLinearSpace=!0,u._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1},l?(l.applyByPostProcess=!0,u._attachImageProcessingConfiguration(l,!0),u.fromLinearSpace=!1):(u._attachImageProcessingConfiguration(null,!0),u.imageProcessingConfiguration.applyByPostProcess=!0),u.onApply=function(t){u.imageProcessingConfiguration.bind(t,u.aspectRatio)},u}return h(e,p),Object.defineProperty(e.prototype,'imageProcessingConfiguration',{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t)},enumerable:!0,configurable:!0}),e.prototype._attachImageProcessingConfiguration=function(e,t){var i=this;if(void 0===t&&(t=!1),e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{var r=null,n=this.getEngine(),o=this.getCamera();if(o)r=o.getScene();else if(n&&n.scenes){var s=n.scenes;r=s[s.length-1]}else r=d.Engine.LastCreatedScene;this._imageProcessingConfiguration=r.imageProcessingConfiguration}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._updateParameters()}),t||this._updateParameters()}},Object.defineProperty(e.prototype,'colorCurves',{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(t){this.imageProcessingConfiguration.colorCurves=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'colorCurvesEnabled',{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'colorGradingTexture',{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(t){this.imageProcessingConfiguration.colorGradingTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'colorGradingEnabled',{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'exposure',{get:function(){return this.imageProcessingConfiguration.exposure},set:function(t){this.imageProcessingConfiguration.exposure=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'toneMappingEnabled',{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'contrast',{get:function(){return this.imageProcessingConfiguration.contrast},set:function(t){this.imageProcessingConfiguration.contrast=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteStretch',{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(t){this.imageProcessingConfiguration.vignetteStretch=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteCentreX',{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(t){this.imageProcessingConfiguration.vignetteCentreX=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteCentreY',{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(t){this.imageProcessingConfiguration.vignetteCentreY=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteWeight',{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(t){this.imageProcessingConfiguration.vignetteWeight=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteColor',{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(t){this.imageProcessingConfiguration.vignetteColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteCameraFov',{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(t){this.imageProcessingConfiguration.vignetteCameraFov=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteBlendMode',{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(t){this.imageProcessingConfiguration.vignetteBlendMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vignetteEnabled',{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(t){this.imageProcessingConfiguration.vignetteEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'fromLinearSpace',{get:function(){return this._fromLinearSpace},set:function(t){this._fromLinearSpace!==t&&(this._fromLinearSpace=t,this._updateParameters())},enumerable:!0,configurable:!0}),e.prototype.getClassName=function(){return'ImageProcessingPostProcess'},e.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);var e='';for(var t in this._defines)this._defines[t]&&(e+='#define '+t+';\r\n');var o=['textureSampler'];d.ImageProcessingConfiguration.PrepareSamplers(o,this._defines);var r=['scale'];d.ImageProcessingConfiguration.PrepareUniforms(r,this._defines),this.updateEffect(e,r,o)},e.prototype.dispose=function(t){p.prototype.dispose.call(this,t),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this.imageProcessingConfiguration.applyByPostProcess=!1},g([d.serialize()],e.prototype,'_fromLinearSpace',void 0),e}(d.PostProcess);d.ImageProcessingPostProcess=e}(e||(e={}));var e;!function(T){var e=function(e){function p(t,d,r,n,o,s,a){void 0===r&&(r=null),void 0===n&&(n=null),void 0===o&&(o=null),void 0===s&&(s=null),void 0===a&&(a=null);var l=e.call(this,t,d.getScene())||this;return l.name=t,l.children=[],l.animations=[],l._index=null,l._absoluteTransform=new T.Matrix,l._invertedAbsoluteTransform=new T.Matrix,l._scalingDeterminant=1,l._worldTransform=new T.Matrix,l._needToDecompose=!0,l._needToCompose=!1,l._skeleton=d,l._localMatrix=n?n.clone():T.Matrix.Identity(),l._restPose=o||l._localMatrix.clone(),l._baseMatrix=s||l._localMatrix.clone(),l._index=a,d.bones.push(l),l.setParent(r,!1),(s||n)&&l._updateDifferenceMatrix(),l}return h(p,e),Object.defineProperty(p.prototype,'_matrix',{get:function(){return this._compose(),this._localMatrix},set:function(t){this._localMatrix.copyFrom(t),this._needToDecompose=!0},enumerable:!0,configurable:!0}),p.prototype.getSkeleton=function(){return this._skeleton},p.prototype.getParent=function(){return this._parent},p.prototype.setParent=function(r,e){if(void 0===e&&(e=!0),this._parent!==r){if(this._parent){var t=this._parent.children.indexOf(this);-1!==t&&this._parent.children.splice(t,1)}this._parent=r,this._parent&&this._parent.children.push(this),e&&this._updateDifferenceMatrix(),this.markAsDirty()}},p.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},p.prototype.getBaseMatrix=function(){return this._baseMatrix},p.prototype.getRestPose=function(){return this._restPose},p.prototype.getWorldMatrix=function(){return this._worldTransform},p.prototype.returnToRest=function(){this.updateMatrix(this._restPose.clone())},p.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},p.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},Object.defineProperty(p.prototype,'position',{get:function(){return this._decompose(),this._localPosition},set:function(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose()},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'rotation',{get:function(){return this.getRotation()},set:function(t){this.setRotation(t)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'rotationQuaternion',{get:function(){return this._decompose(),this._localRotation},set:function(t){this.setRotationQuaternion(t)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'scaling',{get:function(){return this.getScale()},set:function(t){this.setScale(t)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'animationPropertiesOverride',{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!0,configurable:!0}),p.prototype._decompose=function(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=T.Vector3.Zero(),this._localRotation=T.Quaternion.Zero(),this._localPosition=T.Vector3.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},p.prototype._compose=function(){this._needToCompose&&(this._needToCompose=!1,T.Matrix.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix))},p.prototype.updateMatrix=function(r,e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this._baseMatrix.copyFrom(r),e&&this._updateDifferenceMatrix(),t?(this._localMatrix.copyFrom(r),this._markAsDirtyAndDecompose()):this.markAsDirty()},p.prototype._updateDifferenceMatrix=function(r,e){if(void 0===e&&(e=!0),r||(r=this._baseMatrix),this._parent?r.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(r),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),e)for(var t=0;t<this.children.length;t++)this.children[t]._updateDifferenceMatrix();this._scalingDeterminant=0>this._absoluteTransform.determinant()?-1:1},p.prototype.markAsDirty=function(){this._currentRenderId++,this._childRenderId++,this._skeleton._markAsDirty()},p.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},p.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},p.prototype.copyAnimationRange=function(e,t,i,r,n){void 0===r&&(r=!1),void 0===n&&(n=null),0===this.animations.length&&(this.animations.push(new T.Animation(this.name,'_matrix',e.animations[0].framePerSecond,T.Animation.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var o=e.animations[0].getRange(t);if(!o)return!1;for(var E=o.from,c=o.to,u=e.animations[0].getKeys(),f=e.length,d=e.getParent(),p=this.getParent(),P=r&&d&&f&&this.length&&f!==this.length,m=P&&p&&d?p.length/d.length:1,g=r&&!p&&n&&(1!==n.x||1!==n.y||1!==n.z),v=this.animations[0].getKeys(),y=0,b=u.length,x,a,l;y<b;y++)x=u[y],x.frame>=E&&x.frame<=c&&(r?(l=x.value.clone(),P?(a=l.getTranslation(),l.setTranslation(a.scaleInPlace(m))):g&&n?(a=l.getTranslation(),l.setTranslation(a.multiplyInPlace(n))):l=x.value):l=x.value,v.push({frame:x.frame+i,value:l}));return this.animations[0].createRange(t,E+i,c+i),!0},p.prototype.translate=function(e,t,r){void 0===t&&(t=T.Space.LOCAL);var i=this.getLocalMatrix();if(t==T.Space.LOCAL)i.m[12]+=e.x,i.m[13]+=e.y,i.m[14]+=e.z;else{var o=null;r&&(o=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=p._tmpMats[0],a=p._tmpVecs[0];this._parent&&(r&&o?(n.copyFrom(this._parent.getAbsoluteTransform()),n.multiplyToRef(o,n)):n.copyFrom(this._parent.getAbsoluteTransform())),n.m[12]=0,n.m[13]=0,n.m[14]=0,n.invert(),T.Vector3.TransformCoordinatesToRef(e,n,a),i.m[12]+=a.x,i.m[13]+=a.y,i.m[14]+=a.z}this._markAsDirtyAndDecompose()},p.prototype.setPosition=function(e,t,r){void 0===t&&(t=T.Space.LOCAL);var i=this.getLocalMatrix();if(t==T.Space.LOCAL)i.m[12]=e.x,i.m[13]=e.y,i.m[14]=e.z;else{var o=null;r&&(o=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=p._tmpMats[0],a=p._tmpVecs[0];this._parent&&(r&&o?(n.copyFrom(this._parent.getAbsoluteTransform()),n.multiplyToRef(o,n)):n.copyFrom(this._parent.getAbsoluteTransform())),n.invert(),T.Vector3.TransformCoordinatesToRef(e,n,a),i.m[12]=a.x,i.m[13]=a.y,i.m[14]=a.z}this._markAsDirtyAndDecompose()},p.prototype.setAbsolutePosition=function(e,t){this.setPosition(e,T.Space.WORLD,t)},p.prototype.scale=function(e,t,r,i){void 0===i&&(i=!1);var o=this.getLocalMatrix(),n=p._tmpMats[0];T.Matrix.ScalingToRef(e,t,r,n),n.multiplyToRef(o,o),n.invert();for(var a=0,s=this.children;a<s.length;a++){var l=s[a],c=l.getLocalMatrix();c.multiplyToRef(n,c),c.m[12]*=e,c.m[13]*=t,c.m[14]*=r,l._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),i)for(var u=0,f=this.children,l;u<f.length;u++)l=f[u],l.scale(e,t,r,i)},p.prototype.setScale=function(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose()},p.prototype.getScale=function(){return this._decompose(),this._localScaling},p.prototype.getScaleToRef=function(t){this._decompose(),t.copyFrom(this._localScaling)},p.prototype.setYawPitchRoll=function(e,t,r,i,o){if(void 0===i&&(i=T.Space.LOCAL),i===T.Space.LOCAL){var n=p._tmpQuat;return T.Quaternion.RotationYawPitchRollToRef(e,t,r,n),void this.setRotationQuaternion(n,i,o)}var a=p._tmpMats[0];if(this._getNegativeRotationToRef(a,o)){var s=p._tmpMats[1];T.Matrix.RotationYawPitchRollToRef(e,t,r,s),a.multiplyToRef(s,s),this._rotateWithMatrix(s,i,o)}},p.prototype.rotate=function(e,t,r,i){void 0===r&&(r=T.Space.LOCAL);var o=p._tmpMats[0];o.m[12]=0,o.m[13]=0,o.m[14]=0,T.Matrix.RotationAxisToRef(e,t,o),this._rotateWithMatrix(o,r,i)},p.prototype.setAxisAngle=function(e,t,r,i){if(void 0===r&&(r=T.Space.LOCAL),r===T.Space.LOCAL){var o=p._tmpQuat;return T.Quaternion.RotationAxisToRef(e,t,o),void this.setRotationQuaternion(o,r,i)}var n=p._tmpMats[0];if(this._getNegativeRotationToRef(n,i)){var a=p._tmpMats[1];T.Matrix.RotationAxisToRef(e,t,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,r,i)}},p.prototype.setRotation=function(e,t,o){void 0===t&&(t=T.Space.LOCAL),this.setYawPitchRoll(e.y,e.x,e.z,t,o)},p.prototype.setRotationQuaternion=function(e,t,r){if(void 0===t&&(t=T.Space.LOCAL),t===T.Space.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();var i=p._tmpMats[0];if(this._getNegativeRotationToRef(i,r)){var o=p._tmpMats[1];T.Matrix.FromQuaternionToRef(e,o),i.multiplyToRef(o,o),this._rotateWithMatrix(o,t,r)}},p.prototype.setRotationMatrix=function(e,t,r){if(void 0===t&&(t=T.Space.LOCAL),t===T.Space.LOCAL){var i=p._tmpQuat;return T.Quaternion.FromRotationMatrixToRef(e,i),void this.setRotationQuaternion(i,t,r)}var o=p._tmpMats[0];if(this._getNegativeRotationToRef(o,r)){var n=p._tmpMats[1];n.copyFrom(e),o.multiplyToRef(e,n),this._rotateWithMatrix(n,t,r)}},p.prototype._rotateWithMatrix=function(e,t,r){void 0===t&&(t=T.Space.LOCAL);var i=this.getLocalMatrix(),o=i.m[12],n=i.m[13],a=i.m[14],s=this.getParent(),l=p._tmpMats[3],d=p._tmpMats[4];s&&t==T.Space.WORLD?(r?(l.copyFrom(r.getWorldMatrix()),s.getAbsoluteTransform().multiplyToRef(l,l)):l.copyFrom(s.getAbsoluteTransform()),d.copyFrom(l),d.invert(),i.multiplyToRef(l,i),i.multiplyToRef(e,i),i.multiplyToRef(d,i)):t==T.Space.WORLD&&r?(l.copyFrom(r.getWorldMatrix()),d.copyFrom(l),d.invert(),i.multiplyToRef(l,i),i.multiplyToRef(e,i),i.multiplyToRef(d,i)):i.multiplyToRef(e,i),i.m[12]=o,i.m[13]=n,i.m[14]=a,this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},p.prototype._getNegativeRotationToRef=function(e,t){var r=p._tmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t&&(e.multiplyToRef(t.getWorldMatrix(),e),T.Matrix.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,r)),e.invert(),!isNaN(e.m[0])&&(r.m[0]*=this._scalingDeterminant,e.multiplyToRef(r,e),!0)},p.prototype.getPosition=function(e,t){void 0===e&&(e=T.Space.LOCAL),void 0===t&&(t=null);var o=T.Vector3.Zero();return this.getPositionToRef(e,t,o),o},p.prototype.getPositionToRef=function(e,t,r){if(void 0===e&&(e=T.Space.LOCAL),e==T.Space.LOCAL){var i=this.getLocalMatrix();r.x=i.m[12],r.y=i.m[13],r.z=i.m[14]}else{var o=null;t&&(o=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=p._tmpMats[0];t&&o?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(o,n)):n=this.getAbsoluteTransform(),r.x=n.m[12],r.y=n.m[13],r.z=n.m[14]}},p.prototype.getAbsolutePosition=function(e){void 0===e&&(e=null);var t=T.Vector3.Zero();return this.getPositionToRef(T.Space.WORLD,e,t),t},p.prototype.getAbsolutePositionToRef=function(e,t){this.getPositionToRef(T.Space.WORLD,e,t)},p.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this._parent)this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var o=this._skeleton.getPoseMatrix();o&&this._absoluteTransform.multiplyToRef(o,this._absoluteTransform)}for(var e=this.children,t=e.length,i=0;i<t;i++)e[i].computeAbsoluteTransforms()},p.prototype.getDirection=function(e,t){void 0===t&&(t=null);var o=T.Vector3.Zero();return this.getDirectionToRef(e,t,o),o},p.prototype.getDirectionToRef=function(e,t,r){void 0===t&&(t=null);var i=null;t&&(i=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=p._tmpMats[0];o.copyFrom(this.getAbsoluteTransform()),t&&i&&o.multiplyToRef(i,o),T.Vector3.TransformNormalToRef(e,o,r),r.normalize()},p.prototype.getRotation=function(e,t){void 0===e&&(e=T.Space.LOCAL),void 0===t&&(t=null);var o=T.Vector3.Zero();return this.getRotationToRef(e,t,o),o},p.prototype.getRotationToRef=function(e,t,r){void 0===e&&(e=T.Space.LOCAL),void 0===t&&(t=null);var i=p._tmpQuat;this.getRotationQuaternionToRef(e,t,i),i.toEulerAnglesToRef(r)},p.prototype.getRotationQuaternion=function(e,t){void 0===e&&(e=T.Space.LOCAL),void 0===t&&(t=null);var o=T.Quaternion.Identity();return this.getRotationQuaternionToRef(e,t,o),o},p.prototype.getRotationQuaternionToRef=function(e,t,r){if(void 0===e&&(e=T.Space.LOCAL),void 0===t&&(t=null),e==T.Space.LOCAL)this._decompose(),r.copyFrom(this._localRotation);else{var i=p._tmpMats[0],o=this.getAbsoluteTransform();t?o.multiplyToRef(t.getWorldMatrix(),i):i.copyFrom(o),i.m[0]*=this._scalingDeterminant,i.m[1]*=this._scalingDeterminant,i.m[2]*=this._scalingDeterminant,i.decompose(void 0,r,void 0)}},p.prototype.getRotationMatrix=function(e,t){void 0===e&&(e=T.Space.LOCAL);var o=T.Matrix.Identity();return this.getRotationMatrixToRef(e,t,o),o},p.prototype.getRotationMatrixToRef=function(e,t,r){if(void 0===e&&(e=T.Space.LOCAL),e==T.Space.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(r);else{var i=p._tmpMats[0],o=this.getAbsoluteTransform();t?o.multiplyToRef(t.getWorldMatrix(),i):i.copyFrom(o),i.m[0]*=this._scalingDeterminant,i.m[1]*=this._scalingDeterminant,i.m[2]*=this._scalingDeterminant,i.getRotationMatrixToRef(r)}},p.prototype.getAbsolutePositionFromLocal=function(e,t){void 0===t&&(t=null);var o=T.Vector3.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,o),o},p.prototype.getAbsolutePositionFromLocalToRef=function(e,t,r){void 0===t&&(t=null);var i=null;t&&(i=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=p._tmpMats[0];t&&i?(o.copyFrom(this.getAbsoluteTransform()),o.multiplyToRef(i,o)):o=this.getAbsoluteTransform(),T.Vector3.TransformCoordinatesToRef(e,o,r)},p.prototype.getLocalPositionFromAbsolute=function(e,t){void 0===t&&(t=null);var o=T.Vector3.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,o),o},p.prototype.getLocalPositionFromAbsoluteToRef=function(e,t,r){void 0===t&&(t=null);var i=null;t&&(i=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=p._tmpMats[0];o.copyFrom(this.getAbsoluteTransform()),t&&i&&o.multiplyToRef(i,o),o.invert(),T.Vector3.TransformCoordinatesToRef(e,o,r)},p._tmpVecs=[T.Vector3.Zero(),T.Vector3.Zero()],p._tmpQuat=T.Quaternion.Identity(),p._tmpMats=[T.Matrix.Identity(),T.Matrix.Identity(),T.Matrix.Identity(),T.Matrix.Identity(),T.Matrix.Identity()],p}(T.Node);T.Bone=e}(e||(e={}));var e;!function(E){var e=function(){function e(e,d,i){if(this.targetPosition=E.Vector3.Zero(),this.poleTargetPosition=E.Vector3.Zero(),this.poleTargetLocalOffset=E.Vector3.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=E.Quaternion.Identity(),this._bone1Mat=E.Matrix.Identity(),this._bone2Ang=V,this._maxAngle=V,this._rightHandedSystem=!1,this._bendAxis=E.Vector3.Right(),this._slerping=!1,this._adjustRoll=0,this._bone2=d,this._bone1=d.getParent(),this._bone1){this.mesh=e;var r=d.getPosition();if(0<d.getAbsoluteTransform().determinant()&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=.5*V,this._bendAxis.z=1)),this._bone1.length){var n=this._bone1.getScale(),o=this._bone2.getScale();this._bone1Length=this._bone1.length*n.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*o.y*this.mesh.scaling.y}else if(this._bone1.children[0]){e.computeWorldMatrix(!0);var s=this._bone2.children[0].getAbsolutePosition(e),a=this._bone2.getAbsolutePosition(e),l=this._bone1.getAbsolutePosition(e);this._bone1Length=E.Vector3.Distance(s,a),this._bone2Length=E.Vector3.Distance(a,l)}this._bone1.getRotationMatrixToRef(E.Space.WORLD,e,this._bone1Mat),this.maxAngle=V,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}}return Object.defineProperty(e.prototype,'maxAngle',{get:function(){return this._maxAngle},set:function(t){this._setMaxAngle(t)},enumerable:!0,configurable:!0}),e.prototype._setMaxAngle=function(r){0>r&&(r=0),(r>V||void 0==r)&&(r=V),this._maxAngle=r;var e=this._bone1Length,t=this._bone2Length;this._maxReach=$(e*e+t*t-2*e*t*F(r))},e.prototype.update=function(){var t=this._bone1;if(t){var i=this.targetPosition,r=this.poleTargetPosition,n=e._tmpMats[0],o=e._tmpMats[1];this.targetMesh&&i.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,r):this.poleTargetMesh&&E.Vector3.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),r);var s=e._tmpVecs[0],a=e._tmpVecs[1],l=e._tmpVecs[2],h=e._tmpVecs[3],c=e._tmpVecs[4],u=e._tmpQuat;t.getAbsolutePositionToRef(this.mesh,s),r.subtractToRef(s,c),0==c.x&&0==c.y&&0==c.z?c.y=1:c.normalize(),i.subtractToRef(s,h),h.normalize(),E.Vector3.CrossToRef(h,c,a),a.normalize(),E.Vector3.CrossToRef(h,a,l),l.normalize(),E.Matrix.FromXYZAxesToRef(l,h,a,n);var f=this._bone1Length,d=this._bone2Length,p=E.Vector3.Distance(s,i);0<this._maxReach&&(p=C(this._maxReach,p));var _=(d*d+p*p-f*f)/(2*d*p),m=(p*p+f*f-d*d)/(2*p*f);1<_&&(_=1),1<m&&(m=1),-1>_&&(_=-1),-1>m&&(m=-1);var g=T(_),P=T(m),A=-g-P;if(this._rightHandedSystem)E.Matrix.RotationYawPitchRollToRef(0,0,this._adjustRoll,o),o.multiplyToRef(n,n),E.Matrix.RotationAxisToRef(this._bendAxis,P,o),o.multiplyToRef(n,n);else{var b=e._tmpVecs[5];b.copyFrom(this._bendAxis),b.x*=-1,E.Matrix.RotationAxisToRef(b,-P,o),o.multiplyToRef(n,n)}this.poleAngle&&(E.Matrix.RotationAxisToRef(h,this.poleAngle,o),n.multiplyToRef(o,n)),this._bone1&&(1>this.slerpAmount?(this._slerping||E.Quaternion.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),E.Quaternion.FromRotationMatrixToRef(n,u),E.Quaternion.SlerpToRef(this._bone1Quat,u,this.slerpAmount,this._bone1Quat),A=this._bone2Ang*(1-this.slerpAmount)+A*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,E.Space.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(n,E.Space.WORLD,this.mesh),this._bone1Mat.copyFrom(n),this._slerping=!1)),this._bone2.setAxisAngle(this._bendAxis,A,E.Space.LOCAL),this._bone2Ang=A}},e._tmpVecs=[E.Vector3.Zero(),E.Vector3.Zero(),E.Vector3.Zero(),E.Vector3.Zero(),E.Vector3.Zero(),E.Vector3.Zero()],e._tmpQuat=E.Quaternion.Identity(),e._tmpMats=[E.Matrix.Identity(),E.Matrix.Identity()],e}();E.BoneIKController=e}(e||(e={}));var e;!function(O){var e=function(){function e(e,l,i,r){if(this.upAxis=O.Vector3.Up(),this.upAxisSpace=O.Space.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=O.Quaternion.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=O.Vector3.Forward(),this.mesh=e,this.bone=l,this.target=i,r&&(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),this.maxYaw=null==r.maxYaw?V:r.maxYaw,this.minYaw=null==r.minYaw?-V:r.minYaw,this.maxPitch=null==r.maxPitch?V:r.maxPitch,this.minPitch=null==r.minPitch?-V:r.minPitch,null!=r.slerpAmount&&(this.slerpAmount=r.slerpAmount),null!=r.upAxis&&(this.upAxis=r.upAxis),null!=r.upAxisSpace&&(this.upAxisSpace=r.upAxisSpace),null!=r.yawAxis||null!=r.pitchAxis)){var n=O.Axis.Y,o=O.Axis.X;null!=r.yawAxis&&(n=r.yawAxis.clone(),n.normalize()),null!=r.pitchAxis&&(o=r.pitchAxis.clone(),o.normalize());var s=O.Vector3.Cross(o,n);this._transformYawPitch=O.Matrix.Identity(),O.Matrix.FromXYZAxesToRef(o,n,s,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}l.getParent()||this.upAxisSpace!=O.Space.BONE||(this.upAxisSpace=O.Space.LOCAL)}return Object.defineProperty(e.prototype,'minYaw',{get:function(){return this._minYaw},set:function(t){this._minYaw=t,this._minYawSin=B(t),this._minYawCos=F(t),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'maxYaw',{get:function(){return this._maxYaw},set:function(t){this._maxYaw=t,this._maxYawSin=B(t),this._maxYawCos=F(t),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'minPitch',{get:function(){return this._minPitch},set:function(t){this._minPitch=t,this._minPitchTan=y(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'maxPitch',{get:function(){return this._maxPitch},set:function(t){this._maxPitch=t,this._maxPitchTan=y(t)},enumerable:!0,configurable:!0}),e.prototype.update=function(){if(1>this.slerpAmount&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);var t=this.bone,i=e._tmpVecs[0];t.getAbsolutePositionToRef(this.mesh,i);var r=this.target,n=e._tmpMats[0],o=e._tmpMats[1],s=this.mesh,a=t.getParent(),l=e._tmpVecs[1];l.copyFrom(this.upAxis),this.upAxisSpace==O.Space.BONE&&a?(this._transformYawPitch&&O.Vector3.TransformCoordinatesToRef(l,this._transformYawPitchInv,l),a.getDirectionToRef(l,this.mesh,l)):this.upAxisSpace==O.Space.LOCAL&&(s.getDirectionToRef(l,l),1==s.scaling.x&&1==s.scaling.y&&1==s.scaling.z||l.normalize());var h=!1,c=!1;if(this._maxYaw==V&&this._minYaw==-V||(h=!0),this._maxPitch==V&&this._minPitch==-V||(c=!0),h||c){var u=e._tmpMats[2],f=e._tmpMats[3];if(this.upAxisSpace==O.Space.BONE&&1==l.y&&a)a.getRotationMatrixToRef(O.Space.WORLD,this.mesh,u);else if(this.upAxisSpace!=O.Space.LOCAL||1!=l.y||a){var d=e._tmpVecs[2];d.copyFrom(this._fowardAxis),this._transformYawPitch&&O.Vector3.TransformCoordinatesToRef(d,this._transformYawPitchInv,d),a?a.getDirectionToRef(d,this.mesh,d):s.getDirectionToRef(d,d);var p=O.Vector3.Cross(l,d);p.normalize();var d=O.Vector3.Cross(p,l);O.Matrix.FromXYZAxesToRef(p,l,d,u)}else u.copyFrom(s.getWorldMatrix());u.invertToRef(f);var _=null;if(c){var m=e._tmpVecs[3];r.subtractToRef(i,m),O.Vector3.TransformCoordinatesToRef(m,f,m),_=$(m.x*m.x+m.z*m.z);var g=I(m.y,_),v=g;g>this._maxPitch?(m.y=this._maxPitchTan*_,v=this._maxPitch):g<this._minPitch&&(m.y=this._minPitchTan*_,v=this._minPitch),g!=v&&(O.Vector3.TransformCoordinatesToRef(m,u,m),m.addInPlace(i),r=m)}if(h){var m=e._tmpVecs[4];r.subtractToRef(i,m),O.Vector3.TransformCoordinatesToRef(m,f,m);var y=I(m.x,m.z),b=y;if((y>this._maxYaw||y<this._minYaw)&&(null==_&&(_=$(m.x*m.x+m.z*m.z)),this._yawRange>V?this._isAngleBetween(y,this._maxYaw,this._midYawConstraint)?(m.z=this._maxYawCos*_,m.x=this._maxYawSin*_,b=this._maxYaw):this._isAngleBetween(y,this._midYawConstraint,this._minYaw)&&(m.z=this._minYawCos*_,m.x=this._minYawSin*_,b=this._minYaw):y>this._maxYaw?(m.z=this._maxYawCos*_,m.x=this._maxYawSin*_,b=this._maxYaw):y<this._minYaw&&(m.z=this._minYawCos*_,m.x=this._minYawSin*_,b=this._minYaw)),this._slerping&&this._yawRange>V){var x=e._tmpVecs[8];x.copyFrom(O.Axis.Z),this._transformYawPitch&&O.Vector3.TransformCoordinatesToRef(x,this._transformYawPitchInv,x);var T=e._tmpMats[4];this._boneQuat.toRotationMatrix(T),this.mesh.getWorldMatrix().multiplyToRef(T,T),O.Vector3.TransformCoordinatesToRef(x,T,x),O.Vector3.TransformCoordinatesToRef(x,f,x);var E=I(x.x,x.z);if(this._getAngleBetween(E,y)>this._getAngleBetween(E,this._midYawConstraint)){null==_&&(_=$(m.x*m.x+m.z*m.z));var P=this._getAngleBetween(E,this._maxYaw);this._getAngleBetween(E,this._minYaw)<P?(b=E+.75*V,m.z=F(b)*_,m.x=B(b)*_):(b=E-.75*V,m.z=F(b)*_,m.x=B(b)*_)}}y!=b&&(O.Vector3.TransformCoordinatesToRef(m,u,m),m.addInPlace(i),r=m)}}var A=e._tmpVecs[5],M=e._tmpVecs[6],S=e._tmpVecs[7],C=e._tmpQuat;r.subtractToRef(i,A),A.normalize(),O.Vector3.CrossToRef(l,A,M),M.normalize(),O.Vector3.CrossToRef(A,M,S),S.normalize(),O.Matrix.FromXYZAxesToRef(M,S,A,n),0===M.x&&0===M.y&&0===M.z||0===S.x&&0===S.y&&0===S.z||0===A.x&&0===A.y&&0===A.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(O.Matrix.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,o),o.multiplyToRef(n,n)),1>this.slerpAmount?(this._slerping||this.bone.getRotationQuaternionToRef(O.Space.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(n,n),O.Quaternion.FromRotationMatrixToRef(n,C),O.Quaternion.SlerpToRef(this._boneQuat,C,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,O.Space.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(n,n),this.bone.setRotationMatrix(n,O.Space.WORLD,this.mesh),this._slerping=!1))},e.prototype._getAngleDiff=function(r,e){var t=e-r;return t%=2*V,t>V?t-=2*V:t<-V&&(t+=2*V),t},e.prototype._getAngleBetween=function(r,e){r%=2*V,r=0>r?r+2*V:r,e%=2*V,e=0>e?e+2*V:e;var t=0;return t=r<e?e-r:r-e,t>V&&(t=2*V-t),t},e.prototype._isAngleBetween=function(r,e,t){if(r%=2*V,r=0>r?r+2*V:r,e%=2*V,e=0>e?e+2*V:e,t%=2*V,t=0>t?t+2*V:t,e<t){if(r>e&&r<t)return!0;}else if(r>t&&r<e)return!0;return!1},e._tmpVecs=[O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero(),O.Vector3.Zero()],e._tmpQuat=O.Quaternion.Identity(),e._tmpMats=[O.Matrix.Identity(),O.Matrix.Identity(),O.Matrix.Identity(),O.Matrix.Identity(),O.Matrix.Identity()],e}();O.BoneLookController=e}(e||(e={}));var e;!function(p){var e=function(){function e(e,o,i){this.name=e,this.id=o,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=[],this._identity=p.Matrix.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this.doNotSerialize=!1,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new p.Observable,this.bones=[],this._scene=i||p.Engine.LastCreatedScene,i.skeletons.push(this),this._isDirty=!0}return Object.defineProperty(e.prototype,'animationPropertiesOverride',{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!0,configurable:!0}),e.prototype.getTransformMatrices=function(t){return this.needInitialSkinMatrix&&t._bonesTransformMatrices?t._bonesTransformMatrices:(this._transformMatrices||this.prepare(),this._transformMatrices)},e.prototype.getScene=function(){return this._scene},e.prototype.toString=function(o){var e='Name: '+this.name+', nBones: '+this.bones.length;if(e+=', nAnimationRanges: '+(this._ranges?Object.keys(this._ranges).length:'none'),o){e+=', Ranges: {';var t=!0;for(var i in this._ranges)t&&(e+=', ',t=!1),e+=i;e+='}'}return e},e.prototype.getBoneIndexByName=function(r){for(var e=0,t=this.bones.length;e<t;e++)if(this.bones[e].name===r)return e;return-1},e.prototype.createAnimationRange=function(e,t,i){if(!this._ranges[e]){this._ranges[e]=new p.AnimationRange(e,t,i);for(var r=0,a=this.bones.length;r<a;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}},e.prototype.deleteAnimationRange=function(o,e){void 0===e&&(e=!0);for(var t=0,i=this.bones.length;t<i;t++)this.bones[t].animations[0]&&this.bones[t].animations[0].deleteRange(o,e);this._ranges[o]=null},e.prototype.getAnimationRange=function(t){return this._ranges[t]},e.prototype.getAnimationRanges=function(){var r=[],t=0,o;for(o in this._ranges)r[t]=this._ranges[o],t++;return r},e.prototype.copyAnimationRange=function(e,t,i){if(void 0===i&&(i=!1),this._ranges[t]||!e.getAnimationRange(t))return!1;var r=!0,s=this._getHighestAnimationFrame()+1,a={},l=e.bones,_,n;for(n=0,_=l.length;n<_;n++)a[l[n].name]=l[n];this.bones.length!==l.length&&(p.Tools.Warn('copyAnimationRange: this rig has '+this.bones.length+' bones, while source as '+l.length),r=!1);var o=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(n=0,_=this.bones.length;n<_;n++){var c=this.bones[n].name,u=a[c];u?r=r&&this.bones[n].copyAnimationRange(u,t,s,i,o):(p.Tools.Warn('copyAnimationRange: not same rig, missing source bone '+c),r=!1)}var f=e.getAnimationRange(t);return f&&(this._ranges[t]=new p.AnimationRange(t,f.from+s,f.to+s)),r},e.prototype.returnToRest=function(){for(var t=0;t<this.bones.length;t++)this.bones[t].returnToRest()},e.prototype._getHighestAnimationFrame=function(){for(var o=0,e=0,t=this.bones.length;e<t;e++)if(this.bones[e].animations[0]){var i=this.bones[e].animations[0].getHighestFrame();o<i&&(o=i)}return o},e.prototype.beginAnimation=function(o,e,t,i){var r=this.getAnimationRange(o);return r?this._scene.beginAnimation(this,r.from,r.to,e,t,i):null},e.prototype._markAsDirty=function(){this._isDirty=!0},e.prototype._registerMeshWithPoseMatrix=function(t){this._meshesWithPoseMatrix.push(t)},e.prototype._unregisterMeshWithPoseMatrix=function(r){var e=this._meshesWithPoseMatrix.indexOf(r);-1<e&&this._meshesWithPoseMatrix.splice(e,1)},e.prototype._computeTransformMatrices=function(a,e){this.onBeforeComputeObservable.notifyObservers(this);for(var t=0;t<this.bones.length;t++){var i=this.bones[t],r=i.getParent();if(r?i.getLocalMatrix().multiplyToRef(r.getWorldMatrix(),i.getWorldMatrix()):e?i.getLocalMatrix().multiplyToRef(e,i.getWorldMatrix()):i.getWorldMatrix().copyFrom(i.getLocalMatrix()),-1!==i._index){var n=null===i._index?t:i._index;i.getInvertedAbsoluteTransform().multiplyToArray(i.getWorldMatrix(),a,16*n)}}this._identity.copyToArray(a,16*this.bones.length)},e.prototype.prepare=function(){if(this._isDirty){if(this.needInitialSkinMatrix)for(var e=0;e<this._meshesWithPoseMatrix.length;e++){var t=this._meshesWithPoseMatrix[e],i=t.getPoseMatrix();if(t._bonesTransformMatrices&&t._bonesTransformMatrices.length===16*(this.bones.length+1)||(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))),this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(var r=0,a;r<this.bones.length;r++)if(a=this.bones[r],!a.getParent()){var o=a.getBaseMatrix();o.multiplyToRef(i,p.Tmp.Matrix[1]),a._updateDifferenceMatrix(p.Tmp.Matrix[1])}}this._computeTransformMatrices(t._bonesTransformMatrices,i)}else this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1))),this._computeTransformMatrices(this._transformMatrices,null);this._isDirty=!1,this._scene._activeBones.addCount(this.bones.length,!1)}},e.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var t=0;t<this.bones.length;t++)this._animatables.push(this.bones[t])}return this._animatables},e.prototype.clone=function(t,i){var r=new e(t,i||t,this._scene);r.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var n=0;n<this.bones.length;n++){var o=this.bones[n],s=null,a=o.getParent();if(a){var l=this.bones.indexOf(a);s=r.bones[l]}var d=new p.Bone(o.name,r,s,o.getBaseMatrix().clone(),o.getRestPose().clone());p.Tools.DeepCopy(o.animations,d.animations)}if(this._ranges)for(var c in r._ranges={},this._ranges){var u=this._ranges[c];u&&(r._ranges[c]=u.clone())}return this._isDirty=!0,r},e.prototype.enableBlending=function(r){void 0===r&&(r=.01),this.bones.forEach(function(e){e.animations.forEach(function(e){e.enableBlending=!0,e.blendingSpeed=r})})},e.prototype.dispose=function(){this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this)},e.prototype.serialize=function(){var l={};l.name=this.name,l.id=this.id,this.dimensionsAtRest&&(l.dimensionsAtRest=this.dimensionsAtRest.asArray()),l.bones=[],l.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var e=0;e<this.bones.length;e++){var t=this.bones[e],i=t.getParent(),r={parentBoneIndex:i?this.bones.indexOf(i):-1,name:t.name,matrix:t.getBaseMatrix().toArray(),rest:t.getRestPose().toArray()};for(var n in l.bones.push(r),t.length&&(r.length=t.length),t.metadata&&(r.metadata=t.metadata),t.animations&&0<t.animations.length&&(r.animation=t.animations[0].serialize()),l.ranges=[],this._ranges){var o=this._ranges[n];if(o){var s={};s.name=n,s.from=o.from,s.to=o.to,l.ranges.push(s)}}}return l},e.Parse=function(t,i){var r=new e(t.name,t.id,i);t.dimensionsAtRest&&(r.dimensionsAtRest=p.Vector3.FromArray(t.dimensionsAtRest)),r.needInitialSkinMatrix=t.needInitialSkinMatrix;var n;for(n=0;n<t.bones.length;n++){var o=t.bones[n],s=null;-1<o.parentBoneIndex&&(s=r.bones[o.parentBoneIndex]);var a=o.rest?p.Matrix.FromArray(o.rest):null,l=new p.Bone(o.name,r,s,p.Matrix.FromArray(o.matrix),a);o.length&&(l.length=o.length),o.metadata&&(l.metadata=o.metadata),o.animation&&l.animations.push(p.Animation.Parse(o.animation))}if(t.ranges)for(n=0;n<t.ranges.length;n++){var d=t.ranges[n];r.createAnimationRange(d.name,d.from,d.to)}return r},e.prototype.computeAbsoluteTransforms=function(r){void 0===r&&(r=!1);var e=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=e||r)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=e)},e.prototype.getPoseMatrix=function(){var t=null;return 0<this._meshesWithPoseMatrix.length&&(t=this._meshesWithPoseMatrix[0].getPoseMatrix()),t},e.prototype.sortBones=function(){for(var r=[],e=Array(this.bones.length),t=0;t<this.bones.length;t++)this._sortBones(t,r,e);this.bones=r},e.prototype._sortBones=function(o,e,t){if(!t[o]){t[o]=!0;var i=this.bones[o];void 0===i._index&&(i._index=o);var r=i.getParent();r&&this._sortBones(this.bones.indexOf(r),e,t),e.push(i)}},e}();p.Skeleton=e}(e||(e={}));var e;!function(a){var e=function(){function r(){this.x=a.Vector3.Zero(),this.y=a.Vector3.Zero(),this.z=a.Vector3.Zero(),this.xx=a.Vector3.Zero(),this.yy=a.Vector3.Zero(),this.zz=a.Vector3.Zero(),this.xy=a.Vector3.Zero(),this.yz=a.Vector3.Zero(),this.zx=a.Vector3.Zero()}return r.prototype.addAmbient=function(e){var t=new a.Vector3(e.r,e.g,e.b);this.xx=this.xx.add(t),this.yy=this.yy.add(t),this.zz=this.zz.add(t)},r.getSphericalPolynomialFromHarmonics=function(t){var e=new r;return e.x=t.L11.scale(1.02333),e.y=t.L1_1.scale(1.02333),e.z=t.L10.scale(1.02333),e.xx=t.L00.scale(.886277).subtract(t.L20.scale(.247708)).add(t.L22.scale(.429043)),e.yy=t.L00.scale(.886277).subtract(t.L20.scale(.247708)).subtract(t.L22.scale(.429043)),e.zz=t.L00.scale(.886277).add(t.L20.scale(.495417)),e.yz=t.L2_1.scale(.858086),e.zx=t.L21.scale(.858086),e.xy=t.L2_2.scale(.858086),e.scale(1/V),e},r.prototype.scale=function(t){this.x=this.x.scale(t),this.y=this.y.scale(t),this.z=this.z.scale(t),this.xx=this.xx.scale(t),this.yy=this.yy.scale(t),this.zz=this.zz.scale(t),this.yz=this.yz.scale(t),this.zx=this.zx.scale(t),this.xy=this.xy.scale(t)},r}();a.SphericalPolynomial=e;var t=function(){function r(){this.L00=a.Vector3.Zero(),this.L1_1=a.Vector3.Zero(),this.L10=a.Vector3.Zero(),this.L11=a.Vector3.Zero(),this.L2_2=a.Vector3.Zero(),this.L2_1=a.Vector3.Zero(),this.L20=a.Vector3.Zero(),this.L21=a.Vector3.Zero(),this.L22=a.Vector3.Zero()}return r.prototype.addLight=function(e,t,i){var r=new a.Vector3(t.r,t.g,t.b),n=r.scale(i);this.L00=this.L00.add(n.scale(.282095)),this.L1_1=this.L1_1.add(n.scale(.488603*e.y)),this.L10=this.L10.add(n.scale(.488603*e.z)),this.L11=this.L11.add(n.scale(.488603*e.x)),this.L2_2=this.L2_2.add(n.scale(1.092548*e.x*e.y)),this.L2_1=this.L2_1.add(n.scale(1.092548*e.y*e.z)),this.L21=this.L21.add(n.scale(1.092548*e.x*e.z)),this.L20=this.L20.add(n.scale(.315392*(3*e.z*e.z-1))),this.L22=this.L22.add(n.scale(.546274*(e.x*e.x-e.y*e.y)))},r.prototype.scale=function(t){this.L00=this.L00.scale(t),this.L1_1=this.L1_1.scale(t),this.L10=this.L10.scale(t),this.L11=this.L11.scale(t),this.L2_2=this.L2_2.scale(t),this.L2_1=this.L2_1.scale(t),this.L20=this.L20.scale(t),this.L21=this.L21.scale(t),this.L22=this.L22.scale(t)},r.prototype.convertIncidentRadianceToIrradiance=function(){this.L00=this.L00.scale(3.141593),this.L1_1=this.L1_1.scale(2.094395),this.L10=this.L10.scale(2.094395),this.L11=this.L11.scale(2.094395),this.L2_2=this.L2_2.scale(.785398),this.L2_1=this.L2_1.scale(.785398),this.L20=this.L20.scale(.785398),this.L21=this.L21.scale(.785398),this.L22=this.L22.scale(.785398)},r.prototype.convertIrradianceToLambertianRadiance=function(){this.scale(1/V)},r.getsphericalHarmonicsFromPolynomial=function(t){var e=new r;return e.L00=t.xx.scale(.376127).add(t.yy.scale(.376127)).add(t.zz.scale(.376126)),e.L1_1=t.y.scale(.977204),e.L10=t.z.scale(.977204),e.L11=t.x.scale(.977204),e.L2_2=t.xy.scale(1.16538),e.L2_1=t.yz.scale(1.16538),e.L20=t.zz.scale(1.34567).subtract(t.xx.scale(.672834)).subtract(t.yy.scale(.672834)),e.L21=t.zx.scale(1.16538),e.L22=t.xx.scale(1.16538).subtract(t.yy.scale(1.16538)),e.scale(Math.PI),e},r}();a.SphericalHarmonics=t}(e||(e={}));var e;!function(T){var e=function(){function t(o,a,t,i){this.name=o,this.worldAxisForNormal=a,this.worldAxisForFileX=t,this.worldAxisForFileY=i}return t}(),t=function(){function t(){}return t.ConvertCubeMapTextureToSphericalPolynomial=function(e){if(!e.isCube)return null;var t=e.getSize().width,d=e.readPixels(0),p=e.readPixels(1),_,m;e.isRenderTarget?(_=e.readPixels(3),m=e.readPixels(2)):(_=e.readPixels(2),m=e.readPixels(3));var g=e.readPixels(4),y=e.readPixels(5),x=e.gammaSpace,b=T.Engine.TEXTUREFORMAT_RGBA,E=T.Engine.TEXTURETYPE_UNSIGNED_INT;e.textureType&&e.textureType!==T.Engine.TEXTURETYPE_UNSIGNED_INT&&(E=T.Engine.TEXTURETYPE_FLOAT);var v={size:t,right:d,left:p,up:_,down:m,front:g,back:y,format:b,type:E,gammaSpace:x};return this.ConvertCubeMapToSphericalPolynomial(v)},t.ConvertCubeMapToSphericalPolynomial=function(e){for(var t=new T.SphericalHarmonics,o=0,r=2/e.size,i=.5*r-1,n=0;6>n;n++)for(var a=this.FileFaces[n],s=e[a.name],l=i,c=e.format===T.Engine.TEXTUREFORMAT_RGBA?4:3,u=0;u<e.size;u++){for(var f=i,d=0,p;d<e.size;d++){p=a.worldAxisForFileX.scale(f).add(a.worldAxisForFileY.scale(l)).add(a.worldAxisForNormal),p.normalize();var _=x(1+f*f+l*l,-1.5),m=s[u*e.size*c+d*c+0],g=s[u*e.size*c+d*c+1],h=s[u*e.size*c+d*c+2];e.type===T.Engine.TEXTURETYPE_UNSIGNED_INT&&(m/=255,g/=255,h/=255),e.gammaSpace&&(m=x(T.Scalar.Clamp(m),T.ToLinearSpace),g=x(T.Scalar.Clamp(g),T.ToLinearSpace),h=x(T.Scalar.Clamp(h),T.ToLinearSpace));var y=new T.Color3(m,g,h);t.addLight(p,y,_),o+=_,f+=r}l+=r}var b=6*(4*V)/6/o;return t.scale(b),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),T.SphericalPolynomial.getSphericalPolynomialFromHarmonics(t)},t.FileFaces=[new e('right',new T.Vector3(1,0,0),new T.Vector3(0,0,-1),new T.Vector3(0,-1,0)),new e('left',new T.Vector3(-1,0,0),new T.Vector3(0,0,1),new T.Vector3(0,-1,0)),new e('up',new T.Vector3(0,1,0),new T.Vector3(1,0,0),new T.Vector3(0,0,1)),new e('down',new T.Vector3(0,-1,0),new T.Vector3(1,0,0),new T.Vector3(0,0,-1)),new e('front',new T.Vector3(0,0,1),new T.Vector3(1,0,0),new T.Vector3(0,-1,0)),new e('back',new T.Vector3(0,0,-1),new T.Vector3(-1,0,0),new T.Vector3(0,-1,0))],t}();T.CubeMapToSphericalPolynomialTools=t}(e||(e={}));var e;!function(o){var e=function(){function e(){}return e.ConvertPanoramaToCubemap=function(e,a,i,r){if(!e)throw'ConvertPanoramaToCubemap: input cannot be null';if(e.length!=3*(a*i))throw'ConvertPanoramaToCubemap: input size is wrong';return{front:this.CreateCubemapTexture(r,this.FACE_FRONT,e,a,i),back:this.CreateCubemapTexture(r,this.FACE_BACK,e,a,i),left:this.CreateCubemapTexture(r,this.FACE_LEFT,e,a,i),right:this.CreateCubemapTexture(r,this.FACE_RIGHT,e,a,i),up:this.CreateCubemapTexture(r,this.FACE_UP,e,a,i),down:this.CreateCubemapTexture(r,this.FACE_DOWN,e,a,i),size:r,type:o.Engine.TEXTURETYPE_FLOAT,format:o.Engine.TEXTUREFORMAT_RGB,gammaSpace:!1}},e.CreateCubemapTexture=function(g,e,t,i,r){for(var n=new ArrayBuffer(3*(4*(g*g))),o=new Float32Array(n),s=e[1].subtract(e[0]).scale(1/g),a=e[3].subtract(e[2]).scale(1/g),l=0,c=0;c<g;c++){for(var u=e[0],f=e[2],d=0,p;d<g;d++){p=f.subtract(u).scale(l).add(u),p.normalize();var _=this.CalcProjectionSpherical(p,t,i,r);o[3*(c*g)+3*d+0]=_.r,o[3*(c*g)+3*d+1]=_.g,o[3*(c*g)+3*d+2]=_.b,u=u.add(s),f=f.add(a)}l+=1/g}return o},e.CalcProjectionSpherical=function(a,e,t,i){for(var r=I(a.z,a.x),n=T(a.y);r<-V;)r+=2*V;for(;r>V;)r-=2*V;var o=r/V;o=.5*o+.5;var s=O(o*t);0>s?s=0:s>=t&&(s=t-1);var l=O(n/V*i);0>l?l=0:l>=i&&(l=i-1);var d=i-l-1;return{r:e[3*(d*t)+3*s+0],g:e[3*(d*t)+3*s+1],b:e[3*(d*t)+3*s+2]}},e.FACE_FRONT=[new o.Vector3(-1,-1,-1),new o.Vector3(1,-1,-1),new o.Vector3(-1,1,-1),new o.Vector3(1,1,-1)],e.FACE_BACK=[new o.Vector3(1,-1,1),new o.Vector3(-1,-1,1),new o.Vector3(1,1,1),new o.Vector3(-1,1,1)],e.FACE_RIGHT=[new o.Vector3(1,-1,-1),new o.Vector3(1,-1,1),new o.Vector3(1,1,-1),new o.Vector3(1,1,1)],e.FACE_LEFT=[new o.Vector3(-1,-1,1),new o.Vector3(-1,-1,-1),new o.Vector3(-1,1,1),new o.Vector3(-1,1,-1)],e.FACE_DOWN=[new o.Vector3(-1,1,-1),new o.Vector3(1,1,-1),new o.Vector3(-1,1,1),new o.Vector3(1,1,1)],e.FACE_UP=[new o.Vector3(-1,-1,1),new o.Vector3(1,-1,1),new o.Vector3(-1,-1,-1),new o.Vector3(1,-1,-1)],e}();o.PanoramaToCubeMapTools=e}(e||(e={}));var e;!function(a){var e=function(){function e(){}return e.Ldexp=function(r,e){return 1023<e?8.98846567431158e+307*r*x(2,e-1023):-1074>e?5e-324*r*x(2,e+1074):r*x(2,e)},e.Rgbe2float=function(a,e,t,i,r,n){0<r?(r=this.Ldexp(1,r-136),a[n+0]=e*r,a[n+1]=t*r,a[n+2]=i*r):(a[n+0]=0,a[n+1]=0,a[n+2]=0)},e.readStringLine=function(a,e){for(var t='',i='',r=e;r<a.length-e&&'\n'!=(i=o(a[r]));r++)t+=i;return t},e.RGBE_ReadHeader=function(d){var e=0,c=0,p=this.readStringLine(d,0);if('#'!=p[0]||'?'!=p[1])throw'Bad HDR Format.';var r=!1,u=!1,f=0;do f+=p.length+1,p=this.readStringLine(d,f),'FORMAT=32-bit_rle_rgbe'==p?u=!0:0==p.length&&(r=!0);while(!r);if(!u)throw'HDR Bad header format, unsupported FORMAT';f+=p.length+1,p=this.readStringLine(d,f);var _=/^\-Y (.*) \+X (.*)$/g,a=_.exec(p);if(!a||3>a.length)throw'HDR Bad header format, no size';if(c=parseInt(a[2]),e=parseInt(a[1]),8>c||32767<c)throw'HDR Bad header format, unsupported size';return f+=p.length+1,{height:e,width:c,dataPosition:f}},e.GetCubeMapTextureData=function(e,t){var i=new Uint8Array(e),r=this.RGBE_ReadHeader(i),n=this.RGBE_ReadPixels_RLE(i,r);return a.PanoramaToCubeMapTools.ConvertPanoramaToCubemap(n,r.width,r.height,t)},e.RGBE_ReadPixels=function(r,e){return this.RGBE_ReadPixels_RLE(r,e)},e.RGBE_ReadPixels_RLE=function(y,e){for(var t=e.height,a=e.width,l=e.dataPosition,h=0,c=0,u=0,f=new ArrayBuffer(4*a),d=new Uint8Array(f),p=new ArrayBuffer(3*(4*(e.width*e.height))),_=new Float32Array(p),m,i,r,n,o;0<t;){if(m=y[l++],i=y[l++],r=y[l++],n=y[l++],2!=m||2!=i||128&r)throw'HDR Bad header format, not RLE';if((r<<8|n)!=a)throw'HDR Bad header format, wrong scan line width';for(h=0,u=0;4>u;u++)for(c=(u+1)*a;h<c;)if(m=y[l++],i=y[l++],128<m){if(0==(o=m-128)||o>c-h)throw'HDR Bad Format, bad scanline data (run)';for(;0<o--;)d[h++]=i}else{if(0==(o=m)||o>c-h)throw'HDR Bad Format, bad scanline data (non-run)';if(d[h++]=i,0<--o)for(var s=0;s<o;s++)d[h++]=y[l++]}for(u=0;u<a;u++)m=d[u],i=d[u+a],r=d[u+2*a],n=d[u+3*a],this.Rgbe2float(_,m,i,r,n,3*((e.height-t)*a)+3*u);t--}return _},e}();a.HDRTools=e}(e||(e={}));var e;!function(y){var e=function(e){function s(t,d,r,n,o,s,a,l,p){void 0===n&&(n=!1),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===a&&(a=!1),void 0===l&&(l=null),void 0===p&&(p=null);var c=e.call(this,d)||this;return c._generateHarmonics=!0,c._onLoad=null,c._onError=null,c.coordinatesMode=y.Texture.CUBIC_MODE,c._isBlocking=!0,c._rotationY=0,c.boundingBoxPosition=y.Vector3.Zero(),t?(c.name=t,c.url=t,c.hasAlpha=!1,c.isCube=!0,c._textureMatrix=y.Matrix.Identity(),c._onLoad=l,c._onError=p,c.gammaSpace=s,c._noMipmap=n,c._size=r,c._texture=c._getFromCache(t,c._noMipmap),c._texture||(d.useDelayedTextureLoading?c.delayLoadState=y.Engine.DELAYLOADSTATE_NOTLOADED:c.loadTexture()),c):c}return h(s,e),Object.defineProperty(s.prototype,'isBlocking',{get:function(){return this._isBlocking},set:function(t){this._isBlocking=t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'rotationY',{get:function(){return this._rotationY},set:function(e){this._rotationY=e,this.setReflectionTextureMatrix(y.Matrix.RotationY(this._rotationY))},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'boundingBoxSize',{get:function(){return this._boundingBoxSize},set:function(e){if(!this._boundingBoxSize||!this._boundingBoxSize.equals(e)){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(y.Material.TextureDirtyFlag)}},enumerable:!0,configurable:!0}),s.prototype.loadTexture=function(){var e=this,t=function(t){var r=e.getScene();if(!r)return null;var i=y.HDRTools.GetCubeMapTextureData(t,e._size);if(e._generateHarmonics){var o=y.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(i);e.sphericalPolynomial=o}for(var T=[],a=null,l=0;6>l;l++){if(!r.getEngine().getCaps().textureFloat){var h=new ArrayBuffer(3*(e._size*e._size));a=new Uint8Array(h)}var c=i[s._facesMapping[l]];if(e.gammaSpace||a)for(var u=0;u<e._size*e._size;u++)if(e.gammaSpace&&(c[3*u+0]=x(c[3*u+0],y.ToGammaSpace),c[3*u+1]=x(c[3*u+1],y.ToGammaSpace),c[3*u+2]=x(c[3*u+2],y.ToGammaSpace)),a){var f=W(255*c[3*u+0],0),d=W(255*c[3*u+1],0),p=W(255*c[3*u+2],0),_=W(W(f,d),p);if(255<_){var m=255/_;f*=m,d*=m,p*=m}a[3*u+0]=f,a[3*u+1]=d,a[3*u+2]=p}a?T.push(a):T.push(c)}return T},r=this.getScene();r&&(this._texture=r.getEngine().createRawCubeTextureFromUrl(this.url,r,this._size,y.Engine.TEXTUREFORMAT_RGB,r.getEngine().getCaps().textureFloat?y.Engine.TEXTURETYPE_FLOAT:y.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,t,null,this._onLoad,this._onError))},s.prototype.clone=function(){var r=this.getScene();if(!r)return this;var o=new s(this.url,r,this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return o.level=this.level,o.wrapU=this.wrapU,o.wrapV=this.wrapV,o.coordinatesIndex=this.coordinatesIndex,o.coordinatesMode=this.coordinatesMode,o},s.prototype.delayLoad=function(){this.delayLoadState===y.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=y.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this.loadTexture())},s.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},s.prototype.setReflectionTextureMatrix=function(t){this._textureMatrix=t},s.Parse=function(e,t,r){var i=null;return e.name&&!e.isRenderTarget&&(i=new s(r+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),i.name=e.name,i.hasAlpha=e.hasAlpha,i.level=e.level,i.coordinatesMode=e.coordinatesMode,i.isBlocking=e.isBlocking),i&&(e.boundingBoxPosition&&(i.boundingBoxPosition=y.Vector3.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(i.boundingBoxSize=y.Vector3.FromArray(e.boundingBoxSize)),e.rotationY&&(i.rotationY=e.rotationY)),i},s.prototype.serialize=function(){if(!this.name)return null;var t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.customType='BABYLON.HDRCubeTexture',t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t},s._facesMapping=['right','left','up','down','front','back'],s}(y.BaseTexture);y.HDRCubeTexture=e}(e||(e={}));var e;!function(y){var o=function(o){function e(e,a){var i=o.call(this,e.x,e.y)||this;return i.index=a,i}return h(e,o),e}(y.Vector2),i=function(){function e(){this.elements=[]}return e.prototype.add=function(t){var a=this,i=[];return t.forEach(function(t){if(0===i.length||!t.equalsWithEpsilon(i[0])){var e=new o(t,a.elements.length);i.push(e),a.elements.push(e)}}),i},e.prototype.computeBounds=function(){var r=new y.Vector2(this.elements[0].x,this.elements[0].y),o=new y.Vector2(this.elements[0].x,this.elements[0].y);return this.elements.forEach(function(t){t.x<r.x?r.x=t.x:t.x>o.x&&(o.x=t.x),t.y<r.y?r.y=t.y:t.y>o.y&&(o.y=t.y)}),{min:r,max:o,width:o.x-r.x,height:o.y-r.y}},e}(),e=function(){function e(){}return e.Rectangle=function(e,t,o,r){return[new y.Vector2(e,t),new y.Vector2(o,t),new y.Vector2(o,r),new y.Vector2(e,r)]},e.Circle=function(e,t,i,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=32);for(var n=[],o=0,s=2*V/r,a=0;a<r;a++)n.push(new y.Vector2(t+F(o)*e,i+B(o)*e)),o-=s;return n},e.Parse=function(e){var t=e.split(/[^-+eE\.\d]+/).map(parseFloat).filter(function(t){return!isNaN(t)}),r=[],o;for(o=0;o<(2147483646&t.length);o+=2)r.push(new y.Vector2(t[o],t[o+1]));return r},e.StartingAt=function(e,t){return y.Path2.StartingAt(e,t)},e}();y.Polygon=e;var t=function(){function e(e,r,a){this._points=new i,this._outlinepoints=new i,this._holes=[],this._epoints=[],this._eholes=[],this._name=e,this._scene=a;var o;o=r instanceof y.Path2?r.getPoints():r,this._addToepoint(o),this._points.add(o),this._outlinepoints.add(o),void 0===p&&y.Tools.Warn('Earcut was not found, the polygon will not be built.')}return e.prototype._addToepoint=function(o){for(var e=0,t=o,i;e<t.length;e++)i=t[e],this._epoints.push(i.x,i.y)},e.prototype.addHole=function(r){this._points.add(r);var e=new i;return e.add(r),this._holes.push(e),this._eholes.push(this._epoints.length/2),this._addToepoint(r),this},e.prototype.build=function(e,t){var i=this;void 0===e&&(e=!1),void 0===t&&(t=0);var n=new y.Mesh(this._name,this._scene),o=[],s=[],a=[],l=this._points.computeBounds();this._points.elements.forEach(function(t){o.push(0,1,0),s.push(t.x,0,t.y),a.push((t.x-l.min.x)/l.width,(t.y-l.min.y)/l.height)});for(var h=[],c=p(this._epoints,this._eholes,2),u=0;u<c.length;u++)h.push(c[u]);if(0<t){var f=s.length/3;this._points.elements.forEach(function(i){o.push(0,-1,0),s.push(i.x,-t,i.y),a.push(1-(i.x-l.min.x)/l.width,1-(i.y-l.min.y)/l.height)});for(var d=h.length,u=0;u<d;u+=3){var T=h[u+0],_=h[u+1],m=h[u+2];h.push(m+f),h.push(_+f),h.push(T+f)}this.addSide(s,o,a,h,l,this._outlinepoints,t,!1),this._holes.forEach(function(r){i.addSide(s,o,a,h,l,r,t,!0)})}return n.setVerticesData(y.VertexBuffer.PositionKind,s,e),n.setVerticesData(y.VertexBuffer.NormalKind,o,e),n.setVerticesData(y.VertexBuffer.UVKind,a,e),n.setIndices(h),n},e.prototype.addSide=function(e,t,i,r,n,o,s,T){for(var l=e.length/3,h=0,c=0;c<o.elements.length;c++){var u=o.elements[c],d;d=c+1>o.elements.length-1?o.elements[0]:o.elements[c+1],e.push(u.x,0,u.y),e.push(u.x,-s,u.y),e.push(d.x,0,d.y),e.push(d.x,-s,d.y);var f=new y.Vector3(u.x,0,u.y),p=new y.Vector3(d.x,0,d.y),_=p.subtract(f),m=new y.Vector3(0,1,0),g=y.Vector3.Cross(_,m);g=g.normalize(),i.push(h/n.width,0),i.push(h/n.width,1),h+=_.length(),i.push(h/n.width,0),i.push(h/n.width,1),T?(t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z),r.push(l),r.push(l+2),r.push(l+1),r.push(l+1),r.push(l+2),r.push(l+3)):(t.push(-g.x,-g.y,-g.z),t.push(-g.x,-g.y,-g.z),t.push(-g.x,-g.y,-g.z),t.push(-g.x,-g.y,-g.z),r.push(l),r.push(l+1),r.push(l+2),r.push(l+1),r.push(l+3),r.push(l+2)),l+=4}},e}();y.PolygonMeshBuilder=t}(e||(e={}));var e;!function(D){var e=0,d=function(){function e(r,e,o){this.pos=r,this.normal=e,this.uv=o}return e.prototype.clone=function(){return new e(this.pos.clone(),this.normal.clone(),this.uv.clone())},e.prototype.flip=function(){this.normal=this.normal.scale(-1)},e.prototype.interpolate=function(t,o){return new e(D.Vector3.Lerp(this.pos,t.pos,o),D.Vector3.Lerp(this.normal,t.normal,o),D.Vector2.Lerp(this.uv,t.uv,o))},e}(),i=function(){function e(r,e){this.normal=r,this.w=e}return e.FromPoints=function(t,i,r){var n=r.subtract(t),o=i.subtract(t);if(0===n.lengthSquared()||0===o.lengthSquared())return null;var s=D.Vector3.Normalize(D.Vector3.Cross(n,o));return new e(s,D.Vector3.Dot(s,t))},e.prototype.clone=function(){return new e(this.normal.clone(),this.w)},e.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},e.prototype.splitPolygon=function(t,i,r,o,n){var a=0,s=[],c,l;for(c=0;c<t.vertices.length;c++){l=D.Vector3.Dot(this.normal,t.vertices[c].pos)-this.w;var u=l<-e.EPSILON?2:l>e.EPSILON?1:0;a|=u,s.push(u)}switch(a){case 0:(0<D.Vector3.Dot(this.normal,t.plane.normal)?i:r).push(t);break;case 1:o.push(t);break;case 2:n.push(t);break;case 3:var f=[],d=[];for(c=0;c<t.vertices.length;c++){var p=(c+1)%t.vertices.length,_=s[c],m=s[p],g=t.vertices[c],h=t.vertices[p];if(2!==_&&f.push(g),1!==_&&d.push(2===_?g:g.clone()),3==(_|m)){l=(this.w-D.Vector3.Dot(this.normal,g.pos))/D.Vector3.Dot(this.normal,h.pos.subtract(g.pos));var y=g.interpolate(h,l);f.push(y),d.push(y.clone())}}var T;3<=f.length&&(T=new P(f,t.shared),T.plane&&o.push(T)),3<=d.length&&(T=new P(d,t.shared),T.plane&&n.push(T));}},e.EPSILON=1e-5,e}(),P=function(){function t(r,o){this.vertices=r,this.shared=o,this.plane=i.FromPoints(r[0].pos,r[1].pos,r[2].pos)}return t.prototype.clone=function(){return new t(this.vertices.map(function(t){return t.clone()}),this.shared)},t.prototype.flip=function(){this.vertices.reverse().map(function(t){t.flip()}),this.plane.flip()},t}(),a=function(){function o(t){this.plane=null,this.front=null,this.back=null,this.polygons=[],t&&this.build(t)}return o.prototype.clone=function(){var e=new o;return e.plane=this.plane&&this.plane.clone(),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.polygons=this.polygons.map(function(t){return t.clone()}),e},o.prototype.invert=function(){for(var r=0;r<this.polygons.length;r++)this.polygons[r].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var e=this.front;this.front=this.back,this.back=e},o.prototype.clipPolygons=function(o){if(!this.plane)return o.slice();for(var e=[],t=[],i=0;i<o.length;i++)this.plane.splitPolygon(o[i],e,t,e,t);return this.front&&(e=this.front.clipPolygons(e)),t=this.back?this.back.clipPolygons(t):[],e.concat(t)},o.prototype.clipTo=function(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)},o.prototype.allPolygons=function(){var t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t},o.prototype.build=function(e){if(e.length){this.plane||(this.plane=e[0].plane.clone());for(var t=[],i=[],r=0;r<e.length;r++)this.plane.splitPolygon(e[r],this.polygons,this.polygons,t,i);t.length&&(this.front||(this.front=new o),this.front.build(t)),i.length&&(this.back||(this.back=new o),this.back.build(i))}},o}(),r=function(){function n(){this.polygons=[]}return n.FromMesh=function(r){var o=[],i=null,m,s,a,l,g,c,u,f,h,p;if(!(r instanceof D.Mesh))throw'BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh';r.computeWorldMatrix(!0),u=r.getWorldMatrix(),f=r.position.clone(),h=r.rotation.clone(),r.rotationQuaternion&&(i=r.rotationQuaternion.clone()),p=r.scaling.clone();for(var _=r.getIndices(),v=r.getVerticesData(D.VertexBuffer.PositionKind),y=r.getVerticesData(D.VertexBuffer.NormalKind),b=r.getVerticesData(D.VertexBuffer.UVKind),x=r.subMeshes,T=0,I=x.length;T<I;T++)for(var L=x[T].indexStart,A=x[T].indexCount+x[T].indexStart;L<A;L+=3){c=[];for(var M=0,S;3>M;M++){S=new D.Vector3(y[3*_[L+M]],y[3*_[L+M]+1],y[3*_[L+M]+2]),a=new D.Vector2(b[2*_[L+M]],b[2*_[L+M]+1]);var C=new D.Vector3(v[3*_[L+M]],v[3*_[L+M]+1],v[3*_[L+M]+2]);l=D.Vector3.TransformCoordinates(C,u),s=D.Vector3.TransformNormal(S,u),m=new d(l,s,a),c.push(m)}g=new P(c,{subMeshId:T,meshId:e,materialIndex:x[T].materialIndex}),g.plane&&o.push(g)}var R=n.FromPolygons(o);return R.matrix=u,R.position=f,R.rotation=h,R.scaling=p,R.rotationQuaternion=i,e++,R},n.FromPolygons=function(r){var e=new n;return e.polygons=r,e},n.prototype.clone=function(){var t=new n;return t.polygons=this.polygons.map(function(t){return t.clone()}),t.copyTransformAttributes(this),t},n.prototype.union=function(r){var e=new a(this.clone().polygons),t=new a(r.clone().polygons);return e.clipTo(t),t.clipTo(e),t.invert(),t.clipTo(e),t.invert(),e.build(t.allPolygons()),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.unionInPlace=function(r){var e=new a(this.polygons),t=new a(r.polygons);e.clipTo(t),t.clipTo(e),t.invert(),t.clipTo(e),t.invert(),e.build(t.allPolygons()),this.polygons=e.allPolygons()},n.prototype.subtract=function(r){var e=new a(this.clone().polygons),t=new a(r.clone().polygons);return e.invert(),e.clipTo(t),t.clipTo(e),t.invert(),t.clipTo(e),t.invert(),e.build(t.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.subtractInPlace=function(r){var e=new a(this.polygons),t=new a(r.polygons);e.invert(),e.clipTo(t),t.clipTo(e),t.invert(),t.clipTo(e),t.invert(),e.build(t.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.intersect=function(r){var e=new a(this.clone().polygons),t=new a(r.clone().polygons);return e.invert(),t.clipTo(e),t.invert(),e.clipTo(t),t.clipTo(e),e.build(t.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.intersectInPlace=function(r){var e=new a(this.polygons),t=new a(r.polygons);e.invert(),t.clipTo(e),t.invert(),e.clipTo(t),t.clipTo(e),e.build(t.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.inverse=function(){var t=this.clone();return t.inverseInPlace(),t},n.prototype.inverseInPlace=function(){this.polygons.map(function(t){t.flip()})},n.prototype.copyTransformAttributes=function(t){return this.matrix=t.matrix,this.position=t.position,this.rotation=t.rotation,this.scaling=t.scaling,this.rotationQuaternion=t.rotationQuaternion,this},n.prototype.buildMeshGeometry=function(e,t,i){var r=this.matrix.clone();r.invert();var n=new D.Mesh(e,t),l=[],h=[],c=[],u=[],f=D.Vector3.Zero(),d=D.Vector3.Zero(),p=D.Vector2.Zero(),_=this.polygons,m=[0,0,0],g={},v=0,y={},b,o,s;i&&_.sort(function(r,e){return r.shared.meshId===e.shared.meshId?r.shared.subMeshId-e.shared.subMeshId:r.shared.meshId-e.shared.meshId});for(var a=0,x=_.length;a<x;a++){b=_[a],y[b.shared.meshId]||(y[b.shared.meshId]={}),y[b.shared.meshId][b.shared.subMeshId]||(y[b.shared.meshId][b.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:b.shared.materialIndex}),s=y[b.shared.meshId][b.shared.subMeshId];for(var T=2,E=b.vertices.length;T<E;T++){m[0]=0,m[1]=T-1,m[2]=T;for(var P=0;3>P;P++){f.copyFrom(b.vertices[m[P]].pos),d.copyFrom(b.vertices[m[P]].normal),p.copyFrom(b.vertices[m[P]].uv);var A=D.Vector3.TransformCoordinates(f,r),M=D.Vector3.TransformNormal(d,r);o=g[A.x+','+A.y+','+A.z],void 0!==o&&c[3*o]===M.x&&c[3*o+1]===M.y&&c[3*o+2]===M.z&&u[2*o]===p.x&&u[2*o+1]===p.y||(l.push(A.x,A.y,A.z),u.push(p.x,p.y),c.push(d.x,d.y,d.z),o=g[A.x+','+A.y+','+A.z]=l.length/3-1),h.push(o),s.indexStart=C(v,s.indexStart),s.indexEnd=W(v,s.indexEnd),v++}}}if(n.setVerticesData(D.VertexBuffer.PositionKind,l),n.setVerticesData(D.VertexBuffer.NormalKind,c),n.setVerticesData(D.VertexBuffer.UVKind,u),n.setIndices(h,null),i){var S=0,R;for(var L in n.subMeshes=[],y){for(var O in R=-1,y[L])s=y[L][O],D.SubMesh.CreateFromIndices(s.materialIndex+S,s.indexStart,s.indexEnd-s.indexStart+1,n),R=W(s.materialIndex,R);S+=++R}}return n},n.prototype.toMesh=function(o,e,t,i){var r=this.buildMeshGeometry(o,t,i);return r.material=e,r.position.copyFrom(this.position),r.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(r.rotationQuaternion=this.rotationQuaternion.clone()),r.scaling.copyFrom(this.scaling),r.computeWorldMatrix(!0),r},n}();D.CSG=r}(e||(e={}));var e;!function(a){var e=function(){function s(e,s,i,r,n){this.size=e,this.position=s,this.alphaMode=a.Engine.ALPHA_ONEONE,this.color=i||new a.Color3(1,1,1),this.texture=r?new a.Texture(r,n.getScene(),!0):null,this._system=n,n.lensFlares.push(this)}return s.AddFlare=function(t,e,i,r,a){return new s(t,e,i,r,a)},s.prototype.dispose=function(){this.texture&&this.texture.dispose();var t=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(t,1)},s}();a.LensFlare=e}(e||(e={}));var e;!function(T){var e=function(){function e(e,a,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||T.Engine.LastCreatedScene,this._emitter=a,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(t){return i.activeCamera&&t.material&&t.isVisible&&t.isEnabled()&&t.isBlocker&&0!=(t.layerMask&i.activeCamera.layerMask)};var r=i.getEngine(),n=[];n.push(1,1),n.push(-1,1),n.push(-1,-1),n.push(1,-1),this._vertexBuffers[T.VertexBuffer.PositionKind]=new T.VertexBuffer(r,n,T.VertexBuffer.PositionKind,!1,!1,2);var o=[];o.push(0),o.push(1),o.push(2),o.push(0),o.push(2),o.push(3),this._indexBuffer=r.createIndexBuffer(o),this._effect=r.createEffect('lensFlare',[T.VertexBuffer.PositionKind],['color','viewportMatrix'],['textureSampler'],'')}return Object.defineProperty(e.prototype,'isEnabled',{get:function(){return this._isEnabled},set:function(t){this._isEnabled=t},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getEmitter=function(){return this._emitter},e.prototype.setEmitter=function(t){this._emitter=t},e.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},e.prototype.computeEffectivePosition=function(e){var t=this.getEmitterPosition();return t=T.Vector3.Project(t,T.Matrix.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=T.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),0<this.viewportBorder&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder),0<t.z&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)},e.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera)return!1;var e=this.getEmitterPosition(),t=e.subtract(this._scene.activeCamera.globalPosition),i=t.length();t.normalize();var r=new T.Ray(this._scene.activeCamera.globalPosition,t),a=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!a||!a.hit||a.distance>i},e.prototype.render=function(){if(!this._effect.isReady()||!this._scene.activeCamera)return!1;var e=this._scene.getEngine(),t=this._scene.activeCamera.viewport,i=t.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(i))return!1;if(!this._isVisible())return!1;var r,n;r=this._positionX<this.borderLimit+i.x?this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?this._positionX-i.x-i.width+this.borderLimit:0,n=this._positionY<this.borderLimit+i.y?this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?this._positionY-i.y-i.height+this.borderLimit:0;var o=r>n?r:n;(o-=this.viewportBorder)>this.borderLimit&&(o=this.borderLimit);var s=1-o/this.borderLimit;if(0>s)return!1;1<s&&(s=1),0<this.viewportBorder&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=2*this.viewportBorder,i.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var a=i.x+i.width/2,l=i.y+i.height/2,h=a-this._positionX,c=l-this._positionY;e.enableEffect(this._effect),e.setState(!1),e.setDepthBuffer(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var u=0,f;u<this.lensFlares.length;u++){f=this.lensFlares[u],e.setAlphaMode(f.alphaMode);var d=a-h*f.position,p=l-c*f.position,_=f.size,m=f.size*e.getAspectRatio(this._scene.activeCamera,!0),g=2*(d/(i.width+2*i.x))-1,x=1-2*(p/(i.height+2*i.y)),y=T.Matrix.FromValues(_/2,0,0,0,0,m/2,0,0,0,0,1,0,g,x,0,1);this._effect.setMatrix('viewportMatrix',y),this._effect.setTexture('textureSampler',f.texture),this._effect.setFloat4('color',f.color.r*s,f.color.g*s,f.color.b*s,1),e.drawElementsType(T.Material.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(T.Engine.ALPHA_DISABLE),!0},e.prototype.dispose=function(){var e=this._vertexBuffers[T.VertexBuffer.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[T.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)},e.Parse=function(t,i,r){var n=i.getLastEntryByID(t.emitterId),o=t.name||'lensFlareSystem#'+t.emitterId,s=new e(o,n,i);s.id=t.id||o,s.borderLimit=t.borderLimit;for(var a=0,l;a<t.flares.length;a++)l=t.flares[a],T.LensFlare.AddFlare(l.size,l.position,T.Color3.FromArray(l.color),l.textureName?r+l.textureName:'',s);return s},e.prototype.serialize=function(){for(var e={id:this.id,name:this.name,emitterId:this.getEmitter().id,borderLimit:this.borderLimit,flares:[]},t=0,o;t<this.lensFlares.length;t++)o=this.lensFlares[t],e.flares.push({size:o.size,position:o.position,color:o.color.asArray(),textureName:T.Tools.GetFilename(o.texture?o.texture.name:'')});return e},e}();T.LensFlareSystem=e}(e||(e={}));var e;!function(o){var a=function(){function t(r,o){this.type=r,this.jointData=o,o.nativeParams=o.nativeParams||{}}return Object.defineProperty(t.prototype,'physicsJoint',{get:function(){return this._physicsJoint},set:function(t){this._physicsJoint,this._physicsJoint=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'physicsPlugin',{set:function(t){this._physicsPlugin=t},enumerable:!0,configurable:!0}),t.prototype.executeNativeFunction=function(t){t(this._physicsPlugin.world,this._physicsJoint)},t.DistanceJoint=0,t.HingeJoint=1,t.BallAndSocketJoint=2,t.WheelJoint=3,t.SliderJoint=4,t.PrismaticJoint=5,t.UniversalJoint=6,t.Hinge2Joint=t.WheelJoint,t.PointToPointJoint=8,t.SpringJoint=9,t.LockJoint=10,t}();o.PhysicsJoint=a;var e=function(t){function e(e){return t.call(this,a.DistanceJoint,e)||this}return h(e,t),e.prototype.updateDistance=function(r,e){this._physicsPlugin.updateDistanceJoint(this,r,e)},e}(a);o.DistanceJoint=e;var t=function(r){function e(e,o){return r.call(this,e,o)||this}return h(e,r),e.prototype.setMotor=function(r,e){this._physicsPlugin.setMotor(this,r||0,e)},e.prototype.setLimit=function(r,e){this._physicsPlugin.setLimit(this,r,e)},e}(a);o.MotorEnabledJoint=t;var r=function(t){function e(e){return t.call(this,a.HingeJoint,e)||this}return h(e,t),e.prototype.setMotor=function(r,e){this._physicsPlugin.setMotor(this,r||0,e)},e.prototype.setLimit=function(r,e){this._physicsPlugin.setLimit(this,r,e)},e}(t);o.HingeJoint=r;var i=function(t){function e(e){return t.call(this,a.Hinge2Joint,e)||this}return h(e,t),e.prototype.setMotor=function(r,e,t){void 0===t&&(t=0),this._physicsPlugin.setMotor(this,r||0,e,t)},e.prototype.setLimit=function(r,e,t){void 0===t&&(t=0),this._physicsPlugin.setLimit(this,r,e,t)},e}(t);o.Hinge2Joint=i}(e||(e={}));var e;!function(d){var e=function(){function p(e,a,i,r){void 0===i&&(i={mass:0});var n=this;return(this.object=e,this.type=a,this._options=i,this._scene=r,this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=[],this._onAfterPhysicsStepCallbacks=[],this._onPhysicsCollideCallbacks=[],this._deltaPosition=d.Vector3.Zero(),this._isDisposed=!1,this._tmpQuat=new d.Quaternion,this._tmpQuat2=new d.Quaternion,this.beforeStep=function(){n._physicsEngine&&(n.object.translate(n._deltaPosition,-1),n._deltaRotationConjugated&&n.object.rotationQuaternion&&n.object.rotationQuaternion.multiplyToRef(n._deltaRotationConjugated,n.object.rotationQuaternion),n.object.computeWorldMatrix(!1),n.object.parent&&n.object.rotationQuaternion?(n.getParentsRotation(),n._tmpQuat.multiplyToRef(n.object.rotationQuaternion,n._tmpQuat)):n._tmpQuat.copyFrom(n.object.rotationQuaternion||new d.Quaternion),n._options.disableBidirectionalTransformation||n.object.rotationQuaternion&&n._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(n,n.object.getAbsolutePivotPoint(),n._tmpQuat),n._onBeforePhysicsStepCallbacks.forEach(function(t){t(n)}))},this.afterStep=function(){n._physicsEngine&&(n._onAfterPhysicsStepCallbacks.forEach(function(t){t(n)}),n._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(n),n.object.parent&&n.object.rotationQuaternion&&(n.getParentsRotation(),n._tmpQuat.conjugateInPlace(),n._tmpQuat.multiplyToRef(n.object.rotationQuaternion,n.object.rotationQuaternion)),n.object.setAbsolutePosition(n.object.position),n._deltaRotation&&n.object.rotationQuaternion&&n.object.rotationQuaternion.multiplyToRef(n._deltaRotation,n.object.rotationQuaternion),n.object.translate(n._deltaPosition,1))},this.onCollideEvent=null,this.onCollide=function(r){if((n._onPhysicsCollideCallbacks.length||n.onCollideEvent)&&n._physicsEngine){var o=n._physicsEngine.getImpostorWithPhysicsBody(r.body);o&&(n.onCollideEvent&&n.onCollideEvent(n,o),n._onPhysicsCollideCallbacks.filter(function(t){return-1!==t.otherImpostors.indexOf(o)}).forEach(function(t){t.callback(n,o)}))}},!this.object)?void d.Tools.Error('No object was provided. A physics object is obligatory'):void(!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=d.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new d.Quaternion),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&d.Tools.Warn('You must affect impostors to children before affecting impostor to parent.')):d.Tools.Error('Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.')))}return Object.defineProperty(p.prototype,'isDisposed',{get:function(){return this._isDisposed},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'mass',{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(t){this.setMass(t)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'friction',{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,t)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'restitution',{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,t)},enumerable:!0,configurable:!0}),p.prototype._init=function(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))},p.prototype._getPhysicsParent=function(){return this.object.parent instanceof d.AbstractMesh?this.object.parent.physicsImpostor:null},p.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},p.prototype.setScalingUpdated=function(){this.forceUpdate()},p.prototype.forceUpdate=function(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()},Object.defineProperty(p.prototype,'physicsBody',{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(t){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=t,this.resetUpdateFlags()},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,'parent',{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(t){this._parent=t},enumerable:!0,configurable:!0}),p.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},p.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var t=this.object.rotationQuaternion;this.object.rotationQuaternion=p.IDENTITY_QUATERNION,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);var e=this.object.getBoundingInfo(),o=e.boundingBox.extendSizeWorld.scale(2);return this.object.rotationQuaternion=t,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),o}return p.DEFAULT_OBJECT_SIZE},p.prototype.getObjectCenter=function(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position},p.prototype.getParam=function(t){return this._options[t]},p.prototype.setParam=function(r,e){this._options[r]=e,this._bodyUpdateRequired=!0},p.prototype.setMass=function(t){this.getParam('mass')!==t&&this.setParam('mass',t),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,t)},p.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):d.Vector3.Zero()},p.prototype.setLinearVelocity=function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,t)},p.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):d.Vector3.Zero()},p.prototype.setAngularVelocity=function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,t)},p.prototype.executeNativeFunction=function(t){this._physicsEngine&&t(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},p.prototype.registerBeforePhysicsStep=function(t){this._onBeforePhysicsStepCallbacks.push(t)},p.prototype.unregisterBeforePhysicsStep=function(e){var t=this._onBeforePhysicsStepCallbacks.indexOf(e);-1<t?this._onBeforePhysicsStepCallbacks.splice(t,1):d.Tools.Warn('Function to remove was not found')},p.prototype.registerAfterPhysicsStep=function(t){this._onAfterPhysicsStepCallbacks.push(t)},p.prototype.unregisterAfterPhysicsStep=function(e){var t=this._onAfterPhysicsStepCallbacks.indexOf(e);-1<t?this._onAfterPhysicsStepCallbacks.splice(t,1):d.Tools.Warn('Function to remove was not found')},p.prototype.registerOnPhysicsCollide=function(r,e){var o=r instanceof Array?r:[r];this._onPhysicsCollideCallbacks.push({callback:e,otherImpostors:o})},p.prototype.unregisterOnPhysicsCollide=function(e,t){var o=e instanceof Array?e:[e],a=this._onPhysicsCollideCallbacks.indexOf({callback:t,otherImpostors:o});-1<a?this._onPhysicsCollideCallbacks.splice(a,1):d.Tools.Warn('Function to remove was not found')},p.prototype.getParentsRotation=function(){var e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):d.Quaternion.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat},p.prototype.applyForce=function(r,e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,r,e),this},p.prototype.applyImpulse=function(r,e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,r,e),this},p.prototype.createJoint=function(e,t,o){var r=new d.PhysicsJoint(t,o);return this.addJoint(e,r),this},p.prototype.addJoint=function(r,o){return this._joints.push({otherImpostor:r,joint:o}),this._physicsEngine&&this._physicsEngine.addJoint(this,r,o),this},p.prototype.sleep=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this},p.prototype.wakeUp=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this},p.prototype.clone=function(t){return t?new p(t,this.type,this._options,this._scene):null},p.prototype.dispose=function(){var r=this;this._physicsEngine&&(this._joints.forEach(function(e){r._physicsEngine&&r._physicsEngine.removeJoint(r,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)},p.prototype.setDeltaPosition=function(t){this._deltaPosition.copyFrom(t)},p.prototype.setDeltaRotation=function(e){this._deltaRotation||(this._deltaRotation=new d.Quaternion),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()},p.prototype.getBoxSizeToRef=function(t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,t),this},p.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0},p.prototype.syncBoneWithImpostor=function(e,t,r,i,o){var n=p._tmpVecs[0],a=this.object;if(a.rotationQuaternion)if(o){var s=p._tmpQuat;a.rotationQuaternion.multiplyToRef(o,s),e.setRotationQuaternion(s,d.Space.WORLD,t)}else e.setRotationQuaternion(a.rotationQuaternion,d.Space.WORLD,t);n.x=0,n.y=0,n.z=0,r&&(n.x=r.x,n.y=r.y,n.z=r.z,e.getDirectionToRef(n,t,n),void 0!==i&&null!==i||(i=r.length()),n.x*=i,n.y*=i,n.z*=i),e.getParent()?(n.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)},p.prototype.syncImpostorWithBone=function(e,t,r,i,o,n){var a=this.object;if(a.rotationQuaternion)if(o){var s=p._tmpQuat;e.getRotationQuaternionToRef(d.Space.WORLD,t,s),s.multiplyToRef(o,a.rotationQuaternion)}else e.getRotationQuaternionToRef(d.Space.WORLD,t,a.rotationQuaternion);var l=p._tmpVecs[0],c=p._tmpVecs[1];n||(n=p._tmpVecs[2],n.x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,c),e.getAbsolutePositionToRef(t,l),(void 0===i||null===i)&&r&&(i=r.length()),void 0!==i&&null!==i&&(l.x+=c.x*i,l.y+=c.y*i,l.z+=c.z*i),a.setAbsolutePosition(l)},p.DEFAULT_OBJECT_SIZE=new d.Vector3(1,1,1),p.IDENTITY_QUATERNION=d.Quaternion.Identity(),p._tmpVecs=[d.Vector3.Zero(),d.Vector3.Zero(),d.Vector3.Zero()],p._tmpQuat=d.Quaternion.Identity(),p.NoImpostor=0,p.SphereImpostor=1,p.BoxImpostor=2,p.PlaneImpostor=3,p.MeshImpostor=4,p.CylinderImpostor=7,p.ParticleImpostor=8,p.HeightmapImpostor=9,p}();d.PhysicsImpostor=e}(e||(e={}));var e;!function(r){var e=function(){function e(e,o){if(void 0===o&&(o=new r.CannonJSPlugin),this._physicsPlugin=o,this._impostors=[],this._joints=[],!this._physicsPlugin.isSupported())throw new Error('Physics Engine '+this._physicsPlugin.name+' cannot be found. Please make sure it is included.');e=e||new r.Vector3(0,-9.807,0),this.setGravity(e),this.setTimeStep()}return e.prototype.setGravity=function(t){this.gravity=t,this._physicsPlugin.setGravity(this.gravity)},e.prototype.setTimeStep=function(t){void 0===t&&(t=1/60),this._physicsPlugin.setTimeStep(t)},e.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()},e.prototype.dispose=function(){this._impostors.forEach(function(t){t.dispose()}),this._physicsPlugin.dispose()},e.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},e.prototype.addImpostor=function(t){t.uniqueId=this._impostors.push(t),t.parent||this._physicsPlugin.generatePhysicsBody(t)},e.prototype.removeImpostor=function(r){var e=this._impostors.indexOf(r);if(-1<e){var t=this._impostors.splice(e,1);t.length&&(t[0].physicsBody=null)}},e.prototype.addJoint=function(o,a,n){var s={mainImpostor:o,connectedImpostor:a,joint:n};n.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)},e.prototype.removeJoint=function(o,e,t){var i=this._joints.filter(function(i){return i.connectedImpostor===e&&i.joint===t&&i.mainImpostor===o});i.length&&this._physicsPlugin.removeJoint(i[0])},e.prototype._step=function(r){var o=this;this._impostors.forEach(function(t){t.isBodyInitRequired()&&o._physicsPlugin.generatePhysicsBody(t)}),.1<r?r=.1:0>=r&&(r=1/60),this._physicsPlugin.executeStep(r,this._impostors)},e.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},e.prototype.getImpostors=function(){return this._impostors},e.prototype.getImpostorForPhysicsObject=function(r){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].object===r)return this._impostors[e];return null},e.prototype.getImpostorWithPhysicsBody=function(r){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].physicsBody===r)return this._impostors[e];return null},e.Epsilon=.001,e}();r.PhysicsEngine=e}(e||(e={}));var e;!function(_){var e=function(){function e(e){this._scene=e,this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine||_.Tools.Warn('Physics engine not enabled. Please enable the physics before you can use the methods.')}return e.prototype.applyRadialExplosionImpulse=function(s,t,r,n){if(void 0===n&&(n=m.Constant),!this._physicsEngine)return _.Tools.Warn('Physics engine not enabled. Please enable the physics before you call this method.'),null;var e=this._physicsEngine.getImpostors();if(0===e.length)return null;var o=new d(this._scene);return e.forEach(function(a){var e=o.getImpostorForceAndContactPoint(a,s,t,r,n);e&&a.applyImpulse(e.force,e.contactPoint)}),o.dispose(!1),o},e.prototype.applyRadialExplosionForce=function(s,t,r,n){if(void 0===n&&(n=m.Constant),!this._physicsEngine)return _.Tools.Warn('Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.'),null;var e=this._physicsEngine.getImpostors();if(0===e.length)return null;var o=new d(this._scene);return e.forEach(function(a){var e=o.getImpostorForceAndContactPoint(a,s,t,r,n);e&&a.applyForce(e.force,e.contactPoint)}),o.dispose(!1),o},e.prototype.gravitationalField=function(e,t,r,i){if(void 0===i&&(i=m.Constant),!this._physicsEngine)return _.Tools.Warn('Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.'),null;if(0===this._physicsEngine.getImpostors().length)return null;var o=new l(this,this._scene,e,t,r,i);return o.dispose(!1),o},e.prototype.updraft=function(e,t,i,r,o){if(void 0===o&&(o=u.Center),!this._physicsEngine)return _.Tools.Warn('Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.'),null;if(0===this._physicsEngine.getImpostors().length)return null;var a=new c(this._scene,e,t,i,r,o);return a.dispose(!1),a},e.prototype.vortex=function(e,t,o,r){if(!this._physicsEngine)return _.Tools.Warn('Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.'),null;if(0===this._physicsEngine.getImpostors().length)return null;var i=new p(this._scene,e,t,o,r);return i.dispose(!1),i},e}();_.PhysicsHelper=e;var d=function(){function e(t){this._sphereOptions={segments:32,diameter:1},this._rays=[],this._dataFetched=!1,this._scene=t}return e.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere,rays:this._rays}},e.prototype.getImpostorForceAndContactPoint=function(e,t,i,r,n){if(0===e.mass)return null;if(!this._intersectsWithSphere(e,t,i))return null;if('Mesh'!==e.object.getClassName()&&'InstancedMesh'!==e.object.getClassName())return null;var o=e.getObjectCenter(),a=o.subtract(t),s=new _.Ray(t,a,i);this._rays.push(s);var l=s.intersectsMesh(e.object),c=l.pickedPoint;if(!c)return null;var p=_.Vector3.Distance(t,c);if(p>i)return null;var f=n===m.Constant?r:r*(1-p/i);return{force:a.multiplyByFloats(f,f,f),contactPoint:c}},e.prototype.dispose=function(r){var e=this;void 0===r&&(r=!0),r?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},e.prototype._prepareSphere=function(){this._sphere||(this._sphere=_.MeshBuilder.CreateSphere('radialExplosionEventSphere',this._sphereOptions,this._scene),this._sphere.isVisible=!1)},e.prototype._intersectsWithSphere=function(e,t,o){var r=e.object;return this._prepareSphere(),this._sphere.position=t,this._sphere.scaling=new _.Vector3(2*o,2*o,2*o),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(r,!0)},e}();_.PhysicsRadialExplosionEvent=d;var l=function(){function t(a,s,t,i,r,n){void 0===n&&(n=m.Constant),this._dataFetched=!1,this._physicsHelper=a,this._scene=s,this._origin=t,this._radius=i,this._strength=r,this._falloff=n,this._tickCallback=this._tick.bind(this)}return t.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},t.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},t.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},t.prototype.dispose=function(r){var e=this;void 0===r&&(r=!0),r?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},t.prototype._tick=function(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,-1*this._strength,this._falloff);else{var t=this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,-1*this._strength,this._falloff);t&&(this._sphere=t.getData().sphere.clone('radialExplosionEventSphereClone'))}},t}();_.PhysicsGravitationalFieldEvent=l;var c=function(){function e(e,a,i,r,n,o){this._scene=e,this._origin=a,this._radius=i,this._strength=r,this._height=n,this._updraftMode=o,this._originTop=_.Vector3.Zero(),this._originDirection=_.Vector3.Zero(),this._cylinderPosition=_.Vector3.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._origin.addToRef(new _.Vector3(0,this._height/2,0),this._cylinderPosition),this._origin.addToRef(new _.Vector3(0,this._height,0),this._originTop),this._updraftMode===u.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this)}return e.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},e.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},e.prototype.dispose=function(r){var e=this;void 0===r&&(r=!0),r?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0)},e.prototype.getImpostorForceAndContactPoint=function(o){if(0===o.mass)return null;if(!this._intersectsWithCylinder(o))return null;var e=o.getObjectCenter();if(this._updraftMode===u.Perpendicular)var a=this._originDirection;else var a=e.subtract(this._originTop);var i=-1*this._strength;return{force:a.multiplyByFloats(i,i,i),contactPoint:e}},e.prototype._tick=function(){var r=this;this._physicsEngine.getImpostors().forEach(function(e){var t=r.getImpostorForceAndContactPoint(e);t&&e.applyForce(t.force,t.contactPoint)})},e.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=_.MeshBuilder.CreateCylinder('updraftEventCylinder',{height:this._height,diameter:2*this._radius},this._scene),this._cylinder.isVisible=!1)},e.prototype._intersectsWithCylinder=function(r){var e=r.object;return this._prepareCylinder(),this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},e}();_.PhysicsUpdraftEvent=c;var p=function(){function e(e,a,i,r,n){this._scene=e,this._origin=a,this._radius=i,this._strength=r,this._height=n,this._originTop=_.Vector3.Zero(),this._centripetalForceThreshold=.7,this._updraftMultiplier=.02,this._cylinderPosition=_.Vector3.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._origin.addToRef(new _.Vector3(0,this._height/2,0),this._cylinderPosition),this._origin.addToRef(new _.Vector3(0,this._height,0),this._originTop),this._tickCallback=this._tick.bind(this)}return e.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},e.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},e.prototype.dispose=function(r){var e=this;void 0===r&&(r=!0),r?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0)},e.prototype.getImpostorForceAndContactPoint=function(e){if(0===e.mass)return null;if(!this._intersectsWithCylinder(e))return null;if('Mesh'!==e.object.getClassName()&&'InstancedMesh'!==e.object.getClassName())return null;var t=e.getObjectCenter(),m=new _.Vector3(this._origin.x,t.y,this._origin.z),r=t.subtract(m),n=new _.Ray(m,r,this._radius),o=n.intersectsMesh(e.object),s=o.pickedPoint;if(!s)return null;var g=o.distance/this._radius,l=_.Vector3.Cross(m,t).normalize(),h=s.normalize();if(g>this._centripetalForceThreshold&&(h=h.negate()),g>this._centripetalForceThreshold)var c=h.x*this._strength/8,u=h.y*this._updraftMultiplier,f=h.z*this._strength/8;else var c=(l.x+h.x)/2,u=this._originTop.y*this._updraftMultiplier,f=(l.z+h.z)/2;var d=new _.Vector3(c,u,f);return d=d.multiplyByFloats(this._strength,this._strength,this._strength),{force:d,contactPoint:t}},e.prototype._tick=function(){var r=this;this._physicsEngine.getImpostors().forEach(function(e){var t=r.getImpostorForceAndContactPoint(e);t&&e.applyForce(t.force,t.contactPoint)})},e.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=_.MeshBuilder.CreateCylinder('vortexEventCylinder',{height:this._height,diameter:2*this._radius},this._scene),this._cylinder.isVisible=!1)},e.prototype._intersectsWithCylinder=function(r){var e=r.object;return this._prepareCylinder(),this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},e}();_.PhysicsVortexEvent=p;var m;!function(t){t[t.Constant=0]='Constant',t[t.Linear=1]='Linear'}(m=_.PhysicsRadialImpulseFalloff||(_.PhysicsRadialImpulseFalloff={}));var u;!function(t){t[t.Center=0]='Center',t[t.Perpendicular=1]='Perpendicular'}(u=_.PhysicsUpdraftMode||(_.PhysicsUpdraftMode={}))}(e||(e={}));var e;!function(T){var e=function(){function e(e,t){return(void 0===e&&(e=!0),void 0===t&&(t=10),this._useDeltaForWorldStep=e,this.name='CannonJSPlugin',this._physicsMaterials=[],this._fixedTimeStep=1/60,this.BJSCANNON=d,this._minus90X=new T.Quaternion(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new T.Quaternion(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=T.Vector3.Zero(),this._tmpDeltaPosition=T.Vector3.Zero(),this._tmpUnityRotation=new T.Quaternion,!this.isSupported())?void T.Tools.Error('CannonJS is not available. Please make sure you included the js file.'):void(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t)}return e.prototype.setGravity=function(t){this.world.gravity.copy(t)},e.prototype.setTimeStep=function(t){this._fixedTimeStep=t},e.prototype.getTimeStep=function(){return this._fixedTimeStep},e.prototype.executeStep=function(t){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?t:0,3)},e.prototype.applyImpulse=function(o,e,t){var i=new this.BJSCANNON.Vec3(t.x,t.y,t.z),r=new this.BJSCANNON.Vec3(e.x,e.y,e.z);o.physicsBody.applyImpulse(r,i)},e.prototype.applyForce=function(o,e,t){var i=new this.BJSCANNON.Vec3(t.x,t.y,t.z),r=new this.BJSCANNON.Vec3(e.x,e.y,e.z);o.physicsBody.applyForce(r,i)},e.prototype.generatePhysicsBody=function(a){if(a.parent)return void(a.physicsBody&&(this.removePhysicsBody(a),a.forceUpdate()));if(a.isBodyInitRequired()){var e=this._createShape(a),l=a.physicsBody;l&&this.removePhysicsBody(a);var t=this._addMaterial('mat-'+a.uniqueId,a.getParam('friction'),a.getParam('restitution')),i={mass:a.getParam('mass'),material:t},n=a.getParam('nativeOptions');for(var o in n)n.hasOwnProperty(o)&&(i[o]=n[o]);a.physicsBody=new this.BJSCANNON.Body(i),a.physicsBody.addEventListener('collide',a.onCollide),this.world.addEventListener('preStep',a.beforeStep),this.world.addEventListener('postStep',a.afterStep),a.physicsBody.addShape(e),this.world.add(a.physicsBody),l&&['force','torque','velocity','angularVelocity'].forEach(function(e){a.physicsBody[e].copy(l[e])}),this._processChildMeshes(a)}this._updatePhysicsBodyTransformation(a)},e.prototype._processChildMeshes=function(t){var e=this,i=t.object.getChildMeshes?t.object.getChildMeshes(!0):[],d=t.object.rotationQuaternion;if(i.length){var r=function(o,i){if(d&&i.rotationQuaternion){var n=i.getPhysicsImpostor();if(n&&n.parent!==t){var a=i.getAbsolutePosition().subtract(t.object.getAbsolutePosition()),s=i.rotationQuaternion.multiply(T.Quaternion.Inverse(d));n.physicsBody&&(e.removePhysicsBody(n),n.physicsBody=null),n.parent=t,n.resetUpdateFlags(),t.physicsBody.addShape(e._createShape(n),new e.BJSCANNON.Vec3(a.x,a.y,a.z),new e.BJSCANNON.Quaternion(s.x,s.y,s.z,s.w)),t.physicsBody.mass+=n.getParam('mass')}d.multiplyInPlace(i.rotationQuaternion),i.getChildMeshes(!0).filter(function(t){return!!t.physicsImpostor}).forEach(r.bind(e,i.getAbsolutePosition()))}};i.filter(function(t){return!!t.physicsImpostor}).forEach(r.bind(this,t.object.getAbsolutePosition()))}},e.prototype.removePhysicsBody=function(t){t.physicsBody.removeEventListener('collide',t.onCollide),this.world.removeEventListener('preStep',t.beforeStep),this.world.removeEventListener('postStep',t.afterStep),this.world.remove(t.physicsBody)},e.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(e&&i){var r=t.joint.jointData,o={pivotA:r.mainPivot?new this.BJSCANNON.Vec3().copy(r.mainPivot):null,pivotB:r.connectedPivot?new this.BJSCANNON.Vec3().copy(r.connectedPivot):null,axisA:r.mainAxis?new this.BJSCANNON.Vec3().copy(r.mainAxis):null,axisB:r.connectedAxis?new this.BJSCANNON.Vec3().copy(r.connectedAxis):null,maxForce:r.nativeParams.maxForce,collideConnected:!!r.collision},s;switch(t.joint.type){case T.PhysicsJoint.HingeJoint:case T.PhysicsJoint.Hinge2Joint:s=new this.BJSCANNON.HingeConstraint(e,i,o);break;case T.PhysicsJoint.DistanceJoint:s=new this.BJSCANNON.DistanceConstraint(e,i,r.maxDistance||2);break;case T.PhysicsJoint.SpringJoint:var n=r;s=new this.BJSCANNON.Spring(e,i,{restLength:n.length,stiffness:n.stiffness,damping:n.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break;case T.PhysicsJoint.LockJoint:s=new this.BJSCANNON.LockConstraint(e,i,o);break;case T.PhysicsJoint.PointToPointJoint:case T.PhysicsJoint.BallAndSocketJoint:default:s=new this.BJSCANNON.PointToPointConstraint(e,o.pivotA,i,o.pivotA,o.maxForce);}s.collideConnected=!!r.collision,t.joint.physicsJoint=s,t.joint.type===T.PhysicsJoint.SpringJoint?t.mainImpostor.registerAfterPhysicsStep(function(){s.applyForce()}):this.world.addConstraint(s)}},e.prototype.removeJoint=function(t){this.world.removeConstraint(t.joint.physicsJoint)},e.prototype._addMaterial=function(a,e,t){var i,r;for(i=0;i<this._physicsMaterials.length;i++)if(r=this._physicsMaterials[i],r.friction===e&&r.restitution===t)return r;var n=new this.BJSCANNON.Material(a);return n.friction=e,n.restitution=t,this._physicsMaterials.push(n),n},e.prototype._checkWithEpsilon=function(t){return t<T.PhysicsEngine.Epsilon?T.PhysicsEngine.Epsilon:t},e.prototype._createShape=function(t){var e=t.object,r=t.getObjectExtendSize(),n;switch(t.type){case T.PhysicsImpostor.SphereImpostor:var i=r.x,o=r.y,s=r.z;n=new this.BJSCANNON.Sphere(W(this._checkWithEpsilon(i),this._checkWithEpsilon(o),this._checkWithEpsilon(s))/2);break;case T.PhysicsImpostor.CylinderImpostor:n=new this.BJSCANNON.Cylinder(this._checkWithEpsilon(r.x)/2,this._checkWithEpsilon(r.x)/2,this._checkWithEpsilon(r.y),16);break;case T.PhysicsImpostor.BoxImpostor:var a=r.scale(.5);n=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(a.x),this._checkWithEpsilon(a.y),this._checkWithEpsilon(a.z)));break;case T.PhysicsImpostor.PlaneImpostor:T.Tools.Warn('Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead'),n=new this.BJSCANNON.Plane;break;case T.PhysicsImpostor.MeshImpostor:var l=e.getVerticesData?e.getVerticesData(T.VertexBuffer.PositionKind):[],x=e.getIndices?e.getIndices():[];if(!l)return;var c=e.position.clone(),u=e.rotation&&e.rotation.clone(),f=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace();var d=e.computeWorldMatrix(!0),_=[],m;for(m=0;m<l.length;m+=3)T.Vector3.TransformCoordinates(T.Vector3.FromArray(l,m),d).toArray(_,m);T.Tools.Warn('MeshImpostor only collides against spheres.'),n=new this.BJSCANNON.Trimesh(_,x),e.position.copyFrom(c),u&&e.rotation&&e.rotation.copyFrom(u),f&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(f);break;case T.PhysicsImpostor.HeightmapImpostor:var p=e.position.clone(),g=e.rotation&&e.rotation.clone(),b=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace(),e.rotationQuaternion&&e.rotationQuaternion.multiplyInPlace(this._minus90X),n=this._createHeightmap(e),e.position.copyFrom(p),g&&e.rotation&&e.rotation.copyFrom(g),b&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(b),e.computeWorldMatrix(!0);break;case T.PhysicsImpostor.ParticleImpostor:n=new this.BJSCANNON.Particle;}return n},e.prototype._createHeightmap=function(t,e){var i=t.getVerticesData(T.VertexBuffer.PositionKind),n=t.computeWorldMatrix(!0),o=[],s;for(s=0;s<i.length;s+=3)T.Vector3.TransformCoordinates(T.Vector3.FromArray(i,s),n).toArray(o,s);i=o;for(var r=[],a=e||~~($(i.length/3)-1),l=t.getBoundingInfo(),h=C(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.y),c=l.boundingBox.extendSizeWorld.z,u=2*h/a,x=0;x<i.length;x+=3){var d=O(i[x+0]/u+a/2),p=O(-1*(i[x+1]/u-a/2)),_=-i[x+2]+c;r[d]||(r[d]=[]),r[d][p]||(r[d][p]=_),r[d][p]=W(_,r[d][p])}for(var d=0;d<=a;++d){if(!r[d]){for(var m=1;!r[(d+m)%a];)m++;r[d]=r[(d+m)%a].slice()}for(var p=0;p<=a;++p)if(!r[d][p]){for(var m=1,g;void 0===g;)g=r[d][(p+m++)%a];r[d][p]=g}}var b=new this.BJSCANNON.Heightfield(r,{elementSize:u});return b.minY=c,b},e.prototype._updatePhysicsBodyTransformation=function(t){var e=t.object;if(e.computeWorldMatrix&&e.computeWorldMatrix(!0),e.getBoundingInfo()){var i=t.getObjectCenter();this._tmpDeltaPosition.copyFrom(e.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(t.object.scaling),this._tmpPosition.copyFrom(i);var r=e.rotationQuaternion;if(r){if(t.type!==T.PhysicsImpostor.PlaneImpostor&&t.type!==T.PhysicsImpostor.HeightmapImpostor&&t.type!==T.PhysicsImpostor.CylinderImpostor||(r=r.multiply(this._minus90X),t.setDeltaRotation(this._plus90X)),t.type===T.PhysicsImpostor.HeightmapImpostor){var n=e,o=n.getBoundingInfo(),s=n.rotationQuaternion;n.rotationQuaternion=this._tmpUnityRotation,n.computeWorldMatrix(!0);var a=i.clone(),l=n.getPivotMatrix()||T.Matrix.Translation(0,0,0),d=T.Matrix.Translation(o.boundingBox.extendSizeWorld.x,0,-o.boundingBox.extendSizeWorld.z);n.setPreTransformMatrix(d),n.computeWorldMatrix(!0);var c=o.boundingBox.centerWorld.subtract(i).subtract(n.position).negate();this._tmpPosition.copyFromFloats(c.x,c.y-o.boundingBox.extendSizeWorld.y,c.z),this._tmpDeltaPosition.copyFrom(o.boundingBox.centerWorld.subtract(a)),this._tmpDeltaPosition.y+=o.boundingBox.extendSizeWorld.y,n.rotationQuaternion=s,n.setPreTransformMatrix(l),n.computeWorldMatrix(!0)}else t.type===T.PhysicsImpostor.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpDeltaPosition),t.physicsBody.position.copy(this._tmpPosition),t.physicsBody.quaternion.copy(r)}}},e.prototype.setTransformationFromPhysicsBody=function(t){t.object.position.copyFrom(t.physicsBody.position),t.object.rotationQuaternion&&t.object.rotationQuaternion.copyFrom(t.physicsBody.quaternion)},e.prototype.setPhysicsBodyTransformation=function(r,e,t){r.physicsBody.position.copy(e),r.physicsBody.quaternion.copy(t)},e.prototype.isSupported=function(){return void 0!==this.BJSCANNON},e.prototype.setLinearVelocity=function(r,e){r.physicsBody.velocity.copy(e)},e.prototype.setAngularVelocity=function(r,e){r.physicsBody.angularVelocity.copy(e)},e.prototype.getLinearVelocity=function(t){var e=t.physicsBody.velocity;return e?new T.Vector3(e.x,e.y,e.z):null},e.prototype.getAngularVelocity=function(t){var e=t.physicsBody.angularVelocity;return e?new T.Vector3(e.x,e.y,e.z):null},e.prototype.setBodyMass=function(r,e){r.physicsBody.mass=e,r.physicsBody.updateMassProperties()},e.prototype.getBodyMass=function(t){return t.physicsBody.mass},e.prototype.getBodyFriction=function(t){return t.physicsBody.material.friction},e.prototype.setBodyFriction=function(r,e){r.physicsBody.material.friction=e},e.prototype.getBodyRestitution=function(t){return t.physicsBody.material.restitution},e.prototype.setBodyRestitution=function(r,e){r.physicsBody.material.restitution=e},e.prototype.sleepBody=function(t){t.physicsBody.sleep()},e.prototype.wakeUpBody=function(t){t.physicsBody.wakeUp()},e.prototype.updateDistanceJoint=function(r,e){r.physicsJoint.distance=e},e.prototype.setMotor=function(o,e,t,i){i||(o.physicsJoint.enableMotor(),o.physicsJoint.setMotorSpeed(e),t&&this.setLimit(o,t))},e.prototype.setLimit=function(r,e,o){r.physicsJoint.motorEquation.maxForce=e,r.physicsJoint.motorEquation.minForce=void 0===o?-e:o},e.prototype.syncMeshWithImpostor=function(r,e){var t=e.physicsBody;r.position.x=t.position.x,r.position.y=t.position.y,r.position.z=t.position.z,r.rotationQuaternion&&(r.rotationQuaternion.x=t.quaternion.x,r.rotationQuaternion.y=t.quaternion.y,r.rotationQuaternion.z=t.quaternion.z,r.rotationQuaternion.w=t.quaternion.w)},e.prototype.getRadius=function(t){return t.physicsBody.shapes[0].boundingSphereRadius},e.prototype.getBoxSizeToRef=function(r,e){var t=r.physicsBody.shapes[0];e.x=2*t.halfExtents.x,e.y=2*t.halfExtents.y,e.z=2*t.halfExtents.z},e.prototype.dispose=function(){},e.prototype._extendNamespace=function(){var r=new this.BJSCANNON.Vec3,e=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(t,i,p){if(p=p||10,0===(i=i||0))this.internalStep(t),this.time+=t;else{var n=ee((this.time+i)/t)-ee(this.time/t);n=C(n,p)||1;for(var o=performance.now(),s=0;s!==n&&(this.internalStep(t),!(performance.now()-o>1e3*t));s++);this.time+=i;for(var a=this.time%t,l=r,c=this.bodies,u=0,f;u!==c.length;u++)f=c[u],f.type!==e.Body.STATIC&&f.sleepState!==e.Body.SLEEPING?(f.position.vsub(f.previousPosition,l),l.scale(a/t,l),f.position.vadd(l,f.interpolatedPosition)):(f.interpolatedPosition.copy(f.position),f.interpolatedQuaternion.copy(f.quaternion))}}},e}();T.CannonJSPlugin=e}(e||(e={}));var e;!function(s){var e=function(){function e(e){this.name='OimoJSPlugin',this._tmpImpostorsArray=[],this._tmpPositionVector=s.Vector3.Zero(),this.BJSOIMO=c,this.world=new this.BJSOIMO.World({iterations:e}),this.world.clear()}return e.prototype.setGravity=function(t){this.world.gravity.copy(t)},e.prototype.setTimeStep=function(t){this.world.timeStep=t},e.prototype.getTimeStep=function(){return this.world.timeStep},e.prototype.executeStep=function(a,e){var t=this;e.forEach(function(t){t.beforeStep()}),this.world.step(),e.forEach(function(r){r.afterStep(),t._tmpImpostorsArray[r.uniqueId]=r});for(var i=this.world.contacts;null!==i;)if(!i.touching||i.body1.sleeping||i.body2.sleeping){var r=this._tmpImpostorsArray[+i.body1.name],n=this._tmpImpostorsArray[+i.body2.name];r&&n?(r.onCollide({body:n.physicsBody}),n.onCollide({body:r.physicsBody}),i=i.next):i=i.next}else i=i.next},e.prototype.applyImpulse=function(o,e,t){var i=o.physicsBody.mass;o.physicsBody.applyImpulse(t.scale(this.world.invScale),e.scale(this.world.invScale*i))},e.prototype.applyForce=function(e,t,o){s.Tools.Warn('Oimo doesn\'t support applying force. Using impule instead.'),this.applyImpulse(e,t,o)},e.prototype.generatePhysicsBody=function(e){var t=this;if(e.parent)return void(e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate()));if(e.isBodyInitRequired()){var i={name:e.uniqueId,config:[e.getParam('mass')||1,e.getParam('friction'),e.getParam('restitution')],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam('mass'),density:e.getParam('mass'),friction:e.getParam('friction'),restitution:e.getParam('restitution'),world:this.world},r=[e];!function(t){t.getChildMeshes&&t.getChildMeshes().forEach(function(t){t.physicsImpostor&&r.push(t.physicsImpostor)})}(e.object);var a=function(e){return W(e,s.PhysicsEngine.Epsilon)};r.forEach(function(r){if(r.object.rotationQuaternion){var o=r.object.rotationQuaternion,n=o.toEulerAngles(),y=r.getObjectExtendSize(),l=57.29577951308232;if(r===e){var h=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(h,t._tmpPositionVector),t._tmpPositionVector.divideInPlace(e.object.scaling),i.pos.push(h.x),i.pos.push(h.y),i.pos.push(h.z),i.posShape.push(0,0,0),i.rot.push(n.x*l),i.rot.push(n.y*l),i.rot.push(n.z*l),i.rotShape.push(0,0,0)}else{var c=r.object.getAbsolutePosition().subtract(e.object.getAbsolutePosition());i.posShape.push(c.x),i.posShape.push(c.y),i.posShape.push(c.z),i.pos.push(0,0,0),i.rot.push(0),i.rot.push(0),i.rot.push(0),i.rotShape.push(n.x*l),i.rotShape.push(n.y*l),i.rotShape.push(n.z*l)}switch(r.type){case s.PhysicsImpostor.ParticleImpostor:s.Tools.Warn('No Particle support in OIMO.js. using SphereImpostor instead');case s.PhysicsImpostor.SphereImpostor:var u=y.x,f=y.y,d=y.z,p=W(a(u),a(f),a(d))/2;i.type.push('sphere'),i.size.push(p),i.size.push(p),i.size.push(p);break;case s.PhysicsImpostor.CylinderImpostor:var _=a(y.x)/2,m=a(y.y);i.type.push('cylinder'),i.size.push(_),i.size.push(m),i.size.push(m);break;case s.PhysicsImpostor.PlaneImpostor:case s.PhysicsImpostor.BoxImpostor:default:var _=a(y.x),m=a(y.y),g=a(y.z);i.type.push('box'),i.size.push(_),i.size.push(m),i.size.push(g);}r.object.rotationQuaternion=o}}),e.physicsBody=this.world.add(i)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)},e.prototype.removePhysicsBody=function(t){this.world.removeRigidBody(t.physicsBody)},e.prototype.generateJoint=function(e){var t=e.mainImpostor.physicsBody,l=e.connectedImpostor.physicsBody;if(t&&l){var d=e.joint.jointData,o=d.nativeParams||{},c={body1:t,body2:l,axe1:o.axe1||(d.mainAxis?d.mainAxis.asArray():null),axe2:o.axe2||(d.connectedAxis?d.connectedAxis.asArray():null),pos1:o.pos1||(d.mainPivot?d.mainPivot.asArray():null),pos2:o.pos2||(d.connectedPivot?d.connectedPivot.asArray():null),min:o.min,max:o.max,collision:o.collision||d.collision,spring:o.spring,world:this.world},a;switch(e.joint.type){case s.PhysicsJoint.BallAndSocketJoint:a='jointBall';break;case s.PhysicsJoint.SpringJoint:s.Tools.Warn('OIMO.js doesn\'t support Spring Constraint. Simulating using DistanceJoint instead');c.min=d.length||c.min,c.max=W(c.min,c.max);case s.PhysicsJoint.DistanceJoint:a='jointDistance',c.max=d.maxDistance;break;case s.PhysicsJoint.PrismaticJoint:a='jointPrisme';break;case s.PhysicsJoint.SliderJoint:a='jointSlide';break;case s.PhysicsJoint.WheelJoint:a='jointWheel';break;case s.PhysicsJoint.HingeJoint:default:a='jointHinge';}c.type=a,e.joint.physicsJoint=this.world.add(c)}},e.prototype.removeJoint=function(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){s.Tools.Warn(e)}},e.prototype.isSupported=function(){return void 0!==this.BJSOIMO},e.prototype.setTransformationFromPhysicsBody=function(t){t.physicsBody.sleeping||(t.object.position.copyFrom(t.physicsBody.getPosition()),t.object.rotationQuaternion&&t.object.rotationQuaternion.copyFrom(t.physicsBody.getQuaternion()))},e.prototype.setPhysicsBodyTransformation=function(o,e,t){var i=o.physicsBody;i.position.copy(e),i.orientation.copy(t),i.syncShapes(),i.awake()},e.prototype.setLinearVelocity=function(r,e){r.physicsBody.linearVelocity.init(e.x,e.y,e.z)},e.prototype.setAngularVelocity=function(r,e){r.physicsBody.angularVelocity.init(e.x,e.y,e.z)},e.prototype.getLinearVelocity=function(e){var t=e.physicsBody.linearVelocity;return t?new s.Vector3(t.x,t.y,t.z):null},e.prototype.getAngularVelocity=function(e){var t=e.physicsBody.angularVelocity;return t?new s.Vector3(t.x,t.y,t.z):null},e.prototype.setBodyMass=function(r,e){var t=0===e;r.physicsBody.shapes.density=t?1:e,r.physicsBody.setupMass(t?2:1)},e.prototype.getBodyMass=function(t){return t.physicsBody.shapes.density},e.prototype.getBodyFriction=function(t){return t.physicsBody.shapes.friction},e.prototype.setBodyFriction=function(r,e){r.physicsBody.shapes.friction=e},e.prototype.getBodyRestitution=function(t){return t.physicsBody.shapes.restitution},e.prototype.setBodyRestitution=function(r,e){r.physicsBody.shapes.restitution=e},e.prototype.sleepBody=function(t){t.physicsBody.sleep()},e.prototype.wakeUpBody=function(t){t.physicsBody.awake()},e.prototype.updateDistanceJoint=function(r,e,t){r.physicsJoint.limitMotor.upperLimit=e,void 0!==t&&(r.physicsJoint.limitMotor.lowerLimit=t)},e.prototype.setMotor=function(o,e,t,i){var r=i?o.physicsJoint.rotationalLimitMotor2:o.physicsJoint.rotationalLimitMotor1||o.physicsJoint.rotationalLimitMotor||o.physicsJoint.limitMotor;r&&r.setMotor(e,t)},e.prototype.setLimit=function(o,e,a,i){var r=i?o.physicsJoint.rotationalLimitMotor2:o.physicsJoint.rotationalLimitMotor1||o.physicsJoint.rotationalLimitMotor||o.physicsJoint.limitMotor;r&&r.setLimit(e,void 0===a?-e:a)},e.prototype.syncMeshWithImpostor=function(r,e){var t=e.physicsBody;r.position.x=t.position.x,r.position.y=t.position.y,r.position.z=t.position.z,r.rotationQuaternion&&(r.rotationQuaternion.x=t.orientation.x,r.rotationQuaternion.y=t.orientation.y,r.rotationQuaternion.z=t.orientation.z,r.rotationQuaternion.w=t.orientation.s)},e.prototype.getRadius=function(t){return t.physicsBody.shapes.radius},e.prototype.getBoxSizeToRef=function(r,e){var t=r.physicsBody.shapes;e.x=2*t.halfWidth,e.y=2*t.halfHeight,e.z=2*t.halfDepth},e.prototype.dispose=function(){this.world.clear()},e}();s.OimoJSPlugin=e}(e||(e={}));var e;!function(S){var e=function(){function e(){}return e.GetTGAHeader=function(r){var e=0;return{id_length:r[e++],colormap_type:r[e++],image_type:r[e++],colormap_index:r[e++]|r[e++]<<8,colormap_length:r[e++]|r[e++]<<8,colormap_size:r[e++],origin:[r[e++]|r[e++]<<8,r[e++]|r[e++]<<8],width:r[e++]|r[e++]<<8,height:r[e++]|r[e++]<<8,pixel_size:r[e++],flags:r[e++]}},e.UploadContent=function(t,i){if(19>i.length)return void S.Tools.Error('Unable to load TGA file - Not enough data to contain header');var r=18,n=e.GetTGAHeader(i);if(n.id_length+r>i.length)return void S.Tools.Error('Unable to load TGA file - Not enough data');r+=n.id_length;var o=!1,s=!1,a=!1;switch(n.image_type){case e._TYPE_RLE_INDEXED:o=!0;case e._TYPE_INDEXED:s=!0;break;case e._TYPE_RLE_RGB:o=!0;case e._TYPE_RGB:break;case e._TYPE_RLE_GREY:o=!0;case e._TYPE_GREY:a=!0;}var l=n.pixel_size>>3,u=n.width*n.height*l,f,h;if(s&&(h=i.subarray(r,r+=n.colormap_length*(n.colormap_size>>3))),o){f=new Uint8Array(u);for(var c=0,m=new Uint8Array(l),g,d,p;r<u&&c<u;)if(g=i[r++],d=1+(127&g),128&g){for(p=0;p<l;++p)m[p]=i[r++];for(p=0;p<d;++p)f.set(m,c+p*l);c+=l*d}else{for(d*=l,p=0;p<d;++p)f[c+p]=i[r++];c+=d}}else f=i.subarray(r,r+=s?n.width*n.height:u);var _,v,y,b,x,T;switch((n.flags&e._ORIGIN_MASK)>>e._ORIGIN_SHIFT){default:case e._ORIGIN_UL:_=0,y=1,T=n.width,v=0,b=1,x=n.height;break;case e._ORIGIN_BL:_=0,y=1,T=n.width,v=n.height-1,b=-1,x=-1;break;case e._ORIGIN_UR:_=n.width-1,y=-1,T=-1,v=0,b=1,x=n.height;break;case e._ORIGIN_BR:_=n.width-1,y=-1,T=-1,v=n.height-1,b=-1,x=-1;}var E='_getImageData'+(a?'Grey':'')+n.pixel_size+'bits',P=e[E](n,h,f,v,b,x,_,y,T);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n.width,n.height,0,t.RGBA,t.UNSIGNED_BYTE,P)},e._getImageData8bits=function(f,e,t,i,r,n,o,s,a){var l=e,d=f.width,p=f.height,_=0,m=new Uint8Array(4*(d*p)),g,h,c;for(c=i;c!==n;c+=r)for(h=o;h!==a;h+=s,_++)g=t[_],m[4*(h+d*c)+3]=255,m[4*(h+d*c)+2]=l[3*g+0],m[4*(h+d*c)+1]=l[3*g+1],m[4*(h+d*c)+0]=l[3*g+2];return m},e._getImageData16bits=function(T,e,t,i,r,n,o,s,a){var l=t,f=T.width,d=T.height,p=0,_=new Uint8Array(4*(f*d)),m,h,c;for(c=i;c!==n;c+=r)for(h=o;h!==a;h+=s,p+=2){m=l[p+0]+(l[p+1]<<8);var u=0|255*((31744&m)>>10)/31,g=0|255*((992&m)>>5)/31,x=0|255*(31&m)/31;_[4*(h+f*c)+0]=u,_[4*(h+f*c)+1]=g,_[4*(h+f*c)+2]=x,_[4*(h+f*c)+3]=32768&m?0:255}return _},e._getImageData24bits=function(m,e,t,i,r,n,o,s,a){var l=t,u=m.width,f=m.height,d=0,p=new Uint8Array(4*(u*f)),_,g;for(g=i;g!==n;g+=r)for(_=o;_!==a;_+=s,d+=3)p[4*(_+u*g)+3]=255,p[4*(_+u*g)+2]=l[d+0],p[4*(_+u*g)+1]=l[d+1],p[4*(_+u*g)+0]=l[d+2];return p},e._getImageData32bits=function(m,e,t,i,r,n,o,s,a){var l=t,u=m.width,f=m.height,d=0,p=new Uint8Array(4*(u*f)),_,g;for(g=i;g!==n;g+=r)for(_=o;_!==a;_+=s,d+=4)p[4*(_+u*g)+2]=l[d+0],p[4*(_+u*g)+1]=l[d+1],p[4*(_+u*g)+0]=l[d+2],p[4*(_+u*g)+3]=l[d+3];return p},e._getImageDataGrey8bits=function(f,e,t,i,r,n,o,s,a){var l=f.width,d=f.height,p=0,_=new Uint8Array(4*(l*d)),m,g,c;for(c=i;c!==n;c+=r)for(g=o;g!==a;g+=s,p++)m=t[p],_[4*(g+l*c)+0]=m,_[4*(g+l*c)+1]=m,_[4*(g+l*c)+2]=m,_[4*(g+l*c)+3]=255;return _},e._getImageDataGrey16bits=function(m,e,t,i,r,n,o,s,a){var l=t,u=m.width,f=m.height,d=0,p=new Uint8Array(4*(u*f)),_,g;for(g=i;g!==n;g+=r)for(_=o;_!==a;_+=s,d+=2)p[4*(_+u*g)+0]=l[d+0],p[4*(_+u*g)+1]=l[d+0],p[4*(_+u*g)+2]=l[d+0],p[4*(_+u*g)+3]=l[d+1];return p},e._TYPE_INDEXED=1,e._TYPE_RGB=2,e._TYPE_GREY=3,e._TYPE_RLE_INDEXED=9,e._TYPE_RLE_RGB=10,e._TYPE_RLE_GREY=11,e._ORIGIN_MASK=48,e._ORIGIN_SHIFT=4,e._ORIGIN_BL=0,e._ORIGIN_BR=1,e._ORIGIN_UL=2,e._ORIGIN_UR=3,e}();S.TGATools=e}(e||(e={}));var e;!function(H){function e(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function t(t){return o(255&t,255&t>>8,255&t>>16,255&t>>24)}var d=e('DXT1'),r=e('DXT3'),n=e('DXT5'),p=e('DX10'),i=function(){function X(){}return X.GetDDSInfo=function(e){var t=new Int32Array(e,0,31),o=new Int32Array(e,0,35),i=1;131072&t[2]&&(i=W(1,t[7]));var a=t[21],s=a===p?o[32]:0,f=H.Engine.TEXTURETYPE_UNSIGNED_INT;switch(a){case 113:f=H.Engine.TEXTURETYPE_HALF_FLOAT;break;case 116:f=H.Engine.TEXTURETYPE_FLOAT;break;case p:if(10===s){f=H.Engine.TEXTURETYPE_HALF_FLOAT;break}}return{width:t[4],height:t[3],mipmapCount:i,isFourCC:4==(4&t[20]),isRGB:64==(64&t[20]),isLuminance:131072==(131072&t[20]),isCube:512==(512&t[28]),isCompressed:a===d||a===r||a===n,dxgiFormat:s,textureType:f}},X._ToHalfFloat=function(t){X._FloatView||(X._FloatView=new Float32Array(1),X._Int32View=new Int32Array(X._FloatView.buffer)),X._FloatView[0]=t;var e=X._Int32View[0],i=32768&e>>16,r=2047&e>>12,a=255&e>>23;return 103>a?i:142<a?(i|=31744,i|=(255==a?0:1)&&8388607&e):113>a?(r|=2048,i|=(r>>114-a)+(1&r>>113-a)):(i|=a-112<<10|r>>1,i+=1&r)},X._FromHalfFloat=function(o){var e=(32768&o)>>15,t=(31744&o)>>10,i=1023&o;return 0==t?0.00006103515625*(e?-1:1)*(i/1024):31==t?i?NaN:1/0*(e?-1:1):(e?-1:1)*x(2,t-15)*(1+i/1024)},X._GetHalfFloatAsFloatRGBAArrayBuffer=function(t,e,i,r,n,o){for(var s=new Float32Array(r),a=new Uint16Array(n,i),l=0,d=0;d<e;d++)for(var c=0,p;c<t;c++)p=4*(c+d*t),s[l]=X._FromHalfFloat(a[p]),s[l+1]=X._FromHalfFloat(a[p+1]),s[l+2]=X._FromHalfFloat(a[p+2]),s[l+3]=X.StoreLODInAlphaChannel?o:X._FromHalfFloat(a[p+3]),l+=4;return s},X._GetHalfFloatRGBAArrayBuffer=function(t,e,i,r,n,o){if(X.StoreLODInAlphaChannel){for(var s=new Uint16Array(r),a=new Uint16Array(n,i),l=0,d=0;d<e;d++)for(var c=0,p;c<t;c++)p=4*(c+d*t),s[l]=a[p],s[l+1]=a[p+1],s[l+2]=a[p+2],s[l+3]=X._ToHalfFloat(o),l+=4;return s}return new Uint16Array(n,i,r)},X._GetFloatRGBAArrayBuffer=function(t,e,i,r,n,o){if(X.StoreLODInAlphaChannel){for(var s=new Float32Array(r),a=new Float32Array(n,i),l=0,d=0;d<e;d++)for(var c=0,p;c<t;c++)p=4*(c+d*t),s[l]=a[p],s[l+1]=a[p+1],s[l+2]=a[p+2],s[l+3]=o,l+=4;return s}return new Float32Array(n,i,r)},X._GetFloatAsUIntRGBAArrayBuffer=function(e,t,r,i,o,n){for(var a=new Uint8Array(i),s=new Float32Array(o,r),l=0,c=0;c<t;c++)for(var p=0,u;p<e;p++)u=4*(p+c*e),a[l]=255*H.Scalar.Clamp(s[u]),a[l+1]=255*H.Scalar.Clamp(s[u+1]),a[l+2]=255*H.Scalar.Clamp(s[u+2]),a[l+3]=X.StoreLODInAlphaChannel?n:255*H.Scalar.Clamp(s[u+3]),l+=4;return a},X._GetHalfFloatAsUIntRGBAArrayBuffer=function(e,t,r,i,o,n){for(var a=new Uint8Array(i),s=new Uint16Array(o,r),l=0,c=0;c<t;c++)for(var p=0,u;p<e;p++)u=4*(p+c*e),a[l]=255*H.Scalar.Clamp(X._FromHalfFloat(s[u])),a[l+1]=255*H.Scalar.Clamp(X._FromHalfFloat(s[u+1])),a[l+2]=255*H.Scalar.Clamp(X._FromHalfFloat(s[u+2])),a[l+3]=X.StoreLODInAlphaChannel?n:255*H.Scalar.Clamp(X._FromHalfFloat(s[u+3])),l+=4;return a},X._GetRGBAArrayBuffer=function(_,e,t,i,r,n,o,s,a){for(var l=new Uint8Array(i),m=new Uint8Array(r,t),c=0,u=0;u<e;u++)for(var f=0,d;f<_;f++)d=4*(f+u*_),l[c]=m[d+n],l[c+1]=m[d+o],l[c+2]=m[d+s],l[c+3]=m[d+a],c+=4;return l},X._ExtractLongWordOrder=function(t){return 0===t||255===t||-16777216===t?0:1+X._ExtractLongWordOrder(t>>8)},X._GetRGBArrayBuffer=function(p,e,t,i,r,n,o,s){for(var a=new Uint8Array(i),l=new Uint8Array(r,t),_=0,c=0;c<e;c++)for(var u=0,f;u<p;u++)f=3*(u+c*p),a[_]=l[f+n],a[_+1]=l[f+o],a[_+2]=l[f+s],_+=3;return a},X._GetLuminanceArrayBuffer=function(d,e,t,i,r){for(var n=new Uint8Array(i),o=new Uint8Array(r,t),s=0,a=0;a<e;a++)for(var l=0,p;l<d;l++)p=l+a*d,n[s]=o[p],s++;return n},X.UploadDDSLevels=function(e,o,i,a,s,l,c,u){void 0===c&&(c=-1);var f=null;a.sphericalPolynomial&&(f=[]);var _=e.getCaps().s3tc,h=new Int32Array(i,0,31),P=0,A=0,M=0,S=1,C,m,g,v,y,b,x;if(542327876!==h[0])return void H.Tools.Error('Invalid magic number in DDS header');if(!a.isFourCC&&!a.isRGB&&!a.isLuminance)return void H.Tools.Error('Unsupported format, must contain a FourCC, RGB or LUMINANCE code');if(a.isCompressed&&!_)return void H.Tools.Error('Compressed textures are not supported on this platform.');var T=h[22];v=h[1]+4;var R=!1;if(a.isFourCC)switch(C=h[21]){case d:S=8,A=_.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case r:S=16,A=_.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case n:S=16,A=_.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 113:case 116:R=!0;break;case p:v+=20;var O=!1;switch(a.dxgiFormat){case 10:R=!0,O=!0;break;case 88:a.isRGB=!0,a.isFourCC=!1,T=32,O=!0;}if(O)break;default:return void console.error('Unsupported FourCC code:',t(C));}var I=X._ExtractLongWordOrder(h[23]),D=X._ExtractLongWordOrder(h[24]),w=X._ExtractLongWordOrder(h[25]),L=X._ExtractLongWordOrder(h[26]);R&&(M=e._getWebGLTextureType(a.textureType),A=e._getRGBABufferInternalSizedFormat(a.textureType)),b=1,131072&h[2]&&!1!==s&&(b=W(1,h[7]));for(var F=0,B;F<l;F++){for(B=1===l?o.TEXTURE_2D:o.TEXTURE_CUBE_MAP_POSITIVE_X+F+(u||0),m=h[4],g=h[3],x=0;x<b;++x){if(-1===c||c===x){var V=-1===c?x:0;if(!a.isCompressed&&a.isFourCC){P=4*(m*g);var N=null;e._badOS||e._badDesktopOS||!e.getCaps().textureHalfFloat&&!e.getCaps().textureFloat?(128===T?(N=X._GetFloatAsUIntRGBAArrayBuffer(m,g,v,P,i,V),f&&0==V&&f.push(X._GetFloatRGBAArrayBuffer(m,g,v,P,i,V))):64==T&&(N=X._GetHalfFloatAsUIntRGBAArrayBuffer(m,g,v,P,i,V),f&&0==V&&f.push(X._GetHalfFloatAsFloatRGBAArrayBuffer(m,g,v,P,i,V))),a.textureType=H.Engine.TEXTURETYPE_UNSIGNED_INT,M=e._getWebGLTextureType(a.textureType),A=e._getRGBABufferInternalSizedFormat(a.textureType)):128===T?(N=X._GetFloatRGBAArrayBuffer(m,g,v,P,i,V),f&&0==V&&f.push(N)):64!==T||e.getCaps().textureHalfFloat?(N=X._GetHalfFloatRGBAArrayBuffer(m,g,v,P,i,V),f&&0==V&&f.push(X._GetHalfFloatAsFloatRGBAArrayBuffer(m,g,v,P,i,V))):(N=X._GetHalfFloatAsFloatRGBAArrayBuffer(m,g,v,P,i,V),f&&0==V&&f.push(N),a.textureType=H.Engine.TEXTURETYPE_FLOAT,M=e._getWebGLTextureType(a.textureType),A=e._getRGBABufferInternalSizedFormat(a.textureType)),N&&e._uploadDataToTexture(B,V,A,m,g,o.RGBA,M,N)}else if(a.isRGB)24===T?(P=3*(m*g),y=X._GetRGBArrayBuffer(m,g,v,P,i,I,D,w),e._uploadDataToTexture(B,V,o.RGB,m,g,o.RGB,o.UNSIGNED_BYTE,y)):(P=4*(m*g),y=X._GetRGBAArrayBuffer(m,g,v,P,i,I,D,w,L),e._uploadDataToTexture(B,V,o.RGBA,m,g,o.RGBA,o.UNSIGNED_BYTE,y));else if(a.isLuminance){var U=o.getParameter(o.UNPACK_ALIGNMENT),k=m,z=ee((m+U-1)/U)*U;P=z*(g-1)+k,y=X._GetLuminanceArrayBuffer(m,g,v,P,i),e._uploadDataToTexture(B,V,o.LUMINANCE,m,g,o.LUMINANCE,o.UNSIGNED_BYTE,y)}else P=W(4,m)/4*W(4,g)/4*S,y=new Uint8Array(i,v,P),e._uploadCompressedDataToTexture(B,V,A,m,g,y)}v+=T?m*g*(T/8):P,m*=.5,g*=.5,m=W(1,m),g=W(1,g)}if(void 0!==u)break}a.sphericalPolynomial=f&&0<f.length?H.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial({size:h[4],right:f[0],left:f[1],up:f[2],down:f[3],front:f[4],back:f[5],format:H.Engine.TEXTUREFORMAT_RGBA,type:H.Engine.TEXTURETYPE_FLOAT,gammaSpace:!1}):void 0},X.StoreLODInAlphaChannel=!1,X}();H.DDSTools=i}(e||(e={}));var e;!function(o){var e=function(){function d(e,t){this.arrayBuffer=e;var r=new Uint8Array(this.arrayBuffer,0,12);if(171!==r[0]||75!==r[1]||84!==r[2]||88!==r[3]||32!==r[4]||49!==r[5]||49!==r[6]||187!==r[7]||13!==r[8]||10!==r[9]||26!==r[10]||10!==r[11])return void o.Tools.Error('texture missing KTX identifier');var i=new Int32Array(this.arrayBuffer,12,13),a=16909060===i[0];return this.glType=a?this.switchEndainness(i[1]):i[1],this.glTypeSize=a?this.switchEndainness(i[2]):i[2],this.glFormat=a?this.switchEndainness(i[3]):i[3],this.glInternalFormat=a?this.switchEndainness(i[4]):i[4],this.glBaseInternalFormat=a?this.switchEndainness(i[5]):i[5],this.pixelWidth=a?this.switchEndainness(i[6]):i[6],this.pixelHeight=a?this.switchEndainness(i[7]):i[7],this.pixelDepth=a?this.switchEndainness(i[8]):i[8],this.numberOfArrayElements=a?this.switchEndainness(i[9]):i[9],this.numberOfFaces=a?this.switchEndainness(i[10]):i[10],this.numberOfMipmapLevels=a?this.switchEndainness(i[11]):i[11],this.bytesOfKeyValueData=a?this.switchEndainness(i[12]):i[12],0===this.glType?(this.numberOfMipmapLevels=W(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?void o.Tools.Error('only 2D textures currently supported'):0===this.numberOfArrayElements?this.numberOfFaces===t?void(this.loadType=d.COMPRESSED_2D):void o.Tools.Error('number of faces expected'+t+', but found '+this.numberOfFaces):void o.Tools.Error('texture arrays not currently supported')):void o.Tools.Error('only compressed formats currently supported')}return d.prototype.switchEndainness=function(t){return(255&t)<<24|(65280&t)<<8|65280&t>>8|255&t>>24},d.prototype.uploadLevels=function(t,e){switch(this.loadType){case d.COMPRESSED_2D:this._upload2DCompressedLevels(t,e);break;case d.TEX_2D:case d.COMPRESSED_3D:case d.TEX_3D:}},d.prototype._upload2DCompressedLevels=function(t,e){for(var i=d.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,n=this.pixelHeight,o=e?this.numberOfMipmapLevels:1,s=0;s<o;s++){for(var a=new Int32Array(this.arrayBuffer,i,1)[0],l=0;l<this.numberOfFaces;l++){var p=1===this.numberOfFaces?t.TEXTURE_2D:t.TEXTURE_CUBE_MAP_POSITIVE_X+l,c=new Uint8Array(this.arrayBuffer,i+4,a);t.compressedTexImage2D(p,s,this.glInternalFormat,r,n,0,c),i+=a+4,i+=3-(a+3)%4}r=W(1,.5*r),n=W(1,.5*n)}},d.HEADER_LEN=64,d.COMPRESSED_2D=0,d.COMPRESSED_3D=1,d.TEX_2D=2,d.TEX_3D=3,d}();o.KhronosTextureContainer=e}(e||(e={}));var e;!function(d){!function(e){var t=function(){function e(e,a,i,r,n){void 0===r&&(r=!0),void 0===n&&(n=1),this.skeleton=e,this.mesh=a,this.autoUpdateBonesMatrices=r,this.renderingGroupId=n,this.color=d.Color3.White(),this._debugLines=[],this._isEnabled=!1,this._scene=i,this.update(),this._renderFunction=this.update.bind(this)}return Object.defineProperty(e.prototype,'isEnabled',{get:function(){return this._isEnabled},set:function(t){this._isEnabled!==t&&(this._isEnabled=t,t?this._scene.registerBeforeRender(this._renderFunction):this._scene.unregisterBeforeRender(this._renderFunction))},enumerable:!0,configurable:!0}),e.prototype._getBonePosition=function(e,t,i,r,n,o){void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0);var s=d.Tmp.Matrix[0],a=t.getParent();if(s.copyFrom(t.getLocalMatrix()),0!==r||0!==n||0!==o){var l=d.Tmp.Matrix[1];d.Matrix.IdentityToRef(l),l.m[12]=r,l.m[13]=n,l.m[14]=o,l.multiplyToRef(s,s)}a&&s.multiplyToRef(a.getAbsoluteTransform(),s),s.multiplyToRef(i,s),e.x=s.m[12],e.y=s.m[13],e.z=s.m[14]},e.prototype._getLinesForBonesWithLength=function(e,t){for(var i=e.length,r=this.mesh.position,n=0;n<i;n++){var o=e[n],s=this._debugLines[n];s||(s=[d.Vector3.Zero(),d.Vector3.Zero()],this._debugLines[n]=s),this._getBonePosition(s[0],o,t),this._getBonePosition(s[1],o,t,0,o.length,0),s[0].subtractInPlace(r),s[1].subtractInPlace(r)}},e.prototype._getLinesForBonesNoLength=function(e){for(var t=e.length,r=0,i=this.mesh.position,o=t-1;0<=o;o--){var n=e[o],a=n.getParent();if(a){var s=this._debugLines[r];s||(s=[d.Vector3.Zero(),d.Vector3.Zero()],this._debugLines[r]=s),n.getAbsolutePositionToRef(this.mesh,s[0]),a.getAbsolutePositionToRef(this.mesh,s[1]),s[0].subtractInPlace(i),s[1].subtractInPlace(i),r++}}},e.prototype.update=function(){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones,this.mesh.getWorldMatrix()):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix()),this._debugMesh?d.MeshBuilder.CreateLineSystem('',{lines:this._debugLines,updatable:!0,instance:this._debugMesh},this._scene):(this._debugMesh=d.MeshBuilder.CreateLineSystem('',{lines:this._debugLines,updatable:!0,instance:null},this._scene),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color},e.prototype.dispose=function(){this._debugMesh&&(this.isEnabled=!1,this._debugMesh.dispose(),this._debugMesh=null)},e}();e.SkeletonViewer=t}(d.Debug||(d.Debug={}))}(e||(e={}));var e;!function(a){!function(e){var t=function(){function e(e,r){void 0===r&&(r=1),this._xline=[a.Vector3.Zero(),a.Vector3.Zero()],this._yline=[a.Vector3.Zero(),a.Vector3.Zero()],this._zline=[a.Vector3.Zero(),a.Vector3.Zero()],this.scaleLines=1,this.scaleLines=r,this._xmesh=a.Mesh.CreateLines('xline',this._xline,e,!0),this._ymesh=a.Mesh.CreateLines('yline',this._yline,e,!0),this._zmesh=a.Mesh.CreateLines('zline',this._zline,e,!0),this._xmesh.renderingGroupId=2,this._ymesh.renderingGroupId=2,this._zmesh.renderingGroupId=2,this._xmesh.material.checkReadyOnlyOnce=!0,this._xmesh.color=new a.Color3(1,0,0),this._ymesh.material.checkReadyOnlyOnce=!0,this._ymesh.color=new a.Color3(0,1,0),this._zmesh.material.checkReadyOnlyOnce=!0,this._zmesh.color=new a.Color3(0,0,1),this.scene=e}return e.prototype.update=function(e,t,i,r){var n=this.scaleLines;this._xmesh&&this._xmesh.position.copyFrom(e),this._ymesh&&this._ymesh.position.copyFrom(e),this._zmesh&&this._zmesh.position.copyFrom(e);var o=this._xline[1];o.x=t.x*n,o.y=t.y*n,o.z=t.z*n,a.Mesh.CreateLines('',this._xline,null,!1,this._xmesh),o=this._yline[1],o.x=i.x*n,o.y=i.y*n,o.z=i.z*n,a.Mesh.CreateLines('',this._yline,null,!1,this._ymesh),o=this._zline[1],o.x=r.x*n,o.y=r.y*n,o.z=r.z*n,a.Mesh.CreateLines('',this._zline,null,!1,this._zmesh)},e.prototype.dispose=function(){this._xmesh&&this._xmesh.dispose(),this._ymesh&&this._ymesh.dispose(),this._zmesh&&this._zmesh.dispose(),this._xmesh=null,this._ymesh=null,this._zmesh=null,this.scene=null},e}();e.AxesViewer=t}(a.Debug||(a.Debug={}))}(e||(e={}));var e;!function(a){!function(e){var t=function(e){function t(t,l,r,n){void 0===n&&(n=1);var o=e.call(this,t,n)||this;return o.pos=a.Vector3.Zero(),o.xaxis=a.Vector3.Zero(),o.yaxis=a.Vector3.Zero(),o.zaxis=a.Vector3.Zero(),o.mesh=r,o.bone=l,o}return h(t,e),t.prototype.update=function(){if(this.mesh&&this.bone){var t=this.bone;t.getAbsolutePositionToRef(this.mesh,this.pos),t.getDirectionToRef(a.Axis.X,this.mesh,this.xaxis),t.getDirectionToRef(a.Axis.Y,this.mesh,this.yaxis),t.getDirectionToRef(a.Axis.Z,this.mesh,this.zaxis),e.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)}},t.prototype.dispose=function(){this.mesh&&(this.mesh=null,this.bone=null,e.prototype.dispose.call(this))},t}(e.AxesViewer);e.BoneAxesViewer=t}(a.Debug||(a.Debug={}))}(e||(e={}));var e;!function(a){var e=function(){function o(t){this.ray=t}return o.CreateAndShow=function(t,e,i){var r=new o(t);return r.show(e,i),r},o.prototype.show=function(e,t){if(!this._renderFunction&&this.ray){var o=this.ray;this._renderFunction=this._render.bind(this),this._scene=e,this._renderPoints=[o.origin,o.origin.add(o.direction.scale(o.length))],this._renderLine=a.Mesh.CreateLines('ray',this._renderPoints,e,!0),this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}t&&this._renderLine&&this._renderLine.color.copyFrom(t)},o.prototype.hide=function(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])},o.prototype._render=function(){var e=this.ray;if(e){var t=this._renderPoints[1],o=C(e.length,1e6);t.copyFrom(e.direction),t.scaleInPlace(o),t.addInPlace(e.origin),a.Mesh.CreateLines('ray',this._renderPoints,this._scene,!0,this._renderLine)}},o.prototype.attachToMesh=function(e,t,i,r){this._attachedToMesh=e;var n=this.ray;n&&(n.direction||(n.direction=a.Vector3.Zero()),n.origin||(n.origin=a.Vector3.Zero()),r&&(n.length=r),i||(i=a.Vector3.Zero()),t||(t=new a.Vector3(0,0,-1)),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(t),this._meshSpaceOrigin.copyFrom(i)):(this._meshSpaceDirection=t.clone(),this._meshSpaceOrigin=i.clone()),this._updateToMeshFunction||(this._updateToMeshFunction=this._updateToMesh.bind(this),this._attachedToMesh.getScene().registerBeforeRender(this._updateToMeshFunction)),this._updateToMesh())},o.prototype.detachFromMesh=function(){this._attachedToMesh&&(this._updateToMeshFunction&&this._attachedToMesh.getScene().unregisterBeforeRender(this._updateToMeshFunction),this._attachedToMesh=null,this._updateToMeshFunction=null)},o.prototype._updateToMesh=function(){var e=this.ray;if(this._attachedToMesh&&e){if(this._attachedToMesh._isDisposed)return void this.detachFromMesh();this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,e.direction),a.Vector3.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),e.origin)}},o.prototype.dispose=function(){this.hide(),this.detachFromMesh(),this.ray=null},o}();a.RayHelper=e}(e||(e={}));var e;!function(r){var e=function(){function e(t){this.BJSINSPECTOR='undefined'==typeof INSPECTOR?void 0:INSPECTOR,this._scene=t}return e.prototype._createInspector=function(o){void 0===o&&(o={});var e=o.popup||!1,t=o.initialTab||0,i=o.parentElement||null;this._inspector||(this.BJSINSPECTOR=this.BJSINSPECTOR||'undefined'!=typeof INSPECTOR?INSPECTOR:void 0,this._inspector=new this.BJSINSPECTOR.Inspector(this._scene,e,t,i,o.newColors))},e.prototype.isVisible=function(){return!!this._inspector},e.prototype.hide=function(){if(this._inspector){try{this._inspector.dispose()}catch(t){}this._inspector=null}},e.prototype.show=function(t){void 0===t&&(t={}),void 0===this.BJSINSPECTOR?r.Tools.LoadScript(e.InspectorURL,this._createInspector.bind(this,t)):this._createInspector(t)},e.InspectorURL='https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js',e}();r.DebugLayer=e}(e||(e={}));var e;!function(o){!function(e){var t=function(){function e(e){this._impostors=[],this._meshes=[],this._numMeshes=0,this._scene=e||o.Engine.LastCreatedScene;var r=this._scene.getPhysicsEngine();r&&(this._physicsEnginePlugin=r.getPhysicsPlugin())}return e.prototype._updateDebugMeshes=function(){for(var o=this._physicsEnginePlugin,e=0,t;e<this._numMeshes;e++)if(t=this._impostors[e],t)if(t.isDisposed)this.hideImpostor(this._impostors[e--]);else{var i=this._meshes[e];i&&o&&o.syncMeshWithImpostor(i,t)}},e.prototype.showImpostor=function(r){if(this._scene){for(var e=0;e<this._numMeshes;e++)if(this._impostors[e]==r)return;var t=this._getDebugMesh(r,this._scene);t&&(this._impostors[this._numMeshes]=r,this._meshes[this._numMeshes]=t,0===this._numMeshes&&(this._renderFunction=this._updateDebugMeshes.bind(this),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++)}},e.prototype.hideImpostor=function(o){if(o&&this._scene){for(var e=!1,t=0;t<this._numMeshes;t++)if(this._impostors[t]==o){var i=this._meshes[t];if(!i)continue;this._scene.removeMesh(i),i.dispose(),this._numMeshes--,0<this._numMeshes?(this._meshes[t]=this._meshes[this._numMeshes],this._impostors[t]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),e=!0;break}e&&0===this._numMeshes&&this._scene.unregisterBeforeRender(this._renderFunction)}},e.prototype._getDebugMaterial=function(e){return this._debugMaterial||(this._debugMaterial=new o.StandardMaterial('',e),this._debugMaterial.wireframe=!0),this._debugMaterial},e.prototype._getDebugBoxMesh=function(e){return this._debugBoxMesh||(this._debugBoxMesh=o.MeshBuilder.CreateBox('physicsBodyBoxViewMesh',{size:1},e),this._debugBoxMesh.renderingGroupId=1,this._debugBoxMesh.rotationQuaternion=o.Quaternion.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(e),e.removeMesh(this._debugBoxMesh)),this._debugBoxMesh.createInstance('physicsBodyBoxViewInstance')},e.prototype._getDebugSphereMesh=function(e){return this._debugSphereMesh||(this._debugSphereMesh=o.MeshBuilder.CreateSphere('physicsBodySphereViewMesh',{diameter:1},e),this._debugSphereMesh.renderingGroupId=1,this._debugSphereMesh.rotationQuaternion=o.Quaternion.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(e),e.removeMesh(this._debugSphereMesh)),this._debugSphereMesh.createInstance('physicsBodyBoxViewInstance')},e.prototype._getDebugMesh=function(e,t){var i=null;if(e.type==o.PhysicsImpostor.BoxImpostor)i=this._getDebugBoxMesh(t),e.getBoxSizeToRef(i.scaling);else if(e.type==o.PhysicsImpostor.SphereImpostor){i=this._getDebugSphereMesh(t);var r=e.getRadius();i.scaling.x=2*r,i.scaling.y=2*r,i.scaling.z=2*r}return i},e.prototype.dispose=function(){for(var t=0;t<this._numMeshes;t++)this.hideImpostor(this._impostors[t]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null},e}();e.PhysicsViewer=t}(o.Debug||(o.Debug={}))}(e||(e={}));var e;!function(d){var e=function(){function e(e){this.frontColor=new d.Color3(1,1,1),this.backColor=new d.Color3(.1,.1,.1),this.showBackLines=!0,this.renderList=new d.SmartArray(32),this._vertexBuffers={},this._scene=e}return e.prototype._prepareRessources=function(){if(!this._colorShader){this._colorShader=new d.ShaderMaterial('colorShader',this._scene,'color',{attributes:[d.VertexBuffer.PositionKind],uniforms:['world','viewProjection','color']});var e=this._scene.getEngine(),t=d.VertexData.CreateBox({size:1});this._vertexBuffers[d.VertexBuffer.PositionKind]=new d.VertexBuffer(e,t.positions,d.VertexBuffer.PositionKind,!1),this._createIndexBuffer()}},e.prototype._createIndexBuffer=function(){var t=this._scene.getEngine();this._indexBuffer=t.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])},e.prototype._rebuild=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&e._rebuild(),this._createIndexBuffer()},e.prototype.reset=function(){this.renderList.reset()},e.prototype.render=function(){if(0!==this.renderList.length&&(this._prepareRessources(),this._colorShader.isReady())){var e=this._scene.getEngine();e.setDepthWrite(!1),this._colorShader._preBind();for(var t=0;t<this.renderList.length;t++){var i=this.renderList.data[t],r=i.minimum,n=i.maximum,o=n.subtract(r),s=r.add(o.scale(.5)),a=d.Matrix.Scaling(o.x,o.y,o.z).multiply(d.Matrix.Translation(s.x,s.y,s.z)).multiply(i.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),this.showBackLines&&(e.setDepthFunctionToGreaterOrEqual(),this._scene.resetCachedMaterial(),this._colorShader.setColor4('color',this.backColor.toColor4()),this._colorShader.bind(a),e.drawElementsType(d.Material.LineListDrawMode,0,24)),e.setDepthFunctionToLess(),this._scene.resetCachedMaterial(),this._colorShader.setColor4('color',this.frontColor.toColor4()),this._colorShader.bind(a),e.drawElementsType(d.Material.LineListDrawMode,0,24)}this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0)}},e.prototype.renderOcclusionBoundingBox=function(e){if(this._prepareRessources(),this._colorShader.isReady()&&e._boundingInfo){var t=this._scene.getEngine();t.setDepthWrite(!1),t.setColorWrite(!1),this._colorShader._preBind();var i=e._boundingInfo.boundingBox,r=i.minimum,n=i.maximum,o=n.subtract(r),s=r.add(o.scale(.5)),a=d.Matrix.Scaling(o.x,o.y,o.z).multiply(d.Matrix.Translation(s.x,s.y,s.z)).multiply(i.getWorldMatrix());t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),t.setDepthFunctionToLess(),this._scene.resetCachedMaterial(),this._colorShader.bind(a),t.drawElementsType(d.Material.LineListDrawMode,0,24),this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0)}},e.prototype.dispose=function(){if(this._colorShader){this.renderList.dispose(),this._colorShader.dispose();var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[d.VertexBuffer.PositionKind]=null),this._scene.getEngine()._releaseBuffer(this._indexBuffer)}},e}();d.BoundingBoxRenderer=e}(e||(e={}));var e;!function(a){var e=function(){function e(e,o,i){void 0===o&&(o=0),void 0===i&&(i=null),this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this.onInfluenceChanged=new a.Observable,this._animationPropertiesOverride=null,this._scene=i||a.Engine.LastCreatedScene,this.influence=o}return Object.defineProperty(e.prototype,'influence',{get:function(){return this._influence},set:function(r){if(this._influence!==r){var e=this._influence;this._influence=r,this.onInfluenceChanged.hasObservers&&this.onInfluenceChanged.notifyObservers(0===e||0===r)}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'animationPropertiesOverride',{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'hasPositions',{get:function(){return!!this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'hasNormals',{get:function(){return!!this._normals},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'hasTangents',{get:function(){return!!this._tangents},enumerable:!0,configurable:!0}),e.prototype.setPositions=function(t){this._positions=t},e.prototype.getPositions=function(){return this._positions},e.prototype.setNormals=function(t){this._normals=t},e.prototype.getNormals=function(){return this._normals},e.prototype.setTangents=function(t){this._tangents=t},e.prototype.getTangents=function(){return this._tangents},e.prototype.serialize=function(){var e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),a.Animation.AppendSerializedAnimations(this,e),e},e.Parse=function(t){var i=new e(t.name,t.influence);if(i.setPositions(t.positions),t.normals&&i.setNormals(t.normals),t.tangents&&i.setTangents(t.tangents),t.animations)for(var r=0,n;r<t.animations.length;r++)n=t.animations[r],i.animations.push(a.Animation.Parse(n));return i},e.FromMesh=function(t,i,r){i||(i=t.name);var n=new e(i,r,t.getScene());return n.setPositions(t.getVerticesData(a.VertexBuffer.PositionKind)),t.isVerticesDataPresent(a.VertexBuffer.NormalKind)&&n.setNormals(t.getVerticesData(a.VertexBuffer.NormalKind)),t.isVerticesDataPresent(a.VertexBuffer.TangentKind)&&n.setTangents(t.getVerticesData(a.VertexBuffer.TangentKind)),n},e}();a.MorphTarget=e}(e||(e={}));var e;!function(r){var e=function(){function e(e){void 0===e&&(e=null),this._targets=[],this._targetObservable=[],this._activeTargets=new r.SmartArray(16),this._supportsNormals=!1,this._supportsTangents=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=[],e||(e=r.Engine.LastCreatedScene),this._scene=e,this._scene&&(this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(e.prototype,'uniqueId',{get:function(){return this._uniqueId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vertexCount',{get:function(){return this._vertexCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'supportsNormals',{get:function(){return this._supportsNormals},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'supportsTangents',{get:function(){return this._supportsTangents},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'numTargets',{get:function(){return this._targets.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'numInfluencers',{get:function(){return this._activeTargets.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'influences',{get:function(){return this._influences},enumerable:!0,configurable:!0}),e.prototype.getActiveTarget=function(t){return this._activeTargets.data[t]},e.prototype.getTarget=function(t){return this._targets[t]},e.prototype.addTarget=function(r){var o=this;this._targets.push(r),this._targetObservable.push(r.onInfluenceChanged.add(function(t){o._syncActiveTargets(t)})),this._syncActiveTargets(!0)},e.prototype.removeTarget=function(r){var e=this._targets.indexOf(r);0<=e&&(this._targets.splice(e,1),r.onInfluenceChanged.remove(this._targetObservable.splice(e,1)[0]),this._syncActiveTargets(!0))},e.prototype.serialize=function(){for(var o={id:this.uniqueId,targets:[]},e=0,t=this._targets,i;e<t.length;e++)i=t[e],o.targets.push(i.serialize());return o},e.prototype._syncActiveTargets=function(e){var t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._vertexCount=0;for(var i=0,d=this._targets,n;i<d.length;i++){n=d[i],this._activeTargets.push(n),this._tempInfluences[t++]=n.influence;var o=n.getPositions();if(o){this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents;var s=o.length/3;if(0===this._vertexCount)this._vertexCount=s;else if(this._vertexCount!==s)return void r.Tools.Error('Incompatible target. Targets must all have the same vertices count.')}}this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(var a=0;a<t;a++)this._influences[a]=this._tempInfluences[a];e&&this.synchronize()},e.prototype.synchronize=function(){if(this._scene)for(var r=0,e=this._scene.meshes,t;r<e.length;r++)t=e[r],t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()},e.Parse=function(t,i){var l=new e(i);l._uniqueId=t.id;for(var n=0,o=t.targets,s;n<o.length;n++)s=o[n],l.addTarget(r.MorphTarget.Parse(s));return l},e}();r.MorphTargetManager=e}(e||(e={}));var e;!function(m){var e=function(){function o(e,o,i){void 0===i&&(i=2),this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=o||64,this._selectionContent=new m.SmartArrayNoDuplicate(1024),this._creationFunc=e}return o.prototype.update=function(t,e,i){o._CreateBlocks(t,e,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},o.prototype.addMesh=function(r){for(var e=0;e<this.blocks.length;e++)this.blocks[e].addEntry(r)},o.prototype.select=function(r,e){this._selectionContent.reset();for(var t=0;t<this.blocks.length;t++)this.blocks[t].select(r,this._selectionContent,e);return e?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},o.prototype.intersects=function(o,e,t){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++)this.blocks[i].intersects(o,e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},o.prototype.intersectsRay=function(r){this._selectionContent.reset();for(var e=0;e<this.blocks.length;e++)this.blocks[e].intersectsRay(r,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},o._CreateBlocks=function(e,t,i,r,n,o,s,a){s.blocks=[];for(var l=new m.Vector3((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2),g=0;2>g;g++)for(var c=0;2>c;c++)for(var u=0;2>u;u++){var f=e.add(l.multiplyByFloats(g,c,u)),d=e.add(l.multiplyByFloats(g+1,c+1,u+1)),p=new m.OctreeBlock(f,d,r,n+1,o,a);p.addEntries(i),s.blocks.push(p)}},o.CreationFuncForMeshes=function(r,e){var t=r.getBoundingInfo();!r.isBlocked&&t.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(r)},o.CreationFuncForSubMeshes=function(r,e){r.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(r)},o}();m.Octree=e}(e||(e={}));var e;!function(a){var e=function(){function e(a,e,s,i,r,n){this.entries=[],this._boundingVectors=[],this._capacity=s,this._depth=i,this._maxDepth=r,this._creationFunc=n,this._minPoint=a,this._maxPoint=e,this._boundingVectors.push(a.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors.push(a.clone()),this._boundingVectors[2].x=e.x,this._boundingVectors.push(a.clone()),this._boundingVectors[3].y=e.y,this._boundingVectors.push(a.clone()),this._boundingVectors[4].z=e.z,this._boundingVectors.push(e.clone()),this._boundingVectors[5].z=a.z,this._boundingVectors.push(e.clone()),this._boundingVectors[6].x=a.x,this._boundingVectors.push(e.clone()),this._boundingVectors[7].y=a.y}return Object.defineProperty(e.prototype,'capacity',{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'minPoint',{get:function(){return this._minPoint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'maxPoint',{get:function(){return this._maxPoint},enumerable:!0,configurable:!0}),e.prototype.addEntry=function(r){if(this.blocks)for(var e=0,t;e<this.blocks.length;e++)t=this.blocks[e],t.addEntry(r);else this._creationFunc(r,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},e.prototype.addEntries=function(r){for(var e=0,t;e<r.length;e++)t=r[e],this.addEntry(t)},e.prototype.select=function(e,t,o){if(a.BoundingBox.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(var r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,o);return}o?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}},e.prototype.intersects=function(e,t,i,r){if(a.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(var n=0;n<this.blocks.length;n++)this.blocks[n].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},e.prototype.intersectsRay=function(r,e){if(r.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(r,e);return}e.concatWithNoDuplicate(this.entries)}},e.prototype.createInnerBlocks=function(){a.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},e}();a.OctreeBlock=e}(e||(e={}));var e;!function(a){var e=function(e){function t(t,l,r,n){var o=e.call(this,t,'vrDistortionCorrection',['LensCenter','Scale','ScaleIn','HmdWarpParam'],null,n.postProcessScaleFactor,l,a.Texture.BILINEAR_SAMPLINGMODE)||this;return o._isRightEye=r,o._distortionFactors=n.distortionK,o._postProcessScaleFactor=n.postProcessScaleFactor,o._lensCenterOffset=n.lensCenterOffset,o.adaptScaleToCurrentViewport=!0,o.onSizeChangedObservable.add(function(){o._scaleIn=new a.Vector2(2,2/o.aspectRatio),o._scaleFactor=new a.Vector2(.5*(1/o._postProcessScaleFactor),.5*(1/o._postProcessScaleFactor)*o.aspectRatio),o._lensCenter=new a.Vector2(o._isRightEye?.5-.5*o._lensCenterOffset:.5+.5*o._lensCenterOffset,.5)}),o.onApplyObservable.add(function(t){t.setFloat2('LensCenter',o._lensCenter.x,o._lensCenter.y),t.setFloat2('Scale',o._scaleFactor.x,o._scaleFactor.y),t.setFloat2('ScaleIn',o._scaleIn.x,o._scaleIn.y),t.setFloat4('HmdWarpParam',o._distortionFactors[0],o._distortionFactors[1],o._distortionFactors[2],o._distortionFactors[3])}),o}return h(t,e),t}(a.PostProcess);a.VRDistortionCorrectionPostProcess=e}(e||(e={}));var e;!function(r){var e=function(l){function e(e,d,i,r,n,o){var s=l.call(this,e,'anaglyph',null,['leftSampler'],d,i[1],r,n,o)||this;return s._passedProcess=i[0]._rigPostProcess,s.onApplyObservable.add(function(t){t.setTextureFromPostProcess('leftSampler',s._passedProcess)}),s}return h(e,l),e}(r.PostProcess);r.AnaglyphPostProcess=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,c,r,n,o,s){var a=e.call(this,t,'stereoscopicInterlace',['stepSize'],['camASampler'],1,c[1],n,o,s,r?'#define IS_STEREOSCOPIC_HORIZ 1':void 0)||this;return a._passedProcess=c[0]._rigPostProcess,a._stepSize=new d.Vector2(1/a.width,1/a.height),a.onSizeChangedObservable.add(function(){a._stepSize=new d.Vector2(1/a.width,1/a.height)}),a.onApplyObservable.add(function(t){t.setTextureFromPostProcess('camASampler',a._passedProcess),t.setFloat2('stepSize',a._stepSize.x,a._stepSize.y)}),a}return h(t,e),t}(d.PostProcess);d.StereoscopicInterlacePostProcess=e}(e||(e={}));var e;!function(r){var e=function(){function e(){var o=this;this._screenOrientationAngle=0,this._screenQuaternion=new r.Quaternion,this._alpha=0,this._beta=0,this._gamma=0,this._orientationChanged=function(){o._screenOrientationAngle=void 0===window.orientation?window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0:+window.orientation,o._screenOrientationAngle=-r.Tools.ToRadians(o._screenOrientationAngle/2),o._screenQuaternion.copyFromFloats(0,B(o._screenOrientationAngle),0,F(o._screenOrientationAngle))},this._deviceOrientation=function(t){o._alpha=null===t.alpha?0:t.alpha,o._beta=null===t.beta?0:t.beta,o._gamma=null===t.gamma?0:t.gamma},this._constantTranform=new r.Quaternion(-0.7071067811865476,0,0,0.7071067811865476),this._orientationChanged()}return Object.defineProperty(e.prototype,'camera',{get:function(){return this._camera},set:function(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new r.Quaternion)},enumerable:!0,configurable:!0}),e.prototype.attachControl=function(){window.addEventListener('orientationchange',this._orientationChanged),window.addEventListener('deviceorientation',this._deviceOrientation),this._orientationChanged()},e.prototype.detachControl=function(){window.removeEventListener('orientationchange',this._orientationChanged),window.removeEventListener('deviceorientation',this._deviceOrientation)},e.prototype.checkInputs=function(){this._alpha&&(r.Quaternion.RotationYawPitchRollToRef(r.Tools.ToRadians(this._alpha),r.Tools.ToRadians(this._beta),-r.Tools.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)},e.prototype.getClassName=function(){return'FreeCameraDeviceOrientationInput'},e.prototype.getSimpleName=function(){return'deviceOrientation'},e}();r.FreeCameraDeviceOrientationInput=e,r.CameraInputTypes.FreeCameraDeviceOrientationInput=e}(e||(e={}));var e;!function(r){var e=function(){function t(){this.alphaCorrection=1,this.betaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return t.prototype.attachControl=function(r,e){this.camera.attachControl(r,e),window.addEventListener('deviceorientation',this._deviceOrientationHandler)},t.prototype._onOrientationEvent=function(t){null!==t.alpha&&(this._alpha=0|+t.alpha),null!==t.gamma&&(this._gamma=0|+t.gamma),this._dirty=!0},t.prototype.checkInputs=function(){this._dirty&&(this._dirty=!1,0>this._gamma&&(this._gamma=180+this._gamma),this.camera.alpha=2*(-this._alpha/180*V%V),this.camera.beta=this._gamma/180*V)},t.prototype.detachControl=function(){window.removeEventListener('deviceorientation',this._deviceOrientationHandler)},t.prototype.getClassName=function(){return'ArcRotateCameraVRDeviceOrientationInput'},t.prototype.getSimpleName=function(){return'VRDeviceOrientation'},t}();r.ArcRotateCameraVRDeviceOrientationInput=e,r.CameraInputTypes.ArcRotateCameraVRDeviceOrientationInput=e}(e||(e={}));var e;!function(r){var e=function(){function o(){this.compensateDistortion=!0}return Object.defineProperty(o.prototype,'aspectRatio',{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'aspectRatioFov',{get:function(){return 2*f(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'leftHMatrix',{get:function(){var e=this.hScreenSize/4-this.lensSeparationDistance/2,t=4*e/this.hScreenSize;return r.Matrix.Translation(t,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'rightHMatrix',{get:function(){var e=this.hScreenSize/4-this.lensSeparationDistance/2,t=4*e/this.hScreenSize;return r.Matrix.Translation(-t,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'leftPreViewMatrix',{get:function(){return r.Matrix.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,'rightPreViewMatrix',{get:function(){return r.Matrix.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),o.GetDefault=function(){var t=new o;return t.hResolution=1280,t.vResolution=800,t.hScreenSize=.149759993,t.vScreenSize=.0935999975,t.vScreenCenter=.0467999987,t.eyeToScreenDistance=.0410000011,t.lensSeparationDistance=.063500002,t.interpupillaryDistance=.064000003,t.distortionK=[1,.219999999,.239999995,0],t.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],t.postProcessScaleFactor=1.714605507808412,t.lensCenterOffset=.151976421,t},o}();r.VRCameraMetrics=e}(e||(e={}));var e;!function(l){var e=function(d){function e(e,t,r,n){void 0===n&&(n={});var o=d.call(this,e,t,r)||this;o.webVROptions=n,o._vrDevice=null,o.rawPose=null,o._specsVersion='1.1',o._attached=!1,o._descendants=[],o._deviceRoomPosition=l.Vector3.Zero(),o._deviceRoomRotationQuaternion=l.Quaternion.Identity(),o._standingMatrix=null,o.devicePosition=l.Vector3.Zero(),o.deviceRotationQuaternion=l.Quaternion.Identity(),o.deviceScaleFactor=1,o._deviceToWorld=l.Matrix.Identity(),o._worldToDevice=l.Matrix.Identity(),o.controllers=[],o.onControllersAttachedObservable=new l.Observable,o.onControllerMeshLoadedObservable=new l.Observable,o.rigParenting=!0,o._defaultHeight=void 0,o._workingVector=l.Vector3.Zero(),o._oneVector=l.Vector3.One(),o._workingMatrix=l.Matrix.Identity(),o._cache.position=l.Vector3.Zero(),n.defaultHeight&&(o._defaultHeight=n.defaultHeight,o.position.y=o._defaultHeight),o.minZ=.1,5===arguments.length&&(o.webVROptions=arguments[4]),void 0==o.webVROptions.trackPosition&&(o.webVROptions.trackPosition=!0),void 0==o.webVROptions.controllerMeshes&&(o.webVROptions.controllerMeshes=!0),void 0==o.webVROptions.defaultLightingOnControllers&&(o.webVROptions.defaultLightingOnControllers=!0),o.rotationQuaternion=new l.Quaternion,o.webVROptions&&o.webVROptions.positionScale&&(o.deviceScaleFactor=o.webVROptions.positionScale);var c=o.getEngine();return o._onVREnabled=function(t){t&&o.initControllers()},c.onVRRequestPresentComplete.add(o._onVREnabled),c.initWebVR().add(function(e){e.vrDisplay&&o._vrDevice!==e.vrDisplay&&(o._vrDevice=e.vrDisplay,o.setCameraRigMode(l.Camera.RIG_MODE_WEBVR,{parentCamera:o,vrDisplay:o._vrDevice,frameData:o._frameData,specs:o._specsVersion}),o._attached&&o.getEngine().enableVR())}),'undefined'!=typeof VRFrameData&&(o._frameData=new VRFrameData),r.onBeforeCameraRenderObservable.add(function(r){r.parent===o&&o.rigParenting&&(o._descendants=o.getDescendants(!0,function(r){var e=o.controllers.some(function(e){return e._mesh===r}),a=-1!==o._rigCameras.indexOf(r);return!e&&!a}),o._descendants.forEach(function(e){e.parent=r}))}),r.onAfterCameraRenderObservable.add(function(t){t.parent===o&&o.rigParenting&&o._descendants.forEach(function(t){t.parent=o})}),o}return h(e,d),e.prototype.deviceDistanceToRoomGround=function(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0},e.prototype.useStandingMatrix=function(e){var t=this;void 0===e&&(e=function(){}),this.getEngine().initWebVRAsync().then(function(o){o.vrDisplay&&o.vrDisplay.stageParameters&&o.vrDisplay.stageParameters.sittingToStandingTransform?(t._standingMatrix=new l.Matrix,l.Matrix.FromFloat32ArrayToRefScaled(o.vrDisplay.stageParameters.sittingToStandingTransform,0,1,t._standingMatrix),t.getScene().useRightHandedSystem||[2,6,8,9,14].forEach(function(r){t._standingMatrix&&(t._standingMatrix.m[r]*=-1)}),e(!0)):e(!1)})},e.prototype.useStandingMatrixAsync=function(){var r=this;return new Promise(function(o){r.useStandingMatrix(function(t){o(t)})})},e.prototype.dispose=function(){this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),d.prototype.dispose.call(this)},e.prototype.getControllerByName=function(o){for(var e=0,t=this.controllers,i;e<t.length;e++)if(i=t[e],i.hand===o)return i;return null},Object.defineProperty(e.prototype,'leftController',{get:function(){return this._leftController||(this._leftController=this.getControllerByName('left')),this._leftController},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'rightController',{get:function(){return this._rightController||(this._rightController=this.getControllerByName('right')),this._rightController},enumerable:!0,configurable:!0}),e.prototype.getForwardRay=function(t){return void 0===t&&(t=100),this.leftCamera?d.prototype.getForwardRay.call(this,t,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):d.prototype.getForwardRay.call(this,t)},e.prototype._checkInputs=function(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),d.prototype._checkInputs.call(this)},e.prototype.updateFromDevice=function(t){t&&t.orientation&&(this.rawPose=t,this._deviceRoomRotationQuaternion.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this.webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)))},e.prototype.attachControl=function(e,t){d.prototype.attachControl.call(this,e,t),this._attached=!0,t=!l.Camera.ForceAttachControlToAlwaysPreventDefault&&t,this._vrDevice&&this.getEngine().enableVR()},e.prototype.detachControl=function(t){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),d.prototype.detachControl.call(this,t),this._attached=!1,this.getEngine().disableVR()},e.prototype.getClassName=function(){return'WebVRFreeCamera'},e.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()},e.prototype._updateRigCameras=function(){var r=this._rigCameras[0],e=this._rigCameras[1];r.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),r.position.copyFrom(this._deviceRoomPosition),e.position.copyFrom(this._deviceRoomPosition)},e.prototype._updateCache=function(e){var t=this;this.rotationQuaternion.equals(this._cache.rotationQuaternion)&&this.position.equals(this._cache.position)||(this.updateCacheCalled||(this.updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),l.Vector3.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),l.Matrix.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(function(r){r._deviceToWorld.copyFrom(t._deviceToWorld),r.update()})),e||d.prototype._updateCache.call(this),this.updateCacheCalled=!1},e.prototype.update=function(){l.Vector3.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition),l.Matrix.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),l.Quaternion.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),d.prototype.update.call(this)},e.prototype._getViewMatrix=function(){return l.Matrix.Identity()},e.prototype._getWebVRViewMatrix=function(){var o=this,e=this._cameraRigParams.parentCamera;e._updateCache();var t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return l.Matrix.FromArrayToRef(t,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||[2,6,8,9,14].forEach(function(t){o._webvrViewMatrix.m[t]*=-1}),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),l.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),1!==e.deviceScaleFactor&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.m[12]*=e.deviceScaleFactor,this._webvrViewMatrix.m[13]*=e.deviceScaleFactor,this._webvrViewMatrix.m[14]*=e.deviceScaleFactor),this._webvrViewMatrix.invert()),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||l.Matrix.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix},e.prototype._getWebVRProjectionMatrix=function(){var o=this,e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;var t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return l.Matrix.FromArrayToRef(t,0,this._projectionMatrix),this.getScene().useRightHandedSystem||[8,9,10,11].forEach(function(t){o._projectionMatrix.m[t]*=-1}),this._projectionMatrix},e.prototype.initControllers=function(){var e=this;this.controllers=[];var t=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=t.onGamepadDisconnectedObservable.add(function(t){if(t.type===l.Gamepad.POSE_ENABLED){var o=t;o.defaultModel&&o.defaultModel.setEnabled(!1),'right'===o.hand&&(e._rightController=null),'left'===o.hand&&(e._leftController=null);var r=e.controllers.indexOf(o);-1!==r&&e.controllers.splice(r,1)}}),this._onGamepadConnectedObserver=t.onGamepadConnectedObservable.add(function(t){if(t.type===l.Gamepad.POSE_ENABLED){var a=t;if(a.deviceScaleFactor=e.deviceScaleFactor,a._deviceToWorld.copyFrom(e._deviceToWorld),e.webVROptions.controllerMeshes&&(a.defaultModel?a.defaultModel.setEnabled(!0):a.initControllerMesh(e.getScene(),function(t){if(t.scaling.scaleInPlace(e.deviceScaleFactor),e.onControllerMeshLoadedObservable.notifyObservers(a),e.webVROptions.defaultLightingOnControllers){e._lightOnControllers||(e._lightOnControllers=new l.HemisphericLight('vrControllersLight',new l.Vector3(0,1,0),e.getScene()));var r=function(o,a){var e=o.getChildren();0!==e.length&&e.forEach(function(t){a.includedOnlyMeshes.push(t),r(t,a)})};e._lightOnControllers.includedOnlyMeshes.push(t),r(t,e._lightOnControllers)}})),a.attachToPoseControlledCamera(e),-1===e.controllers.indexOf(a)){e.controllers.push(a);for(var r=!1,i=0;i<e.controllers.length;i++)e.controllers[i].controllerType===l.PoseEnabledControllerType.VIVE&&(r?e.controllers[i].hand='right':(r=!0,e.controllers[i].hand='left'));2<=e.controllers.length&&e.onControllersAttachedObservable.notifyObservers(e.controllers)}}})},e}(l.FreeCamera);l.WebVRFreeCamera=e}(e||(e={}));var e;!function(a){var e=function(e){function t(t,s,r){var n=e.call(this,t,s,r)||this;return n._quaternionCache=new a.Quaternion,n.inputs.addDeviceOrientation(),n}return h(t,e),t.prototype.getClassName=function(){return'DeviceOrientationCamera'},t.prototype._checkInputs=function(){e.prototype._checkInputs.call(this),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)},t.prototype.resetToCurrentRotation=function(r){var t=this;void 0===r&&(r=a.Axis.Y),this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new a.Quaternion),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),['x','y','z'].forEach(function(o){r[o]?t._initialQuaternion[o]*=-1:t._initialQuaternion[o]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))},t}(a.FreeCamera);a.DeviceOrientationCamera=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,l,r,n,o){void 0===n&&(n=!0),void 0===o&&(o=d.VRCameraMetrics.GetDefault());var c=e.call(this,t,l,r)||this;return o.compensateDistortion=n,c.setCameraRigMode(d.Camera.RIG_MODE_VR,{vrCameraMetrics:o}),c}return h(t,e),t.prototype.getClassName=function(){return'VRDeviceOrientationFreeCamera'},t}(d.DeviceOrientationCamera);d.VRDeviceOrientationFreeCamera=e;var t=function(e){function t(t,l,r,n,o){void 0===n&&(n=!0),void 0===o&&(o=d.VRCameraMetrics.GetDefault());var s=e.call(this,t,l,r,n,o)||this;return s.inputs.addGamepad(),s}return h(t,e),t.prototype.getClassName=function(){return'VRDeviceOrientationGamepadCamera'},t}(e);d.VRDeviceOrientationGamepadCamera=t;var o=function(e){function t(t,p,r,n,o,s,a,l){void 0===a&&(a=!0),void 0===l&&(l=d.VRCameraMetrics.GetDefault());var u=e.call(this,t,p,r,n,o,s)||this;return l.compensateDistortion=a,u.setCameraRigMode(d.Camera.RIG_MODE_VR,{vrCameraMetrics:l}),u.inputs.addVRDeviceOrientation(),u}return h(t,e),t.prototype.getClassName=function(){return'VRDeviceOrientationArcRotateCamera'},t}(d.ArcRotateCamera);d.VRDeviceOrientationArcRotateCamera=o}(e||(e={}));var e;!function(d){var e=function(e){function t(t,a,r,l){var o=e.call(this,t,a,l)||this;return o.interaxialDistance=r,o.setCameraRigMode(d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),o}return h(t,e),t.prototype.getClassName=function(){return'AnaglyphFreeCamera'},t}(d.FreeCamera);d.AnaglyphFreeCamera=e;var t=function(e){function t(t,c,r,n,o,s,p){var l=e.call(this,t,c,r,n,o,p)||this;return l.interaxialDistance=s,l.setCameraRigMode(d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:s}),l}return h(t,e),t.prototype.getClassName=function(){return'AnaglyphArcRotateCamera'},t}(d.ArcRotateCamera);d.AnaglyphArcRotateCamera=t;var o=function(e){function t(t,a,r,l){var o=e.call(this,t,a,l)||this;return o.interaxialDistance=r,o.setCameraRigMode(d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),o}return h(t,e),t.prototype.getClassName=function(){return'AnaglyphGamepadCamera'},t}(d.GamepadCamera);d.AnaglyphGamepadCamera=o;var r=function(e){function t(t,a,r,l){var o=e.call(this,t,a,l)||this;return o.interaxialDistance=r,o.setCameraRigMode(d.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),o}return h(t,e),t.prototype.getClassName=function(){return'AnaglyphUniversalCamera'},t}(d.UniversalCamera);d.AnaglyphUniversalCamera=r;var i=function(e){function t(t,l,r,c,o){var s=e.call(this,t,l,o)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=c,s.setCameraRigMode(c?d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return h(t,e),t.prototype.getClassName=function(){return'StereoscopicFreeCamera'},t}(d.FreeCamera);d.StereoscopicFreeCamera=i;var n=function(e){function t(t,p,r,n,o,s,u,l){var f=e.call(this,t,p,r,n,o,l)||this;return f.interaxialDistance=s,f.isStereoscopicSideBySide=u,f.setCameraRigMode(u?d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:s}),f}return h(t,e),t.prototype.getClassName=function(){return'StereoscopicArcRotateCamera'},t}(d.ArcRotateCamera);d.StereoscopicArcRotateCamera=n;var a=function(e){function t(t,l,r,c,o){var s=e.call(this,t,l,o)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=c,s.setCameraRigMode(c?d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return h(t,e),t.prototype.getClassName=function(){return'StereoscopicGamepadCamera'},t}(d.GamepadCamera);d.StereoscopicGamepadCamera=a;var s=function(e){function t(t,l,r,c,o){var s=e.call(this,t,l,o)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=c,s.setCameraRigMode(c?d.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:d.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return h(t,e),t.prototype.getClassName=function(){return'StereoscopicUniversalCamera'},t}(d.UniversalCamera);d.StereoscopicUniversalCamera=s}(e||(e={}));var e;!function(d){var e=function(){function e(t,o){if(void 0===o&&(o=null),this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=e._idCounter++,o)this._gazeTracker=o.clone('gazeTracker');else{this._gazeTracker=d.Mesh.CreateTorus('gazeTracker',.0035,.0025,20,t,!1),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;var r=new d.StandardMaterial('targetMat',t);r.specularColor=d.Color3.Black(),r.emissiveColor=new d.Color3(.7,.7,.7),r.backFaceCulling=!1,this._gazeTracker.material=r}}return e.prototype._getForwardRay=function(e){return new d.Ray(d.Vector3.Zero(),new d.Vector3(0,0,e))},e.prototype._selectionPointerDown=function(){this._pointerDownOnMeshAsked=!0,this._currentMeshSelected&&this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})},e.prototype._selectionPointerUp=function(){this._currentMeshSelected&&this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1},e.prototype._activatePointer=function(){this._activePointer=!0},e.prototype._deactivatePointer=function(){this._activePointer=!1},e.prototype._updatePointerDistance=function(t){void 0===t&&(t=100)},e.prototype.dispose=function(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()},e._idCounter=0,e}(),a=function(e){function t(t,c,r){var n=e.call(this,c,r)||this;n.webVRController=t,n._laserPointer=d.Mesh.CreateCylinder('laserPointer',1,.004,2e-4,20,1,c,!1);var o=new d.StandardMaterial('laserPointerMat',c);if(o.emissiveColor=new d.Color3(.7,.7,.7),o.alpha=.6,n._laserPointer.material=o,n._laserPointer.rotation.x=V/2,n._laserPointer.position.z=-.5,n._laserPointer.isVisible=!1,!t.mesh){var s=new d.Mesh('preloadControllerMesh',c),a=new d.Mesh(d.PoseEnabledController.POINTING_POSE,c);a.rotation.x=-.7,s.addChild(a),t.attachToMesh(s)}return n._setLaserPointerParent(t.mesh),n._meshAttachedObserver=t._meshAttachedObservable.add(function(t){n._setLaserPointerParent(t)}),n}return h(t,e),t.prototype._getForwardRay=function(t){return this.webVRController.getForwardRay(t)},t.prototype._activatePointer=function(){e.prototype._activatePointer.call(this),this._laserPointer.isVisible=!0},t.prototype._deactivatePointer=function(){e.prototype._deactivatePointer.call(this),this._laserPointer.isVisible=!1},t.prototype._setLaserPointerColor=function(t){this._laserPointer.material.emissiveColor=t},t.prototype._setLaserPointerParent=function(e){var t=function(r){r.name+=' laserPointer',r.getChildMeshes().forEach(function(r){t(r)})};t(e);var o=e.getChildMeshes();this.webVRController._pointingPoseNode=null;for(var r=0;r<o.length;r++)if(o[r].name&&0<=o[r].name.indexOf(d.PoseEnabledController.POINTING_POSE)){e=o[r],this.webVRController._pointingPoseNode=e;break}this._laserPointer.parent=e},t.prototype._updatePointerDistance=function(t){void 0===t&&(t=100),this._laserPointer.scaling.y=t,this._laserPointer.position.z=-t/2},t.prototype.dispose=function(){e.prototype.dispose.call(this),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)},t}(e),i=function(o){function e(t,e){var a=o.call(this,e)||this;return a.getCamera=t,a}return h(e,o),e.prototype._getForwardRay=function(e){var t=this.getCamera();return t?t.getForwardRay(e):new d.Ray(d.Vector3.Zero(),d.Vector3.Forward())},e}(e),t=function(){function e(e,r){void 0===r&&(r={});var c=this;if(this.webVROptions=r,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.onEnteringVRObservable=new d.Observable,this.onExitingVRObservable=new d.Observable,this.onControllerMeshLoadedObservable=new d.Observable,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._rotationAllowed=!0,this._teleportBackwardsVector=new d.Vector3(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor='#444444',this._teleportationBorderColor='#FFFFFF',this._rotationAngle=0,this._haloCenter=new d.Vector3(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this.leftController=null,this.rightController=null,this.onNewMeshSelected=new d.Observable,this.onNewMeshPicked=new d.Observable,this.onBeforeCameraTeleport=new d.Observable,this.onAfterCameraTeleport=new d.Observable,this.onSelectedMeshUnselected=new d.Observable,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this._onResize=function(){c.moveButtonToBottomRight(),c._fullscreenVRpresenting&&c._webVRready&&c.exitVR()},this._onFullscreenChange=function(){void 0===document.fullscreen?void 0===document.mozFullScreen?void 0===document.webkitIsFullScreen?void 0!==document.msIsFullScreen&&(c._fullscreenVRpresenting=document.msIsFullScreen):c._fullscreenVRpresenting=document.webkitIsFullScreen:c._fullscreenVRpresenting=document.mozFullScreen:c._fullscreenVRpresenting=document.fullscreen,!c._fullscreenVRpresenting&&c._canvas&&(c.exitVR(),c._useCustomVRButton||(c._btnVR.style.top=c._canvas.offsetTop+c._canvas.offsetHeight-70+'px',c._btnVR.style.left=c._canvas.offsetLeft+c._canvas.offsetWidth-100+'px'))},this.beforeRender=function(){c.leftController&&c.leftController._activePointer&&c._castRayAndSelectObject(c.leftController),c.rightController&&c.rightController._activePointer&&c._castRayAndSelectObject(c.rightController),c.leftController&&c.leftController._activePointer||c.rightController&&c.rightController._activePointer?c._cameraGazer._gazeTracker.isVisible=!1:c._castRayAndSelectObject(c._cameraGazer)},this._onNewGamepadConnected=function(e){if(e.type!==d.Gamepad.POSE_ENABLED)e.leftStick&&e.onleftstickchanged(function(t){c._teleportationInitialized&&c.teleportationEnabled&&(!c.leftController&&!c.rightController||c.leftController&&!c.leftController._activePointer&&c.rightController&&!c.rightController._activePointer)&&(c._checkTeleportWithRay(t,c._cameraGazer),c._checkTeleportBackwards(t,c._cameraGazer))}),e.rightStick&&e.onrightstickchanged(function(t){c._teleportationInitialized&&c._checkRotate(t,c._cameraGazer)}),e.type===d.Gamepad.XBOX&&(e.onbuttondown(function(e){c._interactionsEnabled&&e===d.Xbox360Button.A&&c._cameraGazer._selectionPointerDown()}),e.onbuttonup(function(e){c._interactionsEnabled&&e===d.Xbox360Button.A&&c._cameraGazer._selectionPointerUp()}));else{var t=e,r=new a(t,c._scene,c._cameraGazer._gazeTracker);'right'===t.hand||c.leftController&&c.leftController.webVRController!=t?c.rightController=r:c.leftController=r,c._tryEnableInteractionOnController(r)}},this._tryEnableInteractionOnController=function(t){c._interactionsRequested&&!t._interactionsEnabled&&c._enableInteractionOnController(t),c._teleportationRequested&&!t._teleportationEnabled&&c._enableTeleportationOnController(t)},this._onNewGamepadDisconnected=function(e){e instanceof d.WebVRController&&('left'===e.hand&&null!=c.leftController&&(c.leftController.dispose(),c.leftController=null),'right'===e.hand&&null!=c.rightController&&(c.rightController.dispose(),c.rightController=null))},this._workingVector=d.Vector3.Zero(),this._workingQuaternion=d.Quaternion.Identity(),this._workingMatrix=d.Matrix.Identity(),this._scene=e,this._canvas=e.getEngine().getRenderingCanvas(),void 0===r.createFallbackVRDeviceOrientationFreeCamera&&(r.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===r.createDeviceOrientationCamera&&(r.createDeviceOrientationCamera=!0),void 0===r.defaultHeight&&(r.defaultHeight=1.7),r.useCustomVRButton&&(this._useCustomVRButton=!0,r.customVRButton&&(this._btnVR=r.customVRButton)),r.rayLength&&(this._rayLength=r.rayLength),this._defaultHeight=r.defaultHeight,r.positionScale&&(this._rayLength*=r.positionScale,this._defaultHeight*=r.positionScale),this._position=this._scene.activeCamera?this._scene.activeCamera.position.clone():new d.Vector3(0,this._defaultHeight,0),r.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new d.DeviceOrientationCamera('deviceOrientationVRHelper',this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof d.TargetCamera&&this._scene.activeCamera.rotation)){var o=this._scene.activeCamera;o.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(o.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(d.Quaternion.RotationYawPitchRoll(o.rotation.y,o.rotation.x,o.rotation.z)),this._deviceOrientationCamera.rotation=o.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._canvas&&this._scene.activeCamera.attachControl(this._canvas)}else this._existingCamera=this._scene.activeCamera;if(r.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new d.VRDeviceOrientationFreeCamera('VRDeviceOrientationVRHelper',this._position,this._scene)),this._webVRCamera=new d.WebVRFreeCamera('WebVRHelper',this._position,this._scene,r),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new i(function(){return c.currentVRCamera},e),!this._useCustomVRButton){this._btnVR=document.createElement('BUTTON'),this._btnVR.className='babylonVRicon',this._btnVR.id='babylonVRiconbtn',this._btnVR.title='Click to switch to VR';var n='.babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url(data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }';n+='.babylonVRicon.vrdisplaypresenting { display: none; }';var s=document.createElement('style');s.appendChild(document.createTextNode(n)),document.getElementsByTagName('head')[0].appendChild(s),this.moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener('click',function(){c.isInVRMode?c.exitVR():c.enterVR()}),window.addEventListener('resize',this._onResize),document.addEventListener('fullscreenchange',this._onFullscreenChange,!1),document.addEventListener('mozfullscreenchange',this._onFullscreenChange,!1),document.addEventListener('webkitfullscreenchange',this._onFullscreenChange,!1),document.addEventListener('msfullscreenchange',this._onFullscreenChange,!1),r.createFallbackVRDeviceOrientationFreeCamera?this.displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(function(t){t.vrDisplay&&c.displayVRButton()}),this._onKeyDown=function(t){27===t.keyCode&&c.isInVRMode&&c.exitVR()},document.addEventListener('keydown',this._onKeyDown),this._scene.onPrePointerObservable.add(function(){c.isInVRMode&&(c.exitVR(),c._fullscreenVRpresenting&&c._scene.getEngine().switchFullscreen(!0))},d.PointerEventTypes.POINTERDOUBLETAP,!1),this._onVRDisplayChanged=function(t){return c.onVRDisplayChanged(t)},this._onVrDisplayPresentChange=function(){return c.onVrDisplayPresentChange()},this._onVRRequestPresentStart=function(){c._webVRrequesting=!0,c.updateButtonVisibility()},this._onVRRequestPresentComplete=function(){c._webVRrequesting=!1,c.updateButtonVisibility()},e.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChanged),e.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),e.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),window.addEventListener('vrdisplaypresentchange',this._onVrDisplayPresentChange),e.onDisposeObservable.add(function(){c.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(function(t){return c._onDefaultMeshLoaded(t)}),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this.updateButtonVisibility(),this._circleEase=new d.CircleEase,this._circleEase.setEasingMode(d.EasingFunction.EASINGMODE_EASEINOUT)}return Object.defineProperty(e.prototype,'onEnteringVR',{get:function(){return this.onEnteringVRObservable},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onExitingVR',{get:function(){return this.onExitingVRObservable},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onControllerMeshLoaded',{get:function(){return this.onControllerMeshLoadedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'teleportationTarget',{get:function(){return this._teleportationTarget},set:function(t){t&&(t.name='teleportationTarget',this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'gazeTrackerMesh',{get:function(){return this._cameraGazer._gazeTracker},set:function(t){t&&(this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name='gazeTracker',this.leftController&&(this.leftController._gazeTracker=this._cameraGazer._gazeTracker.clone('gazeTracker')),this.rightController&&(this.rightController._gazeTracker=this._cameraGazer._gazeTracker.clone('gazeTracker')))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'displayGaze',{get:function(){return this._displayGaze},set:function(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1,this.leftController&&(this.leftController._gazeTracker.isVisible=!1),this.rightController&&(this.rightController._gazeTracker.isVisible=!1))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'displayLaserPointer',{get:function(){return this._displayLaserPointer},set:function(t){this._displayLaserPointer=t,t?(this.rightController&&this.rightController._activatePointer(),this.leftController&&this.leftController._activatePointer()):(this.rightController&&(this.rightController._deactivatePointer(),this.rightController._gazeTracker.isVisible=!1),this.leftController&&(this.leftController._deactivatePointer(),this.leftController._gazeTracker.isVisible=!1))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'deviceOrientationCamera',{get:function(){return this._deviceOrientationCamera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'currentVRCamera',{get:function(){return this._webVRready?this._webVRCamera:this._scene.activeCamera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'webVRCamera',{get:function(){return this._webVRCamera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'vrDeviceOrientationCamera',{get:function(){return this._vrDeviceOrientationCamera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'_teleportationRequestInitiated',{get:function(){return this._cameraGazer._teleportationRequestInitiated||null!==this.leftController&&this.leftController._teleportationRequestInitiated||null!==this.rightController&&this.rightController._teleportationRequestInitiated},enumerable:!0,configurable:!0}),e.prototype._onDefaultMeshLoaded=function(e){this.leftController&&this.leftController.webVRController==e&&e.mesh&&this.leftController._setLaserPointerParent(e.mesh),this.rightController&&this.rightController.webVRController==e&&e.mesh&&this.rightController._setLaserPointerParent(e.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(e)}catch(e){d.Tools.Warn('Error in your custom logic onControllerMeshLoaded: '+e)}},Object.defineProperty(e.prototype,'isInVRMode',{get:function(){return this._webVRpresenting||this._fullscreenVRpresenting},enumerable:!0,configurable:!0}),e.prototype.onVrDisplayPresentChange=function(){var e=this._scene.getEngine().getVRDevice();if(e){var t=this._webVRpresenting;this._webVRpresenting=e.isPresenting,t&&!this._webVRpresenting&&this.exitVR()}else d.Tools.Warn('Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?');this.updateButtonVisibility()},e.prototype.onVRDisplayChanged=function(t){this._webVRsupported=t.vrSupported,this._webVRready=!!t.vrDisplay,this._webVRpresenting=t.vrDisplay&&t.vrDisplay.isPresenting,this.updateButtonVisibility()},e.prototype.moveButtonToBottomRight=function(){this._canvas&&!this._useCustomVRButton&&(this._btnVR.style.top=this._canvas.offsetTop+this._canvas.offsetHeight-70+'px',this._btnVR.style.left=this._canvas.offsetLeft+this._canvas.offsetWidth-100+'px')},e.prototype.displayVRButton=function(){this._useCustomVRButton||this._btnVRDisplayed||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)},e.prototype.updateButtonVisibility=function(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className='babylonVRicon',this.isInVRMode?this._btnVR.className+=' vrdisplaypresenting':(this._webVRready&&(this._btnVR.className+=' vrdisplayready'),this._webVRsupported&&(this._btnVR.className+=' vrdisplaysupported'),this._webVRrequesting&&(this._btnVR.className+=' vrdisplayrequesting')))},e.prototype.enterVR=function(){if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){d.Tools.Warn('Error in your custom logic onEnteringVR: '+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this._existingCamera=this._scene.activeCamera),this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().switchFullscreen(!0),this.updateButtonVisibility()),this._scene.activeCamera&&this._canvas&&this._scene.activeCamera.attachControl(this._canvas),this._interactionsEnabled&&this._scene.registerBeforeRender(this.beforeRender))},e.prototype.exitVR=function(){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){d.Tools.Warn('Error in your custom logic onExitingVR: '+e)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._canvas&&this._scene.activeCamera.attachControl(this._canvas)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera),this.updateButtonVisibility(),this._interactionsEnabled&&this._scene.unregisterBeforeRender(this.beforeRender),this._scene.getEngine().resize()},Object.defineProperty(e.prototype,'position',{get:function(){return this._position},set:function(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)},enumerable:!0,configurable:!0}),e.prototype.enableInteractions=function(){var r=this;this._interactionsEnabled||(this._interactionsRequested=!0,this.leftController&&this._enableInteractionOnController(this.leftController),this.rightController&&this._enableInteractionOnController(this.rightController),this.raySelectionPredicate=function(t){return t.isVisible},this.meshSelectionPredicate=function(){return!0},this._raySelectionPredicate=function(e){return!!(r._isTeleportationFloor(e)||-1===e.name.indexOf('gazeTracker')&&-1===e.name.indexOf('teleportationTarget')&&-1===e.name.indexOf('torusTeleportation')&&-1===e.name.indexOf('laserPointer'))&&r.raySelectionPredicate(e)},this._interactionsEnabled=!0)},e.prototype._isTeleportationFloor=function(r){for(var e=0;e<this._floorMeshesCollection.length;e++)if(this._floorMeshesCollection[e].id===r.id)return!0;return this._floorMeshName&&r.name===this._floorMeshName},e.prototype.addFloorMesh=function(t){this._floorMeshesCollection&&(-1<this._floorMeshesCollection.indexOf(t)||this._floorMeshesCollection.push(t))},e.prototype.removeFloorMesh=function(r){if(this._floorMeshesCollection){var e=this._floorMeshesCollection.indexOf(r);-1!==e&&this._floorMeshesCollection.splice(e,1)}},e.prototype.enableTeleportation=function(e){if(void 0===e&&(e={}),!this._teleportationInitialized){this._teleportationRequested=!0,this.enableInteractions(),e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),null!=this.leftController&&this._enableTeleportationOnController(this.leftController),null!=this.rightController&&this._enableTeleportationOnController(this.rightController);var t=new d.ImageProcessingConfiguration;t.vignetteColor=new d.Color4(0,0,0,0),t.vignetteEnabled=!0,this._postProcessMove=new d.ImageProcessingPostProcess('postProcessMove',1,this._webVRCamera,void 0,void 0,void 0,void 0,t),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}},e.prototype._enableInteractionOnController=function(r){var e=this;r.webVRController.mesh&&(r._interactionsEnabled=!0,r._activatePointer(),r.webVRController.onMainButtonStateChangedObservable.add(function(t){e._displayLaserPointer&&1===t.value&&(r._activePointer?r._deactivatePointer():r._activatePointer(),e.displayGaze&&(r._gazeTracker.isVisible=r._activePointer))}),r.webVRController.onTriggerStateChangedObservable.add(function(t){r._pointerDownOnMeshAsked?t.value<e._padSensibilityDown&&r._selectionPointerUp():t.value>e._padSensibilityUp&&r._selectionPointerDown()}))},e.prototype._checkTeleportWithRay=function(r,e){this._teleportationRequestInitiated&&!e._teleportationRequestInitiated||(e._teleportationRequestInitiated?$(r.y*r.y+r.x*r.x)<this._padSensibilityDown&&(this._teleportActive&&this._teleportCamera(this._haloCenter),e._teleportationRequestInitiated=!1):r.y<-this._padSensibilityUp&&e._dpadPressed&&(e._activatePointer(),e._teleportationRequestInitiated=!0))},e.prototype._checkRotate=function(r,e){e._teleportationRequestInitiated||(e._rotationLeftAsked?r.x>-this._padSensibilityDown&&(e._rotationLeftAsked=!1):r.x<-this._padSensibilityUp&&e._dpadPressed&&(e._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),e._rotationRightAsked?r.x<this._padSensibilityDown&&(e._rotationRightAsked=!1):r.x>this._padSensibilityUp&&e._dpadPressed&&(e._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))},e.prototype._checkTeleportBackwards=function(e,t){if(!t._teleportationRequestInitiated)if(!(e.y>this._padSensibilityUp&&t._dpadPressed))t._teleportationBackRequestInitiated=!1;else if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;var i=d.Quaternion.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(i=this.currentVRCamera.deviceRotationQuaternion,r=this.currentVRCamera.devicePosition),i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,d.Quaternion.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),d.Vector3.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);var a=new d.Ray(r,this._workingVector),o=this._scene.pickWithRay(a,this._raySelectionPredicate);o&&o.pickedPoint&&o.pickedMesh&&this._isTeleportationFloor(o.pickedMesh)&&5>o.distance&&this._teleportCamera(o.pickedPoint),t._teleportationBackRequestInitiated=!0}},e.prototype._enableTeleportationOnController=function(r){var t=this;r.webVRController.mesh&&(r._interactionsEnabled||this._enableInteractionOnController(r),r._interactionsEnabled=!0,r._teleportationEnabled=!0,r.webVRController.controllerType===d.PoseEnabledControllerType.VIVE&&(r._dpadPressed=!1,r.webVRController.onPadStateChangedObservable.add(function(t){r._dpadPressed=t.pressed,r._dpadPressed||(r._rotationLeftAsked=!1,r._rotationRightAsked=!1,r._teleportationBackRequestInitiated=!1)})),r.webVRController.onPadValuesChangedObservable.add(function(o){t.teleportationEnabled&&(t._checkTeleportBackwards(o,r),t._checkTeleportWithRay(o,r)),t._checkRotate(o,r)}))},e.prototype._createTeleportationCircles=function(){this._teleportationTarget=d.Mesh.CreateGround('teleportationTarget',2,2,2,this._scene),this._teleportationTarget.isPickable=!1;var e=new d.DynamicTexture('DynamicTexture',512,this._scene,!0);e.hasAlpha=!0;var t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*V,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();var i=new d.StandardMaterial('TextPlaneMaterial',this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;var r=d.Mesh.CreateTorus('torusTeleportation',.75,.1,25,this._scene,!1);r.isPickable=!1,r.parent=this._teleportationTarget;var n=new d.Animation('animationInnerCircle','position.y',30,d.Animation.ANIMATIONTYPE_FLOAT,d.Animation.ANIMATIONLOOPMODE_CYCLE),o=[];o.push({frame:0,value:0}),o.push({frame:30,value:.4}),o.push({frame:60,value:0}),n.setKeys(o);var s=new d.SineEase;s.setEasingMode(d.EasingFunction.EASINGMODE_EASEINOUT),n.setEasingFunction(s),r.animations=[],r.animations.push(n),this._scene.beginAnimation(r,0,60,!0),this._hideTeleportationTarget()},e.prototype._displayTeleportationTarget=function(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))},e.prototype._hideTeleportationTarget=function(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))},e.prototype._rotateCamera=function(e){var t=this;if(this.currentVRCamera instanceof d.FreeCamera){e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];var i=d.Quaternion.FromRotationMatrix(d.Matrix.RotationY(V/4*this._rotationAngle)),c=new d.Animation('animationRotation','rotationQuaternion',90,d.Animation.ANIMATIONTYPE_QUATERNION,d.Animation.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),n.push({frame:6,value:i}),c.setKeys(n),c.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(c),this._postProcessMove.animations=[];var o=new d.Animation('animationPP','vignetteWeight',90,d.Animation.ANIMATIONTYPE_FLOAT,d.Animation.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:0}),s.push({frame:3,value:4}),s.push({frame:6,value:0}),o.setKeys(s),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o);var a=new d.Animation('animationPP2','vignetteStretch',90,d.Animation.ANIMATIONTYPE_FLOAT,d.Animation.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),a.setKeys(l),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,function(){t._webVRCamera.detachPostProcess(t._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}},e.prototype._moveTeleportationSelectorTo=function(e,t,i){if(e.pickedPoint){t._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(e.pickedPoint),this._teleportationTarget.position.copyFrom(e.pickedPoint));var r=this._convertNormalToDirectionOfRay(e.getNormal(!0,!1),i);if(r){var a=d.Vector3.Cross(d.Axis.Y,r),o=d.Vector3.Cross(r,a);d.Vector3.RotationFromAxisToRef(o,r,a,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}},e.prototype._teleportCamera=function(e){var t=this;if(this.currentVRCamera instanceof d.FreeCamera){this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),e.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(e),this._workingVector.y+=this.isInVRMode?this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this.currentVRCamera.animations=[];var i=new d.Animation('animationCameraTeleportation','position',90,d.Animation.ANIMATIONTYPE_VECTOR3,d.Animation.ANIMATIONLOOPMODE_CONSTANT),r=[{frame:0,value:this.currentVRCamera.position},{frame:11,value:this._workingVector}];i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];var n=new d.Animation('animationPP','vignetteWeight',90,d.Animation.ANIMATIONTYPE_FLOAT,d.Animation.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:5,value:8}),o.push({frame:11,value:0}),n.setKeys(o),this._postProcessMove.animations.push(n);var s=new d.Animation('animationPP2','vignetteStretch',90,d.Animation.ANIMATIONTYPE_FLOAT,d.Animation.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:5,value:10}),a.push({frame:11,value:0}),s.setKeys(a),this._postProcessMove.animations.push(s),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,11,!1,1,function(){t._webVRCamera.detachPostProcess(t._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,11,!1,1,function(){t.onAfterCameraTeleport.notifyObservers(t._workingVector)}),this._hideTeleportationTarget()}},e.prototype._convertNormalToDirectionOfRay=function(e,t){return e&&T(d.Vector3.Dot(e,t.direction))<V/2&&e.scaleInPlace(-1),e},e.prototype._castRayAndSelectObject=function(e){if(this.currentVRCamera instanceof d.FreeCamera){var t=e._getForwardRay(this._rayLength),i=this._scene.pickWithRay(t,this._raySelectionPredicate);if(i&&i.pickedPoint){if(this._displayGaze){var r=1;e._gazeTracker.isVisible=!0,e._isActionableMesh&&(r=3),e._gazeTracker.scaling.x=i.distance*r,e._gazeTracker.scaling.y=i.distance*r,e._gazeTracker.scaling.z=i.distance*r;var n=this._convertNormalToDirectionOfRay(i.getNormal(),t);if(n){var o=d.Vector3.Cross(d.Axis.Y,n),s=d.Vector3.Cross(n,o);d.Vector3.RotationFromAxisToRef(s,n,o,e._gazeTracker.rotation)}e._gazeTracker.position.copyFrom(i.pickedPoint),0>e._gazeTracker.position.x?e._gazeTracker.position.x+=.002:e._gazeTracker.position.x-=.002,0>e._gazeTracker.position.y?e._gazeTracker.position.y+=.002:e._gazeTracker.position.y-=.002,0>e._gazeTracker.position.z?e._gazeTracker.position.z+=.002:e._gazeTracker.position.z-=.002}e._updatePointerDistance(i.distance)}else e._updatePointerDistance(),e._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(e._currentHit=i,e._pointerDownOnMeshAsked&&this._scene.simulatePointerMove(e._currentHit,{pointerId:e._id}),this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint)return e._currentMeshSelected&&!this._isTeleportationFloor(e._currentMeshSelected)&&this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,void(e._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,e,t));if(i.pickedMesh!==e._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),e._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(new d.Color3(0,0,1)),this.changeLaserColor(new d.Color3(.2,.2,1)),e._isActionableMesh=!0):(this.changeGazeColor(new d.Color3(.7,.7,.7)),this.changeLaserColor(new d.Color3(.7,.7,.7)),e._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh)}catch(e){d.Tools.Warn('Error in your custom logic onNewMeshSelected: '+e)}}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(new d.Color3(.7,.7,.7)),this.changeLaserColor(new d.Color3(.7,.7,.7))}else e._currentHit=null,this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(new d.Color3(.7,.7,.7)),this.changeLaserColor(new d.Color3(.7,.7,.7))}},e.prototype._notifySelectedMeshUnselected=function(t){t&&this.onSelectedMeshUnselected.notifyObservers(t)},e.prototype.changeLaserColor=function(t){this.leftController&&this.leftController._setLaserPointerColor(t),this.rightController&&this.rightController._setLaserPointerColor(t)},e.prototype.changeGazeColor=function(t){this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=t,this.leftController&&(this.leftController._gazeTracker.material.emissiveColor=t),this.rightController&&(this.rightController._gazeTracker.material.emissiveColor=t))},e.prototype.dispose=function(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this.leftController&&this.leftController.dispose(),this.rightController&&this.rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this._floorMeshesCollection=[],document.removeEventListener('keydown',this._onKeyDown),window.removeEventListener('vrdisplaypresentchange',this._onVrDisplayPresentChange),window.removeEventListener('resize',this._onResize),document.removeEventListener('fullscreenchange',this._onFullscreenChange),document.removeEventListener('mozfullscreenchange',this._onFullscreenChange),document.removeEventListener('webkitfullscreenchange',this._onFullscreenChange),document.removeEventListener('msfullscreenchange',this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChanged),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),window.removeEventListener('vrdisplaypresentchange',this._onVrDisplayPresentChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this.beforeRender)},e.prototype.getClassName=function(){return'VRExperienceHelper'},e}();d.VRExperienceHelper=t}(e||(e={}));var e;!function(a){var s;!function(t){t[t.X=0]='X',t[t.Y=1]='Y',t[t.Z=2]='Z'}(s=a.JoystickAxis||(a.JoystickAxis={}));var e=function(){function l(e){var t=this;if(this._leftJoystick=!!e,l._globalJoystickIndex++,this._axisTargetedByLeftAndRight=s.X,this._axisTargetedByUpAndDown=s.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new a.StringDictionary,this.deltaPosition=a.Vector3.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=function(){l.vjCanvasWidth=window.innerWidth,l.vjCanvasHeight=window.innerHeight,l.vjCanvas&&(l.vjCanvas.width=l.vjCanvasWidth,l.vjCanvas.height=l.vjCanvasHeight),l.halfWidth=l.vjCanvasWidth/2},!l.vjCanvas){window.addEventListener('resize',this._onResize,!1),l.vjCanvas=document.createElement('canvas'),l.vjCanvasWidth=window.innerWidth,l.vjCanvasHeight=window.innerHeight,l.vjCanvas.width=window.innerWidth,l.vjCanvas.height=window.innerHeight,l.vjCanvas.style.width='100%',l.vjCanvas.style.height='100%',l.vjCanvas.style.position='absolute',l.vjCanvas.style.backgroundColor='transparent',l.vjCanvas.style.top='0px',l.vjCanvas.style.left='0px',l.vjCanvas.style.zIndex='5',l.vjCanvas.style.msTouchAction='none',l.vjCanvas.setAttribute('touch-action','none');var i=l.vjCanvas.getContext('2d');if(!i)throw new Error('Unable to create canvas for virtual joystick');l.vjCanvasContext=i,l.vjCanvasContext.strokeStyle='#ffffff',l.vjCanvasContext.lineWidth=2,document.body.appendChild(l.vjCanvas)}l.halfWidth=l.vjCanvas.width/2,this.pressed=!1,this._joystickColor='cyan',this._joystickPointerID=-1,this._joystickPointerPos=new a.Vector2(0,0),this._joystickPreviousPointerPos=new a.Vector2(0,0),this._joystickPointerStartPos=new a.Vector2(0,0),this._deltaJoystickVector=new a.Vector2(0,0),this._onPointerDownHandlerRef=function(r){t._onPointerDown(r)},this._onPointerMoveHandlerRef=function(r){t._onPointerMove(r)},this._onPointerUpHandlerRef=function(r){t._onPointerUp(r)},l.vjCanvas.addEventListener('pointerdown',this._onPointerDownHandlerRef,!1),l.vjCanvas.addEventListener('pointermove',this._onPointerMoveHandlerRef,!1),l.vjCanvas.addEventListener('pointerup',this._onPointerUpHandlerRef,!1),l.vjCanvas.addEventListener('pointerout',this._onPointerUpHandlerRef,!1),l.vjCanvas.addEventListener('contextmenu',function(t){t.preventDefault()},!1),requestAnimationFrame(function(){t._drawVirtualJoystick()})}return l.prototype.setJoystickSensibility=function(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)},l.prototype._onPointerDown=function(r){var e;r.preventDefault(),e=!0===this._leftJoystick?r.clientX<l.halfWidth:r.clientX>l.halfWidth,e&&0>this._joystickPointerID?(this._joystickPointerID=r.pointerId,this._joystickPointerStartPos.x=r.clientX,this._joystickPointerStartPos.y=r.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone(),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(r.pointerId.toString(),r)):2>l._globalJoystickIndex&&this._action&&(this._action(),this._touches.add(r.pointerId.toString(),{x:r.clientX,y:r.clientY,prevX:r.clientX,prevY:r.clientY}))},l.prototype._onPointerMove=function(t){if(this._joystickPointerID==t.pointerId){this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY,this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var e=this.reverseLeftRight?-1:1,i=e*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case s.X:this.deltaPosition.x=C(1,W(-1,i));break;case s.Y:this.deltaPosition.y=C(1,W(-1,i));break;case s.Z:this.deltaPosition.z=C(1,W(-1,i));}var r=this.reverseUpDown?1:-1,a=r*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case s.X:this.deltaPosition.x=C(1,W(-1,a));break;case s.Y:this.deltaPosition.y=C(1,W(-1,a));break;case s.Z:this.deltaPosition.z=C(1,W(-1,a));}}else{var o=this._touches.get(t.pointerId.toString());o&&(o.x=t.clientX,o.y=t.clientY)}},l.prototype._onPointerUp=function(r){if(this._joystickPointerID==r.pointerId)l.vjCanvasContext.clearRect(this._joystickPointerStartPos.x-64,this._joystickPointerStartPos.y-64,128,128),l.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-42,this._joystickPreviousPointerPos.y-42,84,84),this._joystickPointerID=-1,this.pressed=!1;else{var e=this._touches.get(r.pointerId.toString());e&&l.vjCanvasContext.clearRect(e.prevX-44,e.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(r.pointerId.toString())},l.prototype.setJoystickColor=function(t){this._joystickColor=t},l.prototype.setActionOnTouch=function(t){this._action=t},l.prototype.setAxisForLeftRight=function(t){this._axisTargetedByLeftAndRight=t===s.X||t===s.Y||t===s.Z?t:s.X},l.prototype.setAxisForUpDown=function(t){this._axisTargetedByUpAndDown=t===s.X||t===s.Y||t===s.Z?t:s.Y},l.prototype._drawVirtualJoystick=function(){var o=this;this.pressed&&this._touches.forEach(function(e,t){t.pointerId===o._joystickPointerID?(l.vjCanvasContext.clearRect(o._joystickPointerStartPos.x-64,o._joystickPointerStartPos.y-64,128,128),l.vjCanvasContext.clearRect(o._joystickPreviousPointerPos.x-42,o._joystickPreviousPointerPos.y-42,84,84),l.vjCanvasContext.beginPath(),l.vjCanvasContext.lineWidth=6,l.vjCanvasContext.strokeStyle=o._joystickColor,l.vjCanvasContext.arc(o._joystickPointerStartPos.x,o._joystickPointerStartPos.y,40,0,2*V,!0),l.vjCanvasContext.stroke(),l.vjCanvasContext.closePath(),l.vjCanvasContext.beginPath(),l.vjCanvasContext.strokeStyle=o._joystickColor,l.vjCanvasContext.lineWidth=2,l.vjCanvasContext.arc(o._joystickPointerStartPos.x,o._joystickPointerStartPos.y,60,0,2*V,!0),l.vjCanvasContext.stroke(),l.vjCanvasContext.closePath(),l.vjCanvasContext.beginPath(),l.vjCanvasContext.strokeStyle=o._joystickColor,l.vjCanvasContext.arc(o._joystickPointerPos.x,o._joystickPointerPos.y,40,0,2*V,!0),l.vjCanvasContext.stroke(),l.vjCanvasContext.closePath(),o._joystickPreviousPointerPos=o._joystickPointerPos.clone()):(l.vjCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),l.vjCanvasContext.beginPath(),l.vjCanvasContext.fillStyle='white',l.vjCanvasContext.beginPath(),l.vjCanvasContext.strokeStyle='red',l.vjCanvasContext.lineWidth=6,l.vjCanvasContext.arc(t.x,t.y,40,0,2*V,!0),l.vjCanvasContext.stroke(),l.vjCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(function(){o._drawVirtualJoystick()})},l.prototype.releaseCanvas=function(){l.vjCanvas&&(l.vjCanvas.removeEventListener('pointerdown',this._onPointerDownHandlerRef),l.vjCanvas.removeEventListener('pointermove',this._onPointerMoveHandlerRef),l.vjCanvas.removeEventListener('pointerup',this._onPointerUpHandlerRef),l.vjCanvas.removeEventListener('pointerout',this._onPointerUpHandlerRef),window.removeEventListener('resize',this._onResize),document.body.removeChild(l.vjCanvas),l.vjCanvas=null)},l._globalJoystickIndex=0,l}();a.VirtualJoystick=e}(e||(e={}));var e;!function(r){var e=function(o){function e(e,a,i){var r=o.call(this,e,a,i)||this;return r.inputs.addVirtualJoystick(),r}return h(e,o),e.prototype.getClassName=function(){return'VirtualJoysticksCamera'},e}(r.FreeCamera);r.VirtualJoysticksCamera=e}(e||(e={}));var e;!function(o){var e=function(){function e(){}return e.prototype.getLeftJoystick=function(){return this._leftjoystick},e.prototype.getRightJoystick=function(){return this._rightjoystick},e.prototype.checkInputs=function(){if(this._leftjoystick){var e=this.camera,t=50*e._computeLocalCameraSpeed(),i=o.Matrix.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=o.Vector3.TransformCoordinates(new o.Vector3(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}},e.prototype.attachControl=function(){this._leftjoystick=new o.VirtualJoystick(!0),this._leftjoystick.setAxisForUpDown(o.JoystickAxis.Z),this._leftjoystick.setAxisForLeftRight(o.JoystickAxis.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new o.VirtualJoystick(!1),this._rightjoystick.setAxisForUpDown(o.JoystickAxis.X),this._rightjoystick.setAxisForLeftRight(o.JoystickAxis.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor('yellow')},e.prototype.detachControl=function(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()},e.prototype.getClassName=function(){return'FreeCameraVirtualJoystickInput'},e.prototype.getSimpleName=function(){return'virtualJoystick'},e}();o.FreeCameraVirtualJoystickInput=e,o.CameraInputTypes.FreeCameraVirtualJoystickInput=e}(e||(e={}));var e;!function(T){var e=function(){function t(r,o,t){this.quality=r,this.distance=o,this.optimizeMesh=t}return t}();T.SimplificationSettings=e;var t=function(){function e(){this.running=!1,this._simplificationArray=[]}return e.prototype.addTask=function(t){this._simplificationArray.push(t)},e.prototype.executeNext=function(){var t=this._simplificationArray.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1},e.prototype.runSimplification=function(o){var t=this;if(o.parallelProcessing)o.settings.forEach(function(i){t.getSimplifier(o).simplify(i,function(e){o.mesh.addLODLevel(i.distance,e),e.isVisible=!0,i.quality===o.settings[o.settings.length-1].quality&&o.successCallback&&o.successCallback(),t.executeNext()})});else{var a=this.getSimplifier(o),r=function(t,e){a.simplify(t,function(i){o.mesh.addLODLevel(t.distance,i),i.isVisible=!0,e()})};T.AsyncLoop.Run(o.settings.length,function(t){r(o.settings[t.index],function(){t.executeNext()})},function(){o.successCallback&&o.successCallback(),t.executeNext()})}},e.prototype.getSimplifier=function(t){switch(t.simplificationType){case i.QUADRATIC:default:return new r(t.mesh);}},e}();T.SimplificationQueue=t;var i;!function(t){t[t.QUADRATIC=0]='QUADRATIC'}(i=T.SimplificationType||(T.SimplificationType={}));var _=function(){function t(t){this.vertices=t,this.error=[,,,,],this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}return t}();T.DecimationTriangle=_;var d=function(){function t(r,i){this.position=r,this.id=i,this.isBorder=!0,this.q=new o,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}return t.prototype.updatePosition=function(t){this.position.copyFrom(t)},t}();T.DecimationVertex=d;var o=function(){function o(r){this.data=Array(10);for(var o=0;10>o;++o)this.data[o]=r&&r[o]?r[o]:0}return o.prototype.det=function(d,e,t,i,r,n,o,s,a){return this.data[d]*this.data[r]*this.data[a]+this.data[t]*this.data[i]*this.data[s]+this.data[e]*this.data[n]*this.data[o]-this.data[t]*this.data[r]*this.data[o]-this.data[d]*this.data[n]*this.data[s]-this.data[e]*this.data[i]*this.data[a]},o.prototype.addInPlace=function(r){for(var e=0;10>e;++e)this.data[e]+=r.data[e]},o.prototype.addArrayInPlace=function(r){for(var e=0;10>e;++e)this.data[e]+=r[e]},o.prototype.add=function(e){for(var t=new o,i=0;10>i;++i)t.data[i]=this.data[i]+e.data[i];return t},o.FromData=function(e,t,i,r){return new o(o.DataFromNumbers(e,t,i,r))},o.DataFromNumbers=function(o,e,t,i){return[o*o,o*e,o*t,o*i,e*e,e*t,e*i,t*t,t*i,i*i]},o}();T.QuadraticMatrix=o;var s=function(){function t(r,o){this.vertexId=r,this.triangleId=o}return t}();T.Reference=s;var r=function(){function e(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=T.Epsilon}return e.prototype.simplify=function(o,e){var t=this;this.initDecimatedMesh(),T.AsyncLoop.Run(this._mesh.subMeshes.length,function(r){t.initWithMesh(r.index,function(){t.runDecimation(o,r.index,function(){r.executeNext()})},o.optimizeMesh)},function(){setTimeout(function(){e(t._reconstructedMesh)},0)})},e.prototype.runDecimation=function(e,t,i){var E=this,r=~~(this.triangles.length*e.quality),n=0,o=this.triangles.length,a=function(e,t){setTimeout(function(){0==e%5&&E.updateMesh(0===e);for(var i=0;i<E.triangles.length;++i)E.triangles[i].isDirty=!1;var s=1e-9*x(e+3,E.aggressiveness),a=function(e){var t=~~((E.triangles.length/2+e)%E.triangles.length),i=E.triangles[t];if(i&&!(i.error[3]>s||i.deleted||i.isDirty))for(var r=0;3>r;++r)if(i.error[r]<s){var o=[],a=[],l=i.vertices[r],c=i.vertices[(r+1)%3];if(l.isBorder||c.isBorder)continue;var u=T.Vector3.Zero(),f=T.Vector3.Zero(),d=T.Vector2.Zero(),p=new T.Color4(0,0,0,1);E.calculateError(l,c,u,f,d,p);var _=[];if(E.isFlipped(l,c,u,o,i.borderFactor,_))continue;if(E.isFlipped(c,l,u,a,i.borderFactor,_))continue;if(0>o.indexOf(!0)||0>a.indexOf(!0))continue;var m=[];if(_.forEach(function(t){-1===m.indexOf(t)&&(t.deletePending=!0,m.push(t))}),0!=m.length%2)continue;l.q=c.q.add(l.q),l.updatePosition(u);var g=E.references.length;n=E.updateTriangles(l,l,o,n),n=E.updateTriangles(l,c,a,n);var h=E.references.length-g;if(!(h<=l.triangleCount))l.triangleStart=g;else if(h)for(var y=0;y<h;y++)E.references[l.triangleStart+y]=E.references[g+y];l.triangleCount=h;break}};T.AsyncLoop.SyncAsyncForLoop(E.triangles.length,E.syncIterations,a,t,function(){return o-n<=r})},0)};T.AsyncLoop.Run(this.decimationIterations,function(t){o-n<=r?t.breakLoop():a(t.index,function(){t.executeNext()})},function(){setTimeout(function(){E.reconstructMesh(t),i()},0)})},e.prototype.initWithMesh=function(e,t,o){var m=this;this.vertices=[],this.triangles=[];var s=this._mesh.getVerticesData(T.VertexBuffer.PositionKind),n=this._mesh.getIndices(),l=this._mesh.subMeshes[e],a=function(r){if(o)for(var e=0;e<m.vertices.length;++e)if(m.vertices[e].position.equals(r))return m.vertices[e];return null},g=[],r=l.verticesCount;T.AsyncLoop.SyncAsyncForLoop(r,this.syncIterations/4>>0,function(e){if(s){var t=e+l.verticesStart,o=T.Vector3.FromArray(s,3*t),r=a(o)||new d(o,m.vertices.length);r.originalOffsets.push(t),r.id===m.vertices.length&&m.vertices.push(r),g.push(r.id)}},function(){T.AsyncLoop.SyncAsyncForLoop(l.indexCount/3,m.syncIterations,function(s){if(n){var e=l.indexStart/3+s,t=3*e,i=n[t+0],r=n[t+1],o=n[t+2],a=m.vertices[g[i-l.verticesStart]],c=m.vertices[g[r-l.verticesStart]],u=m.vertices[g[o-l.verticesStart]],d=new _([a,c,u]);d.originalOffset=t,m.triangles.push(d)}},function(){m.init(t)})})},e.prototype.init=function(e){var a=this;T.AsyncLoop.SyncAsyncForLoop(this.triangles.length,this.syncIterations,function(e){var t=a.triangles[e];t.normal=T.Vector3.Cross(t.vertices[1].position.subtract(t.vertices[0].position),t.vertices[2].position.subtract(t.vertices[0].position)).normalize();for(var r=0;3>r;r++)t.vertices[r].q.addArrayInPlace(o.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-T.Vector3.Dot(t.normal,t.vertices[0].position)))},function(){T.AsyncLoop.SyncAsyncForLoop(a.triangles.length,a.syncIterations,function(o){for(var e=a.triangles[o],t=0;3>t;++t)e.error[t]=a.calculateError(e.vertices[t],e.vertices[(t+1)%3]);e.error[3]=C(e.error[0],e.error[1],e.error[2])},function(){e()})})},e.prototype.reconstructMesh=function(e){var t=[],r;for(r=0;r<this.vertices.length;++r)this.vertices[r].triangleCount=0;var x,i;for(r=0;r<this.triangles.length;++r)if(!this.triangles[r].deleted){for(x=this.triangles[r],i=0;3>i;++i)x.vertices[i].triangleCount=1;t.push(x)}var o=this._reconstructedMesh.getVerticesData(T.VertexBuffer.PositionKind)||[],n=this._reconstructedMesh.getVerticesData(T.VertexBuffer.NormalKind)||[],a=this._reconstructedMesh.getVerticesData(T.VertexBuffer.UVKind)||[],s=this._reconstructedMesh.getVerticesData(T.VertexBuffer.ColorKind)||[],l=this._mesh.getVerticesData(T.VertexBuffer.NormalKind),c=this._mesh.getVerticesData(T.VertexBuffer.UVKind),u=this._mesh.getVerticesData(T.VertexBuffer.ColorKind),f=0;for(r=0;r<this.vertices.length;++r){var d=this.vertices[r];d.id=f,d.triangleCount&&d.originalOffsets.forEach(function(t){l&&(o.push(d.position.x),o.push(d.position.y),o.push(d.position.z),n.push(l[3*t]),n.push(l[3*t+1]),n.push(l[3*t+2]),c&&c.length?(a.push(c[2*t]),a.push(c[2*t+1])):u&&u.length&&(s.push(u[4*t]),s.push(u[4*t+1]),s.push(u[4*t+2]),s.push(u[4*t+3])),++f)})}var p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var g=this._reconstructedMesh.getIndices(),h=this._mesh.getIndices();for(r=0;r<t.length;++r)x=t[r],[0,1,2].forEach(function(r){var e=h[x.originalOffset+r],t=x.vertices[r].originalOffsets.indexOf(e);0>t&&(t=0),g.push(x.vertices[r].id+t+_)});this._reconstructedMesh.setIndices(g),this._reconstructedMesh.setVerticesData(T.VertexBuffer.PositionKind,o),this._reconstructedMesh.setVerticesData(T.VertexBuffer.NormalKind,n),0<a.length&&this._reconstructedMesh.setVerticesData(T.VertexBuffer.UVKind,a),0<s.length&&this._reconstructedMesh.setVerticesData(T.VertexBuffer.ColorKind,s);var y=this._mesh.subMeshes[e];0<e&&(this._reconstructedMesh.subMeshes=[],m.forEach(function(e){T.SubMesh.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())}),T.SubMesh.AddToMesh(y.materialIndex,_,f,p,3*t.length,this._reconstructedMesh))},e.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new T.Mesh(this._mesh.name+'Decimated',this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},e.prototype.isFlipped=function(e,t,i,r,n,o){for(var s=0,a;s<e.triangleCount;++s)if(a=this.triangles[this.references[e.triangleStart+s].triangleId],!a.deleted){var l=this.references[e.triangleStart+s].vertexId,_=a.vertices[(l+1)%3],c=a.vertices[(l+2)%3];if(_!==t&&c!==t){var u=_.position.subtract(i);u=u.normalize();var f=c.position.subtract(i);if(f=f.normalize(),.999<A(T.Vector3.Dot(u,f)))return!0;var d=T.Vector3.Cross(u,f).normalize();if(r[s]=!1,.2>T.Vector3.Dot(d,a.normal))return!0}else r[s]=!0,o.push(a)}return!1},e.prototype.updateTriangles=function(l,e,t,i){for(var r=i,n=0;n<e.triangleCount;++n){var o=this.references[e.triangleStart+n],s=this.triangles[o.triangleId];s.deleted||(t[n]&&s.deletePending?(s.deleted=!0,r++):(s.vertices[o.vertexId]=l,s.isDirty=!0,s.error[0]=this.calculateError(s.vertices[0],s.vertices[1])+s.borderFactor/2,s.error[1]=this.calculateError(s.vertices[1],s.vertices[2])+s.borderFactor/2,s.error[2]=this.calculateError(s.vertices[2],s.vertices[0])+s.borderFactor/2,s.error[3]=C(s.error[0],s.error[1],s.error[2]),this.references.push(o)))}return r},e.prototype.identifyBorder=function(){for(var d=0;d<this.vertices.length;++d){var e=[],i=[],r=this.vertices[d],n;for(n=0;n<r.triangleCount;++n)for(var t=this.triangles[this.references[r.triangleStart+n].triangleId],o=0;3>o;o++){for(var s=0,a=t.vertices[o];s<e.length&&i[s]!==a.id;)++s;s===e.length?(e.push(1),i.push(a.id)):e[s]++}for(n=0;n<e.length;++n)this.vertices[i[n]].isBorder=!(1!==e[n])}},e.prototype.updateMesh=function(a){void 0===a&&(a=!1);var d;if(!a){var t=[];for(d=0;d<this.triangles.length;++d)this.triangles[d].deleted||t.push(this.triangles[d]);this.triangles=t}for(d=0;d<this.vertices.length;++d)this.vertices[d].triangleCount=0,this.vertices[d].triangleStart=0;var i,r,n;for(d=0;d<this.triangles.length;++d)for(i=this.triangles[d],r=0;3>r;++r)n=i.vertices[r],n.triangleCount++;var o=0;for(d=0;d<this.vertices.length;++d)this.vertices[d].triangleStart=o,o+=this.vertices[d].triangleCount,this.vertices[d].triangleCount=0;var c=Array(3*this.triangles.length);for(d=0;d<this.triangles.length;++d)for(i=this.triangles[d],r=0;3>r;++r)n=i.vertices[r],c[n.triangleStart+n.triangleCount]=new s(r,d),n.triangleCount++;this.references=c,a&&this.identifyBorder()},e.prototype.vertexError=function(o,e){var t=e.x,i=e.y,r=e.z;return o.data[0]*t*t+2*o.data[1]*t*i+2*o.data[2]*t*r+2*o.data[3]*t+o.data[4]*i*i+2*o.data[5]*i*r+2*o.data[6]*i+o.data[7]*r*r+2*o.data[8]*r+o.data[9]},e.prototype.calculateError=function(e,t,o){var r=e.q.add(t.q),i=e.isBorder&&t.isBorder,a=0,n=r.det(0,1,2,1,4,5,2,5,7);if(0===n||i){var s=e.position.add(t.position).divide(new T.Vector3(2,2,2)),l=this.vertexError(r,e.position),c=this.vertexError(r,t.position),d=this.vertexError(r,s);a=C(l,c,d),a===l?o&&o.copyFrom(e.position):a===c?o&&o.copyFrom(t.position):o&&o.copyFrom(s)}else o||(o=T.Vector3.Zero()),o.x=-1/n*r.det(1,2,3,4,5,6,5,7,8),o.y=1/n*r.det(0,2,3,1,5,6,2,7,8),o.z=-1/n*r.det(0,1,3,1,4,6,2,5,8),a=this.vertexError(r,o);return a},e}();T.QuadraticErrorSimplification=r}(e||(e={}));var e;!function(r){var e=function(){function t(r,o){this.distance=r,this.mesh=o}return t}();r.MeshLODLevel=e}(e||(e={}));var e;!function(p){var e=function(){function t(t){void 0===t&&(t=0),this.priority=t}return t.prototype.getDescription=function(){return''},t.prototype.apply=function(){return!0},t}();p.SceneOptimization=e;var _=function(o){function e(e,a,i){void 0===e&&(e=0),void 0===a&&(a=1024),void 0===i&&(i=.5);var r=o.call(this,e)||this;return r.priority=e,r.maximumSize=a,r.step=i,r}return h(e,o),e.prototype.getDescription=function(){return'Reducing render target texture size to '+this.maximumSize},e.prototype.apply=function(t){for(var e=!0,i=0,r;i<t.textures.length;i++)if(r=t.textures[i],r.canRescale&&!r.getContext){var a=r.getSize();W(a.width,a.height)>this.maximumSize&&(r.scale(this.step),e=!1)}return e},e}(e);p.TextureOptimization=_;var i=function(o){function e(e,a,i){void 0===e&&(e=0),void 0===a&&(a=2),void 0===i&&(i=.25);var r=o.call(this,e)||this;return r.priority=e,r.maximumScale=a,r.step=i,r._currentScale=-1,r._directionOffset=1,r}return h(e,o),e.prototype.getDescription=function(){return'Setting hardware scaling level to '+this._currentScale},e.prototype.apply=function(t){return-1===this._currentScale&&(this._currentScale=t.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,t.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale},e}(e);p.HardwareScalingOptimization=i;var m=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return'Turning shadows on/off'},e.prototype.apply=function(r,e){return r.shadowsEnabled=e.isInImprovementMode,!0},e}(e);p.ShadowsOptimization=m;var n=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return'Turning post-processes on/off'},e.prototype.apply=function(r,e){return r.postProcessesEnabled=e.isInImprovementMode,!0},e}(e);p.PostProcessesOptimization=n;var s=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return'Turning lens flares on/off'},e.prototype.apply=function(r,e){return r.lensFlaresEnabled=e.isInImprovementMode,!0},e}(e);p.LensFlaresOptimization=s;var o=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return this.onGetDescription?this.onGetDescription():'Running user defined callback'},e.prototype.apply=function(r,e){return!this.onApply||this.onApply(r,e)},e}(e);p.CustomOptimization=o;var a=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return'Turning particles on/off'},e.prototype.apply=function(r,e){return r.particlesEnabled=e.isInImprovementMode,!0},e}(e);p.ParticlesOptimization=a;var r=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return h(e,r),e.prototype.getDescription=function(){return'Turning render targets off'},e.prototype.apply=function(r,e){return r.renderTargetsEnabled=e.isInImprovementMode,!0},e}(e);p.RenderTargetsOptimization=r;var c=function(e){function d(){var t=null!==e&&e.apply(this,arguments)||this;return t._canBeMerged=function(e){if(!(e instanceof p.Mesh))return!1;var t=e;return t.isVisible&&t.isEnabled()&&!(0<t.instances.length)&&!t.skeleton&&!t.hasLODLevels&&!t.parent},t}return h(d,e),Object.defineProperty(d,'UpdateSelectionTree',{get:function(){return d._UpdateSelectionTree},set:function(t){d._UpdateSelectionTree=t},enumerable:!0,configurable:!0}),d.prototype.getDescription=function(){return'Merging similar meshes together'},d.prototype.apply=function(e,t,r){for(var i=e.meshes.slice(0),o=i.length,n=0;n<o;n++){var a=[],s=i[n];if(this._canBeMerged(s)){a.push(s);for(var l=n+1,c;l<o;l++)c=i[l],this._canBeMerged(c)&&c.material===s.material&&c.checkCollisions===s.checkCollisions&&(a.push(c),o--,i.splice(l,1),l--);2>a.length||p.Mesh.MergeMeshes(a,void 0,!0)}}return void 0==r?d.UpdateSelectionTree&&e.createOrUpdateSelectionOctree():r&&e.createOrUpdateSelectionOctree(),!0},d._UpdateSelectionTree=!1,d}(e);p.MergeMeshesOptimization=c;var u=function(){function d(r,o){void 0===r&&(r=60),void 0===o&&(o=2e3),this.targetFrameRate=r,this.trackerDuration=o,this.optimizations=[]}return d.prototype.addOptimization=function(t){return this.optimizations.push(t),this},d.prototype.addCustomOptimization=function(a,e,t){void 0===t&&(t=0);var i=new o(t);return i.onApply=a,i.onGetDescription=e,this.optimizations.push(i),this},d.LowDegradationAllowed=function(e){var t=new d(e),r=0;return t.addOptimization(new c(r)),t.addOptimization(new m(r)),t.addOptimization(new s(r)),r++,t.addOptimization(new n(r)),t.addOptimization(new a(r)),r++,t.addOptimization(new _(r,1024)),t},d.ModerateDegradationAllowed=function(e){var t=new d(e),o=0;return t.addOptimization(new c(o)),t.addOptimization(new m(o)),t.addOptimization(new s(o)),o++,t.addOptimization(new n(o)),t.addOptimization(new a(o)),o++,t.addOptimization(new _(o,512)),o++,t.addOptimization(new r(o)),o++,t.addOptimization(new i(o,2)),t},d.HighDegradationAllowed=function(e){var t=new d(e),o=0;return t.addOptimization(new c(o)),t.addOptimization(new m(o)),t.addOptimization(new s(o)),o++,t.addOptimization(new n(o)),t.addOptimization(new a(o)),o++,t.addOptimization(new _(o,256)),o++,t.addOptimization(new r(o)),o++,t.addOptimization(new i(o,4)),t},d}();p.SceneOptimizerOptions=u;var t=function(){function a(e,d,i,r){void 0===i&&(i=!0),void 0===r&&(r=!1);var n=this;if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new p.Observable,this.onNewOptimizationAppliedObservable=new p.Observable,this.onFailureObservable=new p.Observable,this._options=d||new u,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i)for(var o=0,s=0,a=this._options.optimizations,l;s<a.length;s++)l=a[s],l.priority=o++;this._improvementMode=r,this._scene=e||p.Engine.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(function(){n._sceneDisposeObserver=null,n.dispose()})}return Object.defineProperty(a.prototype,'isInImprovementMode',{get:function(){return this._improvementMode},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'currentPriorityLevel',{get:function(){return this._currentPriorityLevel},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'currentFrameRate',{get:function(){return this._currentFrameRate},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'targetFrameRate',{get:function(){return this._targetFrameRate},set:function(t){this._targetFrameRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'trackerDuration',{get:function(){return this._trackerDuration},set:function(t){this._trackerDuration=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'optimizations',{get:function(){return this._options.optimizations},enumerable:!0,configurable:!0}),a.prototype.stop=function(){this._isRunning=!1},a.prototype.reset=function(){this._currentPriorityLevel=0},a.prototype.start=function(){var t=this;this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(function(){setTimeout(function(){t._checkCurrentState()},t._trackerDuration)}))},a.prototype._checkCurrentState=function(){var a=this;if(this._isRunning){var e=this._scene,t=this._options;if(this._currentFrameRate=O(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate)return this._isRunning=!1,void this.onSuccessObservable.notifyObservers(this);for(var i=!0,r=!0,n=0,o;n<t.optimizations.length;n++)o=t.optimizations[n],o.priority===this._currentPriorityLevel&&(r=!1,i=i&&o.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(o));if(r)return this._isRunning=!1,void this.onFailureObservable.notifyObservers(this);i&&this._currentPriorityLevel++,e.executeWhenReady(function(){setTimeout(function(){a._checkCurrentState()},a._trackerDuration)})}},a.prototype.dispose=function(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)},a.OptimizeAsync=function(t,e,i,r){var n=new a(t,e||u.ModerateDegradationAllowed(),!1);return i&&n.onSuccessObservable.add(function(){i()}),r&&n.onFailureObservable.add(function(){r()}),n.start(),n},a}();p.SceneOptimizer=t}(e||(e={}));var e;!function(d){var e=function(){function e(t){this.zOffset=1,this._scene=t}return e.prototype.render=function(e,t,i){var r=this;void 0===i&&(i=!1);var n=this._scene,o=this._scene.getEngine(),s=o.getCaps().instancedArrays&&null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id];if(this.isReady(e,s)){var a=e.getRenderingMesh(),l=e.getMaterial();if(l&&n.activeCamera){if(o.enableEffect(this._effect),l.useLogarithmicDepth&&this._effect.setFloat('logarithmicDepthConstant',2/(m(n.activeCamera.maxZ+1)/_)),this._effect.setFloat('offset',i?0:a.outlineWidth),this._effect.setColor4('color',i?a.overlayColor:a.outlineColor,i?a.overlayAlpha:l.alpha),this._effect.setMatrix('viewProjection',n.getTransformMatrix()),a.useBones&&a.computeBonesUsingShaders&&a.skeleton&&this._effect.setMatrices('mBones',a.skeleton.getTransformMatrices(a)),a._bind(e,this._effect,d.Material.TriangleFillMode),l&&l.needAlphaTesting()){var p=l.getAlphaTestTexture();p&&(this._effect.setTexture('diffuseSampler',p),this._effect.setMatrix('diffuseMatrix',p.getTextureMatrix()))}o.setZOffset(-this.zOffset),a._processRendering(e,this._effect,d.Material.TriangleFillMode,t,s,function(o,e){r._effect.setMatrix('world',e)}),o.setZOffset(0)}}},e.prototype.isReady=function(e,t){var i=[],r=[d.VertexBuffer.PositionKind,d.VertexBuffer.NormalKind],n=e.getMesh(),o=e.getMaterial();o&&(o.needAlphaTesting()&&(i.push('#define ALPHATEST'),n.isVerticesDataPresent(d.VertexBuffer.UVKind)&&(r.push(d.VertexBuffer.UVKind),i.push('#define UV1')),n.isVerticesDataPresent(d.VertexBuffer.UV2Kind)&&(r.push(d.VertexBuffer.UV2Kind),i.push('#define UV2'))),o.useLogarithmicDepth&&i.push('#define LOGARITHMICDEPTH')),n.useBones&&n.computeBonesUsingShaders?(r.push(d.VertexBuffer.MatricesIndicesKind),r.push(d.VertexBuffer.MatricesWeightsKind),4<n.numBoneInfluencers&&(r.push(d.VertexBuffer.MatricesIndicesExtraKind),r.push(d.VertexBuffer.MatricesWeightsExtraKind)),i.push('#define NUM_BONE_INFLUENCERS '+n.numBoneInfluencers),i.push('#define BonesPerMesh '+(n.skeleton?n.skeleton.bones.length+1:0))):i.push('#define NUM_BONE_INFLUENCERS 0'),t&&(i.push('#define INSTANCES'),r.push('world0'),r.push('world1'),r.push('world2'),r.push('world3'));var s=i.join('\n');return this._cachedDefines!==s&&(this._cachedDefines=s,this._effect=this._scene.getEngine().createEffect('outline',r,['world','mBones','viewProjection','diffuseMatrix','offset','color','logarithmicDepthConstant'],['diffuseSampler'],s)),this._effect.isReady()},e}();d.OutlineRenderer=e}(e||(e={}));var e;!function(T){var e=function(){return function(){this.edges=[],this.edgesConnectedCount=0}}(),t=function(){function t(r,e,t){void 0===e&&(e=.95),void 0===t&&(t=!1),this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=[],this._linesNormals=[],this._linesIndices=[],this._buffers={},this._checkVerticesInsteadOfIndices=!1,this._source=r,this._checkVerticesInsteadOfIndices=t,this._epsilon=e,this._prepareRessources(),this._generateEdgesLines()}return t.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=new T.ShaderMaterial('lineShader',this._source.getScene(),'line',{attributes:['position','normal'],uniforms:['worldViewProjection','color','width','aspectRatio']}),this._lineShader.disableDepthWrite=!0,this._lineShader.backFaceCulling=!1)},t.prototype._rebuild=function(){var e=this._buffers[T.VertexBuffer.PositionKind];e&&e._rebuild(),(e=this._buffers[T.VertexBuffer.NormalKind])&&e._rebuild();var t=this._source.getScene(),o=t.getEngine();this._ib=o.createIndexBuffer(this._linesIndices)},t.prototype.dispose=function(){var e=this._buffers[T.VertexBuffer.PositionKind];e&&(e.dispose(),this._buffers[T.VertexBuffer.PositionKind]=null),e=this._buffers[T.VertexBuffer.NormalKind],e&&(e.dispose(),this._buffers[T.VertexBuffer.NormalKind]=null),this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose()},t.prototype._processEdgeForAdjacencies=function(o,e,t,i,r){return o===t&&e===i||o===i&&e===t?0:o===i&&e===r||o===r&&e===i?1:o===r&&e===t||o===t&&e===r?2:-1},t.prototype._processEdgeForAdjacenciesWithVertices=function(o,e,t,i,r){return o.equalsWithEpsilon(t)&&e.equalsWithEpsilon(i)||o.equalsWithEpsilon(i)&&e.equalsWithEpsilon(t)?0:o.equalsWithEpsilon(i)&&e.equalsWithEpsilon(r)||o.equalsWithEpsilon(r)&&e.equalsWithEpsilon(i)?1:o.equalsWithEpsilon(r)&&e.equalsWithEpsilon(t)||o.equalsWithEpsilon(t)&&e.equalsWithEpsilon(r)?2:-1},t.prototype._checkEdge=function(e,t,i,r,n){var o;if(o=void 0===t||T.Vector3.Dot(i[e],i[t])<this._epsilon,o){var s=this._linesPositions.length/3;r.subtract(n).normalize(),this._linesPositions.push(r.x),this._linesPositions.push(r.y),this._linesPositions.push(r.z),this._linesPositions.push(r.x),this._linesPositions.push(r.y),this._linesPositions.push(r.z),this._linesPositions.push(n.x),this._linesPositions.push(n.y),this._linesPositions.push(n.z),this._linesPositions.push(n.x),this._linesPositions.push(n.y),this._linesPositions.push(n.z),this._linesNormals.push(n.x),this._linesNormals.push(n.y),this._linesNormals.push(n.z),this._linesNormals.push(-1),this._linesNormals.push(n.x),this._linesNormals.push(n.y),this._linesNormals.push(n.z),this._linesNormals.push(1),this._linesNormals.push(r.x),this._linesNormals.push(r.y),this._linesNormals.push(r.z),this._linesNormals.push(-1),this._linesNormals.push(r.x),this._linesNormals.push(r.y),this._linesNormals.push(r.z),this._linesNormals.push(1),this._linesIndices.push(s),this._linesIndices.push(s+1),this._linesIndices.push(s+2),this._linesIndices.push(s),this._linesIndices.push(s+2),this._linesIndices.push(s+3)}},t.prototype._generateEdgesLines=function(){var t=this._source.getVerticesData(T.VertexBuffer.PositionKind),i=this._source.getIndices();if(i&&t){var r=[],s=[],a,n;for(a=0;a<i.length;a+=3){n=new e;var o=i[a],l=i[a+1],h=i[a+2];n.p0=new T.Vector3(t[3*o],t[3*o+1],t[3*o+2]),n.p1=new T.Vector3(t[3*l],t[3*l+1],t[3*l+2]),n.p2=new T.Vector3(t[3*h],t[3*h+1],t[3*h+2]);var c=T.Vector3.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));c.normalize(),s.push(c),r.push(n)}for(a=0;a<r.length;a++){n=r[a];for(var u=a+1,f;u<r.length&&(f=r[u],3!==n.edgesConnectedCount);u++)if(3!==f.edgesConnectedCount)for(var d=i[3*u],p=i[3*u+1],_=i[3*u+2],m=0,g;3>m&&(g=0,!(void 0===n.edges[m]&&(0===m?g=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(i[3*a],i[3*a+1],d,p,_):1===m?g=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(i[3*a+1],i[3*a+2],d,p,_):2===m?g=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(i[3*a+2],i[3*a],d,p,_):void 0,-1!==g&&(n.edges[m]=u,f.edges[g]=a,n.edgesConnectedCount++,f.edgesConnectedCount++,3===n.edgesConnectedCount))));m++);}for(a=0;a<r.length;a++){var x=r[a];this._checkEdge(a,x.edges[0],s,x.p0,x.p1),this._checkEdge(a,x.edges[1],s,x.p1,x.p2),this._checkEdge(a,x.edges[2],s,x.p2,x.p0)}var y=this._source.getScene().getEngine();this._buffers[T.VertexBuffer.PositionKind]=new T.VertexBuffer(y,this._linesPositions,T.VertexBuffer.PositionKind,!1),this._buffers[T.VertexBuffer.NormalKind]=new T.VertexBuffer(y,this._linesNormals,T.VertexBuffer.NormalKind,!1,!1,4),this._ib=y.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},t.prototype.render=function(){var e=this._source.getScene();if(this._lineShader.isReady()&&e.activeCamera){var t=e.getEngine();this._lineShader._preBind(),t.bindBuffers(this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4('color',this._source.edgesColor),e.activeCamera.mode===T.Camera.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat('width',this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat('width',this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat('aspectRatio',t.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),t.drawElementsType(T.Material.TriangleFillMode,0,this._indicesCount),this._lineShader.unbind(),t.setDepthWrite(!0)}},t}();T.EdgesRenderer=t}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(p){var e=function(){function e(e,r){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new p.Color4},this.neutralColor=new p.Color4,this.isEnabled=!0,this.onDisposeObservable=new p.Observable,this.onBeforeRenderMainTextureObservable=new p.Observable,this.onBeforeComposeObservable=new p.Observable,this.onAfterComposeObservable=new p.Observable,this.onSizeChangedObservable=new p.Observable,this.name=e,this._scene=r||p.Engine.LastCreatedScene,this._engine=r.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._generateIndexBuffer(),this._genrateVertexBuffer()}return Object.defineProperty(e.prototype,'camera',{get:function(){return this._effectLayerOptions.camera},enumerable:!0,configurable:!0}),e.prototype._init=function(e){this._effectLayerOptions=b({mainTextureRatio:.5,alphaBlendingMode:p.Engine.ALPHA_COMBINE,camera:null},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mergeEffect=this._createMergeEffect()},e.prototype._generateIndexBuffer=function(){var t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._engine.createIndexBuffer(t)},e.prototype._genrateVertexBuffer=function(){var e=new p.VertexBuffer(this._engine,[1,1,-1,1,-1,-1,1,-1],p.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[p.VertexBuffer.PositionKind]=e},e.prototype._setMainTextureSize=function(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?p.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?p.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=ee(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=ee(this._mainTextureDesiredSize.height)},e.prototype._createMainTexture=function(){var a=this;this._mainTexture=new p.RenderTargetTexture('HighlightLayerMainRTT',{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,p.Engine.TEXTURETYPE_UNSIGNED_INT),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=p.Texture.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=p.Texture.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(p.Texture.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.customRenderFunction=function(t,e,i,r){a.onBeforeRenderMainTextureObservable.notifyObservers(a);var n=a._scene.getEngine(),s;if(r.length){for(n.setColorWrite(!1),s=0;s<r.length;s++)a._renderSubMesh(r.data[s]);n.setColorWrite(!0)}for(s=0;s<t.length;s++)a._renderSubMesh(t.data[s]);for(s=0;s<e.length;s++)a._renderSubMesh(e.data[s]);for(s=0;s<i.length;s++)a._renderSubMesh(i.data[s])},this._mainTexture.onClearObservable.add(function(t){t.clear(a.neutralColor,!0,!0,!0)})},e.prototype._isReady=function(e,t,i){var r=e.getMaterial();if(!r)return!1;if(!r.isReady(e.getMesh(),t))return!1;var _=[],o=[p.VertexBuffer.PositionKind],s=e.getMesh(),a=!1,l=!1;if(r&&r.needAlphaTesting()){var m=r.getAlphaTestTexture();m&&(_.push('#define ALPHATEST'),s.isVerticesDataPresent(p.VertexBuffer.UV2Kind)&&1===m.coordinatesIndex?(_.push('#define DIFFUSEUV2'),l=!0):s.isVerticesDataPresent(p.VertexBuffer.UVKind)&&(_.push('#define DIFFUSEUV1'),a=!0))}i&&(_.push('#define EMISSIVE'),s.isVerticesDataPresent(p.VertexBuffer.UV2Kind)&&1===i.coordinatesIndex?(_.push('#define EMISSIVEUV2'),l=!0):s.isVerticesDataPresent(p.VertexBuffer.UVKind)&&(_.push('#define EMISSIVEUV1'),a=!0)),a&&(o.push(p.VertexBuffer.UVKind),_.push('#define UV1')),l&&(o.push(p.VertexBuffer.UV2Kind),_.push('#define UV2')),s.useBones&&s.computeBonesUsingShaders?(o.push(p.VertexBuffer.MatricesIndicesKind),o.push(p.VertexBuffer.MatricesWeightsKind),4<s.numBoneInfluencers&&(o.push(p.VertexBuffer.MatricesIndicesExtraKind),o.push(p.VertexBuffer.MatricesWeightsExtraKind)),_.push('#define NUM_BONE_INFLUENCERS '+s.numBoneInfluencers),_.push('#define BonesPerMesh '+(s.skeleton?s.skeleton.bones.length+1:0))):_.push('#define NUM_BONE_INFLUENCERS 0');var c=s.morphTargetManager,u=0;c&&0<c.numInfluencers&&(_.push('#define MORPHTARGETS'),u=c.numInfluencers,_.push('#define NUM_MORPH_INFLUENCERS '+u),p.MaterialHelper.PrepareAttributesForMorphTargets(o,s,{NUM_MORPH_INFLUENCERS:u})),t&&(_.push('#define INSTANCES'),o.push('world0'),o.push('world1'),o.push('world2'),o.push('world3'));var g=_.join('\n');return this._cachedDefines!==g&&(this._cachedDefines=g,this._effectLayerMapGenerationEffect=this._scene.getEngine().createEffect('glowMapGeneration',o,['world','mBones','viewProjection','diffuseMatrix','color','emissiveMatrix','morphTargetInfluences'],['diffuseSampler','emissiveSampler'],g,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u})),this._effectLayerMapGenerationEffect.isReady()},e.prototype.render=function(){var o=this._mergeEffect;if(o.isReady()){for(var e=0;e<this._postProcesses.length;e++)if(!this._postProcesses[e].isReady())return;var t=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this),t.enableEffect(o),t.setState(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,o);var i=t.getAlphaMode();t.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(o),t.setAlphaMode(i),this.onAfterComposeObservable.notifyObservers(this);var r=this._mainTexture.getSize();this._setMainTextureSize(),r.width===this._mainTextureDesiredSize.width&&r.height===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}},e.prototype.hasMesh=function(){return!0},e.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},e.prototype._shouldRenderMesh=function(){return!0},e.prototype._shouldRenderEmissiveTextureForMesh=function(){return!0},e.prototype._renderSubMesh=function(e){var d=this;if(this.shouldRender()){var t=e.getMaterial(),r=e.getRenderingMesh(),i=this._scene,o=i.getEngine();if(t&&!t.needAlphaBlendingForMesh(r)){o.setState(t.backFaceCulling);var n=r._getInstancesRenderList(e._id);if(!n.mustReturn&&this._shouldRenderMesh(r)){var a=o.getCaps().instancedArrays&&null!==n.visibleInstances[e._id]&&void 0!==n.visibleInstances[e._id];if(this._setEmissiveTextureAndColor(r,e,t),this._isReady(e,a,this._emissiveTextureAndColor.texture)){if(o.enableEffect(this._effectLayerMapGenerationEffect),r._bind(e,this._effectLayerMapGenerationEffect,p.Material.TriangleFillMode),this._effectLayerMapGenerationEffect.setMatrix('viewProjection',i.getTransformMatrix()),this._effectLayerMapGenerationEffect.setFloat4('color',this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a),t&&t.needAlphaTesting()){var s=t.getAlphaTestTexture();if(s){this._effectLayerMapGenerationEffect.setTexture('diffuseSampler',s);var l=s.getTextureMatrix();l&&this._effectLayerMapGenerationEffect.setMatrix('diffuseMatrix',l)}}this._emissiveTextureAndColor.texture&&(this._effectLayerMapGenerationEffect.setTexture('emissiveSampler',this._emissiveTextureAndColor.texture),this._effectLayerMapGenerationEffect.setMatrix('emissiveMatrix',this._emissiveTextureAndColor.texture.getTextureMatrix())),r.useBones&&r.computeBonesUsingShaders&&r.skeleton&&this._effectLayerMapGenerationEffect.setMatrices('mBones',r.skeleton.getTransformMatrices(r)),p.MaterialHelper.BindMorphTargetParameters(r,this._effectLayerMapGenerationEffect),r._processRendering(e,this._effectLayerMapGenerationEffect,p.Material.TriangleFillMode,n,a,function(r,e){return d._effectLayerMapGenerationEffect.setMatrix('world',e)})}else this._mainTexture.resetRefreshCounter()}}}},e.prototype._rebuild=function(){var e=this._vertexBuffers[p.VertexBuffer.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()},e.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var t=0;t<this._postProcesses.length;t++)this._postProcesses[t]&&this._postProcesses[t].dispose();this._postProcesses=[];for(var t=0;t<this._textures.length;t++)this._textures[t]&&this._textures[t].dispose();this._textures=[]},e.prototype.dispose=function(){var e=this._vertexBuffers[p.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[p.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._disposeTextureAndPostProcesses();var t=this._scene.effectLayers.indexOf(this,0);-1<t&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()},e.prototype.getClassName=function(){return'EffectLayer'},e.Parse=function(e,t,o){return p.Tools.Instantiate(e.customType).Parse(e,t,o)},g([p.serialize()],e.prototype,'name',void 0),g([p.serializeAsColor4()],e.prototype,'neutralColor',void 0),g([p.serialize()],e.prototype,'isEnabled',void 0),g([p.serializeAsCameraReference()],e.prototype,'camera',null),e}();p.EffectLayer=e}(e||(e={}));var e;!function(d){var e=function(e){function t(t,p,r,n,o,s,a,l){void 0===s&&(s=d.Texture.BILINEAR_SAMPLINGMODE);var u=e.call(this,t,'glowBlurPostProcess',['screenSize','direction','blurWidth'],null,n,o,s,a,l)||this;return u.direction=p,u.kernel=r,u.onApplyObservable.add(function(t){t.setFloat2('screenSize',u.width,u.height),t.setVector2('direction',u.direction),t.setFloat('blurWidth',u.kernel)}),u}return h(t,e),t}(d.PostProcess),t=function(l){function s(e,t,r){var o=l.call(this,e,t)||this;return o.name=e,o.innerGlow=!0,o.outerGlow=!0,o.onBeforeBlurObservable=new d.Observable,o.onAfterBlurObservable=new d.Observable,o._instanceGlowingMeshStencilReference=s.GlowingMeshStencilReference++,o._meshes={},o._excludedMeshes={},o.neutralColor=s.NeutralColor,o._engine.isStencilEnable||d.Tools.Warn('Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new BABYLON.Engine(canvas, antialias, { stencil: true }'),o._options=b({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:d.Engine.ALPHA_COMBINE,camera:null},r),o._init({alphaBlendingMode:o._options.alphaBlendingMode,camera:o._options.camera,mainTextureFixedSize:o._options.mainTextureFixedSize,mainTextureRatio:o._options.mainTextureRatio}),o._shouldRender=!1,o}return h(s,l),Object.defineProperty(s.prototype,'blurHorizontalSize',{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(t){this._horizontalBlurPostprocess.kernel=t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,'blurVerticalSize',{get:function(){return this._verticalBlurPostprocess.kernel},set:function(t){this._verticalBlurPostprocess.kernel=t},enumerable:!0,configurable:!0}),s.prototype.getEffectName=function(){return s.EffectName},s.prototype._createMergeEffect=function(){return this._engine.createEffect('glowMapMerge',[d.VertexBuffer.PositionKind],['offset'],['textureSampler'],this._options.isStroke?'#define STROKE \n':void 0)},s.prototype._createTextureAndPostProcesses=function(){var t=this,o=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,i=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;o=this._engine.needPOTTextures?d.Tools.GetExponentOfTwo(o,this._maxSize):o,i=this._engine.needPOTTextures?d.Tools.GetExponentOfTwo(i,this._maxSize):i,this._blurTexture=new d.RenderTargetTexture('HighlightLayerBlurRTT',{width:o,height:i},this._scene,!1,!0,d.Engine.TEXTURETYPE_HALF_FLOAT),this._blurTexture.wrapU=d.Texture.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=d.Texture.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(d.Texture.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===d.Engine.ALPHA_COMBINE?(this._downSamplePostprocess=new d.PassPostProcess('HighlightLayerPPP',this._options.blurTextureSizeRatio,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.onApplyObservable.add(function(r){r.setTexture('textureSampler',t._mainTexture)}),this._horizontalBlurPostprocess=new e('HighlightLayerHBP',new d.Vector2(1,0),this._options.blurHorizontalSize,1,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2('screenSize',o,i)}),this._verticalBlurPostprocess=new e('HighlightLayerVBP',new d.Vector2(0,1),this._options.blurVerticalSize,1,null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2('screenSize',o,i)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new d.BlurPostProcess('HighlightLayerHBP',new d.Vector2(1,0),this._options.blurHorizontalSize/2,{width:o,height:i},null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d.Engine.TEXTURETYPE_HALF_FLOAT),this._horizontalBlurPostprocess.width=o,this._horizontalBlurPostprocess.height=i,this._horizontalBlurPostprocess.onApplyObservable.add(function(r){r.setTexture('textureSampler',t._mainTexture)}),this._verticalBlurPostprocess=new d.BlurPostProcess('HighlightLayerVBP',new d.Vector2(0,1),this._options.blurVerticalSize/2,{width:o,height:i},null,d.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d.Engine.TEXTURETYPE_HALF_FLOAT),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(function(){t.onBeforeBlurObservable.notifyObservers(t);var r=t._blurTexture.getInternalTexture();r&&t._scene.postProcessManager.directRender(t._postProcesses,r,!0),t.onAfterBlurObservable.notifyObservers(t)}),this._postProcesses.map(function(t){t.autoClear=!1})},s.prototype.needStencil=function(){return!0},s.prototype.isReady=function(i,e){var t=i.getMaterial(),a=i.getRenderingMesh();if(!t||!a||!this._meshes)return!1;var d=null,o=this._meshes[a.uniqueId];return o&&o.glowEmissiveOnly&&t&&(d=t.emissiveTexture),l.prototype._isReady.call(this,i,e,d)},s.prototype._internalRender=function(e){e.setTexture('textureSampler',this._blurTexture);var t=this._engine,i=t.getStencilBuffer(),r=t.getStencilFunction(),n=t.getStencilMask(),o=t.getStencilOperationPass(),s=t.getStencilOperationFail(),a=t.getStencilOperationDepthFail(),l=t.getStencilFunctionReference();t.setStencilOperationPass(d.Engine.REPLACE),t.setStencilOperationFail(d.Engine.KEEP),t.setStencilOperationDepthFail(d.Engine.KEEP),t.setStencilMask(0),t.setStencilBuffer(!0),t.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&(e.setFloat('offset',0),t.setStencilFunction(d.Engine.NOTEQUAL),t.drawElementsType(d.Material.TriangleFillMode,0,6)),this.innerGlow&&(e.setFloat('offset',1),t.setStencilFunction(d.Engine.EQUAL),t.drawElementsType(d.Material.TriangleFillMode,0,6)),t.setStencilFunction(r),t.setStencilMask(n),t.setStencilBuffer(i),t.setStencilOperationPass(o),t.setStencilOperationFail(s),t.setStencilOperationDepthFail(a),t.setStencilFunctionReference(l)},s.prototype.shouldRender=function(){return!!l.prototype.shouldRender.call(this)&&!!this._meshes},s.prototype._shouldRenderMesh=function(t){return!this._excludedMeshes||!this._excludedMeshes[t.uniqueId]},s.prototype._setEmissiveTextureAndColor=function(o,e,t){var i=this._meshes[o.uniqueId];i?this._emissiveTextureAndColor.color.set(i.color.r,i.color.g,i.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),i&&i.glowEmissiveOnly&&t?(this._emissiveTextureAndColor.texture=t.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null},s.prototype.addExcludedMesh=function(t){this._excludedMeshes&&(this._excludedMeshes[t.uniqueId]||(this._excludedMeshes[t.uniqueId]={mesh:t,beforeRender:t.onBeforeRenderObservable.add(function(t){t.getEngine().setStencilBuffer(!1)}),afterRender:t.onAfterRenderObservable.add(function(t){t.getEngine().setStencilBuffer(!0)})}))},s.prototype.removeExcludedMesh=function(r){if(this._excludedMeshes){var e=this._excludedMeshes[r.uniqueId];e&&(e.beforeRender&&r.onBeforeRenderObservable.remove(e.beforeRender),e.afterRender&&r.onAfterRenderObservable.remove(e.afterRender)),this._excludedMeshes[r.uniqueId]=null}},s.prototype.hasMesh=function(t){return!!this._meshes&&void 0!==this._meshes[t.uniqueId]&&null!==this._meshes[t.uniqueId]},s.prototype.addMesh=function(o,a,s){var l=this;if(void 0===s&&(s=!1),this._meshes){var r=this._meshes[o.uniqueId];r?r.color=a:this._meshes[o.uniqueId]={mesh:o,color:a,observerHighlight:o.onBeforeRenderObservable.add(function(t){l._excludedMeshes&&l._excludedMeshes[t.uniqueId]?l._defaultStencilReference(t):t.getScene().getEngine().setStencilFunctionReference(l._instanceGlowingMeshStencilReference)}),observerDefault:o.onAfterRenderObservable.add(this._defaultStencilReference),glowEmissiveOnly:s},this._shouldRender=!0}},s.prototype.removeMesh=function(r){if(this._meshes){var e=this._meshes[r.uniqueId];for(var t in e&&(e.observerHighlight&&r.onBeforeRenderObservable.remove(e.observerHighlight),e.observerDefault&&r.onAfterRenderObservable.remove(e.observerDefault),delete this._meshes[r.uniqueId]),this._shouldRender=!1,this._meshes)if(this._meshes[t]){this._shouldRender=!0;break}}},s.prototype._defaultStencilReference=function(t){t.getScene().getEngine().setStencilFunctionReference(s.NormalMeshStencilReference)},s.prototype._disposeMesh=function(t){this.removeMesh(t),this.removeExcludedMesh(t)},s.prototype.dispose=function(){if(this._meshes){for(var r in this._meshes){var e=this._meshes[r];e&&e.mesh&&(e.observerHighlight&&e.mesh.onBeforeRenderObservable.remove(e.observerHighlight),e.observerDefault&&e.mesh.onAfterRenderObservable.remove(e.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(var r in this._excludedMeshes){var e=this._excludedMeshes[r];e&&(e.beforeRender&&e.mesh.onBeforeRenderObservable.remove(e.beforeRender),e.afterRender&&e.mesh.onAfterRenderObservable.remove(e.afterRender))}this._excludedMeshes=null}l.prototype.dispose.call(this)},s.prototype.getClassName=function(){return'HighlightLayer'},s.prototype.serialize=function(){var e=d.SerializationHelper.Serialize(this);if(e.customType='BABYLON.HighlightLayer',e.meshes=[],this._meshes)for(var t in this._meshes){var i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(var r in this._excludedMeshes){var a=this._excludedMeshes[r];a&&e.excludedMeshes.push(a.mesh.id)}return e},s.Parse=function(e,t,r){var i=d.SerializationHelper.Parse(function(){return new s(e.name,t,e.options)},e,t,r),n;for(n=0;n<e.excludedMeshes.length;n++){var o=t.getMeshByID(e.excludedMeshes[n]);o&&i.addExcludedMesh(o)}for(n=0;n<e.meshes.length;n++){var a=e.meshes[n],o=t.getMeshByID(a.meshId);o&&i.addMesh(o,d.Color3.FromArray(a.color),a.glowEmissiveOnly)}return i},s.EffectName='HighlightLayer',s.NeutralColor=new d.Color4(0,0,0,0),s.GlowingMeshStencilReference=2,s.NormalMeshStencilReference=1,g([d.serialize()],s.prototype,'innerGlow',void 0),g([d.serialize()],s.prototype,'outerGlow',void 0),g([d.serialize()],s.prototype,'blurHorizontalSize',null),g([d.serialize()],s.prototype,'blurVerticalSize',null),g([d.serialize('options')],s.prototype,'_options',void 0),s}(d.EffectLayer);d.HighlightLayer=t}(e||(e={}));var e;!function(l){var e=function(s){function e(t,r,i){var o=s.call(this,t,r)||this;return o._intensity=1,o._includedOnlyMeshes=[],o._excludedMeshes=[],o.neutralColor=new l.Color4(0,0,0,1),o._options=b({mainTextureRatio:e.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1},i),o._init({alphaBlendingMode:l.Engine.ALPHA_ADD,camera:o._options.camera,mainTextureFixedSize:o._options.mainTextureFixedSize,mainTextureRatio:o._options.mainTextureRatio}),o}return h(e,s),Object.defineProperty(e.prototype,'blurKernelSize',{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(t){this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'intensity',{get:function(){return this._intensity},set:function(t){this._intensity=t},enumerable:!0,configurable:!0}),e.prototype.getEffectName=function(){return e.EffectName},e.prototype._createMergeEffect=function(){return this._engine.createEffect('glowMapMerge',[l.VertexBuffer.PositionKind],['offset'],['textureSampler','textureSampler2'],'#define EMISSIVE \n')},e.prototype._createTextureAndPostProcesses=function(){var a=this,e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?l.Tools.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?l.Tools.GetExponentOfTwo(t,this._maxSize):t;var d=0;d=this._engine.getCaps().textureHalfFloatRender?l.Engine.TEXTURETYPE_HALF_FLOAT:l.Engine.TEXTURETYPE_UNSIGNED_INT,this._blurTexture1=new l.RenderTargetTexture('GlowLayerBlurRTT',{width:e,height:t},this._scene,!1,!0,d),this._blurTexture1.wrapU=l.Texture.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=l.Texture.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(l.Texture.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;var n=ee(e/2),c=ee(t/2);this._blurTexture2=new l.RenderTargetTexture('GlowLayerBlurRTT2',{width:n,height:c},this._scene,!1,!0,d),this._blurTexture2.wrapU=l.Texture.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=l.Texture.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(l.Texture.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._horizontalBlurPostprocess1=new l.BlurPostProcess('GlowLayerHBP1',new l.Vector2(1,0),this._options.blurKernelSize/2,{width:e,height:t},null,l.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.onApplyObservable.add(function(t){t.setTexture('textureSampler',a._mainTexture)}),this._verticalBlurPostprocess1=new l.BlurPostProcess('GlowLayerVBP1',new l.Vector2(0,1),this._options.blurKernelSize/2,{width:e,height:t},null,l.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d),this._horizontalBlurPostprocess2=new l.BlurPostProcess('GlowLayerHBP2',new l.Vector2(1,0),this._options.blurKernelSize/2,{width:n,height:c},null,l.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d),this._horizontalBlurPostprocess2.width=n,this._horizontalBlurPostprocess2.height=c,this._horizontalBlurPostprocess2.onApplyObservable.add(function(t){t.setTexture('textureSampler',a._blurTexture1)}),this._verticalBlurPostprocess2=new l.BlurPostProcess('GlowLayerVBP2',new l.Vector2(0,1),this._options.blurKernelSize/2,{width:n,height:c},null,l.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,d),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(function(){var t=a._blurTexture1.getInternalTexture();t&&(a._scene.postProcessManager.directRender(a._postProcesses1,t,!0),(t=a._blurTexture2.getInternalTexture())&&a._scene.postProcessManager.directRender(a._postProcesses2,t,!0))}),this._postProcesses.map(function(t){t.autoClear=!1})},e.prototype.isReady=function(t,e){var i=t.getMaterial(),a=t.getRenderingMesh();if(!i||!a)return!1;var l=i.emissiveTexture;return s.prototype._isReady.call(this,t,e,l)},e.prototype.needStencil=function(){return!1},e.prototype._internalRender=function(e){e.setTexture('textureSampler',this._blurTexture1),e.setTexture('textureSampler2',this._blurTexture2),e.setFloat('offset',this._intensity);var t=this._engine,o=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(l.Material.TriangleFillMode,0,6),t.setStencilBuffer(o)},e.prototype._setEmissiveTextureAndColor=function(o,e,t){var i=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(o,e,t):t?(this._emissiveTextureAndColor.texture=t.emissiveTexture,this._emissiveTextureAndColor.texture&&(i=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(o,e,t,this._emissiveTextureAndColor.color):t.emissiveColor?this._emissiveTextureAndColor.color.set(t.emissiveColor.r*i,t.emissiveColor.g*i,t.emissiveColor.b*i,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)},e.prototype._shouldRenderMesh=function(t){return this.hasMesh(t)},e.prototype.addExcludedMesh=function(t){-1===this._excludedMeshes.indexOf(t.uniqueId)&&this._excludedMeshes.push(t.uniqueId)},e.prototype.removeExcludedMesh=function(r){var e=this._excludedMeshes.indexOf(r.uniqueId);-1!==e&&this._excludedMeshes.splice(e,1)},e.prototype.addIncludedOnlyMesh=function(t){-1===this._includedOnlyMeshes.indexOf(t.uniqueId)&&this._includedOnlyMeshes.push(t.uniqueId)},e.prototype.removeIncludedOnlyMesh=function(r){var e=this._includedOnlyMeshes.indexOf(r.uniqueId);-1!==e&&this._includedOnlyMeshes.splice(e,1)},e.prototype.hasMesh=function(t){return this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(t.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(t.uniqueId)},e.prototype._disposeMesh=function(t){this.removeIncludedOnlyMesh(t),this.removeExcludedMesh(t)},e.prototype.getClassName=function(){return'GlowLayer'},e.prototype.serialize=function(){var e=l.SerializationHelper.Serialize(this);e.customType='BABYLON.GlowLayer';var t;if(e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){var o=this._scene.getMeshByUniqueID(this._includedOnlyMeshes[t]);o&&e.includedMeshes.push(o.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){var o=this._scene.getMeshByUniqueID(this._excludedMeshes[t]);o&&e.excludedMeshes.push(o.id)}return e},e.Parse=function(i,t,r){var n=l.SerializationHelper.Parse(function(){return new e(i.name,t,i.options)},i,t,r),s;for(s=0;s<i.excludedMeshes.length;s++){var o=t.getMeshByID(i.excludedMeshes[s]);o&&n.addExcludedMesh(o)}for(s=0;s<i.includedMeshes.length;s++){var o=t.getMeshByID(i.includedMeshes[s]);o&&n.addIncludedOnlyMesh(o)}return n},e.EffectName='GlowLayer',e.DefaultBlurKernelSize=32,e.DefaultTextureRatio=.5,g([l.serialize()],e.prototype,'blurKernelSize',null),g([l.serialize()],e.prototype,'intensity',null),g([l.serialize('options')],e.prototype,'_options',void 0),e}(l.EffectLayer);l.GlowLayer=e}(e||(e={}));var e;!function(d){var o;!function(t){t[t.INIT=0]='INIT',t[t.RUNNING=1]='RUNNING',t[t.DONE=2]='DONE',t[t.ERROR=3]='ERROR'}(o=d.AssetTaskState||(d.AssetTaskState={}));var e=function(){function t(t){this.name=t,this._isCompleted=!1,this._taskState=o.INIT}return Object.defineProperty(t.prototype,'isCompleted',{get:function(){return this._isCompleted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'taskState',{get:function(){return this._taskState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,'errorObject',{get:function(){return this._errorObject},enumerable:!0,configurable:!0}),t.prototype._setErrorObject=function(r,o){this._errorObject||(this._errorObject={message:r,exception:o})},t.prototype.run=function(t,e,i){var r=this;this._taskState=o.RUNNING,this.runTask(t,function(){r.onDoneCallback(e,i)},function(o,e){r.onErrorCallback(i,o,e)})},t.prototype.runTask=function(){throw new Error('runTask is not implemented')},t.prototype.onErrorCallback=function(t,e,a){this._taskState=o.ERROR,this._errorObject={message:e,exception:a},this.onError&&this.onError(this,e,a),t()},t.prototype.onDoneCallback=function(t,r){try{this._taskState=o.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),t()}catch(t){this.onErrorCallback(r,'Task is done, error executing success callback(s)',t)}},t}();d.AbstractAssetTask=e;var t=function(){function t(r,o,t){this.remainingCount=r,this.totalCount=o,this.task=t}return t}();d.AssetsProgressEvent=t;var p=function(a){function e(t,e,s,r){var n=a.call(this,t)||this;return n.name=t,n.meshesNames=e,n.rootUrl=s,n.sceneFilename=r,n}return h(e,a),e.prototype.runTask=function(e,o,a){var i=this;d.SceneLoader.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,function(a,e,t){i.loadedMeshes=a,i.loadedParticleSystems=e,i.loadedSkeletons=t,o()},null,function(r,e,t){a(e,t)})},e}(e);d.MeshAssetTask=p;var r=function(o){function e(e,a){var i=o.call(this,e)||this;return i.name=e,i.url=a,i}return h(e,o),e.prototype.runTask=function(o,a,n){var t=this;o._loadFile(this.url,function(r){t.text=r,a()},void 0,!1,!1,function(r,e){r&&n(r.status+' '+r.statusText,e)})},e}(e);d.TextFileAssetTask=r;var n=function(o){function e(e,a){var i=o.call(this,e)||this;return i.name=e,i.url=a,i}return h(e,o),e.prototype.runTask=function(o,a,n){var t=this;o._loadFile(this.url,function(r){t.data=r,a()},void 0,!0,!0,function(r,e){r&&n(r.status+' '+r.statusText,e)})},e}(e);d.BinaryFileAssetTask=n;var a=function(o){function e(t,e){var a=o.call(this,t)||this;return a.name=t,a.url=e,a}return h(e,o),e.prototype.runTask=function(e,t,i){var r=this,a=new Image;d.Tools.SetCorsBehavior(this.url,a),a.onload=function(){r.image=a,t()},a.onerror=function(t){i('Error loading image',t)},a.src=this.url},e}(e);d.ImageAssetTask=a;var l=function(e){function t(t,l,r,n,o){void 0===o&&(o=d.Texture.TRILINEAR_SAMPLINGMODE);var s=e.call(this,t)||this;return s.name=t,s.url=l,s.noMipmap=r,s.invertY=n,s.samplingMode=o,s}return h(t,e),t.prototype.runTask=function(e,t,o){this.texture=new d.Texture(this.url,e,this.noMipmap,this.invertY,this.samplingMode,function(){t()},function(r,e){o(r,e)})},t}(e);d.TextureAssetTask=l;var s=function(a){function e(t,e,l,r,n){var o=a.call(this,t)||this;return o.name=t,o.url=e,o.extensions=l,o.noMipmap=r,o.files=n,o}return h(e,a),e.prototype.runTask=function(e,t,o){this.texture=new d.CubeTexture(this.url,e,this.extensions,this.noMipmap,this.files,function(){t()},function(r,e){o(r,e)})},e}(e);d.CubeTextureAssetTask=s;var c=function(c){function e(t,e,d,r,n,o,s){void 0===r&&(r=!1),void 0===n&&(n=!0),void 0===o&&(o=!1),void 0===s&&(s=!1);var a=c.call(this,t)||this;return a.name=t,a.url=e,a.size=d,a.noMipmap=r,a.generateHarmonics=n,a.gammaSpace=o,a.reserved=s,a}return h(e,c),e.prototype.run=function(e,t,o){this.texture=new d.HDRCubeTexture(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,function(){t()},function(r,e){o(r,e)})},e}(e);d.HDRCubeTextureAssetTask=c;var i=function(){function e(e){this._isLoading=!1,this._tasks=[],this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new d.Observable,this.onTaskErrorObservable=new d.Observable,this.onTasksDoneObservable=new d.Observable,this.onProgressObservable=new d.Observable,this.useDefaultLoadingScreen=!0,this._scene=e}return e.prototype.addMeshTask=function(a,e,t,i){var r=new p(a,e,t,i);return this._tasks.push(r),r},e.prototype.addTextFileTask=function(o,e){var t=new r(o,e);return this._tasks.push(t),t},e.prototype.addBinaryFileTask=function(r,e){var t=new n(r,e);return this._tasks.push(t),t},e.prototype.addImageTask=function(r,e){var t=new a(r,e);return this._tasks.push(t),t},e.prototype.addTextureTask=function(e,t,i,r,a){void 0===a&&(a=d.Texture.TRILINEAR_SAMPLINGMODE);var o=new l(e,t,i,r,a);return this._tasks.push(o),o},e.prototype.addCubeTextureTask=function(a,e,t,i,r){var n=new s(a,e,t,i,r);return this._tasks.push(n),n},e.prototype.addHDRCubeTextureTask=function(l,e,t,i,r,n,o){void 0===i&&(i=!1),void 0===r&&(r=!0),void 0===n&&(n=!1),void 0===o&&(o=!1);var s=new c(l,e,t,i,r,n,o);return this._tasks.push(s),s},e.prototype._decreaseWaitingTasksCount=function(r){var i=this;this._waitingTasksCount--;try{r.taskState===o.DONE&&d.Tools.SetImmediate(function(){var t=i._tasks.indexOf(r);-1<t&&i._tasks.splice(t,1)}),this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,r),this.onProgressObservable.notifyObservers(new t(this._waitingTasksCount,this._totalTasksCount,r))}catch(e){d.Tools.Error('Error running progress callbacks.'),console.log(e)}if(0===this._waitingTasksCount){try{this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(e){d.Tools.Error('Error running tasks-done callbacks.'),console.log(e)}this._isLoading=!1,this._scene.getEngine().hideLoadingUI()}},e.prototype._runTask=function(o){var e=this,t=function(t,i){o._setErrorObject(t,i),e.onTaskError&&e.onTaskError(o),e.onTaskErrorObservable.notifyObservers(o),e._decreaseWaitingTasksCount(o)};o.run(this._scene,function(){try{e.onTaskSuccess&&e.onTaskSuccess(o),e.onTaskSuccessObservable.notifyObservers(o),e._decreaseWaitingTasksCount(o)}catch(r){t('Error executing task success callbacks',r)}},t)},e.prototype.reset=function(){return this._isLoading=!1,this._tasks=[],this},e.prototype.load=function(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,0===this._waitingTasksCount)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(var r=0,e;r<this._tasks.length;r++)e=this._tasks[r],this._runTask(e);return this},e}();d.AssetsManager=i}(e||(e={}));var e;!function(A){var e=[],a=function(t,o){if(!e[t.id]&&!t.doNotSerialize){if(t instanceof A.BoxGeometry)o.boxes.push(t.serialize());else if(t instanceof A.SphereGeometry)o.spheres.push(t.serialize());else if(t instanceof A.CylinderGeometry)o.cylinders.push(t.serialize());else if(t instanceof A.TorusGeometry)o.toruses.push(t.serialize());else if(t instanceof A.GroundGeometry)o.grounds.push(t.serialize());else if(t instanceof A.Plane)o.planes.push(t.serialize());else if(t instanceof A.TorusKnotGeometry)o.torusKnots.push(t.serialize());else{if(t instanceof A._PrimitiveGeometry)throw new Error('Unknown primitive type');o.vertexData.push(t.serializeVerticeData())}e[t.id]=!0}},i=function(o,e){var t={},r=o._geometry;return r&&(o.getScene().getGeometryByID(r.id)||a(r,e.geometries)),o.serialize&&o.serialize(t),t},t=function(r,e){if(r.delayLoadState===A.Engine.DELAYLOADSTATE_LOADED||r.delayLoadState===A.Engine.DELAYLOADSTATE_NONE){r.material&&(r.material instanceof A.StandardMaterial?(e.materials=e.materials||[],e.materials.some(function(t){return t.id===r.material.id})||e.materials.push(r.material.serialize())):r.material instanceof A.MultiMaterial&&(e.multiMaterials=e.multiMaterials||[],e.multiMaterials.some(function(t){return t.id===r.material.id})||e.multiMaterials.push(r.material.serialize())));var t=r._geometry;t&&(e.geometries||(e.geometries={},e.geometries.boxes=[],e.geometries.spheres=[],e.geometries.cylinders=[],e.geometries.toruses=[],e.geometries.grounds=[],e.geometries.planes=[],e.geometries.torusKnots=[],e.geometries.vertexData=[]),a(t,e.geometries)),r.skeleton&&(e.skeletons=e.skeletons||[],e.skeletons.push(r.skeleton.serialize())),e.meshes=e.meshes||[],e.meshes.push(i(r,e))}},r=function(){function S(){}return S.ClearCache=function(){e=[]},S.Serialize=function(t){var r={};if(S.ClearCache(),r.useDelayedTextureLoading=t.useDelayedTextureLoading,r.autoClear=t.autoClear,r.clearColor=t.clearColor.asArray(),r.ambientColor=t.ambientColor.asArray(),r.gravity=t.gravity.asArray(),r.collisionsEnabled=t.collisionsEnabled,r.workerCollisions=t.workerCollisions,t.fogMode&&0!==t.fogMode&&(r.fogMode=t.fogMode,r.fogColor=t.fogColor.asArray(),r.fogStart=t.fogStart,r.fogEnd=t.fogEnd,r.fogDensity=t.fogDensity),t.isPhysicsEnabled()){var o=t.getPhysicsEngine();o&&(r.physicsEnabled=!0,r.physicsGravity=o.gravity.asArray(),r.physicsEngine=o.getPhysicsPluginName())}t.metadata&&(r.metadata=t.metadata),r.morphTargetManagers=[];for(var n=0,s=t.meshes;n<s.length;n++){var l=s[n],c=l.morphTargetManager;c&&r.morphTargetManagers.push(c.serialize())}r.lights=[];var u,f;for(u=0;u<t.lights.length;u++)f=t.lights[u],f.doNotSerialize||r.lights.push(f.serialize());for(r.cameras=[],u=0;u<t.cameras.length;u++){var d=t.cameras[u];d.doNotSerialize||r.cameras.push(d.serialize())}t.activeCamera&&(r.activeCameraID=t.activeCamera.id),A.Animation.AppendSerializedAnimations(t,r),r.materials=[],r.multiMaterials=[];var p;for(u=0;u<t.materials.length;u++)p=t.materials[u],p.doNotSerialize||r.materials.push(p.serialize());for(r.multiMaterials=[],u=0;u<t.multiMaterials.length;u++){var _=t.multiMaterials[u];r.multiMaterials.push(_.serialize())}for(t.environmentTexture&&(r.environmentTexture=t.environmentTexture.name),r.skeletons=[],u=0;u<t.skeletons.length;u++){var m=t.skeletons[u];m.doNotSerialize||r.skeletons.push(m.serialize())}for(r.transformNodes=[],u=0;u<t.transformNodes.length;u++)r.transformNodes.push(t.transformNodes[u].serialize());r.geometries={},r.geometries.boxes=[],r.geometries.spheres=[],r.geometries.cylinders=[],r.geometries.toruses=[],r.geometries.grounds=[],r.geometries.planes=[],r.geometries.torusKnots=[],r.geometries.vertexData=[],e=[];var g=t.getGeometries();for(u=0;u<g.length;u++){var h=g[u];h.isReady()&&a(h,r.geometries)}for(r.meshes=[],u=0;u<t.meshes.length;u++){var l=t.meshes[u];if(l instanceof A.Mesh){var y=l;y.doNotSerialize||y.delayLoadState!==A.Engine.DELAYLOADSTATE_LOADED&&y.delayLoadState!==A.Engine.DELAYLOADSTATE_NONE||r.meshes.push(i(y,r))}}for(r.particleSystems=[],u=0;u<t.particleSystems.length;u++)r.particleSystems.push(t.particleSystems[u].serialize());for(r.lensFlareSystems=[],u=0;u<t.lensFlareSystems.length;u++)r.lensFlareSystems.push(t.lensFlareSystems[u].serialize());for(r.shadowGenerators=[],u=0;u<t.lights.length;u++){f=t.lights[u];var b=f.getShadowGenerator();b&&r.shadowGenerators.push(b.serialize())}for(t.actionManager&&(r.actions=t.actionManager.serialize('scene')),r.sounds=[],u=0;u<t.soundTracks.length;u++)for(var x=t.soundTracks[u],T=0;T<x.soundCollection.length;T++)r.sounds.push(x.soundCollection[T].serialize());for(r.effectLayers=[],u=0;u<t.effectLayers.length;u++){var E=t.effectLayers[u];E.serialize&&r.effectLayers.push(E.serialize())}return r},S.SerializeMesh=function(e,o,i){void 0===o&&(o=!1),void 0===i&&(i=!1);var r={};if(S.ClearCache(),e=e instanceof Array?e:[e],o||i)for(var n=0;n<e.length;++n)i&&e[n].getDescendants().forEach(function(t){t instanceof A.Mesh&&0>e.indexOf(t)&&e.push(t)}),o&&e[n].parent&&0>e.indexOf(e[n].parent)&&e.push(e[n].parent);return e.forEach(function(o){t(o,r)}),r},S}();A.SceneSerializer=r}(e||(e={}));var e;!function(a){var e=function(){function e(e,s,i,r){void 0===r&&(r=!0);var n=this;this.name=e,this._viewMatrix=a.Matrix.Identity(),this._target=a.Vector3.Zero(),this._add=a.Vector3.Zero(),this._invertYAxis=!1,this.position=a.Vector3.Zero(),this._scene=i,this._scene.reflectionProbes.push(this),this._renderTargetTexture=new a.RenderTargetTexture(e,s,i,r,!0,a.Engine.TEXTURETYPE_UNSIGNED_INT,!0),this._renderTargetTexture.onBeforeRenderObservable.add(function(e){0===e?n._add.copyFromFloats(1,0,0):1===e?n._add.copyFromFloats(-1,0,0):2===e?n._add.copyFromFloats(0,n._invertYAxis?1:-1,0):3===e?n._add.copyFromFloats(0,n._invertYAxis?-1:1,0):4===e?n._add.copyFromFloats(0,0,1):5===e?n._add.copyFromFloats(0,0,-1):void 0;n._attachedMesh&&n.position.copyFrom(n._attachedMesh.getAbsolutePosition()),n.position.addToRef(n._add,n._target),a.Matrix.LookAtLHToRef(n.position,n._target,a.Vector3.Up(),n._viewMatrix),i.setTransformMatrix(n._viewMatrix,n._projectionMatrix),i._forcedViewPosition=n.position}),this._renderTargetTexture.onAfterUnbindObservable.add(function(){i._forcedViewPosition=null,i.updateTransformMatrix(!0)}),i.activeCamera&&(this._projectionMatrix=a.Matrix.PerspectiveFovLH(V/2,1,i.activeCamera.minZ,i.activeCamera.maxZ))}return Object.defineProperty(e.prototype,'samples',{get:function(){return this._renderTargetTexture.samples},set:function(t){this._renderTargetTexture.samples=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'refreshRate',{get:function(){return this._renderTargetTexture.refreshRate},set:function(t){this._renderTargetTexture.refreshRate=t},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},Object.defineProperty(e.prototype,'cubeTexture',{get:function(){return this._renderTargetTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'renderList',{get:function(){return this._renderTargetTexture.renderList},enumerable:!0,configurable:!0}),e.prototype.attachToMesh=function(t){this._attachedMesh=t},e.prototype.setRenderingAutoClearDepthStencil=function(r,e){this._renderTargetTexture.setRenderingAutoClearDepthStencil(r,e)},e.prototype.dispose=function(){var t=this._scene.reflectionProbes.indexOf(this);-1!==t&&this._scene.reflectionProbes.splice(t,1),this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null)},e}();a.ReflectionProbe=e}(e||(e={}));var e;!function(d){var e=function(){function e(e,c,i,r,n){this.name=e,this.scale=new d.Vector2(1,1),this.offset=new d.Vector2(0,0),this.alphaBlendingMode=d.Engine.ALPHA_COMBINE,this.layerMask=268435455,this._vertexBuffers={},this.onDisposeObservable=new d.Observable,this.onBeforeRenderObservable=new d.Observable,this.onAfterRenderObservable=new d.Observable,this.texture=c?new d.Texture(c,i,!0):null,this.isBackground=void 0===r||r,this.color=void 0===n?new d.Color4(1,1,1,1):n,this._scene=i||d.Engine.LastCreatedScene,this._scene.layers.push(this);var o=this._scene.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1);var a=new d.VertexBuffer(o,s,d.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[d.VertexBuffer.PositionKind]=a,this._createIndexBuffer(),this._effect=o.createEffect('layer',[d.VertexBuffer.PositionKind],['textureMatrix','color','scale','offset'],['textureSampler'],''),this._alphaTestEffect=o.createEffect('layer',[d.VertexBuffer.PositionKind],['textureMatrix','color','scale','offset'],['textureSampler'],'#define ALPHATEST')}return Object.defineProperty(e.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onBeforeRender',{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'onAfterRender',{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype._createIndexBuffer=function(){var r=this._scene.getEngine(),e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=r.createIndexBuffer(e)},e.prototype._rebuild=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&e._rebuild(),this._createIndexBuffer()},e.prototype.render=function(){var e=this.alphaTest?this._alphaTestEffect:this._effect;if(e.isReady()&&this.texture&&this.texture.isReady()){var t=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this),t.enableEffect(e),t.setState(!1),e.setTexture('textureSampler',this.texture),e.setMatrix('textureMatrix',this.texture.getTextureMatrix()),e.setFloat4('color',this.color.r,this.color.g,this.color.b,this.color.a),e.setVector2('offset',this.offset),e.setVector2('scale',this.scale),t.bindBuffers(this._vertexBuffers,this._indexBuffer,e),this.alphaTest?t.drawElementsType(d.Material.TriangleFillMode,0,6):(t.setAlphaMode(this.alphaBlendingMode),t.drawElementsType(d.Material.TriangleFillMode,0,6),t.setAlphaMode(d.Engine.ALPHA_DISABLE)),this.onAfterRenderObservable.notifyObservers(this)}},e.prototype.dispose=function(){var e=this._vertexBuffers[d.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[d.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null);var t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()},e}();d.Layer=e}(e||(e={}));var e;!function(d){var e=function(){function e(){}return e.CreateResizedCopy=function(c,e,t,p){void 0===p&&(p=!0);var n=c.getScene(),o=n.getEngine(),s=new d.RenderTargetTexture('resized'+c.name,{width:e,height:t},n,!c.noMipmap,!0,c._texture.type,!1,c._samplingMode,!1);s.wrapU=c.wrapU,s.wrapV=c.wrapV,s.uOffset=c.uOffset,s.vOffset=c.vOffset,s.uScale=c.uScale,s.vScale=c.vScale,s.uAng=c.uAng,s.vAng=c.vAng,s.wAng=c.wAng,s.coordinatesIndex=c.coordinatesIndex,s.level=c.level,s.anisotropicFilteringLevel=c.anisotropicFilteringLevel,s._texture.isReady=!1,c.wrapU=d.Texture.CLAMP_ADDRESSMODE,c.wrapV=d.Texture.CLAMP_ADDRESSMODE;var a=new d.PassPostProcess('pass',1,null,p?d.Texture.BILINEAR_SAMPLINGMODE:d.Texture.NEAREST_SAMPLINGMODE,o,!1,d.Engine.TEXTURETYPE_UNSIGNED_INT);return a.getEffect().executeWhenCompiled(function(){a.onApply=function(t){t.setTexture('textureSampler',c)};var t=s.getInternalTexture();t&&(n.postProcessManager.directRender([a],t),o.unBindFramebuffer(t),s.disposeFramebufferObjects(),a.dispose(),t.isReady=!0)}),s},e.GetEnvironmentBRDFTexture=function(e){if(!e._environmentBRDFTexture){var t=d.Texture.CreateFromBase64String(this._environmentBRDFBase64Texture,'EnvironmentBRDFTexture',e,!0,!1,d.Texture.BILINEAR_SAMPLINGMODE);t.wrapU=d.Texture.CLAMP_ADDRESSMODE,t.wrapV=d.Texture.CLAMP_ADDRESSMODE,e._environmentBRDFTexture=t}return e._environmentBRDFTexture},e._environmentBRDFBase64Texture='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR4Xu19Z7PtTHbW1g3jMMbGmGDAZAMm5xxMLDAU0WSKWOQcCoqccw6eGdtgk4yNbZxnvvAL+Af8Af6AsQl+06ako9X36dXPSi3pnPu+cz/cOntL3S1pq5+w1mrpLs/eud9fvn27rf9evPPwFz+v22S7fGZ/n7/70G79J5/Xv/qzbLP+Pnvvoc/6Tz7jX/15/c62LfeH7fofbpfP3l/ct36Wf+u4+D37+XYb++G26LPsr/zFttnPuh37bm1bt0f7MvtlnOx4uv0H4fty8UUsz77rfn/57u32cgXvDv72eQf0tl0+G38b0Nf9K4Dl704MEfA16KsE8Gw9JgD+DQE8EA0DT2b7GwK4GHnF4a8iguXZt9/vL5/dbisJbEq/uwD5vIK/fbbAv4N9U/8nJIDNCazKvBLBGwdwu62OhajxmQSAx6gqNp5HCg9wPan2nwSNjhLD8ux/3u8vP3y7vbwDAYjtR8AzFyDqLu1Q+YEINnew23rPCYiKb+q/K7o4AVT4tg0t/h4ydJZfkQASQ/d5b9fZ/Z1ENmuPn/cwYCYEELBguKC3nRkCnE0AFOwOKCOAR/sH/L4hgFMpbSWP5dn/uN9ffs7t9mJ5cAHoBLTyszBAFJ/F/xIKdASw5wgaEWDMLySxAk4svf6L+4QAGPiJCziNAPb4f3UZ2dh/m+z7BK4SAPYrxf5FB6ABPgCUAfANAZwKyscc7IEA/vv9/uLzbreXzx9cQCMACAl00m8jAlF7ov6SCMQ8gJsMFFBnCECSg5H6TxJAU3vPAbwhgFfz9AABeOEDBcIbB3AqPzwQwH+731/8sNvt5Ydut5e3B2C/fG9P+jESgGz/RgxG9r9VAwTUUh0goQDafUz+DYnAnSha5l99Z1l/yQVswAZSGIAugNd/9xBgCw9E8aECkHUB22QPHIAVDlQdQAMWAibhBgZAasAVHUAI8Cqg96Tm0bj3VBS9jwd7IIBvuN9ffMHt9vLTbreXy+32QlwAhgMIeuNzKwOqCoB2Aa00KHE+EsIeDuj4H2N+Hf/TfAC6A4nhgQCQDDwiaKDXiq9KgBEJNPArAtCk0AEd2mpAizW3/lYIoANpBPg3BPA+hjs/9eXZV+0E8Bm32wsJA9aEoBCAuAABPiEAC/yDC4gSgRgKRHkAlgsI6v7iEFqJEMgBwb4BGkEfEEDnDlReoAP/SQRgOYIB+IYDMEE/SQBbXoLNr0jhq4qOZc0PHBSf5oKW519xvz//kbfby8+83V68ABfwniIBgwgQ/HoRUMv8w5qAoQqgk4DWQiCw+63eD8k/XAPQgK5s/5a5xzAAqgR6wY9k+ZEMtCOoJABb230hEHMFWQdgAl0Ap/+uc6tKBrrP/n0AuwfiNwTwNKguHHV5/qX3+/M1B/Ddb7cXax7g2e324vaQB3hhkMAW92tHoFb96cVAbimwkgQ0Vv7R+D8iACfuxzKfLvnNlAAjAsBwwP2MwLQAD9sbYJME0AFcg5uBPSAA0x0AobhtcDKDA0j3KYDhk7Hp8uKj9/vzH3C7vfget9uLT9nDgDUZuOYCLBJA8MNKPyGGIftPrL+4gy3eh5p/lwRUYYAs9Fn7tM/E9lvJwCH2DxJ/mPTr4nyyLiDtBgTAGCrgNuPzNuETgN+suEEAFhng9lkCoICMLH7V0isCeEMCxylrefkl9/uzz90J4NNUGLDmAnYXINUBrf5dCCAuQCcCvYVAYPk3G++VAveVfkIAFRLolgbr2F9ifP33pAqAV/fHRF4HcAS7AKlAAEIYFNwITOszs/wMsB6II4BXFZ0QwBsSOEYCDwTw2TsBfPrt9uLlqzCgcwFABI0EVCiANl8Uvq0JWNsi2JPZ/0YKsOiHxftsW4v51ZqAaBWgZf91PsBL/jFHwEqBR1cCiuJ3gAfCmCEA3cf8rmz8AMZHIoA3JDBPAsuHVgL4jNvt+UoCH34ggK0asIYBGArsAB7AD+reQgCl+GwZ8LaNlP3MEEDaSg4ACMGr/+ulwV4JsAEfLH42/vdKgWElAJ4QpBl+LAlKErHwt+oGMgTA2ngE4IUIOH3dGr/hAKT/m/UBdSJYPuVL7vflU26352sScCWAD+0EsCcDVxewKjfmAzAsENVn4EfgdySgnYB81yEAgL4RA8T8mTUASAAYBgylQAkL8K/+zL6rsl8qF6ArAeS7WRGoAB8Sf7isN/VZqTs6jQ5wXlweWfyqpQ8I4I0TmCCAT/3I/b48u92ef9bt9nwNAdZE4FoOFALYXcAGegkDMByAzzQEgJh+cAIs/legH0IA5QTCPADE+7ISkD0TgA/8sBIgLQfOgF/F9kPcr+J8fIYguyCILQRKgV4DNviOzoKqeJS0u4AA3pBAjQSWT//I/b5OmC0MWB3ASgBrGLA+IryvDNxCgRXo+wKhjgwk8bcTwUACsJ09ANRVAALwCxmEoFcrAUsuAJ4M1E8BDuHABAHomJ8RgACrZfQLyT9dBWi2OOEG9NJd/TDQ8HAQuBE97ZhjGKy6o+imnU+4gDckkCeB5cMfud/v6zr9Dz84gOdCAM/3JwQhF9CAD25gBWWz/8wNgMpj3K9Lfy0foMMBVffXyT4r+cceC9bvCcDFP0311QrATPkvWgosYQFLAuoqQEcQuw3v2si25F+M1RkZXLUU+CgBmCBOEsCbvECOBJbP+Oj9fv+u2+3Zp91uz9cy4Kfebs/3ROD6iPD2b10YJCXB+0PyrgsHdtBuRACfBeTN+uM+suJPSEDbfh3/oxPoHgwiC3/06j8Eutj69sAQqj++I0CUfvIpwCEvYCT90O4Pn1XsT5Ve1/+dcp9FBh3woqXBSEJkvjHHEOUPqJPAjUUCeOMGfCJYPvOj9/t7//d2e7YmAlcS2B3A8xcPYcBm/7ULEDIQew+5gS0EIEA31R8Uf6gAoBsgKwBd9ddvBBJAs6XARgLQXQ2o7T8+IETe+9eRACg7rhCMVgCiE8D4O9wOCb2ubOht1/vYd2ubzLlgKbBHEDSnAMfL6durVm8qBPwXWz7rY/f7/X/fbsvL2+3Zqv4QAjzfw4COAMAJbEC3wC8koBJ9lAhgxZ+4hi3Oh/f8dU8EqtV/JhHgWn9cC4CJQZXZp6GAk/1nawMkrrcqAiwPIIA2FwOB2oaAF5UkcX+GADBs0I5gsNbBQqCorJcFJjqWKvhNMjky0Aek7/LZH7vf3/vO2215vruAD91uz/dSYCOAPQzYkoD7vw34sFIQw4LNymNSUKk8Wv0hCYhkoJ74Q6BboO9eDKoWAHXvBiCvAdPZf4nt3QqA924AbfXV8t8uN4Bt2We029WkoErWpSoCSm11TM8AOYA5uRS4RAITIQDDavaYHxCcm5exfM7H7vd3v2N9McDt9uxDD//WKsAG/ue32/M1DEACuO3g1jkBsf57fqCL/7UbIISAio85AAG0VQEYiIC9DJTYfy/+Dx8HlpeDRK8G90IBHQbgWgD2WT8LoOJ7NyeA5JEkAwwxmuqzur5X6y+sBEwDMggrqoBNH7c68Puk/fI9Vwfwvx4e6H724oEA1iSg5AAaAewlweeyLmAnAHQCTfU1CTAH4GyTMt+QDMRFQFEYQB71lXUAOjHYlvTqh4N2xe5yASoh2PpaJUGDBDrLr9cGIDlY1l+vDlQOAQHckYMiA68KMFsGtOy65RCGsMIDT+QqJoD3yUwCy/f+6P3+7koAt50AXrwigM0FrIuEoBrwHMMAUhmQUKAlAwHo7VmAPURo9h/r//ozLv1V7/5v6wGMV4B3rwYPXEBqIZAQwp4TYDE+LQlqtQfw6my/LgsyZaeLg7wVgmDnWQ5AA5ZWCDRx7ECzyn3udgFptFCIgTlyFRMEUCKgA+O/jl2Xz/3o/f7Otz88QvpszQOsLmAPARoBSDVgud02AthdwPZ5BSxUBVr8L3kAVHrvs076KSLQi3/M9QCJ7H/G/rf4n8X41XIgcwHecuBMDgAe+BHA6uQgqnvbF5DB5hwUQM3vQgIWkKOVftH+gAC6cz0RXZ9MjmD5fh/ZCWCd1CsB7CSwhgArAUgIIC5AQoDOCewJwab+CH79WR4C0mQAZT4hEQS9DgfEztNkoEECDfi6FAhZflb6Q1XXqwHDEECpvZX4a0qP1l7bfAS98cQfzQUo9a4mASMC0CsIm6JGK/2i/QkCuFK9PxmIYPm8nQDu795uy3K7LTvwVyJAB7ARwJoAVLkA7QIkJ9A5AQS95Ad2YmgvAJWwQFcBpB38pUuB9wVKbAWgCXwV86Mz2ICKTwUWFgOxMEBicr0eoBwCGBUADfxsDsAiA+zflNay31ZcfnAdAAXgDGkcdAcfZCJYfuCX3O9vf/vtthHAmgcQF7ATwOoAtn9IACsRSDkQ/wqIIUGoXYEQQ/sL5IDJP539776DwodVAGlr5QBgP8sDdApP3gSUXQa8/rZsRaBeHmy+HwDyCI1MUNlZzX9iJSBO9igJGJYCo4RdIqMfJQ4Ztq8C7FXjHuSnQ92XH/yvdwJ4Z68ErOXAlQRW0O9/JRG42v9GBHsuAImAqv+uzDo30C3yAfVHoHeg9xyAp/7wlp+WFCSWv1sOTBb+0EoAZP5DImBrApAUMFHolQG19c+EAkbpjyUEdQ6gm/QEsCzZFxKDlWNwprJVWfBm/1WAvWrcQ0ie7Lz80H91v7/9v263+9sPI2zrAZAEdvXvXMBKBJIIFDcgyUAEvHICg/o7wA/Bvyt35wCc2F9Cg03RvRyAA34N8hD0xsIfXP7bQgDMFSgyYO8GsF4N/hQ5ALak1yUGRQDZZJ5VWXgKEsie8yQuH63b8vn/8oEA3lsJYJ2EQgD73xX4z9bs/74gaHMBQgA7+DsXAJWBBniHCLTtNx2AUnkG/LYNiUCpvX7wp6sIOHF/lwgkNf8UGagwYMgLMBdgLQCyVgOyciCGCs5nz/Jr8EXOQOcQZEbrfjjTU8qaCBseMyx4vxPB8iP+RU8A24Kg9R8Qgaj/av8lDBgcwApQ+QdVgW0bKr3+jsk//AztzBKgtv4K+Kj08rl7JFgt9BnCAIsQcD2AsQAolQj0CAGAqhOFCK5u3cA+84dyIJLCPm6buAgoBa5qDoDF6wzUkZ13iSDKKwTamSKZSf29cuzJUwq7LV/wz18RwH2Nl9dKABLArv6bC5B/+9OBGxmsIIR1AQ3w2gk4RECTfwBulgC0rP96/FYJUOv9SzkAB/xuKTBY/qsTgZ0LILF/s/RW9v81ywEwhbeAwUIH6hRwGp+wEOhqoF49fojqQoPlR/+z+/3t77jd3n3rdru999CzEYAQAYJfXACEAqL8W5lQgA5uoJUK9zxBB3ii9ALiYT2AjvuN72wFILP+XdlP8gLKFeg6f5QM3AC+VlMMZ9ABGuN+VePHWL6tHVD23or3tQPo2iWfBRgShDp0ELcBjmIAbwTWqEzIJvLM6kEDEFcD9erxCzg3my4/9p/e7299x+323lu32+oAtjwAhgE7Cazqv7mAvRLQcgG7A9B5AAwHus87CWBYsIKFfe+eCSBgt2J+7QBQ+VsogOU/9fIPBvLhASEF8AHwlhPQ2wVYFhmo/Wby74QyYLcmQAEbbbue2FcnAb28QTmHQKBwNVCvHv8IESw//h/f7299pyIA7QIE/LsTeIbqL59hPUADvHIBG8jBIWgn0L4rsKMj2Noomz8QgZELsCoAAnh0Caj8lup7ib9tX+ZBoKgUmFkWTGJ8S/UHZa/kAHT+QGaeoeQmMUC/CoAzVYAjYDvSNwPCq8fPnINus/zEfwQE8O7tdt8dwGZjIQQQ9Y9cwAB+RQIC4I4MdvvdLL+O//E7LgLykn6q3Efjf6X8bOUfkoNYcQZ8z/KzBUBYCqT/YQgjBuOBHxPs7JHh7JoAy/IzWz+xEtBKBEYg8fIGw+SeQQQ+CzHZP+oWXWPU/8z9y0/+h/f729/5kAN4791X/6/cpl4SCsDfLRQwHEBLCmJFYH92vssNgBPo7D8qv4CekIHpAjKgx1iffGbKb5UAQwdguIAtz2KsEWj7vIQggNON91lYoIFN2mznYKj9UBmwQgXLLcDstRTdBchEFWAWcLP9MgC9cuzM8aXN8lP//v3+9v/uCUDyAM0FIBFADqAjAsgFiAvYwK3/MfAL8InSd/Yfy37Qpyv3OSTgxf8C5vZXPfF3aB2AA3hJGg5LghMOgCUBo8SgEAyC3Irvh5xAwhW0cT1iQBKYWds/QQLdeVUQcrEjeGoiWH7633sggHfWJOAaAkglYL/wLQyQf3tYsCp9CwmgFIgOgIJ/JwMdBuB3cQTDX4z9wR2whN+WE9idh67761p/F/8bpb8O/OotQCsJDhZfji0qT9p0LsCI83X9H8E9KH8iCSiTrQO29bwAAbvlCipPAw4T/oRKQAVElbaMJ472t7jnqnEjrlt+1t+539/6P4oAxLquawIkF7Bb/40M9hAAHcD2GVzABmBYKSgxfyMGAbROCipl1w6gs/8ZF0Cy/UIOOr7vHAIu9iHP/2v77yX9ROUt29+AHVUCnDJgtvSn8wXsnQGzIUAW3F27qFS4z2CrD07wCogqbR8LtGecUwR4vX/5OX/7FQFsOYC9FCiToBGAEAH83ZwA5AM06BspiPKrNQIt/kcg69iffBegNqVXb/wdQgIMC0DltUuQ+L+Bmz0OrNTdK/91+4JVf15SEPMCYRkwEfc3stBxurMS0AoTMKRocaV8cKw6jpcFsdUn2/8qRT8buGeP55HC8vP+5v3+1v99cADvvfNQBZB4dO24Kv5GAntSUOz/+n1wAis4wAnoMAC/N9svSUKsBABgmwPAbQTwWzsW/2vAI6j14h+1CEjnBYZFQWSxj+sEVFyPjgBBrhf+aOtPY39vRaBVJlQ2vyOGIATQsb6etBguDMSQyAF4IMhUAmZANNNnUNSqBDvtzzif6HSWL/wbuwN4eycA4gDEBQgRYPzfSGC3/BYBdOCHxKBHBAJoAbdWfIz1I9XXsf5g9y0yAJB7iUDPCaC6e2EA2ngMGyIHwAgBldncf4ID0EDXVp1NYmbnrclOtyfDhiPOoCO4CEXB/rOBfOZ4yy/8a7sDAALY1gKAfWMEgOovoNdk0IArKr+7gwH02gWQ2L4t/sEEoLL2IQnoFX96HYC4CIz/jcSgAJSVAtu2RPZ/SPRBHkC7AkYEqceC2fqBfdKaCcHAAeAkpKVBCANcElBVgBQRTC4HngHOTJ+rQo2jhEbP6xf/VU4AmBza7L+EAZgLgGSgxP8dGQDwmQOQbS2xp6oEWAnQn1seIEMCJO4fsv8Q2w/JQU0IJMvPiCCT/NPuQP/noJ0rAFBa23VSr1N/vQhIgxzzB9odMMIAkGvFZPF6JkyIlJeFFl6IcRYYX0ciOOOcll/6l+/3t/7fngPYy4BSCmyT0SGAlgvY4/+BAET10fZjUhAWCg2AV8nBEPQ6D6DJgSUAoQ/G+Dr+T9l/pfg0HxAs/e3WBUhbsihIgHKkHGiGCQHYO/UHomDgdd0BcRkZlYtyAFlgZNtlzqkSJcwc1xr/6FjLL/tLPQG8t+YA3tuXBKPiqISgAB//bjZdkoNE/Rs5EAIYXIAKCwYHYJADlvhalp8RgS4PogNwFN8jgo1A2LoALxRw1gA09TbCAjckQHBZlQEFwEoS0Iv1S3mAYFGPlwOIJn+0v+ocPohEsHzRX9gJYM0BvPvwTyoB2gGsP6iEAowANsBJWAAVgRYeAPCb/WdkAKEAttNJwRbzM+UPQI8K36k9Kf3RagBTe2vhj3o8uAFXLxUGxTdXBrK1AIltTZ2JzUe7Lp/Ralvxvrb5kcWP9nv2fwBzIRF4FRFkx/XcwRljHCGm5Vf++fv9re+63d4xCABVRhOAJoOtRCguQKoCmghwv7L/mBPQwB/KfMQhCEF0ym8RAUkIToUAxrP/gxOwSoDGmn9WCjTzASw3kHQA5poA7Q4g3n+MEMAChiadiopXwHZV26usvB43e/7Lr/pznADakmBdDcB8AFj+5ggcF4AhgAlwwyUM6m+pPgF8U3BS6jOdAAkJ3HUAO5C7ZKBT99/IVDsGhwyY3e8qNfhCERXDa5BrlW/ftaoqe265Ar0U+PIQQCUzqwqYBYfnSK4AcuW8sjmHaMzl1/zZnQDeud3eXRcCrfH/ngNYbyxzAKL8nQNAMiC5gI0gBNz42XIBAnAkBACwqDyWByPlp2BPWP7WD0Crs/5ewq+1JaBnWX8rEajbDiVAlbNpwHRyAJ4D6EqECQcQWfxo/0wI4E3wcPJnUbSLXqH5A26qHaD9kb7ssKaj+nV/ZiSALRG4rwhsJLBfUKt/k3yAJMGwEtCFBGD/PTIY4n6d8ANyaEk/Q/nPUv8h+WeRgXYCVgIwSwbK3osKi4PonEGUC2C2Pngc2LL73Xanlj9bBTg7BIgAFe2vuoxZS14B7wy/DCT8xX/qfn/rrYccwLtrElA7AJkgkrDSJUHJfO/Z/wZ4Kx8g4IXyYKfm0i9QfkoSJK5HghALr51Ce2Jwv0ad9BvAj1WCidKfZf1x3UDnvPQ90HYf7o1WfSQMGbOpU1D3H6oCynpjPE7VfSccpoalMEHNdAxFKkDLgDzTRo5ZaXukz1E34f1Gy2/8kzEB6MUlsjCoCwWMEAAdgOcGTECrnECn+JYTgPyABn0U82vwt7hfJft0rK9DAlHooTSolH94GxBUAnTSL/reAbz6UBADt344SDkIJBIT5E62HgnEAwgFmjq3ChFkAJUFd7Zd9fwsdZ89nnX85Tf/8Z0A1hwAOgDJAxBbuU1usboYCoiCKvWX+L/lAUDlNUG0bD8Bt7dviP9Vf0v9LbV3XQCz/3qbZf2d0h8D+JAPYDb/RAfArL1l92W7Z/OjEICpOZvkw7bES0EisET7M0RxRNkzx78qJGj37rf+MUUA+zoAnQjs1gTAhJNyFy4X7kBtkYHKB0ifDMgrLiADfJMESGa/Cwe0/a+CHsmA5QQ8N6ByAzJZh1IhEobOAegsvwaVDhEKDkCre0cielYbau4SQfIZggyIM0DMtMkc6ywnMHMsduzlt/+R+/2tt2+3d8QBiAtQSUBaEVDxPyYB22cEuiYDQgJtLUFk7539ke1vgAeAR05gC3ekbAclwuaEjEVA3XoAAnLpT6sBCuStrUrIpqsBHhkwcBOVTecFJAteCAFSyk/GzapwBOJofwV0mbEQkNX2p/X9HX9IEcB7eyLw3q8IlPgSbV/LBThEIMreQJkhAeYOIsDrsELV8VmIgHX9ITGo1L+BnxGB5wQY6IvKLzZZCKD7nsj8m+sADjoAVHk9ga19tF1CzSk5GO8T9MCUAdpZbSqEUW17lpNYfucfvN/fBgfwLlQBcEnwdkA9cdGiCjCgGrCpZhACDMSA6wL28dewgKl6GzuI963EXwtf1Nr/wQ0YMb+bCJwAPgKc5gPIPeiImeUC4B5J2zbZnGXBQjI4Mdk2HFNPYqv9MNlJCJByAzPPEezIiUAe7a8ANjPWGYpePc52Db/799/vb7/zKgQQAnhvDwH0cwFWLqBluwkRYJ7AqgoMTiHjApTqR9ZfbLxbCbCUX1wOKQGiO8ASn7XdKgMimL2SoG4nkxGVnqk+OoeBDHR4AN87EmCWnlULBGiBuiNJMFC5RJB8HsACRgYwZ7WpEEY2pNEuYOoYv/f37Q7g3dvtnT3+39YC6BBAv3IK1wVA9p8SAYC5gRDBqz53QDasvag/dQboGMCy0zBA7e/CgoTyszX/VeA35QeH1YGc2Hwr2YchGn5mJNGVd8FdoEOIHEBo9VkeQc3cqFJgEkPhxSBHwoIMCVTAlx1vlggq4y+/7/fe72+tDuDdV2XARgD7isDtd95BpZWjKRUov4Acwa6BT5OEsEjICg1aBUAl8DpwA2kgQeCYbHsjL0zygfKbll9XC5xk3zYGgM1yA0IKERGgI2PJQJ20M13CAQfgWv1kEjBj+Yc2zlqAGdWPgBPtrwI2O16FXMrn8Ad+z04AaxVgTwDiasAtBNgnrK4E6HBgSApichCBBHkBCnQNbmb1iTPoSEXlDXCfTv6x0EAA2OUDtCPA70bMT6sAXjVAlf4sIhieC8BYXy0CYk5gIPKCA8CJGzoAI5QYJqoRzx8NAZ6KCLLgzra7igSWP/i79hzA6gCAAMQFrBMNSUCrFypUm+x78k/cQRffY45AqatOGDJy0CDHkh5dDERielFhWvrTIYHO+icy/jK+qe6sCkCAH70erLsXylXMWv5GFowQrLyACISU6HZ0W+RALX0Qz2ug4NgYUWScRNQ+q6IZ8GbaVMCdHS99jX/4dwIBCAmsoNd5AHAB1sRDArByAV1YgLkBnfRDF6AtPbP4LNY32lkOgMX/tPynSKFzC466Y2JP+mT+mk8BOiVAVP2MA9COgH4nQGcgHxyCAe5uMicqARTcJ+QBIlB5+6O+V4E7c9wMCSx/9HfkCEDyAMPDJiQZ2AABqtZUVwG7s+ZWMlCDO/F9iPFZso9l/IkDaMRgxPqe4g8JQa30yg14pdaM7TddgWHxXcUPVgLqvnqyWw6AqrlT0jPV33AekYJb4IlAdfX+6LwR0BVi8Yhg+WO//X5/e68AyLMAawlwCAEwF2BkpTfgqwlu5QU6G45KrdYNsNi9qwAQMgjBnyEDI77XYGcxfjXut1wAhlfSptsGoNHJPab6XkLwTAeAk1MIidp+mJlRJYCqPxCABwizr0aUDl3I/ogEMsDMjJEZp0oYjECWP/HbSA4ACEDWAbA8gJ6MjADWbYP6i5LqvyRROBBABHgjXEAV14k963s7d0koOkm/s+J+FiaERADqbjkAHKNNrsRCoE7lmYsQ0HjlPm+dgMzKRLmQkkgyBJhR/SPWPwPyTJuriWD5U78FHMB7eyJQ5QDaYiBhXL0mgGWumRNQAO/KbieTASMOL8bvVgUSq2/lAvAaOvDiwiEjs6/BThdZ6bUBJNvfuQN0Z+pzVzI09nXqrT3UMRMAACAASURBVJcKg+J6xKAnLao7Tvruc6ZcyBS6EDpUXUIEvgyAz2oTnQuqe+aYzT386d98v69rALZ1AEIAazVgz/4zBzC8aorlAdS2rkIgC4e8v2TxkOsGMLeA45I6vgZ7ygFg4g8JQhOdl+FPZv+ZnRey0CQhE4PtH1TfCBmkXQd+S+1ZXkCTiQZq0gG4sb6qMHSAKFYQHpsIMoDMtKla/syYy5/9Tb0DWGP/7R8QgOUA2NtnzEw3LhRS6hjlA9CK6/gfS4XU5rOk427p9bg02cfATtS9CwGcSsB6/taTf9Zvx0ItvQ2JgH7WgEYyMMA+5AwmHMBMDsAjAhrPTz5M9H4mggy4M65g+XO/YSeAXf1lLYAsBca/24D7MwKdakBIYOUBxKYyJ0BDAeIOTOW2QI75AgVkXNVH7b+VBFTgDisAQda/gd5LrCrlZpa/WXJrEVBk+cGxNWAkqwDMQWiFNq2/zNKgDOi6A2NFICULRAV8rrSN7HgEzmh/NH4G2MZlDi8qXf78Fz8QgNj/thjIcADtvw9HNcgQwGxIwPIGLHTQVj8BfszWmzkAlZsQwFrlPbcCYOUCjBwKKwl6pUBRWyFhukxY7LmO7414X8f61BVY4YLY9iDBhy6BTX6LPJCoPHtcAXelbQRUD+gZEojGZyCvjrv8hV/fOwArBGBLgnFpcGdJYUJ0gNknxLDNCwm8xKEV6xtqPwt4DWpm92kIQICN7bSNF2Xv/pLfUgNd5wxoCEAA34GbqL0VAmhSuMIBuIqv8wGJRUQWmCzAfNIQwV/8tff7O+9BEhBKgEMiUIUAXjLQinMbAAAcCIruFWMVgBPFX28iLhW2Yvzu+JCo06A21wAQm69XRVJwk+RpaiEQCxeQKEDlaWhgtEWQWEqvt7vhwoQDKAFfjR+5hytdgjf20X1HLH/kIpa//GtUCLATgE4CogOQz628IwzslKx0gosuG1bWnuUGotJhyzUYYUIjBSsnoJKVXZnPCAeYo3EBH1UDDIA38CniiBR/CA1I1r5VEQBUg/1XVt8jjG7iWZUD5WEz5UIK8sRagIhYquQQgfqI/a/aeBYKZMOD5a/86r0MCGsApAqQcQDbgTQBMNuqJ70GE/nuOgMSGjDFj7ZZhNABnxBTIxon459Vfa9yYpUEEfRU5RXounEUkJEgGJlEYNb9O2IQ16hsO07y9nk2ETjzJKG4JIKUSlgQKqyDzgzQM22ic/AcxPLXflXSAew30no8eDsJvBGWyhmJsKojQOAOi3R0yRFtPcvuqxo/tf7qeryYv2T/mZqT0IARgfzmG9Eg6erP8Jvr+4Tk4Sk6IwnWfgA/IxsCPhmfKWuk3ugcqENIgLwC+hl1j4Ac7c+CPDNOd4/++q/ccwCRA1iFHkqAtBrA3ICh/J46Yp7AjM+DHIK27t1aA0YIbKGPIisrw59NAOqSH/0NEKyMCBS4qwnAtNpnk4JGnN8pfKYKoIgiA2R2DEYglW1XE8FZQI6AHu1vv8nf+BUPBNDKgFYOgDkAsHdmQhAnkhP74kNDg72OwgMP0CRuN90GW+CTdCwWoVluQKv3EAYQ1cZjuOpv9JXJNyT49KIgliMwlByVu7kJUFwvPBjcQuaxYSuUOBAGZMjGIxEP1BEQn3z/3/oi4gA0CQD4uxAACMBLCKLNjFSPJd3Q7rtJOWu1oZNcHMgmE+8H5T3P3Xj7OlCzCgEeN+sEVDs8Rpu4Ol9ggd1ScuYWkAQIsDv1lrYqB+BZ/2FfsBqQAe3sbZG6Xwn2aGzr3Ja//cuJA8CnAXfr314SajgBkwBwAs6EAwmwWWFChThY0s8iI297B3DDPYRtCLi3Psb2AdRAHrKvqb9BCEyNtaKXS4OkoqAnomXjKUEo9e/GSjqAs0HvAS8C5WzfaNwKES1/95cZDmAlAbIacPudIRcgi4H0oqBuUirgU6WDSVtJsHnJw8gtZNyGWeJLEJNn61vZzYjzo/3dQ0Ea1DgmUXMWAqTAbil9UOaLynttQj+iAzibCCLQRfstUM+ShJiqqP/y937p7gDuex5gBz5bByD23woDMA9ACeCAG8jkCLTis+8ZUhjCAisZOKvwySw/OoWONFWMrmv4ZsWAqX+wrXMGbLkwnMvgIowEIWuHTsV1CTKz978WeViA88IKDzRnA/Ts8TyCcUng7/+SngC2twFZJLBPljIB4IQ1wgA9waPM+rCfJApN9Tae1beOGZ1LO06CEKj7UbF9A7CVB7AShIa9R3Uf1gOwhF9V6S1iEEQFDqFN3my14IJEYNYRTANNERd+PZMMIsXXp7H8g198v68VgHf2uP9dBX5xAtvbgaUUqEqCg/1HKweAlx9vsLeGIlqxchWojCyqY1RCgXK5jxGHofIsD9B+V92nSAgIxCEkgLEGBU8mAaO4PgoVmEJbOQQG1CzIs+08Msg6kAwRzJBOlgiWf/SLRgewksCq8l0YAKBveQAgBGb/t4vDhJQmAwf4a9dQeZPWnJbiHMfgOYeNlAKlx3BFOxs3L6B+LySS8EUg6rzwuEgQ3luBGugDqx/lCzyCGPbtCBBi05M9Io2OFB4hEXgmGLMgzZDEjIvYruUf/0I7BGgkAJWAbY46SUArGThMyAIZVADH2ppEkiCBir2n5xmpu5ME1I5pUH+LYEnFICKEDpiFEADPSSu0JhQX/MphTBFBIYnI3MRjgLviLs48H9OR/JNf4IcAK9bxPwoV9TerAXgj4T0BOJk9MhAQDZOfACUCNgIy0zbTJpPZpyGAQwTiKug7AYkr0L+N991Vf00gpGyHINbK3yZVMQQwVT2xEMh1BEZ/Nvk1EKsKmgXyGeOeTQQdEf/TL3wggNX2b/H//jqwLRGo1gC0HMCeD9AlQPw+WDqZJEZIoCdaNY6OgOmFAVq5u7ae3Y9AHam7sd8kApUsZHaekclAvrv86eoBcwkZkFvrA1hf1wU4Cu4Btu1T/c8G/hWgrxDEmSFDc0D//OdDCEAqADoPIMnA7a8wrv6LpSEFfJlkoQtAdfKShEmAWlUDN7xgOYYE6DPuBY+Lv0W0HRXdK/cN2X6l0jqcsICubbx2AVeFAK7Sy+zV1YDiasAjgH6MvqZth+vXH6sksfyLn/eKAFaw6yoA5gEE9FYScDsZZfsR8CwhSJNb2Tq5UVLsQO0lE5Pk4bqRiBDU/oEcHFVn9X1T4dFZ6TKhYfWZcltqbm6HsZm6D07QKuGRcqQGgEUKSF5N2QySYPutbZkw4SmJwCIIJIXIYSz/8uf2BEDXAWAosN/w7gUhAHwhge7GY2wGBKFtf5oMGKgcl1Cx/wKwKKQY2hWB3oHbqver7ab6J8t/2L9VbaR6sM8auk4gArlRNbBchQnSaBw5RyV7lRCAgSYCerS/otRZwqiMmSECc7x/9XNUDkCvAyB5AAwDtrlBQgG8KegCOsvolQgrgPKcQKTQSReBhOCquBP3a8LTToXF/vpY8ls2J6AdBFH/rNJfov4YDoL6UzVP5gDc8MBJBFbBnwHrWW08EEcqrvhw+5oNBZZ//bMLBCDqb7kAcAJtUQeyOuQDcGIPnzFeJQClSbJqngBULW3xIzKpkBYe3wGxkISn/u5zASwccLbh5NHhht43ELsFcGeFXwfmA1UAdBsZ9YxU/ej+zDkwJ+RtO5Mkmhh9yc+637cKwJ79lxyAlP/kKcC1IqBzAJgL0K4AQwC0m7hgyAsBrAVEaL0HJU6SQKeiyT6dWictOwsTsqW+9ttosAax/pA3AKJBEqEhQLX+T+J2PG9GEIxEPPC6ag/SNzhOtm/fZo3JABYpfLT/KBFU+leUvxHNR37mSAAC/lYBUDkA76EgIYWOAHASKnXHm4/hwaB8pIxIV8oFFpxlziNws/0diSgF91bwuQQmE7QQ+2fUvwO+pf7KkXRA9db6W6QB1+KCHu1qMgTQE70DoTOG24/Y5qMuIEMOFYBXQ4FM++WjP2MnAFUClGTg5gCEAMhy4M4F7JNou/eZ0qBWELD7qO6D0uNkZXmEwKqb4HXI4wzAa8ejLTYSjb5mfXz8jgCvlP86YrhC/ZH4lfpSFU4SgAfMo88TZFxAlRgyY1aI4Iy2zQF87KfbBLCVAAP199YCaBJAV9AlnAxX0NqwnIBSrHSSziAPa/VeJt/ACMp0AY6l1+CNvofqb6h6NikoJMMUHN2apayZNt3YxRwAPa6Tb2iTXj4cVP2MwkdkUQFz5njsGt1tX/rTHghArwHY7P++DBhdwDanYCWgzgPIfh2TtfUB+6QcJhcBedfGUXoGwAaOyXhdKy4rC1rxPAtlymqfjP0x5h6ArVSdARJdiQa6BWC8t3h8RhQ616AnY+cEigRQdREWUZ1NDBnFz4I5Y+OroMf2y5f9VE4ACH50AS4B7OD28gDtxyEVgW6yOIQwWGlg/Uz8bQLXcBoa/AM56Dq8FcMbCTyx/o3ISF3fsvaMWPRv7JLEPht08nC4TyTDb5UNI1VnwO3coaHQFPBKxa0QwAO/G1LAucwA+2oHkDkny2Vs27/8pygCANUXF9D+h2CdC1CA334rcQf7Z7yxsp8qiFpBOKhPQAiW6jIlN9UdzllAKQBjdtxT9eF8HJLQ5xNae6Lska1nSu+pfyMjb3GOlxwEYrHANwA6sO/abdBxyRiPAf4ZoGf6WOA9y0Es/+YnAwHs4JfsP4v/JSEoTgD/is1veYFZEsB+xAp7gDEX0yRU2asQaHX2wD8QjEEsCDKt0pZqM2LpSqaiiNpteCW7mQSgukc4UTWxsH0Z8EaKT/erRGIW/E/pAo6AOdt35+Pxvwf/t0gA8BKQFfzZMiDmAYakoJ4oUB2gE4UtHDLiYQSa9bnsDEhJj4HfdBYHF/V4Vn8gvh3sh9Rfk60ot7c9Uf+Xc80AkDnCNGng+RrnzCa/RS6Z8zXBJDv0ORnf9bHY96Pbov7LV/ykMQfQrQMgVQABvP67//60BKgXA7UTU9Z/mDgk+TeAndjrBtpCBcEF9Wz23on7j1p9TW74mzaH4jgC/Vtri20uDdakzvIDbTL0y1I9Gx+V8CJHgNeTBfIMEXhjz5LDU5HB8pU/ccwByBOAXQ6AxP9sQVBL5EJGF8uByPYDCehJE1UGAuB7JKD3MadA22iFx9DCiPPpeZAFOZWyH46Jk2cDPiZFRX1IvI7XrMdg2fsOvCRsYGMM25QadgC8KAeQIg5BblAajOL26v5Z4DPrb6m95wKWf/cTxhwAPgJskQAu/aUhAIB5+22J9aelQa0uOuFFQoRBCY2Soc4PNBDBMQVAGJ50amqVI8kYOH4F3FTZsyU9EvuLMs4q/NBP3SNT1Y2FPQyQcs0RYYT7JxYTZQgiAmoE/Ki/8E80DgO+RQYe8Nvx/v2P3wng9updALgAyEoEYrY/ejS4katyBegG2OfOEqpSX7s4K0QohgVUpSft+5VgR7BFsb/nEkxScByD/s31pB2IIOMSIETRE9YLF0wiOGMtwcUu4EoyyIAe79uyEsDwIhAsBSrrT6sAuyJ0i4KU6p9CAkpl9boBNuHT7iCw9vThJBJfe8erKrt2IZZjoWSIcTkLCTwVt6oC6nojwLKYvuoWIsUf1DsZRljn7m3PAPcMBY/GqIK8YU/IHTYs/+HHKQLYAd+tBCQkMIQA7L0AQAxo8bbjI1MXPiOIqMJNOgIEly4HmvsUIaUA7oQ0tD/LuBsAzTqC7XosUnAy/MwBZADtKTl1fjhB2aT19j9RCHAGOWTGyII/Gyos//HHAgEo5c8kAbv4X6m+lRDEmy73EtViSEA5pcFOIVTSMHIEAgTLVuvVceXVeFWwO3F+ByIW5zuxv1ZRRqL6d2TK64E1Y/9dIiDWfVB3veqPEcEThAARcDNgPKtNdC6Dw/lPP+Z+fxcWAOHbgM2FQKDsQ/wP+7TSo+qzsiAqk1apLmGoVUor4kTpcCCDALzZen1EQpbNp+QEjgNdiZWxN8t4pCKQUXeLOChZOFacEoFxTmzsYRIjEZwQAnjjRwCL7Hu0PxofLnVc1IM7gzxGE96vWgkAHwUWF8AWAuGDQOyhIAQ/KwPu+9t5KmVvJwXtMHSgE9BQfU0g7oMy2g4byb9ZMFtkwUCMhNDtJ2VDDVoNLBoSEBLpQBYB18kPpElkv9HM1XRzwFB85gzw2BaArX4uoRRAFYG7up+RQYYgKm5i+aof/RACiPK39wAAEbB3ArSq3v4Bl//qpcAa8Nt3QhAM7N0FE7DTSWc4goEUAAwm8Ky1CNYCG69syWr/BJBWLkArvWflL1H/iDwE2I6dH0hKJkeyYtCRFYCThSdZYLuEwo6hCGwGlE9FBsNx//OP2gkAwwBJBBoVgK4SsE8KyQWwuJ8RAoIdCQJvpMXqVnlQA3z4TpRdjsHA1IEo6hss7JFzQQDQYwaE0AHAUmMrSWgAmJKomuRH7D8DmOVWGMAjgHb7T8oBeORR2XcFOcyMyfps2776C/ocwPr7df8rkEMC23xS/0uQLgVm3IBOAHYni1ldneHVcSMJKdbJEYYOQU7BDR+M8VMZeQZUY1tHVNYxlQJnQgJNKNbk9tzGAFovx0CWDXurDkPF1+MVcgBZhzDbbgaoVWdQsftNaIHcNwLQIYCQgCh9SwaC2jfgQ/lPg92qAnQnokIB6gCUcrlVAqNsZqqco+xMtTM2/FTwVxyBofAsvGGgNe25UxqskgxV+ETIkCaCAgFEzkLmqdXuqZ1ARBam6gMAl6/5kSoEUPYfwa/fBNSeBQBi2MZW7wRox8skBgnYTUfgKLeA11O4KDk3gJ0pWzI00BOYxuhOeU9fhwXWqdg/Io7MfuJKKNhBfRrAJisAFJgH1wF4oPYAF4HxyP6oLwN6xhls/f7Lj7jf5dHf9hdeBNoRgJH5L4UB+2TSpBDmBADsCG5U9izYq+Sg25uKqqsJhnJ64JdrcC13Mfan14tAdDL76MhM0qmOFdh2fRxGJBZQoycKI7BkQZ5tFx0v2h+BPw30BrhXH7bweCOA/eWf+kUgFvjxKcChGqAAbuYADCLQ4N5O14j9I/DjftcGe1UDpn7Ogh2LhCrHfyzw098Hwews/aVkkMzkD8qd7JciggNJQItUjoC0CuAjxMLOMzz3r/3h4ADgLcDM+ktOwKwC4HJg9ZmV/RoXWaGBUv1TiYABO8ofWLHwRDLPBd8JCn8quLMWPeMkiPozK5/dNpBCkAPIgnwWiLP9QqAqBc8of6rN1/3wh4VA8gRg9AxARwI7iFgJUCcAKwlBFg50lQIdDoCbMC1rpYKQrBygW+kUMcjkR+CsxvHus/sReCPQRvsR0A74rPCBnXtK6ZVTsdzgYwK+ovaVthE5zCi/8MnydZ+vQgC1AIiFARveINHnJQMbNlHlAbDbiTj7NBmUiYCoNqsiDBNUT+YjoHaSh3Lz3BDBcivedkaSjvqa8X2ypBe+QEQBVl9vBHrmCCi4H7EKcJban00GFcJYvv6H9UlA+i4AXAuAZT/1WWf/LdXv8G6VAQkxlMHPMsJFJ3CJylugstTaU2FPdT3wZpQ9UZ4LiYvU/TswJ1xDRsWZ88v0a0oIFjtDNt7YEQCPEEc0dnX/AwGQ2P9oDkDCAvld9XdP9dEV4I3tbpaenMZ3V2lIn0yCSlv0wyTh1Nkz9p6ppxVGoFU2VV/UOqn+6NKiMbtzdQgmcgRv1P/hJlXdw/C7/dcfajsAifeFDESU27MB+wa5jzoUaOB3LD4SA4v9NVF4LgAnd3ehgeozAHugHianEx6wCR+FG2YeA294whVQYtjvWQRUMw9BlDIkG7b6j4VmVrusOp9s/y0ncJX6R+POAD4kiI0A4L8BQ+Uf3gfg2H/2MBBTfdP+C7vAzdaPAFfIwLSERHVoIoqUBjNKm3EDGVIwx8kAOFLuaL86hkkkxcU/jDgrSh8CUhG9B6iMzc+0iUB7xO6H4EWszLqBb/ghJARgTwKytwI7OYAhBHBcQDYckOtlTmFYABIA3XILbCEJ3QaE1ampsRItHTbsF+mqqpUryCzZzYA/QzJJN+ICPLFqLwPCI/F/aXy5N4YjiRT6akB7BGmd2/INP/ghBGjJPwL+1QnIfGf2X8CuQ4GGEZXoO9UFEOdwhAxYDiCtXE79ngKh2t7LFWTAHwAbSTEKEby2kaqznEHUJ6XmCUJJjaPUdFbFK4CvtI2IprJ/+caVAHQSkD0ObL0MxCgJbnNNqb7+XlX+KATYLlwdky4NZVaRxY/ZcMGLZwNHkCaXCPwZ1bbOBZXNyS0wkJruSKmll1w9CsrHdACzZOBdYwWwYj7CcAhcijf+8o0/KHYAkgzs/u4Trqm+/g7gKYUDRNG7F4jKhTlAbz+SbgNjdz+g0S5yA0wFO5AQAnHVzwOoZ/vPAn8yMeclKSMlPwOspm1nhO2oeRZEM+0qgH8q9d/O8ZtWAig4AMGQuRDIWQ48JAUBkO3eRcDWuQSi+pETQOBSdpxQ/kjJI7IYljkrVXaBlajpZxbqeGrOQEDzGqA8OoywfvdqHP5+IICznEKFSDJOYhjvm35g0QEkFwIh2Bm4w3AgcAJ6MrV5R+y9BpcmCFQl+oOz8MByE0qNu/EK4UDkJBihWHF7Bvz4m5jAJct+I8Wn+6+I1a8YE0k4+OwBtaLwlbYZwIfjrQQwrP4jK/82+6+2y8q/IQmolR2SiNvvqFUc3x/A9jOwESfAgB6BnxGJFR6E9tWbhJ499ey9FUbIhDT6ejadAjwKMbSVtkgxY7kvAOuZjwFn1fvq0CACeAhucGPycejzzT9gdABYERheCLqDUQhh+0qeC2iYNcBvWf4wMWgQhE7+CdHoC04TAlFy0zkY6+41udAJkyANar8JKVIHEBFEspYfOZLIxofkmSEOr82B+H9WvWcIoALaStuILNj+bdtKAF4JUKu+uQpQx/5AFKj6NBwQeiLOYCCxKEegCELb++GHcCoCA2taYHXU0IrtXTJhjsd5kKcDpziDBEEgQZkkg+MBWVigiYjA/T3gZofjGI4kC+azwTszXgTaqwlgHX/5ls97tRRYVL2tADRCgUH1yYKgDofE4nc4VqDG/EGbE0ZiziMIF/yGYlCHYJEKKzviJLaOEWTbQ5CQpN9AAhcoP5JWGaBA8lmyKYHZI+FgldwMeLNhgncNlX0RWczufyAAWQqcjP2tCgACV+Z+t0RYAUmIpAOxEdtHTmDbTybBsHaAnIMmiuHmatcBk9m8iexcEgrqVgP2c6cxvFL+LMii2HkYJ5Er8H6TaeL4ANj/CKSPofiIowcH8P23COBGnwHQhOBVALxHg1l4kCED0mbIEVjqTIhk+4GT26dJIXAF0yGBQR4U6MR5ZNsNTkIRS0mVsa8ir+o4LnF4ZKvPYXKV3xWK/1o4gG/9/ioJKC8E9dyAAXaM75sDANDp+N8LA7p3CyjF1Y5B3xxKEsZ6AVo5SIDYZHMvGRUlqqLseLCSbzunpBVGMsy6hTA0icAWXf9sIjC45irZyPzKuJUjIH4KxR8cwLd+v50A1PMAmOzTnwXTYvkld7Bth5uM+9uBo3yAodKR8uP4HUEQ5dFtGYEM25QCDwQQqVAEzAgcQdx/JvipC4jICX50Cpxk/wzoorCkAsrM8WbHM0WCEGXU9qr9y0oAWwiglH8LCYz1/w3wqvznqr5BDhqsUwuEqg5BkUwHdgOI2yGsx02tHIHcaGd/pMQIbArMRF7hCGAwFMqAxWwTEdys+sO9zJzfjBuoKPVVba8lgGISsFsApElivyE45wdXADdNhwUdlkm8nnYCCeWXY+l439tecgvG5OxuZqSMjnPoJnwWYJETYUoenWOkaBP9M2C2yDML8my72fg/Am2FLKKxZvZvfb7t+77KAWxOwEj8NXUHp7DNb3QBCvwSAnSCq0MAQhiitugOcCzcbsX71qrAri9OXEY21nMGHUu9GnG4oQVncMg2Z8FPSDEFNMcVHemf6ssIidw3a6wsyM9oVwXhUQLwznkQMVIKbQRAV/45RKDJoAHcIQMhiwjUQwjQscer3hYh0BWBxhhCNCzej/ZZx9FuIsolHLbMFUWfAXIUviAY2ecKOUVjMTIoXH8EmAwhRSA/Cuoj/c255pHot33uQw6A5QFku5cLQGAjMSDmLCcw4BImixUaCDCZkntuwGtPCcABCx6nHBJkVDg7qSuvwEoAcQDIBPi9MTIAKyt59rcKyGWWHCr9IvJ4kv2NAII8gIC1Wwqs1wUAoi0yEABrx82UP+sGziCFDsgkHLDyBN1N80gjqCLg+CkQJOPqdn4BUOhEniENVJtE/2x8TduRa/IAmT1WBMSzxomO8yj7P/65r1YCotIPn0m8j28BFpVvwGdkoCRf2/gOd1k3MNgImIEEyBZZYEKJugVrHYEoi3EsTSzu5HEIZCCFyuQPnMIl4If7kgVMtt0hUkOCMj5XgVex7VM2XU3IlEAQxyPDdP0//n3GlYAh+FWs370OXBbbqWSfblNxAlbbsuUPyMLLBeA9YLafTZruB8+AO2vps+32650Flqem4b4T1d881oyreWICqJLL1e2XjQDkjUDkmX+d5WffEVeWE0CBNJU/qfq6f0eQBdVv/Qw1tdyCBWzGsDJGqBIZgiCAzjqK0kQ6A1hnjOGBNUEwIUmd5AAqxyndB0PFw7nkOAY9R5ePf+9XSUBGBAJudAVt234Ttn37xi4ESGyTE0rnAIBtBqwfAD/+Zl68r8nGdA3RykEsy2TtfJYkKsfWk+wM4GavJwnA2fj/CDCPgqzSPwoLov1HSOUVAeBKwGgtgJH80+AfbL8OC9A66Od0gFy0UiuCa+Sjt0cKboYQRGmHsR0w4vmGE0GRltk+AapuIlTbG9dcDh8mxpkCauL6wt/eUcojfY8AUiv0Wd+tc3ogAA/8xsKfDuykTVP2/YO1GlCLNnUCiii0Cpu7LUfgjUf2WTG/JgXLORwFtbkE2VLQRNKPTgiHjNKASBw7PZZ2J0Vnc+Q4ugsk6gAAG0BJREFUVVKKQH/muZxKCp/4Xv3DQGLn0fI3sEerAPVTghAaaFyllgcDi1Asq43t6yzwI2IIKgHiOFKWjZyjZ3XZBMuAOJqYbTJVwwuDfIb/l8FR2cy5VX6Ts0HmZdunz90i7eClJZnjZdoMv1EjAMcFbLiYAT+x8TpX0DCeAHPXxAA5XTug7YiW7on9NPYPwgLtEEKiSNjcTg2y4YSehCeBv+xUZid98ne5khCmwHaQDGeOGfVZVgKwqgAiiBH4U2XAfTCco1qxNcAZxiOAm+J/kSvwEoYU4Anl325ath0hr5BYNPDYq9Sr4LzY+reJfBZZVa/vhPYRGGf2Z/p4bZZPfM++CmCFAF4YIETR/upnApw3AqUJAQ4ShQPD/ovA3wjdANDwwxvKZbVjN45uSwI427eqnIywpsbIKOT7iAAy4Ix+p5kxMn2kzSsCCKoA+AiwJoOOAJTtF8vPSAK3NSFLhAJdPwLuTKiwHc8jhsx+1YaGBSRxJdeadQgWETBVTJNG0mVEE3TbXww9yg6lmPzL/gapawNSitpXgIdcF40783tlzmUd94EAEiVAuc8m+HWOoCH61fxAy19R/mplAElHicqrryeD3wM1fVkpm1gBkOgxHEV0gZA4VnpiFlQ5MzHNNoXjpM+9APBozKuI59BvpgAwJgE/B0KA6CWgrP7vZP4bWcBJZJYEI1FYQuzlAtw8gTFg2jXs12I+diz7gQA9tu/2GaRkOQvrfYapiZgNR6znyMn1zQCkpG7GOZfG0PenQAAZIM6cS2bcq9osnxAC0C6AgH14+Ie9EIQQwoY5FRo0HAbbKY5In3Yf2QtHEGVWiGEAVhHow1cHPHgeJnAZqAIll3GrSUdKBkdyBmQF41WTsxv3LMK6mAAe5bdwSKt6/AcCMEIAmevrbz88A7Dv1CofVQQ66w9ftAJrMdSuAHD46ucIiEGDeRDcKCwgB43KgZYa47l4biIav0QyybjfOufhWGcRiQHK7nivKQFUATcQ+Ylgnhl7+cT3sEOARgDO038dATjZ/w74AKTM9q05AScjBY8YEHRVy4/Kr4mEKZXbRnaSa/IAvR3HISk3CZkkr3AMOPeM3c2SiTtWAfyzgDyz3+xYZ/6e6XPoCMBZ9tuAboB8cALKIbT5x54H2CeVBrkGOHUFHjFQNlBJ6wnVZ+AWgogA3Fg6cVymuJ1zME/kYQdT0CwgXTUpEFdmUodtCgQQjrVf2NXtMuNn2lTu18x4rxyACgO8sp+n+ts+A+Rs+a+0Z1jFfXS/ASLLGQxjJEAYlgpn1FwdN0UazloDD6wR4aQVH4GTPP+ZCUkn/MmhxtWgsu7H7O9x5fkun/hsFQKw5B+AGsGfjfc9UrDIYjukmmjatlv4taoAFduvyccFWYJIvOSdFvIo7s8Avps0ScBaE606VoVUdFvL9byO4Inc2PvhnEcC2CfL+mf7p+P//ar1dgTsEA7AmJ1gFrZ36k36tXEjV8CshFwT3tEsqBPt2rDQNqX68GNl2kfEUQGmpcQR+VSOkQJIQf2vUMorxkxdd1R+hbl6aLzmAMhCnuEZAKPmrxW+EYAFcGtpsLM9dATgUrSiMvLQbSruYArQCaKIAJxyCjgxnGN6hGLuyy55npicFuEcJZSjAD7aPwvOK46TGfPBAej4nz3959T8B8VXYMR5aK4HIACOLD8DLZvzlp2nZiAB1G1+J9pVbD8jrdR6Awts5PymQL+Pf6j6EBCCNVHN/7iV/lgq6XkWCcn1k2NmwX2UxLLHyQBeLkPGXD7x3cccQGbdP1P9UPmt5CAAqiMLOVvD8re2XkjggHXASALUWfAzl4BzKLT0wblk+kdt0vuNc6lMbBPkhtU9tMpRgfUogGaApfmi8lsdPd9S/44ASLyPQEelZwlATQqIPU/56ctB1MtEGI61slP1NybvU4LfELBXmxMZfzZGxnGkQY8HgB9rxkVM9XkK0imqfYUYqgRYAnHBEelxXzkAJwcg4EOFz9p+5hSasBPlZuGCMgIPIkwmiN50RjWg+22zDsFxHRnwR21cEKtzjADvTUx0OzMgjsY2VbEI/iq4ps+L3JiKslfPszJ2pS2exwMBZHMA+8Re709HAGxxELTtnACgWZNIa5ew/APY9c0xngno+qlBXHxfDP7tBlaOwSZjsn+GFLZJciAMOUQYRQI4dKxHBvWVJDAz9vKJz4rXAYjidiHA/sPRtQDWE4LGOwIt1e+2KxvgEsD7DPyotNPqXwQNO84ApIkxI3IJwXryMcPjnUAAVeCd1f6MaxsJgNX9WXjgKbzlCIwyX7vn3jJhpZCUAGBjRBCKTzjukoraOlfbp04iooTk04mFic4I6QiwvQkvp+XlL44cewYkZwF0uDZ1D2Ztu76VR8ZZPv5ZDxpOwwDr+X9P4ZV9b66B2HodRmgXnHEGrc8Tgz98B4GF4wJp0Bud7B+BqDu9fcxMn6hNaT+5llL/IsnNkMNMn9eZUDYC0M/5I2jXzxqowzaw9l1bZzsCl1p9I1zQJCHkhffeVH+HJBgA9HwysZYE4TA/Z/sZziECi+clPAXOKg62y5xLFHJMjZFU2ciVnA30GRJ4jD7Lxz/zVQ5AwFVa/rt3osAv5gIQ3A+25OFuenbefV6AlBLZeBb4U/hMNSLQC8gonPyzx7Xq7gapyObwfKJx4SfIOJmzjveYQM78VlW7PktU2eseCSCI9wegW5Y/SQwakDpksPYLM1juofVTQHFxE71NKGkJQmyGDTyt9qsFGeCYo8N5ZcfJtnMnsvo9smNm2mWBUHU50bFnjvvYY67H6wiAvvLLyQPgk3xWqKCFRZSdAbdti5KBilws8YrcAd70cgxfJYtAYQPI97uPEog62DbxCmNGE7UKJjx2duwz2kVjXLl/hiAihzEz5isCCFYByhzRCj0A37H92xjE1neuwtmP/V1nQBYKWfMbQ40MCKvtD5EMO6ErgBqMGQGBnWa6z37sdPujoUYUipy4f9a+R0A/c9zl277bXgXYRQABjsDUIK0Anym7DiW0m2CCaS0ZHsggafuzYO6GSwCQNkn0CwnojDESYUwFjDjcTL9osVHZTTwigCMgvu77txCAEkCy7s9IAcHI3IIGNoJwIAV0ppmwYD+4xgn9HoCpAuIQl0aDsF9nH0J6KDWo2v5DKk86zxy/QjCZtq9Tm+hcrtq/EUCn9M4LQIYwYL+x5mpABUgK8H0jgmH47IC/U38Sl1fBnwV+GryzuYILwd+GTl5ENPmyzNONkzx2xg7PklP2ujLtHqtNdJxov3YljQBEibW1t7Y34CVW/Wngt3vv9MXxB4sPd5w5CBY+6PESTvihCUzU7JzF68uCwzrnSnKudCx1MZmJUxo/itWTP+bMeWX7PEW7s46ZGSdq00IA+uYfou4DkEG9vX2W7Weqz8gBccjcAQNPRfnNuUjcCQPB6a7BZIMqBI32SfBVjhZNtm6sxPFL48HglX5XtM2OeWa7zFhWm+VbP6NPAgrYXOX3VH8fwFT9qEqg+rvq76izRxQZfEVlQXcOJ4nDBdgZY6TZKoZ6ZpLFo4iq8JZHj1Htf1X7K8bNjDnTZiCAyPLPxvs4LnUEiaW/HaifCPyReEXEkSGfM22/nO82OaKTTyP4QMOLQo/M5NdnfXWf6viZ9pk263Vm2m0hwOoAUK3NxUCBsrvEkFH9YI1AN3+zFYHki0M6UBog8bCDYcth0SUHOgW3pwxyAPiJ9wvMjp6Z7Gzsx+pXPU62/RntGgFYyt/IQVnS9au3DwHL6vc6RIjWASDIBntvOMvsSkAPwBZuuu0HQBuNUwUFPd+LwZ+diFc4kPSxyQ/52H2rx6u0z7bV7ZZvkRyAEddr694BP3IFmXyAE/NHlt8iAv2fjXju1wJ/Cvhq4AzOzDZO58y4mXxClUxObX/4IvqzyU547xqOjnGkf7VvpX2p7bd8eCIJKIpLXAFTfq322jl0feCOee00qC2HYIHfUt408GFgb26n5v0JawVmiOVUgHuDpX6E+GwqEzseLRcnXz3OzDVV+3jtl5UAEKAIOhO40WO+mZifOA5KBEG7DuCJhUADIcDkZPPUJIQDil21/dP4KXYsNs9g46HNgYGrkz1/UucRwHrMo+c527/abwwBdgLoSIAou1bjSNU98jD/81Ct/t7/IyAuRPocAH9F9be2pEM0x+l+tTEag03u11H55Zy2yTZzURUUH2xbBVDmcEfGfOy+yzfrEMBaCrzfTAbsiBwyYcGg/oSEAOu9sKi2oe2fUP3WJQnacN4XbH84lp6VB9xJZoKn25RPPD3yaQ2PAC5zEkfHP9I/03cjAAbgAegHFv9YBMEsPyqsPgcNbNaWgb+bh4QsNLHgjWV9Q4IxZoZFIubxghmWcRWZSVrgj/xwb8Df/VYZMEY/7hVjPBAAgIIqvKHGkfJ3Y0UEsl99+L4AaQcoxLmm593Z4Gfz2pvrw76kg5giBXIiV+EwHDdsEE336/efAaiZszzzuEfHWr7508k7ARXIEMjMGZhKnnkpKGnDxhu2ESWfAX8K0Jn/ZwBmgjn3E7Y/i5uIWDITM3uszFgdYV01cPVEgvZHwXP0dK46fmXc5Zs+nZcBN8BFqn10v7H8V5NMZ7kTVYHBoicBTMkgqaqhC3AaRHiJ9m8TccJZeBM4dUw2wIHrjABVmdjkJ2nDV8eJzuus/VeelzX2RgCDwnuLghxV74CbedQ3Uy5MvBQkUn53P7odreIJUFnzvdueGKdq+b3xLwF2NqE/zRxnweiDNc6VpLD+Uo0AGnjBWg92f6dVur2yNFhA59h4nEfb5+T6fw2MCPxU9ZV8mG3UXKNzn1yjnqIRZtz9RXIpinaIplkiCgd+08D9Bc4ihuUbMQRQkzXrDBAv4UNBcllR+IDK/Ejgb5MZZnVEIJ7V9J4M9EAdEUI7ZqZhVrkzZJawFslTegPvR/gFMiSxEYBW2PX7oPIROWTe+JsIHzoygS/6fDTwjiq/Bv8s8BmJAOfR2x6BxnMW1dDBIyxrTkbnt/VzGqX6PwIgjhxCX0MGXEeO9xh912t4IIAo5nfAj2o0kAaqeDLb341hHNcDf/QEoAvsI8lCA4nW5D/iAE5558ABxR/O/SDCD3a/DCuZ83q/E8HyDZ/mVAF2pCEoKcizdj5DJEIaVfAnlgJXwT/lApxS3wzoM2DLTNSK8mfHE+UvtS/A9apxM6fwlMeW81vJ5WrnsREAA/W2LQHsVMyfGKez/gr8Q1ignEXm8V8PzFXXYIHJUmY2mWbIwPq/EvWEzkzeTJuQNMgg2XEzIJwJb6rjHgp7zjrYI43D3MryX8EBWHZ+VvUtEmGAbseAGUSPWwT/2apvglntOAv0bRwDWRnAXdYmM/BkEvKpgZm8tEeC7nWH6QhgRvVdkColt9rKcT1ioC4gsP0V8LttjUnMwFkBvjXJhu2EFGcBEk3saL8cN5uHmD3PaMpnzzMax9v/GMc4cn5n9N0IANXXBWnmPQCi0Enwb8AO2mbAXwFw1fJXiKQBxLg7FYJAR8aGiyboZfvVwNFxMhN1ZoyZPplzie5hZYzXve3y9RICEBAOZJAEdQnQxpiuG3DWBWA//RnJhu5TdyskFTIDKwBPtU2qfwQGb3/Ut/utEo0TTUxczPSd6ZMF5pVjZ88hanfkHDcCiAC7HSAqFQJthi4icAlU8YMyImPtAcAOmLBtCHzCHikwR6GEvtMnVxQY6ZFD2vMt8TDTjFN5yj5Xgisa29t/BNSV4y5f/6nj04ADABNZfI8kqJor5XcVPwF+D7RybimSgF/PHDNQ5YhAPCC2vkl3EYF6VvlpP7VxZpJW+lTasntbAYLVduYcKse9evzoXJav+9RX6wBkMnUKfgH4U+VFDcTkcmANCAR/SBIF8M+CPOUUCDnijZwB9UyfDlSJmZpo0s3HTPtMm7McRMkNRcgK9s9e18HDDt03AugArx7qMfftQ0XKP+MmvD4U4HguhDi8PpV9mfUGTJFToJdrMGaGNWHO2u46iYCQjgAwC4RsuyxRZoA0c8xo3CvGjI7p3dvla4kD2Dqom06JIOsOEs8A4A9jOZCzwV9yBKpxBtSZNt01JY5h3cwzicA7p84VZGZech1AFhjZdjPneYTIop+iet7ReGed60YAFuBc9T8R/IPiF2N+Rh6RWtM+xEmIw/EmlEckacA6KnsGuL0JaO5LJv2ykztqF+2fBXV23LNApcc5cnyPCM4Yd/kv6ACyoM62q7wSTD+BaDiQlAuYLBNSIBeAGRGBSQbkTlZAf0bb4dySbqQ62TOTNtPGDVkIarJjnkkCR45Z/V1nHMPa5xUBwEQ/TfnhF3DHJC8TYa7gKPhLqg8Hi4Bd3W9ZbDZhzgB3ZYx2bs7szUzsqM3R/Y/pBqJzPZM0HgP4eD0bAaTi/WxeoBDvD6SQIAzG/K1bslJgEUF3o48+XUhi32EiFev8WYKYAjzOPBCDSFkicHj7o75Zlc+MQy4vurS2vzp+9ryvtveZ81i+5lPGMiBT3zRJ7J3Tig9UHvVxHYC6SxmQm22csVwC2q8lcgTbGGRWHQF4tq83KbYxjNkegWAW6NG4mUk84wYyx50Zt3K+FgFUzu2o+9gIIALeVeBHuxmdQxb8VeAP48IAEZCn9zvHsCZQFuDZdvQ4CeWPJudTE0F0fjNOoDLmEQKoHmfmWjRhLF8dOQA1KVygFpKDrwP4B7IwgDkNdOYIDJBlgXt2O7wPenJEE3IG7DN9qhM9Ou8rx5slgMo5zzoT5hY2AjBBfTL48cfZhs6+OhzOvANtArBpR5AA5mEiIHc5GjPrCLLEcIXyW5O3uj07sTNgybTJgjU7Vna8KtEebe/1X/6z5QAmwT+AnL1g9CD4hTzcsMAiDba9mPCLQEv3G2RlTfoMoDNtvEnZ+quBZlR6Buwzx7lCvTMAz7SZIYDsuFlyZCrvnddGAIMDCMDfgbxCFIkKgUcg2q6m1X3/VWj7yTUD7Ec1iSHhLrJEcAT0dLIVKxHRRKwSQQSAq/dH15PdX2030z76LRj4oz7LV2kHQJRqIAgB1GOD31DRChF0bR3lM8GcKO91fYvuwmJr73y8yeQSRlL5zwL1rOJHk/jo/oxyR8e4GtDZ41fPoyeAQhKvVBk4Q/kD8FdIYLvhCTLxQozIAWzDBwCLQB3tj87BnQwTyl8hgkrbzKSNAHD1/gxJZNtkrhfVPLo2rfyV9hsBlMH8RMpfBjn8MpbyZ8asEEEbT/1GFZWOgB/tD13EBcpfBfwVbiCa+FfvrwA7OpfKWLNksZ7D8p8+lFwI9AS2H1U0A1Rp47YlwLTaTwF/7xSB9Oj+I+pfeX15SCYGyWYm5etGAhlQPmabqxwFjrsRgAaO+f0k5ccTcI+dBGuaHJLjReByCSNQ16PAj/qHgIUBKqrN2h7tH6ncFQQRgSoCeLQ/Gj+65gxxasufPSZrt/zHrAN4jcCfBjyG4RPPCZQdgAOuCLgeqUSEFIIeZt0VQD46pjeBryCBCMRX788CNjqPCplYx9wIIHQAB8GfVvwT3gNAgTQBflflme0l7qJCIDMgzwCvtQmcSZpECi82rTiECBTVsWbHi/pl9kdtzgT20bGW/xA5gNcc/K4bOAh8D8DdD3/kPygplhVLoL9Q+TPnESlUFdTV9rPOIgLw0f1HQRv9rjpE8I63EYDpAF5D8LuAP2j5o7GpSkMn/UNXvlfaZtxCa3Oh8lcAWWk7C9yzjpEFmAes2X3ZY2dIKNNm+feWA3hC8FeASNuS9QxZNbeOTfur38i6edkxI2BnVFc7kyPWPnO8yvhntI0m9WOSwBGQRy7g6P4skWwEMDiASfDjzTFdxX5m3f4CYCNyyCzwicZIkQUBv6fiFYWvtDVB9cjKnyWLqrqfBehZsM4CcbZfFrjR+BFRynGWf6cdwCT4GahSJBCAPwJrtx++6GOnQK3icVO5T3p+oAL0qG13fYScvImVAW/p+CoIzYxfPb8qkUSAuIIgZseMzjWzP9NmPb+NABpYXgPwlwAPE02vZjwT8BHJsMn7ZG6AzLoMAM9qU7H5Z6j7GWNkVLd6nCwAFVe2r5HCn7V/+crVAVSeAUALbyjhrPJ7LsIC9NaHKN4lDsBQVtMpOI7CIyg2ebxjzKr/DOgzfSok8NhtI2CeCfQjID3SN7pG3L985cvEOgAE/ZFXfSceCio7AMO1uIShriflFhySqQL2DMKgx0yofwbAnnupALYCpsx5PUaY8H4ILSoAjxzG8hUvi88C7Ee3VB5PjrZJuA02BgVp4EBSwM7E/cn1BBVV90A2tQ86RQCOCCuz/ygRZAF/lETOBLSnypXz9Igssy8igIp7WP7tTgAhcCfVuyOBE8DfLq4A/shVuERhAGsKpBeFBNH/gmRNqogoov2PRQJHj/MYJDBDDkeAPHs8fcxGAJaiVwHMwLZtS4Df7Kst+8HKgQX44fj7hizYz24XKbH8rmjzItAe3R+dU9WmZ53AB5UEZoE8228ggH+TdQAFADMgpQhGAZ0SAlHkSOGj/VZ4MRNCZPvMtuv6JQgqA9gqKWTBmAV3tl32uGcpvgWy6vZZpT8L5CgQlAA85a2qtwZ6RflDB5AEfwT4aL+21Fb7LIhn+kfAzfzHIhVgR22j8zmq/BVQZc61SgKV41fH9n6bWXI4q9/y5SoJiAMfBb9Xm7ccwXB8cQVE7QayIW8groI0s5KwOmYEHm9Cm/suUP+MEp/V5oiaV8B6VdsZEphR9Jk+FXLYCMAE0oTtb2OpCZoBq+kAjLFMsgDP4x33TOsfugohMnJuEUEM56lmRaSIV+/PnP8RwGfHrxzjyrZnksPlBPBlRhlwxrpnwW8CnWXJC0RymBCS5b4zwV5Wf+hwBNhH+lqW9rHdwVF1P9r/dQZ6ljiWlQC0SjIbPLRRilYFv0cC7Yc9WOrLAFWf94y9n+ljnZurdie8YnzquMS9PAUJHAVshqCs63oMsFeuzzvPaB8eZ/lS7QCU4jJVNckgUGurH1XuiVJfilSYFTdUtUIgR0nA67/tU7OjouBll2GEKVnQZ4EWXUPFps8es3KM15EEskoPt3T7KP02AojUO0UCk+CnoCWAzII7Au2w3yG8o6COzoUBioKCnKPrFBjJqRlQcQLVY2WJIjNuBaCvIwlUVX0G0NVjdATwMXEAAYBdEnhC8Ecgc/efGPNH5xFNdhOQRdt/ptpHCh3tj675CFE8JTFUjv2UriFz7GUlgOp/DNKRwUHwdxPfUeMjDoCCq5BfOOoEZvpr2x+BLavolXEyAM6obnTMzHEqoMuc09HxKv2rbTPAVYZO/ydUbXfkKP4/BnecprBuissAAAAASUVORK5CYII=',e}();d.TextureTools=e}(e||(e={}));var e;!function(g){var e=function(){function T(){this._mode=T.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=[],this._betaIsAnimating=!1}return Object.defineProperty(T.prototype,'name',{get:function(){return'Framing'},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'mode',{get:function(){return this._mode},set:function(t){this._mode=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'radiusScale',{get:function(){return this._radiusScale},set:function(t){this._radiusScale=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'positionScale',{get:function(){return this._positionScale},set:function(t){this._positionScale=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'defaultElevation',{get:function(){return this._defaultElevation},set:function(t){this._defaultElevation=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'elevationReturnTime',{get:function(){return this._elevationReturnTime},set:function(t){this._elevationReturnTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'elevationReturnWaitTime',{get:function(){return this._elevationReturnWaitTime},set:function(t){this._elevationReturnWaitTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'zoomStopsAnimation',{get:function(){return this._zoomStopsAnimation},set:function(t){this._zoomStopsAnimation=t},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,'framingTime',{get:function(){return this._framingTime},set:function(t){this._framingTime=t},enumerable:!0,configurable:!0}),T.prototype.init=function(){},T.prototype.attach=function(e){var o=this;this._attachedCamera=e;var t=this._attachedCamera.getScene();T.EasingFunction.setEasingMode(T.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(function(e){return e.type===g.PointerEventTypes.POINTERDOWN?void(o._isPointerDown=!0):void(e.type===g.PointerEventTypes.POINTERUP&&(o._isPointerDown=!1))}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(function(t){t&&o.zoomOnMesh(t)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){o._applyUserInteraction(),o._maintainCameraAboveGround()})},T.prototype.detach=function(){if(this._attachedCamera){var t=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&t.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}},T.prototype.zoomOnMesh=function(o,e,t){void 0===e&&(e=!1),void 0===t&&(t=null),o.computeWorldMatrix(!0);var i=o.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(i.minimumWorld,i.maximumWorld,e,t)},T.prototype.zoomOnMeshHierarchy=function(o,e,t){void 0===e&&(e=!1),void 0===t&&(t=null),o.computeWorldMatrix(!0);var i=o.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(i.min,i.max,e,t)},T.prototype.zoomOnMeshesHierarchy=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i=null);for(var r=new g.Vector3(S,S,S),n=new g.Vector3(-S,-S,-S),o=0,s;o<e.length;o++)s=e[o].getHierarchyBoundingVectors(!0),g.Tools.CheckExtends(s.min,r,n),g.Tools.CheckExtends(s.max,r,n);this.zoomOnBoundingInfo(r,n,t,i)},T.prototype.zoomOnBoundingInfo=function(e,t,r,i){var o=this;void 0===r&&(r=!1),void 0===i&&(i=null);var n;if(this._attachedCamera){var a=e.y,s=t.y,l=a+(s-a)*this._positionScale,c=t.subtract(e).scale(.5);if(r)n=new g.Vector3(0,l,0);else{var u=e.add(c);n=new g.Vector3(u.x,l,u.z)}this._vectorTransition||(this._vectorTransition=g.Animation.CreateAnimation('target',g.Animation.ANIMATIONTYPE_VECTOR3,60,T.EasingFunction)),this._betaIsAnimating=!0;var f=g.Animation.TransitionTo('target',n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);f&&this._animatables.push(f);var d=0;if(this._mode===T.FitFrustumSidesMode){var p=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ,d=p}else this._mode===T.IgnoreBoundsSizeMode&&(d=this._calculateLowerRadiusFromModelBoundingSphere(e,t),null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));var _=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/_,this._attachedCamera.wheelPrecision=100/d,this._radiusTransition||(this._radiusTransition=g.Animation.CreateAnimation('radius',g.Animation.ANIMATIONTYPE_FLOAT,60,T.EasingFunction)),f=g.Animation.TransitionTo('radius',d,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,function(){o.stopAllAnimations(),i&&i(),o._attachedCamera&&o._attachedCamera.storeState()}),f&&this._animatables.push(f)}},T.prototype._calculateLowerRadiusFromModelBoundingSphere=function(t,e){var i=e.subtract(t),r=i.length(),n=this._getFrustumSlope(),o=.5*r*this._radiusScale,a=o*$(1+1/(n.x*n.x)),s=o*$(1+1/(n.y*n.y)),l=W(a,s),d=this._attachedCamera;return d?(d.lowerRadiusLimit&&this._mode===T.IgnoreBoundsSizeMode&&(l=l<d.lowerRadiusLimit?d.lowerRadiusLimit:l),d.upperRadiusLimit&&(l=l>d.upperRadiusLimit?d.upperRadiusLimit:l),l):0},T.prototype._maintainCameraAboveGround=function(){var e=this;if(!(0>this._elevationReturnTime)){var t=g.Tools.Now-this._lastInteractionTime,r=.5*V-this._defaultElevation;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>.5*V&&t>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=g.Animation.CreateAnimation('beta',g.Animation.ANIMATIONTYPE_FLOAT,60,T.EasingFunction));var o=g.Animation.TransitionTo('beta',r,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,function(){e._clearAnimationLocks(),e.stopAllAnimations()});o&&this._animatables.push(o)}}},T.prototype._getFrustumSlope=function(){var e=this._attachedCamera;if(!e)return g.Vector2.Zero();var o=e.getScene().getEngine(),i=o.getAspectRatio(e),r=y(e.fov/2);return new g.Vector2(r*i,r)},T.prototype._clearAnimationLocks=function(){this._betaIsAnimating=!1},T.prototype._applyUserInteraction=function(){this.isUserIsMoving&&(this._lastInteractionTime=g.Tools.Now,this.stopAllAnimations(),this._clearAnimationLocks())},T.prototype.stopAllAnimations=function(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()},Object.defineProperty(T.prototype,'isUserIsMoving',{get:function(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)},enumerable:!0,configurable:!0}),T.EasingFunction=new g.ExponentialEase,T.EasingMode=g.EasingFunction.EASINGMODE_EASEINOUT,T.IgnoreBoundsSizeMode=0,T.FitFrustumSidesMode=1,T}();g.FramingBehavior=e}(e||(e={}));var e;!function(o){var e=function(){function e(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=[]}return Object.defineProperty(e.prototype,'name',{get:function(){return'Bouncing'},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'autoTransitionRange',{get:function(){return this._autoTransitionRange},set:function(r){var o=this;if(this._autoTransitionRange!==r){this._autoTransitionRange=r;var e=this._attachedCamera;e&&(r?this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(function(t){if(t){t.computeWorldMatrix(!0);var e=t.getBoundingInfo().diagonalLength;o.lowerRadiusTransitionRange=.05*e,o.upperRadiusTransitionRange=.05*e}}):this._onMeshTargetChangedObserver&&e.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}},enumerable:!0,configurable:!0}),e.prototype.init=function(){},e.prototype.attach=function(r){var e=this;this._attachedCamera=r,this._onAfterCheckInputsObserver=r.onAfterCheckInputsObservable.add(function(){e._attachedCamera&&(e._isRadiusAtLimit(e._attachedCamera.lowerRadiusLimit)&&e._applyBoundRadiusAnimation(e.lowerRadiusTransitionRange),e._isRadiusAtLimit(e._attachedCamera.upperRadiusLimit)&&e._applyBoundRadiusAnimation(e.upperRadiusTransitionRange))})},e.prototype.detach=function(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)},e.prototype._isRadiusAtLimit=function(t){return!!this._attachedCamera&&this._attachedCamera.radius===t&&!this._radiusIsAnimating},e.prototype._applyBoundRadiusAnimation=function(t){var i=this;if(this._attachedCamera){this._radiusBounceTransition||(e.EasingFunction.setEasingMode(e.EasingMode),this._radiusBounceTransition=o.Animation.CreateAnimation('radius',o.Animation.ANIMATIONTYPE_FLOAT,60,e.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;var r=o.Animation.TransitionTo('radius',this._attachedCamera.radius+t,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,function(){return i._clearAnimationLocks()});r&&this._animatables.push(r)}},e.prototype._clearAnimationLocks=function(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)},e.prototype.stopAllAnimations=function(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()},e.EasingFunction=new o.BackEase(.3),e.EasingMode=o.EasingFunction.EASINGMODE_EASEOUT,e}();o.BouncingBehavior=e}(e||(e={}));var e;!function(a){var e=function(){function e(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}return Object.defineProperty(e.prototype,'name',{get:function(){return'AutoRotation'},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'zoomStopsAnimation',{get:function(){return this._zoomStopsAnimation},set:function(t){this._zoomStopsAnimation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'idleRotationSpeed',{get:function(){return this._idleRotationSpeed},set:function(t){this._idleRotationSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'idleRotationWaitTime',{get:function(){return this._idleRotationWaitTime},set:function(t){this._idleRotationWaitTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'idleRotationSpinupTime',{get:function(){return this._idleRotationSpinupTime},set:function(t){this._idleRotationSpinupTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'rotationInProgress',{get:function(){return 0<A(this._cameraRotationSpeed)},enumerable:!0,configurable:!0}),e.prototype.init=function(){},e.prototype.attach=function(e){var s=this;this._attachedCamera=e;var t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(function(e){return e.type===a.PointerEventTypes.POINTERDOWN?void(s._isPointerDown=!0):void(e.type===a.PointerEventTypes.POINTERUP&&(s._isPointerDown=!1))}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){var e=a.Tools.Now,t=0;null!=s._lastFrameTime&&(t=e-s._lastFrameTime),s._lastFrameTime=e,s._applyUserInteraction();var r=e-s._lastInteractionTime-s._idleRotationWaitTime,i=W(C(r/s._idleRotationSpinupTime,1),0);s._cameraRotationSpeed=s._idleRotationSpeed*i,s._attachedCamera&&(s._attachedCamera.alpha-=s._cameraRotationSpeed*(t/1e3))})},e.prototype.detach=function(){if(this._attachedCamera){var t=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&t.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}},e.prototype._userIsZooming=function(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset},e.prototype._shouldAnimationStopForInteraction=function(){if(!this._attachedCamera)return!1;var t=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(t=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?t:this._userIsZooming()},e.prototype._applyUserInteraction=function(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=a.Tools.Now)},e.prototype._userIsMoving=function(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)},e}();a.AutoRotationBehavior=e}(e||(e={}));var e;!function(d){var e=function(){return function(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}}();d.NullEngineOptions=e;var t=function(t){function o(o){void 0===o&&(o=new e);var i=t.call(this,null)||this;return void 0===o.deterministicLockstep&&(o.deterministicLockstep=!1),void 0===o.lockstepMaxSteps&&(o.lockstepMaxSteps=4),i._options=o,i._caps=new d.EngineCapabilities,i._caps.maxTexturesImageUnits=16,i._caps.maxVertexTextureImageUnits=16,i._caps.maxTextureSize=512,i._caps.maxCubemapTextureSize=512,i._caps.maxRenderTextureSize=512,i._caps.maxVertexAttribs=16,i._caps.maxVaryingVectors=16,i._caps.maxFragmentUniformVectors=16,i._caps.maxVertexUniformVectors=16,i._caps.standardDerivatives=!1,i._caps.astc=null,i._caps.s3tc=null,i._caps.pvrtc=null,i._caps.etc1=null,i._caps.etc2=null,i._caps.textureAnisotropicFilterExtension=null,i._caps.maxAnisotropy=0,i._caps.uintIndices=!1,i._caps.fragmentDepthSupported=!1,i._caps.highPrecisionShaderSupported=!0,i._caps.colorBufferFloat=!1,i._caps.textureFloat=!1,i._caps.textureFloatLinearFiltering=!1,i._caps.textureFloatRender=!1,i._caps.textureHalfFloat=!1,i._caps.textureHalfFloatLinearFiltering=!1,i._caps.textureHalfFloatRender=!1,i._caps.textureLOD=!1,i._caps.drawBuffersExtension=!1,i._caps.depthTextureExtension=!1,i._caps.vertexArrayObject=!1,i._caps.instancedArrays=!1,d.Tools.Log('Babylon.js null engine (v'+d.Engine.Version+') launched'),'undefined'==typeof URL&&(URL={createObjectURL:function(){},revokeObjectURL:function(){}}),'undefined'==typeof Blob&&(Blob=function(){}),i}return h(o,t),o.prototype.isDeterministicLockStep=function(){return this._options.deterministicLockstep},o.prototype.getLockstepMaxSteps=function(){return this._options.lockstepMaxSteps},o.prototype.getHardwareScalingLevel=function(){return 1},o.prototype.createVertexBuffer=function(){return{capacity:0,references:1,is32Bits:!1}},o.prototype.createIndexBuffer=function(){return{capacity:0,references:1,is32Bits:!1}},o.prototype.clear=function(o,e,t,i){void 0===i&&(i=!1)},o.prototype.getRenderWidth=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth},o.prototype.getRenderHeight=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight},o.prototype.setViewport=function(t){this._cachedViewport=t},o.prototype.createShaderProgram=function(){return{transformFeedback:null,__SPECTOR_rebuildProgram:null}},o.prototype.getUniforms=function(){return[]},o.prototype.getAttributes=function(){return[]},o.prototype.bindSamplers=function(){this._currentEffect=null},o.prototype.enableEffect=function(t){this._currentEffect=t,t.onBind&&t.onBind(t),t.onBindObservable.notifyObservers(t)},o.prototype.setState=function(o,e,t,i){void 0===e&&(e=0),void 0===i&&(i=!1)},o.prototype.setIntArray=function(){},o.prototype.setIntArray2=function(){},o.prototype.setIntArray3=function(){},o.prototype.setIntArray4=function(){},o.prototype.setFloatArray=function(){},o.prototype.setFloatArray2=function(){},o.prototype.setFloatArray3=function(){},o.prototype.setFloatArray4=function(){},o.prototype.setArray=function(){},o.prototype.setArray2=function(){},o.prototype.setArray3=function(){},o.prototype.setArray4=function(){},o.prototype.setMatrices=function(){},o.prototype.setMatrix=function(){},o.prototype.setMatrix3x3=function(){},o.prototype.setMatrix2x2=function(){},o.prototype.setFloat=function(){},o.prototype.setFloat2=function(){},o.prototype.setFloat3=function(){},o.prototype.setBool=function(){},o.prototype.setFloat4=function(){},o.prototype.setColor3=function(){},o.prototype.setColor4=function(){},o.prototype.setAlphaMode=function(e,t){void 0===t&&(t=!1),this._alphaMode!==e&&(this._alphaState.alphaBlend=e!==d.Engine.ALPHA_DISABLE,t||this.setDepthWrite(e===d.Engine.ALPHA_DISABLE),this._alphaMode=e)},o.prototype.bindBuffers=function(){},o.prototype.wipeCaches=function(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},o.prototype.draw=function(){},o.prototype.drawElementsType=function(){},o.prototype.drawArraysType=function(){},o.prototype._createTexture=function(){return{}},o.prototype._releaseTexture=function(){},o.prototype.createTexture=function(e,t,p,r,n,o,s,a,l,f){void 0===n&&(n=d.Texture.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=null),void 0===s&&(s=null),void 0===a&&(a=null);var c=new d.InternalTexture(this,d.InternalTexture.DATASOURCE_URL);return c.url=e+'',c.generateMipMaps=!t,c.samplingMode=n,c.invertY=p,c.baseWidth=this._options.textureSize,c.baseHeight=this._options.textureSize,c.width=this._options.textureSize,c.height=this._options.textureSize,f&&(c.format=f),c.isReady=!0,o&&o(),c},o.prototype.createRenderTargetTexture=function(e,t){var a=new d.RenderTargetCreationOptions;void 0!==t&&'object'==typeof t?(a.generateMipMaps=t.generateMipMaps,a.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,a.generateStencilBuffer=a.generateDepthBuffer&&t.generateStencilBuffer,a.type=void 0===t.type?d.Engine.TEXTURETYPE_UNSIGNED_INT:t.type,a.samplingMode=void 0===t.samplingMode?d.Texture.TRILINEAR_SAMPLINGMODE:t.samplingMode):(a.generateMipMaps=t,a.generateDepthBuffer=!0,a.generateStencilBuffer=!1,a.type=d.Engine.TEXTURETYPE_UNSIGNED_INT,a.samplingMode=d.Texture.TRILINEAR_SAMPLINGMODE);var r=new d.InternalTexture(this,d.InternalTexture.DATASOURCE_RENDERTARGET),n=e.width||e,o=e.height||e;return r._depthStencilBuffer={},r._framebuffer={},r.baseWidth=n,r.baseHeight=o,r.width=n,r.height=o,r.isReady=!0,r.samples=1,r.generateMipMaps=!!a.generateMipMaps,r.samplingMode=a.samplingMode,r.type=a.type,r._generateDepthBuffer=a.generateDepthBuffer,r._generateStencilBuffer=!!a.generateStencilBuffer,r},o.prototype.updateTextureSamplingMode=function(r,e){e.samplingMode=r},o.prototype.bindFramebuffer=function(o,e,t,i,r){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=o,this._currentFramebuffer=o._MSAAFramebuffer?o._MSAAFramebuffer:o._framebuffer,this._cachedViewport&&!r&&this.setViewport(this._cachedViewport,t,i)},o.prototype.unBindFramebuffer=function(r,e,t){void 0===e&&(e=!1),this._currentRenderTarget=null,t&&(r._MSAAFramebuffer&&(this._currentFramebuffer=r._framebuffer),t()),this._currentFramebuffer=null},o.prototype.createDynamicVertexBuffer=function(){return{capacity:1,references:1,is32Bits:!1}},o.prototype.updateDynamicIndexBuffer=function(r,e,t){void 0===t&&(t=0)},o.prototype.updateDynamicVertexBuffer=function(){},o.prototype._bindTextureDirectly=function(r,e){this._boundTexturesCache[this._activeChannel]!==e&&(this._boundTexturesCache[this._activeChannel]=e)},o.prototype._bindTexture=function(r,e){0>r||this._bindTextureDirectly(0,e)},o.prototype._releaseBuffer=function(t){return 0==--t.references},o.prototype.releaseEffects=function(){},o}(d.Engine);d.NullEngine=t}(e||(e={}));var e;!function(r){var e=function(){function e(e){this.engine=e,this._captureGPUFrameTime=!1,this._gpuFrameTime=new r.PerfCounter,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new r.PerfCounter,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}return Object.defineProperty(e.prototype,'gpuFrameTimeCounter',{get:function(){return this._gpuFrameTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureGPUFrameTime',{get:function(){return this._captureGPUFrameTime},set:function(r){var o=this;r!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=r,r?(this._onBeginFrameObserver=this.engine.onBeginFrameObservable.add(function(){o._gpuFrameTimeToken||(o._gpuFrameTimeToken=o.engine.startTimeQuery())}),this._onEndFrameObserver=this.engine.onEndFrameObservable.add(function(){if(o._gpuFrameTimeToken){var t=o.engine.endTimeQuery(o._gpuFrameTimeToken);-1<t&&(o._gpuFrameTimeToken=null,o._gpuFrameTime.fetchNewFrame(),o._gpuFrameTime.addCount(t,!0))}})):(this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'shaderCompilationTimeCounter',{get:function(){return this._shaderCompilationTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureShaderCompilationTime',{get:function(){return this._captureShaderCompilationTime},set:function(r){var e=this;r!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=r,r?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(function(){e._shaderCompilationTime.fetchNewFrame(),e._shaderCompilationTime.beginMonitoring()}),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(function(){e._shaderCompilationTime.endMonitoring()})):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null},e}();r.EngineInstrumentation=e}(e||(e={}));var e;!function(r){var e=function(){function e(e){var o=this;this.scene=e,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new r.PerfCounter,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new r.PerfCounter,this._captureFrameTime=!1,this._frameTime=new r.PerfCounter,this._captureRenderTime=!1,this._renderTime=new r.PerfCounter,this._captureInterFrameTime=!1,this._interFrameTime=new r.PerfCounter,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new r.PerfCounter,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new r.PerfCounter,this._capturePhysicsTime=!1,this._physicsTime=new r.PerfCounter,this._captureAnimationsTime=!1,this._animationsTime=new r.PerfCounter,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeAnimationsObserver=e.onBeforeAnimationsObservable.add(function(){o._captureActiveMeshesEvaluationTime&&o._activeMeshesEvaluationTime.fetchNewFrame(),o._captureRenderTargetsRenderTime&&o._renderTargetsRenderTime.fetchNewFrame(),o._captureFrameTime&&(r.Tools.StartPerformanceCounter('Scene rendering'),o._frameTime.beginMonitoring()),o._captureInterFrameTime&&o._interFrameTime.endMonitoring(),o._captureParticlesRenderTime&&o._particlesRenderTime.fetchNewFrame(),o._captureSpritesRenderTime&&o._spritesRenderTime.fetchNewFrame(),o._captureAnimationsTime&&o._animationsTime.beginMonitoring(),o.scene.getEngine()._drawCalls.fetchNewFrame(),o.scene.getEngine()._textureCollisions.fetchNewFrame()}),this._onAfterRenderObserver=e.onAfterRenderObservable.add(function(){o._captureFrameTime&&(r.Tools.EndPerformanceCounter('Scene rendering'),o._frameTime.endMonitoring()),o._captureRenderTime&&o._renderTime.endMonitoring(!1),o._captureInterFrameTime&&o._interFrameTime.beginMonitoring()})}return Object.defineProperty(e.prototype,'activeMeshesEvaluationTimeCounter',{get:function(){return this._activeMeshesEvaluationTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureActiveMeshesEvaluationTime',{get:function(){return this._captureActiveMeshesEvaluationTime},set:function(e){var t=this;e!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=e,e?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(function(){r.Tools.StartPerformanceCounter('Active meshes evaluation'),t._activeMeshesEvaluationTime.beginMonitoring()}),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(function(){r.Tools.EndPerformanceCounter('Active meshes evaluation'),t._activeMeshesEvaluationTime.endMonitoring()})):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'renderTargetsRenderTimeCounter',{get:function(){return this._renderTargetsRenderTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureRenderTargetsRenderTime',{get:function(){return this._captureRenderTargetsRenderTime},set:function(e){var t=this;e!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=e,e?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(function(){r.Tools.StartPerformanceCounter('Render targets rendering'),t._renderTargetsRenderTime.beginMonitoring()}),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(function(){r.Tools.EndPerformanceCounter('Render targets rendering'),t._renderTargetsRenderTime.endMonitoring(!1)})):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'particlesRenderTimeCounter',{get:function(){return this._particlesRenderTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureParticlesRenderTime',{get:function(){return this._captureParticlesRenderTime},set:function(e){var t=this;e!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=e,e?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(function(){r.Tools.StartPerformanceCounter('Particles'),t._particlesRenderTime.beginMonitoring()}),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(function(){r.Tools.EndPerformanceCounter('Particles'),t._particlesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'spritesRenderTimeCounter',{get:function(){return this._spritesRenderTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureSpritesRenderTime',{get:function(){return this._captureSpritesRenderTime},set:function(e){var t=this;e!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=e,e?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(function(){r.Tools.StartPerformanceCounter('Sprites'),t._spritesRenderTime.beginMonitoring()}),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(function(){r.Tools.EndPerformanceCounter('Sprites'),t._spritesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'physicsTimeCounter',{get:function(){return this._physicsTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'capturePhysicsTime',{get:function(){return this._capturePhysicsTime},set:function(e){var t=this;e!==this._capturePhysicsTime&&(this._capturePhysicsTime=e,e?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(function(){r.Tools.StartPerformanceCounter('Physics'),t._physicsTime.beginMonitoring()}),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(function(){r.Tools.EndPerformanceCounter('Physics'),t._physicsTime.endMonitoring()})):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'animationsTimeCounter',{get:function(){return this._animationsTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureAnimationsTime',{get:function(){return this._captureAnimationsTime},set:function(r){var e=this;r!==this._captureAnimationsTime&&(this._captureAnimationsTime=r,r?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(function(){e._animationsTime.endMonitoring()}):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'frameTimeCounter',{get:function(){return this._frameTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureFrameTime',{get:function(){return this._captureFrameTime},set:function(t){this._captureFrameTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'interFrameTimeCounter',{get:function(){return this._interFrameTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureInterFrameTime',{get:function(){return this._captureInterFrameTime},set:function(t){this._captureInterFrameTime=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'renderTimeCounter',{get:function(){return this._renderTime},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'captureRenderTime',{get:function(){return this._captureRenderTime},set:function(e){var t=this;e!==this._captureRenderTime&&(this._captureRenderTime=e,e?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(function(){t._renderTime.beginMonitoring(),r.Tools.StartPerformanceCounter('Main render')}),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(function(){t._renderTime.endMonitoring(!1),r.Tools.EndPerformanceCounter('Main render')})):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'drawCallsCounter',{get:function(){return this.scene.getEngine()._drawCalls},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'textureCollisionsCounter',{get:function(){return this.scene.getEngine()._textureCollisions},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null,this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null,this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene=null},e}();r.SceneInstrumentation=e}(e||(e={}));var e;!function(r){var e=function(){return function(){this._timeElapsedQueryEnded=!1}}();r._TimeToken=e}(e||(e={}));var e;!function(y){var e=function(r){function e(){var e=r.call(this)||this;return e.DIFFUSE=!1,e.DIFFUSEDIRECTUV=0,e.GAMMADIFFUSE=!1,e.DIFFUSEHASALPHA=!1,e.OPACITYFRESNEL=!1,e.REFLECTIONBLUR=!1,e.REFLECTIONFRESNEL=!1,e.REFLECTIONFALLOFF=!1,e.TEXTURELODSUPPORT=!1,e.PREMULTIPLYALPHA=!1,e.USERGBCOLOR=!1,e.USEHIGHLIGHTANDSHADOWCOLORS=!1,e.NOISE=!1,e.REFLECTIONBGR=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.REFLECTION=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.REFLECTIONMAP_OPPOSITEZ=!1,e.LODINREFLECTIONALPHA=!1,e.GAMMAREFLECTION=!1,e.EQUIRECTANGULAR_RELFECTION_FOV=!1,e.MAINUV1=!1,e.MAINUV2=!1,e.UV1=!1,e.UV2=!1,e.CLIPPLANE=!1,e.POINTSIZE=!1,e.FOG=!1,e.NORMAL=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.SHADOWFLOAT=!1,e.rebuild(),e}return h(e,r),e}(y.MaterialDefines),t=function(o){function a(e,t){var i=o.call(this,e,t)||this;return i.primaryColor=y.Color3.White(),i._primaryColorShadowLevel=0,i._primaryColorHighlightLevel=0,i.reflectionTexture=null,i.reflectionBlur=0,i.diffuseTexture=null,i._shadowLights=null,i.shadowLights=null,i.shadowLevel=0,i.sceneCenter=y.Vector3.Zero(),i.opacityFresnel=!0,i.reflectionFresnel=!1,i.reflectionFalloffDistance=0,i.reflectionAmount=1,i.reflectionReflectance0=.05,i.reflectionReflectance90=.5,i.useRGBColor=!0,i.enableNoise=!1,i._fovMultiplier=1,i.useEquirectangularFOV=!1,i._maxSimultaneousLights=4,i.maxSimultaneousLights=4,i._imageProcessingObserver=null,i.switchToBGR=!1,i._renderTargets=new y.SmartArray(16),i._reflectionControls=y.Vector4.Zero(),i._white=y.Color3.White(),i._primaryShadowColor=y.Color3.Black(),i._primaryHighlightColor=y.Color3.Black(),i._attachImageProcessingConfiguration(null),i.getRenderTargetTextures=function(){return i._renderTargets.reset(),i._diffuseTexture&&i._diffuseTexture.isRenderTarget&&i._renderTargets.push(i._diffuseTexture),i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),i._renderTargets},i}return h(a,o),Object.defineProperty(a.prototype,'_perceptualColor',{get:function(){return this.__perceptualColor},set:function(t){this.__perceptualColor=t,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'primaryColorShadowLevel',{get:function(){return this._primaryColorShadowLevel},set:function(t){this._primaryColorShadowLevel=t,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'primaryColorHighlightLevel',{get:function(){return this._primaryColorHighlightLevel},set:function(t){this._primaryColorHighlightLevel=t,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'reflectionStandardFresnelWeight',{set:function(r){var e=r;.5>e?(e*=2,this.reflectionReflectance0=a.StandardReflectance0*e,this.reflectionReflectance90=a.StandardReflectance90*e):(e=2*e-1,this.reflectionReflectance0=a.StandardReflectance0+(1-a.StandardReflectance0)*e,this.reflectionReflectance90=a.StandardReflectance90+(1-a.StandardReflectance90)*e)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'fovMultiplier',{get:function(){return this._fovMultiplier},set:function(t){isNaN(t)&&(t=1),this._fovMultiplier=W(0,C(2,t))},enumerable:!0,configurable:!0}),a.prototype._attachImageProcessingConfiguration=function(r){var e=this;r!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=r||this.getScene().imageProcessingConfiguration,this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){e._computePrimaryColorFromPerceptualColor(),e._markAllSubMeshesAsImageProcessingDirty()}))},Object.defineProperty(a.prototype,'imageProcessingConfiguration',{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraColorCurvesEnabled',{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraColorGradingEnabled',{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraToneMappingEnabled',{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraExposure',{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraContrast',{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraColorGradingTexture',{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this.imageProcessingConfiguration.colorGradingTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,'cameraColorCurves',{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(t){this.imageProcessingConfiguration.colorCurves=t},enumerable:!0,configurable:!0}),a.prototype.needAlphaTesting=function(){return!0},a.prototype.needAlphaBlending=function(){return 0>this.alpha||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha},a.prototype.isReadyForSubMesh=function(t,i,r){var n=this;if(void 0===r&&(r=!1),i.effect&&this.isFrozen&&this._wasPreviouslyReady)return!0;i._materialDefines||(i._materialDefines=new e);var o=this.getScene(),s=i._materialDefines;if(!this.checkReadyOnEveryCall&&i.effect&&s._renderId===o.getRenderId())return!0;var g=o.getEngine();if(y.MaterialHelper.PrepareDefinesForLights(o,t,s,!1,this._maxSimultaneousLights),s._needNormals=!0,s._areTexturesDirty){if(s._needUVs=!1,o.texturesEnabled){if(o.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&y.StandardMaterial.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;y.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,s,'DIFFUSE'),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;var l=this._reflectionTexture;if(l&&y.StandardMaterial.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=l.gammaSpace,s.REFLECTIONBLUR=0<this._reflectionBlur,s.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,s.LODINREFLECTIONALPHA=l.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===y.Texture.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=l.isCube,l.coordinatesMode){case y.Texture.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case y.Texture.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case y.Texture.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case y.Texture.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case y.Texture.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case y.Texture.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case y.Texture.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case y.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case y.Texture.CUBIC_MODE:case y.Texture.INVCUBIC_MODE:default:s.REFLECTIONMAP_CUBIC=!0;}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=0<this.reflectionFalloffDistance,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1}s.PREMULTIPLYALPHA=this.alphaMode===y.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===y.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel)),s._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(y.MaterialHelper.PrepareDefinesForMisc(t,o,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t),s),y.MaterialHelper.PrepareDefinesForFrameBoundValues(o,g,s,r),y.MaterialHelper.PrepareDefinesForAttributes(t,s,!1,!0,!1)&&t&&(o.getEngine().getCaps().standardDerivatives||t.isVerticesDataPresent(y.VertexBuffer.NormalKind)||(t.createNormals(!0),y.Tools.Warn('BackgroundMaterial: Normals have been created for the mesh: '+t.name))),s.isDirty){s.markAsProcessed(),o.resetCachedMaterial();var h=new y.EffectFallbacks;s.FOG&&h.addFallback(0,'FOG'),s.POINTSIZE&&h.addFallback(1,'POINTSIZE'),y.MaterialHelper.HandleFallbacksForShadows(s,h,this._maxSimultaneousLights),0<s.NUM_BONE_INFLUENCERS&&h.addCPUSkinningFallback(0,t);var T=[y.VertexBuffer.PositionKind];s.NORMAL&&T.push(y.VertexBuffer.NormalKind),s.UV1&&T.push(y.VertexBuffer.UVKind),s.UV2&&T.push(y.VertexBuffer.UV2Kind),y.MaterialHelper.PrepareAttributesForBones(T,t,s,h),y.MaterialHelper.PrepareAttributesForInstances(T,s);var x=['world','view','viewProjection','vEyePosition','vLightsType','vFogInfos','vFogColor','pointSize','vClipPlane','mBones','vPrimaryColor','vPrimaryColorShadow','vReflectionInfos','reflectionMatrix','vReflectionMicrosurfaceInfos','fFovMultiplier','shadowLevel','alpha','vBackgroundCenter','vReflectionControl','vDiffuseInfos','diffuseMatrix'],b=['diffuseSampler','reflectionSampler','reflectionSamplerLow','reflectionSamplerHigh'],E=['Material','Scene'];y.ImageProcessingConfiguration.PrepareUniforms(x,s),y.ImageProcessingConfiguration.PrepareSamplers(b,s),y.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:x,uniformBuffersNames:E,samplers:b,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});var v=function(t){n.onCompiled&&n.onCompiled(t),n.bindSceneUniformBuffer(t,o.getSceneUniformBuffer())},P=s.toString();i.setEffect(o.getEngine().createEffect('background',{attributes:T,uniformsNames:x,uniformBuffersNames:E,samplers:b,defines:P,fallbacks:h,onCompiled:v,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},g),s),this.buildUniformLayout()}return i.effect&&i.effect.isReady()&&(s._renderId=o.getRenderId(),this._wasPreviouslyReady=!0,!0)},a.prototype._computePrimaryColorFromPerceptualColor=function(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())},a.prototype._computePrimaryColors=function(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))},a.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform('vPrimaryColor',4),this._uniformBuffer.addUniform('vPrimaryColorShadow',4),this._uniformBuffer.addUniform('vDiffuseInfos',2),this._uniformBuffer.addUniform('vReflectionInfos',2),this._uniformBuffer.addUniform('diffuseMatrix',16),this._uniformBuffer.addUniform('reflectionMatrix',16),this._uniformBuffer.addUniform('vReflectionMicrosurfaceInfos',3),this._uniformBuffer.addUniform('fFovMultiplier',1),this._uniformBuffer.addUniform('pointSize',1),this._uniformBuffer.addUniform('shadowLevel',1),this._uniformBuffer.addUniform('alpha',1),this._uniformBuffer.addUniform('vBackgroundCenter',3),this._uniformBuffer.addUniform('vReflectionControl',4),this._uniformBuffer.create()},a.prototype.unbind=function(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture('diffuseSampler',null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture('reflectionSampler',null),o.prototype.unbind.call(this)},a.prototype.bindOnlyWorldMatrix=function(t){this._activeEffect.setMatrix('world',t)},a.prototype.bindForSubMesh=function(e,t,i){var r=this.getScene(),n=i._materialDefines;if(n){var o=i.effect;if(o){this._activeEffect=o,this.bindOnlyWorldMatrix(e),y.MaterialHelper.BindBonesParameters(t,this._activeEffect);var s=this._mustRebind(r,o,t.visibility);if(s){this._uniformBuffer.bindToEffect(o,'Material'),this.bindViewProjection(o);var d=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync||(r.texturesEnabled&&(this._diffuseTexture&&y.StandardMaterial.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2('vDiffuseInfos',this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),y.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,'diffuse')),d&&y.StandardMaterial.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix('reflectionMatrix',d.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2('vReflectionInfos',d.level,this._reflectionBlur),this._uniformBuffer.updateFloat3('vReflectionMicrosurfaceInfos',d.getSize().width,d.lodGenerationScale,d.lodGenerationOffset))),0<this.shadowLevel&&this._uniformBuffer.updateFloat('shadowLevel',this.shadowLevel),this._uniformBuffer.updateFloat('alpha',this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat('pointSize',this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4('vPrimaryColor',this._primaryHighlightColor,1),this._uniformBuffer.updateColor4('vPrimaryColorShadow',this._primaryShadowColor,1)):this._uniformBuffer.updateColor4('vPrimaryColor',this._primaryColor,1)),this._uniformBuffer.updateFloat('fFovMultiplier',this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&y.StandardMaterial.DiffuseTextureEnabled&&this._uniformBuffer.setTexture('diffuseSampler',this._diffuseTexture),d&&y.StandardMaterial.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture('reflectionSampler',d):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture('reflectionSampler',d._lodTextureMid||d),this._uniformBuffer.setTexture('reflectionSamplerLow',d._lodTextureLow||d),this._uniformBuffer.setTexture('reflectionSamplerHigh',d._lodTextureHigh||d)):this._uniformBuffer.setTexture('reflectionSampler',d),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3('vBackgroundCenter',this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4('vReflectionControl',this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),y.MaterialHelper.BindClipPlane(this._activeEffect,r),y.MaterialHelper.BindEyePosition(o,r)}!s&&this.isFrozen||(r.lightsEnabled&&y.MaterialHelper.BindLights(r,t,this._activeEffect,n,this._maxSimultaneousLights,!1),this.bindView(o),y.MaterialHelper.BindFogParameters(r,t,this._activeEffect),this._imageProcessingConfiguration.bind(this._activeEffect)),this._uniformBuffer.update(),this._afterBind(t)}}},a.prototype.dispose=function(r,e){void 0===r&&(r=!1),void 0===e&&(e=!1),e&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),o.prototype.dispose.call(this,r)},a.prototype.clone=function(e){var t=this;return y.SerializationHelper.Clone(function(){return new a(e,t.getScene())},this)},a.prototype.serialize=function(){var e=y.SerializationHelper.Serialize(this);return e.customType='BABYLON.BackgroundMaterial',e},a.prototype.getClassName=function(){return'BackgroundMaterial'},a.Parse=function(e,t,r){return y.SerializationHelper.Parse(function(){return new a(e.name,t)},e,t,r)},a.StandardReflectance0=.05,a.StandardReflectance90=.5,g([y.serializeAsColor3()],a.prototype,'_primaryColor',void 0),g([y.expandToProperty('_markAllSubMeshesAsLightsDirty')],a.prototype,'primaryColor',void 0),g([y.serializeAsColor3()],a.prototype,'__perceptualColor',void 0),g([y.serialize()],a.prototype,'_primaryColorShadowLevel',void 0),g([y.serialize()],a.prototype,'_primaryColorHighlightLevel',void 0),g([y.expandToProperty('_markAllSubMeshesAsLightsDirty')],a.prototype,'primaryColorHighlightLevel',null),g([y.serializeAsTexture()],a.prototype,'_reflectionTexture',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionTexture',void 0),g([y.serialize()],a.prototype,'_reflectionBlur',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionBlur',void 0),g([y.serializeAsTexture()],a.prototype,'_diffuseTexture',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'diffuseTexture',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'shadowLights',void 0),g([y.serialize()],a.prototype,'_shadowLevel',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'shadowLevel',void 0),g([y.serializeAsVector3()],a.prototype,'_sceneCenter',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'sceneCenter',void 0),g([y.serialize()],a.prototype,'_opacityFresnel',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'opacityFresnel',void 0),g([y.serialize()],a.prototype,'_reflectionFresnel',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionFresnel',void 0),g([y.serialize()],a.prototype,'_reflectionFalloffDistance',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionFalloffDistance',void 0),g([y.serialize()],a.prototype,'_reflectionAmount',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionAmount',void 0),g([y.serialize()],a.prototype,'_reflectionReflectance0',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionReflectance0',void 0),g([y.serialize()],a.prototype,'_reflectionReflectance90',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'reflectionReflectance90',void 0),g([y.serialize()],a.prototype,'_useRGBColor',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'useRGBColor',void 0),g([y.serialize()],a.prototype,'_enableNoise',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'enableNoise',void 0),g([y.serialize()],a.prototype,'_maxSimultaneousLights',void 0),g([y.expandToProperty('_markAllSubMeshesAsTexturesDirty')],a.prototype,'maxSimultaneousLights',void 0),g([y.serializeAsImageProcessingConfiguration()],a.prototype,'_imageProcessingConfiguration',void 0),a}(y.PushMaterial);y.BackgroundMaterial=t}(e||(e={}));var b=this&&this.__assign||Object.assign||function(o){for(var e=1,i=arguments.length,r;e<i;e++)for(var t in r=arguments[e],r)Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},e;!function(l){var e=function(){function e(t,o){var r=this;this._errorHandler=function(o,i){r.onErrorObservable.notifyObservers({message:o,exception:i})},this._options=b({},e._getDefaultOptions(),t),this._scene=o,this.onErrorObservable=new l.Observable,this._setupBackground(),this._setupImageProcessing()}return e._getDefaultOptions=function(){return{createGround:!0,groundSize:15,groundTexture:this._groundTextureCDNUrl,groundColor:new l.Color3(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:l.Engine.TEXTURETYPE_UNSIGNED_INT,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._skyboxTextureCDNUrl,skyboxColor:new l.Color3(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:l.Vector3.Zero(),setupImageProcessing:!0,environmentTexture:this._environmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}},Object.defineProperty(e.prototype,'rootMesh',{get:function(){return this._rootMesh},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'skybox',{get:function(){return this._skybox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'skyboxTexture',{get:function(){return this._skyboxTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'skyboxMaterial',{get:function(){return this._skyboxMaterial},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'ground',{get:function(){return this._ground},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'groundTexture',{get:function(){return this._groundTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'groundMirror',{get:function(){return this._groundMirror},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'groundMirrorRenderList',{get:function(){return this._groundMirror?this._groundMirror.renderList:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,'groundMaterial',{get:function(){return this._groundMaterial},enumerable:!0,configurable:!0}),e.prototype.updateOptions=function(r){var e=b({},this._options,r);this._ground&&!e.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!e.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=e.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!e.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!e.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=e.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!e.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=e.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=e,this._setupBackground(),this._setupImageProcessing()},e.prototype.setMainColor=function(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new l.Color4(e.r,e.g,e.b,1))},e.prototype._setupImageProcessing=function(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())},e.prototype._setupEnvironmentTexture=function(){if(!this._scene.environmentTexture){if(this._options.environmentTexture instanceof l.BaseTexture)return void(this._scene.environmentTexture=this._options.environmentTexture);var e=l.CubeTexture.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}},e.prototype._setupBackground=function(){this._rootMesh||(this._rootMesh=new l.Mesh('BackgroundHelper',this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;var e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y},e.prototype._getSceneSize=function(){var d=this,e=this._options.groundSize,t=this._options.skyboxSize,c=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:c};var p=this._scene.getWorldExtends(function(t){return t!==d._ground&&t!==d._rootMesh&&t!==d._skybox}),o=p.max.subtract(p.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof l.ArcRotateCamera&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);var s=o.length();s>e&&(e=2*s,t=e),e*=1.1,t*=1.5,c=p.min.add(o.scale(.5)),c.y=p.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:c}},e.prototype._setupGround=function(e){var t=this;this._ground||(this._ground=l.Mesh.CreatePlane('BackgroundPlane',e.groundSize,this._scene),this._ground.rotation.x=V/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(function(){t._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow},e.prototype._setupGroundMaterial=function(){this._groundMaterial||(this._groundMaterial=new l.BackgroundMaterial('BackgroundPlaneMaterial',this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=l.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)},e.prototype._setupGroundDiffuseTexture=function(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof l.BaseTexture)return void(this._groundMaterial.diffuseTexture=this._options.groundTexture);var e=new l.Texture(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler);e.gammaSpace=!1,e.hasAlpha=!0,this._groundMaterial.diffuseTexture=e}},e.prototype._setupGroundMirrorTexture=function(e){var t=l.Texture.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new l.MirrorTexture('BackgroundPlaneMirrorTexture',{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,l.Texture.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new l.Plane(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.gammaSpace=!1,this._groundMirror.renderList))for(var o=0,r;o<this._scene.meshes.length;o++)r=this._scene.meshes[o],r!==this._ground&&r!==this._skybox&&r!==this._rootMesh&&this._groundMirror.renderList.push(r);this._groundMirror.clearColor=new l.Color4(this._options.groundColor.r,this._options.groundColor.g,this._options.groundColor.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel},e.prototype._setupMirrorInGroundMaterial=function(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)},e.prototype._setupSkybox=function(e){var t=this;this._skybox||(this._skybox=l.Mesh.CreateBox('BackgroundSkybox',e.skyboxSize,this._scene,void 0,l.Mesh.BACKSIDE),this._skybox.onDisposeObservable.add(function(){t._skybox=null})),this._skybox.parent=this._rootMesh},e.prototype._setupSkyboxMaterial=function(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new l.BackgroundMaterial('BackgroundSkyboxMaterial',this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)},e.prototype._setupSkyboxReflectionTexture=function(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof l.BaseTexture)return void(this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture);this._skyboxTexture=new l.CubeTexture(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=l.Texture.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}},e.prototype.dispose=function(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)},e._groundTextureCDNUrl='https://assets.babylonjs.com/environments/backgroundGround.png',e._skyboxTextureCDNUrl='https://assets.babylonjs.com/environments/backgroundSkybox.dds',e._environmentTextureCDNUrl='https://assets.babylonjs.com/environments/environmentSpecular.dds',e}();l.EnvironmentHelper=e}(e||(e={}));var e;!function(d){var e=function(c){function e(e,t,r,n){var o=c.call(this,e,n)||this;e=e||'videoDome',r.resolution=0|A(r.resolution)||12,r.clickToPlay=!!r.clickToPlay,r.autoPlay=void 0===r.autoPlay||!!r.autoPlay,r.loop=void 0===r.loop||!!r.loop,r.size=A(r.size)||(n.activeCamera?.48*n.activeCamera.maxZ:1e3);var s={loop:r.loop,autoPlay:r.autoPlay,autoUpdateTexture:!0},a=o._material=new d.BackgroundMaterial(e+'_material',n),l=o._videoTexture=new d.VideoTexture(e+'_texture',t,n,!1,!1,d.Texture.TRILINEAR_SAMPLINGMODE,s);return o._mesh=d.MeshBuilder.CreateIcoSphere(e+'_mesh',{flat:!1,radius:r.size,subdivisions:r.resolution,sideOrientation:d.Mesh.BACKSIDE},n),l.coordinatesMode=d.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,l.wrapV=d.Texture.CLAMP_ADDRESSMODE,a.reflectionTexture=o._videoTexture,a.useEquirectangularFOV=!0,a.fovMultiplier=1,o._mesh.material=a,o._mesh.parent=o,r.clickToPlay&&(n.onPointerUp=function(){o._videoTexture.video.play()}),o}return h(e,c),Object.defineProperty(e.prototype,'fovMultiplier',{get:function(){return this._material.fovMultiplier},set:function(t){this._material.fovMultiplier=t},enumerable:!0,configurable:!0}),e.prototype.dispose=function(t,e){void 0===e&&(e=!1),this._videoTexture.dispose(),this._mesh.dispose(),this._material.dispose(),c.prototype.dispose.call(this,t,e)},e}(d.Node);d.VideoDome=e}(e||(e={})),e.Effect.ShadersStore={defaultVertexShader:'#include<__decl__defaultVertex>\n\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nvarying vec2 vSpecularUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL \nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n',defaultPixelShader:'#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n\n#include<helperFunctions>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY \n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\n#if SPECULARDIRECTUV == 1\n#define vSpecularUV vMainUV1\n#elif SPECULARDIRECTUV == 2\n#define vSpecularUV vMainUV2\n#else\nvarying vec2 vSpecularUV;\n#endif\nuniform sampler2D specularSampler;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n\n#include<fresnelFunction>\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb;\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor=toGammaSpace(refractionColor);\n#endif\nrefractionColor*=vRefractionInfos.x;\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb;\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor=toGammaSpace(reflectionColor);\n#endif\nreflectionColor*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n\n\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\n#ifdef PREMULTIPLYALPHA\n\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\ngl_FragColor=color;\n}\n',pbrVertexShader:'precision highp float;\n#include<__decl__pbrVertex>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2; \n#endif \n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#if defined(ALBEDO) && ALBEDODIRECTUV == 0\nvarying vec2 vAlbedoUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0\nvarying vec2 vReflectivityUV;\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=environmentIrradianceJones(reflectionVector);\n#endif\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif \n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif \n#if defined(ALBEDO) && ALBEDODIRECTUV == 0 \nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0 \nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0 \nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0 \nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0 \nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0 \nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0 \nif (vMicroSurfaceSamplerInfos.x == 0.)\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0 \nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<bumpVertex>\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n}',pbrPixelShader:'#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision highp float;\n#include<__decl__pbrFragment>\nuniform vec4 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vCameraInfos;\n\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2;\n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n\n#ifdef ALBEDO\n#if ALBEDODIRECTUV == 1\n#define vAlbedoUV vMainUV1\n#elif ALBEDODIRECTUV == 2\n#define vAlbedoUV vMainUV2\n#else\nvarying vec2 vAlbedoUV;\n#endif\nuniform sampler2D albedoSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY\n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFLECTIVITY\n#if REFLECTIVITYDIRECTUV == 1\n#define vReflectivityUV vMainUV1\n#elif REFLECTIVITYDIRECTUV == 2\n#define vReflectivityUV vMainUV2\n#else\nvarying vec2 vReflectivityUV;\n#endif\nuniform sampler2D reflectivitySampler;\n#endif\n#ifdef MICROSURFACEMAP\n#if MICROSURFACEMAPDIRECTUV == 1\n#define vMicroSurfaceSamplerUV vMainUV1\n#elif MICROSURFACEMAPDIRECTUV == 2\n#define vMicroSurfaceSamplerUV vMainUV2\n#else\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\nuniform sampler2D microSurfaceSampler;\n#endif\n\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#endif\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n\n#include<shadowsFragmentFunctions>\n#include<pbrFunctions>\n#include<harmonicsFunctions>\n#include<pbrLightFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\n\n\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\n#include<bumpFragment>\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalW.xyz);\nvec3 nDfdy=dFdy(normalW.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\n\nfloat geometricRoughnessFactor=pow(clamp(slopeSquare ,0.,1.),0.333);\n\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\n#else\nfloat geometricRoughnessFactor=0.;\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n\n\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\n\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\nsurfaceAlbedo*=vAlbedoInfos.y;\n#endif\n\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#if !defined(LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nsurfaceAlbedo*=vColor.rgb;\n#endif\n\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#endif\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\n\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicColorMap.r,surfaceMetallicColorMap.r,surfaceMetallicColorMap.r);\nambientOcclusionColor=mix(ambientOcclusionColor,aoStoreInMetalMap,vReflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicColorMap.g;\n#endif\n#endif\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n\nmicroSurface=1.0-metallicRoughness.g;\n\nvec3 baseColor=surfaceAlbedo;\n\n\nconst vec3 DefaultSpecularReflectanceDielectric=vec3(0.04,0.04,0.04);\n\nsurfaceAlbedo=mix(baseColor.rgb*(1.0-DefaultSpecularReflectanceDielectric.r),vec3(0.,0.,0.),metallicRoughness.r);\n\nsurfaceReflectivityColor=mix(DefaultSpecularReflectanceDielectric,baseColor,metallicRoughness.r);\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nsurfaceReflectivityColor*=toLinearSpace(surfaceReflectivityColorMap.rgb);\nsurfaceReflectivityColor*=vReflectivityInfos.y;\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceReflectivityColorMap.a;\nmicroSurface*=vReflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#endif\n#endif\n#endif\n\nmicroSurface=clamp(microSurface,0.,1.);\n\nfloat roughness=1.-microSurface;\n\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\n\n\n\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\n\nalpha=fresnelSchlickEnvironmentGGX(clamp(dot(viewDirectionW,normalForward),0.0,1.0),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#endif\n\n\nfloat NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=clamp(NdotVUnclamped,0.,1.)+0.00001;\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n#ifdef SPECULARAA\n\n\nalphaG+=(0.75*geometricAlphaGFactor);\n#endif\n\n#ifdef REFRACTION\nvec3 environmentRefraction=vec3(0.,0.,0.);\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#ifdef REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODINREFRACTIONALPHA\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,1.0);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef LODINREFRACTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD).rgb;\n#else\nfloat lodRefractionNormalized=clamp(refractionLOD/log2(vRefractionMicrosurfaceInfos.x),0.,1.);\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec3 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords).rgb;\nif(lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords).rgb,\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n}else{\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords).rgb,\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFRACTION\nenvironmentRefraction=toLinearSpace(environmentRefraction.rgb);\n#endif\n\nenvironmentRefraction*=vRefractionInfos.x;\n#endif\n\n#ifdef REFLECTION\nvec3 environmentRadiance=vec3(0.,0.,0.);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,1.);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,requestedReflectionLOD).rgb;\n#else\nfloat lodReflectionNormalized=clamp(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x),0.,1.);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec3 environmentSpecularMid=sampleReflection(reflectionSampler,reflectionCoords).rgb;\nif(lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords).rgb,\nenvironmentSpecularMid,\nlodReflectionNormalizedDoubled\n);\n}else{\nenvironmentRadiance=mix(\nenvironmentSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords).rgb,\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\n#endif\n\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\nenvironmentIrradiance=environmentIrradianceJones(irradianceVector);\n#endif\n#endif\n\nenvironmentRadiance*=vReflectionInfos.x;\nenvironmentRadiance*=vReflectionColor.rgb;\nenvironmentIrradiance*=vReflectionColor.rgb;\n#endif\n\n\n\nfloat reflectance=max(max(surfaceReflectivityColor.r,surfaceReflectivityColor.g),surfaceReflectivityColor.b);\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nvec3 specularEnvironmentR0=surfaceReflectivityColor.rgb;\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0)*reflectance90;\n\nvec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb;\n#ifdef GAMMALIGHTMAP\nlightmapColor=toLinearSpace(lightmapColor);\n#endif\nlightmapColor*=vLightmapInfos.y;\n#endif\nlightingInfo info;\nfloat shadow=1.; \nfloat NdotL=-1.;\n#include<lightFragment>[0..maxSimultaneousLights]\n\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n\nvec2 brdfSamplerUV=vec2(NdotV,roughness);\n\nvec4 environmentBrdf=texture2D(environmentBrdfSampler,brdfSamplerUV);\nvec3 specularEnvironmentReflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW);\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\n\nvec3 specularEnvironmentReflectance=fresnelSchlickEnvironmentGGX(NdotV,specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n\n#ifdef REFRACTION\nvec3 refractance=vec3(0.0,0.0,0.0);\nvec3 transmission=vec3(1.0,1.0,1.0);\n#ifdef LINKREFRACTIONTOTRANSPARENCY\n\ntransmission*=(1.0-alpha);\n\n\nvec3 mixedAlbedo=surfaceAlbedo;\nfloat maxChannel=max(max(mixedAlbedo.r,mixedAlbedo.g),mixedAlbedo.b);\nvec3 tint=clamp(maxChannel*mixedAlbedo,0.0,1.0);\n\nsurfaceAlbedo*=alpha;\n\nenvironmentIrradiance*=alpha;\n\nenvironmentRefraction*=tint;\n\nalpha=1.0;\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\nspecularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,alpha);\n\ntransmission*=1.0-specularEnvironmentReflectance;\n\nrefractance=transmission;\n#endif\n\n\n\n\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n\n#ifdef REFLECTION\nvec3 finalIrradiance=environmentIrradiance;\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\n\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\n\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#endif\n\n#ifdef REFLECTION\nvec3 finalRadiance=environmentRadiance;\nfinalRadiance*=specularEnvironmentReflectance;\n\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#endif\n\n#ifdef REFRACTION\nvec3 finalRefraction=environmentRefraction;\nfinalRefraction*=refractance;\n#endif\n\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA)\nalpha=clamp(alpha+luminanceOverAlpha*luminanceOverAlpha,0.,1.);\n#endif\n#endif\n#endif\n\nvec3 finalDiffuse=diffuseBase;\nfinalDiffuse.rgb+=vAmbientColor;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\n\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\nfinalEmissive*=vEmissiveInfos.y;\n#endif\n\n\n\nvec4 finalColor=vec4(\nfinalDiffuse*ambientOcclusionColor*vLightingIntensity.x +\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance*ambientOcclusionColor*vLightingIntensity.z +\n#endif\n#ifdef SPECULARTERM\n\n\nfinalSpecularScaled +\n#endif\n#ifdef REFLECTION\n\n\nfinalRadianceScaled +\n#endif\n#ifdef REFRACTION\nfinalRefraction*vLightingIntensity.z +\n#endif\n#endif\nfinalEmissive*vLightingIntensity.y,\nalpha);\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor;\n#else\nfinalColor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n\nfinalColor=max(finalColor,0.0);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#else\n\nfinalColor=applyImageProcessing(finalColor);\n#endif\n#ifdef PREMULTIPLYALPHA\n\nfinalColor.rgb*=finalColor.a;\n#endif\ngl_FragColor=finalColor;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n}',spritesVertexShader:'\nattribute vec4 position;\nattribute vec4 options;\nattribute vec4 cellInfo;\nattribute vec4 color;\n\nuniform vec2 textureInfos;\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\nvoid main(void) { \nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=options.zw;\nvec2 uvScale=textureInfos.xy;\ncornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \n\nvColor=color;\n\nvec2 uvOffset=vec2(abs(offset.x-cellInfo.x),1.0-abs(offset.y-cellInfo.y));\nvUV=(uvOffset+cellInfo.zw)*uvScale;\n\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n}',spritesPixelShader:'uniform bool alphaTest;\nvarying vec4 vColor;\n\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest) \n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n}',particlesVertexShader:'\nattribute vec3 position;\nattribute vec4 color;\nattribute vec4 options;\nattribute float cellIndex;\n\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec3 particlesInfos; \n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nvarying float fClipDistance;\n#endif\nvoid main(void) { \nvec3 viewPos=(view*vec4(position,1.0)).xyz; \nvec3 cornerPos;\nfloat size=options.y;\nfloat angle=options.x;\nvec2 offset=options.zw;\ncornerPos=vec3(offset.x-0.5,offset.y-0.5,0.)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/particlesInfos.z);\nfloat columnOffset=cellIndex-rowOffset*particlesInfos.z;\nvec2 uvScale=particlesInfos.xy;\nvec2 uvOffset=vec2(offset.x ,1.0-offset.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*vec4(viewPos,1.0);\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n}',particlesPixelShader:'\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\nvoid main(void) {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif\nvec4 baseColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=(baseColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n}',gpuRenderParticlesVertexShader:'#version 300 es\nuniform vec4 colorDead;\nuniform mat4 view;\nuniform mat4 projection;\n\nin vec3 position;\nin float age;\nin float life;\nin float size;\nin vec4 color;\nin vec2 offset;\nin vec2 uv;\nout vec2 vUV;\nout vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nout float fClipDistance;\n#endif\nvoid main() {\nvUV=uv;\nfloat ratio=age/life;\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n\nvec4 viewPosition=view*vec4(position,1.0);\ngl_Position=projection*(viewPosition+vec4(offset*size,0.,0.));\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*viewPosition;\nfClipDistance=dot(worldPos,vClipPlane);\n#endif \n}',gpuRenderParticlesPixelShader:'#version 300 es\nuniform sampler2D textureSampler;\nin vec2 vUV;\nin vec4 vColor;\nout vec4 outFragColor;\n#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\nvoid main() {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif \noutFragColor=texture(textureSampler,vUV)*vColor;\n}\n',gpuUpdateParticlesVertexShader:'#version 300 es\n#define PI 3.14159\nuniform float currentCount;\nuniform float timeDelta;\nuniform float stopFactor;\nuniform vec3 generalRandoms;\nuniform mat4 emitterWM;\nuniform vec2 lifeTime;\nuniform vec2 emitPower;\nuniform vec2 sizeRange;\nuniform vec4 color1;\nuniform vec4 color2;\nuniform vec3 gravity;\nuniform sampler2D randomSampler;\n#ifdef BOXEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\nuniform vec3 minEmitBox;\nuniform vec3 maxEmitBox;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform float radius;\nuniform float angle;\nuniform float height;\nuniform float directionRandomizer;\n#endif\n\nin vec3 position;\nin float age;\nin float life;\nin float seed;\nin float size;\nin vec4 color;\nin vec3 direction;\n\nout vec3 outPosition;\nout float outAge;\nout float outLife;\nout float outSeed;\nout float outSize;\nout vec4 outColor;\nout vec3 outDirection;\nvec3 getRandomVec3(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;\n}\nvec4 getRandomVec4(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));\n}\nvoid main() {\nif (age>=life) {\nif (stopFactor == 0.) {\noutPosition=position;\noutAge=life;\noutLife=life;\noutSeed=seed;\noutColor=vec4(0.,0.,0.,0.);\noutSize=0.;\noutDirection=direction;\nreturn;\n}\nvec3 position;\nvec3 direction;\n\nvec4 randoms=getRandomVec4(generalRandoms.x);\n\noutAge=0.0;\noutLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;\n\noutSeed=seed;\n\noutSize=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n\noutColor=color1+(color2-color1)*randoms.b;\n\n#ifdef BOXEMITTER\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nvec3 randoms3=getRandomVec3(generalRandoms.z);\nposition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;\ndirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nvec3 randoms3=getRandomVec3(generalRandoms.z);\n\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=PI*randoms2.y;\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nposition=(radius*randoms2.z)*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\ndirection=direction1+(direction2-direction1)*randoms3;\n#else\n\ndirection=position+directionRandomizer*randoms3;\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nfloat s=2.0*PI*randoms2.x;\nfloat h=randoms2.y;\n\nh=1.-h*h;\nfloat lRadius=radius*randoms2.z;\nlRadius=lRadius*h;\nfloat randX=lRadius*sin(s);\nfloat randZ=lRadius*cos(s);\nfloat randY=h*height;\nposition=vec3(randX,randY,randZ); \n\nif (angle == 0.) {\ndirection=vec3(0.,1.0,0.);\n} else {\nvec3 randoms3=getRandomVec3(generalRandoms.z);\ndirection=position+directionRandomizer*randoms3;\n}\n#else \n\nposition=vec3(0.,0.,0.);\n\ndirection=2.0*(getRandomVec3(seed)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\noutPosition=(emitterWM*vec4(position,1.)).xyz;\noutDirection=(emitterWM*vec4(direction*power,0.)).xyz;\n} else { \noutPosition=position+direction*timeDelta;\noutAge=age+timeDelta;\noutLife=life;\noutSeed=seed;\noutColor=color;\noutSize=size;\noutDirection=direction+gravity*timeDelta;\n}\n}',gpuUpdateParticlesPixelShader:'#version 300 es\nvoid main() {\ndiscard;\n}\n',colorVertexShader:'\nattribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\nuniform mat4 viewProjection;\nuniform mat4 world;\n\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\nvoid main(void) {\nmat4 finalWorld=world;\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n}',colorPixelShader:'#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\nvoid main(void) {\n#ifdef VERTEXCOLOR\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n}',postprocessVertexShader:'\nattribute vec2 position;\nuniform vec2 scale;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n}',passPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}',shadowMapVertexShader:'\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\nuniform vec3 lightData;\n#endif\n#include<bonesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n\n#include<instancesDeclaration>\n#include<helperFunctions>\nuniform mat4 viewProjection;\nuniform vec3 biasAndScale;\nuniform vec2 depthValues;\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvec3 worldNor=normalize(normalWorld*normal);\n#ifdef DIRECTIONINLIGHTDATA\nvec3 worldLightDir=normalize(-lightData.xyz);\n#else\nvec3 directionToLight=lightData.xyz-worldPos.xyz;\nvec3 worldLightDir=normalize(directionToLight);\n#endif\nfloat ndl=dot(worldNor,worldLightDir);\nfloat sinNL=sqrt(1.0-ndl*ndl);\nfloat normalBias=biasAndScale.y*sinNL;\nworldPos.xyz-=worldNor*normalBias;\n#endif\n\ngl_Position=viewProjection*worldPos;\n#ifdef DEPTHTEXTURE\n\ngl_Position.z+=biasAndScale.x*gl_Position.w;\n#endif\n\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y))+biasAndScale.x;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}',shadowMapPixelShader:'#ifndef FLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nuniform vec3 biasAndScale;\nuniform vec2 depthValues;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nfloat depth=vDepthMetric;\n#ifdef ESM\ndepth=clamp(exp(-min(87.,biasAndScale.z*depth)),0.,1.);\n#endif\n#ifdef FLOAT\ngl_FragColor=vec4(depth,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depth);\n#endif\n}',depthBoxBlurPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}',proceduralVertexShader:'\nattribute vec2 position;\n\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}',depthVertexShader:'\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}',depthPixelShader:'#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(vDepthMetric,vDepthMetric*vDepthMetric,0.0,1.0);\n}',ssaoPixelShader:'\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n',ssao2PixelShader:'\nprecision highp float;\nuniform sampler2D textureSampler;\nuniform float near;\nuniform float far;\nuniform float radius;\nvarying vec2 vUV;\nfloat perspectiveDepthToViewZ( const in float invClipZ,const in float near,const in float far ) {\nreturn ( near*far )/( ( far-near )*invClipZ-far );\n}\nfloat viewZToPerspectiveDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( near*far/viewZ+far)/( far-near );\n}\nfloat viewZToOrthographicDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( viewZ+near )/( near-far );\n}\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform sampler2D normalSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float base;\nuniform float xViewport;\nuniform float yViewport;\nuniform float maxZ;\nuniform float minZAspect;\nuniform vec2 texelSize;\nuniform mat4 projection;\nvoid main()\n{\nvec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;\nfloat depth=texture2D(textureSampler,vUV).r;\nfloat depthSign=depth/abs(depth);\ndepth=depth*depthSign;\nvec3 normal=texture2D(normalSampler,vUV).rgb; \nfloat occlusion=0.0;\nfloat correctedRadius=min(radius,minZAspect*depth/near);\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);\nvec3 origin=vViewRay*depth;\nvec3 rvec=random*2.0-1.0;\nrvec.z=0.0;\nvec3 tangent=normalize(rvec-normal*dot(rvec,normal));\nvec3 bitangent=cross(normal,tangent);\nmat3 tbn=mat3(tangent,bitangent,normal);\nfloat difference;\nif (depth>maxZ) {\ngl_FragColor=vec4(1.0,1.0,1.0,1.0);\nreturn;\n}\nfor (int i=0; i<SAMPLES; ++i) {\n\nvec3 samplePosition=tbn*sampleSphere[i];\nsamplePosition=samplePosition*correctedRadius+origin;\n\nvec4 offset=vec4(samplePosition,1.0);\noffset=projection*offset;\noffset.xyz/=offset.w;\noffset.xy=offset.xy*0.5+0.5;\nif (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {\ncontinue;\n}\n\nfloat sampleDepth=abs(texture2D(textureSampler,offset.xy).r);\n\nfloat rangeCheck=abs(depth-sampleDepth)<correctedRadius ? 1.0 : 0.0;\ndifference=depthSign*samplePosition.z-sampleDepth;\n\nocclusion+=(difference>=1e-5 ? 1.0 : 0.0)*rangeCheck;\n}\n\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor=vec4(vec3(result),1.0);\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.3846153846)*direction;\nvec2 off2=vec2(3.2307692308)*direction;\ncolor+=texture2D(image,uv)*0.2270270270;\ncolor+=texture2D(image,uv+(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv-(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv+(off2/resolution))*0.0702702703;\ncolor+=texture2D(image,uv-(off2/resolution))*0.0702702703;\nreturn color;\n}\nvec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\ncolor+=texture2D(image,uv)*0.1964825501511404;\ncolor+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;\ncolor+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;\nreturn color;\n}\nvec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\nfloat compareDepth=abs(texture2D(depthSampler,uv).r);\nfloat sampleDepth;\nfloat weight;\nfloat weightSum=30.0;\ncolor+=texture2D(image,uv)*30.0;\nsampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off3/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off3/resolution))*weight;\nreturn color/weightSum;\n}\nvoid main()\n{\n#if EXPENSIVE\nfloat compareDepth=abs(texture2D(depthSampler,vUV).r);\nfloat texelsize=1.0/outSize;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 direction=vec2(0.0,1.0);\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=abs(texture2D(depthSampler,samplePos).r);\nfloat weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n#else\nvec4 color;\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#else\nvec2 direction=vec2(0.0,1.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#endif\ngl_FragColor.rgb=vec3(color.r);\ngl_FragColor.a=1.0;\n#endif\n}\n#endif\n',ssaoCombinePixelShader:'uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 ssaoColor=texture2D(textureSampler,vUV);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n}\n',lensHighlightsPixelShader:'\nuniform sampler2D textureSampler; \n\nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\n\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\n\nif (gain == -1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\n\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n\n}',depthOfFieldPixelShader:'\n\n\n\n\nuniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\n\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\n\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\n\nuniform float near;\nuniform float far;\n\nvarying vec2 vUV;\n\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \n\nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\n\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\n\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion == 0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\n\nfloat sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {\n\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\n\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\n\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nif (size == 0.0) { return col; }\n\n\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \n\nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\n\n\n\n\nreturn col;\n}\nvoid main(void)\n{\n\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \n\n\nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\n\nif (dof_enabled == false || coc<0.07) { coc=0.0; }\n\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\n\nfloat blur_amount=max(edge_blur_amount,coc);\n\nif (blur_amount == 0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\n\ngl_FragColor=getBlurColor(blur_amount*1.7);\n\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\n\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\n\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n',standardPixelShader:'uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;\nuniform mat4 lightWorld;\nuniform vec3 cameraPosition;\nuniform vec3 sunDirection;\nuniform vec3 sunColor;\nuniform vec2 depthValues;\nuniform float scatteringCoefficient;\nuniform float scatteringPower;\nuniform sampler2D shadowMapSampler;\nuniform sampler2D positionSampler;\nfloat computeScattering(float lightDotView)\n{\nfloat result=1.0-scatteringCoefficient*scatteringCoefficient;\nresult/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));\nreturn result;\n}\nvoid main(void)\n{\n\nvec3 worldPos=texture2D(positionSampler,vUV).rgb;\nvec3 startPosition=cameraPosition;\nvec3 rayVector=worldPos-startPosition;\nfloat rayLength=length(rayVector);\nvec3 rayDirection=rayVector/rayLength;\nfloat stepLength=rayLength/NB_STEPS;\nvec3 stepL=rayDirection*stepLength;\nvec3 currentPosition=startPosition;\nvec3 accumFog=vec3(0.0);\nfor (int i=0; i<int(NB_STEPS); i++)\n{\nvec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);\nfloat depthMetric=(worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depthMetric,0.0,1.0);\nworldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;\nworldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);\nfloat shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;\nif (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));\ncurrentPosition+=stepL;\n}\naccumFog/=NB_STEPS;\nvec3 color=accumFog*scatteringPower;\ngl_FragColor=vec4(color*exp(color) ,1.0);\n}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);\n}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];\nvoid main()\n{\nfloat average=0.0;\nvec4 color=vec4(0.0);\nfloat maximum=-1e20;\nvec3 weight=vec3(0.299,0.587,0.114);\nfor (int i=0; i<4; i++)\n{\ncolor=texture2D(textureSampler,vUV+ lumOffsets[i]);\n\nfloat GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\nvec4 pack(float value) {\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(value*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvoid main()\n{\nvec4 color=vec4(0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++)\n{\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;\nuniform float averageLuminance;\nvoid main()\n{\nvec4 color=texture2D(textureAdderSampler,vUV);\nvec4 adjustedColor=color/averageLuminance;\ncolor=adjustedColor;\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform vec2 screenSize;\nuniform float motionScale;\nuniform float motionStrength;\nuniform sampler2D depthSampler;\nvoid main(void)\n{\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=cpos*inverseViewProjection;\nvec4 ppos=cpos*prevViewProjection;\nppos.xyz/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n}\n#endif\n',fxaaVertexShader:'\nattribute vec2 position;\nuniform vec2 texelSize;\n\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd);\nsampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;\nsampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;\nsampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;\nsampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;\nsampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;\nsampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;\nsampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;\nsampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;\ngl_Position=vec4(position,0.0,1.0);\n}',fxaaPixelShader:'uniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst float fxaaQualitySubpix=1.0;\nconst float fxaaQualityEdgeThreshold=0.166;\nconst float fxaaQualityEdgeThresholdMin=0.0833;\nconst vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){\nvec2 posM;\nposM.x=vUV.x;\nposM.y=vUV.y;\nvec4 rgbyM=texture2D(textureSampler,vUV,0.0);\nfloat lumaM=FxaaLuma(rgbyM);\nfloat lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));\nfloat lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));\nfloat lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));\nfloat lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));\nfloat maxSM=max(lumaS,lumaM);\nfloat minSM=min(lumaS,lumaM);\nfloat maxESM=max(lumaE,maxSM);\nfloat minESM=min(lumaE,minSM);\nfloat maxWN=max(lumaN,lumaW);\nfloat minWN=min(lumaN,lumaW);\nfloat rangeMax=max(maxWN,maxESM);\nfloat rangeMin=min(minWN,minESM);\nfloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;\nfloat range=rangeMax-rangeMin;\nfloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\nreturn;\n}\n#endif\nfloat lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));\nfloat lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));\nfloat lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));\nfloat lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));\nfloat lumaNS=lumaN+lumaS;\nfloat lumaWE=lumaW+lumaE;\nfloat subpixRcpRange=1.0/range;\nfloat subpixNSWE=lumaNS+lumaWE;\nfloat edgeHorz1=(-2.0*lumaM)+lumaNS;\nfloat edgeVert1=(-2.0*lumaM)+lumaWE;\nfloat lumaNESE=lumaNE+lumaSE;\nfloat lumaNWNE=lumaNW+lumaNE;\nfloat edgeHorz2=(-2.0*lumaE)+lumaNESE;\nfloat edgeVert2=(-2.0*lumaN)+lumaNWNE;\nfloat lumaNWSW=lumaNW+lumaSW;\nfloat lumaSWSE=lumaSW+lumaSE;\nfloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);\nfloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);\nfloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;\nfloat edgeVert3=(-2.0*lumaS)+lumaSWSE;\nfloat edgeHorz=abs(edgeHorz3)+edgeHorz4;\nfloat edgeVert=abs(edgeVert3)+edgeVert4;\nfloat subpixNWSWNESE=lumaNWSW+lumaNESE;\nfloat lengthSign=texelSize.x;\nbool horzSpan=edgeHorz>=edgeVert;\nfloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;\nif (!horzSpan)\n{\nlumaN=lumaW;\n}\nif (!horzSpan) \n{\nlumaS=lumaE;\n}\nif (horzSpan) \n{\nlengthSign=texelSize.y;\n}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;\nfloat gradientN=lumaN-lumaM;\nfloat gradientS=lumaS-lumaM;\nfloat lumaNN=lumaN+lumaM;\nfloat lumaSS=lumaS+lumaM;\nbool pairN=abs(gradientN)>=abs(gradientS);\nfloat gradient=max(abs(gradientN),abs(gradientS));\nif (pairN)\n{\nlengthSign=-lengthSign;\n}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);\nvec2 posB;\nposB.x=posM.x;\nposB.y=posM.y;\nvec2 offNP;\noffNP.x=(!horzSpan) ? 0.0 : texelSize.x;\noffNP.y=(horzSpan) ? 0.0 : texelSize.y;\nif (!horzSpan) \n{\nposB.x+=lengthSign*0.5;\n}\nif (horzSpan)\n{\nposB.y+=lengthSign*0.5;\n}\nvec2 posN;\nposN.x=posB.x-offNP.x*1.5;\nposN.y=posB.y-offNP.y*1.5;\nvec2 posP;\nposP.x=posB.x+offNP.x*1.5;\nposP.y=posB.y+offNP.y*1.5;\nfloat subpixD=((-2.0)*subpixC)+3.0;\nfloat lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));\nfloat subpixE=subpixC*subpixC;\nfloat lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));\nif (!pairN) \n{\nlumaNN=lumaSS;\n}\nfloat gradientScaled=gradient*1.0/4.0;\nfloat lumaMM=lumaM-lumaNN*0.5;\nfloat subpixF=subpixD*subpixE;\nbool lumaMLTZero=lumaMM<0.0;\nlumaEndN-=lumaNN*0.5;\nlumaEndP-=lumaNN*0.5;\nbool doneN=abs(lumaEndN)>=gradientScaled;\nbool doneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) \n{\nposN.x-=offNP.x*3.0;\n}\nif (!doneN) \n{\nposN.y-=offNP.y*3.0;\n}\nbool doneNP=(!doneN) || (!doneP);\nif (!doneP) \n{\nposP.x+=offNP.x*3.0;\n}\nif (!doneP)\n{\nposP.y+=offNP.y*3.0;\n}\nif (doneNP)\n{\nif (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));\nif (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));\nif (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;\nif (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;\ndoneN=abs(lumaEndN)>=gradientScaled;\ndoneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) posN.x-=offNP.x*12.0;\nif (!doneN) posN.y-=offNP.y*12.0;\ndoneNP=(!doneN) || (!doneP);\nif (!doneP) posP.x+=offNP.x*12.0;\nif (!doneP) posP.y+=offNP.y*12.0;\n}\nfloat dstN=posM.x-posN.x;\nfloat dstP=posP.x-posM.x;\nif (!horzSpan)\n{\ndstN=posM.y-posN.y;\n}\nif (!horzSpan) \n{\ndstP=posP.y-posM.y;\n}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;\nfloat spanLength=(dstP+dstN);\nbool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;\nfloat spanLengthRcp=1.0/spanLength;\nbool directionN=dstN<dstP;\nfloat dst=min(dstN,dstP);\nbool goodSpan=directionN ? goodSpanN : goodSpanP;\nfloat subpixG=subpixF*subpixF;\nfloat pixelOffset=(dst*(-spanLengthRcp))+0.5;\nfloat subpixH=subpixG*fxaaQualitySubpix;\nfloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;\nfloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);\nif (!horzSpan)\n{\nposM.x+=pixelOffsetSubpix*lengthSign;\n}\nif (horzSpan)\n{\nposM.y+=pixelOffsetSubpix*lengthSign;\n}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\n}\nelse\n{\ngl_FragColor=texture2D(textureSampler,posM,0.0);\n}\n#else\ngl_FragColor=texture2D(textureSampler,posM,0.0);\n#endif\n}',chromaticAberrationPixelShader:'\nuniform sampler2D textureSampler; \n\nuniform float chromatic_aberration;\nuniform float radialIntensity;\nuniform vec2 direction;\nuniform vec2 centerPosition;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);\nvec2 directionOfEffect=direction;\nif(directionOfEffect.x == 0. && directionOfEffect.y == 0.){\ndirectionOfEffect=normalize(centered_screen_pos);\n}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\n\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;\nfloat ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;\n\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\noriginal.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);\ngl_FragColor=original;\n}',grainPixelShader:'#include<helperFunctions>\n\nuniform sampler2D textureSampler; \n\nuniform float intensity;\nuniform float animatedSeed;\n\nvarying vec2 vUV;\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec2 seed=vUV*(animatedSeed);\nfloat grain=dither(seed,intensity);\n\nfloat lum=getLuminance(gl_FragColor.rgb);\nfloat grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;\ngl_FragColor.rgb+=grain*grainAmount;\ngl_FragColor.rgb=max(gl_FragColor.rgb,0.0);\n}',sharpenPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 sharpnessAmounts;\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 color=texture2D(textureSampler,vUV);\nvec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;\ngl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);\n}',kernelBlurVertexShader:'\nattribute vec2 position;\n\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n}',kernelBlurPixelShader:'\nuniform sampler2D textureSampler;\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nuniform vec2 cameraMinMaxZ;\nfloat sampleDistance(const in vec2 offset) {\nfloat depth=texture2D(circleOfConfusionSampler,offset).g; \nreturn cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth; \n}\nfloat sampleCoC(const in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r; \nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT \nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}',depthOfFieldMergePixelShader:'uniform sampler2D textureSampler;\nvarying vec2 vUV;\nuniform sampler2D circleOfConfusionSampler;\nuniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\nvoid main(void)\n{\nfloat coc=texture2D(circleOfConfusionSampler,vUV).r;\n#if BLUR_LEVEL == 0\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred0=texture2D(blurStep0,vUV);\ngl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL == 1\nif(coc<0.5){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(original,blurred1,coc/0.5);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV); \nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);\n}\n#endif\n#if BLUR_LEVEL == 2\nif(coc<0.33){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(original,blurred2,coc/0.33);\n}else if(coc<0.66){\nvec4 blurred1=texture2D(blurStep1,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);\n}\n#endif\n}\n',circleOfConfusionPixelShader:'\nuniform sampler2D depthSampler;\n\nvarying vec2 vUV;\n\nuniform vec2 cameraMinMaxZ;\n\nuniform float focusDistance;\nuniform float cocPrecalculation;\nvoid main(void)\n{\nfloat depth=texture2D(depthSampler,vUV).r;\nfloat pixelDistance=(cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth)*1000.0; \nfloat coc=abs(cocPrecalculation* ((focusDistance-pixelDistance)/pixelDistance));\ncoc=clamp(coc,0.0,1.0);\ngl_FragColor=vec4(coc,depth,coc,1.0);\n}\n',bloomMergePixelShader:'uniform sampler2D textureSampler;\nuniform sampler2D bloomBlur;\nvarying vec2 vUV;\nuniform float bloomWeight;\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec3 blurred=texture2D(bloomBlur,vUV).rgb;\ngl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); \n}\n',extractHighlightsPixelShader:'#include<helperFunctions>\n\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float threshold;\nuniform float exposure;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\nfloat luma=getLuminance(gl_FragColor.rgb*exposure);\ngl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;\n}',geometryVertexShader:'precision highp float;\nprecision highp int;\n#include<bonesDeclaration>\n#include<instancesDeclaration>\nattribute vec3 position;\nattribute vec3 normal;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nvarying vec2 uv;\n#endif\n#ifdef UV2\nvarying vec2 uv2;\n#endif\n#endif\n\nuniform mat4 viewProjection;\nuniform mat4 view;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 pos=vec4(finalWorld*vec4(position,1.0));\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normal,0.0)));\nvViewPos=view*pos;\n#ifdef POSITION\nvPosition=pos.xyz/pos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}',geometryPixelShader:'#extension GL_EXT_draw_buffers : require\nprecision highp float;\nprecision highp int;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef POSITION\n#include<mrtFragmentDeclaration>[3]\n#else\n#include<mrtFragmentDeclaration>[2]\n#endif\nvoid main() {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n\ngl_FragData[1]=vec4(normalize(vNormalV),1.0);\n\n#ifdef POSITION\ngl_FragData[2]=vec4(vPosition,1.0);\n#endif\n}',refractionPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}',blackAndWhitePixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float degree;\nvoid main(void) \n{\nvec3 color=texture2D(textureSampler,vUV).rgb;\nfloat luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);\ngl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);\n}',convolutionPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}',filterPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}',volumetricLightScatteringPixelShader:'uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\nvoid main(void) {\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;\ndataSample*=illuminationDecay*weight;\ncolor+=dataSample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n}\n',volumetricLightScatteringPassPixelShader:'#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n',colorCorrectionPixelShader:'\nuniform sampler2D textureSampler; \nuniform sampler2D colorTable; \n\nvarying vec2 vUV;\n\nconst float SLICE_COUNT=16.0; \n\nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}',tonemapPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}',displayPassPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}',highlightsPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nconst vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\nvoid main(void) \n{\nvec4 tex=texture2D(textureSampler,vUV);\nvec3 c=tex.rgb;\nfloat luma=dot(c.rgb,RGBLuminanceCoefficients);\n\n\ngl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); \n}',imageProcessingPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main(void)\n{\nvec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\n\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;\n}',lensFlareVertexShader:'\nattribute vec2 position;\n\nuniform mat4 viewportMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n}',lensFlarePixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n}',anaglyphPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}',stereoscopicInterlacePixelShader:'const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\nvoid main(void)\n{\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else{\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}',vrDistortionCorrectionPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);\nelse{\ngl_FragColor=texture2D(textureSampler,tc);\n}\n}',glowBlurPostProcessPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\n\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\n\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}',glowMapGenerationPixelShader:'#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\nuniform vec4 color;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUVDiffuse).a<0.4)\ndiscard;\n#endif\n#ifdef EMISSIVE\ngl_FragColor=texture2D(emissiveSampler,vUVEmissive)*color;\n#else\ngl_FragColor=color;\n#endif\n}',glowMapGenerationVertexShader:'\nattribute vec3 position;\n#include<bonesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(positionUpdated,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}',glowMapMergePixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\n\nuniform float offset;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);\nbaseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);\nbaseColor.a=alpha;\nbaseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\ngl_FragColor=baseColor;\n}',glowMapMergeVertexShader:'\nattribute vec2 position;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) {\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}',lineVertexShader:'\nattribute vec3 position;\nattribute vec4 normal;\n\nuniform mat4 worldViewProjection;\nuniform float width;\nuniform float aspectRatio;\nvoid main(void) {\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n}',linePixelShader:'uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}',outlineVertexShader:'\nattribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\nvoid main(void)\n{\nvec3 offsetPosition=position+normal*offset;\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<logDepthVertex>\n}\n',outlinePixelShader:'#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n}',layerVertexShader:'\nattribute vec2 position;\n\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n}',layerPixelShader:'\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n}',backgroundVertexShader:'precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2; \n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));\nvec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));\nif (fFovMultiplier<=1.0) {\nvDirectionW=normalize(segment);\n} else {\nvDirectionW=normalize(vDirectionW+(vDirectionW-segment));\n}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif \n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0 \nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n}\n',backgroundPixelShader:'#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#define RECIPROCAL_PI2 0.15915494\n\nuniform vec3 vEyePosition;\n\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<helperFunctions>\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<clipPlaneFragmentDeclaration>\n\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n#endif\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\n\nfloat shadow=1.;\nfloat globalShadow=0.;\nfloat shadowLightCount=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n\nvec3 reflectionColor=vec3(1.,1.,1.);\n#ifdef REFLECTION\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\n\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\nreflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD).rgb;\n#else\nfloat lodReflectionNormalized=clamp(reflectionLOD,0.,1.);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec3 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords).rgb;\nif(lodReflectionNormalizedDoubled<1.0){\nreflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords).rgb,\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nreflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords).rgb,\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);\nreflectionColor=reflectionSample.rgb;\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor=reflectionColor.bgr;\n#endif\n\nreflectionColor*=vReflectionInfos.x;\n#endif\n\nvec3 diffuseColor=vec3(1.,1.,1.);\nfloat finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\n\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;\nvec3 reflectionReflectance0=vReflectionControl.yyy;\nvec3 reflectionReflectance90=vReflectionControl.zzz;\nfloat VdotN=dot(normalize(vEyePosition),normalW);\nvec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(clamp(VdotN,0.0,1.0),reflectionReflectance0,reflectionReflectance90,1.0);\nreflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-clamp(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w,0.0,1.0);\nreflectionDistanceFalloff*=reflectionDistanceFalloff;\nreflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor,clamp(reflectionAmount,0.,1.));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition-vBackgroundCenter));\n\nconst float startAngle=0.1;\nfloat fadeFactor=clamp(viewAngleToFloor/startAngle,0.0,1.0);\nfinalAlpha*=fadeFactor*fadeFactor;\n#endif\n\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\n\nvec4 color=vec4(finalColor,finalAlpha);\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#else\n\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\n\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);\ncolor=max(color,0.0);\n#endif\ngl_FragColor=color;\n}\n'},e.Effect.IncludesShadersStore={depthPrePass:'#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif',bonesDeclaration:'#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif',instancesDeclaration:'#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif',pointCloudVertexDeclaration:'#ifdef POINTSIZE\nuniform float pointSize;\n#endif',bumpVertexDeclaration:'#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n',clipPlaneVertexDeclaration:'#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif',fogVertexDeclaration:'#ifdef FOG\nvarying vec3 vFogDistance;\n#endif',morphTargetsVertexGlobalDeclaration:'#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#endif',morphTargetsVertexDeclaration:'#ifdef MORPHTARGETS\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#endif',logDepthDeclaration:'#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif',morphTargetsVertex:'#ifdef MORPHTARGETS\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#endif',instancesVertex:'#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif',bonesVertex:'#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif',bumpVertex:'#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif',clipPlaneVertex:'#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif',fogVertex:'#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif',shadowsVertex:'#ifdef SHADOWS\n#if defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\nvDepthMetric{X}=((vPositionFromLight{X}.z+light{X}.depthValues.x)/(light{X}.depthValues.y));\n#endif\n#endif',pointCloudVertex:'#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif',logDepthVertex:'#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif',helperFunctions:'const float PI=3.1415926535897932384626433832795;\nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\n\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.0,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\nvec3 applyEaseInOut(vec3 x){\nreturn x*x*(3.0-2.0*x);\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn pow(color,vec3(LinearEncodePowerApprox));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn pow(color,vec3(GammaEncodePowerApprox));\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\n\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat dither=mix(-varianceAmount/255.0,varianceAmount/255.0,rand);\nreturn dither;\n}',lightFragmentDeclaration:'#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#else\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif',lightsFragmentFunctions:'\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}',lightUboDeclaration:'#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec3 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\n#endif\n#ifdef HEMILIGHT{X}\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif',defaultVertexDeclaration:'\nuniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n',defaultFragmentDeclaration:'uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_SKYBOX\n#else\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif',defaultUboDeclaration:'layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor; \nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix; \nvec4 vTangentSpaceParams;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nfloat pointSize; \n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};',shadowsFragmentFunctions:'#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadow=texture2D(shadowSampler,uv).x;\n#endif\nif (shadowPixelDepth>shadow)\n{\nreturn computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff);\n}\nreturn 1.;\n}\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\n#ifndef SHADOWFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n#ifdef WEBGL2\n\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat shadow=texture2D(shadowSampler,uvDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\n\n\nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n\n\n\n\n\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\n\nfloat AAOffset=shadowMapSizeInverse*10.;\n\n\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\n\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\n\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\n\nshadow=mix(darkness,1.,shadow);\n\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#endif\n#endif\n',fresnelFunction:'#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif',reflectionFunction:'#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\n\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\n\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\n\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\n\nvec3 intersectPositionWS=vertexPos+origVec*distance;\n\nreturn intersectPositionWS-cubePos;\n}\n#endif\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvec3 direction=vDirectionW;\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nreturn vec3(1.0-s,t,0);\n#else\nreturn vec3(s,t,0);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition.xyz);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition.xyz;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=normalize(worldPos.xyz-vEyePosition.xyz);\n\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,vReflectionSize,vReflectionPosition);\n#endif\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}',imageProcessingDeclaration:'#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#ifdef VIGNETTE\nuniform vec2 vInverseScreenSize;\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif',imageProcessingFunctions:'#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\nvec4 applyImageProcessing(vec4 result) {\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\n\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\n\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=clamp(result.rgb,0.0,1.0);\n#ifdef CONTRAST\n\nvec3 resultHighContrast=applyEaseInOut(result.rgb);\nif (contrast<1.0) {\n\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\n\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\n\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\nreturn result;\n}',bumpFragmentFunctions:'#ifdef BUMP\n#if BUMPDIRECTUV == 1\n#define vBumpUV vMainUV1\n#elif BUMPDIRECTUV == 2\n#define vBumpUV vMainUV2\n#else\nvarying vec2 vBumpUV;\n#endif\nuniform sampler2D bumpSampler;\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#endif\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nuv=gl_FrontFacing ? uv : -uv;\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\n\ntangent*=vTangentSpaceParams.x;\nbitangent*=vTangentSpaceParams.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\nmap=map*2.0-1.0;\n#ifdef NORMALXYSCALE\nmap=normalize(map*vec3(vBumpInfos.y,vBumpInfos.y,1.0));\n#endif\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif',clipPlaneFragmentDeclaration:'#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif',fogFragmentDeclaration:'#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif',clipPlaneFragment:'#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif',bumpFragment:'vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#else \nfloat normalScale=vBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,vBumpUV);\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz*2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW); \n#else\nnormalW=perturbNormal(TBN,vBumpUV+uvOffset);\n#endif\n#endif',lightFragment:'#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || (defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X}))\n\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCLOSEESM{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif\n#endif',logDepthFragment:'#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif',fogFragment:'#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif',pbrVertexDeclaration:'uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n',pbrFragmentDeclaration:'uniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\n\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif',pbrUboDeclaration:'layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec2 vAlbedoInfos;\nuniform vec3 vAmbientInfos;\nuniform vec2 vOpacityInfos;\nuniform vec2 vEmissiveInfos;\nuniform vec2 vLightmapInfos;\nuniform vec3 vReflectivityInfos;\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform vec4 vRefractionInfos;\nuniform vec2 vReflectionInfos;\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \nuniform vec3 vBumpInfos;\nuniform mat4 albedoMatrix;\nuniform mat4 ambientMatrix;\nuniform mat4 opacityMatrix;\nuniform mat4 emissiveMatrix;\nuniform mat4 lightmapMatrix;\nuniform mat4 reflectivityMatrix;\nuniform mat4 microSurfaceSamplerMatrix;\nuniform mat4 bumpMatrix;\nuniform vec2 vTangentSpaceParams;\nuniform mat4 refractionMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec3 vRefractionMicrosurfaceInfos;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\nuniform float pointSize;\n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};',pbrFunctions:'\n#define RECIPROCAL_PI2 0.15915494\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\nconst float kRougnhessToAlphaScale=0.1;\nconst float kRougnhessToAlphaOffset=0.29248125;\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nconst float kMinimumVariance=0.0005;\nfloat alphaG=square(roughness)+kMinimumVariance;\nreturn alphaG;\n}\n\nfloat smithVisibilityG1_TrowbridgeReitzGGX(float dot,float alphaG)\n{\nfloat tanSquared=(1.0-dot*dot)/(dot*dot);\nreturn 2.0/(1.0+sqrt(1.0+alphaG*alphaG*tanSquared));\n}\nfloat smithVisibilityG_TrowbridgeReitzGGX_Walter(float NdotL,float NdotV,float alphaG)\n{\nreturn smithVisibilityG1_TrowbridgeReitzGGX(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGX(NdotV,alphaG);\n}\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow(clamp(1.0-VdotH,0.,1.),5.0);\n}\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n\nvec3 computeSpecularTerm(float NdotH,float NdotL,float NdotV,float VdotH,float roughness,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor)\n{\nroughness=max(roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\nfloat visibility=smithVisibilityG_TrowbridgeReitzGGX_Walter(NdotL,NdotV,alphaG);\nvisibility/=(4.0*NdotL*NdotV); \nfloat specTerm=max(0.,visibility*distribution)*NdotL;\nvec3 fresnel=fresnelSchlickGGX(VdotH,reflectance0,reflectance90);\nreturn fresnel*specTerm;\n}\nfloat computeDiffuseTerm(float NdotL,float NdotV,float VdotH,float roughness)\n{\n\n\nfloat diffuseFresnelNV=pow(clamp(1.0-NdotL,0.000001,1.),5.0);\nfloat diffuseFresnelNL=pow(clamp(1.0-NdotV,0.000001,1.),5.0);\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel*NdotL/PI;\n}\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=clamp(lightRoughness+roughness,0.,1.);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n\n\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=clamp(reflectance0*25.0,0.0,1.0);\nreturn reflectance90;\n}\n\n\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\n\n\n\n\n\n\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nfloat microsurfaceAverageSlopeTexels=microsurfaceAverageSlope*cubeMapDimensionPixels;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\n\n\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn clamp(square(temp)-1.0+ambientOcclusion,0.0,1.0);\n}\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal) {\n\nvec3 reflection=reflect(view,normal);\nfloat temp=clamp( 1.0+1.1*dot(reflection,normal),0.0,1.0);\nreturn square(temp);\n}',harmonicsFunctions:'#ifdef USESPHERICALFROMREFLECTIONMAP\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\nvec3 quaternionVectorRotation_ScaledSqrtTwo(vec4 Q,vec3 V){\nvec3 T=cross(Q.xyz,V);\nT+=Q.www*V;\nreturn cross(Q.xyz,T)+V;\n}\nvec3 environmentIrradianceJones(vec3 normal)\n{\n\n\n\n\n\n\n\n\n\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz*Nz+C1;\nvec3 t2=a2*Ny+t1;\nvec3 t3=b3*Nx+t2;\nreturn t3;\n}\n#endif',pbrLightFunctions:'\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range)\n{ \n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat lightDistanceFalloff=1.0/((lightDistanceSquared+0.001));\n#else\nfloat lightDistanceFalloff=max(0.,1.0-length(lightOffset)/range);\n#endif\nreturn lightDistanceFalloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\n#ifdef USEPHYSICALLIGHTFALLOFF\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfalloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\n#else\nfloat cosAngle=max(0.000000000000001,dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\n#endif\nreturn falloff;\n}\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\nvec3 lightDirection;\nfloat attenuation=1.0;\nfloat lightDistance;\n\nif (lightData.w == 0.)\n{\nvec3 lightOffset=lightData.xyz-vPositionW;\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nattenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\nlightDistance=sqrt(lightDistanceSquared);\nlightDirection=normalize(lightOffset);\n}\n\nelse\n{\nlightDistance=length(-lightData.xyz);\nlightDirection=normalize(-lightData.xyz);\n}\n\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+lightDirection);\nNdotL=clamp(dot(vNormal,lightDirection),0.00000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\nvec3 lightOffset=lightData.xyz-vPositionW;\nvec3 directionToLightCenterW=normalize(lightOffset);\n\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nfloat attenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\n\nfloat directionalAttenuation=computeDirectionalLightFalloff(lightDirection.xyz,directionToLightCenterW,lightDirection.w,lightData.w);\nattenuation*=directionalAttenuation;\n\nfloat lightDistance=sqrt(lightDistanceSquared);\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+directionToLightCenterW);\nNdotL=clamp(dot(vNormal,directionToLightCenterW),0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\n\n\n\nNdotL=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,NdotL);\n#ifdef SPECULARTERM\n\nvec3 lightVectorW=normalize(lightData.xyz);\nvec3 H=normalize(viewDirectionW+lightVectorW);\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nNdotL=clamp(NdotL,0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor;\n#endif\nreturn result;\n}\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn toLinearSpace(textureColor);\n}',kernelBlurFragment:'#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif',kernelBlurFragment2:'#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif',kernelBlurVaryingDeclaration:'varying vec2 sampleCoord{X};',kernelBlurVertex:'sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};',mrtFragmentDeclaration:'#if __VERSION__>=200\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n',bones300Declaration:'#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nin vec4 matricesIndices;\nin vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nin vec4 matricesIndicesExtra;\nin vec4 matricesWeightsExtra;\n#endif\n#endif',instances300Declaration:'#ifdef INSTANCES\nin vec4 world0;\nin vec4 world1;\nin vec4 world2;\nin vec4 world3;\n#else\nuniform mat4 world;\n#endif',backgroundVertexDeclaration:'uniform mat4 view;\nuniform mat4 viewProjection;\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif',backgroundFragmentDeclaration:' uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;\nuniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif',backgroundUboDeclaration:'layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec4 vPrimaryColor;\nuniform vec4 vPrimaryColorShadow;\nuniform vec2 vDiffuseInfos;\nuniform vec2 vReflectionInfos;\nuniform mat4 diffuseMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\nuniform float pointSize;\nuniform float shadowLevel;\nuniform float alpha;\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};'};var t='undefined'==typeof l?'undefined'==typeof window?this:window:l;return t.BABYLON=e,void 0!==p&&(t.Earcut={earcut:p}),e})}).call(e,t(2))},function(e,t,r){'use strict';function o(){d.width=window.innerWidth,d.height=window.innerHeight,c.resize(),i()}function i(){l.isOnMobile=!1,l.isOnMobile=!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))}var a=Math.sin,n=Math.abs,s=r(0),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(s);r(6),r(7);const d=document.getElementById('renderCanvas'),c=new l.Engine(d,!0,{preserveDrawingBuffer:!0,stencil:!0}),p=function(){const e=new l.Scene(c);e.collisionsEnabled=!0,e.showFps();const t=new l.FreeCamera('camera1',new l.Vector3(0,0,0),e);t.fov=1.2,t.setTarget(l.Vector3.Zero());let r=new l.Mesh.CreateBox('hero',34,e);r.speed=15,r.rotateSpeed=2,r.angularSensibility=2e3,r.inertia=.9,r.heroDirection=new l.Vector3(0,0,0),r.heroRotation=new l.Vector2(0,0),r.position.y=200,r.ellipsoid=new l.Vector3(40,40,40),r.checkCollisions=!0,t.parent=r,l.SceneLoader.Append('assets/','room1.babylon',e,function(){const t=e.meshes;for(let e=0;e<t.length;e++)if('room'===t[e].name){t[e].getChildren()}}),e.onPointerObservable.add(function(e){if(e.type===l.PointerEventTypes.POINTERDOWN){try{e.event.target.setPointerCapture(e.event.pointerId)}catch(t){}r.previousPosition={x:e.event.clientX,y:e.event.clientY}}if(e.type===l.PointerEventTypes.POINTERUP){try{e.event.target.releasePointerCapture(e.event.pointerId)}catch(t){}r.previousPosition=null}if(e.type===l.PointerEventTypes.POINTERMOVE){if(!r.previousPosition)return;let t=e.event.clientX-r.previousPosition.x;r.heroRotation.y+=t/r.angularSensibility;let o=e.event.clientY-r.previousPosition.y;r.heroRotation.x+=o/r.angularSensibility,r.previousPosition={x:e.event.clientX,y:e.event.clientY}}});let i={};return e.actionManager=new l.ActionManager(e),e.actionManager.registerAction(new l.ExecuteCodeAction(l.ActionManager.OnKeyDownTrigger,function(e){i[e.sourceEvent.key]='keydown'===e.sourceEvent.type})),e.actionManager.registerAction(new l.ExecuteCodeAction(l.ActionManager.OnKeyUpTrigger,function(e){i[e.sourceEvent.key]='keydown'===e.sourceEvent.type})),e.onBeforeRenderObservable.add(()=>{(i.w||i.ArrowUp)&&(r.heroDirection.z=r.speed),l.isOnMobile&&(r.heroDirection.z=r.speed);let e=new l.Vector3(0,0,0),t=0<n(r.heroDirection.z),o=0<n(r.heroRotation.x)||0<n(r.heroRotation.y);if(t){let t=r.heroDirection.z+5*r.rotation.x;e.x=parseFloat(a(r.rotation.y))*t,e.y=parseFloat(-a(r.rotation.x))*t,e.z=parseFloat(Math.cos(r.rotation.y))*t,e.negate(),r.moveWithCollisions(e),n(r.heroDirection.z)<r.speed*l.Epsilon&&(r.heroDirection.z=0),r.heroDirection.z*=r.inertia}o&&(r.rotation.x+=r.heroRotation.x,r.rotation.y+=r.heroRotation.y,n(r.heroRotation.x)<r.rotateSpeed*l.Epsilon&&(r.heroRotation.x=0),n(r.heroRotation.y)<r.rotateSpeed*l.Epsilon&&(r.heroRotation.y=0),r.heroRotation.scaleInPlace(r.inertia))}),o(),e}();c.runRenderLoop(function(){p.render()}),window.addEventListener('resize',function(){o()})},function(e){var t=function(){return this}();try{t=t||Function('return this')()||(1,eval)('this')}catch(r){'object'==typeof window&&(t=window)}e.exports=t},function(t){if('undefined'==typeof CANNON){var r=new Error('Cannot find module "CANNON"');throw r.code='MODULE_NOT_FOUND',r}t.exports=CANNON},function(t){if('undefined'==typeof OIMO){var r=new Error('Cannot find module "OIMO"');throw r.code='MODULE_NOT_FOUND',r}t.exports=OIMO},function(t){if('undefined'==typeof EARCUT){var r=new Error('Cannot find module "EARCUT"');throw r.code='MODULE_NOT_FOUND',r}t.exports=EARCUT},function(o,e,i){var a=String.fromCharCode,s=Number.MAX_VALUE,l=Math.PI;!function(a,e){var r=[],t=a.BABYLON||this.BABYLON;t=t||i(0),o.exports=e(t)}(this,function(t){t=t||this.BABYLON;var d=(this&&this.__decorate,this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(o,e){for(var r in e)e.hasOwnProperty(r)&&(o[r]=e[r])};return function(e,r){function t(){this.constructor=e}o(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}()),t;!function(g){var e=function(){function e(){this.solidPattern=/solid (\S*)([\S\s]*)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g,this.name='stl',this.extensions={".stl":{isBinary:!0}}}return e.prototype.importMesh=function(e,r,t,i,o){var n;if(this.isBinary(t)){var s=new g.Mesh('stlmesh',r);return this.parseBinary(s,t),o&&o.push(s),!0}for(var l=new Uint8Array(t),c='',d=0;d<t.byteLength;d++)c+=a(l[d]);for(t=c;n=this.solidPattern.exec(t);){var p=n[1];if(p!=n[3])return g.Tools.Error('Error in STL, solid name != endsolid name'),!1;if(e&&p)if(e instanceof Array){if(!e.indexOf(p))continue;}else if(p!==e)continue;p=p||'stlmesh';var s=new g.Mesh(p,r);this.parseASCII(s,n[2]),o&&o.push(s)}return!0},e.prototype.load=function(o,e,r){var t=this.importMesh(null,o,e,r,null,null,null);return t&&o.createDefaultCameraOrLight(),t},e.prototype.loadAssetContainer=function(e,r,t){var o=new g.AssetContainer(e);return this.importMesh(null,e,r,t,o.meshes,null,null),o.removeAllFromScene(),o},e.prototype.isBinary=function(i){var e,r;if(r=new DataView(i),e=50,84+r.getUint32(80,!0)*e===r.byteLength)return!0;for(var t=r.byteLength,a=0;a<t;a++)if(127<r.getUint8(a))return!0;return!1},e.prototype.parseBinary=function(e,r){for(var t=new DataView(r),n=t.getUint32(80,!0),o=0,a=new Float32Array(3*(3*n)),i=new Float32Array(3*(3*n)),s=new Uint32Array(3*n),l=0,u=0;u<n;u++){for(var c=84+50*u,d=t.getFloat32(c,!0),f=t.getFloat32(c+4,!0),h=t.getFloat32(c+8,!0),p=1,m;3>=p;p++)m=c+12*p,a[o]=t.getFloat32(m,!0),a[o+2]=t.getFloat32(m+4,!0),a[o+1]=t.getFloat32(m+8,!0),i[o]=d,i[o+2]=f,i[o+1]=h,o+=3;s[l]=l++,s[l]=l++,s[l]=l++}e.setVerticesData(g.VertexBuffer.PositionKind,a),e.setVerticesData(g.VertexBuffer.NormalKind,i),e.setIndices(s),e.computeWorldMatrix(!0)},e.prototype.parseASCII=function(e,r){for(var t=[],o=[],a=[],i=0,s;s=this.facetsPattern.exec(r);){var n=s[1],l=this.normalPattern.exec(n);if(this.normalPattern.lastIndex=0,l){for(var p=[+l[1],+l[5],+l[3]],d;d=this.vertexPattern.exec(n);)t.push(+d[1],+d[5],+d[3]),o.push(p[0],p[1],p[2]);a.push(i++,i++,i++),this.vertexPattern.lastIndex=0}}this.facetsPattern.lastIndex=0,e.setVerticesData(g.VertexBuffer.PositionKind,t),e.setVerticesData(g.VertexBuffer.NormalKind,o),e.setIndices(a),e.computeWorldMatrix(!0)},e}();g.STLFileLoader=e,g.SceneLoader&&g.SceneLoader.RegisterPlugin(new e)}(t||(t={}));var t;!function(z){var e=function(){function e(){this.materials=[]}return e.prototype.parseMTL=function(r,t,n){if(!(t instanceof ArrayBuffer)){for(var o=t.split('\n'),i=/\s+/,s=null,l=0,p,a;l<o.length;l++)if(a=o[l].trim(),0!==a.length&&'#'!==a.charAt(0)){var c=a.indexOf(' '),d=0<=c?a.substring(0,c):a;d=d.toLowerCase();var u=0<=c?a.substring(c+1).trim():'';'newmtl'===d?(s&&this.materials.push(s),s=new z.StandardMaterial(u,r)):'kd'===d&&s?(p=u.split(i,3).map(parseFloat),s.diffuseColor=z.Color3.FromArray(p)):'ka'===d&&s?(p=u.split(i,3).map(parseFloat),s.ambientColor=z.Color3.FromArray(p)):'ks'===d&&s?(p=u.split(i,3).map(parseFloat),s.specularColor=z.Color3.FromArray(p)):'ke'===d&&s?(p=u.split(i,3).map(parseFloat),s.emissiveColor=z.Color3.FromArray(p)):'ns'===d&&s?s.specularPower=parseFloat(u):'d'===d&&s?s.alpha=parseFloat(u):'map_ka'===d&&s?s.ambientTexture=e._getTexture(n,u,r):'map_kd'===d&&s?s.diffuseTexture=e._getTexture(n,u,r):'map_ks'===d&&s?s.specularTexture=e._getTexture(n,u,r):'map_ns'===d||('map_bump'===d&&s?s.bumpTexture=e._getTexture(n,u,r):'map_d'===d&&s&&(s.opacityTexture=e._getTexture(n,u,r)))}s&&this.materials.push(s)}},e._getTexture=function(e,r,i){if(!r)return null;var n=e;if('file:'===e){var o=r.lastIndexOf('\\');-1===o&&(o=r.lastIndexOf('/')),n+=-1<o?r.substr(o+1):r}else n+=r;return new z.Texture(n,i)},e}();z.MTLFileLoader=e;var r=function(){function l(){this.name='obj',this.extensions='.obj',this.obj=/^o/,this.group=/^g/,this.mtllib=/^mtllib /,this.usemtl=/^usemtl /,this.smooth=/^s /,this.vertexPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.normalPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.uvPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.facePattern1=/f\s+(([\d]{1,}[\s]?){3,})+/,this.facePattern2=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern3=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern4=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/}return l.prototype._loadMTL=function(e,r,t){var i=z.Tools.BaseUrl+r+e;z.Tools.LoadFile(i,t,void 0,void 0,!1,function(){console.warn('Error - Unable to load '+i)})},l.prototype.importMesh=function(i,e,r,t,a){var o=this._parseSolid(i,e,r,t);return a&&o.forEach(function(t){a.push(t)}),!0},l.prototype.load=function(o,e,r){return this.importMesh(null,o,e,r,null,null,null)},l.prototype.loadAssetContainer=function(e,r,t){var o=new z.AssetContainer(e);return this.importMesh(null,e,r,t,o.meshes,null,null),o.removeAllFromScene(),o},l.prototype._parseSolid=function(t,W,r,o){for(var X=[],Y=[],u=[],i=[],d=[],c=[],h=[],p=[],m=[],_=0,a=!1,n=[],y=[],v=[],K=[],g='',Q='',L=new e,x=1,M=!0,Z=function(o,e){o[e[0]]||(o[e[0]]={normals:[],idx:[]});var r=o[e[0]].normals.indexOf(e[1]);return-1===r?-1:o[e[0]].idx[r]},S=function(o,e){o[e[0]]||(o[e[0]]={normals:[],idx:[],uv:[]});var r=o[e[0]].normals.indexOf(e[1]);return 1!=r&&e[2]==o[e[0]].uv[r]?o[e[0]].idx[r]:-1},w=function(t,e,r,n,o,a){var i;i=l.OPTIMIZE_WITH_UV?S(m,[t,r,e]):Z(m,[t,r]),-1==i?(d.push(c.length),c.push(n),h.push(o),p.push(a),m[t].normals.push(r),m[t].idx.push(_++),l.OPTIMIZE_WITH_UV&&m[t].uv.push(e)):d.push(i)},N=function(){for(var t=0;t<c.length;t++)n.push(c[t].x,c[t].y,c[t].z),y.push(p[t].x,p[t].y,p[t].z),v.push(h[t].x,h[t].y);c=[],p=[],h=[],m=[],_=0},F=function(t,e){e+1<t.length&&(K.push(t[0],t[e],t[e+1]),e+=1,F(t,e))},I=function(){0<i.length&&(R=i[i.length-1],N(),d.reverse(),R.indices=d.slice(),R.positions=n.slice(),R.normals=y.slice(),R.uvs=v.slice(),d=[],n=[],y=[],v=[])},P=r.split('\n'),C=0,R;C<P.length;C++){var s=P[C].trim(),G;if(0!==s.length&&'#'!==s.charAt(0))if(null!==(G=this.vertexPattern.exec(s)))X.push(new z.Vector3(parseFloat(G[1]),parseFloat(G[2]),parseFloat(G[3])));else if(null!==(G=this.normalPattern.exec(s)))Y.push(new z.Vector3(parseFloat(G[1]),parseFloat(G[2]),parseFloat(G[3])));else if(null!==(G=this.uvPattern.exec(s)))u.push(new z.Vector2(parseFloat(G[1]),parseFloat(G[2])));else if(null!==(G=this.facePattern3.exec(s)))!function(s,e){F(s,e);for(var r=0;r<K.length;r++){var t=K[r].split('/'),n=parseInt(t[0])-1,o=parseInt(t[1])-1,a=parseInt(t[2])-1;w(n,o,a,X[n],u[o],Y[a])}K=[]}(G[1].trim().split(' '),1);else if(null!==(G=this.facePattern4.exec(s)))!function(e,r){F(e,r);for(var t=0;t<K.length;t++){var n=K[t].split('//'),o=parseInt(n[0])-1,a=parseInt(n[1])-1;w(o,1,a,X[o],z.Vector2.Zero(),Y[a])}K=[]}(G[1].trim().split(' '),1);else if(null!==(G=this.facePattern2.exec(s)))!function(e,r){F(e,r);for(var t=0;t<K.length;t++){var n=K[t].split('/'),o=parseInt(n[0])-1,a=parseInt(n[1])-1;w(o,a,0,X[o],u[a],z.Vector3.Up())}K=[]}(G[1].trim().split(' '),1);else if(null!==(G=this.facePattern1.exec(s)))!function(e,r){F(e,r);for(var t=0,i;t<K.length;t++)i=parseInt(K[t])-1,w(i,0,0,X[i],z.Vector2.Zero(),z.Vector3.Up());K=[]}(G[1].trim().split(' '),1);else if(this.group.test(s)||this.obj.test(s)){var B={name:s.substring(2).trim(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,materialName:''};I(),i.push(B),a=!0,M=!0,x=1}else if(this.usemtl.test(s)){if(g=s.substring(7).trim(),!M){I();var B={name:'_mm'+x.toString(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,materialName:g};x++,i.push(B)}a&&M&&(i[i.length-1].materialName=g,M=!1)}else this.mtllib.test(s)?Q=s.substring(7).trim():this.smooth.test(s)||console.log('Unhandled expression at line : '+s)}a&&(R=i[i.length-1],d.reverse(),N(),R.indices=d,R.positions=n,R.normals=y,R.uvs=v),a||(d.reverse(),N(),i.push({name:z.Geometry.RandomId(),indices:d,positions:n,normals:y,uvs:v,materialName:g}));for(var V=[],D=[],U=0;U<i.length;U++){if(t&&i[U].name)if(t instanceof Array){if(-1==t.indexOf(i[U].name))continue;}else if(i[U].name!==t)continue;R=i[U];var k=new z.Mesh(i[U].name,W);D.push(i[U].materialName);var j=new z.VertexData;j.positions=R.positions,j.normals=R.normals,j.uvs=R.uvs,j.indices=R.indices,j.applyToMesh(k),l.INVERT_Y&&(k.scaling.y*=-1),V.push(k)}return''!==Q&&this._loadMTL(Q,o,function(i){L.parseMTL(W,i,o);for(var e=0;e<L.materials.length;e++){for(var r=0,n=[],a;-1<(a=D.indexOf(L.materials[e].name,r));)n.push(a),r=a+1;if(-1==a&&0==n.length)L.materials[e].dispose();else for(var t=0;t<n.length;t++)V[n[t]].material=L.materials[e]}}),V},l.OPTIMIZE_WITH_UV=!1,l.INVERT_Y=!1,l}();z.OBJFileLoader=r,z.SceneLoader&&z.SceneLoader.RegisterPlugin(new r)}(t||(t={}));var t;!function(i){var e;!function(t){t[t.AUTO=0]='AUTO',t[t.FORCE_RIGHT_HANDED=1]='FORCE_RIGHT_HANDED'}(e=i.GLTFLoaderCoordinateSystemMode||(i.GLTFLoaderCoordinateSystemMode={}));var r;!function(t){t[t.NONE=0]='NONE',t[t.FIRST=1]='FIRST',t[t.ALL=2]='ALL'}(r=i.GLTFLoaderAnimationStartMode||(i.GLTFLoaderAnimationStartMode={})),!function(t){t[t.LOADING=0]='LOADING',t[t.READY=1]='READY',t[t.COMPLETE=2]='COMPLETE'}(i.GLTFLoaderState||(i.GLTFLoaderState={}));var t=function(){function d(){this.onParsedObservable=new i.Observable,this.coordinateSystemMode=e.AUTO,this.animationStartMode=r.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this._normalizeAnimationGroupsToBeginAtZero=!0,this.preprocessUrlAsync=function(t){return Promise.resolve(t)},this.onMeshLoadedObservable=new i.Observable,this.onTextureLoadedObservable=new i.Observable,this.onMaterialLoadedObservable=new i.Observable,this.onCameraLoadedObservable=new i.Observable,this.onCompleteObservable=new i.Observable,this.onDisposeObservable=new i.Observable,this.onExtensionLoadedObservable=new i.Observable,this._loader=null,this.name='gltf',this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}}}return Object.defineProperty(d.prototype,'onParsed',{set:function(t){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onMeshLoaded',{set:function(t){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onTextureLoaded',{set:function(t){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onMaterialLoaded',{set:function(t){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onCameraLoaded',{set:function(t){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onComplete',{set:function(t){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onDispose',{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,'onExtensionLoaded',{set:function(t){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(t)},enumerable:!0,configurable:!0}),d.prototype.whenCompleteAsync=function(){var t=this;return new Promise(function(e){t.onCompleteObservable.add(function(){e()},void 0,void 0,void 0,!0)})},Object.defineProperty(d.prototype,'loaderState',{get:function(){return this._loader?this._loader.state:null},enumerable:!0,configurable:!0}),d.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null),this.preprocessUrlAsync=function(t){return Promise.resolve(t)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},d.prototype.importMeshAsync=function(s,e,r,t,n){var o=this;return Promise.resolve().then(function(){var a=o._parse(r);return o._loader=o._getLoader(a),o._loader.importMeshAsync(s,e,a,t,n)})},d.prototype.loadAsync=function(i,e,r,t){var n=this;return Promise.resolve().then(function(){var o=n._parse(e);return n._loader=n._getLoader(o),n._loader.loadAsync(i,o,r,t)})},d.prototype.loadAssetContainerAsync=function(e,r,t,n){var o=this;return Promise.resolve().then(function(){var a=o._parse(r);return o._loader=o._getLoader(a),o._loader.importMeshAsync(null,e,a,t,n).then(function(r){var t=new i.AssetContainer(e);return Array.prototype.push.apply(t.meshes,r.meshes),Array.prototype.push.apply(t.particleSystems,r.particleSystems),Array.prototype.push.apply(t.skeletons,r.skeletons),Array.prototype.push.apply(t.animationGroups,r.animationGroups),t.removeAllFromScene(),t})})},d.prototype.canDirectLoad=function(t){return-1!==t.indexOf('scene')&&-1!==t.indexOf('node')},d.prototype.createPlugin=function(){return new d},d.prototype._parse=function(t){var e;return e=t instanceof ArrayBuffer?d._parseBinary(t):{json:JSON.parse(t),bin:null},this.onParsedObservable.notifyObservers(e),this.onParsedObservable.clear(),e},d.prototype._getLoader=function(t){var n=this,e=t.json.asset||{},r=d._parseVersion(e.version);if(!r)throw new Error('Invalid version: '+e.version);if(void 0!==e.minVersion){var o=d._parseVersion(e.minVersion);if(!o)throw new Error('Invalid minimum version: '+e.minVersion);if(0<d._compareVersion(o,{major:2,minor:0}))throw new Error('Incompatible minimum version: '+e.minVersion)}var c={1:d.CreateGLTFLoaderV1,2:d.CreateGLTFLoaderV2},s=c[r.major];if(!s)throw new Error('Unsupported version: '+e.version);var p=s();return p.coordinateSystemMode=this.coordinateSystemMode,p.animationStartMode=this.animationStartMode,p.compileMaterials=this.compileMaterials,p.useClipPlane=this.useClipPlane,p.compileShadowGenerators=this.compileShadowGenerators,p.transparencyAsCoverage=this.transparencyAsCoverage,p._normalizeAnimationGroupsToBeginAtZero=this._normalizeAnimationGroupsToBeginAtZero,p.preprocessUrlAsync=this.preprocessUrlAsync,p.onMeshLoadedObservable.add(function(t){return n.onMeshLoadedObservable.notifyObservers(t)}),p.onTextureLoadedObservable.add(function(t){return n.onTextureLoadedObservable.notifyObservers(t)}),p.onMaterialLoadedObservable.add(function(t){return n.onMaterialLoadedObservable.notifyObservers(t)}),p.onCameraLoadedObservable.add(function(t){return n.onCameraLoadedObservable.notifyObservers(t)}),p.onExtensionLoadedObservable.add(function(t){return n.onExtensionLoadedObservable.notifyObservers(t)}),p.onCompleteObservable.add(function(){n.onMeshLoadedObservable.clear(),n.onTextureLoadedObservable.clear(),n.onMaterialLoadedObservable.clear(),n.onCameraLoadedObservable.clear(),n.onExtensionLoadedObservable.clear(),n.onCompleteObservable.notifyObservers(n),n.onCompleteObservable.clear()}),p},d._parseBinary=function(r){var e=new s(r),t=e.readUint32();if(t!=={Magic:1179937895}.Magic)throw new Error('Unexpected magic: '+t);var o=e.readUint32();switch(o){case 1:return d._parseV1(e);case 2:return d._parseV2(e);}throw new Error('Unsupported version: '+o)},d._parseV1=function(r){var e=r.readUint32();if(e!=r.getLength())throw new Error('Length in header does not match actual data length: '+e+' != '+r.getLength());var t=r.readUint32(),a=r.readUint32(),i;switch(a){case{JSON:0}.JSON:i=JSON.parse(d._decodeBufferToText(r.readUint8Array(t)));break;default:throw new Error('Unexpected content format: '+a);}var n=r.getLength()-r.getPosition();return{json:i,bin:r.readUint8Array(n)}},d._parseV2=function(n){var e={JSON:1313821514,BIN:5130562},r=n.readUint32();if(r!==n.getLength())throw new Error('Length in header does not match actual data length: '+r+' != '+n.getLength());var t=n.readUint32();if(n.readUint32()!==e.JSON)throw new Error('First chunk format is not JSON');for(var o=JSON.parse(d._decodeBufferToText(n.readUint8Array(t))),l=null,c;n.getPosition()<n.getLength();)switch(c=n.readUint32(),n.readUint32()){case e.JSON:throw new Error('Unexpected JSON chunk');case e.BIN:l=n.readUint8Array(c);break;default:n.skipBytes(c);}return{json:o,bin:l}},d._parseVersion=function(t){if('1.0'===t||'1.0.1'===t)return{major:1,minor:0};var e=(t+'').match(/^(\d+)\.(\d+)/);return e?{major:parseInt(e[1]),minor:parseInt(e[2])}:null},d._compareVersion=function(t,e){return t.major>e.major?1:t.major<e.major?-1:t.minor>e.minor?1:t.minor<e.minor?-1:0},d._decodeBufferToText=function(o){for(var e='',r=o.byteLength,t=0;t<r;t++)e+=a(o[t]);return e},d.IncrementalLoading=!0,d.HomogeneousCoordinates=!1,d}();i.GLTFFileLoader=t;var s=function(){function t(t){this._arrayBuffer=t,this._dataView=new DataView(t),this._byteOffset=0}return t.prototype.getPosition=function(){return this._byteOffset},t.prototype.getLength=function(){return this._arrayBuffer.byteLength},t.prototype.readUint32=function(){var t=this._dataView.getUint32(this._byteOffset,!0);return this._byteOffset+=4,t},t.prototype.readUint8Array=function(t){var e=new Uint8Array(this._arrayBuffer,this._byteOffset,t);return this._byteOffset+=t,e},t.prototype.skipBytes=function(t){this._byteOffset+=t},t}();i.SceneLoader&&i.SceneLoader.RegisterPlugin(new t)}(t||(t={}));var t;!function(t){!function(t){!function(t){t[t.BYTE=5120]='BYTE',t[t.UNSIGNED_BYTE=5121]='UNSIGNED_BYTE',t[t.SHORT=5122]='SHORT',t[t.UNSIGNED_SHORT=5123]='UNSIGNED_SHORT',t[t.FLOAT=5126]='FLOAT'}(t.EComponentType||(t.EComponentType={})),!function(t){t[t.FRAGMENT=35632]='FRAGMENT',t[t.VERTEX=35633]='VERTEX'}(t.EShaderType||(t.EShaderType={})),!function(t){t[t.BYTE=5120]='BYTE',t[t.UNSIGNED_BYTE=5121]='UNSIGNED_BYTE',t[t.SHORT=5122]='SHORT',t[t.UNSIGNED_SHORT=5123]='UNSIGNED_SHORT',t[t.INT=5124]='INT',t[t.UNSIGNED_INT=5125]='UNSIGNED_INT',t[t.FLOAT=5126]='FLOAT',t[t.FLOAT_VEC2=35664]='FLOAT_VEC2',t[t.FLOAT_VEC3=35665]='FLOAT_VEC3',t[t.FLOAT_VEC4=35666]='FLOAT_VEC4',t[t.INT_VEC2=35667]='INT_VEC2',t[t.INT_VEC3=35668]='INT_VEC3',t[t.INT_VEC4=35669]='INT_VEC4',t[t.BOOL=35670]='BOOL',t[t.BOOL_VEC2=35671]='BOOL_VEC2',t[t.BOOL_VEC3=35672]='BOOL_VEC3',t[t.BOOL_VEC4=35673]='BOOL_VEC4',t[t.FLOAT_MAT2=35674]='FLOAT_MAT2',t[t.FLOAT_MAT3=35675]='FLOAT_MAT3',t[t.FLOAT_MAT4=35676]='FLOAT_MAT4',t[t.SAMPLER_2D=35678]='SAMPLER_2D'}(t.EParameterType||(t.EParameterType={})),!function(t){t[t.CLAMP_TO_EDGE=33071]='CLAMP_TO_EDGE',t[t.MIRRORED_REPEAT=33648]='MIRRORED_REPEAT',t[t.REPEAT=10497]='REPEAT'}(t.ETextureWrapMode||(t.ETextureWrapMode={})),!function(t){t[t.NEAREST=9728]='NEAREST',t[t.LINEAR=9728]='LINEAR',t[t.NEAREST_MIPMAP_NEAREST=9984]='NEAREST_MIPMAP_NEAREST',t[t.LINEAR_MIPMAP_NEAREST=9985]='LINEAR_MIPMAP_NEAREST',t[t.NEAREST_MIPMAP_LINEAR=9986]='NEAREST_MIPMAP_LINEAR',t[t.LINEAR_MIPMAP_LINEAR=9987]='LINEAR_MIPMAP_LINEAR'}(t.ETextureFilterType||(t.ETextureFilterType={})),!function(t){t[t.ALPHA=6406]='ALPHA',t[t.RGB=6407]='RGB',t[t.RGBA=6408]='RGBA',t[t.LUMINANCE=6409]='LUMINANCE',t[t.LUMINANCE_ALPHA=6410]='LUMINANCE_ALPHA'}(t.ETextureFormat||(t.ETextureFormat={})),!function(t){t[t.FRONT=1028]='FRONT',t[t.BACK=1029]='BACK',t[t.FRONT_AND_BACK=1032]='FRONT_AND_BACK'}(t.ECullingType||(t.ECullingType={})),!function(t){t[t.ZERO=0]='ZERO',t[t.ONE=1]='ONE',t[t.SRC_COLOR=768]='SRC_COLOR',t[t.ONE_MINUS_SRC_COLOR=769]='ONE_MINUS_SRC_COLOR',t[t.DST_COLOR=774]='DST_COLOR',t[t.ONE_MINUS_DST_COLOR=775]='ONE_MINUS_DST_COLOR',t[t.SRC_ALPHA=770]='SRC_ALPHA',t[t.ONE_MINUS_SRC_ALPHA=771]='ONE_MINUS_SRC_ALPHA',t[t.DST_ALPHA=772]='DST_ALPHA',t[t.ONE_MINUS_DST_ALPHA=773]='ONE_MINUS_DST_ALPHA',t[t.CONSTANT_COLOR=32769]='CONSTANT_COLOR',t[t.ONE_MINUS_CONSTANT_COLOR=32770]='ONE_MINUS_CONSTANT_COLOR',t[t.CONSTANT_ALPHA=32771]='CONSTANT_ALPHA',t[t.ONE_MINUS_CONSTANT_ALPHA=32772]='ONE_MINUS_CONSTANT_ALPHA',t[t.SRC_ALPHA_SATURATE=776]='SRC_ALPHA_SATURATE'}(t.EBlendingFunction||(t.EBlendingFunction={}))}(t.GLTF1||(t.GLTF1={}))}(t||(t={}));var t;!function(z){!function(R){var r;!function(t){t[t.IDENTIFIER=1]='IDENTIFIER',t[t.UNKNOWN=2]='UNKNOWN',t[t.END_OF_INPUT=3]='END_OF_INPUT'}(r||(r={}));var e=function(){function t(t){this._pos=0,this.currentToken=r.UNKNOWN,this.currentIdentifier='',this.currentString='',this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=t,this._maxPos=t.length}return t.prototype.getNextToken=function(){if(this.isEnd())return r.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=r.UNKNOWN,'_'===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=r.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||'_'===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},t.prototype.peek=function(){return this._toParse[this._pos]},t.prototype.read=function(){return this._toParse[this._pos++]},t.prototype.forward=function(){this._pos++},t.prototype.isEnd=function(){return this._pos>=this._maxPos},t}(),D=['MODEL','VIEW','PROJECTION','MODELVIEW','MODELVIEWPROJECTION','JOINTMATRIX'],o=['world','view','projection','worldView','worldViewProjection','mBones'],B=['translation','rotation','scale'],i=['position','rotationQuaternion','scaling'],a=function(o,e){for(var r in o){var t=o[r];e.buffers[r]=t,e.buffersCount++}},s=function(o,e){for(var r in o){var t=o[r];e.shaders[r]=t,e.shaderscount++}},l=function(i,e,r){for(var t in i){var a=i[t];r[e][t]=a}},t=function(t){if(t)for(var e=0;e<t.length/2;e++)t[2*e+1]=1-t[2*e+1]},n=function(t){if('NORMAL'===t.semantic)return'normal';if('POSITION'===t.semantic)return'position';if('JOINT'===t.semantic)return'matricesIndices';if('WEIGHT'===t.semantic)return'matricesWeights';if('COLOR'===t.semantic)return'color';if(t.semantic&&-1!==t.semantic.indexOf('TEXCOORD_')){var e=+t.semantic.split('_')[1];return'uv'+(0==e?'':e+1)}return null},d=function(e){for(var t in e.animations){var r=e.animations[t];if(r.channels&&r.samplers)for(var o=null,a=0;a<r.channels.length;a++){var n=r.channels[a],s=r.samplers[n.sampler];if(s){var l=null,d=null;r.parameters?(l=r.parameters[s.input],d=r.parameters[s.output]):(l=s.input,d=s.output);var c=R.GLTFUtils.GetBufferFromAccessor(e,e.accessors[l]),u=R.GLTFUtils.GetBufferFromAccessor(e,e.accessors[d]),p=n.target.id,f=e.scene.getNodeByID(p);if(null===f&&(f=e.scene.getNodeByName(p)),null!==f){var _=f instanceof z.Bone,m=n.target.path,h=B.indexOf(m);-1!==h&&(m=i[h]);var y=z.Animation.ANIMATIONTYPE_MATRIX;_||('rotationQuaternion'===m?(y=z.Animation.ANIMATIONTYPE_QUATERNION,f.rotationQuaternion=new z.Quaternion):y=z.Animation.ANIMATIONTYPE_VECTOR3);var b=null,T=[],g=0,E=!1;_&&o&&o.getKeys().length===c.length&&(b=o,E=!0),E||(b=new z.Animation(t,_?'_matrix':m,1,y,z.Animation.ANIMATIONLOOPMODE_CYCLE));for(var v=0,x;v<c.length;v++){if(x=null,'rotationQuaternion'===m?(x=z.Quaternion.FromArray([u[g],u[g+1],u[g+2],u[g+3]]),g+=4):(x=z.Vector3.FromArray([u[g],u[g+1],u[g+2]]),g+=3),_){var P=f,A=z.Vector3.Zero(),S=new z.Quaternion,C=z.Vector3.Zero(),O=P.getBaseMatrix();E&&o&&(O=o.getKeys()[v].value),O.decompose(C,S,A),'position'===m?A=x:'rotationQuaternion'===m?S=x:C=x,x=z.Matrix.Compose(C,S,A)}E?o&&(o.getKeys()[v].value=x):T.push({frame:c[v],value:x})}!E&&b&&(b.setKeys(T),f.animations.push(b)),o=b,e.scene.stopAnimation(f),e.scene.beginAnimation(f,0,c[c.length-1],!0,1)}else z.Tools.Warn('Creating animation named '+t+'. But cannot find node named '+p+' to attach to')}}}},V=function(e){var r=null;if(e.translation||e.rotation||e.scale){var t=z.Vector3.FromArray(e.scale||[1,1,1]),i=z.Quaternion.FromArray(e.rotation||[0,0,0,1]),o=z.Vector3.FromArray(e.translation||[0,0,0]);r=z.Matrix.Compose(t,i,o)}else r=z.Matrix.FromArray(e.matrix);return r},c=function(e,r,t,n){for(var o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];var a=e.nodes;for(var i in a){var s=a[i];if(s.jointName)for(var l=s.children,o=0,p;o<l.length;o++)if(p=e.nodes[l[o]],p.jointName&&p.jointName===t){var u=V(s),d=new z.Bone(s.name||'',n,c(e,r,s.jointName,n),u);return d.id=i,d}}return null},p=function(i,e){for(var r=0;r<i.length;r++)for(var t=i[r],n=0,o;n<t.node.children.length;n++)if(o=t.node.children[n],o===e)return t.bone;return null},_=function(i,e){var a=i.nodes,t=a[e];if(t)return{node:t,id:e};for(var s in a)if(t=a[s],t.jointName===e)return{node:t,id:s};return null},f=function(o,e){for(var r=0;r<o.jointNames.length;r++)if(o.jointNames[r]===e)return!0;return!1},m=function(e,r,t,n){for(var o in e.nodes){var a=e.nodes[o],p=o;if(a.jointName&&!f(t,a.jointName)){var g=V(a),l=new z.Bone(a.name||'',r,null,g);l.id=p,n.push({bone:l,node:a,id:p})}}for(var y=0;y<n.length;y++)for(var c=n[y],d=c.node.children,T=0;T<d.length;T++){for(var h=null,m=0;m<n.length;m++)if(n[m].id===d[T]){h=n[m];break}h&&(h.bone._parent=c.bone,c.bone.children.push(h.bone))}},u=function(e,r,t,n,o){if(n||(n=new z.Skeleton(r.name||'','',e.scene)),!r.babylonSkeleton)return n;var a=[],i=[];m(e,n,r,a),n.bones=[];for(var s=0,l;s<r.jointNames.length;s++)if(l=_(e,r.jointNames[s]),l){var u=l.node;if(u){var o=l.id,y=e.scene.getBoneByID(o);if(y)n.bones.push(y);else{for(var d=!1,f=null,b=0,v;b<s;b++)if(v=_(e,r.jointNames[b]),v){var P=v.node;if(P){var T=P.children;if(T){d=!1;for(var g=0;g<T.length;g++)if(T[g]===o){f=c(e,r,r.jointNames[b],n),d=!0;break}if(d)break}}else z.Tools.Warn('Joint named '+r.jointNames[b]+' does not exist when looking for parent')}var E=V(u);!f&&0<a.length&&(f=p(a,o))&&-1===i.indexOf(f)&&i.push(f),new z.Bone(u.jointName||'',n,f,E).id=o}}else z.Tools.Warn('Joint named '+r.jointNames[s]+' does not exist')}var A=n.bones;n.bones=[];for(var s=0,l;s<r.jointNames.length;s++)if(l=_(e,r.jointNames[s]),l)for(var b=0;b<A.length;b++)if(A[b].id===l.id){n.bones.push(A[b]);break}n.prepare();for(var s=0;s<i.length;s++)n.bones.push(i[s]);return n},h=function(e,r,n,o,a){if(a||(a=new z.Mesh(r.name||'',e.scene),a.id=o),!r.babylonNode)return a;for(var i=[],s=null,l=[],d=[],c=[],u=[],f=0;f<n.length;f++){var p=n[f],m=e.meshes[p];if(m)for(var _=0;_<m.primitives.length;_++){var h=new z.VertexData,y=m.primitives[_];y.mode;var b=y.attributes,v=null,T=null;for(var g in b)if(v=e.accessors[b[g]],T=R.GLTFUtils.GetBufferFromAccessor(e,v),'NORMAL'===g)h.normals=new Float32Array(T.length),h.normals.set(T);else if('POSITION'===g){if(z.GLTFFileLoader.HomogeneousCoordinates){h.positions=new Float32Array(T.length-T.length/4);for(var E=0;E<T.length;E+=4)h.positions[E]=T[E],h.positions[E+1]=T[E+1],h.positions[E+2]=T[E+2]}else h.positions=new Float32Array(T.length),h.positions.set(T);d.push(h.positions.length)}else if(-1!==g.indexOf('TEXCOORD_')){var P=+g.split('_')[1],x=z.VertexBuffer.UVKind+(0==P?'':P+1),A=new Float32Array(T.length);A.set(T),t(A),h.set(A,x)}else'JOINT'===g?(h.matricesIndices=new Float32Array(T.length),h.matricesIndices.set(T)):'WEIGHT'===g?(h.matricesWeights=new Float32Array(T.length),h.matricesWeights.set(T)):'COLOR'===g&&(h.colors=new Float32Array(T.length),h.colors.set(T));if(v=e.accessors[y.indices])T=R.GLTFUtils.GetBufferFromAccessor(e,v),h.indices=new Int32Array(T.length),h.indices.set(T),u.push(h.indices.length);else{for(var M=[],E=0;E<h.positions.length/3;E++)M.push(E);h.indices=new Int32Array(M),u.push(h.indices.length)}s?s.merge(h):s=h;var S=e.scene.getMaterialByID(y.material);i.push(null===S?R.GLTFUtils.GetDefaultMaterial(e.scene):S),l.push(0===l.length?0:l[l.length-1]+d[d.length-2]),c.push(0===c.length?0:c[c.length-1]+u[u.length-2])}}var C;1<i.length?(C=new z.MultiMaterial('multimat'+o,e.scene),C.subMaterials=i):C=new z.StandardMaterial('multimat'+o,e.scene),1===i.length&&(C=i[0]),a.material||(a.material=C),new z.Geometry(o,e.scene,s,!1,a),a.computeWorldMatrix(!0),a.subMeshes=[];for(var O=0,f=0;f<n.length;f++){var p=n[f],m=e.meshes[p];if(m)for(var _=0;_<m.primitives.length;_++)m.primitives[_].mode,z.SubMesh.AddToMesh(O,l[O],d[O],c[O],u[O],a,a,!0),O++}return a},y=function(o,e,r,t){o.position&&(o.position=e),(o.rotationQuaternion||o.rotation)&&(o.rotationQuaternion=r),o.scaling&&(o.scaling=t)},g=function(e,r){if(r.matrix){var t=new z.Vector3(0,0,0),o=new z.Quaternion,a=new z.Vector3(0,0,0);z.Matrix.FromArray(r.matrix).decompose(a,o,t),y(e,t,o,a)}else r.translation&&r.rotation&&r.scale&&y(e,z.Vector3.FromArray(r.translation),z.Quaternion.FromArray(r.rotation),z.Vector3.FromArray(r.scale));e.computeWorldMatrix(!0)},T=function(e,r,t){var o=null;if(e.importOnlyMeshes&&(r.skin||r.meshes)&&e.importMeshesNames&&0<e.importMeshesNames.length&&-1===e.importMeshesNames.indexOf(r.name||''))return null;if(r.skin){if(r.meshes){var a=e.skins[r.skin],i=h(e,r,r.meshes,t,r.babylonNode);i.skeleton=e.scene.getLastSkeletonByID(r.skin),null===i.skeleton&&(i.skeleton=u(e,a,0,a.babylonSkeleton,r.skin),a.babylonSkeleton||(a.babylonSkeleton=i.skeleton)),o=i}}else if(r.meshes){var i=h(e,r,r.mesh?[r.mesh]:r.meshes,t,r.babylonNode);o=i}else if(!(!r.light||r.babylonNode||e.importOnlyMeshes)){var n=e.lights[r.light];if(n)if('ambient'===n.type){var s=n[n.type],f=new z.HemisphericLight(r.light,z.Vector3.Zero(),e.scene);f.name=r.name||'',s.color&&(f.diffuse=z.Color3.FromArray(s.color)),o=f}else if('directional'===n.type){var p=n[n.type],m=new z.DirectionalLight(r.light,z.Vector3.Zero(),e.scene);m.name=r.name||'',p.color&&(m.diffuse=z.Color3.FromArray(p.color)),o=m}else if('point'===n.type){var _=n[n.type],T=new z.PointLight(r.light,z.Vector3.Zero(),e.scene);T.name=r.name||'',_.color&&(T.diffuse=z.Color3.FromArray(_.color)),o=T}else if('spot'===n.type){var E=n[n.type],b=new z.SpotLight(r.light,z.Vector3.Zero(),z.Vector3.Zero(),0,0,e.scene);b.name=r.name||'',E.color&&(b.diffuse=z.Color3.FromArray(E.color)),E.fallOfAngle&&(b.angle=E.fallOfAngle),E.fallOffExponent&&(b.exponent=E.fallOffExponent),o=b}}else if(r.camera&&!r.babylonNode&&!e.importOnlyMeshes){var v=e.cameras[r.camera];if(v)if('orthographic'===v.type){var l=new z.FreeCamera(r.camera,z.Vector3.Zero(),e.scene,!1);l.name=r.name||'',l.mode=z.Camera.ORTHOGRAPHIC_CAMERA,l.attachControl(e.scene.getEngine().getRenderingCanvas()),o=l}else if('perspective'===v.type){var P=v[v.type],c=new z.FreeCamera(r.camera,z.Vector3.Zero(),e.scene,!1);c.name=r.name||'',c.attachControl(e.scene.getEngine().getRenderingCanvas()),P.aspectRatio||(P.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),P.znear&&P.zfar&&(c.maxZ=P.zfar,c.minZ=P.znear),o=c}}if(!r.jointName){if(r.babylonNode)return r.babylonNode;if(null===o){var d=new z.Mesh(r.name||'',e.scene);r.babylonNode=d,o=d}}if(null!==o){if(r.matrix&&o instanceof z.Mesh)g(o,r);else{var x=r.translation||[0,0,0],A=r.rotation||[0,0,0,1],M=r.scale||[1,1,1];y(o,z.Vector3.FromArray(x),z.Quaternion.FromArray(A),z.Vector3.FromArray(M))}o.updateCache(!0),r.babylonNode=o}return o},b=function(s,e,r,t){void 0===t&&(t=!1);var l=s.nodes[e],o=null;if(t=!(s.importOnlyMeshes&&!t&&s.importMeshesNames)||-1!==s.importMeshesNames.indexOf(l.name||'')||0===s.importMeshesNames.length,!l.jointName&&t&&null!==(o=T(s,l,e))&&(o.id=e,o.parent=r),l.children)for(var a=0;a<l.children.length;a++)b(s,l.children[a],o,t)},x=function(i){var e=i.currentScene;if(e)for(var r=0;r<e.nodes.length;r++)b(i,e.nodes[r],null);else for(var t in i.scenes){e=i.scenes[t];for(var r=0;r<e.nodes.length;r++)b(i,e.nodes[r],null)}d(i);for(var r=0,a;r<i.scene.skeletons.length;r++)a=i.scene.skeletons[r],i.scene.beginAnimation(a,0,Number.MAX_VALUE,!0,1)},E=function(r,e,t,n,o,a,i){var s=a.values||o.parameters;for(var l in t){var u=t[l],c=u.type;if(!(c===R.EParameterType.FLOAT_MAT2||c===R.EParameterType.FLOAT_MAT3||c===R.EParameterType.FLOAT_MAT4)){var d=s[o.uniforms[l]];if(!d)continue;if(c===R.EParameterType.SAMPLER_2D){var _=e.textures[a.values?d:u.value].babylonTexture;if(null===_||void 0===_)continue;n.getEffect().setTexture(l,_)}else R.GLTFUtils.SetUniform(n.getEffect(),l,d,c)}else if(!(!u.semantic||u.source||u.node))R.GLTFUtils.SetMatrix(e.scene,r,u,l,n.getEffect());else if(u.semantic&&(u.source||u.node)){var p=e.scene.getNodeByName(u.source||u.node||'');if(null===p&&(p=e.scene.getNodeByID(u.source||u.node||'')),null===p)continue;R.GLTFUtils.SetMatrix(e.scene,p,u,l,n.getEffect())}}i(n)},v=function(r,p,e,t,o){var a=t.values||e.parameters,i=e.uniforms;for(var n in o){var s=o[n],l=s.type,c=a[i[n]];if(void 0===c&&(c=s.value),c){var d=function(t){return function(e){s.value&&t&&(p.setTexture(t,e),delete o[t])}};l===R.EParameterType.SAMPLER_2D?R.GLTFLoaderExtension.LoadTextureAsync(r,t.values?c:s.value,d(n),function(){return d(null)}):s.value&&R.GLTFUtils.SetUniform(p,n,t.values?c:s.value,l)&&delete o[n]}}},W=function(i,e,r){return function(t,a){e.dispose(!0),r('Cannot compile program named '+i.name+'. Error: '+a+'. Default material will be applied')}},w=function(s,e,r,t,n,o){return function(){v(s,e,r,t,n),e.onBind=function(a){E(a,s,n,e,r,t,o)}}},S=function(a,e,r){for(var t in e.uniforms){var n=e.uniforms[t],i=e.parameters[n];if(a.currentIdentifier===t&&i.semantic&&!i.source&&!i.node){var s=D.indexOf(i.semantic);if(-1!==s)return delete r[t],o[s]}}return a.currentIdentifier},A=function(r){for(var e in r.materials)R.GLTFLoaderExtension.LoadMaterialAsync(r,e,function(){},function(){})},M=function(){function t(){}return t.CreateRuntime=function(o,e,i){var d={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:e,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[]};return o.extensions&&l(o.extensions,'extensions',d),o.extensionsUsed&&l(o.extensionsUsed,'extensionsUsed',d),o.buffers&&a(o.buffers,d),o.bufferViews&&l(o.bufferViews,'bufferViews',d),o.accessors&&l(o.accessors,'accessors',d),o.meshes&&l(o.meshes,'meshes',d),o.lights&&l(o.lights,'lights',d),o.cameras&&l(o.cameras,'cameras',d),o.nodes&&l(o.nodes,'nodes',d),o.images&&l(o.images,'images',d),o.textures&&l(o.textures,'textures',d),o.shaders&&s(o.shaders,d),o.programs&&l(o.programs,'programs',d),o.samplers&&l(o.samplers,'samplers',d),o.techniques&&l(o.techniques,'techniques',d),o.materials&&l(o.materials,'materials',d),o.animations&&l(o.animations,'animations',d),o.skins&&l(o.skins,'skins',d),o.scenes&&(d.scenes=o.scenes),o.scene&&o.scenes&&(d.currentScene=o.scenes[o.scene]),d},t.LoadBufferAsync=function(e,r,t,n,o){var a=e.buffers[r];z.Tools.IsBase64(a.uri)?setTimeout(function(){return t(new Uint8Array(z.Tools.DecodeBase64(a.uri)))}):z.Tools.LoadFile(e.rootUrl+a.uri,function(r){return t(new Uint8Array(r))},o,void 0,!0,function(t){t&&n(t.status+' '+t.statusText)})},t.LoadTextureBufferAsync=function(e,r,t,n){var o=e.textures[r];if(!o||!o.source)return void n('');if(o.babylonTexture)return void t(null);var s=e.images[o.source];z.Tools.IsBase64(s.uri)?setTimeout(function(){return t(new Uint8Array(z.Tools.DecodeBase64(s.uri)))}):z.Tools.LoadFile(e.rootUrl+s.uri,function(r){return t(new Uint8Array(r))},void 0,void 0,!0,function(t){t&&n(t.status+' '+t.statusText)})},t.CreateTextureAsync=function(e,t,r,o){var i=e.textures[t];if(i.babylonTexture)return void o(i.babylonTexture);var a=e.samplers[i.sampler],n=a.minFilter===R.ETextureFilterType.NEAREST_MIPMAP_NEAREST||a.minFilter===R.ETextureFilterType.NEAREST_MIPMAP_LINEAR||a.minFilter===R.ETextureFilterType.LINEAR_MIPMAP_NEAREST||a.minFilter===R.ETextureFilterType.LINEAR_MIPMAP_LINEAR,s=z.Texture.BILINEAR_SAMPLINGMODE,l=new Blob([r]),d=URL.createObjectURL(l),c=function(){return URL.revokeObjectURL(d)},f=new z.Texture(d,e.scene,!n,!0,s,c,c);void 0!==a.wrapS&&(f.wrapU=R.GLTFUtils.GetWrapMode(a.wrapS)),void 0!==a.wrapT&&(f.wrapV=R.GLTFUtils.GetWrapMode(a.wrapT)),f.name=t,i.babylonTexture=f,o(f)},t.LoadShaderStringAsync=function(e,r,t,n){var o=e.shaders[r];if(z.Tools.IsBase64(o.uri)){var a=atob(o.uri.split(',')[1]);t&&t(a)}else z.Tools.LoadFile(e.rootUrl+o.uri,t,void 0,void 0,!1,function(t){t&&n&&n(t.status+' '+t.statusText)})},t.LoadMaterialAsync=function(t,i,a,s){var l=t.materials[i];if(!l.technique)return void(s&&s('No technique found.'));var c=t.techniques[l.technique];if(!c){var u=new z.StandardMaterial(i,t.scene);return u.diffuseColor=new z.Color3(.5,.5,.5),u.sideOrientation=z.Material.CounterClockWiseSideOrientation,void a(u)}var f=t.programs[c.program],p=c.states,m=z.Effect.ShadersStore[f.vertexShader+'VertexShader'],_=z.Effect.ShadersStore[f.fragmentShader+'PixelShader'],h='',y='',b=new e(m),v=new e(_),T={},g=[],A=[],F=[];for(var N in c.uniforms){var M=c.uniforms[N],O=c.parameters[M];if(T[N]=O,!O.semantic||O.node||O.source)O.type===R.EParameterType.SAMPLER_2D?F.push(N):g.push(N);else{var H=D.indexOf(O.semantic);-1===H?g.push(N):(g.push(o[H]),delete T[N])}}for(var I in c.attributes){var P=c.attributes[I],C=c.parameters[P];C.semantic&&A.push(n(C))}for(;!b.isEnd()&&b.getNextToken();){var X=b.currentToken;if(X===r.IDENTIFIER){var B=!1;for(var I in c.attributes){var P=c.attributes[I],C=c.parameters[P];if(b.currentIdentifier===I&&C.semantic){h+=n(C),B=!0;break}}B||(h+=S(b,c,T))}else h+=b.currentString}for(;!v.isEnd()&&v.getNextToken();){var X=v.currentToken;y+=X===r.IDENTIFIER?S(v,c,T):v.currentString}var G={vertex:f.vertexShader+i,fragment:f.fragmentShader+i},V={attributes:A,uniforms:g,samplers:F,needAlphaBlending:p&&p.enable&&-1!==p.enable.indexOf(3042)};z.Effect.ShadersStore[f.vertexShader+i+'VertexShader']=h,z.Effect.ShadersStore[f.fragmentShader+i+'PixelShader']=y;var Y=new z.ShaderMaterial(i,t.scene,G,V);if(Y.onError=W(f,Y,s),Y.onCompiled=w(t,Y,c,l,T,a),Y.sideOrientation=z.Material.CounterClockWiseSideOrientation,p&&p.functions){var U=p.functions;U.cullFace&&U.cullFace[0]!==R.ECullingType.BACK&&(Y.backFaceCulling=!1);var k=U.blendFuncSeparate;k&&(k[0]===R.EBlendingFunction.SRC_ALPHA&&k[1]===R.EBlendingFunction.ONE_MINUS_SRC_ALPHA&&k[2]===R.EBlendingFunction.ONE&&k[3]===R.EBlendingFunction.ONE?Y.alphaMode=z.Engine.ALPHA_COMBINE:k[0]===R.EBlendingFunction.ONE&&k[1]===R.EBlendingFunction.ONE&&k[2]===R.EBlendingFunction.ZERO&&k[3]===R.EBlendingFunction.ONE?Y.alphaMode=z.Engine.ALPHA_ONEONE:k[0]===R.EBlendingFunction.SRC_ALPHA&&k[1]===R.EBlendingFunction.ONE&&k[2]===R.EBlendingFunction.ZERO&&k[3]===R.EBlendingFunction.ONE?Y.alphaMode=z.Engine.ALPHA_ADD:k[0]===R.EBlendingFunction.ZERO&&k[1]===R.EBlendingFunction.ONE_MINUS_SRC_COLOR&&k[2]===R.EBlendingFunction.ONE&&k[3]===R.EBlendingFunction.ONE?Y.alphaMode=z.Engine.ALPHA_SUBTRACT:k[0]===R.EBlendingFunction.DST_COLOR&&k[1]===R.EBlendingFunction.ZERO&&k[2]===R.EBlendingFunction.ONE&&k[3]===R.EBlendingFunction.ONE?Y.alphaMode=z.Engine.ALPHA_MULTIPLY:k[0]===R.EBlendingFunction.SRC_ALPHA&&k[1]===R.EBlendingFunction.ONE_MINUS_SRC_COLOR&&k[2]===R.EBlendingFunction.ONE&&k[3]===R.EBlendingFunction.ONE&&(Y.alphaMode=z.Engine.ALPHA_MAXIMIZED))}},t}();R.GLTFLoaderBase=M;var P=function(){function e(){this.coordinateSystemMode=z.GLTFLoaderCoordinateSystemMode.AUTO,this.animationStartMode=z.GLTFLoaderAnimationStartMode.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this._normalizeAnimationGroupsToBeginAtZero=!0,this.preprocessUrlAsync=function(t){return Promise.resolve(t)},this.onMeshLoadedObservable=new z.Observable,this.onTextureLoadedObservable=new z.Observable,this.onMaterialLoadedObservable=new z.Observable,this.onCameraLoadedObservable=new z.Observable,this.onCompleteObservable=new z.Observable,this.onDisposeObservable=new z.Observable,this.onExtensionLoadedObservable=new z.Observable,this.state=null}return e.RegisterExtension=function(t){return e.Extensions[t.name]?void z.Tools.Error('Tool with the same name "'+t.name+'" already exists'):void(e.Extensions[t.name]=t)},e.prototype.dispose=function(){},e.prototype._importMeshAsync=function(e,r,n,o,p,i,a){var s=this;return r.useRightHandedSystem=!0,R.GLTFLoaderExtension.LoadRuntimeAsync(r,n,o,function(u){u.importOnlyMeshes=!0,''===e?u.importMeshesNames=[]:'string'==typeof e?u.importMeshesNames=[e]:!e||e instanceof Array?(u.importMeshesNames=[],z.Tools.Warn('Argument meshesNames must be of type string or string[]')):u.importMeshesNames=[e],s._createNodes(u);var r=[],n=[];for(var o in u.nodes){var a=u.nodes[o];a.babylonNode instanceof z.AbstractMesh&&r.push(a.babylonNode)}for(var l in u.skins){var c=u.skins[l];c.babylonSkeleton instanceof z.Skeleton&&n.push(c.babylonSkeleton)}s._loadBuffersAsync(u,function(){s._loadShadersAsync(u,function(){A(u),x(u),!z.GLTFFileLoader.IncrementalLoading&&p&&p(r,n)})},i),z.GLTFFileLoader.IncrementalLoading&&p&&p(r,n)},a),!0},e.prototype.importMeshAsync=function(l,e,r,t,n){var o=this;return new Promise(function(a,i){o._importMeshAsync(l,e,r,t,function(t,o){a({meshes:t,particleSystems:[],skeletons:o,animationGroups:[]})},n,function(t){i(new Error(t))})})},e.prototype._loadAsync=function(e,t,r,o,a,i){var n=this;e.useRightHandedSystem=!0,R.GLTFLoaderExtension.LoadRuntimeAsync(e,t,r,function(e){R.GLTFLoaderExtension.LoadRuntimeExtensionsAsync(e,function(){n._createNodes(e),n._loadBuffersAsync(e,function(){n._loadShadersAsync(e,function(){A(e),x(e),z.GLTFFileLoader.IncrementalLoading||o()})}),z.GLTFFileLoader.IncrementalLoading&&o()},i)},i)},e.prototype.loadAsync=function(s,e,r,t){var n=this;return new Promise(function(o,a){n._loadAsync(s,e,r,function(){o()},t,function(t){a(new Error(t))})})},e.prototype._loadShadersAsync=function(e,t){var r=!1,o=function(r,o){R.GLTFLoaderExtension.LoadShaderStringAsync(e,r,function(a){a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(z.Effect.ShadersStore[r+(o.type===R.EShaderType.VERTEX?'VertexShader':'PixelShader')]=a),e.loadedShaderCount===e.shaderscount&&t())},function(){z.Tools.Error('Error when loading shader program named '+r+' located at '+o.uri)})};for(var a in e.shaders){r=!0;var i=e.shaders[a];i?o.bind(this,a,i)():z.Tools.Error('No shader named: '+a)}r||t()},e.prototype._loadBuffersAsync=function(e,t){var r=!1,o=function(i,o){R.GLTFLoaderExtension.LoadBufferAsync(e,i,function(a){e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[i].byteLength&&z.Tools.Error('Buffer named '+i+' is length '+a.byteLength+'. Expected: '+o.byteLength),e.loadedBufferViews[i]=a),e.loadedBufferCount===e.buffersCount&&t()},function(){z.Tools.Error('Error when loading buffer named '+i+' located at '+o.uri)})};for(var i in e.buffers){r=!0;var a=e.buffers[i];a?o.bind(this,i,a)():z.Tools.Error('No buffer named: '+i)}r||t()},e.prototype._createNodes=function(o){var e=o.currentScene;if(e)for(var r=0;r<e.nodes.length;r++)b(o,e.nodes[r],null);else for(var t in o.scenes){e=o.scenes[t];for(var r=0;r<e.nodes.length;r++)b(o,e.nodes[r],null)}},e.Extensions={},e}();R.GLTFLoader=P,z.GLTFFileLoader.CreateGLTFLoaderV1=function(){return new P}}(z.GLTF1||(z.GLTF1={}))}(t||(t={}));var t;!function(l){!function(e){var r=function(){function i(){}return i.SetMatrix=function(r,t,n,o,a){var i=null;if('MODEL'===n.semantic?i=t.getWorldMatrix():'PROJECTION'===n.semantic?i=r.getProjectionMatrix():'VIEW'===n.semantic?i=r.getViewMatrix():'MODELVIEWINVERSETRANSPOSE'===n.semantic?i=l.Matrix.Transpose(t.getWorldMatrix().multiply(r.getViewMatrix()).invert()):'MODELVIEW'===n.semantic?i=t.getWorldMatrix().multiply(r.getViewMatrix()):'MODELVIEWPROJECTION'===n.semantic?i=t.getWorldMatrix().multiply(r.getTransformMatrix()):'MODELINVERSE'===n.semantic?i=t.getWorldMatrix().invert():'VIEWINVERSE'===n.semantic?i=r.getViewMatrix().invert():'PROJECTIONINVERSE'===n.semantic?i=r.getProjectionMatrix().invert():'MODELVIEWINVERSE'===n.semantic?i=t.getWorldMatrix().multiply(r.getViewMatrix()).invert():'MODELVIEWPROJECTIONINVERSE'===n.semantic?i=t.getWorldMatrix().multiply(r.getTransformMatrix()).invert():'MODELINVERSETRANSPOSE'===n.semantic&&(i=l.Matrix.Transpose(t.getWorldMatrix().invert())),i)switch(n.type){case e.EParameterType.FLOAT_MAT2:a.setMatrix2x2(o,l.Matrix.GetAsMatrix2x2(i));break;case e.EParameterType.FLOAT_MAT3:a.setMatrix3x3(o,l.Matrix.GetAsMatrix3x3(i));break;case e.EParameterType.FLOAT_MAT4:a.setMatrix(o,i);}},i.SetUniform=function(r,t,i,o){return o===e.EParameterType.FLOAT?(r.setFloat(t,i),!0):o===e.EParameterType.FLOAT_VEC2?(r.setVector2(t,l.Vector2.FromArray(i)),!0):o===e.EParameterType.FLOAT_VEC3?(r.setVector3(t,l.Vector3.FromArray(i)),!0):!(o!==e.EParameterType.FLOAT_VEC4)&&(r.setVector4(t,l.Vector4.FromArray(i)),!0)},i.GetWrapMode=function(r){switch(r){case e.ETextureWrapMode.CLAMP_TO_EDGE:return l.Texture.CLAMP_ADDRESSMODE;case e.ETextureWrapMode.MIRRORED_REPEAT:return l.Texture.MIRROR_ADDRESSMODE;case e.ETextureWrapMode.REPEAT:default:return l.Texture.WRAP_ADDRESSMODE;}},i.GetByteStrideFromType=function(t){switch(t.type){case'VEC2':return 2;case'VEC3':return 3;case'VEC4':case'MAT2':return 4;case'MAT3':return 9;case'MAT4':return 16;default:return 1;}},i.GetTextureFilterMode=function(r){return r===e.ETextureFilterType.LINEAR||r===e.ETextureFilterType.LINEAR_MIPMAP_NEAREST||r===e.ETextureFilterType.LINEAR_MIPMAP_LINEAR?l.Texture.TRILINEAR_SAMPLINGMODE:r===e.ETextureFilterType.NEAREST||r===e.ETextureFilterType.NEAREST_MIPMAP_NEAREST?l.Texture.NEAREST_SAMPLINGMODE:l.Texture.BILINEAR_SAMPLINGMODE},i.GetBufferFromBufferView=function(r,l,t,n,o){var t=l.byteOffset+t,a=r.loadedBufferViews[l.buffer];if(t+n>a.byteLength)throw new Error('Buffer access is out of range');var i=a.buffer;switch(t+=a.byteOffset,o){case e.EComponentType.BYTE:return new Int8Array(i,t,n);case e.EComponentType.UNSIGNED_BYTE:return new Uint8Array(i,t,n);case e.EComponentType.SHORT:return new Int16Array(i,t,n);case e.EComponentType.UNSIGNED_SHORT:return new Uint16Array(i,t,n);default:return new Float32Array(i,t,n);}},i.GetBufferFromAccessor=function(t,e){var r=t.bufferViews[e.bufferView],a=e.count*i.GetByteStrideFromType(e);return i.GetBufferFromBufferView(t,r,e.byteOffset,a,e.componentType)},i.DecodeBufferToText=function(o){for(var e='',r=o.byteLength,t=0;t<r;++t)e+=a(o[t]);return e},i.GetDefaultMaterial=function(e){if(!i._DefaultMaterial){l.Effect.ShadersStore.GLTFDefaultMaterialVertexShader='precision highp float;\n\nuniform mat4 worldView;\nuniform mat4 projection;\n\nattribute vec3 position;\n\nvoid main(void)\n{\n    gl_Position = projection * worldView * vec4(position, 1.0);\n}',l.Effect.ShadersStore.GLTFDefaultMaterialPixelShader='precision highp float;\n\nuniform vec4 u_emission;\n\nvoid main(void)\n{\n    gl_FragColor = u_emission;\n}';i._DefaultMaterial=new l.ShaderMaterial('GLTFDefaultMaterial',e,{vertex:'GLTFDefaultMaterial',fragment:'GLTFDefaultMaterial'},{attributes:['position'],uniforms:['worldView','projection','u_emission'],samplers:[],needAlphaBlending:!1}),i._DefaultMaterial.setColor4('u_emission',new l.Color4(.5,.5,.5,1))}return i._DefaultMaterial},i._DefaultMaterial=null,i}();e.GLTFUtils=r}(l.GLTF1||(l.GLTF1={}))}(t||(t={}));var t;!function(t){!function(s){var e=function(){function l(t){this._name=t}return Object.defineProperty(l.prototype,'name',{get:function(){return this._name},enumerable:!0,configurable:!0}),l.prototype.loadRuntimeAsync=function(){return!1},l.prototype.loadRuntimeExtensionsAsync=function(){return!1},l.prototype.loadBufferAsync=function(){return!1},l.prototype.loadTextureBufferAsync=function(){return!1},l.prototype.createTextureAsync=function(){return!1},l.prototype.loadShaderStringAsync=function(){return!1},l.prototype.loadMaterialAsync=function(){return!1},l.LoadRuntimeAsync=function(r,t,n,o,a){l.ApplyExtensions(function(i){return i.loadRuntimeAsync(r,t,n,o,a)},function(){setTimeout(function(){o&&o(s.GLTFLoaderBase.CreateRuntime(t.json,r,n))})})},l.LoadRuntimeExtensionsAsync=function(o,e,t){l.ApplyExtensions(function(i){return i.loadRuntimeExtensionsAsync(o,e,t)},function(){setTimeout(function(){e()})})},l.LoadBufferAsync=function(r,t,n,o,a){l.ApplyExtensions(function(i){return i.loadBufferAsync(r,t,n,o,a)},function(){s.GLTFLoaderBase.LoadBufferAsync(r,t,n,o,a)})},l.LoadTextureAsync=function(r,e,t,i){l.LoadTextureBufferAsync(r,e,function(o){o&&l.CreateTextureAsync(r,e,o,t,i)},i)},l.LoadShaderStringAsync=function(r,t,i,o){l.ApplyExtensions(function(a){return a.loadShaderStringAsync(r,t,i,o)},function(){s.GLTFLoaderBase.LoadShaderStringAsync(r,t,i,o)})},l.LoadMaterialAsync=function(r,t,i,o){l.ApplyExtensions(function(a){return a.loadMaterialAsync(r,t,i,o)},function(){s.GLTFLoaderBase.LoadMaterialAsync(r,t,i,o)})},l.LoadTextureBufferAsync=function(r,t,i,o){l.ApplyExtensions(function(a){return a.loadTextureBufferAsync(r,t,i,o)},function(){s.GLTFLoaderBase.LoadTextureBufferAsync(r,t,i,o)})},l.CreateTextureAsync=function(r,t,n,o,a){l.ApplyExtensions(function(i){return i.createTextureAsync(r,t,n,o,a)},function(){s.GLTFLoaderBase.CreateTextureAsync(r,t,n,o,a)})},l.ApplyExtensions=function(e,r){for(var t in s.GLTFLoader.Extensions)if(e(s.GLTFLoader.Extensions[t]))return;r()},l}();s.GLTFLoaderExtension=e}(t.GLTF1||(t.GLTF1={}))}(t||(t={}));var t;!function(t){!function(c){var e=function(e){function t(){return e.call(this,'KHR_binary_glTF')||this}return d(t,e),t.prototype.loadRuntimeAsync=function(e,r,t,a){var o=r.json.extensionsUsed;return o&&-1!==o.indexOf(this.name)&&r.bin&&(this._bin=r.bin,a(c.GLTFLoaderBase.CreateRuntime(r.json,e,t)),!0)},t.prototype.loadBufferAsync=function(o,e,r){return-1!==o.extensionsUsed.indexOf(this.name)&&'binary_glTF'===e&&(r(this._bin),!0)},t.prototype.loadTextureBufferAsync=function(e,r,t){var o=e.textures[r],a=e.images[o.source];if(!(a.extensions&&this.name in a.extensions))return!1;var i=a.extensions[this.name],n=e.bufferViews[i.bufferView];return t(c.GLTFUtils.GetBufferFromBufferView(e,n,0,n.byteLength,c.EComponentType.UNSIGNED_BYTE)),!0},t.prototype.loadShaderStringAsync=function(e,r,t){var o=e.shaders[r];if(!(o.extensions&&this.name in o.extensions))return!1;var a=o.extensions[this.name],i=e.bufferViews[a.bufferView],n=c.GLTFUtils.GetBufferFromBufferView(e,i,0,i.byteLength,c.EComponentType.UNSIGNED_BYTE);return setTimeout(function(){var e=c.GLTFUtils.DecodeBufferToText(n);t(e)}),!0},t}(c.GLTFLoaderExtension);c.GLTFBinaryExtension=e,c.GLTFLoader.RegisterExtension(new e)}(t.GLTF1||(t.GLTF1={}))}(t||(t={}));var t;!function(_){!function(s){var e=function(e){function t(){return e.call(this,'KHR_materials_common')||this}return d(t,e),t.prototype.loadRuntimeExtensionsAsync=function(e){if(!e.extensions)return!1;var t=e.extensions[this.name];if(!t)return!1;var r=t.lights;if(r)for(var a in r){var i=r[a];switch(i.type){case'ambient':var n=new _.HemisphericLight(i.name,new _.Vector3(0,1,0),e.scene),s=i.ambient;s&&(n.diffuse=_.Color3.FromArray(s.color||[1,1,1]));break;case'point':var u=new _.PointLight(i.name,new _.Vector3(10,10,10),e.scene),c=i.point;c&&(u.diffuse=_.Color3.FromArray(c.color||[1,1,1]));break;case'directional':var d=new _.DirectionalLight(i.name,new _.Vector3(0,-1,0),e.scene),f=i.directional;f&&(d.diffuse=_.Color3.FromArray(f.color||[1,1,1]));break;case'spot':var g=i.spot;if(g){var p=new _.SpotLight(i.name,new _.Vector3(0,10,0),new _.Vector3(0,-1,0),g.fallOffAngle||l,g.fallOffExponent||0,e.scene);p.diffuse=_.Color3.FromArray(g.color||[1,1,1])}break;default:_.Tools.Warn('GLTF Material Common extension: light type "'+i.type+'\u201D not supported');}}return!1},t.prototype.loadMaterialAsync=function(e,r,t,n){var o=e.materials[r];if(!o||!o.extensions)return!1;var l=o.extensions[this.name];if(!l)return!1;var d=new _.StandardMaterial(r,e.scene);return d.sideOrientation=_.Material.CounterClockWiseSideOrientation,'CONSTANT'===l.technique&&(d.disableLighting=!0),d.backFaceCulling=void 0!==l.doubleSided&&!l.doubleSided,d.alpha=void 0===l.values.transparency?1:l.values.transparency,d.specularPower=void 0===l.values.shininess?0:l.values.shininess,'string'==typeof l.values.ambient?this._loadTexture(e,l.values.ambient,d,'ambientTexture',n):d.ambientColor=_.Color3.FromArray(l.values.ambient||[0,0,0]),'string'==typeof l.values.diffuse?this._loadTexture(e,l.values.diffuse,d,'diffuseTexture',n):d.diffuseColor=_.Color3.FromArray(l.values.diffuse||[0,0,0]),'string'==typeof l.values.emission?this._loadTexture(e,l.values.emission,d,'emissiveTexture',n):d.emissiveColor=_.Color3.FromArray(l.values.emission||[0,0,0]),'string'==typeof l.values.specular?this._loadTexture(e,l.values.specular,d,'specularTexture',n):d.specularColor=_.Color3.FromArray(l.values.specular||[0,0,0]),!0},t.prototype._loadTexture=function(t,e,r,i,o){s.GLTFLoaderBase.LoadTextureBufferAsync(t,e,function(a){s.GLTFLoaderBase.CreateTextureAsync(t,e,a,function(t){return r[i]=t},o)},o)},t}(s.GLTFLoaderExtension);s.GLTFMaterialsCommonExtension=e,s.GLTFLoader.RegisterExtension(new e)}(_.GLTF1||(_.GLTF1={}))}(t||(t={}));var t;!function(t){!function(t){var e=function(){function t(){}return t.Assign=function(t){if(t)for(var e=0;e<t.length;e++)t[e]._index=e},t}();t._ArrayItem=e}(t.GLTF2||(t.GLTF2={}))}(t||(t={}));var t;!function(p){!function(_){var e=function(){function m(){this._completePromises=[],this._disposed=!1,this._state=null,this._extensions={},this._defaultSampler={},this._defaultBabylonMaterials={},this._requests=[],this.coordinateSystemMode=p.GLTFLoaderCoordinateSystemMode.AUTO,this.animationStartMode=p.GLTFLoaderAnimationStartMode.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this._normalizeAnimationGroupsToBeginAtZero=!0,this.preprocessUrlAsync=function(t){return Promise.resolve(t)},this.onMeshLoadedObservable=new p.Observable,this.onTextureLoadedObservable=new p.Observable,this.onMaterialLoadedObservable=new p.Observable,this.onCameraLoadedObservable=new p.Observable,this.onCompleteObservable=new p.Observable,this.onDisposeObservable=new p.Observable,this.onExtensionLoadedObservable=new p.Observable}return m._Register=function(e,t){return m._ExtensionFactories[e]?void p.Tools.Error('Extension with the name \''+e+'\' already exists'):void(m._ExtensionFactories[e]=t,m._ExtensionNames.push(e))},Object.defineProperty(m.prototype,'state',{get:function(){return this._state},enumerable:!0,configurable:!0}),m.prototype.dispose=function(){this._disposed||(this._disposed=!0,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._clear())},m.prototype.importMeshAsync=function(d,e,r,t,n){var o=this;return Promise.resolve().then(function(){var a=null;if(d){var i={};if(o._gltf.nodes)for(var s=0,l=o._gltf.nodes,p;s<l.length;s++)p=l[s],p.name&&(i[p.name]=p);a=(d instanceof Array?d:[d]).map(function(t){var e=i[t];if(!e)throw new Error('Failed to find node \''+t+'\'');return e})}return o._loadAsync(a,e,r,t,n).then(function(){return{meshes:o._getMeshes(),particleSystems:[],skeletons:o._getSkeletons(),animationGroups:o._getAnimationGroups()}})})},m.prototype.loadAsync=function(o,e,r,t){return this._loadAsync(null,o,e,r,t)},m.prototype._loadAsync=function(e,t,r,o,a){var i=this;return Promise.resolve().then(function(){i._babylonScene=t,i._rootUrl=o,i._progressCallback=a,i._state=p.GLTFLoaderState.LOADING,i._loadData(r),i._loadExtensions(),i._checkExtensions();var n=[];if(e)n.push(i._loadNodesAsync(e));else{var s=m._GetProperty('#/scene',i._gltf.scenes,i._gltf.scene||0);n.push(i._loadSceneAsync('#/scenes/'+s._index,s))}i.compileMaterials&&n.push(i._compileMaterialsAsync()),i.compileShadowGenerators&&n.push(i._compileShadowGeneratorsAsync());var l=Promise.all(n).then(function(){i._state=p.GLTFLoaderState.READY,i._startAnimations()});return l.then(function(){i._rootBabylonMesh.setEnabled(!0),p.Tools.SetImmediate(function(){i._disposed||Promise.all(i._completePromises).then(function(){i._state=p.GLTFLoaderState.COMPLETE,i.onCompleteObservable.notifyObservers(i),i.onCompleteObservable.clear(),i._clear()}).catch(function(e){p.Tools.Error('glTF Loader: '+e.message),i._clear()})})}),l}).catch(function(e){if(!i._disposed)throw p.Tools.Error('glTF Loader: '+e.message),i._clear(),e})},m.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var r=this._gltf.buffers;if(r&&r[0]&&!r[0].uri){var t=r[0];(t.byteLength<e.bin.byteLength-3||t.byteLength>e.bin.byteLength)&&p.Tools.Warn('Binary buffer length ('+t.byteLength+') from JSON does not match chunk length ('+e.bin.byteLength+')'),t._data=Promise.resolve(e.bin)}else p.Tools.Warn('Unexpected BIN chunk')}},m.prototype._setupData=function(){if(_._ArrayItem.Assign(this._gltf.accessors),_._ArrayItem.Assign(this._gltf.animations),_._ArrayItem.Assign(this._gltf.buffers),_._ArrayItem.Assign(this._gltf.bufferViews),_._ArrayItem.Assign(this._gltf.cameras),_._ArrayItem.Assign(this._gltf.images),_._ArrayItem.Assign(this._gltf.materials),_._ArrayItem.Assign(this._gltf.meshes),_._ArrayItem.Assign(this._gltf.nodes),_._ArrayItem.Assign(this._gltf.samplers),_._ArrayItem.Assign(this._gltf.scenes),_._ArrayItem.Assign(this._gltf.skins),_._ArrayItem.Assign(this._gltf.textures),this._gltf.nodes){for(var r={},e=0,t=this._gltf.nodes,n;e<t.length;e++)if(n=t[e],n.children)for(var o=0,a=n.children,i;o<a.length;o++)i=a[o],r[i]=n._index;for(var s=this._createRootNode(),l=0,p=this._gltf.nodes;l<p.length;l++){var n=p[l],c=r[n._index];n._parent=void 0===c?s:this._gltf.nodes[c]}}},m.prototype._loadExtensions=function(){for(var t=0,e=m._ExtensionNames;t<e.length;t++){var r=e[t],i=m._ExtensionFactories[r](this);this._extensions[r]=i,this.onExtensionLoadedObservable.notifyObservers(i)}this.onExtensionLoadedObservable.clear()},m.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var o=0,e=this._gltf.extensionsRequired;o<e.length;o++){var r=e[o],t=this._extensions[r];if(!t||!t.enabled)throw new Error('Require extension '+r+' is not available')}},m.prototype._createRootNode=function(){this._rootBabylonMesh=new p.Mesh('__root__',this._babylonScene),this._rootBabylonMesh.setEnabled(!1);var e={_babylonMesh:this._rootBabylonMesh};switch(this.coordinateSystemMode){case p.GLTFLoaderCoordinateSystemMode.AUTO:this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],m._LoadTransform(e,this._rootBabylonMesh));break;case p.GLTFLoaderCoordinateSystemMode.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error('Invalid coordinate system mode ('+this.coordinateSystemMode+')');}return this.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e},m.prototype._loadNodesAsync=function(i){for(var e=[],r=0,t=i,a;r<t.length;r++)a=t[r],e.push(this._loadNodeAsync('#/nodes/'+a._index,a));return e.push(this._loadAnimationsAsync()),Promise.all(e).then(function(){})},m.prototype._loadSceneAsync=function(t,e){var r=_.GLTFLoaderExtension._LoadSceneAsync(this,t,e);if(r)return r;for(var o=[],a=0,i=e.nodes;a<i.length;a++){var n=i[a],s=m._GetProperty(t+'/nodes/'+n,this._gltf.nodes,n);o.push(this._loadNodeAsync('#/nodes/'+s._index,s))}return o.push(this._loadAnimationsAsync()),Promise.all(o).then(function(){})},m.prototype._forEachPrimitive=function(i,e){if(i._primitiveBabylonMeshes)for(var r=0,t=i._primitiveBabylonMeshes,a;r<t.length;r++)a=t[r],e(a);else e(i._babylonMesh)},m.prototype._getMeshes=function(){var l=[];l.push(this._rootBabylonMesh);var e=this._gltf.nodes;if(e)for(var r=0,t=e,n;r<t.length;r++)if(n=t[r],n._babylonMesh&&l.push(n._babylonMesh),n._primitiveBabylonMeshes)for(var o=0,a=n._primitiveBabylonMeshes,i;o<a.length;o++)i=a[o],l.push(i);return l},m.prototype._getSkeletons=function(){var i=[],e=this._gltf.skins;if(e)for(var r=0,t=e,a;r<t.length;r++)a=t[r],a._babylonSkeleton&&i.push(a._babylonSkeleton);return i},m.prototype._getAnimationGroups=function(){var i=[],e=this._gltf.animations;if(e)for(var r=0,t=e,a;r<t.length;r++)a=t[r],a._babylonAnimationGroup&&i.push(a._babylonAnimationGroup);return i},m.prototype._startAnimations=function(){switch(this.animationStartMode){case p.GLTFLoaderAnimationStartMode.NONE:break;case p.GLTFLoaderAnimationStartMode.FIRST:var e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break;case p.GLTFLoaderAnimationStartMode.ALL:for(var e=this._getAnimationGroups(),r=0,t=e;r<t.length;r++)t[r].start(!0);break;default:return void p.Tools.Error('Invalid animation start mode ('+this.animationStartMode+')');}},m.prototype._loadNodeAsync=function(e,t){var r=_.GLTFLoaderExtension._LoadNodeAsync(this,e,t);if(r)return r;if(t._babylonMesh)throw new Error(e+': Invalid recursive node hierarchy');var o=[],i=new p.Mesh(t.name||'node'+t._index,this._babylonScene,t._parent._babylonMesh);if(t._babylonMesh=i,m._LoadTransform(t,i),void 0!=t.mesh){var a=m._GetProperty(e+'/mesh',this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync('#/meshes/'+a._index,t,a,i))}if(void 0!=t.camera){var n=m._GetProperty(e+'/camera',this._gltf.cameras,t.camera);this._loadCamera('#/cameras/'+n._index,n,i)}if(t.children)for(var s=0,l=t.children;s<l.length;s++){var d=l[s],c=m._GetProperty(e+'/children/'+d,this._gltf.nodes,d);o.push(this._loadNodeAsync('#/nodes/'+d,c))}return this.onMeshLoadedObservable.notifyObservers(i),Promise.all(o).then(function(){})},m.prototype._loadMeshAsync=function(e,t,r,o){var i=this,a=[],n=r.primitives;if(!n||0===n.length)throw new Error(e+': Primitives are missing');if(_._ArrayItem.Assign(n),1===n.length){var s=n[0];a.push(this._loadPrimitiveAsync(e+'/primitives/'+s._index,t,r,s,o))}else{t._primitiveBabylonMeshes=[];for(var l=0,d=n;l<d.length;l++){var s=d[l],c=new p.Mesh((r.name||o.name)+'_'+s._index,this._babylonScene,o);t._primitiveBabylonMeshes.push(c),a.push(this._loadPrimitiveAsync(e+'/primitives/'+s._index,t,r,s,c)),this.onMeshLoadedObservable.notifyObservers(o)}}if(void 0!=t.skin){var f=m._GetProperty(e+'/skin',this._gltf.skins,t.skin);a.push(this._loadSkinAsync('#/skins/'+f._index,t,r,f))}return Promise.all(a).then(function(){i._forEachPrimitive(t,function(t){t._refreshBoundingInfo(!0)})})},m.prototype._loadPrimitiveAsync=function(t,e,r,n,o){var a=this,i=[];this._createMorphTargets(t,e,r,n,o),i.push(this._loadVertexDataAsync(t,n,o).then(function(e){return a._loadMorphTargetsAsync(t,n,o,e).then(function(){e.applyToMesh(o)})}));var s=m._GetDrawMode(t,n.mode);if(void 0==n.material)o.material=this._getDefaultMaterial(s);else{var l=m._GetProperty(t+'/material}',this._gltf.materials,n.material);i.push(this._loadMaterialAsync('#/materials/'+l._index,l,o,s,function(t){o.material=t}))}return Promise.all(i).then(function(){})},m.prototype._loadVertexDataAsync=function(t,e,n){var a=this,r=_.GLTFLoaderExtension._LoadVertexDataAsync(this,t,e,n);if(r)return r;var i=e.attributes;if(!i)throw new Error(t+': Attributes are missing');var g=[],o=new p.Geometry(n.name,this._babylonScene);if(void 0==e.indices)n.isUnIndexed=!0;else{var s=m._GetProperty(t+'/indices',this._gltf.accessors,e.indices);g.push(this._loadIndicesAccessorAsync('#/accessors/'+s._index,s).then(function(t){o.setIndices(t)}))}var d=function(l,e,r){if(void 0!=i[l]){n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(e)&&n._delayInfo.push(e);var d=m._GetProperty(t+'/attributes/'+l,a._gltf.accessors,i[l]);g.push(a._loadVertexAccessorAsync('#/accessors/'+d._index,d,e).then(function(t){o.setVerticesBuffer(t,d.count)})),r&&r(d)}};return d('POSITION',p.VertexBuffer.PositionKind),d('NORMAL',p.VertexBuffer.NormalKind),d('TANGENT',p.VertexBuffer.TangentKind),d('TEXCOORD_0',p.VertexBuffer.UVKind),d('TEXCOORD_1',p.VertexBuffer.UV2Kind),d('JOINTS_0',p.VertexBuffer.MatricesIndicesKind),d('WEIGHTS_0',p.VertexBuffer.MatricesWeightsKind),d('COLOR_0',p.VertexBuffer.ColorKind,function(t){'VEC4'===t.type&&(n.hasVertexAlpha=!0)}),Promise.all(g).then(function(){return o})},m.prototype._createMorphTargets=function(e,r,t,n,o){if(n.targets){if(void 0==r._numMorphTargets)r._numMorphTargets=n.targets.length;else if(n.targets.length!==r._numMorphTargets)throw new Error(e+': Primitives do not have the same number of targets');o.morphTargetManager=new p.MorphTargetManager;for(var a=0,i;a<n.targets.length;a++)i=r.weights?r.weights[a]:t.weights?t.weights[a]:0,o.morphTargetManager.addTarget(new p.MorphTarget('morphTarget'+a,i))}},m.prototype._loadMorphTargetsAsync=function(l,e,r,t){if(!e.targets)return Promise.resolve();for(var n=[],o=r.morphTargetManager,a=0,i;a<o.numTargets;a++)i=o.getTarget(a),n.push(this._loadMorphTargetVertexDataAsync(l+'/targets/'+a,t,e.targets[a],i));return Promise.all(n).then(function(){})},m.prototype._loadMorphTargetVertexDataAsync=function(t,r,n,o){var a=this,i=[],e=function(o,e,s){if(void 0!=n[o]){var l=r.getVertexBuffer(e);if(l){var d=m._GetProperty(t+'/'+o,a._gltf.accessors,n[o]);i.push(a._loadFloatAccessorAsync('#/accessors/'+d._index,d).then(function(t){s(l,t)}))}}};return e('POSITION',p.VertexBuffer.PositionKind,function(t,i){t.forEach(i.length,function(r,e){i[e]+=r}),o.setPositions(i)}),e('NORMAL',p.VertexBuffer.NormalKind,function(t,i){t.forEach(i.length,function(r,e){i[e]+=r}),o.setNormals(i)}),e('TANGENT',p.VertexBuffer.TangentKind,function(i,a){var r=0;i.forEach(4*(a.length/3),function(t,e){0!=(e+1)%4&&(a[r++]+=t)}),o.setTangents(a)}),Promise.all(i).then(function(){})},m._LoadTransform=function(e,r){var t=p.Vector3.Zero(),i=p.Quaternion.Identity(),o=p.Vector3.One();e.matrix?p.Matrix.FromArray(e.matrix).decompose(o,i,t):(e.translation&&(t=p.Vector3.FromArray(e.translation)),e.rotation&&(i=p.Quaternion.FromArray(e.rotation)),e.scale&&(o=p.Vector3.FromArray(e.scale))),r.position=t,r.rotationQuaternion=i,r.scaling=o},m.prototype._loadSkinAsync=function(e,d,t,r){var o=this,a=function(t){o._forEachPrimitive(d,function(r){r.skeleton=t}),d._babylonMesh.parent=o._rootBabylonMesh,d._babylonMesh.position=p.Vector3.Zero(),d._babylonMesh.rotationQuaternion=p.Quaternion.Identity(),d._babylonMesh.scaling=p.Vector3.One()};if(r._loaded)return r._loaded.then(function(){a(r._babylonSkeleton)});var i='skeleton'+r._index,n=new p.Skeleton(r.name||i,i,this._babylonScene);return r._babylonSkeleton=n,this._loadBones(e,r),a(n),r._loaded=this._loadSkinInverseBindMatricesDataAsync(e,r).then(function(t){o._updateBoneMatrices(n,t)})},m.prototype._loadBones=function(t,e){for(var r={},n=0,o=e.joints;n<o.length;n++){var a=o[n],i=m._GetProperty(t+'/joints/'+a,this._gltf.nodes,a);this._loadBone(i,e,r)}},m.prototype._loadBone=function(e,r,t){var n=t[e._index];if(n)return n;var o=null;e._parent._babylonMesh!==this._rootBabylonMesh&&(o=this._loadBone(e._parent,r,t));var a=r.joints.indexOf(e._index);return n=new p.Bone(e.name||'joint'+e._index,r._babylonSkeleton,o,this._getNodeMatrix(e),null,null,a),t[e._index]=n,e._babylonBones=e._babylonBones||[],e._babylonBones.push(n),n},m.prototype._loadSkinInverseBindMatricesDataAsync=function(t,e){if(void 0==e.inverseBindMatrices)return Promise.resolve(null);var r=m._GetProperty(t+'/inverseBindMatrices',this._gltf.accessors,e.inverseBindMatrices);return this._loadFloatAccessorAsync('#/accessors/'+r._index,r)},m.prototype._updateBoneMatrices=function(e,r){for(var t=0,n=e.bones;t<n.length;t++){var o=n[t],a=p.Matrix.Identity(),i=o._index;r&&-1!==i&&(p.Matrix.FromArrayToRef(r,16*i,a),a.invertToRef(a));var s=o.getParent();s&&a.multiplyToRef(s.getInvertedAbsoluteTransform(),a),o.updateMatrix(a,!1,!1),o._updateDifferenceMatrix(void 0,!1)}},m.prototype._getNodeMatrix=function(e){return e.matrix?p.Matrix.FromArray(e.matrix):p.Matrix.Compose(e.scale?p.Vector3.FromArray(e.scale):p.Vector3.One(),e.rotation?p.Quaternion.FromArray(e.rotation):p.Quaternion.Identity(),e.translation?p.Vector3.FromArray(e.translation):p.Vector3.Zero())},m.prototype._loadCamera=function(e,r,t){var i=new p.FreeCamera(r.name||'camera'+r._index,p.Vector3.Zero(),this._babylonScene,!1);switch(i.parent=t,i.rotation=new p.Vector3(0,l,0),r.type){case'perspective':var o=r.perspective;if(!o)throw new Error(e+': Camera perspective properties are missing');i.fov=o.yfov,i.minZ=o.znear,i.maxZ=o.zfar||s;break;case'orthographic':if(!r.orthographic)throw new Error(e+': Camera orthographic properties are missing');i.mode=p.Camera.ORTHOGRAPHIC_CAMERA,i.orthoLeft=-r.orthographic.xmag,i.orthoRight=r.orthographic.xmag,i.orthoBottom=-r.orthographic.ymag,i.orthoTop=r.orthographic.ymag,i.minZ=r.orthographic.znear,i.maxZ=r.orthographic.zfar;break;default:throw new Error(e+': Invalid camera type ('+r.type+')');}this.onCameraLoadedObservable.notifyObservers(i)},m.prototype._loadAnimationsAsync=function(){var o=this._gltf.animations;if(!o)return Promise.resolve();for(var i=[],r=0,t;r<o.length;r++)t=o[r],i.push(this._loadAnimationAsync('#/animations/'+r,t));return Promise.all(i).then(function(){})},m.prototype._loadAnimationAsync=function(e,t){var r=this,o=new p.AnimationGroup(t.name||'animation'+t._index,this._babylonScene);t._babylonAnimationGroup=o;var a=[];_._ArrayItem.Assign(t.channels),_._ArrayItem.Assign(t.samplers);for(var i=0,n=t.channels,s;i<n.length;i++)s=n[i],a.push(this._loadAnimationChannelAsync(e+'/channels/'+s._index,e,t,s,o));return Promise.all(a).then(function(){o.normalize(r._normalizeAnimationGroupsToBeginAtZero?0:null)})},m.prototype._loadAnimationChannelAsync=function(e,t,r,d,c){var i=this,s=m._GetProperty(e+'/target/node',this._gltf.nodes,d.target.node);if('weights'===d.target.path&&!s._numMorphTargets||'weights'!==d.target.path&&!s._babylonMesh)return Promise.resolve();if(void 0!=s.skin&&'weights'!==d.target.path)return Promise.resolve();var o=m._GetProperty(e+'/sampler',r.samplers,d.sampler);return this._loadAnimationSamplerAsync(t+'/samplers/'+d.sampler,o).then(function(a){var l,n;switch(d.target.path){case'translation':l='position',n=p.Animation.ANIMATIONTYPE_VECTOR3;break;case'rotation':l='rotationQuaternion',n=p.Animation.ANIMATIONTYPE_QUATERNION;break;case'scale':l='scaling',n=p.Animation.ANIMATIONTYPE_VECTOR3;break;case'weights':l='influence',n=p.Animation.ANIMATIONTYPE_FLOAT;break;default:throw new Error(e+': Invalid target path ('+d.target.path+')');}var t=0,o;'position'===l?o=function(){var e=p.Vector3.FromArray(a.output,t);return t+=3,e}:'rotationQuaternion'===l?o=function(){var e=p.Quaternion.FromArray(a.output,t);return t+=4,e}:'scaling'===l?o=function(){var e=p.Vector3.FromArray(a.output,t);return t+=3,e}:'influence'===l?o=function(){for(var o=Array(s._numMorphTargets),e=0;e<s._numMorphTargets;e++)o[e]=a.output[t++];return o}:void 0;var r;switch(a.interpolation){case'STEP':r=function(e){return{frame:a.input[e],value:o(),interpolation:p.AnimationKeyInterpolation.STEP}};break;case'LINEAR':r=function(t){return{frame:a.input[t],value:o()}};break;case'CUBICSPLINE':r=function(t){return{frame:a.input[t],inTangent:o(),value:o(),outTangent:o()}};}for(var u=Array(a.input.length),f=0;f<a.input.length;f++)u[f]=r(f);if('influence'===l)for(var g=0;g<s._numMorphTargets;g++)!function(o){var e=c.name+'_channel'+c.targetedAnimations.length,r=new p.Animation(e,l,1,n);r.setKeys(u.map(function(t){return{frame:t.frame,inTangent:t.inTangent?t.inTangent[o]:void 0,value:t.value[o],outTangent:t.outTangent?t.outTangent[o]:void 0}})),i._forEachPrimitive(s,function(i){var e=i.morphTargetManager.getTarget(o),t=r.clone();e.animations.push(t),c.addTargetedAnimation(t,e)})}(g);else{var h=c.name+'_channel'+c.targetedAnimations.length,m=new p.Animation(h,l,1,n);if(m.setKeys(u),s._babylonBones){for(var _=[s._babylonMesh].concat(s._babylonBones),y=0,T=_;y<T.length;y++)T[y].animations.push(m);c.addTargetedAnimation(m,_)}else s._babylonMesh.animations.push(m),c.addTargetedAnimation(m,s._babylonMesh)}})},m.prototype._loadAnimationSamplerAsync=function(t,e){if(e._data)return e._data;var i=e.interpolation||'LINEAR';switch(i){case'STEP':case'LINEAR':case'CUBICSPLINE':break;default:throw new Error(t+': Invalid interpolation ('+e.interpolation+')');}var r=m._GetProperty(t+'/input',this._gltf.accessors,e.input),o=m._GetProperty(t+'/output',this._gltf.accessors,e.output);return e._data=Promise.all([this._loadFloatAccessorAsync('#/accessors/'+r._index,r),this._loadFloatAccessorAsync('#/accessors/'+o._index,o)]).then(function(o){var e=o[0],a=o[1];return{input:e,interpolation:i,output:a}}),e._data},m.prototype._loadBufferAsync=function(t,e){if(e._data)return e._data;if(!e.uri)throw new Error(t+': Uri is missing');return e._data=this._loadUriAsync(t,e.uri),e._data},m.prototype._loadBufferViewAsync=function(t,e){if(e._data)return e._data;var r=m._GetProperty(t+'/buffer',this._gltf.buffers,e.buffer);return e._data=this._loadBufferAsync('#/buffers/'+r._index,r).then(function(r){try{return new Uint8Array(r.buffer,r.byteOffset+(e.byteOffset||0),e.byteLength)}catch(e){throw new Error(t+': '+e.message)}}),e._data},m.prototype._loadIndicesAccessorAsync=function(t,e){if('SCALAR'!==e.type)throw new Error(t+': Invalid type '+e.type);if(5121!==e.componentType&&5123!==e.componentType&&5125!==e.componentType)throw new Error(t+': Invalid component type '+e.componentType);if(e._data)return e._data;var r=m._GetProperty(t+'/bufferView',this._gltf.bufferViews,e.bufferView);return e._data=this._loadBufferViewAsync('#/bufferViews/'+r._index,r).then(function(r){return m._GetTypedArray(t,e.componentType,r,e.byteOffset,e.count)}),e._data},m.prototype._loadFloatAccessorAsync=function(t,e){var r=this;if(5126!==e.componentType)throw new Error('Invalid component type '+e.componentType);if(e._data)return e._data;var _=m._GetNumComponents(t,e.type),o=_*e.count;if(void 0==e.bufferView)e._data=Promise.resolve(new Float32Array(o));else{var a=m._GetProperty(t+'/bufferView',this._gltf.bufferViews,e.bufferView);e._data=this._loadBufferViewAsync('#/bufferViews/'+a._index,a).then(function(r){return m._GetTypedArray(t,e.componentType,r,e.byteOffset,o)})}if(e.sparse){var g=e.sparse;e._data=e._data.then(function(o){var a=m._GetProperty(t+'/sparse/indices/bufferView',r._gltf.bufferViews,g.indices.bufferView),i=m._GetProperty(t+'/sparse/values/bufferView',r._gltf.bufferViews,g.values.bufferView);return Promise.all([r._loadBufferViewAsync('#/bufferViews/'+a._index,a),r._loadBufferViewAsync('#/bufferViews/'+i._index,i)]).then(function(r){for(var a=r[0],i=r[1],n=m._GetTypedArray(t+'/sparse/indices',g.indices.componentType,a,g.indices.byteOffset,g.count),s=m._GetTypedArray(t+'/sparse/values',e.componentType,i,g.values.byteOffset,_*g.count),l=0,d=0;d<n.length;d++)for(var c=n[d]*_,u=0;u<_;u++)o[c++]=s[l++];return o})})}return e._data},m.prototype._loadVertexBufferViewAsync=function(e,r){var t=this;return r._babylonBuffer?r._babylonBuffer:(r._babylonBuffer=this._loadBufferViewAsync(e,r).then(function(e){return new p.Buffer(t._babylonScene.getEngine(),e,!1)}),r._babylonBuffer)},m.prototype._loadVertexAccessorAsync=function(e,t,n){var o=this;if(t._babylonVertexBuffer)return t._babylonVertexBuffer;if(t.sparse)t._babylonVertexBuffer=this._loadFloatAccessorAsync(e,t).then(function(e){return new p.VertexBuffer(o._babylonScene.getEngine(),e,n,!1)});else{var r=m._GetProperty(e+'/bufferView',this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer=this._loadVertexBufferViewAsync('#/bufferViews/'+r._index,r,n).then(function(i){var a=m._GetNumComponents(e,t.type);return new p.VertexBuffer(o._babylonScene.getEngine(),i,n,!1,!1,r.byteStride,!1,t.byteOffset,a,t.componentType,t.normalized,!0)})}return t._babylonVertexBuffer},m.prototype._getDefaultMaterial=function(e){var r=this._defaultBabylonMaterials[e];return r||(r=this._createMaterial('__gltf_default',e),r.transparencyMode=p.PBRMaterial.PBRMATERIAL_OPAQUE,r.metallic=1,r.roughness=1,this.onMaterialLoadedObservable.notifyObservers(r)),r},m.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,r,t){var i=[];t.metallic=1,t.roughness=1;var o=r.pbrMetallicRoughness;return o&&(o.baseColorFactor?(t.albedoColor=p.Color3.FromArray(o.baseColorFactor),t.alpha=o.baseColorFactor[3]):t.albedoColor=p.Color3.White(),t.metallic=void 0==o.metallicFactor?1:o.metallicFactor,t.roughness=void 0==o.roughnessFactor?1:o.roughnessFactor,o.baseColorTexture&&i.push(this._loadTextureAsync(e+'/baseColorTexture',o.baseColorTexture,function(r){t.albedoTexture=r})),o.metallicRoughnessTexture&&(i.push(this._loadTextureAsync(e+'/metallicRoughnessTexture',o.metallicRoughnessTexture,function(r){t.metallicTexture=r})),t.useMetallnessFromMetallicTextureBlue=!0,t.useRoughnessFromMetallicTextureGreen=!0,t.useRoughnessFromMetallicTextureAlpha=!1)),this._loadMaterialAlphaProperties(e,r,t),Promise.all(i).then(function(){})},m.prototype._loadMaterialAsync=function(r,e,t,n,o){var a=_.GLTFLoaderExtension._LoadMaterialAsync(this,r,e,t,n,o);if(a)return a;e._babylonData=e._babylonData||{};var i=e._babylonData[n];if(!i){var d=[],l=e.name||'materialSG_'+e._index,p=this._createMaterial(l,n);d.push(this._loadMaterialBasePropertiesAsync(r,e,p)),d.push(this._loadMaterialMetallicRoughnessPropertiesAsync(r,e,p)),this.onMaterialLoadedObservable.notifyObservers(p),i={material:p,meshes:[],loaded:Promise.all(d).then(function(){})},e._babylonData[n]=i}return i.meshes.push(t),o(i.material),i.loaded},m.prototype._createMaterial=function(e,r){var t=new p.PBRMaterial(e,this._babylonScene);return t.sideOrientation=this._babylonScene.useRightHandedSystem?p.Material.CounterClockWiseSideOrientation:p.Material.ClockWiseSideOrientation,t.fillMode=r,t.enableSpecularAntiAliasing=!0,t.useRadianceOverAlpha=!this.transparencyAsCoverage,t.useSpecularOverAlpha=!this.transparencyAsCoverage,t},m.prototype._loadMaterialBasePropertiesAsync=function(e,r,t){var i=[];return t.emissiveColor=r.emissiveFactor?p.Color3.FromArray(r.emissiveFactor):new p.Color3(0,0,0),r.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),r.normalTexture&&(i.push(this._loadTextureAsync(e+'/normalTexture',r.normalTexture,function(r){t.bumpTexture=r})),t.invertNormalMapX=!this._babylonScene.useRightHandedSystem,t.invertNormalMapY=this._babylonScene.useRightHandedSystem,void 0!=r.normalTexture.scale&&(t.bumpTexture.level=r.normalTexture.scale)),r.occlusionTexture&&(i.push(this._loadTextureAsync(e+'/occlusionTexture',r.occlusionTexture,function(r){t.ambientTexture=r})),t.useAmbientInGrayScale=!0,void 0!=r.occlusionTexture.strength&&(t.ambientTextureStrength=r.occlusionTexture.strength)),r.emissiveTexture&&i.push(this._loadTextureAsync(e+'/emissiveTexture',r.emissiveTexture,function(r){t.emissiveTexture=r})),Promise.all(i).then(function(){})},m.prototype._loadMaterialAlphaProperties=function(e,r,t){switch(r.alphaMode||'OPAQUE'){case'OPAQUE':t.transparencyMode=p.PBRMaterial.PBRMATERIAL_OPAQUE;break;case'MASK':t.transparencyMode=p.PBRMaterial.PBRMATERIAL_ALPHATEST,t.alphaCutOff=void 0==r.alphaCutoff?.5:r.alphaCutoff,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0);break;case'BLEND':t.transparencyMode=p.PBRMaterial.PBRMATERIAL_ALPHABLEND,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0,t.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(e+': Invalid alpha mode ('+r.alphaMode+')');}},m.prototype._loadTextureAsync=function(_,e,t){var r=this,o=m._GetProperty(_+'/index',this._gltf.textures,e.index);_='#/textures/'+e.index;var i=[],a=void 0==o.sampler?this._defaultSampler:m._GetProperty(_+'/sampler',this._gltf.samplers,o.sampler),n=this._loadSampler('#/samplers/'+a._index,a),s=new p.Deferred,l=new p.Texture(null,this._babylonScene,n.noMipMaps,!1,n.samplingMode,function(){r._disposed||s.resolve()},function(o,e){r._disposed||s.reject(new Error(_+': '+(e&&e.message?e.message:o||'Failed to load texture')))});i.push(s.promise),l.name=o.name||'texture'+o._index,l.wrapU=n.wrapU,l.wrapV=n.wrapV,l.coordinatesIndex=e.texCoord||0;var d=m._GetProperty(_+'/source',this._gltf.images,o.source);return i.push(this._loadImageAsync('#/images/'+d._index,d).then(function(t){l.updateURL(t)})),t(l),this.onTextureLoadedObservable.notifyObservers(l),Promise.all(i).then(function(){})},m.prototype._loadSampler=function(t,e){return e._data||(e._data={noMipMaps:9728===e.minFilter||9729===e.minFilter,samplingMode:m._GetTextureSamplingMode(t,e.magFilter,e.minFilter),wrapU:m._GetTextureWrapMode(t,e.wrapS),wrapV:m._GetTextureWrapMode(t,e.wrapT)}),e._data},m.prototype._loadImageAsync=function(t,i){if(i._objectURL)return i._objectURL;var e;if(i.uri)e=this._loadUriAsync(t,i.uri);else{var r=m._GetProperty(t+'/bufferView',this._gltf.bufferViews,i.bufferView);e=this._loadBufferViewAsync('#/bufferViews/'+r._index,r)}return i._objectURL=e.then(function(t){return URL.createObjectURL(new Blob([t],{type:i.mimeType}))}),i._objectURL},m.prototype._loadUriAsync=function(e,t){var o=this,r=_.GLTFLoaderExtension._LoadUriAsync(this,e,t);if(r)return r;if(!m._ValidateUri(t))throw new Error(e+': Uri \''+t+'\' is invalid');return p.Tools.IsBase64(t)?Promise.resolve(new Uint8Array(p.Tools.DecodeBase64(t))):this.preprocessUrlAsync(this._rootUrl+t).then(function(a){return new Promise(function(r,n){if(!o._disposed){var i=p.Tools.LoadFile(a,function(t){o._disposed||r(new Uint8Array(t))},function(e){if(!o._disposed)try{i&&o._state===p.GLTFLoaderState.LOADING&&(i._lengthComputable=e.lengthComputable,i._loaded=e.loaded,i._total=e.total,o._onProgress())}catch(t){n(t)}},o._babylonScene.database,!0,function(i){o._disposed||n(new p.LoadFileError(e+': Failed to load \''+t+'\''+(i?': '+i.status+' '+i.statusText:''),i))});o._requests.push(i)}})})},m.prototype._onProgress=function(){if(this._progressCallback){for(var e=!0,r=0,t=0,n=0,o=this._requests,a;n<o.length;n++){if(a=o[n],void 0===a._lengthComputable||void 0===a._loaded||void 0===a._total)return;e=e&&a._lengthComputable,r+=a._loaded,t+=a._total}this._progressCallback(new p.SceneLoaderProgressEvent(e,r,e?t:0))}},m._GetProperty=function(o,e,i){if(!e||void 0==i||!e[i])throw new Error(o+': Failed to find index ('+i+')');return e[i]},m._GetTextureWrapMode=function(e,r){switch(r=void 0==r?10497:r){case 33071:return p.Texture.CLAMP_ADDRESSMODE;case 33648:return p.Texture.MIRROR_ADDRESSMODE;case 10497:return p.Texture.WRAP_ADDRESSMODE;default:return p.Tools.Warn(e+': Invalid texture wrap mode ('+r+')'),p.Texture.WRAP_ADDRESSMODE;}},m._GetTextureSamplingMode=function(e,r,t){if(r=void 0==r?9729:r,t=void 0==t?9987:t,9729===r)return 9728===t?p.Texture.LINEAR_NEAREST:9729===t?p.Texture.LINEAR_LINEAR:9984===t?p.Texture.LINEAR_NEAREST_MIPNEAREST:9985===t?p.Texture.LINEAR_LINEAR_MIPNEAREST:9986===t?p.Texture.LINEAR_NEAREST_MIPLINEAR:9987===t?p.Texture.LINEAR_LINEAR_MIPLINEAR:(p.Tools.Warn(e+': Invalid texture minification filter ('+t+')'),p.Texture.LINEAR_LINEAR_MIPLINEAR);switch(9728!==r&&p.Tools.Warn(e+': Invalid texture magnification filter ('+r+')'),t){case 9728:return p.Texture.NEAREST_NEAREST;case 9729:return p.Texture.NEAREST_LINEAR;case 9984:return p.Texture.NEAREST_NEAREST_MIPNEAREST;case 9985:return p.Texture.NEAREST_LINEAR_MIPNEAREST;case 9986:return p.Texture.NEAREST_NEAREST_MIPLINEAR;case 9987:return p.Texture.NEAREST_LINEAR_MIPLINEAR;default:return p.Tools.Warn(e+': Invalid texture minification filter ('+t+')'),p.Texture.NEAREST_NEAREST_MIPNEAREST;}},m._GetTypedArray=function(i,e,r,t,n){var o=r.buffer;t=r.byteOffset+(t||0);try{switch(e){case 5120:return new Int8Array(o,t,n);case 5121:return new Uint8Array(o,t,n);case 5122:return new Int16Array(o,t,n);case 5123:return new Uint16Array(o,t,n);case 5125:return new Uint32Array(o,t,n);case 5126:return new Float32Array(o,t,n);default:throw new Error('Invalid component type '+e);}}catch(e){throw new Error(i+': '+e)}},m._GetNumComponents=function(t,e){switch(e){case'SCALAR':return 1;case'VEC2':return 2;case'VEC3':return 3;case'VEC4':case'MAT2':return 4;case'MAT3':return 9;case'MAT4':return 16;}throw new Error(t+': Invalid type ('+e+')')},m._ValidateUri=function(e){return p.Tools.IsBase64(e)||-1===e.indexOf('..')},m._GetDrawMode=function(e,r){switch(void 0==r&&(r=4),r){case 0:return p.Material.PointListDrawMode;case 1:return p.Material.LineListDrawMode;case 2:return p.Material.LineLoopDrawMode;case 3:return p.Material.LineStripDrawMode;case 4:return p.Material.TriangleFillMode;case 5:return p.Material.TriangleStripDrawMode;case 6:return p.Material.TriangleFanDrawMode;}throw new Error(e+': Invalid mesh primitive mode ('+r+')')},m.prototype._compileMaterialsAsync=function(){var d=[];if(this._gltf.materials)for(var e=0,r=this._gltf.materials,t;e<r.length;e++)if(t=r[e],t._babylonData)for(var n in t._babylonData)for(var o=t._babylonData[n],a=0,i=o.meshes,s;a<i.length;a++){s=i[a],s.computeWorldMatrix(!0);var l=o.material;d.push(l.forceCompilationAsync(s)),this.useClipPlane&&d.push(l.forceCompilationAsync(s,{clipPlane:!0}))}return Promise.all(d).then(function(){})},m.prototype._compileShadowGeneratorsAsync=function(){for(var i=[],e=this._babylonScene.lights,r=0,t=e;r<t.length;r++){var n=t[r],o=n.getShadowGenerator();o&&i.push(o.forceCompilationAsync())}return Promise.all(i).then(function(){})},m.prototype._clear=function(){for(var i=0,e=this._requests;i<e.length;i++)e[i].abort();if(this._requests.length=0,this._gltf&&this._gltf.images)for(var r=0,t=this._gltf.images,n;r<t.length;r++)n=t[r],n._objectURL&&(n._objectURL.then(function(t){URL.revokeObjectURL(t)}),n._objectURL=void 0);for(var o in delete this._gltf,delete this._babylonScene,this._completePromises.length=0,this._extensions)this._extensions[o].dispose();this._extensions={},delete this._rootBabylonMesh,delete this._progressCallback,this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear()},m.prototype._applyExtensions=function(t){for(var e=0,r=m._ExtensionNames;e<r.length;e++){var n=r[e],o=this._extensions[n];if(o.enabled){var a=t(o);if(a)return a}}return null},m._ExtensionNames=[],m._ExtensionFactories={},m}();_.GLTFLoader=e,p.GLTFFileLoader.CreateGLTFLoaderV2=function(){return new e}}(p.GLTF2||(p.GLTF2={}))}(t||(t={}));var t;!function(t){!function(t){var e=function(){function t(t){this.enabled=!0,this._loader=t}return t.prototype.dispose=function(){delete this._loader},t.prototype._loadSceneAsync=function(){return null},t.prototype._loadNodeAsync=function(){return null},t.prototype._loadVertexDataAsync=function(){return null},t.prototype._loadMaterialAsync=function(){return null},t.prototype._loadUriAsync=function(){return null},t.prototype._loadExtensionAsync=function(i,e,r){if(!e.extensions)return null;var t=e.extensions,a=t[this.name];if(!a)return null;delete t[this.name];try{return r(i+'/extensions/'+this.name,a)}finally{t[this.name]=a}},t._LoadSceneAsync=function(o,i,r){return o._applyExtensions(function(t){return t._loadSceneAsync(i,r)})},t._LoadNodeAsync=function(o,i,r){return o._applyExtensions(function(t){return t._loadNodeAsync(i,r)})},t._LoadVertexDataAsync=function(o,i,r,t){return o._applyExtensions(function(o){return o._loadVertexDataAsync(i,r,t)})},t._LoadMaterialAsync=function(i,s,r,t,n,o){return i._applyExtensions(function(i){return i._loadMaterialAsync(s,r,t,n,o)})},t._LoadUriAsync=function(o,i,r){return o._applyExtensions(function(t){return t._loadUriAsync(i,r)})},t}();t.GLTFLoaderExtension=e}(t.GLTF2||(t.GLTF2={}))}(t||(t={}));var t;!function(c){!function(r){!function(e){var t='MSFT_lod',o=function(o){function e(){var r=null!==o&&o.apply(this,arguments)||this;return r.name=t,r.maxLODsToLoad=s,r._loadingNodeLOD=null,r._loadNodeSignals={},r._loadingMaterialLOD=null,r._loadMaterialSignals={},r}return d(e,o),e.prototype._loadNodeAsync=function(e,l){var d=this;return this._loadExtensionAsync(e,l,function(e,t){for(var n=d._getLODs(e,l,d._loader._gltf.nodes,t.ids),r=0,i;r<n.length;r++)!function(a){var e=n[a];0!==a&&(d._loadingNodeLOD=e,d._loadNodeSignals[e._index]||(d._loadNodeSignals[e._index]=new c.Deferred));var t=d._loader._loadNodeAsync('#/nodes/'+e._index,e).then(function(){if(0!==a){var r=n[a-1];r._babylonMesh&&(r._babylonMesh.dispose(!1,!0),delete r._babylonMesh)}if(a!==n.length-1){var e=n[a+1]._index;d._loadNodeSignals[e]&&(d._loadNodeSignals[e].resolve(),delete d._loadNodeSignals[e])}});0===a?i=t:(d._loader._completePromises.push(t),d._loadingNodeLOD=null)}(r);return i})},e.prototype._loadMaterialAsync=function(e,d,p,f,o){var a=this;return this._loadingNodeLOD?null:this._loadExtensionAsync(e,d,function(e,t){for(var i=a._getLODs(e,d,a._loader._gltf.materials,t.ids),r=0,n;r<i.length;r++)!function(l){var r=i[l];0!==l&&(a._loadingMaterialLOD=r,a._loadMaterialSignals[r._index]||(a._loadMaterialSignals[r._index]=new c.Deferred));var e=a._loader._loadMaterialAsync('#/materials/'+r._index,r,p,f,0===l?o:function(){}).then(function(){if(0!==l){var t=r._babylonData;o(t[f].material);var e=i[l-1]._babylonData;e[f]&&(e[f].material.dispose(),delete e[f])}if(l!==i.length-1){var n=i[l+1]._index;a._loadMaterialSignals[n]&&(a._loadMaterialSignals[n].resolve(),delete a._loadMaterialSignals[n])}});0===l?n=e:(a._loader._completePromises.push(e),a._loadingMaterialLOD=null)}(r);return n})},e.prototype._loadUriAsync=function(o,e){var r=this;if(this._loadingMaterialLOD){var t=this._loadingMaterialLOD._index;return this._loadMaterialSignals[t].promise.then(function(){return r._loader._loadUriAsync(o,e)})}if(this._loadingNodeLOD){var t=this._loadingNodeLOD._index;return this._loadNodeSignals[t].promise.then(function(){return r._loader._loadUriAsync(o,e)})}return null},e.prototype._getLODs=function(t,e,s,n){if(0>=this.maxLODsToLoad)throw new Error('maxLODsToLoad must be greater than zero');for(var o=[],a=n.length-1;0<=a;a--)if(o.push(r.GLTFLoader._GetProperty(t+'/ids/'+n[a],s,n[a])),o.length===this.maxLODsToLoad)return o;return o.push(e),o},e}(r.GLTFLoaderExtension);e.MSFT_lod=o,r.GLTFLoader._Register(t,function(t){return new o(t)})}(r.Extensions||(r.Extensions={}))}(c.GLTF2||(c.GLTF2={}))}(t||(t={}));var t;!function(t){!function(r){!function(e){var l='MSFT_minecraftMesh',t=function(n){function e(e){var r=n.call(this,e)||this;r.name=l,r._onMaterialLoaded=function(t){t.needAlphaBlending()&&(t.forceDepthWrite=!0,t.separateCullingPass=!0),t.backFaceCulling=t.forceDepthWrite,t.twoSidedLighting=!0};var d=e._gltf.meshes;if(d&&d.length)for(var o=0,a=d,i;o<a.length;o++)if(i=a[o],i&&i.extras&&i.extras.MSFT_minecraftMesh){r._loader.onMaterialLoadedObservable.add(r._onMaterialLoaded);break}return r}return d(e,n),e}(r.GLTFLoaderExtension);e.MSFT_minecraftMesh=t,r.GLTFLoader._Register(l,function(r){return new t(r)})}(r.Extensions||(r.Extensions={}))}(t.GLTF2||(t.GLTF2={}))}(t||(t={}));var t;!function(t){!function(r){!function(e){var l='MSFT_sRGBFactors',t=function(n){function e(e){var r=n.call(this,e)||this;r.name=l,r._onMaterialLoaded=function(t){t.albedoTexture||t.albedoColor.toLinearSpaceToRef(t.albedoColor),t.reflectivityTexture||t.reflectivityColor.toLinearSpaceToRef(t.reflectivityColor)};var d=e._gltf.materials;if(d&&d.length)for(var o=0,a=d,i;o<a.length;o++)if(i=a[o],i&&i.extras&&i.extras.MSFT_sRGBFactors){r._loader.onMaterialLoadedObservable.add(r._onMaterialLoaded);break}return r}return d(e,n),e}(r.GLTFLoaderExtension);e.MSFT_sRGBFactors=t,r.GLTFLoader._Register(l,function(r){return new t(r)})}(r.Extensions||(r.Extensions={}))}(t.GLTF2||(t.GLTF2={}))}(t||(t={}));var t;!function(p){!function(e){!function(t){var i='KHR_draco_mesh_compression',r=function(o){function t(e){var r=o.call(this,e)||this;return r.name=i,r._dracoCompression=null,p.DracoCompression.DecoderAvailable||(r.enabled=!1),r}return d(t,o),t.prototype.dispose=function(){this._dracoCompression&&this._dracoCompression.dispose(),o.prototype.dispose.call(this)},t.prototype._loadVertexDataAsync=function(t,r,i){var o=this;return this._loadExtensionAsync(t,r,function(a,n){if(void 0!=r.mode){if(5!==r.mode&&4!==r.mode)throw new Error(t+': Unsupported mode '+r.mode);if(5===r.mode)throw new Error(t+': Mode '+r.mode+' is not currently supported')}var s={},l=function(o,e){var r=n.attributes[o];void 0!=r&&(i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(e)&&i._delayInfo.push(e),s[e]=r)};l('POSITION',p.VertexBuffer.PositionKind),l('NORMAL',p.VertexBuffer.NormalKind),l('TANGENT',p.VertexBuffer.TangentKind),l('TEXCOORD_0',p.VertexBuffer.UVKind),l('TEXCOORD_1',p.VertexBuffer.UV2Kind),l('JOINTS_0',p.VertexBuffer.MatricesIndicesKind),l('WEIGHTS_0',p.VertexBuffer.MatricesWeightsKind),l('COLOR_0',p.VertexBuffer.ColorKind);var d=e.GLTFLoader._GetProperty(a,o._loader._gltf.bufferViews,n.bufferView);return d._dracoBabylonGeometry||(d._dracoBabylonGeometry=o._loader._loadBufferViewAsync('#/bufferViews/'+d._index,d).then(function(e){return o._dracoCompression||(o._dracoCompression=new p.DracoCompression),o._dracoCompression.decodeMeshAsync(e,s).then(function(e){var r=new p.Geometry(i.name,o._loader._babylonScene);return e.applyToGeometry(r),r}).catch(function(r){throw new Error(t+': '+r.message)})})),d._dracoBabylonGeometry})},t}(e.GLTFLoaderExtension);t.KHR_draco_mesh_compression=r,e.GLTFLoader._Register(i,function(t){return new r(t)})}(e.Extensions||(e.Extensions={}))}(p.GLTF2||(p.GLTF2={}))}(t||(t={}));var t;!function(i){!function(e){!function(t){var r='KHR_materials_pbrSpecularGlossiness',o=function(o){function e(){var t=null!==o&&o.apply(this,arguments)||this;return t.name=r,t}return d(e,o),e.prototype._loadMaterialAsync=function(p,e,r,t,n){var o=this;return this._loadExtensionAsync(p,e,function(a,i){e._babylonData=e._babylonData||{};var s=e._babylonData[t];if(!s){var f=[],u=e.name||'materialSG_'+e._index,c=o._loader._createMaterial(u,t);f.push(o._loader._loadMaterialBasePropertiesAsync(p,e,c)),f.push(o._loadSpecularGlossinessPropertiesAsync(a,e,i,c)),o._loader.onMaterialLoadedObservable.notifyObservers(c),s={material:c,meshes:[],loaded:Promise.all(f).then(function(){})},e._babylonData[t]=s}return s.meshes.push(r),n(s.material),s.loaded})},e.prototype._loadSpecularGlossinessPropertiesAsync=function(e,r,t,n){var o=[];return t.diffuseFactor?(n.albedoColor=i.Color3.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=i.Color3.White(),n.reflectivityColor=t.specularFactor?i.Color3.FromArray(t.specularFactor):i.Color3.White(),n.microSurface=void 0==t.glossinessFactor?1:t.glossinessFactor,t.diffuseTexture&&o.push(this._loader._loadTextureAsync(e+'/diffuseTexture',t.diffuseTexture,function(t){n.albedoTexture=t})),t.specularGlossinessTexture&&(o.push(this._loader._loadTextureAsync(e+'/specularGlossinessTexture',t.specularGlossinessTexture,function(t){n.reflectivityTexture=t})),n.reflectivityTexture.hasAlpha=!0,n.useMicroSurfaceFromReflectivityMapAlpha=!0),this._loader._loadMaterialAlphaProperties(e,r,n),Promise.all(o).then(function(){})},e}(e.GLTFLoaderExtension);t.KHR_materials_pbrSpecularGlossiness=o,e.GLTFLoader._Register(r,function(t){return new o(t)})}(e.Extensions||(e.Extensions={}))}(i.GLTF2||(i.GLTF2={}))}(t||(t={}));var t;!function(i){!function(e){!function(t){var r='KHR_materials_unlit',o=function(o){function e(){var t=null!==o&&o.apply(this,arguments)||this;return t.name=r,t}return d(e,o),e.prototype._loadMaterialAsync=function(d,e,r,t,n){var o=this;return this._loadExtensionAsync(d,e,function(){e._babylonData=e._babylonData||{};var a=e._babylonData[t];if(!a){var c=e.name||'materialUnlit_'+e._index,s=o._loader._createMaterial(c,t);s.unlit=!0;var p=o._loadUnlitPropertiesAsync(d,e,s);o._loader.onMaterialLoadedObservable.notifyObservers(s),a={material:s,meshes:[],loaded:p},e._babylonData[t]=a}return a.meshes.push(r),n(a.material),a.loaded})},e.prototype._loadUnlitPropertiesAsync=function(e,r,t){var n=[];t.metallic=1,t.roughness=1;var o=r.pbrMetallicRoughness;return o&&(o.baseColorFactor?(t.albedoColor=i.Color3.FromArray(o.baseColorFactor),t.alpha=o.baseColorFactor[3]):t.albedoColor=i.Color3.White(),o.baseColorTexture&&n.push(this._loader._loadTextureAsync(e+'/baseColorTexture',o.baseColorTexture,function(r){t.albedoTexture=r}))),r.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),this._loader._loadMaterialAlphaProperties(e,r,t),Promise.all(n).then(function(){})},e}(e.GLTFLoaderExtension);t.KHR_materials_unlit=o,e.GLTFLoader._Register(r,function(t){return new o(t)})}(e.Extensions||(e.Extensions={}))}(i.GLTF2||(i.GLTF2={}))}(t||(t={}));var t;return function(p){!function(e){!function(t){var r='KHR_lights',_;!function(t){t.AMBIENT='ambient',t.DIRECTIONAL='directional',t.POINT='point',t.SPOT='spot'}(_||(_={}));var o=function(t){function o(){var o=null!==t&&t.apply(this,arguments)||this;return o.name=r,o}return d(o,t),o.prototype._loadSceneAsync=function(t,o){var n=this;return this._loadExtensionAsync(t,o,function(t,r){var i=n._loader._loadSceneAsync(t,o),a=e.GLTFLoader._GetProperty(t,n._lights,r.light);if(a.type!==_.AMBIENT)throw new Error(t+': Only ambient lights are allowed on a scene');return n._loader._babylonScene.ambientColor=a.color?p.Color3.FromArray(a.color):p.Color3.Black(),i})},o.prototype._loadNodeAsync=function(t,o){var n=this;return this._loadExtensionAsync(t,o,function(t,r){var i=n._loader._loadNodeAsync(t,o),a=e.GLTFLoader._GetProperty(t,n._lights,r.light),d=o._babylonMesh.name,c;switch(a.type){case _.AMBIENT:throw new Error(t+': Ambient lights are not allowed on a node');case _.DIRECTIONAL:c=new p.DirectionalLight(d,p.Vector3.Forward(),n._loader._babylonScene);break;case _.POINT:c=new p.PointLight(d,p.Vector3.Zero(),n._loader._babylonScene);break;case _.SPOT:var s=a.outerConeAngle||l/4;c=new p.SpotLight(d,p.Vector3.Zero(),p.Vector3.Forward(),s,2,n._loader._babylonScene);break;default:throw new Error(t+': Invalid light type ('+a.type+')');}return c.diffuse=a.color?p.Color3.FromArray(a.color):p.Color3.White(),c.intensity=void 0==a.intensity?1:a.intensity,c.parent=o._babylonMesh,i})},Object.defineProperty(o.prototype,'_lights',{get:function(){var t=this._loader._gltf.extensions;if(!t||!t[this.name])throw new Error('#/extensions: \''+this.name+'\' not found');return t[this.name].lights},enumerable:!0,configurable:!0}),o}(e.GLTFLoaderExtension);t.KHR_lights=o,e.GLTFLoader._Register(r,function(t){return new o(t)})}(e.Extensions||(e.Extensions={}))}(p.GLTF2||(p.GLTF2={}))}(t||(t={})),t})},function(e,t,r){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var o=r(0),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(o);t.default=i.Scene.prototype.showFps=function(e){function t(){let e=document.getElementById('fps-block');e&&(e.innerHTML=u.getFps().toFixed()+' fps',setTimeout(function(){t()},1e3/r))}e=e||{};let r=e.ioSpeed||30,o=e.location||'tl',i={};e.offset=e.offset||{},i.x=e.offset.x||0,i.y=e.offset.y||0;let a=e.font||'Arial',s=e.color||'rgba(180,180,180,0.65)',l=e.size||'12px',d=e.padding||'0.2em;',c=e.background||'rgba(10,10,10,0.65)',p=document.createElement('div');p.setAttribute('id','fps-block'),p.setAttribute('style','position:absolute;top: 20px;left: 10px;display:block;z-index:10001;font-family:Arial, Helvetica, sans-serif;pointer-events:none;color:'+s+';font-size:'+l+';padding:'+d+';background-color:'+c+';transform:translate('+i.x+','+i.y+');'),p.innerHTML='##&nbsp;fps',document.body.appendChild(p);let n=this,u=n._engine;return t(),p}}]);